<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.49" />
    <meta name="theme" content="VuePress Theme Hope" />
    <title>一、内存管理 | tt110617</title><meta name="description" content="网站">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/myblog/assets/style.f2a6604f.css">
    <link rel="modulepreload" href="/myblog/assets/app.6a2d513d.js"><link rel="modulepreload" href="/myblog/assets/jvm01.html.f238e096.js"><link rel="modulepreload" href="/myblog/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/myblog/assets/jvm01.html.226ff0ab.js"><link rel="prefetch" href="/myblog/assets/index.html.d1ca62f7.js"><link rel="prefetch" href="/myblog/assets/index.html.b5c38db1.js"><link rel="prefetch" href="/myblog/assets/index.html.feb38b0c.js"><link rel="prefetch" href="/myblog/assets/algorithm01.html.dd1af2b2.js"><link rel="prefetch" href="/myblog/assets/algorithm02.html.6645e291.js"><link rel="prefetch" href="/myblog/assets/algorithm03.html.9da54164.js"><link rel="prefetch" href="/myblog/assets/LeetCode Hot 100.html.95af3c37.js"><link rel="prefetch" href="/myblog/assets/index.html.2770fb04.js"><link rel="prefetch" href="/myblog/assets/index.html.9f31cb98.js"><link rel="prefetch" href="/myblog/assets/MongoDB.html.747bd522.js"><link rel="prefetch" href="/myblog/assets/index.html.7970fd4d.js"><link rel="prefetch" href="/myblog/assets/index.html.d76d8eeb.js"><link rel="prefetch" href="/myblog/assets/Docker.html.7e9153cc.js"><link rel="prefetch" href="/myblog/assets/ElasticSearch.html.68bc187d.js"><link rel="prefetch" href="/myblog/assets/nginx.html.feb27b40.js"><link rel="prefetch" href="/myblog/assets/index.html.c88cf0a5.js"><link rel="prefetch" href="/myblog/assets/java8新特性.html.eba77086.js"><link rel="prefetch" href="/myblog/assets/index.html.db442bd7.js"><link rel="prefetch" href="/myblog/assets/index.html.e978b3f4.js"><link rel="prefetch" href="/myblog/assets/vue2.html.cd054f5f.js"><link rel="prefetch" href="/myblog/assets/vue3.html.09644e9e.js"><link rel="prefetch" href="/myblog/assets/mysql01.html.14852074.js"><link rel="prefetch" href="/myblog/assets/mysql02.html.19638d4a.js"><link rel="prefetch" href="/myblog/assets/mysql03.html.19940ab5.js"><link rel="prefetch" href="/myblog/assets/mysql04.html.ff20e708.js"><link rel="prefetch" href="/myblog/assets/index.html.aeaeabce.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.5de27bef.js"><link rel="prefetch" href="/myblog/assets/network01.html.d374f53e.js"><link rel="prefetch" href="/myblog/assets/network02.html.612f1790.js"><link rel="prefetch" href="/myblog/assets/network03.html.f409d6e1.js"><link rel="prefetch" href="/myblog/assets/network04.html.417995ce.js"><link rel="prefetch" href="/myblog/assets/network05.html.383f02d3.js"><link rel="prefetch" href="/myblog/assets/network06.html.6b7b74f3.js"><link rel="prefetch" href="/myblog/assets/index.html.a5289baa.js"><link rel="prefetch" href="/myblog/assets/index.html.1ad05321.js"><link rel="prefetch" href="/myblog/assets/Redis01.html.43cb742a.js"><link rel="prefetch" href="/myblog/assets/Redis02.html.ba0a875f.js"><link rel="prefetch" href="/myblog/assets/Redis03.html.c65b1aff.js"><link rel="prefetch" href="/myblog/assets/Redis04.html.8d20d57a.js"><link rel="prefetch" href="/myblog/assets/Redis05.html.66a2065a.js"><link rel="prefetch" href="/myblog/assets/Redisson原理.html.e587d689.js"><link rel="prefetch" href="/myblog/assets/basics.html.ec7af011.js"><link rel="prefetch" href="/myblog/assets/practice.html.3d6fcedb.js"><link rel="prefetch" href="/myblog/assets/index.html.195983d3.js"><link rel="prefetch" href="/myblog/assets/index.html.ffce25e3.js"><link rel="prefetch" href="/myblog/assets/SpringBoot01.html.1539f2df.js"><link rel="prefetch" href="/myblog/assets/SpringBoot02.html.8d492936.js"><link rel="prefetch" href="/myblog/assets/Dubbo.html.25f8081d.js"><link rel="prefetch" href="/myblog/assets/index.html.25b97898.js"><link rel="prefetch" href="/myblog/assets/SpringCloud.html.11fa754a.js"><link rel="prefetch" href="/myblog/assets/SpringCloudAibaba.html.ba7822c1.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.e3fba77d.js"><link rel="prefetch" href="/myblog/assets/RabbitMQ.html.d245b413.js"><link rel="prefetch" href="/myblog/assets/index.html.2e0e8a71.js"><link rel="prefetch" href="/myblog/assets/OAuth2.0.html.ec57b0c6.js"><link rel="prefetch" href="/myblog/assets/index.html.195b9b99.js"><link rel="prefetch" href="/myblog/assets/SpringSecurity.html.f53a3387.js"><link rel="prefetch" href="/myblog/assets/design01.html.a9ca0966.js"><link rel="prefetch" href="/myblog/assets/design02.html.14685d48.js"><link rel="prefetch" href="/myblog/assets/design03.html.d0742e22.js"><link rel="prefetch" href="/myblog/assets/design04.html.4b4d3a60.js"><link rel="prefetch" href="/myblog/assets/design05.html.dd009a09.js"><link rel="prefetch" href="/myblog/assets/index.html.de8a79d7.js"><link rel="prefetch" href="/myblog/assets/juc01.html.7b5b2a61.js"><link rel="prefetch" href="/myblog/assets/juc02.html.e7af61bf.js"><link rel="prefetch" href="/myblog/assets/juc03.html.c680cb04.js"><link rel="prefetch" href="/myblog/assets/index.html.3ef30b14.js"><link rel="prefetch" href="/myblog/assets/jvm02.html.ad530863.js"><link rel="prefetch" href="/myblog/assets/jvm03.html.af77ed0d.js"><link rel="prefetch" href="/myblog/assets/jvm04.html.dd845ccc.js"><link rel="prefetch" href="/myblog/assets/jvm05.html.56d56c94.js"><link rel="prefetch" href="/myblog/assets/jvm06.html.8c5c08ed.js"><link rel="prefetch" href="/myblog/assets/jvm07.html.8713dffe.js"><link rel="prefetch" href="/myblog/assets/jvm08.html.396f92cc.js"><link rel="prefetch" href="/myblog/assets/index.html.cacef81d.js"><link rel="prefetch" href="/myblog/assets/404.html.82bd4b1a.js"><link rel="prefetch" href="/myblog/assets/index.html.2f713335.js"><link rel="prefetch" href="/myblog/assets/index.html.1a811f74.js"><link rel="prefetch" href="/myblog/assets/index.html.79fe6d6e.js"><link rel="prefetch" href="/myblog/assets/index.html.dcd15e89.js"><link rel="prefetch" href="/myblog/assets/index.html.e8952663.js"><link rel="prefetch" href="/myblog/assets/index.html.5ad7ff00.js"><link rel="prefetch" href="/myblog/assets/index.html.92637d35.js"><link rel="prefetch" href="/myblog/assets/index.html.6033e64c.js"><link rel="prefetch" href="/myblog/assets/index.html.29a3be67.js"><link rel="prefetch" href="/myblog/assets/index.html.d2aef326.js"><link rel="prefetch" href="/myblog/assets/index.html.61fd0259.js"><link rel="prefetch" href="/myblog/assets/index.html.cf3e5974.js"><link rel="prefetch" href="/myblog/assets/index.html.b7fddec6.js"><link rel="prefetch" href="/myblog/assets/index.html.2d1c3407.js"><link rel="prefetch" href="/myblog/assets/index.html.f6e57d32.js"><link rel="prefetch" href="/myblog/assets/index.html.57cfa80f.js"><link rel="prefetch" href="/myblog/assets/index.html.5f4c6904.js"><link rel="prefetch" href="/myblog/assets/index.html.adc9fbf5.js"><link rel="prefetch" href="/myblog/assets/index.html.de6bf546.js"><link rel="prefetch" href="/myblog/assets/index.html.5802a134.js"><link rel="prefetch" href="/myblog/assets/index.html.00532d93.js"><link rel="prefetch" href="/myblog/assets/index.html.dcdb8b0c.js"><link rel="prefetch" href="/myblog/assets/index.html.64a2ffc8.js"><link rel="prefetch" href="/myblog/assets/index.html.aa56265b.js"><link rel="prefetch" href="/myblog/assets/index.html.cf5fc743.js"><link rel="prefetch" href="/myblog/assets/index.html.dd0debdd.js"><link rel="prefetch" href="/myblog/assets/index.html.598a85b3.js"><link rel="prefetch" href="/myblog/assets/algorithm01.html.9516ff71.js"><link rel="prefetch" href="/myblog/assets/algorithm02.html.f215eb2a.js"><link rel="prefetch" href="/myblog/assets/algorithm03.html.b981d3d4.js"><link rel="prefetch" href="/myblog/assets/LeetCode Hot 100.html.921fe2c8.js"><link rel="prefetch" href="/myblog/assets/index.html.9ff070dd.js"><link rel="prefetch" href="/myblog/assets/index.html.f985f07c.js"><link rel="prefetch" href="/myblog/assets/MongoDB.html.367811ae.js"><link rel="prefetch" href="/myblog/assets/index.html.ccc78fec.js"><link rel="prefetch" href="/myblog/assets/index.html.cd9c8951.js"><link rel="prefetch" href="/myblog/assets/Docker.html.9aa6750f.js"><link rel="prefetch" href="/myblog/assets/ElasticSearch.html.834de972.js"><link rel="prefetch" href="/myblog/assets/nginx.html.96457f50.js"><link rel="prefetch" href="/myblog/assets/index.html.5f9750b5.js"><link rel="prefetch" href="/myblog/assets/java8新特性.html.72523a0c.js"><link rel="prefetch" href="/myblog/assets/index.html.4267a9c7.js"><link rel="prefetch" href="/myblog/assets/index.html.64b7cc16.js"><link rel="prefetch" href="/myblog/assets/vue2.html.019d3a52.js"><link rel="prefetch" href="/myblog/assets/vue3.html.f014c692.js"><link rel="prefetch" href="/myblog/assets/mysql01.html.1f3c1d4e.js"><link rel="prefetch" href="/myblog/assets/mysql02.html.6085f62b.js"><link rel="prefetch" href="/myblog/assets/mysql03.html.a05b3e35.js"><link rel="prefetch" href="/myblog/assets/mysql04.html.f83e6c8a.js"><link rel="prefetch" href="/myblog/assets/index.html.c2377b6c.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.62e502c2.js"><link rel="prefetch" href="/myblog/assets/network01.html.bb391280.js"><link rel="prefetch" href="/myblog/assets/network02.html.4835dc75.js"><link rel="prefetch" href="/myblog/assets/network03.html.529a44ea.js"><link rel="prefetch" href="/myblog/assets/network04.html.c4a9ab39.js"><link rel="prefetch" href="/myblog/assets/network05.html.fefe6411.js"><link rel="prefetch" href="/myblog/assets/network06.html.4098bbbd.js"><link rel="prefetch" href="/myblog/assets/index.html.9a37999d.js"><link rel="prefetch" href="/myblog/assets/index.html.25f73ada.js"><link rel="prefetch" href="/myblog/assets/Redis01.html.4774eebb.js"><link rel="prefetch" href="/myblog/assets/Redis02.html.7aa43754.js"><link rel="prefetch" href="/myblog/assets/Redis03.html.3b35817c.js"><link rel="prefetch" href="/myblog/assets/Redis04.html.1eb9f421.js"><link rel="prefetch" href="/myblog/assets/Redis05.html.445e2fb4.js"><link rel="prefetch" href="/myblog/assets/Redisson原理.html.a6281fb0.js"><link rel="prefetch" href="/myblog/assets/basics.html.64ecf975.js"><link rel="prefetch" href="/myblog/assets/practice.html.9bd91dc4.js"><link rel="prefetch" href="/myblog/assets/index.html.45528417.js"><link rel="prefetch" href="/myblog/assets/index.html.2765f82f.js"><link rel="prefetch" href="/myblog/assets/SpringBoot01.html.5e31fcb7.js"><link rel="prefetch" href="/myblog/assets/SpringBoot02.html.bbddd314.js"><link rel="prefetch" href="/myblog/assets/Dubbo.html.ccbf57f9.js"><link rel="prefetch" href="/myblog/assets/index.html.534d4ae8.js"><link rel="prefetch" href="/myblog/assets/SpringCloud.html.eab22d83.js"><link rel="prefetch" href="/myblog/assets/SpringCloudAibaba.html.79284ee6.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.da3eb94f.js"><link rel="prefetch" href="/myblog/assets/RabbitMQ.html.1224037c.js"><link rel="prefetch" href="/myblog/assets/index.html.668ad86c.js"><link rel="prefetch" href="/myblog/assets/OAuth2.0.html.aabd01a5.js"><link rel="prefetch" href="/myblog/assets/index.html.9cd27700.js"><link rel="prefetch" href="/myblog/assets/SpringSecurity.html.469ecc81.js"><link rel="prefetch" href="/myblog/assets/design01.html.2b9f9e86.js"><link rel="prefetch" href="/myblog/assets/design02.html.849b42b0.js"><link rel="prefetch" href="/myblog/assets/design03.html.e4be33cd.js"><link rel="prefetch" href="/myblog/assets/design04.html.bc31a0d9.js"><link rel="prefetch" href="/myblog/assets/design05.html.d5c35997.js"><link rel="prefetch" href="/myblog/assets/index.html.4a7a1688.js"><link rel="prefetch" href="/myblog/assets/juc01.html.5bb1f884.js"><link rel="prefetch" href="/myblog/assets/juc02.html.0ce510cd.js"><link rel="prefetch" href="/myblog/assets/juc03.html.e93fe7b6.js"><link rel="prefetch" href="/myblog/assets/index.html.b5425fa1.js"><link rel="prefetch" href="/myblog/assets/jvm02.html.a9498b0d.js"><link rel="prefetch" href="/myblog/assets/jvm03.html.460f2e71.js"><link rel="prefetch" href="/myblog/assets/jvm04.html.7205bd05.js"><link rel="prefetch" href="/myblog/assets/jvm05.html.edac738a.js"><link rel="prefetch" href="/myblog/assets/jvm06.html.91cbb3f0.js"><link rel="prefetch" href="/myblog/assets/jvm07.html.f40c12f1.js"><link rel="prefetch" href="/myblog/assets/jvm08.html.fb107a67.js"><link rel="prefetch" href="/myblog/assets/index.html.3ba3011a.js"><link rel="prefetch" href="/myblog/assets/404.html.1f196261.js"><link rel="prefetch" href="/myblog/assets/index.html.1375c5bc.js"><link rel="prefetch" href="/myblog/assets/index.html.90d1ac0c.js"><link rel="prefetch" href="/myblog/assets/index.html.4d12ff1c.js"><link rel="prefetch" href="/myblog/assets/index.html.8ddb93d5.js"><link rel="prefetch" href="/myblog/assets/index.html.dd098c61.js"><link rel="prefetch" href="/myblog/assets/index.html.cebf8dc1.js"><link rel="prefetch" href="/myblog/assets/index.html.5674ca1e.js"><link rel="prefetch" href="/myblog/assets/index.html.d2abca49.js"><link rel="prefetch" href="/myblog/assets/index.html.1351de8d.js"><link rel="prefetch" href="/myblog/assets/index.html.9de6b46c.js"><link rel="prefetch" href="/myblog/assets/index.html.611ec9ae.js"><link rel="prefetch" href="/myblog/assets/index.html.a02c1bed.js"><link rel="prefetch" href="/myblog/assets/index.html.eb87c7a9.js"><link rel="prefetch" href="/myblog/assets/index.html.33261d15.js"><link rel="prefetch" href="/myblog/assets/index.html.5589fc08.js"><link rel="prefetch" href="/myblog/assets/index.html.f989be9b.js"><link rel="prefetch" href="/myblog/assets/index.html.9f0a51f1.js"><link rel="prefetch" href="/myblog/assets/index.html.49bd673c.js"><link rel="prefetch" href="/myblog/assets/index.html.f1449990.js"><link rel="prefetch" href="/myblog/assets/index.html.b063a78e.js"><link rel="prefetch" href="/myblog/assets/index.html.3f40e5f3.js"><link rel="prefetch" href="/myblog/assets/index.html.56c44de1.js"><link rel="prefetch" href="/myblog/assets/index.html.f8a7efd0.js"><link rel="prefetch" href="/myblog/assets/index.html.c2db4fad.js"><link rel="prefetch" href="/myblog/assets/404.d0d6ec4e.js"><link rel="prefetch" href="/myblog/assets/Layout.4e3e5e78.js"><link rel="prefetch" href="/myblog/assets/Slide.81c38424.js"><link rel="prefetch" href="/myblog/assets/Blog.d28c723c.js"><link rel="prefetch" href="/myblog/assets/auto.264f6c8c.js"><link rel="prefetch" href="/myblog/assets/index.d8a59108.js"><link rel="prefetch" href="/myblog/assets/index.1842ee54.js"><link rel="prefetch" href="/myblog/assets/mermaid.esm.min.fac286bf.js"><link rel="prefetch" href="/myblog/assets/highlight.esm.d982e650.js"><link rel="prefetch" href="/myblog/assets/markdown.esm.832a189d.js"><link rel="prefetch" href="/myblog/assets/math.esm.a3f84b6f.js"><link rel="prefetch" href="/myblog/assets/notes.esm.3c361cb7.js"><link rel="prefetch" href="/myblog/assets/reveal.esm.b96f05d8.js"><link rel="prefetch" href="/myblog/assets/search.esm.80da4a02.js"><link rel="prefetch" href="/myblog/assets/zoom.esm.8514a202.js"><link rel="prefetch" href="/myblog/assets/Playground.c4bd3c9e.js"><link rel="prefetch" href="/myblog/assets/photoswipe.esm.218074cd.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/myblog/" class="brand"><img class="logo" src="/myblog/avatar.jpg" alt="tt110617"><!----><span class="site-name hide-in-pad">tt110617</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/myblog/" class="nav-link" aria-label="首页"><span class="icon iconfont icon-home"></span>首页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/myblog/backend/" class="nav-link active" aria-label="后端"><span class="icon iconfont icon-java"></span>后端<!----></a></div><div class="nav-item hide-in-mobile"><a href="/myblog/frontend/" class="nav-link" aria-label="前端"><span class="icon iconfont icon-vue"></span>前端<!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://github.com/tt110617" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-java"></span><span class="title">Java</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/myblog/backend/java/java8%E6%96%B0%E7%89%B9%E6%80%A7.html" class="nav-link sidebar-link sidebar-page" aria-label="Java8新特性"><!---->Java8新特性<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-creative"></span><span class="title">设计模式</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-asynchronous"></span><span class="title">JUC</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-share"></span><span class="title">JVM</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="一、内存管理"><!---->一、内存管理<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#程序计数器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="程序计数器"><!---->程序计数器<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#定义" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="定义"><!---->定义<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#作用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="作用"><!---->作用<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#虚拟机栈" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="虚拟机栈"><!---->虚拟机栈<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#定义-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="定义"><!---->定义<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#问题辨析" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="问题辨析"><!---->问题辨析<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#栈内存溢出" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="栈内存溢出"><!---->栈内存溢出<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#线程运行诊断" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="线程运行诊断"><!---->线程运行诊断<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#本地方法栈" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="本地方法栈"><!---->本地方法栈<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#堆" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="堆"><!---->堆<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#定义-2" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="定义"><!---->定义<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#堆内存溢出" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="堆内存溢出"><!---->堆内存溢出<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#堆内存诊断" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="堆内存诊断"><!---->堆内存诊断<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#方法区" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="方法区"><!---->方法区<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#定义-3" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="定义"><!---->定义<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#组成" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="组成"><!---->组成<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#方法区内存溢出" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="方法区内存溢出"><!---->方法区内存溢出<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#运行时常量池" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="运行时常量池"><!---->运行时常量池<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="StringTable"><!---->StringTable<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable特性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="StringTable特性"><!---->StringTable特性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable面试题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="StringTable面试题"><!---->StringTable面试题<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable位置" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="StringTable位置"><!---->StringTable位置<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable垃圾回收" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="StringTable垃圾回收"><!---->StringTable垃圾回收<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable性能调优" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="StringTable性能调优"><!---->StringTable性能调优<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#直接内存" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="直接内存"><!---->直接内存<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#定义-4" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="定义"><!---->定义<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#基本使用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="基本使用"><!---->基本使用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#内存溢出" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="内存溢出"><!---->内存溢出<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#分配和释放原理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="分配和释放原理"><!---->分配和释放原理<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm02.html" class="nav-link sidebar-link sidebar-page" aria-label="二、垃圾回收"><!---->二、垃圾回收<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm03.html" class="nav-link sidebar-link sidebar-page" aria-label="三、类结构文件"><!---->三、类结构文件<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm04.html" class="nav-link sidebar-link sidebar-page" aria-label="四、字节码指令"><!---->四、字节码指令<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm05.html" class="nav-link sidebar-link sidebar-page" aria-label="五、编译器优化"><!---->五、编译器优化<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm06.html" class="nav-link sidebar-link sidebar-page" aria-label="六、类加载"><!---->六、类加载<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm07.html" class="nav-link sidebar-link sidebar-page" aria-label="七、运行期优化"><!---->七、运行期优化<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm08.html" class="nav-link sidebar-link sidebar-page" aria-label="八、内存模型"><!---->八、内存模型<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><img class="icon" src="/myblog/icon/gaoxingneng.png"><span class="title">高性能</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-computer"></span><span class="title">计算机基础</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-frame"></span><span class="title">框架</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><img class="icon" src="/myblog/icon/odbc-full.png"><span class="title">数据库</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-snow"></span><span class="title">算法</span><span class="arrow right"></span></button><!----></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->一、内存管理</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down" localizeddate="2022年8月29日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="/myblog/article/" target="_blank" rel="noopener noreferrer">十一</a></span><span property="author" content="十一"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年8月29日</span><meta property="datePublished" content="2022-08-29T00:00:00.000Z"></span><!----><span aria-label="标签🏷" data-balloon-pos="down" localizeddate="2022年8月29日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li class="tag tag2 clickable" role="navigation">jvm</li></ul><meta property="keywords" content="jvm"></span><span class="words-info" aria-label="字数🔠" data-balloon-pos="down" localizeddate="2022年8月29日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 6878 字</span><meta property="wordCount" content="6878"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#程序计数器" class="router-link-active router-link-exact-active toc-link level2">程序计数器</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#定义" class="router-link-active router-link-exact-active toc-link level3">定义</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#作用" class="router-link-active router-link-exact-active toc-link level3">作用</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#虚拟机栈" class="router-link-active router-link-exact-active toc-link level2">虚拟机栈</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#定义-1" class="router-link-active router-link-exact-active toc-link level3">定义</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#问题辨析" class="router-link-active router-link-exact-active toc-link level3">问题辨析</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#栈内存溢出" class="router-link-active router-link-exact-active toc-link level3">栈内存溢出</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#线程运行诊断" class="router-link-active router-link-exact-active toc-link level3">线程运行诊断</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#本地方法栈" class="router-link-active router-link-exact-active toc-link level2">本地方法栈</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#堆" class="router-link-active router-link-exact-active toc-link level2">堆</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#定义-2" class="router-link-active router-link-exact-active toc-link level3">定义</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#堆内存溢出" class="router-link-active router-link-exact-active toc-link level3">堆内存溢出</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#堆内存诊断" class="router-link-active router-link-exact-active toc-link level3">堆内存诊断</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#方法区" class="router-link-active router-link-exact-active toc-link level2">方法区</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#定义-3" class="router-link-active router-link-exact-active toc-link level3">定义</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#组成" class="router-link-active router-link-exact-active toc-link level3">组成</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#方法区内存溢出" class="router-link-active router-link-exact-active toc-link level3">方法区内存溢出</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#运行时常量池" class="router-link-active router-link-exact-active toc-link level3">运行时常量池</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable" class="router-link-active router-link-exact-active toc-link level3">StringTable</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable特性" class="router-link-active router-link-exact-active toc-link level3">StringTable特性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable面试题" class="router-link-active router-link-exact-active toc-link level3">StringTable面试题</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable位置" class="router-link-active router-link-exact-active toc-link level3">StringTable位置</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable垃圾回收" class="router-link-active router-link-exact-active toc-link level3">StringTable垃圾回收</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#stringtable性能调优" class="router-link-active router-link-exact-active toc-link level3">StringTable性能调优</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#直接内存" class="router-link-active router-link-exact-active toc-link level2">直接内存</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#定义-4" class="router-link-active router-link-exact-active toc-link level3">定义</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#基本使用" class="router-link-active router-link-exact-active toc-link level3">基本使用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#内存溢出" class="router-link-active router-link-exact-active toc-link level3">内存溢出</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm01.html#分配和释放原理" class="router-link-active router-link-exact-active toc-link level3">分配和释放原理</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="一、内存管理" tabindex="-1"><a class="header-anchor" href="#一、内存管理" aria-hidden="true">#</a> 一、内存管理</h1><h2 id="程序计数器" tabindex="-1"><a class="header-anchor" href="#程序计数器" aria-hidden="true">#</a> 程序计数器</h2><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20210828161306005.png" alt="运行时数据区"></p><ul><li>方法区、堆：由所有<code>线程共享</code>的数据区</li><li>虚拟机栈、本地方法栈、程序计数器：线程隔离的数据区（即<code>线程私有</code>）</li><li>程序计数器：唯一一个不会出现 <code>OutOfMemoryError</code> 的区域。</li></ul><h3 id="定义" tabindex="-1"><a class="header-anchor" href="#定义" aria-hidden="true">#</a> 定义</h3><p>Program Counter <code>Register</code> 程序计数器（<code>寄存器</code>）</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220728234914922.png" alt="image-20220728234914922"></p><ul><li>作用：记住下一条指令的执行地址。字节码<strong>解释器</strong>工作时，就是通过获取计数器的值来选取下一条需要执行的字节码指令。</li><li>特点 <ul><li><code>是线程私有的</code>，每个线程都有自己的程序计数器</li><li><code>不会存在内存溢出</code><ul><li>此内存区域没有规定任何 OutOfMemoryError 的情况</li></ul></li><li>线程正在执行一个<code>java方法</code>，计数器记录的是正在执行的<code>虚拟机字节码指令的地址</code>；线程正在执行的<code>本地方法</code>，<code>计数器值应为空</code>（Undefined）</li></ul></li></ul><p>计算机在运行程序时，对于多线程来说，会给每一个内存分配一个时间片。当时间片结束，切换线程时，每个线程都会有其私有的程序计数器来保存它当前的状态。当该线程再次抢到时间片时，便可以通过程序计数器接着继续运行。</p><h3 id="作用" tabindex="-1"><a class="header-anchor" href="#作用" aria-hidden="true">#</a> 作用</h3><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828162256972.png" alt="image-20210828162256972"></p><blockquote><p>程序计数器作用：记住下一条jvm指令的执行地址</p></blockquote><ul><li>在JAVA程序运行时，<code>java源代码</code>会被编译成<code>二进制字节码</code>，作为操纵jvm的jvm指令，然后交给<code>解释器</code>，解释器将其<code>解释为机器码</code>，交给<code>cpu去运行</code>。与此同时，程序计数器会记住<code>下一条jvm指令的执行地址</code>，然后交给解释器继续运行。</li><li>这些<code>jvm指令是通用的</code>，用来直接操纵虚拟机的。所以无论是在window、linux还是macos，只要有虚拟机，java代码都能在其上面运行。这也是<code>java程序跨平台的原因</code>。</li><li>程序计数器是jvm中的一个角色。<code>程序计数器</code>是通过计算机中的<code>寄存器</code>来实现的，寄存器<code>访问速度快，存取速度快</code>。</li></ul><h2 id="虚拟机栈" tabindex="-1"><a class="header-anchor" href="#虚拟机栈" aria-hidden="true">#</a> 虚拟机栈</h2><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828163636801.png" alt="image-20210828163636801"></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828164111685.png" alt="image-20210828164111685"></p><p>栈：<code>线程运行需要的内存空间</code></p><p>栈帧：<code>每个方法运行时需要的内存</code>，存储了</p><ul><li>局部变量表</li><li>操作数栈</li><li>动态连接</li><li>方法出口等</li></ul><p>生命周期：与线程相同</p><p>异常：栈内存溢出 <code>StackOverFlowError</code></p><p>一个栈由多个栈帧组成，每个栈帧都为所调用的方法分配了内存空间，比如方法的参数，局部变量，返回地址等。</p><p>在线程运行时，不同的方法在执行过程中，被依次压入栈中。待执行结束后，弹出栈，释放内存。</p><h3 id="定义-1" tabindex="-1"><a class="header-anchor" href="#定义-1" aria-hidden="true">#</a> 定义</h3><p>Java Virtual Machine Stacks（Java虚拟机栈）</p><ul><li>每个线程运行时所需要的内存，称为虚拟机栈</li><li>每个栈由多个栈帧（Frame）组成，对应着每次方法调用时所占用的内存</li><li>每个线程只能有一个<strong>活动</strong>栈帧，对应则当前正在执行的那个方法。</li></ul><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828165515023.png" alt="image-20210828165515023"></p><p>对于虚拟机栈而言，更多情况研究的是栈帧中的局部变量表部分。局部变量表</p><ul><li>存放了各种java虚拟机基本数据类型、对象引用（reference）、returnAddress类型（指向了一条字节码指令的地址）</li><li>这些数据类型在局部变量表的储存空间：以局部变量槽（Slot）来表示。 <ul><li>64位长度的long、double类型，会占用两个槽位</li></ul></li><li>进入一个方法时，这个方法在栈帧中分配多少局部变量空间，在编译器的时候已经确定。 <ul><li>运行时不会改变</li><li>这里的大小指的是槽位的多少</li></ul></li></ul><h3 id="问题辨析" tabindex="-1"><a class="header-anchor" href="#问题辨析" aria-hidden="true">#</a> 问题辨析</h3><ol><li><p>垃圾回收是否涉及到栈内存</p><p>不涉及。栈内存是方法调用是分配的，在方法结束调用后，就将栈帧弹出栈了，释放了内存。</p></li><li><p>栈内存分配越大越好吗</p><p>并不是。系统的物理内存是一定的，<code>栈空间越大，会导致线程数越少</code>。栈空间越大，也并不会让程序更快，只是有更大的栈空间，能让你<code>做更多次的递归调用</code>。</p></li><li><p>方法内的局部变量是否线程安全</p><ul><li>判断是否安全，即看这些变量<code>对于多个线程是共享的还是私有的</code>。</li><li>如果<code>方法内局部变量没有逃离方法的作用范围</code>，它是<code>线程安全</code>的。</li><li>如果是局部变量<code>引用了对象</code>，并<code>逃离方法的作用范围</code>，需要<code>考虑线程安全</code>。</li></ul></li></ol><h4 id="案例分析1" tabindex="-1"><a class="header-anchor" href="#案例分析1" aria-hidden="true">#</a> 案例分析1</h4><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828170638501.png" alt="image-20210828170638501"></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828170729020.png" alt="image-20210828170729020"></p><p>对于局部变量int x 来说，它是方法内的局部变量，在多线程下，每个线程会为其运行的方法分配栈和栈帧，栈是线程私有的，方法中的局部变量不会受其他线程影响。</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828170618242.png" alt="image-20210828170618242"></p><p>每个线程读取static变量到线程的工作内存中，然后再进行计算，最后将修改以后的变量的值同步到static变量中</p><h4 id="案例分析2" tabindex="-1"><a class="header-anchor" href="#案例分析2" aria-hidden="true">#</a> 案例分析2</h4><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828171600734.png" alt="image-20210828171600734"></p><ul><li>m1方法线程安全：局部变量在方法内，线程私有。</li><li>m2方法线程不安全：变量是通过应用类型拿到的，那么与此同时其他线程也可能拿到这个应用然后对其进行修改。</li><li>m3方法线程不安全：局部变量虽然声明在方法内，但是在最后确返回出去了。返回出去后可能被其他线程引用进行修改。</li></ul><h3 id="栈内存溢出" tabindex="-1"><a class="header-anchor" href="#栈内存溢出" aria-hidden="true">#</a> 栈内存溢出</h3><h4 id="栈空间调整参数" tabindex="-1"><a class="header-anchor" href="#栈空间调整参数" aria-hidden="true">#</a> 栈空间调整参数</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-Xss空间大小
-Xss8M
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><code>栈帧过多</code>导致栈内存溢出</li><li><code>栈帧过大</code>导致栈内存溢出</li></ol><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828172259517.png" alt="image-20210828172259517"></p><p>当程序递归调用次数太多时，会超出栈的空间，导致栈内存溢出。</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828172432094.png" alt="image-20210828172432094"></p><p>方法携带的参数等占用内存太多，导致栈帧过大，使栈内存溢出。</p><h4 id="演示1-栈帧过多" tabindex="-1"><a class="header-anchor" href="#演示1-栈帧过多" aria-hidden="true">#</a> 演示1（栈帧过多）</h4><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828172803288.png" alt="image-20210828172803288"></p><p>递归调用次数太多。</p><h4 id="演示2-互相调用-类似死锁" tabindex="-1"><a class="header-anchor" href="#演示2-互相调用-类似死锁" aria-hidden="true">#</a> 演示2（互相调用，类似死锁）</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">*</span><span class="token operator">*</span>
 <span class="token operator">*</span> json 数据转换
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_19</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Dept</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;Market&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Emp</span> e1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Emp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;zhang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e1<span class="token punctuation">.</span><span class="token function">setDept</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Emp</span> e2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Emp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e2<span class="token punctuation">.</span><span class="token function">setDept</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>

        d<span class="token punctuation">.</span><span class="token function">setEmps</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// { name: &#39;Market&#39;, emps: [{ name:&#39;zhang&#39;, dept:{ name:&#39;&#39;, emps: [ {}]} },] }</span>
        <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Emp</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token keyword">private</span> <span class="token class-name">Dept</span> dept<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Dept</span> <span class="token function">getDept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> dept<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDept</span><span class="token punctuation">(</span><span class="token class-name">Dept</span> dept<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dept <span class="token operator">=</span> dept<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Dept</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Emp</span><span class="token punctuation">&gt;</span></span> emps<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Emp</span><span class="token punctuation">&gt;</span></span> <span class="token function">getEmps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> emps<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEmps</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Emp</span><span class="token punctuation">&gt;</span></span> emps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>emps <span class="token operator">=</span> emps<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在工具类将类转换成json格式时，emp对象里有dep，dep里又有emp字段。</p><p>dep: { name: ‘Market’, emps: [{ name:’zhang’, dept:{ name:’’, emps: [ {}]} },] }</p><p>解决方法：使用 <code>JsonIgnore</code></p><h3 id="线程运行诊断" tabindex="-1"><a class="header-anchor" href="#线程运行诊断" aria-hidden="true">#</a> 线程运行诊断</h3><p>案例1：cpu占用过多</p><p>定位</p><ul><li>用top定位哪个进程对cpu的占用过高 <ul><li>top</li></ul></li><li>用ps命令进一步定位是哪个线程引起的cpu占用过高 <ul><li>ps H -eo pid,tid,%cpu | grep 32655</li></ul></li><li>jstack根据线程id找到有问题的线程，进一步定位到问题代码的源码行数。 <ul><li>jstack 进程id</li></ul></li></ul><p>案例2：程序运行很长时间没有结果</p><h4 id="演示1-cpu占用过多" tabindex="-1"><a class="header-anchor" href="#演示1-cpu占用过多" aria-hidden="true">#</a> 演示1（cpu占用过多）</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 使用top命令查看当前cup运行情况</span>
<span class="token function">top</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828175513175.png" alt="image-20210828175513175"></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 使用ps查看线程的运行情况</span>
<span class="token comment">## -eo 后的参数是想要查看的参数信息，pid进程号，tid线程号，%cpu cpu占用率</span>
<span class="token function">ps</span> H -eo pid,tid,%cpu <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">32655</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828180026634.png" alt="image-20210828180026634"></p><p>32665线程有大问题。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 输出进程内的所有信息，线程号用16进制表示的</span>
<span class="token comment">## 32665线程换算成6进制为7f99</span>
jstack <span class="token number">32655</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828180606154.png" alt="image-20210828180606154"></p><h4 id="演示2-死锁" tabindex="-1"><a class="header-anchor" href="#演示2-死锁" aria-hidden="true">#</a> 演示2（死锁）</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>jstack <span class="token number">32275</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210828181101161.png" alt="image-20210828181101161"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>t1<span class="token punctuation">.</span>stack</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 演示线程死锁
 */</span>
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_3</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">A</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">B</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我获得了 a 和 b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我获得了 a 和 b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="本地方法栈" tabindex="-1"><a class="header-anchor" href="#本地方法栈" aria-hidden="true">#</a> 本地方法栈</h2><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829093158776.png" alt="image-20210829093158776"></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829093335182.png" alt="image-20210829093335182"></p><p>native 本地方法</p><p>本地方法栈，<code>给本地方法的运行提供一个空间</code>。jvm类并不是所有的方法都是java代码编写的，有些底层的方法就是通过c/c++实现的。而java可以调用这些底层方法来完成一些功能。在java调用这些底层方法时，就是运行在本地方法栈中。</p><p>异常：StackOverFlowError、OutOfMemoryError</p><h2 id="堆" tabindex="-1"><a class="header-anchor" href="#堆" aria-hidden="true">#</a> 堆</h2><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829093645420.png" alt="image-20210829093645420"></p><h3 id="定义-2" tabindex="-1"><a class="header-anchor" href="#定义-2" aria-hidden="true">#</a> 定义</h3><p>Heap 堆</p><ul><li>通过new关键字，创建对象都会使用堆内存</li><li>“所有的对象实例以及数组都应当在堆上分配”</li></ul><p>特点</p><ul><li>它是线程共享的，堆中对象都需要考虑线程安全的问题</li><li>有垃圾回收机制</li><li>是虚拟机所管理的内存中最大的一块</li></ul><h3 id="堆内存溢出" tabindex="-1"><a class="header-anchor" href="#堆内存溢出" aria-hidden="true">#</a> 堆内存溢出</h3><p><code>OutOfMemoryError:java heap space</code> 堆内存溢出</p><h4 id="堆空间调整参数" tabindex="-1"><a class="header-anchor" href="#堆空间调整参数" aria-hidden="true">#</a> 堆空间调整参数</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-Xmx空间大小
-Xmx4G
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="案例" tabindex="-1"><a class="header-anchor" href="#案例" aria-hidden="true">#</a> 案例</h4><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829100332978.png" alt="image-20210829100332978"></p><h4 id="案例代码" tabindex="-1"><a class="header-anchor" href="#案例代码" aria-hidden="true">#</a> 案例代码</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>t1<span class="token punctuation">.</span>heap</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 演示堆内存溢出 java.lang.OutOfMemoryError: Java heap space
 * -Xmx8m
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_5</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello, hellohello, hellohellohellohello ...</span>
                a <span class="token operator">=</span> a <span class="token operator">+</span> a<span class="token punctuation">;</span>  <span class="token comment">// hellohellohellohello</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在实际生产中，对于堆内存溢出问题，可能不是那么容易检测出来。因为堆内存空间比较大，在运行时，一时间还不会使其溢出。</p><p>所以为了使堆内存问题尽早暴露出来，可以在测试时，将堆内存空间调整小一些。</p><h3 id="堆内存诊断" tabindex="-1"><a class="header-anchor" href="#堆内存诊断" aria-hidden="true">#</a> 堆内存诊断</h3><ol><li>jps工具 <ul><li>查看当前系统中有哪些java进程</li></ul></li><li>jmap工具 <ul><li>查看 <strong>某一时刻</strong> 堆内存占用情况</li><li>jmap –heap 进程id</li></ul></li><li>jconsole工具 <ul><li>图形界面的，多功能的监测工具，可以<strong>连续</strong>监测</li></ul></li><li>堆内存调整指令参数 <ul><li>-Xmx容量大小</li></ul></li></ol><h4 id="jmp诊断堆内存" tabindex="-1"><a class="header-anchor" href="#jmp诊断堆内存" aria-hidden="true">#</a> jmp诊断堆内存</h4><p>案例代码</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>t1<span class="token punctuation">.</span>heap</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 演示堆内存
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_4</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;1...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 10 Mb</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;2...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        array <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;3...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Thread.sleep 是为了留有时间间隔执行命令，监控进程状态</li><li>程序打印 <strong>1…</strong> 后，执行jps查看该进程的进程号</li><li>jmap -heap 进程id，查看这一时刻进程堆空间使用情况</li><li>程序打印 2… 后，再次执行 jmap 指令查看内存情况</li><li>程序打印 3… 后，再次执行 jmap 指令查看内存情况</li></ul><p>程序运行后</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829161824726.png" alt="image-20210829161824726"></p><p>97751为该进程的pid，调用命令</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>jmap -heap <span class="token number">97751</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829162305968.png" alt="image-20210829162305968"></p><p>具体的堆内存占用在Heap Usage</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829162710121.png" alt="image-20210829162710121"></p><p>在程序打印了 <strong>2…</strong> 后，再次</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>jmap -heap <span class="token number">97751</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829163002318.png" alt="image-20210829163002318"></p><p>按理说应该增加10M，此处有些疑惑</p><p>在打印了 3… 之后，代表着已经被垃圾回收了</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>jmap -heap <span class="token number">97751</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829163513488.png" alt="image-20210829163513488"></p><h4 id="jconsole诊断堆内存" tabindex="-1"><a class="header-anchor" href="#jconsole诊断堆内存" aria-hidden="true">#</a> jconsole诊断堆内存</h4><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829171115106.png" alt="image-20210829171115106"></p><p>但是在jconsole里面可以看出，在给array初始化后，堆内存使用量增加了10M，在垃圾回收后，堆内存使用量又迅速下降。</p><h4 id="jvisualvm诊断堆内存" tabindex="-1"><a class="header-anchor" href="#jvisualvm诊断堆内存" aria-hidden="true">#</a> jvisualvm诊断堆内存</h4><p>jvisualvm是功能更加强大的图形化jvm管理软件。可以进行堆转储，拿到进程某一时刻的快照dump进行分析。</p><p>案例代码：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>t1<span class="token punctuation">.</span>heap</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 演示查看对象个数 堆转储 dump
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_13</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> students <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            students<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            Student student = new Student();</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000000000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> big <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829173250363.png" alt="image-20210829173250363"></p><p>经过测试，在执行了垃圾回收后，堆内存占用还是居高不下。</p><p>于是点击 堆dump 拿取快照，分析详情</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829173611313.png" alt="image-20210829173611313"></p><p>点击查看</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829173857763.png" alt="image-20210829173857763"></p><p>由源代码可知，确实是Student类的原因。</p><p>student数组一直在循环引用，没有被垃圾回收。</p><h2 id="方法区" tabindex="-1"><a class="header-anchor" href="#方法区" aria-hidden="true">#</a> 方法区</h2><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829174141846.png" alt="image-20210829174141846"></p><ul><li>线程共享的</li><li>用于存放 <ul><li>被虚拟机加载的类型信息</li><li>常量</li><li>静态变量</li><li>即时编译器编译后的代码缓存等</li></ul></li></ul><h3 id="定义-3" tabindex="-1"><a class="header-anchor" href="#定义-3" aria-hidden="true">#</a> 定义</h3><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829174456310.png" alt="image-20210829174456310"></p><p><strong>方法区</strong>是一种规范， <strong>永久代</strong> 和 <strong>元空间</strong> 都只是它的实现。</p><h3 id="组成" tabindex="-1"><a class="header-anchor" href="#组成" aria-hidden="true">#</a> 组成</h3><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829174916457.png" alt="image-20210829174916457"></p><ul><li><code>StringTable</code> 迁移到堆中，<code>利于垃圾回收</code>。</li></ul><h3 id="方法区内存溢出" tabindex="-1"><a class="header-anchor" href="#方法区内存溢出" aria-hidden="true">#</a> 方法区内存溢出</h3><h4 id="元空间大小调整参数" tabindex="-1"><a class="header-anchor" href="#元空间大小调整参数" aria-hidden="true">#</a> 元空间大小调整参数</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-XX:MaxMetaspaceSize=8m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="案例代码-1" tabindex="-1"><a class="header-anchor" href="#案例代码-1" aria-hidden="true">#</a> 案例代码</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>t1<span class="token punctuation">.</span>metaspace</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>org<span class="token punctuation">.</span>objectweb<span class="token punctuation">.</span>asm<span class="token punctuation">.</span></span><span class="token class-name">ClassWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>org<span class="token punctuation">.</span>objectweb<span class="token punctuation">.</span>asm<span class="token punctuation">.</span></span><span class="token class-name">Opcodes</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace
 * -XX:MaxMetaspaceSize=8m
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_8</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span> <span class="token comment">// 可以用来加载类的二进制字节码</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Demo1_8</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo1_8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ClassWriter 作用是生成类的二进制字节码</span>
                <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 版本号， public， 类名, 包名, 父类， 接口</span>
                cw<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>V1_8<span class="token punctuation">,</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span>ACC_PUBLIC<span class="token punctuation">,</span> <span class="token string">&quot;Class&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 返回 byte[]</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 执行了类的加载</span>
                test<span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token string">&quot;Class&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> code<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Class 对象</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于元空间使用本地内存，所以很难方法区溢出所以需要手动调整元空间大小。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-XX:MaxMetaspaceSize=8m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829175944594.png" alt="image-20210829175944594"></p><p>运行结果 OutOfMemoryError: Metaspace</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829175453427.png" alt="image-20210829175453427"></p><h4 id="场景" tabindex="-1"><a class="header-anchor" href="#场景" aria-hidden="true">#</a> 场景</h4><ul><li>spring</li><li>mybatis</li></ul><p>都用到了cglib技术，字节码的动态生成技术，动态加载类，动态生成类，运行期间，经常会产生大量的类，可能会产生方法区溢出。</p><h3 id="运行时常量池" tabindex="-1"><a class="header-anchor" href="#运行时常量池" aria-hidden="true">#</a> 运行时常量池</h3><ul><li>运行时常量池是方法区的一部分。常量池表是Class文件中的，可以通过反编译得到。<code>类被加载时</code>，常量池中的信息就会放入运行时常量池。</li><li>常量池，就是一张表，虚拟机指令根据这张常量表找到要执行的<code>类名、方法名、参数类型、字面量</code>等信息</li><li>存放在编译期生成的各种字面量和符号引用。</li><li>运行时常量池，常量池是 *.class 文件中的，当该类被加载，它的常量池信息就会放入运行时常量池，并把里面的<strong>符号地址变为真实地址</strong>。</li><li>运行期间，可以把新的常量放入池中。（String类的intern()方法）</li><li>运行时常量池（Runtime Constant Pool），常量池表（Constant Pool Table）</li></ul><h4 id="案例-1" tabindex="-1"><a class="header-anchor" href="#案例-1" aria-hidden="true">#</a> 案例</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 二进制字节码（类基本信息，常量池，类方法定义，包含了虚拟机指令）</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过反编译这段程序来学习相关的知识</p><p>用到的命令</p><ol><li>先进入到java源文件的目录</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> 目标目录
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol><li>将HelloWorld.java 编译成 HelloWorld.class</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>javac HelloWorld.java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol><li>反编译HelloWorld.class</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>javap -v HelloWorld.class
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>结果如下</p><p><strong>类基本信息</strong></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829200548475.png" alt="image-20210829200548475"></p><p><strong>常量池</strong></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829200834772.png" alt="image-20210829200834772"></p><p><strong>类方法定义</strong></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210829201138637.png" alt="image-20210829201138637"></p><p><strong>方法运行流程</strong></p><ul><li>对于主方法来说，解释器依次执行指令。getstatic–&gt;得到某个常量，索引为##2。</li><li>以##2作为索引去常量池查询，得到 Fieldref ，即属性索引，索引为 ##16，##17</li><li>再以##16，##17为索引继续查询常量池</li><li>依照这个步骤下去继续阅读即可</li></ul><h3 id="stringtable" tabindex="-1"><a class="header-anchor" href="#stringtable" aria-hidden="true">#</a> StringTable</h3><h4 id="常量池与串池的关系" tabindex="-1"><a class="header-anchor" href="#常量池与串池的关系" aria-hidden="true">#</a> 常量池与串池的关系</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// StringTable [ &quot;a&quot;, &quot;b&quot; ,&quot;ab&quot; ]  hashtable 结构，不能扩容</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_22</span> <span class="token punctuation">{</span>
    <span class="token comment">// 常量池中的信息，都会被加载到运行时常量池中， 这时 a b ab 都是常量池中的符号，还没有变为 java 字符串对象</span>
    <span class="token comment">// ldc ##2 会把 a 符号变为 &quot;a&quot; 字符串对象</span>
    <span class="token comment">// ldc ##3 会把 b 符号变为 &quot;b&quot; 字符串对象</span>
    <span class="token comment">// ldc ##4 会把 ab 符号变为 &quot;ab&quot; 字符串对象</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 懒惰的</span>
        <span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行时常量池</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210907173027797.png" alt="image-20210907173027797"></p><p>方法区</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210907172922091.png" alt="image-20210907172922091"></p><p>局部变量表</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210907173105090.png" alt="image-20210907173105090"></p><ol><li>常量池最初存在于字节码中，运行时会被加载到运行时常量池中。这时 a b ab 都是常量池中的符号，还没有变为 java 字符串对象</li><li>字符串的加载是<code>懒惰</code>的，当执行到具体的引用时，才会创建对象。如String s1 = “a”。创建了s1对象。</li><li>同时会创建 <code>StringTable</code> 串池。将s1作为key去串池中寻找，如果没有，才会加入串池</li></ol><h4 id="变量字符串拼接" tabindex="-1"><a class="header-anchor" href="#变量字符串拼接" aria-hidden="true">#</a> 变量字符串拼接</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// StringTable [ &quot;a&quot;, &quot;b&quot; ,&quot;ab&quot; ]  hashtable 结构，不能扩容</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_22</span> <span class="token punctuation">{</span>
    <span class="token comment">// 常量池中的信息，都会被加载到运行时常量池中， 这时 a b ab 都是常量池中的符号，还没有变为 java 字符串对象</span>
    <span class="token comment">// ldc ##2 会把 a 符号变为 &quot;a&quot; 字符串对象</span>
    <span class="token comment">// ldc ##3 会把 b 符号变为 &quot;b&quot; 字符串对象</span>
    <span class="token comment">// ldc ##4 会把 ab 符号变为 &quot;ab&quot; 字符串对象</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 懒惰的</span>
        <span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// new StringBuilder().append(&quot;a&quot;).append(&quot;b&quot;).toString()  </span>
        <span class="token comment">// new String(&quot;ab&quot;)</span>
        <span class="token class-name">String</span> s4 <span class="token operator">=</span> s1 <span class="token operator">+</span> s2<span class="token punctuation">;</span> 
        <span class="token comment">// 输出false，s3在常量池，s4在堆里</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3 <span class="token operator">==</span> s4<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210907171257030.png" alt="image-20210907171257030"></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210907171658785.png" alt="image-20210907171658785"></p><p>可以看到StringBuilder.toString是new了一个String，new的对象在堆里。</p><h4 id="编译期优化-常量字符串拼接" tabindex="-1"><a class="header-anchor" href="#编译期优化-常量字符串拼接" aria-hidden="true">#</a> 编译期优化（常量字符串拼接）</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// StringTable [ &quot;a&quot;, &quot;b&quot; ,&quot;ab&quot; ]  hashtable 结构，不能扩容</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_22</span> <span class="token punctuation">{</span>
    <span class="token comment">// 常量池中的信息，都会被加载到运行时常量池中， 这时 a b ab 都是常量池中的符号，还没有变为 java 字符串对象</span>
    <span class="token comment">// ldc ##2 会把 a 符号变为 &quot;a&quot; 字符串对象</span>
    <span class="token comment">// ldc ##3 会把 b 符号变为 &quot;b&quot; 字符串对象</span>
    <span class="token comment">// ldc ##4 会把 ab 符号变为 &quot;ab&quot; 字符串对象</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 懒惰的</span>
        <span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s4 <span class="token operator">=</span> s1 <span class="token operator">+</span> s2<span class="token punctuation">;</span> <span class="token comment">// new StringBuilder().append(&quot;a&quot;).append(&quot;b&quot;).toString()  new String(&quot;ab&quot;)</span>
        <span class="token class-name">String</span> s5 <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>  <span class="token comment">// javac 在编译期间的优化，结果已经在编译期确定为ab</span>
        <span class="token comment">// true</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3 <span class="token operator">==</span> s5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210907172354228.png" alt="image-20210907172354228"></p><h4 id="字符串延迟加载" tabindex="-1"><a class="header-anchor" href="#字符串延迟加载" aria-hidden="true">#</a> 字符串延迟加载</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 演示字符串字面量也是【延迟】成为对象的
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestString</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数 4695</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;9&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数 4703</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;9&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数4703</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210907174352586.png" alt="image-20210907174352586"></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210907174544915.png" alt="image-20210907174544915"></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210907174717219.png" alt="image-20210907174717219"></p><h3 id="stringtable特性" tabindex="-1"><a class="header-anchor" href="#stringtable特性" aria-hidden="true">#</a> StringTable特性</h3><ul><li>常量池中的字符串仅是符号，第一次用到时才变成对象。</li><li>利用串池的机制，来避免重复创建字符串对象</li><li>字符串 <strong>变量拼接</strong> 的原理是 <code>StringBuilder</code>（1.8）</li><li>字符串 <strong>常量拼接</strong> 的原理是 <code>编译期优化</code></li><li>可以使用intern方法，主动将串池中还没有的字符串对象放入串池 <ul><li>1.8将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池，两种情况均会把串池中的对象返回。</li><li>1.6将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有会把此对象复制一份，放入串池，两种情况均会把串池中的对象返回。即调用intern的对象，和将来放入串池的对象，是两个对象。</li></ul></li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_23</span> <span class="token punctuation">{</span>

    <span class="token comment">//  [&quot;ab&quot;, &quot;a&quot;, &quot;b&quot;]</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> x <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 堆  new String(&quot;a&quot;)   new String(&quot;b&quot;) new String(&quot;ab&quot;)</span>
        <span class="token class-name">String</span> s2 <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> s2 <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> s <span class="token operator">==</span> x <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//false</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>执行到第10行String s2 = s.intern(); 时，将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回。由于String x = “ab”;StringTable中有”ab”了，所以s不会放在常量池。但是会把常量池的”ab”返回回来给s2。</li><li>所以 s2 == x 即 常量池的”ab”</li><li>s != x，因为s没有放进去</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_23</span> <span class="token punctuation">{</span>

    <span class="token comment">//  [&quot;a&quot;, &quot;b&quot;,&quot;ab&quot; ]</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 堆  new String(&quot;a&quot;)   new String(&quot;b&quot;) new String(&quot;ab&quot;)</span>
        <span class="token class-name">String</span> s2 <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> s2 <span class="token operator">==</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> s <span class="token operator">==</span> <span class="token string">&quot;ab&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>执行到第10行String s2 = s.intern(); 时，将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回。此时StringTable还没有”ab”，所以s会放在常量池。同时常量池的”ab”返回回来给s2。</li><li>所以 s2 == x 即 常量池的”ab”</li><li>s == x，因为s放进去了</li></ol><h3 id="stringtable面试题" tabindex="-1"><a class="header-anchor" href="#stringtable面试题" aria-hidden="true">#</a> StringTable面试题</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_21</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token operator">+</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 优化为&quot;ab&quot;</span>
        <span class="token class-name">String</span> s4 <span class="token operator">=</span> s1 <span class="token operator">+</span> s2<span class="token punctuation">;</span> <span class="token comment">// new StringBuilder 在堆中</span>
        <span class="token class-name">String</span> s5 <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 去串池查找添加</span>
        <span class="token class-name">String</span> s6 <span class="token operator">=</span> s4<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3 <span class="token operator">==</span> s4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3 <span class="token operator">==</span> s5<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3 <span class="token operator">==</span> s6<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

        <span class="token class-name">String</span> x2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// new String(&quot;cd&quot;)</span>
        <span class="token class-name">String</span>  x1 <span class="token operator">=</span> <span class="token string">&quot;cd&quot;</span><span class="token punctuation">;</span> <span class="token comment">//&quot;cd&quot;</span>
        x2<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 串池已经有cd，x2放不进去</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x1 <span class="token operator">==</span> x2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果调换位置</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> x2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// new String(&quot;cd&quot;)</span>
x2<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">String</span>  x1 <span class="token operator">=</span> <span class="token string">&quot;cd&quot;</span><span class="token punctuation">;</span> <span class="token comment">//&quot;cd&quot;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x1 <span class="token operator">==</span> x2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="stringtable位置" tabindex="-1"><a class="header-anchor" href="#stringtable位置" aria-hidden="true">#</a> StringTable位置</h3><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908163006245.png" alt="image-20210908163006245"></p><p>在1.6之前。StringTable在 <code>方法区永久代</code> 中，但是放在这之中，虚拟机只会在 <code>full GC</code> 时才会对 StringTable 进行<code>垃圾回收</code>。</p><p>但是其实StringTable的操作是非常频繁的，如果没有及时进行垃圾回收，容易造成 <code>永久代空间不足</code>。</p><p>在1.8后，StringTable放在了 <code>堆</code> 中，使其 <code>垃圾回收的效率更高</code>。</p><h4 id="案例-2" tabindex="-1"><a class="header-anchor" href="#案例-2" aria-hidden="true">#</a> 案例</h4><p>1.6下</p><p>虚拟机参数</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-XX:MaxPermSize=10m  //永久代空间设置
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908163504238.png" alt="image-20210908163504238"></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908163536082.png" alt="image-20210908163536082"></p><p>1.8下</p><p>虚拟机参数</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 堆空间大小设置、关闭UseGCOverheadLimit</span>
<span class="token comment">// -Xmx10m -XX:-UseGCOverheadLimit</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_22</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">260000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908164506315.png" alt="image-20210908164506315"></p><p>可以看到1.6是永久代空间溢出，1.8是堆空间溢出。</p><h3 id="stringtable垃圾回收" tabindex="-1"><a class="header-anchor" href="#stringtable垃圾回收" aria-hidden="true">#</a> StringTable垃圾回收</h3><p>StringTable中的字符串常量不再引用后，也会被垃圾回收。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220729144005303.png" alt="image-20220729144005303"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_23</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// String.valueOf(j).intern();</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908171104909.png" alt="image-20210908171104909"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_23</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908171200024.png" alt="image-20210908171200024"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908171340239.png" alt="image-20210908171340239"></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908171418752.png" alt="image-20210908171418752"></p><p>清理了一些未引用的字符串常量。</p><h3 id="stringtable性能调优" tabindex="-1"><a class="header-anchor" href="#stringtable性能调优" aria-hidden="true">#</a> StringTable性能调优</h3><ul><li>调整 -XX:StringTableSize= <code>桶个数</code></li><li>考虑是否将字符串对象放入池中，即用 <code>intern</code></li></ul><h4 id="参数调优" tabindex="-1"><a class="header-anchor" href="#参数调优" aria-hidden="true">#</a> 参数调优</h4><p>StringTable的数据结构实现是哈希表，调优即 <code>对哈希表的桶的个数</code>的调整。</p><p>jvm参数</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-XX:StringTableSize=1009
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908172615756.png" alt="image-20210908172615756"></p><p>由于入池时候会先去查找StringTable中有无这个字符串，hash表的的寻找，桶个数越多越快。</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908172757892.png" alt="image-20210908172757892"></p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908172852198.png" alt="image-20210908172852198"></p><p>当桶个数为1009时，耗费12097毫秒</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908173023784.png" alt="image-20210908173023784"></p><h4 id="intern调优" tabindex="-1"><a class="header-anchor" href="#intern调优" aria-hidden="true">#</a> intern调优</h4><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908174101833.png" alt="image-20210908174101833"></p><h2 id="直接内存" tabindex="-1"><a class="header-anchor" href="#直接内存" aria-hidden="true">#</a> 直接内存</h2><h3 id="定义-4" tabindex="-1"><a class="header-anchor" href="#定义-4" aria-hidden="true">#</a> 定义</h3><p>不是虚拟机的内存，是系统内存。Direct Memory</p><ul><li>常见于NIO操作时，用于数据缓存区</li><li>分配回收成本过高，但读写性能高</li><li>不受JVM内存回收管理</li><li>使用native函数库直接分配堆外内存，然后通过一个存储在java堆里面的DirectByteBuffer对象作为这块内存的引用进行操作。避免了在java堆和Native堆中来回复制数据。</li><li>本机内存的分配不会收到java堆的限制，利用本地空间。但是本地空间的大小收到本机总内存的限制，当分配给java各个内存区域的总和大于物理内存限制，就会导致动态扩展时出现OOM。</li></ul><h3 id="基本使用" tabindex="-1"><a class="header-anchor" href="#基本使用" aria-hidden="true">#</a> 基本使用</h3><h4 id="java操作磁盘文件" tabindex="-1"><a class="header-anchor" href="#java操作磁盘文件" aria-hidden="true">#</a> java操作磁盘文件</h4><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908192753325.png" alt="image-20210908192753325"></p><p>当java读取磁盘文件时，会从用户态切换到内核态，才能去操作系统内存。读取时，系统内存先开辟一块缓存空间，磁盘文件分块读取。然后java虚拟机内存再开辟缓存空间new Byte[]来读取系统内存的文件。由于有从系统内存读取到java虚拟机的内存，所以效率较低。</p><h4 id="nio操作磁盘文件" tabindex="-1"><a class="header-anchor" href="#nio操作磁盘文件" aria-hidden="true">#</a> NIO操作磁盘文件</h4><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210908192818850.png" alt="image-20210908192818850"></p><p>读取磁盘文件时，会有一块直接内存，java虚拟机和系统内存都能访问使用，所以效率更高。</p><h3 id="内存溢出" tabindex="-1"><a class="header-anchor" href="#内存溢出" aria-hidden="true">#</a> 内存溢出</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> demo1_24 <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">int</span> _100MB <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span>_100MB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210911094441455.png" alt="image-20210911094441455"></p><h3 id="分配和释放原理" tabindex="-1"><a class="header-anchor" href="#分配和释放原理" aria-hidden="true">#</a> 分配和释放原理</h3><ul><li>使用了Unsafe对象完成直接内存的分配回收，并且回收需要主动调用 <code>freeMemory</code> 方法。</li><li>ByteBuffer的实现类内部，使用了Cleaner（虚引用）来检测ByteBuffer对象，一旦ByteBuffer对象被垃圾回收，那么就会由ReferenceHandler线程通过Cleaner的clean方法调用freeMemory来释放直接内存。</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_26</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> _1Gb <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * -XX:+DisableExplicitGC 显式的
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span>_1Gb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;分配完毕...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始释放...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        byteBuffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 显式的垃圾回收，Full GC</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>直接内存不受jvm内存管理</code>，但是这段代码示例中，当byteBuffer = null，执行垃圾回收后，直接内存却被释放了。这是因为跟jdk中的一个类Unsafe有关。</li><li>-XX:+DisableExplicitGC 禁用显式的垃圾回收。只有等到jvm自己进行垃圾回收才会回收。</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 直接内存分配的底层原理：Unsafe
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_27</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> _1Gb <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 分配内存</span>
        <span class="token keyword">long</span> base <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>_1Gb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        unsafe<span class="token punctuation">.</span><span class="token function">setMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> _1Gb<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 释放内存</span>
        unsafe<span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Unsafe</span> <span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Field</span> f <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;theUnsafe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Unsafe</span><span class="token punctuation">)</span> f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> unsafe<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> <span class="token operator">|</span> <span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Unsafe类调用其方法freeMemory来释放了直接内存。</p><p>ByteBuffer源码</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210911095759844.png" alt="image-20210911095759844"></p><p>ByteBuffer分配直接内存是通过new 了一个DirectByteBuffer</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210911095914572.png" alt="image-20210911095914572"></p><p>在DirectByteBuffer内部可以看到，确实是用Unsafe类去分配内存。</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210911100146768.png" alt="image-20210911100146768"></p><p>DirectByteBuffer的run方法释放了直接内存。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20210911100658821.png" alt="image-20210911100658821"></p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/tt110617/edit/main/demo/src/backend/java/jvm/jvm01.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/8/29 21:57:52</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 1253728268@qq.com">hzz</span><!--]--><!--]--></div></footer><nav class="page-nav"><!----><a href="/myblog/backend/java/jvm/jvm02.html" class="nav-link next" aria-label="二、垃圾回收"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">二、垃圾回收<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"></div><div class="copyright">Copyright © 2022 十一</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/myblog/assets/app.6a2d513d.js" defer></script>
  </body>
</html>
