<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.49" />
    <meta name="theme" content="VuePress Theme Hope" />
    <title>八、内存模型 | tt110617</title><meta name="description" content="网站">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/myblog/assets/style.f2a6604f.css">
    <link rel="modulepreload" href="/myblog/assets/app.6a2d513d.js"><link rel="modulepreload" href="/myblog/assets/jvm08.html.fb107a67.js"><link rel="modulepreload" href="/myblog/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/myblog/assets/jvm08.html.396f92cc.js"><link rel="prefetch" href="/myblog/assets/index.html.d1ca62f7.js"><link rel="prefetch" href="/myblog/assets/index.html.b5c38db1.js"><link rel="prefetch" href="/myblog/assets/index.html.feb38b0c.js"><link rel="prefetch" href="/myblog/assets/algorithm01.html.dd1af2b2.js"><link rel="prefetch" href="/myblog/assets/algorithm02.html.6645e291.js"><link rel="prefetch" href="/myblog/assets/algorithm03.html.9da54164.js"><link rel="prefetch" href="/myblog/assets/LeetCode Hot 100.html.95af3c37.js"><link rel="prefetch" href="/myblog/assets/index.html.2770fb04.js"><link rel="prefetch" href="/myblog/assets/index.html.9f31cb98.js"><link rel="prefetch" href="/myblog/assets/MongoDB.html.747bd522.js"><link rel="prefetch" href="/myblog/assets/index.html.7970fd4d.js"><link rel="prefetch" href="/myblog/assets/index.html.d76d8eeb.js"><link rel="prefetch" href="/myblog/assets/Docker.html.7e9153cc.js"><link rel="prefetch" href="/myblog/assets/ElasticSearch.html.68bc187d.js"><link rel="prefetch" href="/myblog/assets/nginx.html.feb27b40.js"><link rel="prefetch" href="/myblog/assets/index.html.c88cf0a5.js"><link rel="prefetch" href="/myblog/assets/java8新特性.html.eba77086.js"><link rel="prefetch" href="/myblog/assets/index.html.db442bd7.js"><link rel="prefetch" href="/myblog/assets/index.html.e978b3f4.js"><link rel="prefetch" href="/myblog/assets/vue2.html.cd054f5f.js"><link rel="prefetch" href="/myblog/assets/vue3.html.09644e9e.js"><link rel="prefetch" href="/myblog/assets/mysql01.html.14852074.js"><link rel="prefetch" href="/myblog/assets/mysql02.html.19638d4a.js"><link rel="prefetch" href="/myblog/assets/mysql03.html.19940ab5.js"><link rel="prefetch" href="/myblog/assets/mysql04.html.ff20e708.js"><link rel="prefetch" href="/myblog/assets/index.html.aeaeabce.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.5de27bef.js"><link rel="prefetch" href="/myblog/assets/network01.html.d374f53e.js"><link rel="prefetch" href="/myblog/assets/network02.html.612f1790.js"><link rel="prefetch" href="/myblog/assets/network03.html.f409d6e1.js"><link rel="prefetch" href="/myblog/assets/network04.html.417995ce.js"><link rel="prefetch" href="/myblog/assets/network05.html.383f02d3.js"><link rel="prefetch" href="/myblog/assets/network06.html.6b7b74f3.js"><link rel="prefetch" href="/myblog/assets/index.html.a5289baa.js"><link rel="prefetch" href="/myblog/assets/index.html.1ad05321.js"><link rel="prefetch" href="/myblog/assets/Redis01.html.43cb742a.js"><link rel="prefetch" href="/myblog/assets/Redis02.html.ba0a875f.js"><link rel="prefetch" href="/myblog/assets/Redis03.html.c65b1aff.js"><link rel="prefetch" href="/myblog/assets/Redis04.html.8d20d57a.js"><link rel="prefetch" href="/myblog/assets/Redis05.html.66a2065a.js"><link rel="prefetch" href="/myblog/assets/Redisson原理.html.e587d689.js"><link rel="prefetch" href="/myblog/assets/basics.html.ec7af011.js"><link rel="prefetch" href="/myblog/assets/practice.html.3d6fcedb.js"><link rel="prefetch" href="/myblog/assets/index.html.195983d3.js"><link rel="prefetch" href="/myblog/assets/index.html.ffce25e3.js"><link rel="prefetch" href="/myblog/assets/SpringBoot01.html.1539f2df.js"><link rel="prefetch" href="/myblog/assets/SpringBoot02.html.8d492936.js"><link rel="prefetch" href="/myblog/assets/Dubbo.html.25f8081d.js"><link rel="prefetch" href="/myblog/assets/index.html.25b97898.js"><link rel="prefetch" href="/myblog/assets/SpringCloud.html.11fa754a.js"><link rel="prefetch" href="/myblog/assets/SpringCloudAibaba.html.ba7822c1.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.e3fba77d.js"><link rel="prefetch" href="/myblog/assets/RabbitMQ.html.d245b413.js"><link rel="prefetch" href="/myblog/assets/index.html.2e0e8a71.js"><link rel="prefetch" href="/myblog/assets/OAuth2.0.html.ec57b0c6.js"><link rel="prefetch" href="/myblog/assets/index.html.195b9b99.js"><link rel="prefetch" href="/myblog/assets/SpringSecurity.html.f53a3387.js"><link rel="prefetch" href="/myblog/assets/design01.html.a9ca0966.js"><link rel="prefetch" href="/myblog/assets/design02.html.14685d48.js"><link rel="prefetch" href="/myblog/assets/design03.html.d0742e22.js"><link rel="prefetch" href="/myblog/assets/design04.html.4b4d3a60.js"><link rel="prefetch" href="/myblog/assets/design05.html.dd009a09.js"><link rel="prefetch" href="/myblog/assets/index.html.de8a79d7.js"><link rel="prefetch" href="/myblog/assets/juc01.html.7b5b2a61.js"><link rel="prefetch" href="/myblog/assets/juc02.html.e7af61bf.js"><link rel="prefetch" href="/myblog/assets/juc03.html.c680cb04.js"><link rel="prefetch" href="/myblog/assets/index.html.3ef30b14.js"><link rel="prefetch" href="/myblog/assets/jvm01.html.226ff0ab.js"><link rel="prefetch" href="/myblog/assets/jvm02.html.ad530863.js"><link rel="prefetch" href="/myblog/assets/jvm03.html.af77ed0d.js"><link rel="prefetch" href="/myblog/assets/jvm04.html.dd845ccc.js"><link rel="prefetch" href="/myblog/assets/jvm05.html.56d56c94.js"><link rel="prefetch" href="/myblog/assets/jvm06.html.8c5c08ed.js"><link rel="prefetch" href="/myblog/assets/jvm07.html.8713dffe.js"><link rel="prefetch" href="/myblog/assets/index.html.cacef81d.js"><link rel="prefetch" href="/myblog/assets/404.html.82bd4b1a.js"><link rel="prefetch" href="/myblog/assets/index.html.2f713335.js"><link rel="prefetch" href="/myblog/assets/index.html.1a811f74.js"><link rel="prefetch" href="/myblog/assets/index.html.79fe6d6e.js"><link rel="prefetch" href="/myblog/assets/index.html.dcd15e89.js"><link rel="prefetch" href="/myblog/assets/index.html.e8952663.js"><link rel="prefetch" href="/myblog/assets/index.html.5ad7ff00.js"><link rel="prefetch" href="/myblog/assets/index.html.92637d35.js"><link rel="prefetch" href="/myblog/assets/index.html.6033e64c.js"><link rel="prefetch" href="/myblog/assets/index.html.29a3be67.js"><link rel="prefetch" href="/myblog/assets/index.html.d2aef326.js"><link rel="prefetch" href="/myblog/assets/index.html.61fd0259.js"><link rel="prefetch" href="/myblog/assets/index.html.cf3e5974.js"><link rel="prefetch" href="/myblog/assets/index.html.b7fddec6.js"><link rel="prefetch" href="/myblog/assets/index.html.2d1c3407.js"><link rel="prefetch" href="/myblog/assets/index.html.f6e57d32.js"><link rel="prefetch" href="/myblog/assets/index.html.57cfa80f.js"><link rel="prefetch" href="/myblog/assets/index.html.5f4c6904.js"><link rel="prefetch" href="/myblog/assets/index.html.adc9fbf5.js"><link rel="prefetch" href="/myblog/assets/index.html.de6bf546.js"><link rel="prefetch" href="/myblog/assets/index.html.5802a134.js"><link rel="prefetch" href="/myblog/assets/index.html.00532d93.js"><link rel="prefetch" href="/myblog/assets/index.html.dcdb8b0c.js"><link rel="prefetch" href="/myblog/assets/index.html.64a2ffc8.js"><link rel="prefetch" href="/myblog/assets/index.html.aa56265b.js"><link rel="prefetch" href="/myblog/assets/index.html.cf5fc743.js"><link rel="prefetch" href="/myblog/assets/index.html.dd0debdd.js"><link rel="prefetch" href="/myblog/assets/index.html.598a85b3.js"><link rel="prefetch" href="/myblog/assets/algorithm01.html.9516ff71.js"><link rel="prefetch" href="/myblog/assets/algorithm02.html.f215eb2a.js"><link rel="prefetch" href="/myblog/assets/algorithm03.html.b981d3d4.js"><link rel="prefetch" href="/myblog/assets/LeetCode Hot 100.html.921fe2c8.js"><link rel="prefetch" href="/myblog/assets/index.html.9ff070dd.js"><link rel="prefetch" href="/myblog/assets/index.html.f985f07c.js"><link rel="prefetch" href="/myblog/assets/MongoDB.html.367811ae.js"><link rel="prefetch" href="/myblog/assets/index.html.ccc78fec.js"><link rel="prefetch" href="/myblog/assets/index.html.cd9c8951.js"><link rel="prefetch" href="/myblog/assets/Docker.html.9aa6750f.js"><link rel="prefetch" href="/myblog/assets/ElasticSearch.html.834de972.js"><link rel="prefetch" href="/myblog/assets/nginx.html.96457f50.js"><link rel="prefetch" href="/myblog/assets/index.html.5f9750b5.js"><link rel="prefetch" href="/myblog/assets/java8新特性.html.72523a0c.js"><link rel="prefetch" href="/myblog/assets/index.html.4267a9c7.js"><link rel="prefetch" href="/myblog/assets/index.html.64b7cc16.js"><link rel="prefetch" href="/myblog/assets/vue2.html.019d3a52.js"><link rel="prefetch" href="/myblog/assets/vue3.html.f014c692.js"><link rel="prefetch" href="/myblog/assets/mysql01.html.1f3c1d4e.js"><link rel="prefetch" href="/myblog/assets/mysql02.html.6085f62b.js"><link rel="prefetch" href="/myblog/assets/mysql03.html.a05b3e35.js"><link rel="prefetch" href="/myblog/assets/mysql04.html.f83e6c8a.js"><link rel="prefetch" href="/myblog/assets/index.html.c2377b6c.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.62e502c2.js"><link rel="prefetch" href="/myblog/assets/network01.html.bb391280.js"><link rel="prefetch" href="/myblog/assets/network02.html.4835dc75.js"><link rel="prefetch" href="/myblog/assets/network03.html.529a44ea.js"><link rel="prefetch" href="/myblog/assets/network04.html.c4a9ab39.js"><link rel="prefetch" href="/myblog/assets/network05.html.fefe6411.js"><link rel="prefetch" href="/myblog/assets/network06.html.4098bbbd.js"><link rel="prefetch" href="/myblog/assets/index.html.9a37999d.js"><link rel="prefetch" href="/myblog/assets/index.html.25f73ada.js"><link rel="prefetch" href="/myblog/assets/Redis01.html.4774eebb.js"><link rel="prefetch" href="/myblog/assets/Redis02.html.7aa43754.js"><link rel="prefetch" href="/myblog/assets/Redis03.html.3b35817c.js"><link rel="prefetch" href="/myblog/assets/Redis04.html.1eb9f421.js"><link rel="prefetch" href="/myblog/assets/Redis05.html.445e2fb4.js"><link rel="prefetch" href="/myblog/assets/Redisson原理.html.a6281fb0.js"><link rel="prefetch" href="/myblog/assets/basics.html.64ecf975.js"><link rel="prefetch" href="/myblog/assets/practice.html.9bd91dc4.js"><link rel="prefetch" href="/myblog/assets/index.html.45528417.js"><link rel="prefetch" href="/myblog/assets/index.html.2765f82f.js"><link rel="prefetch" href="/myblog/assets/SpringBoot01.html.5e31fcb7.js"><link rel="prefetch" href="/myblog/assets/SpringBoot02.html.bbddd314.js"><link rel="prefetch" href="/myblog/assets/Dubbo.html.ccbf57f9.js"><link rel="prefetch" href="/myblog/assets/index.html.534d4ae8.js"><link rel="prefetch" href="/myblog/assets/SpringCloud.html.eab22d83.js"><link rel="prefetch" href="/myblog/assets/SpringCloudAibaba.html.79284ee6.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.da3eb94f.js"><link rel="prefetch" href="/myblog/assets/RabbitMQ.html.1224037c.js"><link rel="prefetch" href="/myblog/assets/index.html.668ad86c.js"><link rel="prefetch" href="/myblog/assets/OAuth2.0.html.aabd01a5.js"><link rel="prefetch" href="/myblog/assets/index.html.9cd27700.js"><link rel="prefetch" href="/myblog/assets/SpringSecurity.html.469ecc81.js"><link rel="prefetch" href="/myblog/assets/design01.html.2b9f9e86.js"><link rel="prefetch" href="/myblog/assets/design02.html.849b42b0.js"><link rel="prefetch" href="/myblog/assets/design03.html.e4be33cd.js"><link rel="prefetch" href="/myblog/assets/design04.html.bc31a0d9.js"><link rel="prefetch" href="/myblog/assets/design05.html.d5c35997.js"><link rel="prefetch" href="/myblog/assets/index.html.4a7a1688.js"><link rel="prefetch" href="/myblog/assets/juc01.html.5bb1f884.js"><link rel="prefetch" href="/myblog/assets/juc02.html.0ce510cd.js"><link rel="prefetch" href="/myblog/assets/juc03.html.e93fe7b6.js"><link rel="prefetch" href="/myblog/assets/index.html.b5425fa1.js"><link rel="prefetch" href="/myblog/assets/jvm01.html.f238e096.js"><link rel="prefetch" href="/myblog/assets/jvm02.html.a9498b0d.js"><link rel="prefetch" href="/myblog/assets/jvm03.html.460f2e71.js"><link rel="prefetch" href="/myblog/assets/jvm04.html.7205bd05.js"><link rel="prefetch" href="/myblog/assets/jvm05.html.edac738a.js"><link rel="prefetch" href="/myblog/assets/jvm06.html.91cbb3f0.js"><link rel="prefetch" href="/myblog/assets/jvm07.html.f40c12f1.js"><link rel="prefetch" href="/myblog/assets/index.html.3ba3011a.js"><link rel="prefetch" href="/myblog/assets/404.html.1f196261.js"><link rel="prefetch" href="/myblog/assets/index.html.1375c5bc.js"><link rel="prefetch" href="/myblog/assets/index.html.90d1ac0c.js"><link rel="prefetch" href="/myblog/assets/index.html.4d12ff1c.js"><link rel="prefetch" href="/myblog/assets/index.html.8ddb93d5.js"><link rel="prefetch" href="/myblog/assets/index.html.dd098c61.js"><link rel="prefetch" href="/myblog/assets/index.html.cebf8dc1.js"><link rel="prefetch" href="/myblog/assets/index.html.5674ca1e.js"><link rel="prefetch" href="/myblog/assets/index.html.d2abca49.js"><link rel="prefetch" href="/myblog/assets/index.html.1351de8d.js"><link rel="prefetch" href="/myblog/assets/index.html.9de6b46c.js"><link rel="prefetch" href="/myblog/assets/index.html.611ec9ae.js"><link rel="prefetch" href="/myblog/assets/index.html.a02c1bed.js"><link rel="prefetch" href="/myblog/assets/index.html.eb87c7a9.js"><link rel="prefetch" href="/myblog/assets/index.html.33261d15.js"><link rel="prefetch" href="/myblog/assets/index.html.5589fc08.js"><link rel="prefetch" href="/myblog/assets/index.html.f989be9b.js"><link rel="prefetch" href="/myblog/assets/index.html.9f0a51f1.js"><link rel="prefetch" href="/myblog/assets/index.html.49bd673c.js"><link rel="prefetch" href="/myblog/assets/index.html.f1449990.js"><link rel="prefetch" href="/myblog/assets/index.html.b063a78e.js"><link rel="prefetch" href="/myblog/assets/index.html.3f40e5f3.js"><link rel="prefetch" href="/myblog/assets/index.html.56c44de1.js"><link rel="prefetch" href="/myblog/assets/index.html.f8a7efd0.js"><link rel="prefetch" href="/myblog/assets/index.html.c2db4fad.js"><link rel="prefetch" href="/myblog/assets/404.d0d6ec4e.js"><link rel="prefetch" href="/myblog/assets/Layout.4e3e5e78.js"><link rel="prefetch" href="/myblog/assets/Slide.81c38424.js"><link rel="prefetch" href="/myblog/assets/Blog.d28c723c.js"><link rel="prefetch" href="/myblog/assets/auto.264f6c8c.js"><link rel="prefetch" href="/myblog/assets/index.d8a59108.js"><link rel="prefetch" href="/myblog/assets/index.1842ee54.js"><link rel="prefetch" href="/myblog/assets/mermaid.esm.min.fac286bf.js"><link rel="prefetch" href="/myblog/assets/highlight.esm.d982e650.js"><link rel="prefetch" href="/myblog/assets/markdown.esm.832a189d.js"><link rel="prefetch" href="/myblog/assets/math.esm.a3f84b6f.js"><link rel="prefetch" href="/myblog/assets/notes.esm.3c361cb7.js"><link rel="prefetch" href="/myblog/assets/reveal.esm.b96f05d8.js"><link rel="prefetch" href="/myblog/assets/search.esm.80da4a02.js"><link rel="prefetch" href="/myblog/assets/zoom.esm.8514a202.js"><link rel="prefetch" href="/myblog/assets/Playground.c4bd3c9e.js"><link rel="prefetch" href="/myblog/assets/photoswipe.esm.218074cd.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/myblog/" class="brand"><img class="logo" src="/myblog/avatar.jpg" alt="tt110617"><!----><span class="site-name hide-in-pad">tt110617</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/myblog/" class="nav-link" aria-label="首页"><span class="icon iconfont icon-home"></span>首页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/myblog/backend/" class="nav-link active" aria-label="后端"><span class="icon iconfont icon-java"></span>后端<!----></a></div><div class="nav-item hide-in-mobile"><a href="/myblog/frontend/" class="nav-link" aria-label="前端"><span class="icon iconfont icon-vue"></span>前端<!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://github.com/tt110617" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-java"></span><span class="title">Java</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/myblog/backend/java/java8%E6%96%B0%E7%89%B9%E6%80%A7.html" class="nav-link sidebar-link sidebar-page" aria-label="Java8新特性"><!---->Java8新特性<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-creative"></span><span class="title">设计模式</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-asynchronous"></span><span class="title">JUC</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-share"></span><span class="title">JVM</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/myblog/backend/java/jvm/jvm01.html" class="nav-link sidebar-link sidebar-page" aria-label="一、内存管理"><!---->一、内存管理<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm02.html" class="nav-link sidebar-link sidebar-page" aria-label="二、垃圾回收"><!---->二、垃圾回收<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm03.html" class="nav-link sidebar-link sidebar-page" aria-label="三、类结构文件"><!---->三、类结构文件<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm04.html" class="nav-link sidebar-link sidebar-page" aria-label="四、字节码指令"><!---->四、字节码指令<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm05.html" class="nav-link sidebar-link sidebar-page" aria-label="五、编译器优化"><!---->五、编译器优化<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm06.html" class="nav-link sidebar-link sidebar-page" aria-label="六、类加载"><!---->六、类加载<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/myblog/backend/java/jvm/jvm07.html" class="nav-link sidebar-link sidebar-page" aria-label="七、运行期优化"><!---->七、运行期优化<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="八、内存模型"><!---->八、内存模型<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#原子性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="原子性"><!---->原子性<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#原子性-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="原子性"><!---->原子性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#问题分析" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="问题分析"><!---->问题分析<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#解决方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="解决方法"><!---->解决方法<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#可见性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="可见性"><!---->可见性<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#退不出的循环" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="退不出的循环"><!---->退不出的循环<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#解决方法-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="解决方法"><!---->解决方法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#可见性-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="可见性"><!---->可见性<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#有序性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="有序性"><!---->有序性<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#诡异的结果" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="诡异的结果"><!---->诡异的结果<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#解决方法-2" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="解决方法"><!---->解决方法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#有序性理解" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="有序性理解"><!---->有序性理解<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#happens-before-先行发生原则" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="happens-before（先行发生原则）"><!---->happens-before（先行发生原则）<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#cas与原子类" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="CAS与原子类"><!---->CAS与原子类<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#cas" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="CAS"><!---->CAS<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#乐观锁和悲观锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="乐观锁和悲观锁"><!---->乐观锁和悲观锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#原子操作类" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="原子操作类"><!---->原子操作类<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#synchronized优化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="synchronized优化"><!---->synchronized优化<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#轻量级锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="轻量级锁"><!---->轻量级锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#锁膨胀" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="锁膨胀"><!---->锁膨胀<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#重量锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="重量锁"><!---->重量锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#偏向锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="偏向锁"><!---->偏向锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#其他优化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="其他优化"><!---->其他优化<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li></ul></section><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><img class="icon" src="/myblog/icon/gaoxingneng.png"><span class="title">高性能</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-computer"></span><span class="title">计算机基础</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-frame"></span><span class="title">框架</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><img class="icon" src="/myblog/icon/odbc-full.png"><span class="title">数据库</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-snow"></span><span class="title">算法</span><span class="arrow right"></span></button><!----></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->八、内存模型</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down" localizeddate="2022年8月29日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="/myblog/article/" target="_blank" rel="noopener noreferrer">十一</a></span><span property="author" content="十一"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年8月29日</span><meta property="datePublished" content="2022-08-29T00:00:00.000Z"></span><!----><span aria-label="标签🏷" data-balloon-pos="down" localizeddate="2022年8月29日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li class="tag tag2 clickable" role="navigation">jvm</li></ul><meta property="keywords" content="jvm"></span><span class="words-info" aria-label="字数🔠" data-balloon-pos="down" localizeddate="2022年8月29日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 7318 字</span><meta property="wordCount" content="7318"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#原子性" class="router-link-active router-link-exact-active toc-link level2">原子性</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#原子性-1" class="router-link-active router-link-exact-active toc-link level3">原子性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#问题分析" class="router-link-active router-link-exact-active toc-link level3">问题分析</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#解决方法" class="router-link-active router-link-exact-active toc-link level3">解决方法</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#可见性" class="router-link-active router-link-exact-active toc-link level2">可见性</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#退不出的循环" class="router-link-active router-link-exact-active toc-link level3">退不出的循环</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#解决方法-1" class="router-link-active router-link-exact-active toc-link level3">解决方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#可见性-1" class="router-link-active router-link-exact-active toc-link level3">可见性</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#有序性" class="router-link-active router-link-exact-active toc-link level2">有序性</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#诡异的结果" class="router-link-active router-link-exact-active toc-link level3">诡异的结果</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#解决方法-2" class="router-link-active router-link-exact-active toc-link level3">解决方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#有序性理解" class="router-link-active router-link-exact-active toc-link level3">有序性理解</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#happens-before-先行发生原则" class="router-link-active router-link-exact-active toc-link level3">happens-before（先行发生原则）</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#cas与原子类" class="router-link-active router-link-exact-active toc-link level2">CAS与原子类</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#cas" class="router-link-active router-link-exact-active toc-link level3">CAS</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#乐观锁和悲观锁" class="router-link-active router-link-exact-active toc-link level3">乐观锁和悲观锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#原子操作类" class="router-link-active router-link-exact-active toc-link level3">原子操作类</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#synchronized优化" class="router-link-active router-link-exact-active toc-link level2">synchronized优化</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#轻量级锁" class="router-link-active router-link-exact-active toc-link level3">轻量级锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#锁膨胀" class="router-link-active router-link-exact-active toc-link level3">锁膨胀</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#重量锁" class="router-link-active router-link-exact-active toc-link level3">重量锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#偏向锁" class="router-link-active router-link-exact-active toc-link level3">偏向锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/java/jvm/jvm08.html#其他优化" class="router-link-active router-link-exact-active toc-link level3">其他优化</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="八、内存模型" tabindex="-1"><a class="header-anchor" href="#八、内存模型" aria-hidden="true">#</a> 八、内存模型</h1><blockquote><p>《Java虚拟机规范》[1]中曾试图定义一种“Java内存模型”[2](Java Memory Model，JMM)来屏 蔽各种硬件和操作系统的内存访问差异，以实现让Java程序在各种平台下都能达到一致的内存访问效果。</p></blockquote><h2 id="原子性" tabindex="-1"><a class="header-anchor" href="#原子性" aria-hidden="true">#</a> 原子性</h2><p>很多人将【java 内存结构】与【java 内存模型】傻傻分不清，【java 内存模型】是 Java Memory Model（JMM）的意思。</p><p>关于它的权威解释，请参考 <a href="https://download.oracle.com/otn-pub/jcp/memory_model-1.0-pfd-spec-oth-JSpec/memory_model-1_0-pfd-spec.pdf?AuthParam=1562811549_4d4994cbd5b59d964cd2907ea22ca08b" target="_blank" rel="noopener noreferrer">https://download.oracle.com/otn-pub/jcp/memory_model-1.0-pfd-spec-oth-JSpec/memory_model-1_0-pfd-spec.pdf?AuthParam=1562811549_4d4994cbd5b59d964cd2907ea22ca08b<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>简单的说，JMM 定义了一套 <code>在多线程读写共享数据时（成员变量、数组）时，对数据的可见性、有序性、和原子性的规则和保障</code></p><h3 id="原子性-1" tabindex="-1"><a class="header-anchor" href="#原子性-1" aria-hidden="true">#</a> 原子性</h3><p>原子性在学习线程时讲过，下面来个例子简单回顾一下：</p><p>问题提出，两个线程对初始值为 0 的<strong>静态变量</strong>一个做自增，一个做自减，各做 5000 次，结果是 0 吗？</p><h3 id="问题分析" tabindex="-1"><a class="header-anchor" href="#问题分析" aria-hidden="true">#</a> 问题分析</h3><p>以上的结果可能是正数、负数、零。为什么呢？因为 Java 中对静态变量的自增，自减并不是原子操作。</p><p>例如对于 i++ 而言（i 为静态变量），实际会产生如下的 JVM 字节码指令：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>getstatic i <span class="token comment">// 获取静态变量i的值 </span>
iconst_1 <span class="token comment">// 准备常量1 </span>
iadd <span class="token comment">// 加法 </span>
putstatic i <span class="token comment">// 将修改后的值存入静态变量i</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而对应 i–- 也是类似：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>getstatic i <span class="token comment">// 获取静态变量i的值 </span>
iconst_1 <span class="token comment">// 准备常量1 </span>
isub <span class="token comment">// 减法 </span>
putstatic i <span class="token comment">// 将修改后的值存入静态变量i</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>此处是静态变量，与局部变量区分开</p><p>局部变量i++是在槽位上直接自增iinc</p><p>静态变量i++，是getstatic加载到操作数栈中，然后iadd做加法加上iconst_1常量1</p><p>不同的线程在自己的操作数栈中进行操作</p></blockquote><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930085507989.png" alt="image-20210930085507989"></p><p>如果是单线程以上 8 行代码是顺序执行（不会交错）没有问题：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 假设i的初始值为0 </span>
getstatic i <span class="token comment">// 线程1-获取静态变量i的值 线程内i=0 </span>
iconst_1 <span class="token comment">// 线程1-准备常量1 </span>
iadd <span class="token comment">// 线程1-自增 线程内i=1 </span>
putstatic i <span class="token comment">// 线程1-将修改后的值存入静态变量i 静态变量i=1 </span>
getstatic i <span class="token comment">// 线程1-获取静态变量i的值 线程内i=1 </span>
iconst_1 <span class="token comment">// 线程1-准备常量1 </span>
isub <span class="token comment">// 线程1-自减 线程内i=0 </span>
putstatic i <span class="token comment">// 线程1-将修改后的值存入静态变量i 静态变量i=0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但多线程下这 8 行代码可能交错运行（为什么会交错？思考一下）：</p><blockquote><p>因为并发操作中，不同的线程是抢占cpu运行，cpu运行有时间片，时间片一到，就该切换线程，然后所有线程又来抢占cpu的时间片，也有可能同一个线程多次抢到。</p></blockquote><p>出现负数的情况：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 假设i的初始值为0 </span>
getstatic i <span class="token comment">// 线程1-获取静态变量i的值 线程内i=0 </span>
getstatic i <span class="token comment">// 线程2-获取静态变量i的值 线程内i=0 </span>
iconst_1 <span class="token comment">// 线程1-准备常量1 </span>
iadd <span class="token comment">// 线程1-自增 线程内i=1 </span>
putstatic i <span class="token comment">// 线程1-将修改后的值存入静态变量i 静态变量i=1 </span>
iconst_1 <span class="token comment">// 线程2-准备常量1 </span>
isub <span class="token comment">// 线程2-自减 线程内i=-1 </span>
putstatic i <span class="token comment">// 线程2-将修改后的值存入静态变量i 静态变量i=-1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>出现正数的情况：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 假设i的初始值为0 </span>
getstatic i <span class="token comment">// 线程1-获取静态变量i的值 线程内i=0 </span>
getstatic i <span class="token comment">// 线程2-获取静态变量i的值 线程内i=0 </span>
iconst_1 <span class="token comment">// 线程1-准备常量1 </span>
iadd <span class="token comment">// 线程1-自增 线程内i=1 </span>
iconst_1 <span class="token comment">// 线程2-准备常量1 </span>
isub <span class="token comment">// 线程2-自减 线程内i=-1 </span>
putstatic i <span class="token comment">// 线程2-将修改后的值存入静态变量i 静态变量i=-1 </span>
putstatic i <span class="token comment">// 线程1-将修改后的值存入静态变量i 静态变量i=1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>不同的线程在自己的操作数栈中操作，操作完后，把结果存入主内存。对于其他线程的操作，本线程是不知道的。同时读入0，我加1，你减1，我在进行加操作时的时候，我是不知道你已经把i变成-1并且放到主内存中了。我只会把i变成1，然后放入主内存中，然后覆盖你。</p></blockquote><h3 id="解决方法" tabindex="-1"><a class="header-anchor" href="#解决方法" aria-hidden="true">#</a> 解决方法</h3><blockquote><p>synchronized （同步关键字）</p></blockquote><p>语法</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span><span class="token punctuation">(</span> 对象 <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  要作为原子操作代码 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用 synchronized 解决并发问题：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token keyword">static</span> <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span> 
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> 
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                i<span class="token operator">++</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> 
        <span class="token comment">// 推荐把synchronized写在for外层，这样加锁解锁只会执行一次</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                i<span class="token operator">--</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如何理解呢：你可以把 obj 想象成一个房间，线程 t1，t2 想象成两个人。</p><p>当线程 t1 执行到 synchronized(obj) 时就好比 t1 进入了这个房间，并反手锁住了门，在门内执行count++ 代码。</p><p>这时候如果 t2 也运行到了 synchronized(obj) 时，它发现门被锁住了，只能在门外等待。</p><p>当 t1 执行完 synchronized{} 块内的代码，这时候才会解开门上的锁，从 obj 房间出来。t2 线程这时才可以进入 obj 房间，反锁住门，执行它的 count– 代码。</p><blockquote><p>注意：上例中 t1 和 t2 线程必须用 synchronized 锁住同一个 obj 对象，如果 t1 锁住的是 m1 对象，t2 锁住的是 m2 对象，就好比两个人分别进入了两个不同的房间，没法起到同步的效果。</p></blockquote><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930091210317.png" alt="image-20210930091210317"></p><ul><li>t1线程进来后，发现锁没有owner，然后就成为owner</li><li>t2线程发现有owner，进入EntryList等待（被阻塞）</li><li>当t1运行结束后释放锁，t2才可以成为owner</li><li>如果EntryList中有多个线程，它们会抢占Owner</li></ul><h2 id="可见性" tabindex="-1"><a class="header-anchor" href="#可见性" aria-hidden="true">#</a> 可见性</h2><h3 id="退不出的循环" tabindex="-1"><a class="header-anchor" href="#退不出的循环" aria-hidden="true">#</a> 退不出的循环</h3><p>先来看一个现象，main 线程对 run 变量的修改对于 t 线程不可见，导致了 t 线程无法停止：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo4_1</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">boolean</span> run <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
           <span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">)</span> <span class="token punctuation">{</span>

           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        run <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 线程t不会如预想的停下来</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为什么呢？分析一下：</p><ol><li>初始状态， t 线程刚开始从主内存读取了 run 的值到工作内存。</li></ol><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930093001427.png" alt="image-20210930093001427"></p><ol><li>因为 t 线程要频繁从主内存中读取 run 的值，JIT 编译器会将 run 的值缓存至自己工作内存中的高速缓存中，减少对主存中 run 的访问，提高效率</li></ol><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930093036840.png" alt="image-20210930093036840"></p><ol><li>1 秒之后，main 线程修改了 run 的值，并同步至主存，而 t 是从自己工作内存中的高速缓存中读取这个变量的值，结果永远是旧值</li></ol><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930093101826.png" alt="image-20210930093101826"></p><h3 id="解决方法-1" tabindex="-1"><a class="header-anchor" href="#解决方法-1" aria-hidden="true">#</a> 解决方法</h3><blockquote><p>volatile（易变关键字）</p></blockquote><p>它可以用来修饰成员变量和静态成员变量，他可以避免线程从自己的工作缓存中查找变量的值，必须到主存中获取它的值，线程操作 volatile 变量都是直接操作主存</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo4_1</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> run <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
           <span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">)</span> <span class="token punctuation">{</span>

           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        run <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930094218802.png" alt="image-20210930094218802"></p><h3 id="可见性-1" tabindex="-1"><a class="header-anchor" href="#可见性-1" aria-hidden="true">#</a> 可见性</h3><p>前面例子体现的实际就是可见性，它保证的是在多个线程之间，一个线程对 volatile 变量的修改对另一个线程可见， 不能保证原子性，仅用在 <code>一个写线程，多个读线程</code> 的情况： 上例从字节码理解是这样的：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>getstatic run <span class="token comment">// 线程 t 获取 run true </span>
getstatic run <span class="token comment">// 线程 t 获取 run true </span>
getstatic run <span class="token comment">// 线程 t 获取 run true </span>
getstatic run <span class="token comment">// 线程 t 获取 run true </span>
putstatic run <span class="token comment">// 线程 main 修改 run 为 false， 仅此一次 </span>
getstatic run <span class="token comment">// 线程 t 获取 run false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>比较一下之前我们将线程安全时举的例子：两个线程一个 i++ 一个 i– ，只能保证看到最新值，不能解决指令交错</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 假设i的初始值为0 </span>
getstatic i <span class="token comment">// 线程1-获取静态变量i的值 线程内i=0 </span>
getstatic i <span class="token comment">// 线程2-获取静态变量i的值 线程内i=0 </span>
iconst_1 <span class="token comment">// 线程1-准备常量1 </span>
iadd <span class="token comment">// 线程1-自增 线程内i=1 </span>
putstatic i <span class="token comment">// 线程1-将修改后的值存入静态变量i 静态变量i=1 </span>
iconst_1 <span class="token comment">// 线程2-准备常量1 </span>
isub <span class="token comment">// 线程2-自减 线程内i=-1 </span>
putstatic i <span class="token comment">// 线程2-将修改后的值存入静态变量i 静态变量i=-1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>注意</strong> synchronized 语句块既可以保证代码块的原子性，也同时保证代码块内变量的可见性。但缺点是synchronized是属于重量级操作，性能相对更低</p><p>如果在前面示例的死循环中加入 System.out.println() 会发现即使不加 volatile 修饰符，线程 t 也能正确看到对 run 变量的修改了，想一想为什么？</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo4_1</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">boolean</span> run <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
           <span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        run <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930094533919.png" alt="image-20210930094533919"></p><p>原因</p><p>System.out.println(“1”);被synchronized修饰了</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930094605918.png" alt="image-20210930094605918"></p><h2 id="有序性" tabindex="-1"><a class="header-anchor" href="#有序性" aria-hidden="true">#</a> 有序性</h2><h3 id="诡异的结果" tabindex="-1"><a class="header-anchor" href="#诡异的结果" aria-hidden="true">#</a> 诡异的结果</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token keyword">boolean</span> ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 

<span class="token comment">// 线程1 执行此方法 </span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor1</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">if</span><span class="token punctuation">(</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> num <span class="token operator">+</span> num<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
    r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token comment">// 线程2 执行此方法 </span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor2</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> 
  ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>I_Result 是一个对象，有一个属性 r1 用来保存结果，问，可能的结果有几种？</p><p>有同学这么分析</p><ul><li>情况1：线程1 先执行，这时 ready = false，所以进入 else 分支结果为 1</li><li>情况2：线程2 先执行 num = 2，但没来得及执行 ready = true，线程1 执行，还是进入 else 分支，结果为1</li><li>情况3：线程2 执行到 ready = true，线程1 执行，这回进入 if 分支，结果为 4（因为 num 已经执行过了）</li></ul><p>但我告诉你，结果还有可能是 0 ，信不信吧！</p><ul><li>这种情况下是：线程2 执行 ready = true，切换到线程1，进入 if 分支，相加为 0，再切回线程2 执行num = 2</li></ul><p>相信很多人已经晕了</p><p>这种现象叫做指令重排，是 JIT 编译器在运行时的一些优化，这个现象需要通过大量测试才能复现：</p><p>借助 java 并发压测工具 jcstress <a href="https://wiki.openjdk.java.net/display/CodeTools/jcstress" target="_blank" rel="noopener noreferrer">https://wiki.openjdk.java.net/display/CodeTools/jcstress<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mvn archetype:generate -DinteractiveMode=false - DarchetypeGroupId=org.openjdk.jcstress -DarchetypeArtifactId=jcstress-java-test-archetype -DgroupId=org.sample -DartifactId=test -Dversion=1.0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>创建 maven 项目，提供如下测试类</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@JCStressTest</span> 
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLE<span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span> 
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span> expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLE_INTERESTING<span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">&quot;!!!!&quot;</span><span class="token punctuation">)</span> 
<span class="token annotation punctuation">@State</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrencyTest</span> <span class="token punctuation">{</span> 
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
    <span class="token keyword">boolean</span> ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
    
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor1</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> num <span class="token operator">+</span> num<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Actor</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor2</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> 
        ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>mvn clean <span class="token function">install</span> 
java -jar target/jcstress.jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>会输出我们感兴趣的结果，摘录其中一次结果：</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930100323679.png" alt="image-20210930100323679"></p><p>可以看到，出现结果为 0 的情况有 638 次，虽然次数相对很少，但毕竟是出现了。</p><h3 id="解决方法-2" tabindex="-1"><a class="header-anchor" href="#解决方法-2" aria-hidden="true">#</a> 解决方法</h3><blockquote><p>volatile 修饰的变量，可以禁用指令重排</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@JCStressTest</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLE<span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span> expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span>ACCEPTABLE_INTERESTING<span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">&quot;!!!!&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@State</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrencyTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor1</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> num <span class="token operator">+</span> num<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Actor</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actor2</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果为：</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930101926776.png" alt="image-20210930101926776"></p><h3 id="有序性理解" tabindex="-1"><a class="header-anchor" href="#有序性理解" aria-hidden="true">#</a> 有序性理解</h3><p>JVM 会在不影响正确性的前提下，可以调整语句的执行顺序，思考下面一段代码</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> 
<span class="token keyword">static</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> 

<span class="token comment">// 在某个线程内执行如下赋值操作 </span>
i <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// 较为耗时的操作 </span>
j <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，至于是先执行 i 还是 先执行 j ，对最终的结果不会产生影响。所以，上面代码真正执行时，既可以是</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>i <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// 较为耗时的操作 </span>
j <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>也可以是</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>j <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span> 
i <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// 较为耗时的操作</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这种特性称之为『指令重排』，多线程下『指令重排』会影响正确性，例如著名的 double-checked locking 模式实现单例</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span> 
  <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> INSTANCE <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 实例没创建，才会进入内部的 synchronized代码块 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>INSTANCE <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment">// 也许有其它线程已经创建实例，所以再判断一次 </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>INSTANCE <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
          INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
      <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上的实现特点是：</p><ul><li>懒惰实例化</li><li>首次使用 getInstance() 才使用 synchronized 加锁，后续使用时无需加锁</li></ul><p>但在多线程环境下，上面的代码是有问题的， INSTANCE = new Singleton() 对应的字节码为：</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930104444857.png" alt="image-20210930104444857"></p><p>其中 4 7 两步的顺序不是固定的，也许 jvm 会优化为：先将引用地址赋值给 INSTANCE 变量后，再执行构造方法，如果两个线程 t1，t2 按如下时间序列执行：</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930104502217.png" alt="image-20210930104502217"></p><p>这时 t1 还未完全将构造方法执行完毕，如果在构造方法中要执行很多初始化操作，那么 t2 拿到的是将是一个未初始化完毕的单例</p><p>对 INSTANCE 使用 <code>volatile</code> 修饰即可，<code>可以禁用指令重排</code>，但要注意在 JDK 5 以上的版本的 volatile 才会真正有效</p><ul><li><strong>synchronized</strong> 的有序性是持有相同锁的两个同步块只能串行的进入，即被加锁的内容要按照顺序被多个线程执行，可是其内部的同步代码仍是会发生重排序，使块与块之间有序可见。</li><li><strong>volatile</strong>的有序性是经过插入内存屏障来保证指令按照顺序执行。不会存在后面的指令跑到前面的指令以前来执行。是保证编译器优化的时候不会让指令乱序。</li><li><strong>synchronized 是不能保证指令重排的</strong>。</li></ul><h3 id="happens-before-先行发生原则" tabindex="-1"><a class="header-anchor" href="#happens-before-先行发生原则" aria-hidden="true">#</a> happens-before（先行发生原则）</h3><p>happens-before 规定了哪些写操作对其它线程的读操作可见，它是可见性与有序性的一套规则总结，抛开以下 happens-before 规则，JMM 并不能保证一个线程对共享变量的写，对于其它线程对该共享变量的读可见</p><ul><li>线程解锁 m 之前对变量的写，对于接下来对 m 加锁的其它线程对该变量的读可见</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span> 
<span class="token keyword">static</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span> 
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span> 
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>线程对 volatile 变量的写，对接下来其它线程对该变量的读可见</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span> 

<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span> 
  x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span> 
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>线程 start 前对变量的写，对该线程开始后对该变量的读可见</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span> 

x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> 
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span> 
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>线程结束前对变量的写，对其它线程得知它结束后的读可见（比如其它线程调用 t1.isAlive() 或t1.join()等待它结束）</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span> 

<span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span> 
  x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>线程 t1 打断 t2（interrupt）前对变量的写，对于其他线程得知 t2 被打断后对变量的读可见（通过t2.interrupted 或 t2.isInterrupted）</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span> 
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">break</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
  t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
  <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span> 
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> 
    t2<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>t2<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>对变量默认值（0，false，null）的写，对其它线程对该变量的读可见</li><li>具有传递性，如果 x hb-&gt; y 并且 y hb-&gt; z 那么有 x hb-&gt; z</li></ul><blockquote><p>变量都是指成员变量或静态成员变量</p></blockquote><h2 id="cas与原子类" tabindex="-1"><a class="header-anchor" href="#cas与原子类" aria-hidden="true">#</a> CAS与原子类</h2><h3 id="cas" tabindex="-1"><a class="header-anchor" href="#cas" aria-hidden="true">#</a> CAS</h3><p>无锁并发。CAS 即 Compare and Swap ，它体现的一种乐观锁的思想，比如多个线程要对一个共享的整型变量执行 +1 操作：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 需要不断尝试 </span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">int</span> 旧值 <span class="token operator">=</span> 共享变量 <span class="token punctuation">;</span> <span class="token comment">// 比如拿到了当前值 0 </span>
  <span class="token keyword">int</span> 结果 <span class="token operator">=</span> 旧值 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 在旧值 0 的基础上增加 1 ，正确结果是 1 </span>
  <span class="token comment">/*这时候如果别的线程把共享变量改成了 5，本线程的正确结果 1 就作废了，这时候 compareAndSwap 返回 false，重新尝试，直到： compareAndSwap 返回 true，表示我本线程做修改的同时，别的线程没有干扰 
  */</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> compareAndSwap <span class="token punctuation">(</span> 旧值<span class="token punctuation">,</span> 结果 <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 成功，退出循环 </span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>在进行结果与旧值的交换之前，会先进行旧值与共享变量的比较。如果共享变量没有被其他线程改变，与旧值相等，旧值才会与结果交换。</li><li>获取共享变量时，为了保证该变量的可见性，需要使用 <code>volatile</code> 修饰。结合 CAS 和 volatile 可以实现无锁并发，适用于 <code>竞争不激烈、多核 CPU</code> 的场景下。</li><li>因为没有使用 synchronized，所以线程 <code>不会陷入阻塞</code> ，这是效率提升的因素之一</li><li>但如果竞争激烈，可以想到重试必然频繁发生，反而效率会受影响</li></ul><p>CAS 底层依赖于一个 Unsafe 类来直接调用操作系统底层的 CAS 指令，下面是直接使用 Unsafe 对象进行线程安全保护的一个例子</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> P4<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span><span class="token class-name">Unsafe</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 柴柴快乐每一天
 * <span class="token keyword">@create</span> 2021-09-30  11:27 上午
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * 『Stay hungry, stay foolish. 』
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestCAS</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataContainer</span> dc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dc<span class="token punctuation">.</span><span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dc<span class="token punctuation">.</span><span class="token function">decrease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dc<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DataContainer</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> data<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Unsafe</span> unsafe<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> DATA_OFFSET<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// Unsafe 对象不能直接调用，只能通过反射获得</span>
            <span class="token class-name">Field</span> theUnsafe <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;theUnsafe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            theUnsafe<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            unsafe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Unsafe</span><span class="token punctuation">)</span> theUnsafe<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> <span class="token operator">|</span> <span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// data 属性在 DataContainer 对象中的偏移量，用于 Unsafe 直接访问该属性</span>
            DATA_OFFSET <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">objectFieldOffset</span><span class="token punctuation">(</span><span class="token class-name">DataContainer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> oldValue<span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取共享变量旧值，可以在这一行加入断点，修改 data 调试来加深理解</span>
            oldValue <span class="token operator">=</span> data<span class="token punctuation">;</span>
            <span class="token comment">// cas 尝试修改 data 为 旧值 + 1，如果期间旧值被别的线程改了，返回 false</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> DATA_OFFSET<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oldValue <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decrease</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> oldValue<span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            oldValue <span class="token operator">=</span> data<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> DATA_OFFSET<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oldValue <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930114057692.png" alt="image-20210930114057692"></p><h3 id="乐观锁和悲观锁" tabindex="-1"><a class="header-anchor" href="#乐观锁和悲观锁" aria-hidden="true">#</a> 乐观锁和悲观锁</h3><ul><li>CAS 是基于乐观锁的思想：最乐观的估计，不怕别的线程来修改共享变量，就算改了也没关系，我吃亏点再重试呗。</li><li>synchronized 是基于悲观锁的思想：最悲观的估计，得防着其它线程来修改共享变量，我上了锁你们都别想改，我改完了解开锁，你们才有机会。</li></ul><h3 id="原子操作类" tabindex="-1"><a class="header-anchor" href="#原子操作类" aria-hidden="true">#</a> 原子操作类</h3><p>juc（java.util.concurrent）中提供了原子操作类，可以提供线程安全的操作，例如：AtomicInteger、AtomicBoolean等，它们底层就是采用 CAS 技术 + volatile 来实现的。</p><p>可以使用 AtomicInteger 改写之前的例子：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> P4<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 柴柴快乐每一天
 * <span class="token keyword">@create</span> 2021-09-30  11:44 上午
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * 『Stay hungry, stay foolish. 』
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo4_4</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建原子类整数对象</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicInteger</span> i <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                i<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取并且自增 i++</span>
                <span class="token comment">// i.incrementAndGet(); // 自增并且获取 ++i</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                i<span class="token punctuation">.</span><span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取并且自减 i--</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果</p><p><img src="https://chasing1874.oss-cn-chengdu.aliyuncs.com/image-20210930114756978.png" alt="image-20210930114756978"></p><h2 id="synchronized优化" tabindex="-1"><a class="header-anchor" href="#synchronized优化" aria-hidden="true">#</a> synchronized优化</h2><p>Java HotSpot 虚拟机中，每个对象都有对象头（包括 class 指针和 Mark Word）。Mark Word 平时存储这个对象的 哈希码 、 分代年龄 ，当加锁时，这些信息就根据情况被替换为 标记位 、 线程锁记录指针 、 重量级锁指针 、 线程ID 等内容</p><h3 id="轻量级锁" tabindex="-1"><a class="header-anchor" href="#轻量级锁" aria-hidden="true">#</a> 轻量级锁</h3><p>如果一个对象虽然有多线程访问，但多线程访问的时间是错开的（也就是没有竞争），那么可以使用轻量级锁来优化。这就好比：</p><p>学生（线程 A）用课本占座，上了半节课，出门了（CPU时间到），回来一看，发现课本没变，说明没有竞争，继续上他的课。 如果这期间有其它学生（线程 B）来了，会告知（线程A）有并发访问，线程A 随即升级为重量级锁，进入重量级锁的流程。</p><p>而重量级锁就不是那么用课本占座那么简单了，可以想象线程 A 走之前，把座位用一个铁栅栏围起来</p><p>假设有两个方法同步块，利用同一个对象加锁</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 同步块 A </span>
    <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 同步块 B </span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每个线程都的栈帧都会包含一个<strong>锁记录</strong>的结构，内部可以存储锁定对象的 Mark Word</p><table><thead><tr><th>线程1</th><th>对象Mark Word</th><th>线程2</th></tr></thead><tbody><tr><td>访问同步块 A，把 Mark 复制到线程 1 的锁记录</td><td>01（无锁）</td><td>-</td></tr><tr><td>CAS 修改 Mark 为线程 1 锁记录地址</td><td>01（无锁）</td><td>-</td></tr><tr><td>成功（加锁）</td><td>00（轻量锁）线程 1锁记录地址</td><td>-</td></tr><tr><td>执行同步块 A</td><td>00（轻量锁）线程 1锁记录地址</td><td>-</td></tr><tr><td>访问同步块 B，把 Mark 复制到线程 1 的锁记录</td><td>00（轻量锁）线程 1锁记录地址</td><td>-</td></tr><tr><td>CAS 修改 Mark 为线程 1 锁记录地址</td><td>00（轻量锁）线程 1锁记录地址</td><td>-</td></tr><tr><td>失败（发现是自己的锁）</td><td>00（轻量锁）线程 1锁记录地址</td><td>-</td></tr><tr><td>锁重入</td><td>00（轻量锁）线程 1锁记录地址</td><td>-</td></tr><tr><td>执行同步块 B</td><td>00（轻量锁）线程 1锁记录地址</td><td>-</td></tr><tr><td>同步块 B 执行完毕</td><td>00（轻量锁）线程 1锁记录地址</td><td>-</td></tr><tr><td>同步块 A 执行完毕</td><td>00（轻量锁）线程 1锁记录地址</td><td>-</td></tr><tr><td>成功（解锁）</td><td>01（无锁）</td><td></td></tr><tr><td>-</td><td>01（无锁）</td><td>访问同步块 A，把 Mark 复制到线程 2 的锁记录</td></tr><tr><td>-</td><td>01（无锁）</td><td>CAS 修改 Mark 为线程 2 锁记录地址</td></tr><tr><td>-</td><td>00（轻量锁）线程 2锁记录地址</td><td>成功（加锁）</td></tr><tr><td>-</td><td>…</td><td>…</td></tr></tbody></table><p>线程1与线程2访问的时间是错开的。（即没有竞争）</p><h3 id="锁膨胀" tabindex="-1"><a class="header-anchor" href="#锁膨胀" aria-hidden="true">#</a> 锁膨胀</h3><p>如果在尝试加轻量级锁的过程中，CAS 操作无法成功，这时一种情况就是有其它线程为此对象加上了轻量级锁（有竞争），这时需要进行锁膨胀，将轻量级锁变为重量级锁。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 同步块 </span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>线程1</th><th>对象Mark</th><th>线程2</th></tr></thead><tbody><tr><td>访问同步块，把 Mark 复制到线程1 的锁记录</td><td>01（无锁）</td><td>-</td></tr><tr><td>CAS 修改 Mark 为线程 1 锁记录地址</td><td>01（无锁）</td><td>-</td></tr><tr><td>成功（加锁）</td><td>00（轻量锁）线程 1 锁记录地址</td><td>-</td></tr><tr><td>执行同步块</td><td>00（轻量锁）线程 1 锁记录地址</td><td>-</td></tr><tr><td>执行同步块</td><td>00（轻量锁）线程 1 锁记录地址</td><td>访问同步块，把 Mark 复制到线程 2</td></tr><tr><td>执行同步块</td><td>00（轻量锁）线程 1 锁记录地址</td><td>CAS 修改 Mark 为线程 2 锁记录地址</td></tr><tr><td>执行同步块</td><td>00（轻量锁）线程 1 锁记录地址</td><td>失败（发现别人已经占了锁）</td></tr><tr><td>执行同步块</td><td>00（轻量锁）线程 1 锁记录地址</td><td>CAS 修改 Mark 为重量锁</td></tr><tr><td>执行同步块</td><td>10（重量锁）重量锁指针</td><td>阻塞中</td></tr><tr><td>执行完毕</td><td>10（重量锁）重量锁指针</td><td>阻塞中</td></tr><tr><td>失败（解锁）</td><td>10（重量锁）重量锁指针</td><td>阻塞中</td></tr><tr><td>释放重量锁，唤起阻塞线程竞争</td><td>01（无锁）</td><td>阻塞中</td></tr><tr><td>-</td><td>10（重量锁）</td><td>竞争重量锁</td></tr><tr><td>-</td><td>10（重量锁）</td><td>成功（加锁）</td></tr><tr><td>-</td><td>…</td><td>…</td></tr></tbody></table><p>线程之间有竞争的情况下，轻量级锁膨胀为重量级锁。</p><h3 id="重量锁" tabindex="-1"><a class="header-anchor" href="#重量锁" aria-hidden="true">#</a> 重量锁</h3><p>重量级锁竞争的时候，还可以使用自旋来进行优化，如果当前线程自旋成功（即这时候持锁线程已经退出了同步块，释放了锁），这时当前线程就可以避免阻塞。</p><p>在 Java 6 之后自旋锁是自适应的，比如对象刚刚的一次自旋操作成功过，那么认为这次自旋成功的可能性会高，就多自旋几次；反之，就少自旋甚至不自旋，总之，比较智能。</p><ul><li>自旋会占用 CPU 时间，单核 CPU 自旋就是浪费，多核 CPU 自旋才能发挥优势。</li><li>好比等红灯时汽车是不是熄火，不熄火相当于自旋（等待时间短了划算），熄火了相当于阻塞（等待时间长了划算）</li><li>Java 7 之后不能控制是否开启自旋功能</li></ul><p>自旋重试成功的情况</p><table><thead><tr><th>线程1（cpu1上）</th><th>对象Mark</th><th>线程2（cpu2上）</th></tr></thead><tbody><tr><td>-</td><td>10（重量锁）</td><td>-</td></tr><tr><td>访问同步块，获取 monitor</td><td>10（重量锁）重量锁指针</td><td>-</td></tr><tr><td>成功（加锁）</td><td>10（重量锁）重量锁指针</td><td>-</td></tr><tr><td>执行同步块</td><td>10（重量锁）重量锁指针</td><td>-</td></tr><tr><td>执行同步块</td><td>10（重量锁）重量锁指针</td><td>访问同步块，获取 monitor</td></tr><tr><td>执行同步块</td><td>10（重量锁）重量锁指针</td><td>自旋重试</td></tr><tr><td>执行完毕</td><td>10（重量锁）重量锁指针</td><td>自旋重试</td></tr><tr><td>成功（解锁）</td><td>01（无锁）</td><td>自旋重试</td></tr><tr><td>-</td><td>10（重量锁）重量锁指针</td><td>成功（加锁）</td></tr><tr><td>-</td><td>10（重量锁）重量锁指针</td><td>执行同步块</td></tr><tr><td>-</td><td>…</td><td>…</td></tr></tbody></table><p>自旋重试失败的情况</p><table><thead><tr><th>线程1（cpu1上）</th><th>对象Mark</th><th>线程2（cpu2上）</th></tr></thead><tbody><tr><td>-</td><td>10（重量锁）</td><td>-</td></tr><tr><td>访问同步块，获取 monitor</td><td>10（重量锁）重量锁指针</td><td>-</td></tr><tr><td>成功（加锁）</td><td>10（重量锁）重量锁指针</td><td>-</td></tr><tr><td>执行同步块</td><td>10（重量锁）重量锁指针</td><td>-</td></tr><tr><td>执行同步块</td><td>10（重量锁）重量锁指针</td><td>访问同步块，获取 monitor</td></tr><tr><td>执行同步块</td><td>10（重量锁）重量锁指针</td><td>自旋重试</td></tr><tr><td>执行同步块</td><td>10（重量锁）重量锁指针</td><td>自旋重试</td></tr><tr><td>执行同步块</td><td>10（重量锁）重量锁指针</td><td>自旋重试</td></tr><tr><td>执行同步块</td><td>10（重量锁）重量锁指针</td><td>阻塞</td></tr><tr><td>-</td><td>…</td><td>…</td></tr></tbody></table><h3 id="偏向锁" tabindex="-1"><a class="header-anchor" href="#偏向锁" aria-hidden="true">#</a> 偏向锁</h3><p>轻量级锁在没有竞争时（就自己这个线程），每次重入仍然需要执行 CAS 操作。Java 6 中引入了偏向锁来做进一步优化：只有第一次使用 CAS 将线程 ID 设置到对象的 Mark Word 头，之后发现这个线程 ID是自己的就表示没有竞争，不用重新 CAS.</p><ul><li>撤销偏向需要将持锁线程升级为轻量级锁，这个过程中所有线程需要暂停（STW）</li><li>访问对象的 hashCode 也会撤销偏向锁</li><li>如果对象虽然被多个线程访问，但没有竞争，这时偏向了线程 T1 的对象仍有机会重新偏向 T2，重偏向会重置对象的 Thread ID</li><li>撤销偏向和重偏向都是批量进行的，以类为单位，类的所有对象批量操作</li><li>如果撤销偏向到达某个阈值，整个类的所有对象都会变为不可偏向的。总是撤销，就直接不给你偏向了。</li><li>可以主动使用 -XX:-UseBiasedLocking 禁用偏向锁</li></ul><p>可以参考这篇论文：<a href="https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-149958.pdf" target="_blank" rel="noopener noreferrer">https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-149958.pdf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>假设有两个方法同步块，利用同一个对象加锁</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 同步块 A </span>
    <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 同步块 B </span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>线程1</th><th>对象Mark</th></tr></thead><tbody><tr><td>访问同步块 A，检查 Mark 中是否有线程 ID</td><td>101（无锁可偏向）</td></tr><tr><td>尝试加偏向锁</td><td>101（无锁可偏向）对象 hashCode</td></tr><tr><td>成功</td><td>101（无锁可偏向）线程ID</td></tr><tr><td>执行同步块 A</td><td>101（无锁可偏向）线程ID</td></tr><tr><td>访问同步块 B，检查 Mark 中是否有线程 ID</td><td>101（无锁可偏向）线程ID</td></tr><tr><td>是自己的线程 ID，锁是自己的，无需做更多操作</td><td>101（无锁可偏向）线程ID</td></tr><tr><td>执行同步块 B</td><td>101（无锁可偏向）线程ID</td></tr><tr><td>执行完毕</td><td>101（无锁可偏向）对象 hashCode</td></tr></tbody></table><h3 id="其他优化" tabindex="-1"><a class="header-anchor" href="#其他优化" aria-hidden="true">#</a> 其他优化</h3><h4 id="减少上锁时间" tabindex="-1"><a class="header-anchor" href="#减少上锁时间" aria-hidden="true">#</a> 减少上锁时间</h4><p>同步代码块中尽量短</p><h4 id="减少锁的粒度" tabindex="-1"><a class="header-anchor" href="#减少锁的粒度" aria-hidden="true">#</a> 减少锁的粒度</h4><p>将一个锁拆分为多个锁提高并发度，例如：</p><ul><li>ConcurrentHashMap</li><li>LongAdder 分为 base 和 cells 两部分。没有并发争用的时候或者是 cells 数组正在初始化的时候，会使用 CAS 来累加值到 base，有并发争用，会初始化 cells 数组，数组有多少个 cell，就允许有多少线程并行修改，最后将数组中每个 cell 累加，再加上 base 就是最终的值</li><li>LinkedBlockingQueue 入队和出队使用不同的锁，相对于LinkedBlockingArray只有一个锁效率要高</li></ul><h4 id="锁粗化" tabindex="-1"><a class="header-anchor" href="#锁粗化" aria-hidden="true">#</a> 锁粗化</h4><p>多次循环进入同步块不如同步块内多次循环 另外 JVM 可能会做如下优化，把多次 append 的加锁操作粗化为一次（因为都是对同一个对象加锁，没必要重入多次）</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="锁消除" tabindex="-1"><a class="header-anchor" href="#锁消除" aria-hidden="true">#</a> 锁消除</h4><p>JVM 会进行代码的逃逸分析，例如某个加锁对象是方法内局部变量，不会被其它线程所访问到，这时候就会被即时编译器忽略掉所有同步操作。</p><h4 id="读写分离" tabindex="-1"><a class="header-anchor" href="#读写分离" aria-hidden="true">#</a> 读写分离</h4><p>CopyOnWriteArrayList ConyOnWriteSet</p><p>参考：</p><p><a href="https://wiki.openjdk.java.net/display/HotSpot/Synchronization" target="_blank" rel="noopener noreferrer">https://wiki.openjdk.java.net/display/HotSpot/Synchronization<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="http://luojinping.com/2015/07/09/java%E9%94%81%E4%BC%98%E5%8C%96/" target="_blank" rel="noopener noreferrer">http://luojinping.com/2015/07/09/java锁优化/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://www.infoq.cn/article/java-se-16-synchronized" target="_blank" rel="noopener noreferrer">https://www.infoq.cn/article/java-se-16-synchronized<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://www.jianshu.com/p/9932047a89be" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/9932047a89be<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://www.cnblogs.com/sheeva/p/6366782.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/sheeva/p/6366782.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://stackoverflflow.com/questions/46312817/does-java-ever-rebias-an-individual-lock" target="_blank" rel="noopener noreferrer">https://stackoverflflow.com/questions/46312817/does-java-ever-rebias-an-individual-lock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/tt110617/edit/main/demo/src/backend/java/jvm/jvm08.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/8/29 21:57:52</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 1253728268@qq.com">hzz</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/myblog/backend/java/jvm/jvm07.html" class="nav-link prev" aria-label="七、运行期优化"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->七、运行期优化</div></a><!----></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"></div><div class="copyright">Copyright © 2022 十一</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/myblog/assets/app.6a2d513d.js" defer></script>
  </body>
</html>
