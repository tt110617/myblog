<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.49" />
    <meta name="theme" content="VuePress Theme Hope" />
    <title>一、基础篇 | tt110617</title><meta name="description" content="网站">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/myblog/assets/style.f2a6604f.css">
    <link rel="modulepreload" href="/myblog/assets/app.6a2d513d.js"><link rel="modulepreload" href="/myblog/assets/basics.html.64ecf975.js"><link rel="modulepreload" href="/myblog/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/myblog/assets/basics.html.ec7af011.js"><link rel="prefetch" href="/myblog/assets/index.html.d1ca62f7.js"><link rel="prefetch" href="/myblog/assets/index.html.b5c38db1.js"><link rel="prefetch" href="/myblog/assets/index.html.feb38b0c.js"><link rel="prefetch" href="/myblog/assets/algorithm01.html.dd1af2b2.js"><link rel="prefetch" href="/myblog/assets/algorithm02.html.6645e291.js"><link rel="prefetch" href="/myblog/assets/algorithm03.html.9da54164.js"><link rel="prefetch" href="/myblog/assets/LeetCode Hot 100.html.95af3c37.js"><link rel="prefetch" href="/myblog/assets/index.html.2770fb04.js"><link rel="prefetch" href="/myblog/assets/index.html.9f31cb98.js"><link rel="prefetch" href="/myblog/assets/MongoDB.html.747bd522.js"><link rel="prefetch" href="/myblog/assets/index.html.7970fd4d.js"><link rel="prefetch" href="/myblog/assets/index.html.d76d8eeb.js"><link rel="prefetch" href="/myblog/assets/Docker.html.7e9153cc.js"><link rel="prefetch" href="/myblog/assets/ElasticSearch.html.68bc187d.js"><link rel="prefetch" href="/myblog/assets/nginx.html.feb27b40.js"><link rel="prefetch" href="/myblog/assets/index.html.c88cf0a5.js"><link rel="prefetch" href="/myblog/assets/java8新特性.html.eba77086.js"><link rel="prefetch" href="/myblog/assets/index.html.db442bd7.js"><link rel="prefetch" href="/myblog/assets/index.html.e978b3f4.js"><link rel="prefetch" href="/myblog/assets/vue2.html.cd054f5f.js"><link rel="prefetch" href="/myblog/assets/vue3.html.09644e9e.js"><link rel="prefetch" href="/myblog/assets/mysql01.html.14852074.js"><link rel="prefetch" href="/myblog/assets/mysql02.html.19638d4a.js"><link rel="prefetch" href="/myblog/assets/mysql03.html.19940ab5.js"><link rel="prefetch" href="/myblog/assets/mysql04.html.ff20e708.js"><link rel="prefetch" href="/myblog/assets/index.html.aeaeabce.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.5de27bef.js"><link rel="prefetch" href="/myblog/assets/network01.html.d374f53e.js"><link rel="prefetch" href="/myblog/assets/network02.html.612f1790.js"><link rel="prefetch" href="/myblog/assets/network03.html.f409d6e1.js"><link rel="prefetch" href="/myblog/assets/network04.html.417995ce.js"><link rel="prefetch" href="/myblog/assets/network05.html.383f02d3.js"><link rel="prefetch" href="/myblog/assets/network06.html.6b7b74f3.js"><link rel="prefetch" href="/myblog/assets/index.html.a5289baa.js"><link rel="prefetch" href="/myblog/assets/index.html.1ad05321.js"><link rel="prefetch" href="/myblog/assets/Redis01.html.43cb742a.js"><link rel="prefetch" href="/myblog/assets/Redis02.html.ba0a875f.js"><link rel="prefetch" href="/myblog/assets/Redis03.html.c65b1aff.js"><link rel="prefetch" href="/myblog/assets/Redis04.html.8d20d57a.js"><link rel="prefetch" href="/myblog/assets/Redis05.html.66a2065a.js"><link rel="prefetch" href="/myblog/assets/Redisson原理.html.e587d689.js"><link rel="prefetch" href="/myblog/assets/practice.html.3d6fcedb.js"><link rel="prefetch" href="/myblog/assets/index.html.195983d3.js"><link rel="prefetch" href="/myblog/assets/index.html.ffce25e3.js"><link rel="prefetch" href="/myblog/assets/SpringBoot01.html.1539f2df.js"><link rel="prefetch" href="/myblog/assets/SpringBoot02.html.8d492936.js"><link rel="prefetch" href="/myblog/assets/Dubbo.html.25f8081d.js"><link rel="prefetch" href="/myblog/assets/index.html.25b97898.js"><link rel="prefetch" href="/myblog/assets/SpringCloud.html.11fa754a.js"><link rel="prefetch" href="/myblog/assets/SpringCloudAibaba.html.ba7822c1.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.e3fba77d.js"><link rel="prefetch" href="/myblog/assets/RabbitMQ.html.d245b413.js"><link rel="prefetch" href="/myblog/assets/index.html.2e0e8a71.js"><link rel="prefetch" href="/myblog/assets/OAuth2.0.html.ec57b0c6.js"><link rel="prefetch" href="/myblog/assets/index.html.195b9b99.js"><link rel="prefetch" href="/myblog/assets/SpringSecurity.html.f53a3387.js"><link rel="prefetch" href="/myblog/assets/design01.html.a9ca0966.js"><link rel="prefetch" href="/myblog/assets/design02.html.14685d48.js"><link rel="prefetch" href="/myblog/assets/design03.html.d0742e22.js"><link rel="prefetch" href="/myblog/assets/design04.html.4b4d3a60.js"><link rel="prefetch" href="/myblog/assets/design05.html.dd009a09.js"><link rel="prefetch" href="/myblog/assets/index.html.de8a79d7.js"><link rel="prefetch" href="/myblog/assets/juc01.html.7b5b2a61.js"><link rel="prefetch" href="/myblog/assets/juc02.html.e7af61bf.js"><link rel="prefetch" href="/myblog/assets/juc03.html.c680cb04.js"><link rel="prefetch" href="/myblog/assets/index.html.3ef30b14.js"><link rel="prefetch" href="/myblog/assets/jvm01.html.226ff0ab.js"><link rel="prefetch" href="/myblog/assets/jvm02.html.ad530863.js"><link rel="prefetch" href="/myblog/assets/jvm03.html.af77ed0d.js"><link rel="prefetch" href="/myblog/assets/jvm04.html.dd845ccc.js"><link rel="prefetch" href="/myblog/assets/jvm05.html.56d56c94.js"><link rel="prefetch" href="/myblog/assets/jvm06.html.8c5c08ed.js"><link rel="prefetch" href="/myblog/assets/jvm07.html.8713dffe.js"><link rel="prefetch" href="/myblog/assets/jvm08.html.396f92cc.js"><link rel="prefetch" href="/myblog/assets/index.html.cacef81d.js"><link rel="prefetch" href="/myblog/assets/404.html.82bd4b1a.js"><link rel="prefetch" href="/myblog/assets/index.html.2f713335.js"><link rel="prefetch" href="/myblog/assets/index.html.1a811f74.js"><link rel="prefetch" href="/myblog/assets/index.html.79fe6d6e.js"><link rel="prefetch" href="/myblog/assets/index.html.dcd15e89.js"><link rel="prefetch" href="/myblog/assets/index.html.e8952663.js"><link rel="prefetch" href="/myblog/assets/index.html.5ad7ff00.js"><link rel="prefetch" href="/myblog/assets/index.html.92637d35.js"><link rel="prefetch" href="/myblog/assets/index.html.6033e64c.js"><link rel="prefetch" href="/myblog/assets/index.html.29a3be67.js"><link rel="prefetch" href="/myblog/assets/index.html.d2aef326.js"><link rel="prefetch" href="/myblog/assets/index.html.61fd0259.js"><link rel="prefetch" href="/myblog/assets/index.html.cf3e5974.js"><link rel="prefetch" href="/myblog/assets/index.html.b7fddec6.js"><link rel="prefetch" href="/myblog/assets/index.html.2d1c3407.js"><link rel="prefetch" href="/myblog/assets/index.html.f6e57d32.js"><link rel="prefetch" href="/myblog/assets/index.html.57cfa80f.js"><link rel="prefetch" href="/myblog/assets/index.html.5f4c6904.js"><link rel="prefetch" href="/myblog/assets/index.html.adc9fbf5.js"><link rel="prefetch" href="/myblog/assets/index.html.de6bf546.js"><link rel="prefetch" href="/myblog/assets/index.html.5802a134.js"><link rel="prefetch" href="/myblog/assets/index.html.00532d93.js"><link rel="prefetch" href="/myblog/assets/index.html.dcdb8b0c.js"><link rel="prefetch" href="/myblog/assets/index.html.64a2ffc8.js"><link rel="prefetch" href="/myblog/assets/index.html.aa56265b.js"><link rel="prefetch" href="/myblog/assets/index.html.cf5fc743.js"><link rel="prefetch" href="/myblog/assets/index.html.dd0debdd.js"><link rel="prefetch" href="/myblog/assets/index.html.598a85b3.js"><link rel="prefetch" href="/myblog/assets/algorithm01.html.9516ff71.js"><link rel="prefetch" href="/myblog/assets/algorithm02.html.f215eb2a.js"><link rel="prefetch" href="/myblog/assets/algorithm03.html.b981d3d4.js"><link rel="prefetch" href="/myblog/assets/LeetCode Hot 100.html.921fe2c8.js"><link rel="prefetch" href="/myblog/assets/index.html.9ff070dd.js"><link rel="prefetch" href="/myblog/assets/index.html.f985f07c.js"><link rel="prefetch" href="/myblog/assets/MongoDB.html.367811ae.js"><link rel="prefetch" href="/myblog/assets/index.html.ccc78fec.js"><link rel="prefetch" href="/myblog/assets/index.html.cd9c8951.js"><link rel="prefetch" href="/myblog/assets/Docker.html.9aa6750f.js"><link rel="prefetch" href="/myblog/assets/ElasticSearch.html.834de972.js"><link rel="prefetch" href="/myblog/assets/nginx.html.96457f50.js"><link rel="prefetch" href="/myblog/assets/index.html.5f9750b5.js"><link rel="prefetch" href="/myblog/assets/java8新特性.html.72523a0c.js"><link rel="prefetch" href="/myblog/assets/index.html.4267a9c7.js"><link rel="prefetch" href="/myblog/assets/index.html.64b7cc16.js"><link rel="prefetch" href="/myblog/assets/vue2.html.019d3a52.js"><link rel="prefetch" href="/myblog/assets/vue3.html.f014c692.js"><link rel="prefetch" href="/myblog/assets/mysql01.html.1f3c1d4e.js"><link rel="prefetch" href="/myblog/assets/mysql02.html.6085f62b.js"><link rel="prefetch" href="/myblog/assets/mysql03.html.a05b3e35.js"><link rel="prefetch" href="/myblog/assets/mysql04.html.f83e6c8a.js"><link rel="prefetch" href="/myblog/assets/index.html.c2377b6c.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.62e502c2.js"><link rel="prefetch" href="/myblog/assets/network01.html.bb391280.js"><link rel="prefetch" href="/myblog/assets/network02.html.4835dc75.js"><link rel="prefetch" href="/myblog/assets/network03.html.529a44ea.js"><link rel="prefetch" href="/myblog/assets/network04.html.c4a9ab39.js"><link rel="prefetch" href="/myblog/assets/network05.html.fefe6411.js"><link rel="prefetch" href="/myblog/assets/network06.html.4098bbbd.js"><link rel="prefetch" href="/myblog/assets/index.html.9a37999d.js"><link rel="prefetch" href="/myblog/assets/index.html.25f73ada.js"><link rel="prefetch" href="/myblog/assets/Redis01.html.4774eebb.js"><link rel="prefetch" href="/myblog/assets/Redis02.html.7aa43754.js"><link rel="prefetch" href="/myblog/assets/Redis03.html.3b35817c.js"><link rel="prefetch" href="/myblog/assets/Redis04.html.1eb9f421.js"><link rel="prefetch" href="/myblog/assets/Redis05.html.445e2fb4.js"><link rel="prefetch" href="/myblog/assets/Redisson原理.html.a6281fb0.js"><link rel="prefetch" href="/myblog/assets/practice.html.9bd91dc4.js"><link rel="prefetch" href="/myblog/assets/index.html.45528417.js"><link rel="prefetch" href="/myblog/assets/index.html.2765f82f.js"><link rel="prefetch" href="/myblog/assets/SpringBoot01.html.5e31fcb7.js"><link rel="prefetch" href="/myblog/assets/SpringBoot02.html.bbddd314.js"><link rel="prefetch" href="/myblog/assets/Dubbo.html.ccbf57f9.js"><link rel="prefetch" href="/myblog/assets/index.html.534d4ae8.js"><link rel="prefetch" href="/myblog/assets/SpringCloud.html.eab22d83.js"><link rel="prefetch" href="/myblog/assets/SpringCloudAibaba.html.79284ee6.js"><link rel="prefetch" href="/myblog/assets/mianshi.html.da3eb94f.js"><link rel="prefetch" href="/myblog/assets/RabbitMQ.html.1224037c.js"><link rel="prefetch" href="/myblog/assets/index.html.668ad86c.js"><link rel="prefetch" href="/myblog/assets/OAuth2.0.html.aabd01a5.js"><link rel="prefetch" href="/myblog/assets/index.html.9cd27700.js"><link rel="prefetch" href="/myblog/assets/SpringSecurity.html.469ecc81.js"><link rel="prefetch" href="/myblog/assets/design01.html.2b9f9e86.js"><link rel="prefetch" href="/myblog/assets/design02.html.849b42b0.js"><link rel="prefetch" href="/myblog/assets/design03.html.e4be33cd.js"><link rel="prefetch" href="/myblog/assets/design04.html.bc31a0d9.js"><link rel="prefetch" href="/myblog/assets/design05.html.d5c35997.js"><link rel="prefetch" href="/myblog/assets/index.html.4a7a1688.js"><link rel="prefetch" href="/myblog/assets/juc01.html.5bb1f884.js"><link rel="prefetch" href="/myblog/assets/juc02.html.0ce510cd.js"><link rel="prefetch" href="/myblog/assets/juc03.html.e93fe7b6.js"><link rel="prefetch" href="/myblog/assets/index.html.b5425fa1.js"><link rel="prefetch" href="/myblog/assets/jvm01.html.f238e096.js"><link rel="prefetch" href="/myblog/assets/jvm02.html.a9498b0d.js"><link rel="prefetch" href="/myblog/assets/jvm03.html.460f2e71.js"><link rel="prefetch" href="/myblog/assets/jvm04.html.7205bd05.js"><link rel="prefetch" href="/myblog/assets/jvm05.html.edac738a.js"><link rel="prefetch" href="/myblog/assets/jvm06.html.91cbb3f0.js"><link rel="prefetch" href="/myblog/assets/jvm07.html.f40c12f1.js"><link rel="prefetch" href="/myblog/assets/jvm08.html.fb107a67.js"><link rel="prefetch" href="/myblog/assets/index.html.3ba3011a.js"><link rel="prefetch" href="/myblog/assets/404.html.1f196261.js"><link rel="prefetch" href="/myblog/assets/index.html.1375c5bc.js"><link rel="prefetch" href="/myblog/assets/index.html.90d1ac0c.js"><link rel="prefetch" href="/myblog/assets/index.html.4d12ff1c.js"><link rel="prefetch" href="/myblog/assets/index.html.8ddb93d5.js"><link rel="prefetch" href="/myblog/assets/index.html.dd098c61.js"><link rel="prefetch" href="/myblog/assets/index.html.cebf8dc1.js"><link rel="prefetch" href="/myblog/assets/index.html.5674ca1e.js"><link rel="prefetch" href="/myblog/assets/index.html.d2abca49.js"><link rel="prefetch" href="/myblog/assets/index.html.1351de8d.js"><link rel="prefetch" href="/myblog/assets/index.html.9de6b46c.js"><link rel="prefetch" href="/myblog/assets/index.html.611ec9ae.js"><link rel="prefetch" href="/myblog/assets/index.html.a02c1bed.js"><link rel="prefetch" href="/myblog/assets/index.html.eb87c7a9.js"><link rel="prefetch" href="/myblog/assets/index.html.33261d15.js"><link rel="prefetch" href="/myblog/assets/index.html.5589fc08.js"><link rel="prefetch" href="/myblog/assets/index.html.f989be9b.js"><link rel="prefetch" href="/myblog/assets/index.html.9f0a51f1.js"><link rel="prefetch" href="/myblog/assets/index.html.49bd673c.js"><link rel="prefetch" href="/myblog/assets/index.html.f1449990.js"><link rel="prefetch" href="/myblog/assets/index.html.b063a78e.js"><link rel="prefetch" href="/myblog/assets/index.html.3f40e5f3.js"><link rel="prefetch" href="/myblog/assets/index.html.56c44de1.js"><link rel="prefetch" href="/myblog/assets/index.html.f8a7efd0.js"><link rel="prefetch" href="/myblog/assets/index.html.c2db4fad.js"><link rel="prefetch" href="/myblog/assets/404.d0d6ec4e.js"><link rel="prefetch" href="/myblog/assets/Layout.4e3e5e78.js"><link rel="prefetch" href="/myblog/assets/Slide.81c38424.js"><link rel="prefetch" href="/myblog/assets/Blog.d28c723c.js"><link rel="prefetch" href="/myblog/assets/auto.264f6c8c.js"><link rel="prefetch" href="/myblog/assets/index.d8a59108.js"><link rel="prefetch" href="/myblog/assets/index.1842ee54.js"><link rel="prefetch" href="/myblog/assets/mermaid.esm.min.fac286bf.js"><link rel="prefetch" href="/myblog/assets/highlight.esm.d982e650.js"><link rel="prefetch" href="/myblog/assets/markdown.esm.832a189d.js"><link rel="prefetch" href="/myblog/assets/math.esm.a3f84b6f.js"><link rel="prefetch" href="/myblog/assets/notes.esm.3c361cb7.js"><link rel="prefetch" href="/myblog/assets/reveal.esm.b96f05d8.js"><link rel="prefetch" href="/myblog/assets/search.esm.80da4a02.js"><link rel="prefetch" href="/myblog/assets/zoom.esm.8514a202.js"><link rel="prefetch" href="/myblog/assets/Playground.c4bd3c9e.js"><link rel="prefetch" href="/myblog/assets/photoswipe.esm.218074cd.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/myblog/" class="brand"><img class="logo" src="/myblog/avatar.jpg" alt="tt110617"><!----><span class="site-name hide-in-pad">tt110617</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/myblog/" class="nav-link" aria-label="首页"><span class="icon iconfont icon-home"></span>首页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/myblog/backend/" class="nav-link active" aria-label="后端"><span class="icon iconfont icon-java"></span>后端<!----></a></div><div class="nav-item hide-in-mobile"><a href="/myblog/frontend/" class="nav-link" aria-label="前端"><span class="icon iconfont icon-vue"></span>前端<!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://github.com/tt110617" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-java"></span><span class="title">Java</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><img class="icon" src="/myblog/icon/gaoxingneng.png"><span class="title">高性能</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-computer"></span><span class="title">计算机基础</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-frame"></span><span class="title">框架</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><img class="icon" src="/myblog/icon/odbc-full.png"><span class="title">数据库</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/myblog/backend/database/MongoDB.html" class="nav-link sidebar-link sidebar-page" aria-label="MongoDB"><!---->MongoDB<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-mysql"></span><span class="title">MySQL</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-mysql"></span><span class="title">MySQL实战四十五讲</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="一、基础篇"><!---->一、基础篇<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-基础架构-一条sql查询语句是如何执行的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.基础架构：一条SQL查询语句是如何执行的？"><!---->1.基础架构：一条SQL查询语句是如何执行的？<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-1-mysql-的逻辑架构图" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1 MySQL 的逻辑架构图"><!---->1.1 MySQL 的逻辑架构图<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-2-连接器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2 连接器"><!---->1.2 连接器<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-3-查询缓存" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3 查询缓存"><!---->1.3 查询缓存<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-4-分析器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.4 分析器"><!---->1.4 分析器<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-5-优化器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.5 优化器"><!---->1.5 优化器<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-6-执行器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.6 执行器"><!---->1.6 执行器<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-7-问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.7 问题"><!---->1.7 问题<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-日志系统-一条sql更新语句是如何执行的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.日志系统：一条SQL更新语句是如何执行的？"><!---->2.日志系统：一条SQL更新语句是如何执行的？<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-1-redo-log" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 redo log"><!---->2.1 redo log<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-2-binlog" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2 binlog"><!---->2.2 binlog<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-3-update-语句的执行流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.3 update 语句的执行流程"><!---->2.3 update 语句的执行流程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-4-两阶段提交" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.4 两阶段提交"><!---->2.4 两阶段提交<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-5-问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.5 问题"><!---->2.5 问题<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_3-事务隔离-为什么你改了我还看不见" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.事务隔离：为什么你改了我还看不见？"><!---->3.事务隔离：为什么你改了我还看不见？<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_3-1-隔离性与隔离级别" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.1 隔离性与隔离级别"><!---->3.1 隔离性与隔离级别<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_3-2-事务隔离级别的实现" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.2 事务隔离级别的实现"><!---->3.2 事务隔离级别的实现<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_3-3-事务的启动方式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.3 事务的启动方式"><!---->3.3 事务的启动方式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_3-4-问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.4 问题"><!---->3.4 问题<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_4-深入浅出索引-上" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.深入浅出索引（上）"><!---->4.深入浅出索引（上）<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_4-1-索引的常见模型" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1 索引的常见模型"><!---->4.1 索引的常见模型<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_4-2-innodb-的索引模型" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.2 InnoDB 的索引模型"><!---->4.2 InnoDB 的索引模型<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_4-3-索引维护" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.3 索引维护"><!---->4.3 索引维护<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_4-4-问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4 问题"><!---->4.4 问题<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_5-深入浅出索引-下" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.深入浅出索引（下）"><!---->5.深入浅出索引（下）<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_5-1-覆盖索引" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.1 覆盖索引"><!---->5.1 覆盖索引<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_5-2-最左前缀原则" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.2 最左前缀原则"><!---->5.2 最左前缀原则<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_5-3-索引下推" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.3 索引下推"><!---->5.3 索引下推<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_5-4-问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.4 问题"><!---->5.4 问题<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_6-全局锁和表锁-给表加个字段怎么有这么多阻碍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.全局锁和表锁 ：给表加个字段怎么有这么多阻碍？"><!---->6.全局锁和表锁 ：给表加个字段怎么有这么多阻碍？<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_6-1-全局锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.1 全局锁"><!---->6.1 全局锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_6-2-表级锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.2 表级锁"><!---->6.2 表级锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_6-3-问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.3 问题"><!---->6.3 问题<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_7-行锁功过-怎么减少行锁对性能的影响" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.行锁功过：怎么减少行锁对性能的影响？"><!---->7.行锁功过：怎么减少行锁对性能的影响？<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_7-1-从两阶段锁说起" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.1 从两阶段锁说起"><!---->7.1 从两阶段锁说起<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_7-2-死锁和死锁检测" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.2 死锁和死锁检测"><!---->7.2 死锁和死锁检测<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_7-3-问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.3 问题"><!---->7.3 问题<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_8-事务到底是隔离的还是不隔离的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.事务到底是隔离的还是不隔离的？"><!---->8.事务到底是隔离的还是不隔离的？<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_8-1-快照-在mvcc里是怎么工作的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.1 “快照”在MVCC里是怎么工作的？"><!---->8.1 “快照”在MVCC里是怎么工作的？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_8-2-更新逻辑" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.2 更新逻辑"><!---->8.2 更新逻辑<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_8-3-小结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.3 小结"><!---->8.3 小结<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_8-4-问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.4 问题"><!---->8.4 问题<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/myblog/backend/database/shizhan/practice.html" class="nav-link sidebar-link sidebar-page" aria-label="二、实践篇"><!---->二、实践篇<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-stack"></span><span class="title">Redis</span><span class="arrow right"></span></button><!----></section><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-snow"></span><span class="title">算法</span><span class="arrow right"></span></button><!----></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->一、基础篇</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down" localizeddate="2022年8月18日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="/myblog/article/" target="_blank" rel="noopener noreferrer">十一</a></span><span property="author" content="十一"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年8月18日</span><meta property="datePublished" content="2022-08-18T00:00:00.000Z"></span><span class="category-info" aria-label="分类🌈" data-balloon-pos="down" localizeddate="2022年8月18日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><ul class="categories-wrapper"><li class="category category6 clickable" role="navigation">数据库</li><meta property="articleSection" content="数据库"></ul></span><span aria-label="标签🏷" data-balloon-pos="down" localizeddate="2022年8月18日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li class="tag tag1 clickable" role="navigation">MySQL实战四十五讲</li></ul><meta property="keywords" content="MySQL实战四十五讲"></span><span class="words-info" aria-label="字数🔠" data-balloon-pos="down" localizeddate="2022年8月18日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 13867 字</span><meta property="wordCount" content="13867"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-基础架构-一条sql查询语句是如何执行的" class="router-link-active router-link-exact-active toc-link level2">1.基础架构：一条SQL查询语句是如何执行的？</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-1-mysql-的逻辑架构图" class="router-link-active router-link-exact-active toc-link level3">1.1 MySQL 的逻辑架构图</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-2-连接器" class="router-link-active router-link-exact-active toc-link level3">1.2 连接器</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-3-查询缓存" class="router-link-active router-link-exact-active toc-link level3">1.3 查询缓存</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-4-分析器" class="router-link-active router-link-exact-active toc-link level3">1.4 分析器</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-5-优化器" class="router-link-active router-link-exact-active toc-link level3">1.5 优化器</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-6-执行器" class="router-link-active router-link-exact-active toc-link level3">1.6 执行器</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_1-7-问题" class="router-link-active router-link-exact-active toc-link level3">1.7 问题</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-日志系统-一条sql更新语句是如何执行的" class="router-link-active router-link-exact-active toc-link level2">2.日志系统：一条SQL更新语句是如何执行的？</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-1-redo-log" class="router-link-active router-link-exact-active toc-link level3">2.1 redo log</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-2-binlog" class="router-link-active router-link-exact-active toc-link level3">2.2 binlog</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-3-update-语句的执行流程" class="router-link-active router-link-exact-active toc-link level3">2.3 update 语句的执行流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-4-两阶段提交" class="router-link-active router-link-exact-active toc-link level3">2.4 两阶段提交</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_2-5-问题" class="router-link-active router-link-exact-active toc-link level3">2.5 问题</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_3-事务隔离-为什么你改了我还看不见" class="router-link-active router-link-exact-active toc-link level2">3.事务隔离：为什么你改了我还看不见？</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_3-1-隔离性与隔离级别" class="router-link-active router-link-exact-active toc-link level3">3.1 隔离性与隔离级别</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_3-2-事务隔离级别的实现" class="router-link-active router-link-exact-active toc-link level3">3.2 事务隔离级别的实现</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_3-3-事务的启动方式" class="router-link-active router-link-exact-active toc-link level3">3.3 事务的启动方式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_3-4-问题" class="router-link-active router-link-exact-active toc-link level3">3.4 问题</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_4-深入浅出索引-上" class="router-link-active router-link-exact-active toc-link level2">4.深入浅出索引（上）</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_4-1-索引的常见模型" class="router-link-active router-link-exact-active toc-link level3">4.1 索引的常见模型</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_4-2-innodb-的索引模型" class="router-link-active router-link-exact-active toc-link level3">4.2 InnoDB 的索引模型</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_4-3-索引维护" class="router-link-active router-link-exact-active toc-link level3">4.3 索引维护</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_4-4-问题" class="router-link-active router-link-exact-active toc-link level3">4.4 问题</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_5-深入浅出索引-下" class="router-link-active router-link-exact-active toc-link level2">5.深入浅出索引（下）</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_5-1-覆盖索引" class="router-link-active router-link-exact-active toc-link level3">5.1 覆盖索引</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_5-2-最左前缀原则" class="router-link-active router-link-exact-active toc-link level3">5.2 最左前缀原则</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_5-3-索引下推" class="router-link-active router-link-exact-active toc-link level3">5.3 索引下推</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_5-4-问题" class="router-link-active router-link-exact-active toc-link level3">5.4 问题</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_6-全局锁和表锁-给表加个字段怎么有这么多阻碍" class="router-link-active router-link-exact-active toc-link level2">6.全局锁和表锁 ：给表加个字段怎么有这么多阻碍？</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_6-1-全局锁" class="router-link-active router-link-exact-active toc-link level3">6.1 全局锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_6-2-表级锁" class="router-link-active router-link-exact-active toc-link level3">6.2 表级锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_6-3-问题" class="router-link-active router-link-exact-active toc-link level3">6.3 问题</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_7-行锁功过-怎么减少行锁对性能的影响" class="router-link-active router-link-exact-active toc-link level2">7.行锁功过：怎么减少行锁对性能的影响？</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_7-1-从两阶段锁说起" class="router-link-active router-link-exact-active toc-link level3">7.1 从两阶段锁说起</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_7-2-死锁和死锁检测" class="router-link-active router-link-exact-active toc-link level3">7.2 死锁和死锁检测</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_7-3-问题" class="router-link-active router-link-exact-active toc-link level3">7.3 问题</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_8-事务到底是隔离的还是不隔离的" class="router-link-active router-link-exact-active toc-link level2">8.事务到底是隔离的还是不隔离的？</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_8-1-快照-在mvcc里是怎么工作的" class="router-link-active router-link-exact-active toc-link level3">8.1 “快照”在MVCC里是怎么工作的？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_8-2-更新逻辑" class="router-link-active router-link-exact-active toc-link level3">8.2 更新逻辑</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_8-3-小结" class="router-link-active router-link-exact-active toc-link level3">8.3 小结</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/myblog/backend/database/shizhan/basics.html#_8-4-问题" class="router-link-active router-link-exact-active toc-link level3">8.4 问题</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="一、基础篇" tabindex="-1"><a class="header-anchor" href="#一、基础篇" aria-hidden="true">#</a> 一、基础篇</h1><h2 id="_1-基础架构-一条sql查询语句是如何执行的" tabindex="-1"><a class="header-anchor" href="#_1-基础架构-一条sql查询语句是如何执行的" aria-hidden="true">#</a> 1.基础架构：一条SQL查询语句是如何执行的？</h2><h3 id="_1-1-mysql-的逻辑架构图" tabindex="-1"><a class="header-anchor" href="#_1-1-mysql-的逻辑架构图" aria-hidden="true">#</a> 1.1 MySQL 的逻辑架构图</h3><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220814135731854.png" alt="image-20220814135731854"></p><p>大体来说，MySQL可以分为 <code>Server层</code> 和 <code>存储引擎层</code> 两部分。</p><p>Server层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖MySQL的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。</p><p>而存储引擎层负责数据的存储和提取。其架构模式是插件式的，支持InnoDB、MyISAM、Memory等多个存储引擎。现在最常用的存储引擎是InnoDB，它从MySQL 5.5.5版本开始成为了默认存储引擎。</p><h3 id="_1-2-连接器" tabindex="-1"><a class="header-anchor" href="#_1-2-连接器" aria-hidden="true">#</a> 1.2 连接器</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>mysql -h<span class="token variable">$ip</span> -P<span class="token variable">$port</span> -u<span class="token variable">$user</span> -p
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>输入连接命令后，连接器开始认证身份</p><p>1.如果用户名或密码不对，你就会收到一个&quot;Access denied for user&quot;的错误，然后客户端程序结束执行。</p><p>2.如果用户名密码认证通过，连接器会到权限表里面查出你拥有的权限。之后，这个连接里面的权限判断逻辑，都将依赖于此时读到的权限。(这就意味着，一个用户成功建立连接后，即使你用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置)</p><p>客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 <code>wait_timeout</code> 控制的，默认值是8小时。</p><blockquote><p>MySQL 占用内存高的原因以及解决方案</p><p>原因：MySQL在执行过程中 <strong>临时使用的内存是管理在连接对象里面的</strong> 。这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是MySQL异常重启了。</p><p>解决：</p><ol><li><strong>定期断开长连接</strong>。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。</li><li>如果你用的是MySQL 5.7或更新版本，可以在每次执行一个比较大的操作后，通过执行 <strong>mysql_reset_connection</strong> 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。</li></ol></blockquote><h3 id="_1-3-查询缓存" tabindex="-1"><a class="header-anchor" href="#_1-3-查询缓存" aria-hidden="true">#</a> 1.3 查询缓存</h3><p>但是大多数情况下我会建议你不要使用查询缓存，为什么呢？因为查询缓存往往弊大于利。</p><p>查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。因此很可能你费劲地把结果存起来，还没使用呢，就被一个更新全清空了。对于更新压力大的数据库来说，查询缓存的命中率会非常低。除非你的业务就是有一张静态表，很长时间才会更新一次。比如，一个系统配置表，那这张表上的查询才适合使用查询缓存。</p><h3 id="_1-4-分析器" tabindex="-1"><a class="header-anchor" href="#_1-4-分析器" aria-hidden="true">#</a> 1.4 分析器</h3><p>分析器先会做“词法分析”。你输入的是由多个字符串和空格组成的一条SQL语句，MySQL需要识别出里面的字符串分别是什么，代表什么。</p><p>做完了这些识别以后，就要做“语法分析”。根据词法分析的结果，语法分析器会根据语法规则，判断你输入的这个SQL语句是否满足MySQL语法。</p><h3 id="_1-5-优化器" tabindex="-1"><a class="header-anchor" href="#_1-5-优化器" aria-hidden="true">#</a> 1.5 优化器</h3><p>优化器的作用就是决定选择 <strong>执行效率高的方案</strong></p><h3 id="_1-6-执行器" tabindex="-1"><a class="header-anchor" href="#_1-6-执行器" aria-hidden="true">#</a> 1.6 执行器</h3><p>首先判断一下你对这个表T有没有执行查询的权限，如果有的话，再去调用引擎提供的接口。</p><p>没有索引的执行流程：</p><ol><li>调用InnoDB引擎接口取这个表的第一行，判断ID值是不是10，如果不是则跳过，如果是则将这行存在结果集中；</li><li>调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。</li><li>执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。</li></ol><p>有索引的话：</p><p>第一次调用的是“取满足条件的第一行”这个接口，之后循环取“满足条件的下一行”这个接口，这些接口都是引擎中已经定义好的</p><h3 id="_1-7-问题" tabindex="-1"><a class="header-anchor" href="#_1-7-问题" aria-hidden="true">#</a> 1.7 问题</h3><p>如果表T中没有字段k，而你执行了这个语句 select * from T where k=1, 那肯定是会报“不存在这个列”的错误： “Unknown column ‘k’ in ‘where clause’”。你觉得这个错误是在我们上面提到的哪个阶段报出来的呢？</p><p><strong>分析器，因为分析器会在分析阶段判断语句是否正确，表是否存在，列是否存在</strong></p><h2 id="_2-日志系统-一条sql更新语句是如何执行的" tabindex="-1"><a class="header-anchor" href="#_2-日志系统-一条sql更新语句是如何执行的" aria-hidden="true">#</a> 2.日志系统：一条SQL更新语句是如何执行的？</h2><h3 id="_2-1-redo-log" tabindex="-1"><a class="header-anchor" href="#_2-1-redo-log" aria-hidden="true">#</a> 2.1 redo log</h3><p>为了减少磁盘IO，提高更新效率</p><p>WAL的全称是 <code>Write-Ahead Logging</code> ，它的关键点就是 <strong>先写日志，再写磁盘</strong>，也就是先写粉板，等不忙的时候再写账本。</p><p>具体来说，当有一条记录需要更新的时候，InnoDB引擎就会先把记录写到redo log（粉板）里面，并更新内存，这个时候更新就算完成了。同时，InnoDB引擎会在适当的时候，将这个操作记录更新到磁盘里面，而这个更新往往是在系统比较空闲的时候做，这就像打烊以后掌柜做的事。</p><p><strong>write pos</strong> 是当前记录的位置，一边写一边后移，写到第3号文件末尾后就回到0号文件开头。</p><p><strong>checkpoint</strong> 是当前要擦除的位置，也是往后推移并且循环的，擦除记录前要把记录更新到数据文件。</p><p>write pos和checkpoint之间的是“粉板”上还空着的部分，可以用来记录新的操作</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220814143516800.png" alt="image-20220814143516800"></p><p>如果write pos追上checkpoint，表示“粉板”满了，这时候不能再执行新的更新，得停下来先擦掉一些记录，把checkpoint推进一下。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220814143543253.png" alt="image-20220814143543253"></p><p>有了redo log，InnoDB就可以保证 <strong>即使数据库发生异常重启，之前提交的记录都不会丢失</strong>，这个能力称为 <code>crash-save</code>（也就是保证了 事务的持久性）。</p><h3 id="_2-2-binlog" tabindex="-1"><a class="header-anchor" href="#_2-2-binlog" aria-hidden="true">#</a> 2.2 binlog</h3><blockquote><p>为什么会有两份日志呢？</p><p>因为最开始MySQL里并没有InnoDB引擎。MySQL自带的引擎是MyISAM，但是MyISAM没有crash-safe的能力，binlog日志只能用于归档。而InnoDB是另一个公司以插件形式引入MySQL的，既然 <strong>只依靠binlog是没有crash-safe能</strong>力 的，所以InnoDB使用另外一套日志系统---也就是 <strong>redo log来实现crash-safe能力。</strong></p></blockquote><p>binlog 和 redo log的不同点：</p><ol><li>redo log是 <strong>InnoDB引擎</strong> 特有的；binlog是MySQL的 <strong>Server层</strong> 实现的，所有引擎都可以使用。</li><li>redo log是 <strong>物理日志</strong>，记录的是 “<strong>在某个数据页上做了什么修改</strong>”；binlog是 <strong>逻辑日志</strong>，记录的是这个语句的原始逻辑，比如“<strong>给ID=2这一行的c字段加1</strong> ”。</li><li>redo log是 <strong>循环写的，空间固定会用完</strong>；binlog是可以 <strong>追加写入</strong> 的。“追加写”是指binlog文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。</li></ol><h3 id="_2-3-update-语句的执行流程" tabindex="-1"><a class="header-anchor" href="#_2-3-update-语句的执行流程" aria-hidden="true">#</a> 2.3 update 语句的执行流程</h3><ol><li>执行器先找引擎取ID=2这一行。ID是主键，引擎直接用树搜索找到这一行。如果ID=2这一行所在的数据页本来就在内存中，就直接返回给执行器；否则，需要先从磁盘读入内存，然后再返回。</li><li>执行器拿到引擎给的行数据，把这个值加上1，比如原来是N，现在就是N+1，得到新的一行数据，再调用引擎接口写入这行新数据。</li><li>引擎将这行新数据更新到内存中，同时将这个更新操作记录到redo log里面，此时redo log处于prepare状态。然后告知执行器执行完成了，随时可以提交事务。</li><li>执行器生成这个操作的binlog，并把binlog写入磁盘。</li><li>执行器调用引擎的提交事务接口，引擎把刚刚写入的redo log改成提交（commit）状态，更新完成。</li></ol><p>这里我给出这个update语句的执行流程图，图中浅色框表示是在InnoDB内部执行的，深色框表示是在执行器中执行的。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220814144711280.png" alt="image-20220814144711280"></p><h3 id="_2-4-两阶段提交" tabindex="-1"><a class="header-anchor" href="#_2-4-两阶段提交" aria-hidden="true">#</a> 2.4 两阶段提交</h3><p>由于redo log和binlog是两个独立的逻辑，如果不用两阶段提交，要么就是先写完redo log再写binlog，或者采用反过来的顺序。我们看看这两种方式会有什么问题。</p><ol><li><p>先写redo log后写binlog。假设在redo log写完，binlog还没有写完的时候，MySQL进程异常重启。由于我们前面说过的，redo log写完之后，系统即使崩溃，仍然能够把数据恢复回来，所以恢复后这一行c的值是1。</p><p>但是由于binlog没写完就crash了，这时候binlog里面就没有记录这个语句。因此，之后备份日志的时候，存起来的binlog里面就没有这条语句。</p><p>然后你会发现，如果需要用这个binlog来恢复临时库的话，由于这个语句的binlog丢失，这个临时库就会少了这一次更新，恢复出来的这一行c的值就是0，与原库的值不同。</p></li><li><p>先写binlog后写redo log。如果在binlog写完之后crash，由于redo log还没写，崩溃恢复以后这个事务无效，所以这一行c的值是0。但是binlog里面已经记录了“把c从0改成1”这个日志。所以，在之后用binlog来恢复的时候就多了一个事务出来，恢复出来的这一行c的值就是1，与原库的值不同。</p></li></ol><p>简单说，redo log和binlog都可以用于表示事务的提交状态，而 <code>两阶段提交就是让这两个日志保持逻辑上的一致</code>。</p><h3 id="_2-5-问题" tabindex="-1"><a class="header-anchor" href="#_2-5-问题" aria-hidden="true">#</a> 2.5 问题</h3><p>前面我说到定期全量备份的周期“取决于系统重要性，有的是一天一备，有的是一周一备”。那么在什么场景下，一天一备会比一周一备更有优势呢？或者说，它影响了这个数据库系统的哪个指标？</p><p><strong>一天一备会比一周一备好处是“最长恢复时间”更短。</strong></p><p>在一天一备的模式里，最坏情况下需要应用一天的 binlog。比如，你每天 0 点做一次全量备份，而要恢复出一个到昨天晚上 23 点的备份。</p><p>一周一备最坏情况就要应用一周的 binlog 了。</p><p>当然这个是有成本的，因为更频繁全量备份需要消耗更多存储空间，所以这个 RTO(恢复目标时间) 是成本换来的，就需要你根据业务重要性来评估了。</p><h2 id="_3-事务隔离-为什么你改了我还看不见" tabindex="-1"><a class="header-anchor" href="#_3-事务隔离-为什么你改了我还看不见" aria-hidden="true">#</a> 3.事务隔离：为什么你改了我还看不见？</h2><h3 id="_3-1-隔离性与隔离级别" tabindex="-1"><a class="header-anchor" href="#_3-1-隔离性与隔离级别" aria-hidden="true">#</a> 3.1 隔离性与隔离级别</h3><p>提到事务，你肯定会想到 <strong>ACID</strong>（Atomicity、Consistency、Isolation、Durability，即原子性、一致性、隔离性、持久性），今天我们就来说说其中I，也就是“隔离性”。</p><p>当数据库上有多个事务同时执行的时候，就可能出现 <strong>脏读（dirty read）、不可重复读（non-repeatable read）、幻读（phantom read）</strong> 的问题，为了解决这些问题，就有了“隔离级别”的概念。</p><p>在谈隔离级别之前，你首先要知道，你隔离得越严实，效率就会越低。因此很多时候，我们都要在二者之间寻找一个平衡点。SQL标准的事务隔离级别包括：<strong>读未提交（read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（serializable）</strong>。下面我逐一为你解释：</p><ul><li>读未提交是指，一个事务还没提交时，它做的变更就能被别的事务看到。</li><li>读提交是指，一个事务提交之后，它做的变更才会被其他事务看到。</li><li>可重复读是指，一个事务执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的。当然在可重复读隔离级别下，未提交变更对其他事务也是不可见的。</li><li>串行化，顾名思义是对于同一行记录，“写”会加“写锁”，“读”会加“读锁”。当出现读写锁冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行。</li></ul><p>执行 SQL 语句</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; create table T(c int) engine=InnoDB; 
mysql&gt; insert into T(c) values(1);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220814152125995.png" alt="image-20220814152125995"></p><ul><li>若隔离级别是“读未提交”， 则V1的值就是2。这时候事务B虽然还没有提交，但是结果已经被A看到了。因此，V2、V3也都是2。</li><li>若隔离级别是“读提交”，则V1是1，V2的值是2。事务B的更新在提交后才能被A看到。所以， V3的值也是2。</li><li>若隔离级别是“可重复读”，则V1、V2是1，V3是2。之所以V2还是1，遵循的就是这个要求：事务在执行期间看到的数据前后必须是一致的。</li><li>若隔离级别是“串行化”，则在事务B执行“将1改成2”的时候，会被锁住。直到事务A提交后，事务B才可以继续执行。所以从A的角度看， V1、V2值是1，V3的值是2。</li></ul><p>在实现上，数据库里面会创建一个视图，访问的时候以视图的逻辑结果为准。在“<strong>可重复读</strong>”隔离级别下，这个视图是在 <strong>事务启动时创建的</strong>，整个事务存在期间都用这个视图。在“<strong>读提交</strong>”隔离级别下，这个视图是 <strong>在每个SQL语句开始执行的时候创建的</strong>。这里需要注意的是，“读未提交”隔离级别下直接返回记录上的最新值，没有视图概念；而“串行化”隔离级别下直接用加锁的方式来避免并行访问。</p><h3 id="_3-2-事务隔离级别的实现" tabindex="-1"><a class="header-anchor" href="#_3-2-事务隔离级别的实现" aria-hidden="true">#</a> 3.2 事务隔离级别的实现</h3><p>假设一个值从1被按顺序改成了2、3、4，在回滚日志里面就会有类似下面的记录。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220814152813098.png" alt="image-20220814152813098"></p><blockquote><p>回滚日志什么时候删除?</p><p>答案是，在不需要的时候才删除。也就是说，系统会判断，当没有事务再需要用到这些回滚日志时，回滚日志会被删除。 什么时候才不需要了呢？就是 <strong>当系统里没有比这个回滚日志更早的read-view的时候</strong>。</p><p>为什么尽量不要用长事务？</p><ul><li>长事务意味着系统里面会存在很老的事务视图。由于这些事务随时可能访问数据库里面的任何数据，所以这个事务提交之前，数据库里面它可能用到的回滚记录都必须保留，这就会导致 <strong>大量占用存储空间</strong>。</li><li>长事务还占用 <strong>锁资源</strong>，也可能拖垮整个库</li></ul></blockquote><h3 id="_3-3-事务的启动方式" tabindex="-1"><a class="header-anchor" href="#_3-3-事务的启动方式" aria-hidden="true">#</a> 3.3 事务的启动方式</h3><ol><li>显式启动事务语句， begin 或 start transaction。配套的提交语句是commit，回滚语句是rollback。</li><li>set autocommit=0，这个命令会将这个线程的自动提交关掉。意味着如果你只执行一个select语句，这个事务就启动了，而且并不会自动提交。这个事务持续存在直到你主动执行commit 或 rollback 语句，或者断开连接。</li></ol><p>在autocommit为1的情况下，用begin显式启动的事务，如果执行commit则提交事务。如果执行 <strong>commit work and chain</strong>，则是提交事务并自动启动下一个事务，这样也省去了再次执行begin语句的开销。同时带来的好处是从程序开发的角度明确地知道每个语句是否处于事务中。</p><h3 id="_3-4-问题" tabindex="-1"><a class="header-anchor" href="#_3-4-问题" aria-hidden="true">#</a> 3.4 问题</h3><p>你现在知道了系统里面应该避免长事务，如果你是业务开发负责人同时也是数据库负责人，你会有什么方案来避免出现或者处理这种情况呢？</p><p>首先，从应用开发端来看：</p><ol><li><p>确认是否使用了 set autocommit=0。这个确认工作可以在测试环境中开展，把 MySQL 的 general_log 开起来，然后随便跑一个业务逻辑，通过 general_log 的日志来确认。一般框架如果会设置这个值，也就会提供参数来控制行为，你的目标就是把它改成 1；</p></li><li><p>确认是否有不必要的只读事务。有些框架会习惯不管什么语句先用 begin/commit 框起来。我见过有些是业务并没有这个需要，但是也把好几个 select 语句放到了事务中，这种只读事务可以去掉；</p></li><li><p>业务连接数据库的时候，根据业务本身的预估，通过 SET MAX_EXECUTION_TIME 命令，来控制每个语句执行的最长时间，避免单个语句意外执行太长时间。</p></li></ol><p>其次，从数据库端来看：</p><ol><li><p>监控 information_schema.Innodb_trx 表，设置长事务阈值，超过就报警 / 或者 kill；</p></li><li><p>Percona 的 pt-kill 这个工具不错，推荐使用；</p></li><li><p>在业务功能测试阶段要求输出所有的 general_log，分析日志行为提前发现问题；</p></li><li><p>如果使用的是 MySQL 5.6 或者更新版本，把 innodb_undo_tablespaces 设置成 2（或更大的值）。如果真的出现大事务导致回滚段过大，这样设置后清理起来更方便。</p></li></ol><h2 id="_4-深入浅出索引-上" tabindex="-1"><a class="header-anchor" href="#_4-深入浅出索引-上" aria-hidden="true">#</a> 4.深入浅出索引（上）</h2><p><strong>索引的出现其实就是为了提高数据查询的效率，就像书的目录一样。</strong></p><h3 id="_4-1-索引的常见模型" tabindex="-1"><a class="header-anchor" href="#_4-1-索引的常见模型" aria-hidden="true">#</a> 4.1 索引的常见模型</h3><ul><li>哈希表</li><li>有序数组</li><li>搜索树</li></ul><p>哈希表：</p><p>无序，所以哈希索引做区间查询的速度是很慢的。所以，哈希表这种结构适用于 <strong>只有等值查询</strong> 的场景，比如Memcached及其他一些NoSQL引擎。</p><p>有序数组：</p><p>而有序数组在 <strong>等值查询和范围查询场景</strong> 中的性能就都非常优秀。但是在需要更新数据的时候就麻烦了，你往中间插入一个记录就必须得挪动后面所有的记录，成本太高。所以，有序数组索引 <strong>只适用于静态存储引擎</strong> ，比如你要保存的是2017年某个城市的所有人口信息，这类不会再修改的数据。</p><p>搜索树:</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220816231220978.png" alt="image-20220816231220978"></p><blockquote><p>B+树的存储能力如何？为何说一般查找行记录，最多只需1~3次磁盘IO?</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220617172426725.png" alt="image-20220617172426725" style="float:left;"></blockquote><h3 id="_4-2-innodb-的索引模型" tabindex="-1"><a class="header-anchor" href="#_4-2-innodb-的索引模型" aria-hidden="true">#</a> 4.2 InnoDB 的索引模型</h3><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; create table T(
id int primary key,
k int not null,
name varchar(16),
index (k))engine=InnoDB;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>表中R1~R5的(ID,k)值分别为(100,1)、(200,2)、(300,3)、(500,5)和(600,6)，两棵树的示例示意图如下。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220816231337099.png" alt="image-20220816231337099"></p><ul><li>主键索引的叶子节点存的是 <strong>整行数据</strong> 。在InnoDB里，主键索引也被称为聚簇索引（clustered index）。</li><li>非主键索引的叶子节点内容是 <strong>主键的值</strong>。在InnoDB里，非主键索引也被称为二级索引 （secondary index）。</li></ul><p>基于主键索引和普通索引的查询有什么区别？</p><p>如果语句是select * from T where ID=500，即主键查询方式，则只需要搜索ID这棵B+树；</p><p>如果语句是select * from T where k=5，即普通索引查询方式，则 <strong>需要先搜索k索引树，得到ID的值为500，再到ID索引树搜索一次。这个过程称为回表。</strong></p><p>也就是说，基于非主键索引的查询需要多扫描一棵索引树。因此，我们在应用中应该 <strong>尽量使用主键查询。</strong></p><h3 id="_4-3-索引维护" tabindex="-1"><a class="header-anchor" href="#_4-3-索引维护" aria-hidden="true">#</a> 4.3 索引维护</h3><p>如果数据页已经满了，根据B+树的算法，这时候需要申请一个新的数据页，然后挪动部分数据过去。这个过程称为 <strong>页分裂</strong>。</p><blockquote><p>你可能在一些建表规范里面见到过类似的描述，要求建表语句里一定要有自增主键。当然事无绝对，我们来分析一下哪些场景下应该使用自增主键，而哪些场景下不应该。</p></blockquote><p>从性能上看：</p><ul><li>自增主键的插入数据模式，正符合了我们前面提到的递增插入的场景。每次插入一条新记录，都是追加操作，都不涉及到挪动其他记录，也不会触发叶子节点的分裂。</li><li>而有业务逻辑的字段做主键，则往往不容易保证有序插入，这样写数据成本相对较高。</li></ul><p>假设你的表中确实有一个唯一字段，比如字符串类型的身份证号，那应该用身份证号做主键，还是用自增字段做主键呢？</p><p>从存储空间的角度看：</p><p><strong>显然，主键长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小。</strong></p><blockquote><p>有没有什么场景适合用业务字段直接做主键的呢？还是有的。比如，有些业务的场景需求是这样的</p></blockquote><ol><li>只有一个索引；</li><li>该索引必须是唯一索引。</li></ol><p>由于没有其他索引，所以也就不用考虑其他索引的叶子节点大小的问题。把这个索引设置为主键，我们就可以 <strong>避免回表操作</strong>。</p><h3 id="_4-4-问题" tabindex="-1"><a class="header-anchor" href="#_4-4-问题" aria-hidden="true">#</a> 4.4 问题</h3><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># 重建普通索引
alter table T drop index k;
alter table T add index(k);
# 重建主键索引
alter table T drop primary key;
alter table T add primary key(id);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我的问题是，对于上面这两个重建索引的作法，说出你的理解。如果有不合适的，为什么，更好的方法是什么？</p><p><strong>答案：</strong></p><p>首先，为什么要重建索引？</p><p>索引可能因为删除，或者页分裂等原因，导致数据页有空洞，重建索引的过程会 <code>创建一个新的索引</code>，把数据按顺序插入，这样页面的利用率最高，<code>也就是索引更紧凑、更省空间。</code></p><p>建索引k的做法是合理的，可以达到省空间的目的。但是，重建主键的过程不合理。不论是删除主键还是创建主键，都会将整个表重建。所以连着执行这两个语句的话，第一个语句就白做了。这两个语句，你可以用这个语句代替 ： <code>alter table T engine=InnoDB</code> 。在专栏的第12篇文章《为什么表数据删掉一半，表文件大小不变？》中，我会和你分析这条语句的执行流程。</p><h2 id="_5-深入浅出索引-下" tabindex="-1"><a class="header-anchor" href="#_5-深入浅出索引-下" aria-hidden="true">#</a> 5.深入浅出索引（下）</h2><p>建表语句</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; create table T (
ID int primary key,
k int NOT NULL DEFAULT 0,
s varchar(16) NOT NULL DEFAULT &#39;&#39;,
index k(k))
engine=InnoDB;
insert into T values(100,1, &#39;aa&#39;),(200,2,&#39;bb&#39;),(300,3,&#39;cc&#39;),(500,5,&#39;ee&#39;),(600,6,&#39;ff&#39;),(700,7,&#39;gg&#39;);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>B+树：</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220817000234119.png" alt="image-20220817000234119"></p><h3 id="_5-1-覆盖索引" tabindex="-1"><a class="header-anchor" href="#_5-1-覆盖索引" aria-hidden="true">#</a> 5.1 覆盖索引</h3><p><strong>select ID from T where k between 3 and 5</strong>，这时只需要查ID的值，而ID的值已经在k索引树上了，因此可以直接提供查询结果，不需要回表。也就是说，在这个查询里面，索引k已经“覆盖了”我们的查询需求，我们称为 <code>覆盖索引</code>。</p><p><strong>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段。</strong></p><p>在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？</p><p>我们知道，身份证号是市民的唯一标识。也就是说，如果有根据身份证号查询市民信息的需求，我们只要在身份证号字段上建立索引就够了。而再建立一个（身份证号、姓名）的联合索引，是不是浪费空间？</p><p>如果现在有一个高频请求，要根据市民的身份证号查询他的姓名，这个联合索引就有意义了。它可以在这个高频请求上用到覆盖索引，不再需要回表查整行记录，减少语句的执行时间。</p><p>当然，索引字段的维护总是有代价的。因此，在建立冗余索引来支持覆盖索引时就需要权衡考虑了。这正是业务DBA，或者称为业务数据架构师的工作。</p><h3 id="_5-2-最左前缀原则" tabindex="-1"><a class="header-anchor" href="#_5-2-最左前缀原则" aria-hidden="true">#</a> 5.2 最左前缀原则</h3><p>我们用（name，age）这个联合索引来分析。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220817000516450.png" alt="image-20220817000516450"></p><p>当你的逻辑需求是查到所有名字是“张三”的人时，可以快速定位到ID4，然后向后遍历得到所有需要的结果。</p><p>在建立联合索引的时候，如何安排索引内的字段顺序?</p><p><strong>第一原则是，如果通过调整顺序，可以少维护一个索引，那么这个顺序往往就是需要优先考虑采用的。</strong></p><p>如果既有联合查询，又有基于a、b各自的查询呢？查询条件里面只有b的语句，是无法使用(a,b)这个联合索引的，这时候你不得不维护另外一个索引，也就是说你需要同时维护(a,b)、(b) 这两个索引?</p><p>这时候，我们要考虑的原则就是 <strong>空间</strong> 了。比如上面这个市民表的情况，name字段是比age字段大的 ，那我就建议你创建一个（name,age)的联合索引和一个(age)的单字段索引。</p><h3 id="_5-3-索引下推" tabindex="-1"><a class="header-anchor" href="#_5-3-索引下推" aria-hidden="true">#</a> 5.3 索引下推</h3><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; select * from tuser where name like &#39;张%&#39; and age=10 and ismale=1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>没有索引下推之前</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220817001004301.png" alt="image-20220817001004301"></p><p>索引下推</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220817001014182.png" alt="image-20220817001014182"></p><p>图3中，在(name,age)索引里面我特意去掉了age的值，这个过程InnoDB并不会去看age的值，只是按顺序把“name第一个字是’张’”的记录一条条取出来回表。因此，需要回表4次。</p><p>图4跟图3的区别是，InnoDB在(name,age)索引内部就判断了age是否等于10，对于不等于10的记录，直接判断并跳过。在我们的这个例子中，只需要对ID4、ID5这两条记录回表取数据判断，就只需要回表2次。</p><p>也就是减少了 <code>回表次数</code>。</p><h3 id="_5-4-问题" tabindex="-1"><a class="header-anchor" href="#_5-4-问题" aria-hidden="true">#</a> 5.4 问题</h3><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE `geek` (
`a` int(11) NOT NULL,
`b` int(11) NOT NULL,
`c` int(11) NOT NULL,
`d` int(11) NOT NULL,
PRIMARY KEY (`a`,`b`),
KEY `c` (`c`),
KEY `ca` (`c`,`a`),
KEY `cb` (`c`,`b`)
) ENGINE=InnoDB; 	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>公司的同事告诉他说，由于历史原因，这个表需要a、b做联合主键，这个小吕理解了。</p><p>但是，学过本章内容的小吕又纳闷了，既然主键包含了a、b这两个字段，那意味着单独在字段c上创建一个索引，就已经包含了三个字段了呀，为什么要建“ca”“cb”这两个索引？</p><p>同事告诉他，是因为他们的业务里面有这样的两种语句：</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>select * from geek where c=N order by a limit 1; 
select * from geek where c=N order by b limit 1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>我给你的问题是，这位同事的解释对吗，为了这两个查询模式，这两个索引是否都是必须的？为什么呢？</p><p>表记录</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>–a--|–b--|–c--|–d--
1 2 3 d
1 3 2 d
1 4 3 d
2 1 3 d
2 2 2 d
2 3 4 d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主键 a，b的聚簇索引组织顺序相当于 order by a,b ，也就是先按a排序，再按b排序，c无序。 索引 ca 的组织是先按c排序，再按a排序，同时记录主键</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>–c--|–a--|–主键部分b-- （注意，这里不是ab，而是只有b）
2 1 3
2 2 2
3 1 2
3 1 4
3 2 1
4 2 3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>这个跟索引c的数据是一模一样的。</strong></p><p>索引 cb 的组织是先按c排序，在按b排序，同时记录主键</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>–c--|–b--|–主键部分a-- （同上）
2 2 2
2 3 1
3 1 2
3 2 1
3 4 1
4 3 2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以，结论是ca可以去掉，cb需要保留。</p><p><strong>其实也就是 ca 可以通过索引下推得到，不要再建立 ca 索引了。</strong></p><h2 id="_6-全局锁和表锁-给表加个字段怎么有这么多阻碍" tabindex="-1"><a class="header-anchor" href="#_6-全局锁和表锁-给表加个字段怎么有这么多阻碍" aria-hidden="true">#</a> 6.全局锁和表锁 ：给表加个字段怎么有这么多阻碍？</h2><p>根据加锁的范围，MySQL里面的锁大致可以分成 <code>全局锁、表级锁和行锁</code> 三类</p><h3 id="_6-1-全局锁" tabindex="-1"><a class="header-anchor" href="#_6-1-全局锁" aria-hidden="true">#</a> 6.1 全局锁</h3><p>全局锁就是对整个数据库实例加锁，会阻塞 DML、DDL 语句</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>Flush tables with read lock (FTWRL)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>全局锁的典型使用场景是，<code>做全库逻辑备份</code></p><p>问题：</p><ul><li>如果你在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆；</li><li>如果你在从库上备份，那么备份期间从库不能执行主库同步过来的binlog，会导致 <strong>主从延迟</strong>。</li></ul><p>备份为什么要加锁呢？</p><p>假设备份期间，有一个用户，他购买了一门课程，业务逻辑里就要扣掉他的余额，然后往已购课程里面加上一门课。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220817154527272.png" alt="image-20220817154527272"></p><p>结果：用户A的数据状态是“账户余额没扣，但是用户课程表里面已经多了一门课”。如果后面用这个备份来恢复数据的话，用户A就发现，自己赚了。</p><p>也就是说，不加锁的话，<strong>备份系统备份的得到的库不是一个逻辑时间点，这个视图是逻辑不一致的</strong>。</p><p>在可重复读隔离级别下开启一个事务可以拿到 <code>一致性视图（MVCC）</code></p><p>官方自带的逻辑备份工具是 <code>mysqldump</code> 。当mysqldump使用参数 <code>–single-transaction</code> 的时候，导数据之前就会启动一个事务，来确保拿到 <code>一致性视图</code>。而由于MVCC的支持，这个过程中数据是可以正常更新的。</p><p>有了这个功能，为什么还需要FTWRL呢？</p><p><strong>一致性读是好，但前提是引擎要支持这个隔离级别</strong>。对于MyISAM这种不支持事务的引擎，我们就需要使用FTWRL命令了。</p><blockquote><p>InnoDB替代MyISAM的原因:</p><ul><li>InnoDB 支持事务，MyISAM 不支持事务。因此 MyISAM 做备份的时候只能通过 FTWRL</li><li>InnoDB 支持行锁，MyISAM 不支持。</li></ul></blockquote><p>既然要全库只读，为什么不使用 <code>set global readonly=true</code> 的方式呢？</p><ul><li>一是，在有些系统中，readonly的值会被用来做其他逻辑，比如用来判断一个库是主库还是备库。因此，<code>修改global变量的方式影响面更大</code>，我不建议你使用。</li><li>二是，在异常处理机制上有差异。如果执行FTWRL命令之后由于 <code>客户端发生异常断开</code> ，那么MySQL会自动 <code>释放这个全局锁</code> ，整个库回到可以正常更新的状态。而将整个库设置为 <code>readonly</code> 之后，如果客户端发生异常，则<code> 数据库就会一直保持readonly状态</code> ，这样会导致整个库长时间处于不可写状态，风险较高。</li></ul><h3 id="_6-2-表级锁" tabindex="-1"><a class="header-anchor" href="#_6-2-表级锁" aria-hidden="true">#</a> 6.2 表级锁</h3><ul><li>表锁</li><li>元数据锁（meta data lock，MDL)</li></ul><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># 加表锁
lock tables … read/write
# 释放锁
unlock tables
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>举个例子, 如果在某个线程A中执行lock tables t1 read, t2 write; 这个语句，则其他线程写t1、读写t2的语句都会被阻塞。同时，线程A在执行unlock tables之前，也只能执行读t1、读写t2的操作。连写t1都不允许，自然也不能访问其他表。</p><p>MDL 锁：</p><p>另一类表级的锁是MDL（metadata lock)。MDL不需要显式使用，在访问一个表的时候会被自动加上。MDL的作用是，<code>保证读写的正确性</code></p><p>特点：</p><ul><li><strong>读锁之间不互斥</strong>，因此你可以有多个线程同时对一张表增删改查。</li><li><strong>读写锁之间、写锁之间是互斥的</strong>，用来保证变更表结构操作的安全性。因此，如果有两个线程要同时给一个表加字段，其中一个要等另一个执行完才能开始执行。</li></ul><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220817155618216.png" alt="image-20220817155618216"></p><p>分析：</p><p>我们可以看到session A先启动，这时候会对表t加一个MDL读锁。由于session B需要的也是MDL读锁，因此可以正常执行。</p><p>之后session C会被blocked，是因为session A的MDL读锁还没有释放，而session C需要MDL写锁，因此只能被阻塞。</p><p>如果只有session C自己被阻塞还没什么关系，但是之后所有要在表t上新申请MDL读锁的请求也会被session C阻塞。前面我们说了，所有对表的增删改查操作都需要先申请MDL读锁，就都被锁住，等于这个表现在完全不可读写了。</p><p>如果某个表上的查询语句频繁，而且客户端有 <code>重试机制</code> ，也就是说超时后会再起一个新session再请求的话，<code>这个库的线程很快就会爆满</code>。</p><p>如何安全地给小表加字段？</p><p>首先我们要 <code>解决长事务</code>，事务不提交，就会一直占着MDL锁。在MySQL的information_schema库的 innodb_trx 表中，你可以查到当前执行中的事务。如果你要做DDL变更的表刚好有长事务在执行，要 <code>考虑先暂停DDL，或者kill掉这个长事务</code> 。</p><p>但考虑一下这个场景。如果你要变更的表是一个热点表，虽然数据量不大，但是 <strong>上面的请求很频繁</strong>，而你不得不加个字段，你该怎么做呢？</p><p>这时候kill可能未必管用，因为新的请求马上就来了。比较理想的机制是，在alter table语句里面 <code>设定等待时间</code>，如果在这个指定的等待时间里面能够拿到MDL写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者DBA再通过重试命令重复这个过程。</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># 不等待
ALTER TABLE tbl_name NOWAIT add column ... 
# 等待
ALTER TABLE tbl_name WAIT N add column ... 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-问题" tabindex="-1"><a class="header-anchor" href="#_6-3-问题" aria-hidden="true">#</a> 6.3 问题</h3><p>备份一般都会在备库上执行，你在用–single-transaction方法做逻辑备份的过程中，如果主库上的一个小表做了一个DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？</p><p>备份过程：</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>Q1:SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
Q2:START TRANSACTION WITH CONSISTENT SNAPSHOT；
/* other tables */
Q3:SAVEPOINT sp;
/* 时刻 1 */
Q4:show create table `t1`;
/* 时刻 2 */
Q5:SELECT * FROM `t1`;
/* 时刻 3 */
Q6:ROLLBACK TO SAVEPOINT sp;
/* 时刻 4 */
/* other tables */
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1.在备份开始的时候，为了确保RR（可重复读）隔离级别，再设置一次RR隔离级别(Q1);</p><p>2.启动事务，这里用 WITH CONSISTENT SNAPSHOT确保这个语句执行完就可以得到一个一致性视图（Q2)；</p><p>3.设置一个保存点，这个很重要（Q3）；</p><p>4.show create 是为了拿到表结构(Q4)，然后正式导数据 （Q5），回滚到SAVEPOINT sp，在这里的作用是释放 t1的MDL锁 （Q6。当然这部分属于“超纲”，上文正文里面都没提到。</p><p>DDL从主库传过来的时间按照效果不同，我打了四个时刻。题目设定为小表，我们假定到达后，如果开始执行，则很快能够执行完成。</p><p>参考答案如下：</p><ol><li>如果在Q4语句执行之前到达，现象：没有影响，备份拿到的是DDL后的表结构。</li><li>如果在“时刻 2”到达，则表结构被改过，Q5执行的时候，报 Table definition has changed, please retry transaction，现象：<code>mysqldump终止；</code></li><li>如果在“时刻2”和“时刻3”之间到达，mysqldump占着t1的MDL读锁，binlog被阻塞，现象：<code>主从延迟，直到Q6执行完成</code>。</li><li>从“时刻4”开始，mysqldump释放了MDL读锁，现象：没有影响，备份拿到的是DDL前的表结构。</li></ol><h2 id="_7-行锁功过-怎么减少行锁对性能的影响" tabindex="-1"><a class="header-anchor" href="#_7-行锁功过-怎么减少行锁对性能的影响" aria-hidden="true">#</a> 7.行锁功过：怎么减少行锁对性能的影响？</h2><h3 id="_7-1-从两阶段锁说起" tabindex="-1"><a class="header-anchor" href="#_7-1-从两阶段锁说起" aria-hidden="true">#</a> 7.1 从两阶段锁说起</h3><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220817173933939.png" alt="image-20220817173933939"></p><p>分析：</p><p>实际上事务B的update语句会被阻塞，直到事务A执行commit之后，事务B才能继续执行。</p><p>在InnoDB事务中，<code>行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放</code> 。这个就是 <strong>两阶段锁协议</strong>。</p><p>建议：<strong>如果你的事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放</strong></p><p>假设你负责实现一个电影票在线交易业务，顾客A要在影院B购买电影票。我们简化一点，这个业务需要涉及到以下操作：</p><ol><li>从顾客A账户余额中扣除电影票价；</li><li>给影院B的账户余额增加这张电影票价；</li><li>记录一条交易日志。</li></ol><p>试想如果同时有另外一个顾客C要在影院B买票，那么这两个事务冲突的部分就是语句2了。因为它们要更新同一个影院账户的余额，需要修改同一行数据。</p><p>根据两阶段锁协议，不论你怎样安排语句顺序，所有的操作需要的行锁都是在事务提交的时候才释放的。所以，如果你把语句2安排在最后，比如按照3、1、2这样的顺序，那么影院账户余额这一行的锁时间就最少。这就 <strong>最大程度地减少了事务之间的锁等待，提升了并发度</strong>。</p><p>如果这个影院做活动，可以低价预售一年内所有的电影票，而且这个活动只做一天。于是在活动时间开始的时候，你的MySQL就挂了。你登上服务器一看，CPU消耗接近100%，但整个数据库每秒就执行不到100个事务。这是什么原因呢？</p><h3 id="_7-2-死锁和死锁检测" tabindex="-1"><a class="header-anchor" href="#_7-2-死锁和死锁检测" aria-hidden="true">#</a> 7.2 死锁和死锁检测</h3><p>当并发系统中不同线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源时，就会导致这几个线程都进入无限等待的状态，称为 <code>死锁</code>。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220817174310207.png" alt="image-20220817174310207"></p><p>当出现死锁以后，有两种策略：</p><ul><li>一种策略是，<code>直接进入等待，直到超时</code> 。这个超时时间可以通过参数 <code>innodb_lock_wait_timeout</code> 来设置。</li><li>另一种策略是，发起 <code>死锁检测</code>，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数innodb_deadlock_detect设置为on，表示开启这个逻辑。</li></ul><p>在InnoDB中，innodb_lock_wait_timeout的默认值是 <code>50s</code>，意味着如果采用第一个策略，当出现死锁以后，第一个被锁住的线程要过50s才会超时退出，然后其他线程才有可能继续执行。对于在线服务来说，这个等待时间往往是无法接受的。</p><p>但是，我们又不可能直接把这个时间设置成一个很小的值，比如1s。这样当出现死锁的时候，确实很快就可以解开，但如果不是死锁，而是简单的锁等待呢？所以，超时时间设置太短的话，会出现很多误伤。</p><p>主动死锁检测:</p><p>每当一个事务被锁的时候，就要看看它所依赖的线程有没有被别人锁住，如此循环，最后判断是否出现了循环等待，也就是死锁。</p><p>那如果是我们上面说到的所有事务都要更新同一行的场景呢？</p><p>每个新来的被堵住的线程，都要判断会不会由于自己的加入导致了死锁，这是一个时间复杂度是O(n)的操作。假设有1000个并发线程要同时更新同一行，那么死锁检测操作就是100万这个量级的。虽然最终检测的结果是没有死锁，但是这期间要消耗大量的CPU资源。因此，你就会看到CPU利用率很高，但是每秒却执行不了几个事务。</p><p>怎么解决由这种热点行更新导致的性能问题呢？</p><p>原因：死锁检测要耗费大量的CPU资源</p><p>解决：</p><ul><li>一种头痛医头的方法，就是如果你能确保这个业务一定不会出现死锁，可以临时把死锁检测关掉</li><li>另一个思路是控制并发度</li><li>可以考虑通过将一行改成逻辑上的多行来减少锁冲突</li></ul><p>还是以影院账户为例，可以考虑放在多条记录上，比如10个记录，影院的账户总额等于这10个记录的值的总和。这样每次要给影院账户加金额的时候，随机选其中一条记录来加。这样每次冲突概率变成原来的1/10，可以减少锁等待个数，也就减少了死锁检测的CPU消耗。</p><h3 id="_7-3-问题" tabindex="-1"><a class="header-anchor" href="#_7-3-问题" aria-hidden="true">#</a> 7.3 问题</h3><p>如果你要删除一个表里面的前10000行数据，有以下三种方法可以做到：</p><p>第一种，直接执行delete from T limit 10000;</p><p>第二种，在一个连接中循环执行20次 delete from T limit 500;</p><p>第三种，在20个连接中同时执行delete from T limit 500。</p><p>你会选择哪一种方法呢？为什么呢？</p><p><strong>第二种方式是相对较好的。</strong></p><p>第一种方式（即：直接执行delete from T limit 10000）里面，单个语句 <strong>占用时间长，锁的时间也比较长；而且大事务还会导致主从延迟。</strong></p><p>第三种方式（即：在20个连接中同时执行delete from T limit 500），会 <strong>人为造成锁冲突。</strong></p><h2 id="_8-事务到底是隔离的还是不隔离的" tabindex="-1"><a class="header-anchor" href="#_8-事务到底是隔离的还是不隔离的" aria-hidden="true">#</a> 8.事务到底是隔离的还是不隔离的？</h2><p>创建表：</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; CREATE TABLE `t` (
`id` int(11) NOT NULL,
`k` int(11) DEFAULT NULL,
PRIMARY KEY (`id`)
) ENGINE=InnoDB;
insert into t(id, k) values(1,1),(2,2);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>事务A、B、C的执行流程:</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818140406248.png" alt="image-20220818140406248"></p><p>这里，我们需要注意的是事务的启动时机。</p><p>begin/start transaction 命令并不是一个事务的起点，在执行到它们之后的第一个操作InnoDB表的语句，事务才真正启动。如果你想要马上启动一个事务，可以使用 <code>start transaction with consistent snapshot</code> 这个命令。</p><p>注意这里的 autocommit=1，因此事务C在语句完成之后会自动提交。</p><p>结果：<strong>事务B查到的k的值是3，而事务A查到的k的值是1</strong></p><h3 id="_8-1-快照-在mvcc里是怎么工作的" tabindex="-1"><a class="header-anchor" href="#_8-1-快照-在mvcc里是怎么工作的" aria-hidden="true">#</a> 8.1 “快照”在MVCC里是怎么工作的？</h3><p>InnoDB里面每个事务有一个唯一的事务ID，叫作 <code>transaction id</code> 。它是在事务开始的时候向InnoDB的事务系统申请的，<strong>是按申请顺序严格递增的</strong>。</p><p>而每行数据也都是有多个版本的。每次事务更新数据的时候，都会生成一个新的数据版本，并且把transaction id赋值给这个数据版本的事务ID，记为 <code>row trx_id</code> 。同时，旧的数据版本要保留，并且在新的数据版本中，能够有信息可以直接拿到它。</p><p>也就是说，数据表中的一行记录，其实可能有多个版本(row)，每个版本有自己的row trx_id。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818140349973.png" alt="image-20220818140349973"></p><p>一个记录被多个事务连续更新后的状态:</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818140425802.png" alt="image-20220818140425802"></p><p>图2中的三个虚线箭头，就是 <code>undo log；</code>而V1、V2、V3并不是物理上真实存在的，而是每次需要的时候根据当前版本和undo log计算出来的。比如，需要V2的时候，就是通过V4依次执行U3、U2算出来。</p><p>在实现上， InnoDB为每个事务构造了一个数组，用来保存这个事务启动瞬间，当前正在“活跃”的所有事务ID。“活跃”指的就是，启动了但还没提交。</p><p>数组里面事务ID的最小值记为低水位，当前系统里面已经创建过的事务ID的最大值加1记为高水位。</p><p>这个视图数组和高水位，就组成了当前事务的一致性视图（read-view）。</p><blockquote><p>ReadView 的结构：</p><ol><li><p><code>creator_trx_id</code> ，创建这个 Read View 的事务 ID。</p><p>说明：只有在对表中的记录做改动时（执行INSERT、DELETE、UPDATE这些语句时）才会为 事务分配事务id，否则在一个只读事务中的事务id值都默认为0。</p></li><li><p><code>trx_ids</code> ，表示在生成ReadView时当前系统中活跃的读写事务的 <code>事务id列表</code> 。</p></li><li><p><code>up_limit_id</code> ，活跃的事务中最小的事务 ID。</p></li><li><p><code>low_limit_id</code> ，表示生成ReadView时系统中应该分配给下一个事务的 id 值。low_limit_id 是系 统最大的事务id值，这里要注意是系统中的事务id，需要区别于正在活跃的事务ID。</p></li></ol></blockquote><p><strong>而数据版本的可见性规则，就是基于数据的row trx_id和这个一致性视图的对比结果得到的。</strong></p><p>这个视图数组把所有的row trx_id 分成了几种不同的情况。</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818140710041.png" alt="image-20220818140710041"></p><p>这样，对于当前事务的启动瞬间来说，一个数据版本的row trx_id，有以下几种可能：</p><ol><li><p>如果落在绿色部分，表示这个版本是已提交的事务或者是当前事务自己生成的，这个数据是可见的；</p></li><li><p>如果落在红色部分，表示这个版本是由将来启动的事务生成的，是肯定不可见的；</p></li><li><p>如果落在黄色部分，那就包括两种情况</p><p>a.若 row trx_id在数组中，表示这个版本是由还没提交的事务生成的，不可见；</p><p>b.若 row trx_id不在数组中，表示这个版本是已经提交了的事务生成的，可见。</p></li></ol><p>所以你现在知道了，<strong>InnoDB利用了“所有数据都有多个版本”的这个特性，实现了“秒级创建快照”的能力。</strong></p><p>接下来，我们继续看一下图1中的三个事务，分析下事务A的语句返回的结果，为什么是k=1。</p><p>这里，我们不妨做如下假设：</p><ol><li>事务A开始前，系统里面只有一个活跃事务ID是99；</li><li>事务A、B、C的版本号分别是100、101、102，且当前系统里只有这四个事务；</li><li>三个事务开始前，(1,1）这一行数据的row trx_id是90。</li></ol><p>这样，事务A的视图数组就是[99,100], 事务B的视图数组是[99,100,101], 事务C的视图数组是[99,100,101,102]。</p><p>为了简化分析，我先把其他干扰语句去掉，只画出跟事务A查询逻辑有关的操作：</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818140942091.png" alt="image-20220818140942091"></p><p>现在事务A要来读数据了，它的视图数组是[99,100]。当然了，读数据都是从当前版本读起的。所以，事务A查询语句的读数据流程是这样的：</p><ul><li>找到(1,3)的时候，判断出row trx_id=101，比高水位大，处于红色区域，不可见；</li><li>接着，找到上一个历史版本，一看row trx_id=102，比高水位大，处于红色区域，不可见；</li><li>再往前找，终于找到了（1,1)，它的row trx_id=90，比低水位小，处于绿色区域，可见。</li></ul><p>这样执行下来，虽然期间这一行数据被修改过，但是事务A不论在什么时候查询，看到这行数据的结果都是一致的，所以我们称之为 <strong>一致性读</strong>。</p><p>这个判断规则是从代码逻辑直接转译过来的，但是正如你所见，用于人肉分析可见性很麻烦。</p><p>所以，我来给你翻译一下。一个数据版本，对于一个事务视图来说，除了自己的更新总是可见以外，有三种情况：</p><ol><li><strong>版本未提交，不可见；</strong></li><li><strong>版本已提交，但是是在视图创建后提交的，不可见；</strong></li><li><strong>版本已提交，而且是在视图创建前提交的，可见。</strong></li></ol><p>现在，我们用这个规则来判断图4中的查询结果，事务A的查询语句的视图数组是在事务A启动的时候生成的，这时候：</p><ul><li>(1,3)还没提交，属于情况1，不可见；</li><li>(1,2)虽然提交了，但是是在视图数组创建之后提交的，属于情况2，不可见；</li><li>(1,1)是在视图数组创建之前提交的，可见。</li></ul><h3 id="_8-2-更新逻辑" tabindex="-1"><a class="header-anchor" href="#_8-2-更新逻辑" aria-hidden="true">#</a> 8.2 更新逻辑</h3><p>细心的同学可能有疑问了：事务B的update语句，如果按照一致性读，好像结果不对哦？</p><p>你看图5中，事务B的视图数组是先生成的，之后事务C才提交，不是应该看不见(1,2)吗，怎么能算出(1,3)来？</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818141152489.png" alt="image-20220818141152489"></p><p>是的，如果事务B在更新之前查询一次数据，这个查询返回的k的值确实是1。</p><p>但是，当它要去更新数据的时候，就不能再在历史版本上更新了，否则事务C的更新就丢失了。因此，事务B此时的set k=k+1是在（1,2）的基础上进行的操作。</p><p>所以，这里就用到了这样一条规则：<strong>更新数据都是先读后写的，而这个读，只能读当前的值，称为“当前读”（current read）。</strong></p><p>因此，在更新的时候，当前读拿到的数据是(1,2)，更新后生成了新版本的数据(1,3)，这个新版本的row trx_id是101。</p><p>所以，在执行事务B查询语句的时候，一看自己的版本号是101，最新数据的版本号也是101，是自己的更新，可以直接使用，所以查询得到的k的值是3。</p><p>当前读：</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># 加读锁
mysql&gt; select k from t where id=1 lock in share mode;
# 加写锁
mysql&gt; select k from t where id=1 for update;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再往前一步，假设事务C不是马上提交的，而是变成了下面的事务C’，会怎么样呢？</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818141326726.png" alt="image-20220818141326726"></p><p>事务C’的不同是，更新后并没有马上提交，在它提交前，事务B的更新语句先发起了。前面说过了，虽然事务C’还没提交，但是(1,2)这个版本也已经生成了，并且是当前的最新版本。那么，事务B的更新语句会怎么处理呢？</p><p>这时候，我们在上一篇文章中提到的“两阶段锁协议”就要上场了。事务C’没提交，也就是说(1,2)这个版本上的写锁还没释放。而事务B是当前读，必须要读最新版本，而且必须加锁，因此就被锁住了，必须等到事务C’释放这个锁，才能继续它的当前读。</p><p>事务B的更新逻辑：</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818141345276.png" alt="image-20220818141345276"></p><p><strong>事务的可重复读的能力是怎么实现的？</strong></p><p>可重复读的核心就是一致性读（consistent read）；而事务更新数据的时候，只能用当前读。如果当前的记录的行锁被其他事务占用的话，就需要进入锁等待。</p><p>而读提交的逻辑和可重复读的逻辑类似，它们最主要的区别是：</p><ul><li>在可重复读隔离级别下，只需要在事务开始的时候创建一致性视图，之后事务里的其他查询都共用这个一致性视图；</li><li>在读提交隔离级别下，<strong>每一个语句执行前都会重新算出一个新的视图。</strong></li></ul><p>读提交隔离级别下的事务状态图：</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818141502019.png" alt="image-20220818141502019"></p><p>这时，事务A的查询语句的视图数组是在执行这个语句的时候创建的，时序上(1,2)、(1,3)的生成时间都在创建这个视图数组的时刻之前。但是，在这个时刻：</p><ul><li>(1,3)还没提交，属于情况1，不可见；</li><li>(1,2)提交了，属于情况3，可见。</li></ul><p>所以，这时候事务A查询语句返回的是k=2。</p><p>显然地，事务B查询结果k=3。</p><h3 id="_8-3-小结" tabindex="-1"><a class="header-anchor" href="#_8-3-小结" aria-hidden="true">#</a> 8.3 小结</h3><p>InnoDB的行数据有多个版本，每个数据版本有自己的row trx_id，每个事务或者语句有自己的一致性视图。普通查询语句是一致性读，<strong>一致性读会根据row trx_id和一致性视图确定数据版本的可见性。</strong></p><ul><li>对于可重复读，查询只承认在事务启动前就已经提交完成的数据；</li><li>对于读提交，查询只承认在语句启动前就已经提交完成的数据；</li></ul><p>而当前读，总是读取已经提交完成的最新版本。</p><p>你也可以想一下，为什么表结构不支持“可重复读”？<strong>这是因为表结构没有对应的行数据，也没有row trx_id，因此只能遵循当前读的逻辑</strong>。</p><p>当然，MySQL 8.0已经可以把表结构放在InnoDB字典里了，也许以后会支持表结构的可重复读。</p><h3 id="_8-4-问题" tabindex="-1"><a class="header-anchor" href="#_8-4-问题" aria-hidden="true">#</a> 8.4 问题</h3><p>我用下面的表结构和初始化语句作为试验环境，事务隔离级别是可重复读。现在，我要把所有“字段c和id值相等的行”的c值清零，但是却发现了一个“诡异”的、改不掉的情况。请你构造出这种情况，并说明其原理。</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; CREATE TABLE `t` (
`id` int(11) NOT NULL,
`c` int(11) DEFAULT NULL,
PRIMARY KEY (`id`)
) ENGINE=InnoDB;
insert into t(id, c) values(1,1),(2,2),(3,3),(4,4);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818141804122.png" alt="image-20220818141804122"></p><p>复现出来以后，请你再思考一下，在实际的业务开发中有没有可能碰到这种情况？你的应用代码会不会掉进这个“坑”里，你又是怎么解决的呢？</p><p><strong>答案：</strong></p><p>情况一：</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818142413853.png" alt="image-20220818142413853"></p><p>情况二：</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220818142627432.png" alt="image-20220818142627432"></p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/tt110617/edit/main/demo/src/backend/database/shizhan/basics.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/9/3 22:24:59</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 1253728268@qq.com">hzz</span><!--]--><!--]--></div></footer><nav class="page-nav"><!----><a href="/myblog/backend/database/shizhan/practice.html" class="nav-link next" aria-label="二、实践篇"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">二、实践篇<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"></div><div class="copyright">Copyright © 2022 十一</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/myblog/assets/app.6a2d513d.js" defer></script>
  </body>
</html>
