import{_ as e}from"./plugin-vue_export-helper.21dcd24c.js";import{o,c,a as n,b as p,d as t,e as s,r as l}from"./app.6a2d513d.js";const i={},u=t(`<h1 id="\u4E8C\u3001redis\u5B9E\u6218\u7BC7" tabindex="-1"><a class="header-anchor" href="#\u4E8C\u3001redis\u5B9E\u6218\u7BC7" aria-hidden="true">#</a> \u4E8C\u3001Redis\u5B9E\u6218\u7BC7</h1><h2 id="\u5F00\u7BC7\u5BFC\u8BFB" tabindex="-1"><a class="header-anchor" href="#\u5F00\u7BC7\u5BFC\u8BFB" aria-hidden="true">#</a> \u5F00\u7BC7\u5BFC\u8BFB</h2><p>\u4EB2\u7231\u7684\u5C0F\u4F19\u4F34\u4EEC\u5927\u5BB6\u597D\uFF0C\u9A6C\u4E0A\u54B1\u4EEC\u5C31\u5F00\u59CB\u5B9E\u6218\u7BC7\u7684\u5185\u5BB9\u4E86\uFF0C\u76F8\u4FE1\u901A\u8FC7\u672C\u7AE0\u7684\u5B66\u4E60\uFF0C\u5C0F\u4F19\u4F34\u4EEC\u5C31\u80FD\u7406\u89E3\u5404\u79CDredis\u7684\u4F7F\u7528\u5566\uFF0C\u63A5\u4E0B\u6765\u54B1\u4EEC\u6765\u4E00\u8D77\u770B\u770B\u5B9E\u6218\u7BC7\u6211\u4EEC\u8981\u5B66\u4E60\u4E00\u4E9B\u4EC0\u4E48\u6837\u7684\u5185\u5BB9</p><ul><li>\u77ED\u4FE1\u767B\u5F55</li></ul><p>\u8FD9\u4E00\u5757\u6211\u4EEC\u4F1A\u4F7F\u7528redis\u5171\u4EABsession\u6765\u5B9E\u73B0</p><ul><li>\u5546\u6237\u67E5\u8BE2\u7F13\u5B58</li></ul><p>\u901A\u8FC7\u672C\u7AE0\u8282\uFF0C\u6211\u4EEC\u4F1A\u7406\u89E3\u7F13\u5B58\u51FB\u7A7F\uFF0C\u7F13\u5B58\u7A7F\u900F\uFF0C\u7F13\u5B58\u96EA\u5D29\u7B49\u95EE\u9898\uFF0C\u8BA9\u5C0F\u4F19\u4F34\u7684\u5BF9\u4E8E\u8FD9\u4E9B\u6982\u5FF5\u7684\u7406\u89E3\u4E0D\u4EC5\u4EC5\u662F\u505C\u7559\u5728\u6982\u5FF5\u4E0A\uFF0C\u66F4\u662F\u80FD\u5728\u4EE3\u7801\u4E2D\u770B\u5230\u5BF9\u5E94\u7684\u5185\u5BB9</p><ul><li>\u4F18\u60E0\u5377\u79D2\u6740</li></ul><p>\u901A\u8FC7\u672C\u7AE0\u8282\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5B66\u4F1ARedis\u7684\u8BA1\u6570\u5668\u529F\u80FD\uFF0C \u7ED3\u5408Lua\u5B8C\u6210\u9AD8\u6027\u80FD\u7684redis\u64CD\u4F5C\uFF0C\u540C\u65F6\u5B66\u4F1ARedis\u5206\u5E03\u5F0F\u9501\u7684\u539F\u7406\uFF0C\u5305\u62ECRedis\u7684\u4E09\u79CD\u6D88\u606F\u961F\u5217</p><ul><li>\u9644\u8FD1\u7684\u5546\u6237</li></ul><p>\u6211\u4EEC\u5229\u7528Redis\u7684GEOHash\u6765\u5B8C\u6210\u5BF9\u4E8E\u5730\u7406\u5750\u6807\u7684\u64CD\u4F5C</p><ul><li>UV\u7EDF\u8BA1</li></ul><p>\u4E3B\u8981\u662F\u4F7F\u7528Redis\u6765\u5B8C\u6210\u7EDF\u8BA1\u529F\u80FD</p><ul><li>\u7528\u6237\u7B7E\u5230</li></ul><p>\u4F7F\u7528Redis\u7684BitMap\u6570\u636E\u7EDF\u8BA1\u529F\u80FD</p><ul><li>\u597D\u53CB\u5173\u6CE8</li></ul><p>\u57FA\u4E8ESet\u96C6\u5408\u7684\u5173\u6CE8\u3001\u53D6\u6D88\u5173\u6CE8\uFF0C\u5171\u540C\u5173\u6CE8\u7B49\u7B49\u529F\u80FD\uFF0C\u8FD9\u4E00\u5757\u77E5\u8BC6\u54B1\u4EEC\u4E4B\u524D\u5C31\u8BB2\u8FC7\uFF0C\u8FD9\u6B21\u6211\u4EEC\u5728\u9879\u76EE\u4E2D\u6765\u4F7F\u7528\u4E00\u4E0B</p><ul><li>\u6253\u4EBA\u63A2\u5E97</li></ul><p>\u57FA\u4E8EList\u6765\u5B8C\u6210\u70B9\u8D5E\u5217\u8868\u7684\u64CD\u4F5C\uFF0C\u540C\u65F6\u57FA\u4E8ESortedSet\u6765\u5B8C\u6210\u70B9\u8D5E\u7684\u6392\u884C\u699C\u529F\u80FD</p><p>\u4EE5\u4E0A\u8FD9\u4E9B\u5185\u5BB9\u54B1\u4EEC\u7EDF\u7EDF\u90FD\u4F1A\u7ED9\u5C0F\u4F19\u4F34\u4EEC\u8BB2\u89E3\u6E05\u695A\uFF0C\u8BA9\u5927\u5BB6\u5145\u5206\u7406\u89E3\u5982\u4F55\u4F7F\u7528Redis</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653056228879.png" alt="1653056228879"></p><h2 id="_1\u3001\u77ED\u4FE1\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u77ED\u4FE1\u767B\u5F55" aria-hidden="true">#</a> 1\u3001\u77ED\u4FE1\u767B\u5F55</h2><h3 id="_1-1\u3001\u5BFC\u5165\u9ED1\u9A6C\u70B9\u8BC4\u9879\u76EE" tabindex="-1"><a class="header-anchor" href="#_1-1\u3001\u5BFC\u5165\u9ED1\u9A6C\u70B9\u8BC4\u9879\u76EE" aria-hidden="true">#</a> 1.1\u3001\u5BFC\u5165\u9ED1\u9A6C\u70B9\u8BC4\u9879\u76EE</h3><h4 id="_1-1-1-\u3001\u5BFC\u5165sql" tabindex="-1"><a class="header-anchor" href="#_1-1-1-\u3001\u5BFC\u5165sql" aria-hidden="true">#</a> 1.1.1 \u3001\u5BFC\u5165SQL</h4><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653057872536.png" alt="1653057872536"></p><h4 id="_1-1-2\u3001\u6709\u5173\u5F53\u524D\u6A21\u578B" tabindex="-1"><a class="header-anchor" href="#_1-1-2\u3001\u6709\u5173\u5F53\u524D\u6A21\u578B" aria-hidden="true">#</a> 1.1.2\u3001\u6709\u5173\u5F53\u524D\u6A21\u578B</h4><p>\u624B\u673A\u6216\u8005app\u7AEF\u53D1\u8D77\u8BF7\u6C42\uFF0C\u8BF7\u6C42\u6211\u4EEC\u7684nginx\u670D\u52A1\u5668\uFF0Cnginx\u57FA\u4E8E\u4E03\u5C42\u6A21\u578B\u8D70\u7684\u4E8BHTTP\u534F\u8BAE\uFF0C\u53EF\u4EE5\u5B9E\u73B0\u57FA\u4E8ELua\u76F4\u63A5\u7ED5\u5F00tomcat\u8BBF\u95EEredis\uFF0C\u4E5F\u53EF\u4EE5\u4F5C\u4E3A\u9759\u6001\u8D44\u6E90\u670D\u52A1\u5668\uFF0C\u8F7B\u677E\u625B\u4E0B\u4E0A\u4E07\u5E76\u53D1\uFF0C \u8D1F\u8F7D\u5747\u8861\u5230\u4E0B\u6E38tomcat\u670D\u52A1\u5668\uFF0C\u6253\u6563\u6D41\u91CF\uFF0C\u6211\u4EEC\u90FD\u77E5\u9053\u4E00\u53F04\u68388G\u7684tomcat\uFF0C\u5728\u4F18\u5316\u548C\u5904\u7406\u7B80\u5355\u4E1A\u52A1\u7684\u52A0\u6301\u4E0B\uFF0C\u5927\u4E0D\u4E86\u5C31\u5904\u74061000\u5DE6\u53F3\u7684\u5E76\u53D1\uFF0C \u7ECF\u8FC7nginx\u7684\u8D1F\u8F7D\u5747\u8861\u5206\u6D41\u540E\uFF0C\u5229\u7528\u96C6\u7FA4\u652F\u6491\u8D77\u6574\u4E2A\u9879\u76EE\uFF0C\u540C\u65F6nginx\u5728\u90E8\u7F72\u4E86\u524D\u7AEF\u9879\u76EE\u540E\uFF0C\u66F4\u662F\u53EF\u4EE5\u505A\u5230\u52A8\u9759\u5206\u79BB\uFF0C\u8FDB\u4E00\u6B65\u964D\u4F4Etomcat\u670D\u52A1\u7684\u538B\u529B\uFF0C\u8FD9\u4E9B\u529F\u80FD\u90FD\u5F97\u9760nginx\u8D77\u4F5C\u7528\uFF0C\u6240\u4EE5nginx\u662F\u6574\u4E2A\u9879\u76EE\u4E2D\u91CD\u8981\u7684\u4E00\u73AF\u3002</p><p>\u5728tomcat\u652F\u6491\u8D77\u5E76\u53D1\u6D41\u91CF\u540E\uFF0C\u6211\u4EEC\u5982\u679C\u8BA9tomcat\u76F4\u63A5\u53BB\u8BBF\u95EEMysql\uFF0C\u6839\u636E\u7ECF\u9A8CMysql\u4F01\u4E1A\u7EA7\u670D\u52A1\u5668\u53EA\u8981\u4E0A\u70B9\u5E76\u53D1\uFF0C\u4E00\u822C\u662F16\u621632 \u6838\u5FC3cpu\uFF0C32 \u621664G\u5185\u5B58\uFF0C\u50CF\u4F01\u4E1A\u7EA7mysql\u52A0\u4E0A\u56FA\u6001\u786C\u76D8\u80FD\u591F\u652F\u6491\u7684\u5E76\u53D1\uFF0C\u5927\u6982\u5C31\u662F4000\u8D77~7000\u5DE6\u53F3\uFF0C\u4E0A\u4E07\u5E76\u53D1\uFF0C \u77AC\u95F4\u5C31\u4F1A\u8BA9Mysql\u670D\u52A1\u5668\u7684cpu\uFF0C\u786C\u76D8\u5168\u90E8\u6253\u6EE1\uFF0C\u5BB9\u6613\u5D29\u6E83\uFF0C\u6240\u4EE5\u6211\u4EEC\u5728\u9AD8\u5E76\u53D1\u573A\u666F\u4E0B\uFF0C\u4F1A\u9009\u62E9\u4F7F\u7528mysql\u96C6\u7FA4\uFF0C\u540C\u65F6\u4E3A\u4E86\u8FDB\u4E00\u6B65\u964D\u4F4EMysql\u7684\u538B\u529B\uFF0C\u540C\u65F6\u589E\u52A0\u8BBF\u95EE\u7684\u6027\u80FD\uFF0C\u6211\u4EEC\u4E5F\u4F1A\u52A0\u5165Redis\uFF0C\u540C\u65F6\u4F7F\u7528Redis\u96C6\u7FA4\u4F7F\u5F97Redis\u5BF9\u5916\u63D0\u4F9B\u66F4\u597D\u7684\u670D\u52A1\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653059409865.png" alt="1653059409865"></p><h4 id="_1-1-3\u3001\u5BFC\u5165\u540E\u7AEF\u9879\u76EE" tabindex="-1"><a class="header-anchor" href="#_1-1-3\u3001\u5BFC\u5165\u540E\u7AEF\u9879\u76EE" aria-hidden="true">#</a> 1.1.3\u3001\u5BFC\u5165\u540E\u7AEF\u9879\u76EE</h4><p>\u5728\u8D44\u6599\u4E2D\u63D0\u4F9B\u4E86\u4E00\u4E2A\u9879\u76EE\u6E90\u7801\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653060237073.png" alt="1653060237073"></p><h4 id="_1-1-4\u3001\u5BFC\u5165\u524D\u7AEF\u5DE5\u7A0B" tabindex="-1"><a class="header-anchor" href="#_1-1-4\u3001\u5BFC\u5165\u524D\u7AEF\u5DE5\u7A0B" aria-hidden="true">#</a> 1.1.4\u3001\u5BFC\u5165\u524D\u7AEF\u5DE5\u7A0B</h4><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653060337562.png" alt="1653060337562"></p><h4 id="_1-1-5-\u8FD0\u884C\u524D\u7AEF\u9879\u76EE" tabindex="-1"><a class="header-anchor" href="#_1-1-5-\u8FD0\u884C\u524D\u7AEF\u9879\u76EE" aria-hidden="true">#</a> 1.1.5 \u8FD0\u884C\u524D\u7AEF\u9879\u76EE</h4><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653060588190.png" alt="1653060588190"></p><h3 id="_1-2\u3001\u57FA\u4E8Esession\u5B9E\u73B0\u767B\u5F55\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_1-2\u3001\u57FA\u4E8Esession\u5B9E\u73B0\u767B\u5F55\u6D41\u7A0B" aria-hidden="true">#</a> 1.2\u3001\u57FA\u4E8ESession\u5B9E\u73B0\u767B\u5F55\u6D41\u7A0B</h3><p><strong>\u53D1\u9001\u9A8C\u8BC1\u7801\uFF1A</strong></p><p>\u7528\u6237\u5728\u63D0\u4EA4\u624B\u673A\u53F7\u540E\uFF0C\u4F1A\u6821\u9A8C\u624B\u673A\u53F7\u662F\u5426\u5408\u6CD5\uFF0C\u5982\u679C\u4E0D\u5408\u6CD5\uFF0C\u5219\u8981\u6C42\u7528\u6237\u91CD\u65B0\u8F93\u5165\u624B\u673A\u53F7</p><p>\u5982\u679C\u624B\u673A\u53F7\u5408\u6CD5\uFF0C\u540E\u53F0\u6B64\u65F6\u751F\u6210\u5BF9\u5E94\u7684\u9A8C\u8BC1\u7801\uFF0C\u540C\u65F6\u5C06\u9A8C\u8BC1\u7801\u8FDB\u884C\u4FDD\u5B58\uFF0C\u7136\u540E\u518D\u901A\u8FC7\u77ED\u4FE1\u7684\u65B9\u5F0F\u5C06\u9A8C\u8BC1\u7801\u53D1\u9001\u7ED9\u7528\u6237</p><p><strong>\u77ED\u4FE1\u9A8C\u8BC1\u7801\u767B\u5F55\u3001\u6CE8\u518C\uFF1A</strong></p><p>\u7528\u6237\u5C06\u9A8C\u8BC1\u7801\u548C\u624B\u673A\u53F7\u8FDB\u884C\u8F93\u5165\uFF0C\u540E\u53F0\u4ECEsession\u4E2D\u62FF\u5230\u5F53\u524D\u9A8C\u8BC1\u7801\uFF0C\u7136\u540E\u548C\u7528\u6237\u8F93\u5165\u7684\u9A8C\u8BC1\u7801\u8FDB\u884C\u6821\u9A8C\uFF0C\u5982\u679C\u4E0D\u4E00\u81F4\uFF0C\u5219\u65E0\u6CD5\u901A\u8FC7\u6821\u9A8C\uFF0C\u5982\u679C\u4E00\u81F4\uFF0C\u5219\u540E\u53F0\u6839\u636E\u624B\u673A\u53F7\u67E5\u8BE2\u7528\u6237\uFF0C\u5982\u679C\u7528\u6237\u4E0D\u5B58\u5728\uFF0C\u5219\u4E3A\u7528\u6237\u521B\u5EFA\u8D26\u53F7\u4FE1\u606F\uFF0C\u4FDD\u5B58\u5230\u6570\u636E\u5E93\uFF0C\u65E0\u8BBA\u662F\u5426\u5B58\u5728\uFF0C\u90FD\u4F1A\u5C06\u7528\u6237\u4FE1\u606F\u4FDD\u5B58\u5230session\u4E2D\uFF0C\u65B9\u4FBF\u540E\u7EED\u83B7\u5F97\u5F53\u524D\u767B\u5F55\u4FE1\u606F</p><p><strong>\u6821\u9A8C\u767B\u5F55\u72B6\u6001:</strong></p><p>\u7528\u6237\u5728\u8BF7\u6C42\u65F6\u5019\uFF0C\u4F1A\u4ECEcookie\u4E2D\u643A\u5E26\u8005JsessionId\u5230\u540E\u53F0\uFF0C\u540E\u53F0\u901A\u8FC7JsessionId\u4ECEsession\u4E2D\u62FF\u5230\u7528\u6237\u4FE1\u606F\uFF0C\u5982\u679C\u6CA1\u6709session\u4FE1\u606F\uFF0C\u5219\u8FDB\u884C\u62E6\u622A\uFF0C\u5982\u679C\u6709session\u4FE1\u606F\uFF0C\u5219\u5C06\u7528\u6237\u4FE1\u606F\u4FDD\u5B58\u5230threadLocal\u4E2D\uFF0C\u5E76\u4E14\u653E\u884C</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653066208144.png" alt="1653066208144"></p><h3 id="_1-3\u3001\u5B9E\u73B0\u53D1\u9001\u77ED\u4FE1\u9A8C\u8BC1\u7801\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_1-3\u3001\u5B9E\u73B0\u53D1\u9001\u77ED\u4FE1\u9A8C\u8BC1\u7801\u529F\u80FD" aria-hidden="true">#</a> 1.3\u3001\u5B9E\u73B0\u53D1\u9001\u77ED\u4FE1\u9A8C\u8BC1\u7801\u529F\u80FD</h3><p><strong>\u903B\u8F91\uFF1A</strong></p><p>1.\u6821\u9A8C\u624B\u673A\u53F7\u662F\u5426\u6B63\u786E</p><p>\u200B 1.1 \u9519\u8BEF\u5219\u8FD4\u56DE\u9519\u8BEF\u4FE1\u606F</p><p>2.\u751F\u6210\u9A8C\u8BC1\u7801</p><p>3.\u5C06\u9A8C\u8BC1\u7801\u4FDD\u5B58\u5230session\u4E2D</p><p>4.\u53D1\u9001\u9A8C\u8BC1\u7801</p><p><strong>\u9875\u9762\u6D41\u7A0B</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653067054461.png" alt="1653067054461"></p><p><strong>\u5177\u4F53\u4EE3\u7801\u5982\u4E0B</strong></p><p><strong>\u8D34\u5FC3\u5C0F\u63D0\u793A\uFF1A</strong></p><p>\u5177\u4F53\u903B\u8F91\u4E0A\u6587\u5DF2\u7ECF\u5206\u6790\uFF0C\u6211\u4EEC\u4EC5\u4EC5\u53EA\u9700\u8981\u6309\u7167\u63D0\u793A\u7684\u903B\u8F91\u5199\u51FA\u4EE3\u7801\u5373\u53EF\u3002</p><ul><li>\u53D1\u9001\u9A8C\u8BC1\u7801</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token doc-comment comment">/**
     * \u53D1\u9001\u624B\u673A\u9A8C\u8BC1\u7801
     * <span class="token keyword">@param</span> <span class="token parameter">phone</span>
     * <span class="token keyword">@param</span> <span class="token parameter">session</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u6821\u9A8C\u624B\u673A\u53F7\u662F\u5426\u6B63\u786E</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.1 \u9519\u8BEF\u5219\u8FD4\u56DE\u9519\u8BEF\u4FE1\u606F</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u624B\u673A\u683C\u5F0F\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.\u751F\u6210\u9A8C\u8BC1\u7801</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomNumbers</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.\u5C06\u9A8C\u8BC1\u7801\u4FDD\u5B58\u5230session\u4E2D</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u53D1\u9001\u9A8C\u8BC1\u7801</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;\u77ED\u4FE1\u9A8C\u8BC1\u7801\u4E3A\uFF1A{}&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u767B\u5F55</li></ul><p>1.\u6821\u9A8C\u624B\u673A\u53F7</p><p>2.\u6821\u9A8C\u9A8C\u8BC1\u7801</p><p>3.\u6839\u636E\u624B\u673A\u53F7\u67E5\u8BE2\u7528\u6237</p><p>4.\u82E5\u4E0D\u5B58\u5728\uFF0C\u63D2\u5165\u65B0\u7528\u6237</p><p>5.\u5C06 \u7528\u6237\u4FE1\u606F \u4FDD\u5B58\u5230 session \u4E2D</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * \u767B\u5F55\u529F\u80FD
     * <span class="token keyword">@param</span> <span class="token parameter">loginForm</span> \u767B\u5F55\u53C2\u6570\uFF0C\u5305\u542B\u624B\u673A\u53F7\u3001\u9A8C\u8BC1\u7801\uFF1B\u6216\u8005\u624B\u673A\u53F7\u3001\u5BC6\u7801
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginFormDTO</span> loginForm<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u6821\u9A8C\u624B\u673A\u53F7</span>
        <span class="token class-name">String</span> phone <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.1 \u9519\u8BEF\u5219\u8FD4\u56DE\u9519\u8BEF\u4FE1\u606F</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u624B\u673A\u683C\u5F0F\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.\u6821\u9A8C\u9A8C\u8BC1\u7801</span>
        <span class="token class-name">String</span> cacheCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheCode <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>cacheCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u9A8C\u8BC1\u7801\u4E0D\u4E00\u81F4\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u6839\u636E\u624B\u673A\u53F7\u67E5\u8BE2\u7528\u6237</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u82E5\u4E0D\u5B58\u5728\uFF0C\u63D2\u5165\u65B0\u7528\u6237</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span>USER_NICK_NAME_PREFIX <span class="token operator">+</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5.\u5C06 \u7528\u6237\u4FE1\u606F \u4FDD\u5B58\u5230 session \u4E2D</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>USER_NICK_NAME_PREFIX <span class="token operator">+</span>  <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4\u3001\u5B9E\u73B0\u767B\u5F55\u62E6\u622A\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_1-4\u3001\u5B9E\u73B0\u767B\u5F55\u62E6\u622A\u529F\u80FD" aria-hidden="true">#</a> 1.4\u3001\u5B9E\u73B0\u767B\u5F55\u62E6\u622A\u529F\u80FD</h3><p>1.\u4ECE session \u4E2D\u83B7\u53D6\u7528\u6237\u4FE1\u606F</p><p>2.\u5224\u65AD\u7528\u6237\u662F\u5426\u5B58\u5728</p><p>\u200B 2.1\u4E0D\u5B58\u5728\u5219\u62E6\u622A</p><p>3.\u628A\u7528\u6237\u4FE1\u606F\u653E\u5728 ThreadLocal\uFF08<code>\u7EBF\u7A0B\u9694\u79BB</code>\uFF09 \u4E2D\uFF0C\u653E\u884C</p><p>\u95EE\u9898\uFF1A</p><blockquote><p>\u96BE\u9053\u6211\u4EEC\u6BCF\u6B21\u90FD\u9700\u8981\u7F16\u5199\u4EE3\u7801\uFF0C\u4ECE session \u4E2D\u53D6\u503C\u5417\uFF1F</p></blockquote><p><code>\u4F7F\u7528\u62E6\u622A\u5668</code></p><p><strong>\u6E29\u99A8\u5C0F\u8D34\u58EB\uFF1Atomcat\u7684\u8FD0\u884C\u539F\u7406</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653068196656.png" alt="1653068196656"></p><p>\u5F53\u7528\u6237\u53D1\u8D77\u8BF7\u6C42\u65F6\uFF0C\u4F1A\u8BBF\u95EE\u6211\u4EEC\u50CFtomcat\u6CE8\u518C\u7684\u7AEF\u53E3\uFF0C\u4EFB\u4F55\u7A0B\u5E8F\u60F3\u8981\u8FD0\u884C\uFF0C\u90FD\u9700\u8981\u6709\u4E00\u4E2A\u7EBF\u7A0B\u5BF9\u5F53\u524D\u7AEF\u53E3\u53F7\u8FDB\u884C\u76D1\u542C\uFF0Ctomcat\u4E5F\u4E0D\u4F8B\u5916\uFF0C\u5F53\u76D1\u542C\u7EBF\u7A0B\u77E5\u9053\u7528\u6237\u60F3\u8981\u548Ctomcat\u8FDE\u63A5\u8FDE\u63A5\u65F6\uFF0C\u90A3\u4F1A\u7531\u76D1\u542C\u7EBF\u7A0B\u521B\u5EFAsocket\u8FDE\u63A5\uFF0Csocket\u90FD\u662F\u6210\u5BF9\u51FA\u73B0\u7684\uFF0C\u7528\u6237\u901A\u8FC7socket\u50CF\u4E92\u76F8\u4F20\u9012\u6570\u636E\uFF0C\u5F53tomcat\u7AEF\u7684socket\u63A5\u53D7\u5230\u6570\u636E\u540E\uFF0C\u6B64\u65F6\u76D1\u542C\u7EBF\u7A0B\u4F1A\u4ECEtomcat\u7684\u7EBF\u7A0B\u6C60\u4E2D\u53D6\u51FA\u4E00\u4E2A\u7EBF\u7A0B\u6267\u884C\u7528\u6237\u8BF7\u6C42\uFF0C\u5728\u6211\u4EEC\u7684\u670D\u52A1\u90E8\u7F72\u5230tomcat\u540E\uFF0C\u7EBF\u7A0B\u4F1A\u627E\u5230\u7528\u6237\u60F3\u8981\u8BBF\u95EE\u7684\u5DE5\u7A0B\uFF0C\u7136\u540E\u7528\u8FD9\u4E2A\u7EBF\u7A0B\u8F6C\u53D1\u5230\u5DE5\u7A0B\u4E2D\u7684controller\uFF0Cservice\uFF0Cdao\u4E2D\uFF0C\u5E76\u4E14\u8BBF\u95EE\u5BF9\u5E94\u7684DB\uFF0C\u5728\u7528\u6237\u6267\u884C\u5B8C\u8BF7\u6C42\u540E\uFF0C\u518D\u7EDF\u4E00\u8FD4\u56DE\uFF0C\u518D\u627E\u5230tomcat\u7AEF\u7684socket\uFF0C\u518D\u5C06\u6570\u636E\u5199\u56DE\u5230\u7528\u6237\u7AEF\u7684socket\uFF0C\u5B8C\u6210\u8BF7\u6C42\u548C\u54CD\u5E94</p><p>\u901A\u8FC7\u4EE5\u4E0A\u8BB2\u89E3\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5F97\u77E5 \u6BCF\u4E2A\u7528\u6237\u5176\u5B9E\u5BF9\u5E94\u90FD\u662F\u53BB\u627Etomcat\u7EBF\u7A0B\u6C60\u4E2D\u7684\u4E00\u4E2A\u7EBF\u7A0B\u6765\u5B8C\u6210\u5DE5\u4F5C\u7684\uFF0C \u4F7F\u7528\u5B8C\u6210\u540E\u518D\u8FDB\u884C\u56DE\u6536\uFF0C\u65E2\u7136\u6BCF\u4E2A\u8BF7\u6C42\u90FD\u662F\u72EC\u7ACB\u7684\uFF0C\u6240\u4EE5\u5728\u6BCF\u4E2A\u7528\u6237\u53BB\u8BBF\u95EE\u6211\u4EEC\u7684\u5DE5\u7A0B\u65F6\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528<code>threadlocal\u6765\u505A\u5230\u7EBF\u7A0B\u9694\u79BB\uFF0C\u6BCF\u4E2A\u7EBF\u7A0B\u64CD\u4F5C\u81EA\u5DF1\u7684\u4E00\u4EFD\u6570\u636E</code></p><p><strong>\u6E29\u99A8\u5C0F\u8D34\u58EB\uFF1A\u5173\u4E8Ethreadlocal</strong></p><p>\u5982\u679C\u5C0F\u4F19\u4F34\u4EEC\u770B\u8FC7threadLocal\u7684\u6E90\u7801\uFF0C\u4F60\u4F1A\u53D1\u73B0\u5728threadLocal\u4E2D\uFF0C\u65E0\u8BBA\u662F\u4ED6\u7684put\u65B9\u6CD5\u548C\u4ED6\u7684get\u65B9\u6CD5\uFF0C \u90FD\u662F\u5148\u4ECE\u83B7\u5F97\u5F53\u524D\u7528\u6237\u7684\u7EBF\u7A0B\uFF0C\u7136\u540E\u4ECE\u7EBF\u7A0B\u4E2D\u53D6\u51FA\u7EBF\u7A0B\u7684\u6210\u5458\u53D8\u91CFmap\uFF0C\u53EA\u8981\u7EBF\u7A0B\u4E0D\u4E00\u6837\uFF0Cmap\u5C31\u4E0D\u4E00\u6837\uFF0C\u6240\u4EE5\u53EF\u4EE5\u901A\u8FC7\u8FD9\u79CD\u65B9\u5F0F\u6765\u505A\u5230\u7EBF\u7A0B\u9694\u79BB</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653068874258.png" alt="1653068874258"></p><p>\u62E6\u622A\u5668\u4EE3\u7801</p><div class="language-Java ext-Java line-numbers-mode"><pre class="language-Java"><code>/**
 * \u767B\u5F55\u62E6\u622A\u5668
 * @author hzz
 * @create 2022-07-25 23:51
 */
public class LoginInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        // 1.\u4ECE session \u4E2D\u83B7\u53D6\u7528\u6237\u4FE1\u606F
        User user = (User) request.getSession().getAttribute(&quot;user&quot;);
        // 2.\u5224\u65AD\u7528\u6237\u662F\u5426\u5B58\u5728
        if (user == null) {
            // 2.1 \u4E0D\u5B58\u5728\u5219\u62E6\u622A
            response.setStatus(401);
            return false;
        }
        // 3.\u628A\u7528\u6237\u4FE1\u606F\u653E\u5728 ThreadLocal \u4E2D\uFF0C\u653E\u884C
        UserDTO userDTO = new UserDTO();
        userDTO.setId(user.getId());
        userDTO.setNickName(user.getNickName());
        userDTO.setIcon(user.getIcon());
        UserHolder.saveUser(userDTO);
        // \u653E\u884C
        return true;
    }


    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        // \u79FB\u9664\u7528\u6237\uFF0C\u907F\u514D\u4FE1\u606F\u6CC4\u9732
        UserHolder.removeUser();
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8BA9\u62E6\u622A\u5668\u751F\u6548</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u8BA9\u62E6\u622A\u5668\u751F\u6548
 * <span class="token keyword">@author</span> hzz
 * <span class="token keyword">@create</span> 2022-07-26 0:05
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span>
                <span class="token string">&quot;/shop/**&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/voucher/**&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/shop-type/**&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/upload/**&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/blog/hot&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/user/code&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/user/login&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-5\u3001\u9690\u85CF\u7528\u6237\u654F\u611F\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#_1-5\u3001\u9690\u85CF\u7528\u6237\u654F\u611F\u4FE1\u606F" aria-hidden="true">#</a> 1.5\u3001\u9690\u85CF\u7528\u6237\u654F\u611F\u4FE1\u606F</h3><p>\u6211\u4EEC\u901A\u8FC7\u6D4F\u89C8\u5668\u89C2\u5BDF\u5230\u6B64\u65F6\u7528\u6237\u7684\u5168\u90E8\u4FE1\u606F\u90FD\u5728\uFF0C\u8FD9\u6837\u6781\u4E3A\u4E0D\u9760\u8C31\uFF0C\u6240\u4EE5\u6211\u4EEC\u5E94\u5F53\u5728\u8FD4\u56DE\u7528\u6237\u4FE1\u606F\u4E4B\u524D\uFF0C\u5C06\u7528\u6237\u7684\u654F\u611F\u4FE1\u606F\u8FDB\u884C\u9690\u85CF\uFF0C\u91C7\u7528\u7684\u6838\u5FC3\u601D\u8DEF\u5C31\u662F\u4E66\u5199\u4E00\u4E2AUserDto\u5BF9\u8C61\uFF0C\u8FD9\u4E2AUserDto\u5BF9\u8C61\u5C31\u6CA1\u6709\u654F\u611F\u4FE1\u606F\u4E86\uFF0C\u6211\u4EEC\u5728\u8FD4\u56DE\u524D\uFF0C\u5C06\u6709\u7528\u6237\u654F\u611F\u4FE1\u606F\u7684User\u5BF9\u8C61\u8F6C\u5316\u6210\u6CA1\u6709\u654F\u611F\u4FE1\u606F\u7684UserDto\u5BF9\u8C61\uFF0C\u90A3\u4E48\u5C31\u80FD\u591F\u907F\u514D\u8FD9\u4E2A\u5C34\u5C2C\u7684\u95EE\u9898\u4E86</p><p><strong>\u5728\u767B\u5F55\u65B9\u6CD5\u5904\u4FEE\u6539</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//7.\u4FDD\u5B58\u7528\u6237\u4FE1\u606F\u5230session\u4E2D</span>
session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span><span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u5728\u62E6\u622A\u5668\u5904\uFF1A</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//5.\u5B58\u5728\uFF0C\u4FDD\u5B58\u7528\u6237\u4FE1\u606F\u5230Threadlocal</span>
<span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">UserDTO</span><span class="token punctuation">)</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u5728UserHolder\u5904\uFF1A\u5C06user\u5BF9\u8C61\u6362\u6210UserDTO</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserHolder</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> tl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveUser</span><span class="token punctuation">(</span><span class="token class-name">UserDTO</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
        tl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserDTO</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> tl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        tl<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-6\u3001session\u5171\u4EAB\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_1-6\u3001session\u5171\u4EAB\u95EE\u9898" aria-hidden="true">#</a> 1.6\u3001session\u5171\u4EAB\u95EE\u9898</h3><p><strong>\u6838\u5FC3\u601D\u8DEF\u5206\u6790\uFF1A</strong></p><p>\u6BCF\u4E2Atomcat\u4E2D\u90FD\u6709\u4E00\u4EFD\u5C5E\u4E8E\u81EA\u5DF1\u7684session,\u5047\u8BBE\u7528\u6237\u7B2C\u4E00\u6B21\u8BBF\u95EE\u7B2C\u4E00\u53F0tomcat\uFF0C\u5E76\u4E14\u628A\u81EA\u5DF1\u7684\u4FE1\u606F\u5B58\u653E\u5230\u7B2C\u4E00\u53F0\u670D\u52A1\u5668\u7684session\u4E2D\uFF0C\u4F46\u662F\u7B2C\u4E8C\u6B21\u8FD9\u4E2A\u7528\u6237\u8BBF\u95EE\u5230\u4E86\u7B2C\u4E8C\u53F0tomcat\uFF0C\u90A3\u4E48\u5728\u7B2C\u4E8C\u53F0\u670D\u52A1\u5668\u4E0A\uFF0C\u80AF\u5B9A\u6CA1\u6709\u7B2C\u4E00\u53F0\u670D\u52A1\u5668\u5B58\u653E\u7684session\uFF0C\u6240\u4EE5\u6B64\u65F6 \u6574\u4E2A\u767B\u5F55\u62E6\u622A\u529F\u80FD\u5C31\u4F1A\u51FA\u73B0\u95EE\u9898\uFF0C\u6211\u4EEC\u80FD\u5982\u4F55\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\u5462\uFF1F\u65E9\u671F\u7684\u65B9\u6848\u662Fsession\u62F7\u8D1D\uFF0C\u5C31\u662F\u8BF4\u867D\u7136\u6BCF\u4E2Atomcat\u4E0A\u90FD\u6709\u4E0D\u540C\u7684session\uFF0C\u4F46\u662F\u6BCF\u5F53\u4EFB\u610F\u4E00\u53F0\u670D\u52A1\u5668\u7684session\u4FEE\u6539\u65F6\uFF0C\u90FD\u4F1A\u540C\u6B65\u7ED9\u5176\u4ED6\u7684Tomcat\u670D\u52A1\u5668\u7684session\uFF0C\u8FD9\u6837\u7684\u8BDD\uFF0C\u5C31\u53EF\u4EE5\u5B9E\u73B0session\u7684\u5171\u4EAB\u4E86</p><p>\u4F46\u662F\u8FD9\u79CD\u65B9\u6848\u5177\u6709\u4E24\u4E2A\u5927\u95EE\u9898</p><p>1\u3001\u6BCF\u53F0\u670D\u52A1\u5668\u4E2D\u90FD\u6709\u5B8C\u6574\u7684\u4E00\u4EFDsession\u6570\u636E\uFF0C\u670D\u52A1\u5668\u538B\u529B\u8FC7\u5927\u3002</p><p>2\u3001session\u62F7\u8D1D\u6570\u636E\u65F6\uFF0C\u53EF\u80FD\u4F1A\u51FA\u73B0\u5EF6\u8FDF</p><p>\u6240\u4EE5\u54B1\u4EEC\u540E\u6765\u91C7\u7528\u7684\u65B9\u6848\u90FD\u662F\u57FA\u4E8Eredis\u6765\u5B8C\u6210\uFF0C\u6211\u4EEC\u628Asession\u6362\u6210redis\uFF0Credis\u6570\u636E\u672C\u8EAB\u5C31\u662F\u5171\u4EAB\u7684\uFF0C\u5C31\u53EF\u4EE5\u907F\u514Dsession\u5171\u4EAB\u7684\u95EE\u9898\u4E86</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653069893050.png" alt="1653069893050"></p><h3 id="_1-7\u3001redis\u4EE3\u66FFsession\u7684\u4E1A\u52A1\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_1-7\u3001redis\u4EE3\u66FFsession\u7684\u4E1A\u52A1\u6D41\u7A0B" aria-hidden="true">#</a> 1.7\u3001Redis\u4EE3\u66FFsession\u7684\u4E1A\u52A1\u6D41\u7A0B</h3><h4 id="_1-7-1\u3001\u8BBE\u8BA1key\u7684\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#_1-7-1\u3001\u8BBE\u8BA1key\u7684\u7ED3\u6784" aria-hidden="true">#</a> 1.7.1\u3001\u8BBE\u8BA1key\u7684\u7ED3\u6784</h4><p>\u9996\u5148\u6211\u4EEC\u8981\u601D\u8003\u4E00\u4E0B\u5229\u7528redis\u6765\u5B58\u50A8\u6570\u636E\uFF0C\u90A3\u4E48\u5230\u5E95\u4F7F\u7528\u54EA\u79CD\u7ED3\u6784\u5462\uFF1F\u7531\u4E8E\u5B58\u5165\u7684\u6570\u636E\u6BD4\u8F83\u7B80\u5355\uFF0C\u6211\u4EEC\u53EF\u4EE5\u8003\u8651\u4F7F\u7528String\uFF0C\u6216\u8005\u662F\u4F7F\u7528\u54C8\u5E0C\uFF0C\u5982\u4E0B\u56FE\uFF0C\u5982\u679C\u4F7F\u7528String\uFF0C\u540C\u5B66\u4EEC\u6CE8\u610F\u4ED6\u7684value\uFF0C\u7528\u591A\u5360\u7528\u4E00\u70B9\u7A7A\u95F4\uFF0C\u5982\u679C\u4F7F\u7528\u54C8\u5E0C\uFF0C\u5219\u4ED6\u7684value\u4E2D\u53EA\u4F1A\u5B58\u50A8\u4ED6\u6570\u636E\u672C\u8EAB\uFF0C\u5982\u679C\u4E0D\u662F\u7279\u522B\u5728\u610F\u5185\u5B58\uFF0C\u5176\u5B9E\u4F7F\u7528String\u5C31\u53EF\u4EE5\u5566\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653319261433.png" alt="1653319261433"></p><h4 id="_1-7-2\u3001\u8BBE\u8BA1key\u7684\u5177\u4F53\u7EC6\u8282" tabindex="-1"><a class="header-anchor" href="#_1-7-2\u3001\u8BBE\u8BA1key\u7684\u5177\u4F53\u7EC6\u8282" aria-hidden="true">#</a> 1.7.2\u3001\u8BBE\u8BA1key\u7684\u5177\u4F53\u7EC6\u8282</h4><p>\u6240\u4EE5\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528String\u7ED3\u6784\uFF0C\u5C31\u662F\u4E00\u4E2A\u7B80\u5355\u7684key\uFF0Cvalue\u952E\u503C\u5BF9\u7684\u65B9\u5F0F\uFF0C\u4F46\u662F\u5173\u4E8Ekey\u7684\u5904\u7406\uFF0Csession\u4ED6\u662F\u6BCF\u4E2A\u7528\u6237\u90FD\u6709\u81EA\u5DF1\u7684session\uFF0C\u4F46\u662Fredis\u7684key\u662F\u5171\u4EAB\u7684\uFF0C\u54B1\u4EEC\u5C31\u4E0D\u80FD\u4F7F\u7528code\u4E86</p><p>\u5728\u8BBE\u8BA1\u8FD9\u4E2Akey\u7684\u65F6\u5019\uFF0C\u6211\u4EEC\u4E4B\u524D\u8BB2\u8FC7\u9700\u8981\u6EE1\u8DB3\u4E24\u70B9</p><p><code>1\u3001key\u8981\u5177\u6709\u552F\u4E00\u6027</code></p><p><code>2\u3001key\u8981\u65B9\u4FBF\u643A\u5E26</code></p><p>\u5982\u679C\u6211\u4EEC\u91C7\u7528phone\uFF1A\u624B\u673A\u53F7\u8FD9\u4E2A\u7684\u6570\u636E\u6765\u5B58\u50A8\u5F53\u7136\u662F\u53EF\u4EE5\u7684\uFF0C\u4F46\u662F\u5982\u679C\u628A\u8FD9\u6837\u7684\u654F\u611F\u6570\u636E\u5B58\u50A8\u5230redis\u4E2D\u5E76\u4E14\u4ECE\u9875\u9762\u4E2D\u5E26\u8FC7\u6765\u6BD5\u7ADF\u4E0D\u592A\u5408\u9002\uFF0C\u6240\u4EE5\u6211\u4EEC\u5728\u540E\u53F0\u751F\u6210\u4E00\u4E2A\u968F\u673A\u4E32token\uFF0C\u7136\u540E\u8BA9\u524D\u7AEF\u5E26\u6765\u8FD9\u4E2Atoken\u5C31\u80FD\u5B8C\u6210\u6211\u4EEC\u7684\u6574\u4F53\u903B\u8F91\u4E86</p><h4 id="_1-7-3\u3001\u6574\u4F53\u8BBF\u95EE\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_1-7-3\u3001\u6574\u4F53\u8BBF\u95EE\u6D41\u7A0B" aria-hidden="true">#</a> 1.7.3\u3001\u6574\u4F53\u8BBF\u95EE\u6D41\u7A0B</h4><p>\u5F53\u6CE8\u518C\u5B8C\u6210\u540E\uFF0C\u7528\u6237\u53BB\u767B\u5F55\u4F1A\u53BB\u6821\u9A8C\u7528\u6237\u63D0\u4EA4\u7684\u624B\u673A\u53F7\u548C\u9A8C\u8BC1\u7801\uFF0C\u662F\u5426\u4E00\u81F4\uFF0C\u5982\u679C\u4E00\u81F4\uFF0C\u5219\u6839\u636E\u624B\u673A\u53F7\u67E5\u8BE2\u7528\u6237\u4FE1\u606F\uFF0C\u4E0D\u5B58\u5728\u5219\u65B0\u5EFA\uFF0C\u6700\u540E\u5C06\u7528\u6237\u6570\u636E\u4FDD\u5B58\u5230redis\uFF0C\u5E76\u4E14\u751F\u6210token\u4F5C\u4E3Aredis\u7684key\uFF0C\u5F53\u6211\u4EEC\u6821\u9A8C\u7528\u6237\u662F\u5426\u767B\u5F55\u65F6\uFF0C\u4F1A\u53BB\u643A\u5E26\u7740token\u8FDB\u884C\u8BBF\u95EE\uFF0C\u4ECEredis\u4E2D\u53D6\u51FAtoken\u5BF9\u5E94\u7684value\uFF0C\u5224\u65AD\u662F\u5426\u5B58\u5728\u8FD9\u4E2A\u6570\u636E\uFF0C\u5982\u679C\u6CA1\u6709\u5219\u62E6\u622A\uFF0C\u5982\u679C\u5B58\u5728\u5219\u5C06\u5176\u4FDD\u5B58\u5230threadLocal\u4E2D\uFF0C\u5E76\u4E14\u653E\u884C\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653319474181.png" alt="1653319474181"></p><h3 id="_1-8\u3001\u57FA\u4E8Eredis\u5B9E\u73B0\u77ED\u4FE1\u767B\u5F55" tabindex="-1"><a class="header-anchor" href="#_1-8\u3001\u57FA\u4E8Eredis\u5B9E\u73B0\u77ED\u4FE1\u767B\u5F55" aria-hidden="true">#</a> 1.8\u3001\u57FA\u4E8ERedis\u5B9E\u73B0\u77ED\u4FE1\u767B\u5F55</h3><p>\u8FD9\u91CC\u5177\u4F53\u903B\u8F91\u5C31\u4E0D\u5206\u6790\u4E86\uFF0C\u4E4B\u524D\u54B1\u4EEC\u5DF2\u7ECF\u91CD\u70B9\u5206\u6790\u8FC7\u8FD9\u4E2A\u903B\u8F91\u5566\u3002</p><blockquote><p>\u751F\u6210\u9A8C\u8BC1\u7801</p></blockquote><p>1.\u6821\u9A8C\u624B\u673A\u53F7\u662F\u5426\u6B63\u786E</p><p>\u200B 1.1 \u9519\u8BEF\u5219\u8FD4\u56DE\u9519\u8BEF\u4FE1\u606F</p><p>2.\u751F\u6210\u9A8C\u8BC1\u7801</p><p>3.\u5C06\u9A8C\u8BC1\u7801\u4FDD\u5B58\u5230 redis \u4E2D\uFF0C key \u7684\u8BBE\u8BA1 <code>login:code: + phone</code>\uFF0C\u5E76\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\u4E3A 2\u5206\u949F</p><p>4.\u53D1\u9001\u9A8C\u8BC1\u7801</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u6821\u9A8C\u624B\u673A\u53F7\u662F\u5426\u6B63\u786E</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.1 \u9519\u8BEF\u5219\u8FD4\u56DE\u9519\u8BEF\u4FE1\u606F</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u624B\u673A\u683C\u5F0F\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.\u751F\u6210\u9A8C\u8BC1\u7801</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomNumbers</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.\u5C06\u9A8C\u8BC1\u7801\u4FDD\u5B58\u5230 redis \u4E2D\uFF0C\u5E76\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\u4E3A 2\u5206\u949F</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_CODE_KEY <span class="token operator">+</span> phone<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_CODE_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u53D1\u9001\u9A8C\u8BC1\u7801</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;\u77ED\u4FE1\u9A8C\u8BC1\u7801\u4E3A\uFF1A{}&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u767B\u5F55</p></blockquote><p>1.\u6821\u9A8C\u624B\u673A\u53F7</p><p>2.\u6821\u9A8C\u9A8C\u8BC1\u7801\uFF0C \u4ECE redis \u4E2D\u53D6\u51FA\u9A8C\u8BC1\u7801</p><p>3.\u6839\u636E\u624B\u673A\u53F7\u67E5\u8BE2\u7528\u6237</p><p>4.\u82E5\u4E0D\u5B58\u5728\uFF0C\u63D2\u5165\u65B0\u7528\u6237</p><p>5.\u5C06 \u7528\u6237\u4FE1\u606F \u4FDD\u5B58\u5230 redis \u4E2D\uFF0Ckey <code>login:user: + token</code>\uFF0C\u8BBE\u7F6E\u8FC7\u671F\u8FC7\u671F\u65F6\u95F4\u4E3A 30\u5206\u949F</p><p>6.\u8FD4\u56DEtoken</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * \u767B\u5F55\u529F\u80FD
     * <span class="token keyword">@param</span> <span class="token parameter">loginForm</span> \u767B\u5F55\u53C2\u6570\uFF0C\u5305\u542B\u624B\u673A\u53F7\u3001\u9A8C\u8BC1\u7801\uFF1B\u6216\u8005\u624B\u673A\u53F7\u3001\u5BC6\u7801
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginFormDTO</span> loginForm<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u6821\u9A8C\u624B\u673A\u53F7</span>
        <span class="token class-name">String</span> phone <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.1 \u9519\u8BEF\u5219\u8FD4\u56DE\u9519\u8BEF\u4FE1\u606F</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u624B\u673A\u683C\u5F0F\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.\u6821\u9A8C\u9A8C\u8BC1\u7801</span>
        <span class="token class-name">String</span> cacheCode <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>LOGIN_CODE_KEY <span class="token operator">+</span> phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheCode <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>cacheCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u9A8C\u8BC1\u7801\u4E0D\u4E00\u81F4\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u6839\u636E\u624B\u673A\u53F7\u67E5\u8BE2\u7528\u6237</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u82E5\u4E0D\u5B58\u5728\uFF0C\u63D2\u5165\u65B0\u7528\u6237</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span>USER_NICK_NAME_PREFIX <span class="token operator">+</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5.\u5C06 \u7528\u6237\u4FE1\u606F \u4FDD\u5B58\u5230 redis \u4E2D\uFF0C\u8BBE\u7F6E\u8FC7\u671F\u8FC7\u671F\u65F6\u95F4\u4E3A 30\u5206\u949F</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">beanToMap</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CopyOptions</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIgnoreNullValue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token comment">// \u5C06 \u503C \u8F6C\u4E3A String \u7C7B\u578B</span>
                <span class="token punctuation">.</span><span class="token function">setFieldValueEditor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u8FD4\u56DE token</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u62E6\u622A</p></blockquote><p>0.\u4ECE request \u4E2D \u83B7\u53D6 token</p><p>1.\u4ECE redis \u4E2D\u83B7\u53D6\u7528\u6237\u4FE1\u606F</p><p>2.\u5224\u65AD\u7528\u6237\u662F\u5426\u5B58\u5728</p><p>\u200B 2.1\u4E0D\u5B58\u5728\u5219\u62E6\u622A</p><p>3.\u628A\u7528\u6237\u4FE1\u606F\u653E\u5728 ThreadLocal\uFF08<code>\u7EBF\u7A0B\u9694\u79BB</code>\uFF09 \u4E2D\uFF0C\u653E\u884C</p><p>4.\u5237\u65B0\u7528\u6237\u4FE1\u606F\u8FC7\u671F\u65F6\u95F4</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u56E0\u4E3A\u8FD9\u4E2A\u7C7B\u6CA1\u6709\u4EA4\u7ED9 Spring \u7BA1\u7406
     * <span class="token keyword">@param</span> <span class="token parameter">redisTemplate</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u4ECE request \u5934\u4E2D\u83B7\u53D6token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.\u4ECE redis \u4E2D\u83B7\u53D6\u7528\u6237\u4FE1\u606F</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5224\u65AD\u7528\u6237\u662F\u5426\u5B58\u5728</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.1 \u4E0D\u5B58\u5728\u5219\u62E6\u622A</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u628A\u7528\u6237\u4FE1\u606F\u653E\u5728 ThreadLocal \u4E2D\uFF0C\u653E\u884C</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u5237\u65B0\u7528\u6237\u4FE1\u606F\u8FC7\u671F\u65F6\u95F4</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u653E\u884C </span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u79FB\u9664\u7528\u6237\uFF0C\u907F\u514D\u4FE1\u606F\u6CC4\u9732</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>RedisConstants</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConstants</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOGIN_CODE_KEY <span class="token operator">=</span> <span class="token string">&quot;login:code:&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> LOGIN_CODE_TTL <span class="token operator">=</span> <span class="token number">2L</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOGIN_USER_KEY <span class="token operator">=</span> <span class="token string">&quot;login:user:&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> LOGIN_USER_TTL <span class="token operator">=</span> <span class="token number">30L</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-9\u3001\u89E3\u51B3\u72B6\u6001\u767B\u5F55\u5237\u65B0\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_1-9\u3001\u89E3\u51B3\u72B6\u6001\u767B\u5F55\u5237\u65B0\u95EE\u9898" aria-hidden="true">#</a> 1.9\u3001\u89E3\u51B3\u72B6\u6001\u767B\u5F55\u5237\u65B0\u95EE\u9898</h3><h4 id="_1-9-1-\u521D\u59CB\u65B9\u6848\u601D\u8DEF\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#_1-9-1-\u521D\u59CB\u65B9\u6848\u601D\u8DEF\u603B\u7ED3" aria-hidden="true">#</a> 1.9.1 \u521D\u59CB\u65B9\u6848\u601D\u8DEF\u603B\u7ED3\uFF1A</h4><p>\u5728\u8FD9\u4E2A\u65B9\u6848\u4E2D\uFF0C\u4ED6\u786E\u5B9E\u53EF\u4EE5\u4F7F\u7528\u5BF9\u5E94\u8DEF\u5F84\u7684\u62E6\u622A\uFF0C\u540C\u65F6\u5237\u65B0\u767B\u5F55token\u4EE4\u724C\u7684\u5B58\u6D3B\u65F6\u95F4\uFF0C\u4F46\u662F\u73B0\u5728\u8FD9\u4E2A\u62E6\u622A\u5668\u4ED6\u53EA\u662F\u62E6\u622A\u9700\u8981\u88AB\u62E6\u622A\u7684\u8DEF\u5F84\uFF0C\u5047\u8BBE\u5F53\u524D\u7528\u6237\u8BBF\u95EE\u4E86\u4E00\u4E9B\u4E0D\u9700\u8981\u62E6\u622A\u7684\u8DEF\u5F84\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u62E6\u622A\u5668\u5C31\u4E0D\u4F1A\u751F\u6548\uFF0C\u6240\u4EE5\u6B64\u65F6\u4EE4\u724C\u5237\u65B0\u7684\u52A8\u4F5C\u5B9E\u9645\u4E0A\u5C31\u4E0D\u4F1A\u6267\u884C\uFF0C\u6240\u4EE5\u8FD9\u4E2A\u65B9\u6848\u4ED6\u662F\u5B58\u5728\u95EE\u9898\u7684</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653320822964.png" alt="1653320822964"></p><h4 id="_1-9-2-\u4F18\u5316\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#_1-9-2-\u4F18\u5316\u65B9\u6848" aria-hidden="true">#</a> 1.9.2 \u4F18\u5316\u65B9\u6848</h4><p>\u65E2\u7136\u4E4B\u524D\u7684\u62E6\u622A\u5668\u65E0\u6CD5\u5BF9\u4E0D\u9700\u8981\u62E6\u622A\u7684\u8DEF\u5F84\u751F\u6548\uFF0C\u90A3\u4E48\u6211\u4EEC\u53EF\u4EE5\u6DFB\u52A0\u4E00\u4E2A\u62E6\u622A\u5668\uFF0C\u5728\u7B2C\u4E00\u4E2A\u62E6\u622A\u5668\u4E2D\u62E6\u622A\u6240\u6709\u7684\u8DEF\u5F84\uFF0C\u628A\u7B2C\u4E8C\u4E2A\u62E6\u622A\u5668\u505A\u7684\u4E8B\u60C5\u653E\u5165\u5230\u7B2C\u4E00\u4E2A\u62E6\u622A\u5668\u4E2D\uFF0C\u540C\u65F6\u5237\u65B0\u4EE4\u724C\uFF0C\u56E0\u4E3A\u7B2C\u4E00\u4E2A\u62E6\u622A\u5668\u6709\u4E86threadLocal\u7684\u6570\u636E\uFF0C\u6240\u4EE5\u6B64\u65F6\u7B2C\u4E8C\u4E2A\u62E6\u622A\u5668\u53EA\u9700\u8981\u5224\u65AD\u62E6\u622A\u5668\u4E2D\u7684user\u5BF9\u8C61\u662F\u5426\u5B58\u5728\u5373\u53EF\uFF0C\u5B8C\u6210\u6574\u4F53\u5237\u65B0\u529F\u80FD\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653320764547.png" alt="1653320764547"></p><h4 id="_1-9-3-\u4EE3\u7801" tabindex="-1"><a class="header-anchor" href="#_1-9-3-\u4EE3\u7801" aria-hidden="true">#</a> 1.9.3 \u4EE3\u7801</h4><p><strong>RefreshTokenInterceptor</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefreshTokenInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RefreshTokenInterceptor</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u83B7\u53D6\u8BF7\u6C42\u5934\u4E2D\u7684token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.\u57FA\u4E8ETOKEN\u83B7\u53D6redis\u4E2D\u7684\u7528\u6237</span>
        <span class="token class-name">String</span> key  <span class="token operator">=</span> LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userMap <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.\u5224\u65AD\u7528\u6237\u662F\u5426\u5B58\u5728</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5.\u5C06\u67E5\u8BE2\u5230\u7684hash\u6570\u636E\u8F6C\u4E3AUserDTO</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>userMap<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.\u5B58\u5728\uFF0C\u4FDD\u5B58\u7528\u6237\u4FE1\u606F\u5230 ThreadLocal</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7.\u5237\u65B0token\u6709\u6548\u671F</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> LOGIN_USER_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 8.\u653E\u884C</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u79FB\u9664\u7528\u6237</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>LoginInterceptor</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u5224\u65AD\u662F\u5426\u9700\u8981\u62E6\u622A\uFF08ThreadLocal\u4E2D\u662F\u5426\u6709\u7528\u6237\uFF09</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u6CA1\u6709\uFF0C\u9700\u8981\u62E6\u622A\uFF0C\u8BBE\u7F6E\u72B6\u6001\u7801</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u62E6\u622A</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u6709\u7528\u6237\uFF0C\u5219\u653E\u884C</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MvcConfig \u52A0\u5165\u62E6\u622A\u5668\u5E76\u8BBE\u7F6E\u4F18\u5148\u7EA7</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * \u8BA9\u62E6\u622A\u5668\u751F\u6548
 * <span class="token keyword">@author</span> hzz
 * <span class="token keyword">@create</span> 2022-07-26 0:05
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span>
                <span class="token string">&quot;/shop/**&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/voucher/**&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/shop-type/**&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/upload/**&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/blog/hot&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/user/code&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;/user/login&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// order \u8D8A\u5C0F\uFF0C\u4F18\u5148\u7EA7\u8D8A\u9AD8</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RefreshTokenInterceptor</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2\u3001\u5546\u6237\u67E5\u8BE2\u7F13\u5B58" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u5546\u6237\u67E5\u8BE2\u7F13\u5B58" aria-hidden="true">#</a> 2\u3001\u5546\u6237\u67E5\u8BE2\u7F13\u5B58</h2><h3 id="_2-1-\u4EC0\u4E48\u662F\u7F13\u5B58" tabindex="-1"><a class="header-anchor" href="#_2-1-\u4EC0\u4E48\u662F\u7F13\u5B58" aria-hidden="true">#</a> 2.1 \u4EC0\u4E48\u662F\u7F13\u5B58?</h3><p><strong>\u524D\u8A00</strong>:<strong>\u4EC0\u4E48\u662F\u7F13\u5B58?</strong></p><p>\u5C31\u50CF\u81EA\u884C\u8F66,\u8D8A\u91CE\u8F66\u7684\u907F\u9707\u5668</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/\u907F\u9707\u5668.gif" alt=""></p><p>\u4E3E\u4E2A\u4F8B\u5B50:\u8D8A\u91CE\u8F66,\u5C71\u5730\u81EA\u884C\u8F66,\u90FD\u62E5\u6709&quot;\u907F\u9707\u5668&quot;,<strong>\u9632\u6B62</strong>\u8F66\u4F53\u52A0\u901F\u540E\u56E0\u60EF\u6027,\u5728\u9177\u4F3C&quot;U&quot;\u5B57\u6BCD\u7684\u5730\u5F62\u4E0A\u98DE\u8DC3,\u786C\u7740\u9646\u5BFC\u81F4\u7684<strong>\u635F\u5BB3</strong>,\u50CF\u4E2A\u5F39\u7C27\u4E00\u6837;</p><p>\u540C\u6837,\u5B9E\u9645\u5F00\u53D1\u4E2D,\u7CFB\u7EDF\u4E5F\u9700\u8981&quot;\u907F\u9707\u5668&quot;,\u9632\u6B62\u8FC7\u9AD8\u7684\u6570\u636E\u8BBF\u95EE\u731B\u51B2\u7CFB\u7EDF,\u5BFC\u81F4\u5176\u64CD\u4F5C\u7EBF\u7A0B\u65E0\u6CD5\u53CA\u65F6\u5904\u7406\u4FE1\u606F\u800C\u762B\u75EA;</p><p>\u8FD9\u5728\u5B9E\u9645\u5F00\u53D1\u4E2D\u5BF9\u4F01\u4E1A\u8BB2,\u5BF9\u4EA7\u54C1\u53E3\u7891,\u7528\u6237\u8BC4\u4EF7\u90FD\u662F\u81F4\u547D\u7684;\u6240\u4EE5\u4F01\u4E1A\u975E\u5E38\u91CD\u89C6\u7F13\u5B58\u6280\u672F;</p><p><strong>\u7F13\u5B58(<strong>Cache),\u5C31\u662F\u6570\u636E\u4EA4\u6362\u7684</strong>\u7F13\u51B2\u533A</strong>,\u4FD7\u79F0\u7684\u7F13\u5B58\u5C31\u662F<strong>\u7F13\u51B2\u533A\u5185\u7684\u6570\u636E</strong>,\u4E00\u822C\u4ECE\u6570\u636E\u5E93\u4E2D\u83B7\u53D6,\u5B58\u50A8\u4E8E\u672C\u5730\u4EE3\u7801(\u4F8B\u5982:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\u4F8B<span class="token number">1</span><span class="token operator">:</span><span class="token class-name">Static</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \u672C\u5730\u7528\u4E8E\u9AD8\u5E76\u53D1

\u4F8B<span class="token number">2</span><span class="token operator">:</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> USER_CACHE <span class="token operator">=</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \u7528\u4E8Eredis\u7B49\u7F13\u5B58

\u4F8B<span class="token number">3</span><span class="token operator">:</span><span class="token class-name">Static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \u672C\u5730\u7F13\u5B58
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7531\u4E8E\u5176\u88AB<strong>Static</strong>\u4FEE\u9970,\u6240\u4EE5\u968F\u7740\u7C7B\u7684\u52A0\u8F7D\u800C\u88AB\u52A0\u8F7D\u5230<strong>\u5185\u5B58\u4E4B\u4E2D</strong>,\u4F5C\u4E3A\u672C\u5730\u7F13\u5B58,\u7531\u4E8E\u5176\u53C8\u88AB<strong>final</strong>\u4FEE\u9970,\u6240\u4EE5\u5176\u5F15\u7528(\u4F8B3:map)\u548C\u5BF9\u8C61(\u4F8B3:new HashMap())\u4E4B\u95F4\u7684\u5173\u7CFB\u662F\u56FA\u5B9A\u7684,\u4E0D\u80FD\u6539\u53D8,\u56E0\u6B64\u4E0D\u7528\u62C5\u5FC3\u8D4B\u503C(=)\u5BFC\u81F4\u7F13\u5B58\u5931\u6548;</p><h4 id="_2-1-1-\u4E3A\u4EC0\u4E48\u8981\u4F7F\u7528\u7F13\u5B58" tabindex="-1"><a class="header-anchor" href="#_2-1-1-\u4E3A\u4EC0\u4E48\u8981\u4F7F\u7528\u7F13\u5B58" aria-hidden="true">#</a> 2.1.1 \u4E3A\u4EC0\u4E48\u8981\u4F7F\u7528\u7F13\u5B58</h4><p>\u4E00\u53E5\u8BDD:\u56E0\u4E3A<strong>\u901F\u5EA6\u5FEB,\u597D\u7528</strong></p><p>\u7F13\u5B58\u6570\u636E\u5B58\u50A8\u4E8E\u4EE3\u7801\u4E2D,\u800C\u4EE3\u7801\u8FD0\u884C\u5728\u5185\u5B58\u4E2D,\u5185\u5B58\u7684\u8BFB\u5199\u6027\u80FD\u8FDC\u9AD8\u4E8E\u78C1\u76D8,\u7F13\u5B58\u53EF\u4EE5\u5927\u5927\u964D\u4F4E<strong>\u7528\u6237\u8BBF\u95EE\u5E76\u53D1\u91CF\u5E26\u6765\u7684</strong>\u670D\u52A1\u5668\u8BFB\u5199\u538B\u529B</p><p>\u5B9E\u9645\u5F00\u53D1\u8FC7\u7A0B\u4E2D,\u4F01\u4E1A\u7684\u6570\u636E\u91CF,\u5C11\u5219\u51E0\u5341\u4E07,\u591A\u5219\u51E0\u5343\u4E07,\u8FD9\u4E48\u5927\u6570\u636E\u91CF,\u5982\u679C\u6CA1\u6709\u7F13\u5B58\u6765\u4F5C\u4E3A&quot;\u907F\u9707\u5668&quot;,\u7CFB\u7EDF\u662F\u51E0\u4E4E\u6491\u4E0D\u4F4F\u7684,\u6240\u4EE5\u4F01\u4E1A\u4F1A\u5927\u91CF\u8FD0\u7528\u5230\u7F13\u5B58\u6280\u672F;</p><p>\u4F46\u662F\u7F13\u5B58\u4E5F\u4F1A\u589E\u52A0\u4EE3\u7801\u590D\u6742\u5EA6\u548C\u8FD0\u8425\u7684\u6210\u672C:</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220523214414123.png" alt=""></p><h4 id="_2-1-2-\u5982\u4F55\u4F7F\u7528\u7F13\u5B58" tabindex="-1"><a class="header-anchor" href="#_2-1-2-\u5982\u4F55\u4F7F\u7528\u7F13\u5B58" aria-hidden="true">#</a> 2.1.2 \u5982\u4F55\u4F7F\u7528\u7F13\u5B58</h4><p>\u5B9E\u9645\u5F00\u53D1\u4E2D,\u4F1A\u6784\u7B51\u591A\u7EA7\u7F13\u5B58\u6765\u4F7F\u7CFB\u7EDF\u8FD0\u884C\u901F\u5EA6\u8FDB\u4E00\u6B65\u63D0\u5347,\u4F8B\u5982:\u672C\u5730\u7F13\u5B58\u4E0Eredis\u4E2D\u7684\u7F13\u5B58\u5E76\u53D1\u4F7F\u7528</p><p><strong>\u6D4F\u89C8\u5668\u7F13\u5B58</strong>\uFF1A\u4E3B\u8981\u662F\u5B58\u5728\u4E8E\u6D4F\u89C8\u5668\u7AEF\u7684\u7F13\u5B58</p><p><strong>\u5E94\u7528\u5C42\u7F13\u5B58</strong>\uFF1A\u53EF\u4EE5\u5206\u4E3Atomcat\u672C\u5730\u7F13\u5B58\uFF0C\u6BD4\u5982\u4E4B\u524D\u63D0\u5230\u7684map\uFF0C\u6216\u8005\u662F\u4F7F\u7528redis\u4F5C\u4E3A\u7F13\u5B58</p><p><strong>\u6570\u636E\u5E93\u7F13\u5B58</strong>\uFF1A\u5728\u6570\u636E\u5E93\u4E2D\u6709\u4E00\u7247\u7A7A\u95F4\u662F buffer pool\uFF0C\u589E\u6539\u67E5\u6570\u636E\u90FD\u4F1A\u5148\u52A0\u8F7D\u5230mysql\u7684\u7F13\u5B58\u4E2D</p><p><strong>CPU\u7F13\u5B58</strong>\uFF1A\u5F53\u4EE3\u8BA1\u7B97\u673A\u6700\u5927\u7684\u95EE\u9898\u662F cpu\u6027\u80FD\u63D0\u5347\u4E86\uFF0C\u4F46\u5185\u5B58\u8BFB\u5199\u901F\u5EA6\u6CA1\u6709\u8DDF\u4E0A\uFF0C\u6240\u4EE5\u4E3A\u4E86\u9002\u5E94\u5F53\u4E0B\u7684\u60C5\u51B5\uFF0C\u589E\u52A0\u4E86cpu\u7684L1\uFF0CL2\uFF0CL3\u7EA7\u7684\u7F13\u5B58</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220523212915666.png" alt=""></p><h3 id="_2-2-\u6DFB\u52A0\u5546\u6237\u7F13\u5B58" tabindex="-1"><a class="header-anchor" href="#_2-2-\u6DFB\u52A0\u5546\u6237\u7F13\u5B58" aria-hidden="true">#</a> 2.2 \u6DFB\u52A0\u5546\u6237\u7F13\u5B58</h3><blockquote><p>1.\u5224\u65AD redis \u662F\u5426\u6709 \u5546\u6237\u7F13\u5B58</p><p>\u200B 1.1 \u5B58\u5728\u5219\u76F4\u63A5\u8FD4\u56DE</p><p>2.\u4ECE\u6570\u636E\u5E93\u4E2D\u67E5\u51FA\u5546\u6237\u4FE1\u606F</p><p>\u200B 2.1 \u4E0D\u5B58\u5728\u62A5\u9519</p><p>3.\u5C06\u5546\u6237\u4FE1\u606F\u4FDD\u5B58\u5728 redis \u4E2D <code>cache_shop: + id</code></p><p>4.\u8FD4\u56DE\u5546\u54C1\u4FE1\u606F</p></blockquote><p>\u5728\u6211\u4EEC\u67E5\u8BE2\u5546\u6237\u4FE1\u606F\u65F6\uFF0C\u6211\u4EEC\u662F\u76F4\u63A5\u64CD\u4F5C\u4ECE\u6570\u636E\u5E93\u4E2D\u53BB\u8FDB\u884C\u67E5\u8BE2\u7684\uFF0C\u5927\u81F4\u903B\u8F91\u662F\u8FD9\u6837\uFF0C\u76F4\u63A5\u67E5\u8BE2\u6570\u636E\u5E93\u90A3\u80AF\u5B9A\u6162\u54AF\uFF0C\u6240\u4EE5\u6211\u4EEC\u9700\u8981\u589E\u52A0\u7F13\u5B58</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryShopById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//\u8FD9\u91CC\u662F\u76F4\u63A5\u67E5\u8BE2\u6570\u636E\u5E93</span>
    <span class="token keyword">return</span> shopService<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-1-\u3001\u7F13\u5B58\u6A21\u578B\u548C\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#_2-2-1-\u3001\u7F13\u5B58\u6A21\u578B\u548C\u601D\u8DEF" aria-hidden="true">#</a> 2.2.1 \u3001\u7F13\u5B58\u6A21\u578B\u548C\u601D\u8DEF</h4><p>\u6807\u51C6\u7684\u64CD\u4F5C\u65B9\u5F0F\u5C31\u662F\u67E5\u8BE2\u6570\u636E\u5E93\u4E4B\u524D\u5148\u67E5\u8BE2\u7F13\u5B58\uFF0C\u5982\u679C\u7F13\u5B58\u6570\u636E\u5B58\u5728\uFF0C\u5219\u76F4\u63A5\u4ECE\u7F13\u5B58\u4E2D\u8FD4\u56DE\uFF0C\u5982\u679C\u7F13\u5B58\u6570\u636E\u4E0D\u5B58\u5728\uFF0C\u518D\u67E5\u8BE2\u6570\u636E\u5E93\uFF0C\u7136\u540E\u5C06\u6570\u636E\u5B58\u5165redis\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653322097736.png" alt="1653322097736"></p><h4 id="_2-1-2\u3001\u4EE3\u7801\u5982\u4E0B" tabindex="-1"><a class="header-anchor" href="#_2-1-2\u3001\u4EE3\u7801\u5982\u4E0B" aria-hidden="true">#</a> 2.1.2\u3001\u4EE3\u7801\u5982\u4E0B</h4><p>\u4EE3\u7801\u601D\u8DEF\uFF1A\u5982\u679C\u7F13\u5B58\u6709\uFF0C\u5219\u76F4\u63A5\u8FD4\u56DE\uFF0C\u5982\u679C\u7F13\u5B58\u4E0D\u5B58\u5728\uFF0C\u5219\u67E5\u8BE2\u6570\u636E\u5E93\uFF0C\u7136\u540E\u5B58\u5165redis\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * \u6839\u636Eid\u67E5\u8BE2\u5546\u94FA\u4FE1\u606F
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> \u5546\u94FAid
     * <span class="token keyword">@return</span> \u5546\u94FA\u8BE6\u60C5\u6570\u636E
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u5224\u65AD redis \u662F\u5426\u6709 \u5546\u6237\u7F13\u5B58</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.1 \u5B58\u5728\u5219\u76F4\u63A5\u8FD4\u56DE</span>
            <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.\u4ECE\u6570\u636E\u5E93\u4E2D\u67E5\u51FA\u5546\u6237\u4FE1\u606F</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.1 \u4E0D\u5B58\u5728\u62A5\u9519</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5546\u54C1\u4FE1\u606F\u4E0D\u5B58\u5728&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u5C06\u5546\u6237\u4FE1\u606F\u4FDD\u5B58\u5728 redis \u4E2D \`cache:shop: + id\`</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u8FD4\u56DE\u5546\u54C1\u4FE1\u606F</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-\u7F13\u5B58\u66F4\u65B0\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_2-3-\u7F13\u5B58\u66F4\u65B0\u7B56\u7565" aria-hidden="true">#</a> 2.3 \u7F13\u5B58\u66F4\u65B0\u7B56\u7565</h3><p>\u7F13\u5B58\u66F4\u65B0\u662Fredis\u4E3A\u4E86\u8282\u7EA6\u5185\u5B58\u800C\u8BBE\u8BA1\u51FA\u6765\u7684\u4E00\u4E2A\u4E1C\u897F\uFF0C\u4E3B\u8981\u662F\u56E0\u4E3A\u5185\u5B58\u6570\u636E\u5B9D\u8D35\uFF0C\u5F53\u6211\u4EEC\u5411redis\u63D2\u5165\u592A\u591A\u6570\u636E\uFF0C\u6B64\u65F6\u5C31\u53EF\u80FD\u4F1A\u5BFC\u81F4\u7F13\u5B58\u4E2D\u7684\u6570\u636E\u8FC7\u591A\uFF0C\u6240\u4EE5redis\u4F1A\u5BF9\u90E8\u5206\u6570\u636E\u8FDB\u884C\u66F4\u65B0\uFF0C\u6216\u8005\u628A\u4ED6\u53EB\u4E3A\u6DD8\u6C70\u66F4\u5408\u9002\u3002</p><p><strong>\u5185\u5B58\u6DD8\u6C70</strong>\uFF1Aredis\u81EA\u52A8\u8FDB\u884C\uFF0C\u5F53redis\u5185\u5B58\u8FBE\u5230\u54B1\u4EEC\u8BBE\u5B9A\u7684max-memery\u7684\u65F6\u5019\uFF0C\u4F1A\u81EA\u52A8\u89E6\u53D1\u6DD8\u6C70\u673A\u5236\uFF0C\u6DD8\u6C70\u6389\u4E00\u4E9B\u4E0D\u91CD\u8981\u7684\u6570\u636E(\u53EF\u4EE5\u81EA\u5DF1\u8BBE\u7F6E\u7B56\u7565\u65B9\u5F0F)</p><p><strong>\u8D85\u65F6\u5254\u9664</strong>\uFF1A\u5F53\u6211\u4EEC\u7ED9redis\u8BBE\u7F6E\u4E86\u8FC7\u671F\u65F6\u95F4ttl\u4E4B\u540E\uFF0Credis\u4F1A\u5C06\u8D85\u65F6\u7684\u6570\u636E\u8FDB\u884C\u5220\u9664\uFF0C\u65B9\u4FBF\u54B1\u4EEC\u7EE7\u7EED\u4F7F\u7528\u7F13\u5B58</p><p><strong>\u4E3B\u52A8\u66F4\u65B0</strong>\uFF1A\u6211\u4EEC\u53EF\u4EE5\u624B\u52A8\u8C03\u7528\u65B9\u6CD5\u628A\u7F13\u5B58\u5220\u6389\uFF0C\u901A\u5E38\u7528\u4E8E\u89E3\u51B3\u7F13\u5B58\u548C\u6570\u636E\u5E93\u4E0D\u4E00\u81F4\u95EE\u9898</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653322506393.png" alt="1653322506393"></p><h4 id="_2-3-1-\u3001\u6570\u636E\u5E93\u7F13\u5B58\u4E0D\u4E00\u81F4\u89E3\u51B3\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#_2-3-1-\u3001\u6570\u636E\u5E93\u7F13\u5B58\u4E0D\u4E00\u81F4\u89E3\u51B3\u65B9\u6848" aria-hidden="true">#</a> 2.3.1 \u3001\u6570\u636E\u5E93\u7F13\u5B58\u4E0D\u4E00\u81F4\u89E3\u51B3\u65B9\u6848\uFF1A</h4><p>\u7531\u4E8E\u6211\u4EEC\u7684<strong>\u7F13\u5B58\u7684\u6570\u636E\u6E90\u6765\u81EA\u4E8E\u6570\u636E\u5E93</strong>,\u800C\u6570\u636E\u5E93\u7684<strong>\u6570\u636E\u662F\u4F1A\u53D1\u751F\u53D8\u5316\u7684</strong>,\u56E0\u6B64,\u5982\u679C\u5F53\u6570\u636E\u5E93\u4E2D<strong>\u6570\u636E\u53D1\u751F\u53D8\u5316,\u800C\u7F13\u5B58\u5374\u6CA1\u6709\u540C\u6B65</strong>,\u6B64\u65F6\u5C31\u4F1A\u6709<strong>\u4E00\u81F4\u6027\u95EE\u9898\u5B58\u5728</strong>,\u5176\u540E\u679C\u662F:</p><p>\u7528\u6237\u4F7F\u7528\u7F13\u5B58\u4E2D\u7684\u8FC7\u65F6\u6570\u636E,\u5C31\u4F1A\u4EA7\u751F\u7C7B\u4F3C\u591A\u7EBF\u7A0B\u6570\u636E\u5B89\u5168\u95EE\u9898,\u4ECE\u800C\u5F71\u54CD\u4E1A\u52A1,\u4EA7\u54C1\u53E3\u7891\u7B49;\u600E\u4E48\u89E3\u51B3\u5462\uFF1F\u6709\u5982\u4E0B\u51E0\u79CD\u65B9\u6848</p><p>Cache Aside Pattern <code>\u4EBA\u5DE5\u7F16\u7801\u65B9\u5F0F</code>\uFF1A\u7F13\u5B58\u8C03\u7528\u8005\u5728\u66F4\u65B0\u5B8C\u6570\u636E\u5E93\u540E\u518D\u53BB\u66F4\u65B0\u7F13\u5B58\uFF0C\u4E5F\u79F0\u4E4B\u4E3A\u53CC\u5199\u65B9\u6848</p><p>Read/Write Through Pattern : \u7531\u7CFB\u7EDF\u672C\u8EAB\u5B8C\u6210\uFF0C\u6570\u636E\u5E93\u4E0E\u7F13\u5B58\u7684\u95EE\u9898\u4EA4\u7531\u7CFB\u7EDF\u672C\u8EAB\u53BB\u5904\u7406</p><p>Write Behind Caching Pattern \uFF1A\u8C03\u7528\u8005\u53EA\u64CD\u4F5C\u7F13\u5B58\uFF0C\u5176\u4ED6\u7EBF\u7A0B\u53BB\u5F02\u6B65\u5904\u7406\u6570\u636E\u5E93\uFF0C\u5B9E\u73B0\u6700\u7EC8\u4E00\u81F4</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653322857620.png" alt="1653322857620"></p><h4 id="_2-3-2-\u3001\u6570\u636E\u5E93\u548C\u7F13\u5B58\u4E0D\u4E00\u81F4\u91C7\u7528\u4EC0\u4E48\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#_2-3-2-\u3001\u6570\u636E\u5E93\u548C\u7F13\u5B58\u4E0D\u4E00\u81F4\u91C7\u7528\u4EC0\u4E48\u65B9\u6848" aria-hidden="true">#</a> 2.3.2 \u3001\u6570\u636E\u5E93\u548C\u7F13\u5B58\u4E0D\u4E00\u81F4\u91C7\u7528\u4EC0\u4E48\u65B9\u6848</h4><p>\u7EFC\u5408\u8003\u8651\u4F7F\u7528\u65B9\u6848\u4E00\uFF0C\u4F46\u662F\u65B9\u6848\u4E00\u8C03\u7528\u8005\u5982\u4F55\u5904\u7406\u5462\uFF1F\u8FD9\u91CC\u6709\u51E0\u4E2A\u95EE\u9898</p><p>\u64CD\u4F5C\u7F13\u5B58\u548C\u6570\u636E\u5E93\u65F6\u6709<code>\u4E09\u4E2A\u95EE\u9898</code>\u9700\u8981\u8003\u8651\uFF1A</p><p>\u5982\u679C\u91C7\u7528\u7B2C\u4E00\u4E2A\u65B9\u6848\uFF0C\u90A3\u4E48\u5047\u8BBE\u6211\u4EEC\u6BCF\u6B21\u64CD\u4F5C\u6570\u636E\u5E93\u540E\uFF0C\u90FD\u64CD\u4F5C\u7F13\u5B58\uFF0C\u4F46\u662F\u4E2D\u95F4\u5982\u679C\u6CA1\u6709\u4EBA\u67E5\u8BE2\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u66F4\u65B0\u52A8\u4F5C\u5B9E\u9645\u4E0A\u53EA\u6709\u6700\u540E\u4E00\u6B21\u751F\u6548\uFF0C\u4E2D\u95F4\u7684\u66F4\u65B0\u52A8\u4F5C\u610F\u4E49\u5E76\u4E0D\u5927\uFF0C\u6211\u4EEC\u53EF\u4EE5\u628A\u7F13\u5B58\u5220\u9664\uFF0C\u7B49\u5F85\u518D\u6B21\u67E5\u8BE2\u65F6\uFF0C\u5C06\u7F13\u5B58\u4E2D\u7684\u6570\u636E\u52A0\u8F7D\u51FA\u6765</p><ul><li><p><code>\u5220\u9664\u7F13\u5B58\u8FD8\u662F\u66F4\u65B0\u7F13\u5B58\uFF1F</code></p><ul><li>\u66F4\u65B0\u7F13\u5B58\uFF1A\u6BCF\u6B21\u66F4\u65B0\u6570\u636E\u5E93\u90FD\u66F4\u65B0\u7F13\u5B58\uFF0C\u65E0\u6548\u5199\u64CD\u4F5C\u8F83\u591A</li><li>\u5220\u9664\u7F13\u5B58\uFF1A\u66F4\u65B0\u6570\u636E\u5E93\u65F6\u8BA9\u7F13\u5B58\u5931\u6548\uFF0C\u67E5\u8BE2\u65F6\u518D\u66F4\u65B0\u7F13\u5B58(\u61D2\u52A0\u8F7D)</li></ul></li><li><p><code>\u5982\u4F55\u4FDD\u8BC1\u7F13\u5B58\u4E0E\u6570\u636E\u5E93\u7684\u64CD\u4F5C\u7684\u540C\u65F6\u6210\u529F\u6216\u5931\u8D25\uFF1F</code></p><ul><li>\u5355\u4F53\u7CFB\u7EDF\uFF0C\u5C06\u7F13\u5B58\u4E0E\u6570\u636E\u5E93\u64CD\u4F5C\u653E\u5728\u4E00\u4E2A\u4E8B\u52A1</li><li>\u5206\u5E03\u5F0F\u7CFB\u7EDF\uFF0C\u5229\u7528TCC\u7B49\u5206\u5E03\u5F0F\u4E8B\u52A1\u65B9\u6848</li></ul></li></ul><p>\u5E94\u8BE5\u5177\u4F53\u64CD\u4F5C\u7F13\u5B58\u8FD8\u662F\u64CD\u4F5C\u6570\u636E\u5E93\uFF0C\u6211\u4EEC\u5E94\u5F53\u662F\u5148\u64CD\u4F5C\u6570\u636E\u5E93\uFF0C\u518D\u5220\u9664\u7F13\u5B58\uFF0C\u539F\u56E0\u5728\u4E8E\uFF0C\u5982\u679C\u4F60\u9009\u62E9\u7B2C\u4E00\u79CD\u65B9\u6848\uFF0C\u5728\u4E24\u4E2A\u7EBF\u7A0B\u5E76\u53D1\u6765\u8BBF\u95EE\u65F6\uFF0C\u5047\u8BBE\u7EBF\u7A0B1\u5148\u6765\uFF0C\u4ED6\u5148\u628A\u7F13\u5B58\u5220\u4E86\uFF0C\u6B64\u65F6\u7EBF\u7A0B2\u8FC7\u6765\uFF0C\u4ED6\u67E5\u8BE2\u7F13\u5B58\u6570\u636E\u5E76\u4E0D\u5B58\u5728\uFF0C\u6B64\u65F6\u4ED6\u5199\u5165\u7F13\u5B58\uFF0C\u5F53\u4ED6\u5199\u5165\u7F13\u5B58\u540E\uFF0C\u7EBF\u7A0B1\u518D\u6267\u884C\u66F4\u65B0\u52A8\u4F5C\u65F6\uFF0C\u5B9E\u9645\u4E0A\u5199\u5165\u7684\u5C31\u662F\u65E7\u7684\u6570\u636E\uFF0C\u65B0\u7684\u6570\u636E\u88AB\u65E7\u6570\u636E\u8986\u76D6\u4E86\u3002</p><ul><li><code>\u5148\u64CD\u4F5C\u7F13\u5B58\u8FD8\u662F\u5148\u64CD\u4F5C\u6570\u636E\u5E93\uFF1F</code><ul><li>\u5148\u5220\u9664\u7F13\u5B58\uFF0C\u518D\u64CD\u4F5C\u6570\u636E\u5E93</li><li>\u5148\u64CD\u4F5C\u6570\u636E\u5E93\uFF0C\u518D\u5220\u9664\u7F13\u5B58</li></ul></li></ul><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653323595206.png" alt="1653323595206"></p><h3 id="_2-4-\u5B9E\u73B0\u5546\u94FA\u548C\u7F13\u5B58\u4E0E\u6570\u636E\u5E93\u53CC\u5199\u4E00\u81F4" tabindex="-1"><a class="header-anchor" href="#_2-4-\u5B9E\u73B0\u5546\u94FA\u548C\u7F13\u5B58\u4E0E\u6570\u636E\u5E93\u53CC\u5199\u4E00\u81F4" aria-hidden="true">#</a> 2.4 \u5B9E\u73B0\u5546\u94FA\u548C\u7F13\u5B58\u4E0E\u6570\u636E\u5E93\u53CC\u5199\u4E00\u81F4</h3><blockquote><p>1.\u5199\u5165\u7F13\u5B58\u65F6\u540C\u65F6\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</p><p>2.\u66F4\u65B0\u65F6\u5148\u64CD\u4F5C\u6570\u636E\u5E93\uFF0C\u518D\u5220\u9664\u7F13\u5B58\uFF0C\u4F7F\u7528 @Transactional \u6CE8\u89E3\u4FDD\u8BC1\u4E8B\u52A1</p></blockquote><p>\u6838\u5FC3\u601D\u8DEF\u5982\u4E0B\uFF1A</p><p>\u4FEE\u6539ShopController\u4E2D\u7684\u4E1A\u52A1\u903B\u8F91\uFF0C\u6EE1\u8DB3\u4E0B\u9762\u7684\u9700\u6C42\uFF1A</p><p>\u6839\u636Eid\u67E5\u8BE2\u5E97\u94FA\u65F6\uFF0C\u5982\u679C\u7F13\u5B58\u672A\u547D\u4E2D\uFF0C\u5219\u67E5\u8BE2\u6570\u636E\u5E93\uFF0C\u5C06\u6570\u636E\u5E93\u7ED3\u679C\u5199\u5165\u7F13\u5B58\uFF0C\u5E76\u8BBE\u7F6E\u8D85\u65F6\u65F6\u95F4</p><p>\u6839\u636Eid\u4FEE\u6539\u5E97\u94FA\u65F6\uFF0C\u5148\u4FEE\u6539\u6570\u636E\u5E93\uFF0C\u518D\u5220\u9664\u7F13\u5B58</p><p><strong>\u4FEE\u6539\u91CD\u70B9\u4EE3\u78011</strong>\uFF1A\u4FEE\u6539<strong>ShopServiceImpl</strong>\u7684queryById\u65B9\u6CD5</p><p><strong>\u8BBE\u7F6Eredis\u7F13\u5B58\u65F6\u6DFB\u52A0\u8FC7\u671F\u65F6\u95F4</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u5224\u65AD redis \u662F\u5426\u6709 \u5546\u6237\u7F13\u5B58</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.1 \u5B58\u5728\u5219\u76F4\u63A5\u8FD4\u56DE</span>
            <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.\u4ECE\u6570\u636E\u5E93\u4E2D\u67E5\u51FA\u5546\u6237\u4FE1\u606F</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.1 \u4E0D\u5B58\u5728\u62A5\u9519</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5546\u54C1\u4FE1\u606F\u4E0D\u5B58\u5728&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u5C06\u5546\u6237\u4FE1\u606F\u4FDD\u5B58\u5728 redis \u4E2D \`cache_shop: + id\`\uFF0C\u540C\u65F6\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u8FD4\u56DE\u5546\u54C1\u4FE1\u606F</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u4FEE\u6539\u91CD\u70B9\u4EE3\u78012</strong></p><p>\u4EE3\u7801\u5206\u6790\uFF1A\u901A\u8FC7\u4E4B\u524D\u7684\u6DD8\u6C70\uFF0C\u6211\u4EEC\u786E\u5B9A\u4E86\u91C7\u7528\u5220\u9664\u7B56\u7565\uFF0C\u6765\u89E3\u51B3\u53CC\u5199\u95EE\u9898\uFF0C\u5F53\u6211\u4EEC\u4FEE\u6539\u4E86\u6570\u636E\u4E4B\u540E\uFF0C\u7136\u540E\u628A\u7F13\u5B58\u4E2D\u7684\u6570\u636E\u8FDB\u884C\u5220\u9664\uFF0C\u67E5\u8BE2\u65F6\u53D1\u73B0\u7F13\u5B58\u4E2D\u6CA1\u6709\u6570\u636E\uFF0C\u5219\u4F1A\u4ECEmysql\u4E2D\u52A0\u8F7D\u6700\u65B0\u7684\u6570\u636E\uFF0C\u4ECE\u800C\u907F\u514D\u6570\u636E\u5E93\u548C\u7F13\u5B58\u4E0D\u4E00\u81F4\u7684\u95EE\u9898</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>	<span class="token annotation punctuation">@Transactional</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">updateShop</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u5148\u64CD\u4F5C\u6570\u636E\u5E93</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5546\u94FA Id \u4E0D\u80FD\u4E3A\u7A7A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5220\u9664\u7F13\u5B58</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-\u7F13\u5B58\u7A7F\u900F\u95EE\u9898\u7684\u89E3\u51B3\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#_2-5-\u7F13\u5B58\u7A7F\u900F\u95EE\u9898\u7684\u89E3\u51B3\u601D\u8DEF" aria-hidden="true">#</a> 2.5 \u7F13\u5B58\u7A7F\u900F\u95EE\u9898\u7684\u89E3\u51B3\u601D\u8DEF</h3><p>\u7F13\u5B58\u7A7F\u900F \uFF1A<code>\u7F13\u5B58\u7A7F\u900F\u662F\u6307\u5BA2\u6237\u7AEF\u8BF7\u6C42\u7684\u6570\u636E\u5728\u7F13\u5B58\u4E2D\u548C\u6570\u636E\u5E93\u4E2D\u90FD\u4E0D\u5B58\u5728\uFF0C\u8FD9\u6837\u7F13\u5B58\u6C38\u8FDC\u4E0D\u4F1A\u751F\u6548\uFF0C\u8FD9\u4E9B\u8BF7\u6C42\u90FD\u4F1A\u6253\u5230\u6570\u636E\u5E93\u3002</code></p><p>\u5E38\u89C1\u7684\u89E3\u51B3\u65B9\u6848\u6709\u4E24\u79CD\uFF1A</p><ul><li><code>\u7F13\u5B58\u7A7A\u5BF9\u8C61</code><ul><li>\u4F18\u70B9\uFF1A\u5B9E\u73B0\u7B80\u5355\uFF0C\u7EF4\u62A4\u65B9\u4FBF</li><li>\u7F3A\u70B9\uFF1A <ul><li>\u989D\u5916\u7684\u5185\u5B58\u6D88\u8017</li><li>\u53EF\u80FD\u9020\u6210\u77ED\u671F\u7684\u4E0D\u4E00\u81F4</li></ul></li></ul></li><li><code>\u5E03\u9686\u8FC7\u6EE4</code><ul><li>\u4F18\u70B9\uFF1A\u5185\u5B58\u5360\u7528\u8F83\u5C11\uFF0C\u6CA1\u6709\u591A\u4F59key</li><li>\u7F3A\u70B9\uFF1A <ul><li>\u5B9E\u73B0\u590D\u6742</li><li>\u5B58\u5728\u8BEF\u5224\u53EF\u80FD</li></ul></li></ul></li></ul><p><strong>\u7F13\u5B58\u7A7A\u5BF9\u8C61\u601D\u8DEF\u5206\u6790</strong>\uFF1A\u5F53\u6211\u4EEC\u5BA2\u6237\u7AEF\u8BBF\u95EE\u4E0D\u5B58\u5728\u7684\u6570\u636E\u65F6\uFF0C\u5148\u8BF7\u6C42redis\uFF0C\u4F46\u662F\u6B64\u65F6redis\u4E2D\u6CA1\u6709\u6570\u636E\uFF0C\u6B64\u65F6\u4F1A\u8BBF\u95EE\u5230\u6570\u636E\u5E93\uFF0C\u4F46\u662F\u6570\u636E\u5E93\u4E2D\u4E5F\u6CA1\u6709\u6570\u636E\uFF0C\u8FD9\u4E2A\u6570\u636E\u7A7F\u900F\u4E86\u7F13\u5B58\uFF0C\u76F4\u51FB\u6570\u636E\u5E93\uFF0C\u6211\u4EEC\u90FD\u77E5\u9053\u6570\u636E\u5E93\u80FD\u591F\u627F\u8F7D\u7684\u5E76\u53D1\u4E0D\u5982redis\u8FD9\u4E48\u9AD8\uFF0C\u5982\u679C\u5927\u91CF\u7684\u8BF7\u6C42\u540C\u65F6\u8FC7\u6765\u8BBF\u95EE\u8FD9\u79CD\u4E0D\u5B58\u5728\u7684\u6570\u636E\uFF0C\u8FD9\u4E9B\u8BF7\u6C42\u5C31\u90FD\u4F1A\u8BBF\u95EE\u5230\u6570\u636E\u5E93\uFF0C\u7B80\u5355\u7684\u89E3\u51B3\u65B9\u6848\u5C31\u662F\u54EA\u6015\u8FD9\u4E2A\u6570\u636E\u5728\u6570\u636E\u5E93\u4E2D\u4E5F\u4E0D\u5B58\u5728\uFF0C\u6211\u4EEC\u4E5F\u628A\u8FD9\u4E2A\u6570\u636E\u5B58\u5165\u5230redis\u4E2D\u53BB\uFF0C\u8FD9\u6837\uFF0C\u4E0B\u6B21\u7528\u6237\u8FC7\u6765\u8BBF\u95EE\u8FD9\u4E2A\u4E0D\u5B58\u5728\u7684\u6570\u636E\uFF0C\u90A3\u4E48\u5728redis\u4E2D\u4E5F\u80FD\u627E\u5230\u8FD9\u4E2A\u6570\u636E\u5C31\u4E0D\u4F1A\u8FDB\u5165\u5230\u7F13\u5B58\u4E86</p><p><strong>\u5E03\u9686\u8FC7\u6EE4</strong>\uFF1A\u5E03\u9686\u8FC7\u6EE4\u5668\u5176\u5B9E\u91C7\u7528\u7684\u662F\u54C8\u5E0C\u601D\u60F3\u6765\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\uFF0C\u901A\u8FC7\u4E00\u4E2A\u5E9E\u5927\u7684\u4E8C\u8FDB\u5236\u6570\u7EC4\uFF0C\u8D70<code>\u54C8\u5E0C\u601D\u60F3</code>\u53BB\u5224\u65AD\u5F53\u524D\u8FD9\u4E2A\u8981\u67E5\u8BE2\u7684\u8FD9\u4E2A\u6570\u636E\u662F\u5426\u5B58\u5728\uFF0C\u5982\u679C\u5E03\u9686\u8FC7\u6EE4\u5668\u5224\u65AD\u5B58\u5728\uFF0C\u5219\u653E\u884C\uFF0C\u8FD9\u4E2A\u8BF7\u6C42\u4F1A\u53BB\u8BBF\u95EEredis\uFF0C\u54EA\u6015\u6B64\u65F6redis\u4E2D\u7684\u6570\u636E\u8FC7\u671F\u4E86\uFF0C\u4F46\u662F\u6570\u636E\u5E93\u4E2D\u4E00\u5B9A\u5B58\u5728\u8FD9\u4E2A\u6570\u636E\uFF0C\u5728\u6570\u636E\u5E93\u4E2D\u67E5\u8BE2\u51FA\u6765\u8FD9\u4E2A\u6570\u636E\u540E\uFF0C\u518D\u5C06\u5176\u653E\u5165\u5230redis\u4E2D\uFF0C</p><p>\u5047\u8BBE\u5E03\u9686\u8FC7\u6EE4\u5668\u5224\u65AD\u8FD9\u4E2A\u6570\u636E\u4E0D\u5B58\u5728\uFF0C\u5219\u76F4\u63A5\u8FD4\u56DE</p><p>\u8FD9\u79CD\u65B9\u5F0F\u4F18\u70B9\u5728\u4E8E\u8282\u7EA6\u5185\u5B58\u7A7A\u95F4\uFF0C\u5B58\u5728\u8BEF\u5224\uFF0C<code>\u8BEF\u5224\u539F\u56E0\u5728\u4E8E\uFF1A\u5E03\u9686\u8FC7\u6EE4\u5668\u8D70\u7684\u662F\u54C8\u5E0C\u601D\u60F3\uFF0C\u53EA\u8981\u54C8\u5E0C\u601D\u60F3\uFF0C\u5C31\u53EF\u80FD\u5B58\u5728\u54C8\u5E0C\u51B2\u7A81</code></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653326156516.png" alt="1653326156516"></p><h3 id="_2-6-\u7F16\u7801\u89E3\u51B3\u5546\u54C1\u67E5\u8BE2\u7684\u7F13\u5B58\u7A7F\u900F\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_2-6-\u7F16\u7801\u89E3\u51B3\u5546\u54C1\u67E5\u8BE2\u7684\u7F13\u5B58\u7A7F\u900F\u95EE\u9898" aria-hidden="true">#</a> 2.6 \u7F16\u7801\u89E3\u51B3\u5546\u54C1\u67E5\u8BE2\u7684\u7F13\u5B58\u7A7F\u900F\u95EE\u9898\uFF1A</h3><p>\u6838\u5FC3\u601D\u8DEF\u5982\u4E0B\uFF1A</p><p>\u5728\u539F\u6765\u7684\u903B\u8F91\u4E2D\uFF0C\u6211\u4EEC\u5982\u679C\u53D1\u73B0\u8FD9\u4E2A\u6570\u636E\u5728mysql\u4E2D\u4E0D\u5B58\u5728\uFF0C\u76F4\u63A5\u5C31\u8FD4\u56DE404\u4E86\uFF0C\u8FD9\u6837\u662F\u4F1A\u5B58\u5728\u7F13\u5B58\u7A7F\u900F\u95EE\u9898\u7684</p><p>\u73B0\u5728\u7684\u903B\u8F91\u4E2D\uFF1A\u5982\u679C\u8FD9\u4E2A\u6570\u636E\u4E0D\u5B58\u5728\uFF0C\u6211\u4EEC\u4E0D\u4F1A\u8FD4\u56DE404 \uFF0C\u8FD8\u662F\u4F1A\u628A\u8FD9\u4E2A\u6570\u636E\u5199\u5165\u5230Redis\u4E2D\uFF0C\u5E76\u4E14\u5C06value\u8BBE\u7F6E\u4E3A\u7A7A\u5B57\u7B26\u4E32\uFF0C\u6B27\u5F53\u518D\u6B21\u53D1\u8D77\u67E5\u8BE2\u65F6\uFF0C\u6211\u4EEC\u5982\u679C\u53D1\u73B0\u547D\u4E2D\u4E4B\u540E\uFF0C\u5224\u65AD\u8FD9\u4E2Avalue\u662F\u5426\u662F\u7A7A\u5B57\u7B26\u4E32\uFF0C\u5982\u679C\u662F\u7A7A\u5B57\u7B26\u4E32\uFF0C\u5219\u662F\u4E4B\u524D\u5199\u5165\u7684\u6570\u636E\uFF0C\u8BC1\u660E\u662F\u7F13\u5B58\u7A7F\u900F\u6570\u636E\uFF0C\u5982\u679C\u4E0D\u662F\uFF0C\u5219\u76F4\u63A5\u8FD4\u56DE\u6570\u636E\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653327124561.png" alt="1653327124561"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * \u7F13\u5B58\u7A7F\u900F
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryWithPassThrough</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u5224\u65AD redis \u662F\u5426\u6709 \u5546\u6237\u7F13\u5B58</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.1 \u5B58\u5728\u5219\u76F4\u63A5\u8FD4\u56DE</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u5224\u65AD\u662F\u5426\u4E3A \u7A7A\u503C</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopJson <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.\u4ECE\u6570\u636E\u5E93\u4E2D\u67E5\u51FA\u5546\u94FA\u4FE1\u606F</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.1 \u4E0D\u5B58\u5728</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u7F13\u5B58 \u7A7A\u5B57\u7B26\u4E32\uFF0C\u5E76\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\u4E3A 2\u5206\u949F</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u5C06\u5546\u94FA\u4FE1\u606F\u4FDD\u5B58\u5728 redis \u4E2D \`cache_shop: + id\`\uFF0C\u540C\u65F6\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u8FD4\u56DE\u5546\u94FA\u4FE1\u606F</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u5C0F\u603B\u7ED3\uFF1A</strong></p><p>\u7F13\u5B58\u7A7F\u900F\u4EA7\u751F\u7684\u539F\u56E0\u662F\u4EC0\u4E48\uFF1F</p><ul><li>\u7528\u6237\u8BF7\u6C42\u7684\u6570\u636E\u5728\u7F13\u5B58\u4E2D\u548C\u6570\u636E\u5E93\u4E2D\u90FD\u4E0D\u5B58\u5728\uFF0C\u4E0D\u65AD\u53D1\u8D77\u8FD9\u6837\u7684\u8BF7\u6C42\uFF0C\u7ED9\u6570\u636E\u5E93\u5E26\u6765\u5DE8\u5927\u538B\u529B</li></ul><p>\u7F13\u5B58\u7A7F\u900F\u7684\u89E3\u51B3\u65B9\u6848\u6709\u54EA\u4E9B\uFF1F</p><ul><li>\u7F13\u5B58null\u503C</li><li>\u5E03\u9686\u8FC7\u6EE4</li><li>\u589E\u5F3Aid\u7684\u590D\u6742\u5EA6\uFF0C\u907F\u514D\u88AB\u731C\u6D4Bid\u89C4\u5F8B</li><li>\u505A\u597D\u6570\u636E\u7684\u57FA\u7840\u683C\u5F0F\u6821\u9A8C</li><li>\u52A0\u5F3A\u7528\u6237\u6743\u9650\u6821\u9A8C</li><li>\u505A\u597D\u70ED\u70B9\u53C2\u6570\u7684\u9650\u6D41</li></ul><h3 id="_2-7-\u7F13\u5B58\u96EA\u5D29\u95EE\u9898\u53CA\u89E3\u51B3\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#_2-7-\u7F13\u5B58\u96EA\u5D29\u95EE\u9898\u53CA\u89E3\u51B3\u601D\u8DEF" aria-hidden="true">#</a> 2.7 \u7F13\u5B58\u96EA\u5D29\u95EE\u9898\u53CA\u89E3\u51B3\u601D\u8DEF</h3><p>\u7F13\u5B58\u96EA\u5D29\u662F\u6307\u5728\u540C\u4E00\u65F6\u6BB5\u5927\u91CF\u7684\u7F13\u5B58key\u540C\u65F6\u5931\u6548\u6216\u8005Redis\u670D\u52A1\u5B95\u673A\uFF0C\u5BFC\u81F4\u5927\u91CF\u8BF7\u6C42\u5230\u8FBE\u6570\u636E\u5E93\uFF0C\u5E26\u6765\u5DE8\u5927\u538B\u529B\u3002</p><p>\u89E3\u51B3\u65B9\u6848\uFF1A</p><ul><li><code>\u7ED9\u4E0D\u540C\u7684Key\u7684TTL\u6DFB\u52A0\u968F\u673A\u503C</code></li><li>\u5229\u7528<code>Redis\u96C6\u7FA4</code>\u63D0\u9AD8\u670D\u52A1\u7684\u53EF\u7528\u6027</li><li>\u7ED9\u7F13\u5B58\u4E1A\u52A1\u6DFB\u52A0<code>\u964D\u7EA7\u9650\u6D41\u7B56\u7565</code></li><li>\u7ED9\u4E1A\u52A1\u6DFB\u52A0<code>\u591A\u7EA7\u7F13\u5B58</code></li></ul><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653327884526.png" alt="1653327884526"></p><h3 id="_2-8-\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898\u53CA\u89E3\u51B3\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#_2-8-\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898\u53CA\u89E3\u51B3\u601D\u8DEF" aria-hidden="true">#</a> 2.8 \u7F13\u5B58\u51FB\u7A7F\u95EE\u9898\u53CA\u89E3\u51B3\u601D\u8DEF</h3><p>\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898\u4E5F\u53EB<code>\u70ED\u70B9Key\u95EE\u9898</code>\uFF0C\u5C31\u662F\u4E00\u4E2A\u88AB<code>\u9AD8\u5E76\u53D1\u8BBF\u95EE</code>\u5E76\u4E14<code>\u7F13\u5B58\u91CD\u5EFA\u4E1A\u52A1\u8F83\u590D\u6742\u7684key</code>\u7A81\u7136\u5931\u6548\u4E86\uFF0C\u65E0\u6570\u7684\u8BF7\u6C42\u8BBF\u95EE\u4F1A\u5728\u77AC\u95F4\u7ED9\u6570\u636E\u5E93\u5E26\u6765\u5DE8\u5927\u7684\u51B2\u51FB\u3002</p><p>\u5E38\u89C1\u7684\u89E3\u51B3\u65B9\u6848\u6709\u4E24\u79CD\uFF1A</p><ul><li>\u4E92\u65A5\u9501</li><li>\u903B\u8F91\u8FC7\u671F</li></ul><p>\u903B\u8F91\u5206\u6790\uFF1A\u5047\u8BBE\u7EBF\u7A0B1\u5728\u67E5\u8BE2\u7F13\u5B58\u4E4B\u540E\uFF0C\u672C\u6765\u5E94\u8BE5\u53BB\u67E5\u8BE2\u6570\u636E\u5E93\uFF0C\u7136\u540E\u628A\u8FD9\u4E2A\u6570\u636E\u91CD\u65B0\u52A0\u8F7D\u5230\u7F13\u5B58\u7684\uFF0C\u6B64\u65F6\u53EA\u8981\u7EBF\u7A0B1\u8D70\u5B8C\u8FD9\u4E2A\u903B\u8F91\uFF0C\u5176\u4ED6\u7EBF\u7A0B\u5C31\u90FD\u80FD\u4ECE\u7F13\u5B58\u4E2D\u52A0\u8F7D\u8FD9\u4E9B\u6570\u636E\u4E86\uFF0C\u4F46\u662F\u5047\u8BBE\u5728\u7EBF\u7A0B1\u6CA1\u6709\u8D70\u5B8C\u7684\u65F6\u5019\uFF0C\u540E\u7EED\u7684\u7EBF\u7A0B2\uFF0C\u7EBF\u7A0B3\uFF0C\u7EBF\u7A0B4\u540C\u65F6\u8FC7\u6765\u8BBF\u95EE\u5F53\u524D\u8FD9\u4E2A\u65B9\u6CD5\uFF0C \u90A3\u4E48\u8FD9\u4E9B\u7EBF\u7A0B\u90FD\u4E0D\u80FD\u4ECE\u7F13\u5B58\u4E2D\u67E5\u8BE2\u5230\u6570\u636E\uFF0C\u90A3\u4E48\u4ED6\u4EEC\u5C31\u4F1A\u540C\u4E00\u65F6\u523B\u6765\u8BBF\u95EE\u67E5\u8BE2\u7F13\u5B58\uFF0C\u90FD\u6CA1\u67E5\u5230\uFF0C\u63A5\u7740\u540C\u4E00\u65F6\u95F4\u53BB\u8BBF\u95EE\u6570\u636E\u5E93\uFF0C\u540C\u65F6\u7684\u53BB\u6267\u884C\u6570\u636E\u5E93\u4EE3\u7801\uFF0C\u5BF9\u6570\u636E\u5E93\u8BBF\u95EE\u538B\u529B\u8FC7\u5927</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653328022622.png" alt="1653328022622"></p><p>\u89E3\u51B3\u65B9\u6848\u4E00\u3001<code>\u4F7F\u7528\u9501\u6765\u89E3\u51B3\uFF1A</code></p><p>\u56E0\u4E3A\u9501\u80FD\u5B9E\u73B0\u4E92\u65A5\u6027\u3002\u5047\u8BBE\u7EBF\u7A0B\u8FC7\u6765\uFF0C\u53EA\u80FD\u4E00\u4E2A\u4EBA\u4E00\u4E2A\u4EBA\u7684\u6765\u8BBF\u95EE\u6570\u636E\u5E93\uFF0C\u4ECE\u800C\u907F\u514D\u5BF9\u4E8E\u6570\u636E\u5E93\u8BBF\u95EE\u538B\u529B\u8FC7\u5927\uFF0C\u4F46\u8FD9\u4E5F\u4F1A\u5F71\u54CD\u67E5\u8BE2\u7684\u6027\u80FD\uFF0C\u56E0\u4E3A\u6B64\u65F6\u4F1A\u8BA9\u67E5\u8BE2\u7684\u6027\u80FD\u4ECE\u5E76\u884C\u53D8\u6210\u4E86\u4E32\u884C\uFF0C\u6211\u4EEC\u53EF\u4EE5\u91C7\u7528tryLock\u65B9\u6CD5 + double check\u6765\u89E3\u51B3\u8FD9\u6837\u7684\u95EE\u9898\u3002</p><p>\u5047\u8BBE\u73B0\u5728\u7EBF\u7A0B1\u8FC7\u6765\u8BBF\u95EE\uFF0C\u4ED6\u67E5\u8BE2\u7F13\u5B58\u6CA1\u6709\u547D\u4E2D\uFF0C\u4F46\u662F\u6B64\u65F6\u4ED6\u83B7\u5F97\u5230\u4E86\u9501\u7684\u8D44\u6E90\uFF0C\u90A3\u4E48\u7EBF\u7A0B1\u5C31\u4F1A\u4E00\u4E2A\u4EBA\u53BB\u6267\u884C\u903B\u8F91\uFF0C\u5047\u8BBE\u73B0\u5728\u7EBF\u7A0B2\u8FC7\u6765\uFF0C\u7EBF\u7A0B2\u5728\u6267\u884C\u8FC7\u7A0B\u4E2D\uFF0C\u5E76\u6CA1\u6709\u83B7\u5F97\u5230\u9501\uFF0C\u90A3\u4E48\u7EBF\u7A0B2\u5C31\u53EF\u4EE5\u8FDB\u884C\u5230\u4F11\u7720\uFF0C\u76F4\u5230\u7EBF\u7A0B1\u628A\u9501\u91CA\u653E\u540E\uFF0C\u7EBF\u7A0B2\u83B7\u5F97\u5230\u9501\uFF0C\u7136\u540E\u518D\u6765\u6267\u884C\u903B\u8F91\uFF0C\u6B64\u65F6\u5C31\u80FD\u591F\u4ECE\u7F13\u5B58\u4E2D\u62FF\u5230\u6570\u636E\u4E86\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653328288627.png" alt="1653328288627"></p><p>\u89E3\u51B3\u65B9\u6848\u4E8C\u3001<code>\u903B\u8F91\u8FC7\u671F\u65B9\u6848</code></p><p>\u65B9\u6848\u5206\u6790\uFF1A\u6211\u4EEC\u4E4B\u6240\u4EE5\u4F1A\u51FA\u73B0\u8FD9\u4E2A\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898\uFF0C\u4E3B\u8981\u539F\u56E0\u662F\u5728\u4E8E\u6211\u4EEC\u5BF9key\u8BBE\u7F6E\u4E86\u8FC7\u671F\u65F6\u95F4\uFF0C\u5047\u8BBE\u6211\u4EEC\u4E0D\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\uFF0C\u5176\u5B9E\u5C31\u4E0D\u4F1A\u6709\u7F13\u5B58\u51FB\u7A7F\u7684\u95EE\u9898\uFF0C\u4F46\u662F\u4E0D\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\uFF0C\u8FD9\u6837\u6570\u636E\u4E0D\u5C31\u4E00\u76F4\u5360\u7528\u6211\u4EEC\u5185\u5B58\u4E86\u5417\uFF0C\u6211\u4EEC\u53EF\u4EE5\u91C7\u7528\u903B\u8F91\u8FC7\u671F\u65B9\u6848\u3002</p><p>\u6211\u4EEC\u628A\u8FC7\u671F\u65F6\u95F4\u8BBE\u7F6E\u5728 redis\u7684value\u4E2D\uFF0C\u6CE8\u610F\uFF1A\u8FD9\u4E2A\u8FC7\u671F\u65F6\u95F4\u5E76\u4E0D\u4F1A\u76F4\u63A5\u4F5C\u7528\u4E8Eredis\uFF0C\u800C\u662F\u6211\u4EEC\u540E\u7EED\u901A\u8FC7\u903B\u8F91\u53BB\u5904\u7406\u3002\u5047\u8BBE\u7EBF\u7A0B1\u53BB\u67E5\u8BE2\u7F13\u5B58\uFF0C\u7136\u540E\u4ECEvalue\u4E2D\u5224\u65AD\u51FA\u6765\u5F53\u524D\u7684\u6570\u636E\u5DF2\u7ECF\u8FC7\u671F\u4E86\uFF0C\u6B64\u65F6\u7EBF\u7A0B1\u53BB\u83B7\u5F97\u4E92\u65A5\u9501\uFF0C\u90A3\u4E48\u5176\u4ED6\u7EBF\u7A0B\u4F1A\u8FDB\u884C\u963B\u585E\uFF0C<code>\u83B7\u5F97\u4E86\u9501\u7684\u7EBF\u7A0B\u4ED6\u4F1A\u5F00\u542F\u4E00\u4E2A \u7EBF\u7A0B\u53BB\u8FDB\u884C \u4EE5\u524D\u7684\u91CD\u6784\u6570\u636E\u7684\u903B\u8F91</code>\uFF0C\u76F4\u5230\u65B0\u5F00\u7684\u7EBF\u7A0B\u5B8C\u6210\u8FD9\u4E2A\u903B\u8F91\u540E\uFF0C\u624D\u91CA\u653E\u9501\uFF0C \u800C\u7EBF\u7A0B1\u76F4\u63A5\u8FDB\u884C\u8FD4\u56DE\uFF0C\u5047\u8BBE\u73B0\u5728\u7EBF\u7A0B3\u8FC7\u6765\u8BBF\u95EE\uFF0C\u7531\u4E8E\u7EBF\u7A0B\u7EBF\u7A0B2\u6301\u6709\u7740\u9501\uFF0C\u6240\u4EE5\u7EBF\u7A0B3\u65E0\u6CD5\u83B7\u5F97\u9501\uFF0C\u7EBF\u7A0B3\u4E5F\u76F4\u63A5\u8FD4\u56DE\u6570\u636E\uFF0C\u53EA\u6709\u7B49\u5230\u65B0\u5F00\u7684\u7EBF\u7A0B2\u628A\u91CD\u5EFA\u6570\u636E\u6784\u5EFA\u5B8C\u540E\uFF0C\u5176\u4ED6\u7EBF\u7A0B\u624D\u80FD\u8D70\u8FD4\u56DE\u6B63\u786E\u7684\u6570\u636E\u3002</p><p>\u8FD9\u79CD\u65B9\u6848\u5DE7\u5999\u5728\u4E8E\uFF0C\u5F02\u6B65\u7684\u6784\u5EFA\u7F13\u5B58\uFF0C\u7F3A\u70B9\u5728\u4E8E\u5728\u6784\u5EFA\u5B8C\u7F13\u5B58\u4E4B\u524D\uFF0C\u8FD4\u56DE\u7684\u90FD\u662F\u810F\u6570\u636E\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653328663897.png" alt="1653328663897"></p><p>\u8FDB\u884C\u5BF9\u6BD4</p><p><strong>\u4E92\u65A5\u9501\u65B9\u6848</strong>\uFF1A\u7531\u4E8E\u4FDD\u8BC1\u4E86\u4E92\u65A5\u6027\uFF0C\u6240\u4EE5\u6570\u636E\u4E00\u81F4\uFF0C\u4E14\u5B9E\u73B0\u7B80\u5355\uFF0C\u56E0\u4E3A\u4EC5\u4EC5\u53EA\u9700\u8981\u52A0\u4E00\u628A\u9501\u800C\u5DF2\uFF0C\u4E5F\u6CA1\u5176\u4ED6\u7684\u4E8B\u60C5\u9700\u8981\u64CD\u5FC3\uFF0C\u6240\u4EE5\u6CA1\u6709\u989D\u5916\u7684\u5185\u5B58\u6D88\u8017\uFF0C\u7F3A\u70B9\u5728\u4E8E\u6709\u9501\u5C31\u6709\u6B7B\u9501\u95EE\u9898\u7684\u53D1\u751F\uFF0C\u4E14\u53EA\u80FD\u4E32\u884C\u6267\u884C\u6027\u80FD\u80AF\u5B9A\u53D7\u5230\u5F71\u54CD</p><p><strong>\u903B\u8F91\u8FC7\u671F\u65B9\u6848</strong>\uFF1A\u7EBF\u7A0B\u8BFB\u53D6\u8FC7\u7A0B\u4E2D\u4E0D\u9700\u8981\u7B49\u5F85\uFF0C\u6027\u80FD\u597D\uFF0C\u6709\u4E00\u4E2A\u989D\u5916\u7684\u7EBF\u7A0B\u6301\u6709\u9501\u53BB\u8FDB\u884C\u91CD\u6784\u6570\u636E\uFF0C\u4F46\u662F\u5728\u91CD\u6784\u6570\u636E\u5B8C\u6210\u524D\uFF0C\u5176\u4ED6\u7684\u7EBF\u7A0B\u53EA\u80FD\u8FD4\u56DE\u4E4B\u524D\u7684\u6570\u636E\uFF0C\u4E14\u5B9E\u73B0\u8D77\u6765\u9EBB\u70E6</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653357522914.png" alt="1653357522914"></p><h3 id="_2-9-\u5229\u7528\u4E92\u65A5\u9501\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_2-9-\u5229\u7528\u4E92\u65A5\u9501\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898" aria-hidden="true">#</a> 2.9 \u5229\u7528\u4E92\u65A5\u9501\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898</h3><blockquote><p>1.\u7F13\u5B58\u4E0D\u5B58\u5728\uFF0C\u83B7\u5F97\u9501 <code>setnx</code>\uFF0C\u952E\u7684\u8BBE\u8BA1 <code>lock:shop: + id</code>\uFF0C\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\u4E3A 10s</p><p>\u200B 1.1 \u83B7\u53D6\u9501\u5931\u8D25\uFF0C\u4F11\u7720 50ms, \u91CD\u65B0\u6267\u884C</p><p>\u200B 1.2 \u83B7\u53D6\u9501\u6210\u529F\uFF0C\u518D\u6B21\u67E5\u770B\u7F13\u5B58\u662F\u5426\u5B58\u5728\uFF0CDoubleCheck\uFF0C\u5B58\u5728\u5219\u65E0\u9700\u518D\u6784\u5EFA\u7F13\u5B58</p><p>2.\u67E5\u6570\u636E\u5E93\uFF0C\u5C06\u7F13\u5B58\u5199\u5230 redis \u4E2D</p><p>3.\u91CA\u653E\u9501 <code>del</code></p></blockquote><p>\u6838\u5FC3\u601D\u8DEF\uFF1A\u76F8\u8F83\u4E8E\u539F\u6765\u4ECE\u7F13\u5B58\u4E2D\u67E5\u8BE2\u4E0D\u5230\u6570\u636E\u540E\u76F4\u63A5\u67E5\u8BE2\u6570\u636E\u5E93\u800C\u8A00\uFF0C\u73B0\u5728\u7684\u65B9\u6848\u662F \u8FDB\u884C\u67E5\u8BE2\u4E4B\u540E\uFF0C\u5982\u679C\u4ECE\u7F13\u5B58\u6CA1\u6709\u67E5\u8BE2\u5230\u6570\u636E\uFF0C\u5219\u8FDB\u884C\u4E92\u65A5\u9501\u7684\u83B7\u53D6\uFF0C\u83B7\u53D6\u4E92\u65A5\u9501\u540E\uFF0C\u5224\u65AD\u662F\u5426\u83B7\u5F97\u5230\u4E86\u9501\uFF0C\u5982\u679C\u6CA1\u6709\u83B7\u5F97\u5230\uFF0C\u5219\u4F11\u7720\uFF0C\u8FC7\u4E00\u4F1A\u518D\u8FDB\u884C\u5C1D\u8BD5\uFF0C\u76F4\u5230\u83B7\u53D6\u5230\u9501\u4E3A\u6B62\uFF0C\u624D\u80FD\u8FDB\u884C\u67E5\u8BE2</p><p>\u5982\u679C\u83B7\u53D6\u5230\u4E86\u9501\u7684\u7EBF\u7A0B\uFF0C\u518D\u53BB\u8FDB\u884C\u67E5\u8BE2\uFF0C\u67E5\u8BE2\u540E\u5C06\u6570\u636E\u5199\u5165redis\uFF0C\u518D\u91CA\u653E\u9501\uFF0C\u8FD4\u56DE\u6570\u636E\uFF0C\u5229\u7528\u4E92\u65A5\u9501\u5C31\u80FD\u4FDD\u8BC1\u53EA\u6709\u4E00\u4E2A\u7EBF\u7A0B\u53BB\u6267\u884C\u64CD\u4F5C\u6570\u636E\u5E93\u7684\u903B\u8F91\uFF0C\u9632\u6B62\u7F13\u5B58\u51FB\u7A7F</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653357860001.png" alt="1653357860001"></p><p><strong>\u64CD\u4F5C\u9501\u7684\u4EE3\u7801\uFF1A</strong></p><p>\u6838\u5FC3\u601D\u8DEF\u5C31\u662F\u5229\u7528redis\u7684setnx\u65B9\u6CD5\u6765\u8868\u793A\u83B7\u53D6\u9501\uFF0C\u8BE5\u65B9\u6CD5\u542B\u4E49\u662Fredis\u4E2D\u5982\u679C\u6CA1\u6709\u8FD9\u4E2Akey\uFF0C\u5219\u63D2\u5165\u6210\u529F\uFF0C\u8FD4\u56DE1\uFF0C\u5728stringRedisTemplate\u4E2D\u8FD4\u56DEtrue\uFF0C \u5982\u679C\u6709\u8FD9\u4E2Akey\u5219\u63D2\u5165\u5931\u8D25\uFF0C\u5219\u8FD4\u56DE0\uFF0C\u5728stringRedisTemplate\u8FD4\u56DEfalse\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7true\uFF0C\u6216\u8005\u662Ffalse\uFF0C\u6765\u8868\u793A\u662F\u5426\u6709\u7EBF\u7A0B\u6210\u529F\u63D2\u5165key\uFF0C\u6210\u529F\u63D2\u5165\u7684key\u7684\u7EBF\u7A0B\u6211\u4EEC\u8BA4\u4E3A\u4ED6\u5C31\u662F\u83B7\u5F97\u5230\u9501\u7684\u7EBF\u7A0B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// \u83B7\u53D6\u9501</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u91CA\u653E\u9501</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u64CD\u4F5C\u4EE3\u7801\uFF1A</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>	<span class="token doc-comment comment">/**
     * \u4F7F\u7528\u4E92\u65A5\u9501\u89E3\u51B3 \u7F13\u5B58\u51FB\u7A7F \u95EE\u9898
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryWithMutex</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u5224\u65AD redis \u662F\u5426\u6709 \u7F13\u5B58</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2. \u5B58\u5728\u5219\u76F4\u63A5\u8FD4\u56DE</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u5224\u65AD\u662F\u5426\u4E3A \u7A7A\u5B57\u7B26\u4E32</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopJson <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3. \u7F13\u5B58\u4E0D\u5B58\u5728\uFF0C\u83B7\u53D6\u9501</span>
            lockKey <span class="token operator">=</span> <span class="token string">&quot;lock:shop:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 4. \u83B7\u53D6\u9501\u5931\u8D25\uFF0C\u4F11\u7720 50ms, \u91CD\u65B0\u6267\u884C</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">queryWithMutex</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 5. \u83B7\u53D6\u9501\u6210\u529F\uFF0C\u518D\u6B21\u67E5\u770B\u7F13\u5B58\u662F\u5426\u5B58\u5728\uFF0CDoubleCheck\uFF0C\u5B58\u5728\u5219\u65E0\u9700\u518D\u6784\u5EFA\u7F13\u5B58</span>
            shopJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 5.1 \u5B58\u5728\u5219\u76F4\u63A5\u8FD4\u56DE</span>
                <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 6.\u4ECE\u6570\u636E\u5E93\u4E2D\u67E5\u51FA\u5546\u94FA\u4FE1\u606F</span>
            shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u6A21\u62DF\u91CD\u5EFA\u65F6\u95F4</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 7. \u4E0D\u5B58\u5728</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u7F13\u5B58 \u7A7A\u503C\uFF0C\u5E76\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\u4E3A 2 \u5206\u949F</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 8.\u5C06\u5546\u94FA\u4FE1\u606F\u4FDD\u5B58\u5728 redis \u4E2D \`cache_shop: + id\`\uFF0C\u540C\u65F6\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// 9.\u91CA\u653E\u9501</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 10.\u8FD4\u56DE\u5546\u94FA\u4FE1\u606F</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-0-\u5229\u7528\u903B\u8F91\u8FC7\u671F\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_3-0-\u5229\u7528\u903B\u8F91\u8FC7\u671F\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898" aria-hidden="true">#</a> 3.0 \u5229\u7528\u903B\u8F91\u8FC7\u671F\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898</h3><blockquote><p>1.\u5224\u65AD\u7F13\u5B58\u662F\u5426\u5B58\u5728</p><p>2.\u4E0D\u5B58\u5728\uFF0C\u8FD4\u56DE\u7A7A</p><p>3.\u5B58\u5728\uFF0C\u4ECE redis \u4E2D\u53D6\u51FA\u6570\u636E</p><p>4.\u5224\u65AD\u662F\u5426\u8FC7\u671F</p><p>5.\u4E0D\u8FC7\u671F\uFF0C\u8FD4\u56DE\u6570\u636E</p><p>6.\u8FC7\u671F\uFF0C\u83B7\u5F97\u4E92\u65A5\u9501</p><p>\u200B 6.1 \u83B7\u53D6\u9501\u5931\u8D25\uFF0C\u8FD4\u56DE\u8FC7\u671F\u7684\u6570\u636E</p><p>\u200B 6.2 \u83B7\u53D6\u9501\u6210\u529F</p><p>\u200B 6.3 DoubleCheck\uFF0C\u5224\u65AD\u7F13\u5B58\u662F\u5426\u8FC7\u671F</p><p>\u200B 6.4 \u4E0D\u8FC7\u671F\uFF0C\u8FD4\u56DE\u6570\u636E</p><p>\u200B 6.5 \u8FC7\u671F\uFF0C\u5F00\u542F\u65B0\u7EBF\u7A0B\uFF0C\u91CD\u5EFA\u7F13\u5B58</p><p>\u200B 6.6 \u91CA\u653E\u9501</p><p>7.\u8FD4\u56DE\u8FC7\u671F\u6570\u636E</p></blockquote><p><strong>\u9700\u6C42\uFF1A\u4FEE\u6539\u6839\u636Eid\u67E5\u8BE2\u5546\u94FA\u7684\u4E1A\u52A1\uFF0C\u57FA\u4E8E\u903B\u8F91\u8FC7\u671F\u65B9\u5F0F\u6765\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898</strong></p><p>\u601D\u8DEF\u5206\u6790\uFF1A\u5F53\u7528\u6237\u5F00\u59CB\u67E5\u8BE2redis\u65F6\uFF0C\u5224\u65AD\u662F\u5426\u547D\u4E2D\uFF0C\u5982\u679C\u6CA1\u6709\u547D\u4E2D\u5219\u76F4\u63A5\u8FD4\u56DE\u7A7A\u6570\u636E\uFF0C\u4E0D\u67E5\u8BE2\u6570\u636E\u5E93\uFF0C\u800C\u4E00\u65E6\u547D\u4E2D\u540E\uFF0C\u5C06value\u53D6\u51FA\uFF0C\u5224\u65ADvalue\u4E2D\u7684\u8FC7\u671F\u65F6\u95F4\u662F\u5426\u6EE1\u8DB3\uFF0C\u5982\u679C\u6CA1\u6709\u8FC7\u671F\uFF0C\u5219\u76F4\u63A5\u8FD4\u56DEredis\u4E2D\u7684\u6570\u636E\uFF0C\u5982\u679C\u8FC7\u671F\uFF0C\u5219\u5728\u5F00\u542F\u72EC\u7ACB\u7EBF\u7A0B\u540E\u76F4\u63A5\u8FD4\u56DE\u4E4B\u524D\u7684\u6570\u636E\uFF0C\u72EC\u7ACB\u7EBF\u7A0B\u53BB\u91CD\u6784\u6570\u636E\uFF0C\u91CD\u6784\u5B8C\u6210\u540E\u91CA\u653E\u4E92\u65A5\u9501\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653360308731.png" alt="1653360308731"></p><p>\u5982\u679C\u5C01\u88C5\u6570\u636E\uFF1A\u56E0\u4E3A\u73B0\u5728redis\u4E2D\u5B58\u50A8\u7684\u6570\u636E\u7684value\u9700\u8981\u5E26\u4E0A\u8FC7\u671F\u65F6\u95F4\uFF0C\u6B64\u65F6\u8981\u4E48\u4F60\u53BB\u4FEE\u6539\u539F\u6765\u7684\u5B9E\u4F53\u7C7B\uFF0C\u8981\u4E48\u4F60</p><p><strong>\u6B65\u9AA4\u4E00\u3001</strong></p><p>\u65B0\u5EFA\u4E00\u4E2A\u5B9E\u4F53\u7C7B\uFF0C\u6211\u4EEC\u91C7\u7528\u7B2C\u4E8C\u4E2A\u65B9\u6848\uFF0C\u8FD9\u4E2A\u65B9\u6848\uFF0C\u5BF9\u539F\u6765\u4EE3\u7801\u6CA1\u6709\u4FB5\u5165\u6027\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisData</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> expireTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u6B65\u9AA4\u4E8C\u3001</strong></p><p><strong>IShopService</strong> \u4E2D\u6DFB\u52A0\u65B9\u6CD5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>	<span class="token doc-comment comment">/**
     * \u7F13\u5B58\u70ED\u70B9\u6570\u636E
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@param</span> <span class="token parameter">expireSeconds</span>
     */</span>
    <span class="token keyword">void</span> <span class="token function">saveShop2Redis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">Long</span> expireSeconds<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728<strong>ShopServiceImpl</strong> \u65B0\u589E\u6B64\u65B9\u6CD5\uFF0C\u5229\u7528\u5355\u5143\u6D4B\u8BD5\u8FDB\u884C\u7F13\u5B58\u9884\u70ED</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * \u7F13\u5B58\u70ED\u70B9\u6570\u636E
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@param</span> <span class="token parameter">expireSeconds</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveShop2Redis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">Long</span> expireSeconds<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u67E5\u6570\u636E\u5E93\uFF0C\u5F97\u5230\u5546\u94FA\u4FE1\u606F</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6A21\u62DF\u91CD\u5EFA\u65F6\u95F4</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5C01\u88C5\u8FC7\u671F\u65F6\u95F4</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.\u5C06\u70ED\u70B9\u6570\u636E\u5B58\u5165 redis \u4E2D</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u5728\u6D4B\u8BD5\u7C7B\u4E2D</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">HmDianPingApplicationTests</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IShopService</span> shopService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">saveShop2Redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        shopService<span class="token punctuation">.</span><span class="token function">saveShop2Redis</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B65\u9AA4\u4E09\uFF1A\u6B63\u5F0F\u4EE3\u7801</p><p><strong>ShopServiceImpl</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> CACHE_REBUILD_EXECUTOR <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryWithLogicalExpire</span><span class="token punctuation">(</span> <span class="token class-name">Long</span> id <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token comment">// 1.\u4ECEredis\u67E5\u8BE2\u5546\u94FA\u7F13\u5B58</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.\u5224\u65AD\u662F\u5426\u5B58\u5728</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.\u5B58\u5728\uFF0C\u76F4\u63A5\u8FD4\u56DE</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.\u547D\u4E2D\uFF0C\u9700\u8981\u5148\u628Ajson\u53CD\u5E8F\u5217\u5316\u4E3A\u5BF9\u8C61</span>
    <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LocalDateTime</span> expireTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.\u5224\u65AD\u662F\u5426\u8FC7\u671F</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>expireTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 5.1.\u672A\u8FC7\u671F\uFF0C\u76F4\u63A5\u8FD4\u56DE\u5E97\u94FA\u4FE1\u606F</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 5.2.\u5DF2\u8FC7\u671F\uFF0C\u9700\u8981\u7F13\u5B58\u91CD\u5EFA</span>
    <span class="token comment">// 6.\u7F13\u5B58\u91CD\u5EFA</span>
    <span class="token comment">// 6.1.\u83B7\u53D6\u4E92\u65A5\u9501</span>
    <span class="token class-name">String</span> lockKey <span class="token operator">=</span> LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 6.2.\u5224\u65AD\u662F\u5426\u83B7\u53D6\u9501\u6210\u529F</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 6.3 DoubleCheck\uFF0C\u5224\u65AD\u7F13\u5B58\u662F\u5426\u8FC7\u671F</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> expireTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.4 \u5224\u65AD\u662F\u5426\u8FC7\u671F</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>expireTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 6.5 \u672A\u8FC7\u671F\uFF0C\u76F4\u63A5\u8FD4\u56DE\u5E97\u94FA\u4FE1\u606F</span>
            <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 6.6 \u8FC7\u671F\uFF0C\u5F00\u542F\u65B0\u7EBF\u7A0B\uFF0C\u91CD\u5EFA\u7F13\u5B58</span>
        CACHE_REBUILD_EXECUTOR<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>

            <span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token comment">//\u91CD\u5EFA\u7F13\u5B58</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveShop2Redis</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">20L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// 6.6 \u91CA\u653E\u9501</span>
                <span class="token function">unlock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u83B7\u53D6\u9501\u5931\u8D25\uFF0C\u8FD4\u56DE\u8FC7\u671F\u7684\u6570\u636E</span>
    <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveShop2Redis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">Long</span> expireSeconds<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u67E5\u6570\u636E\u5E93\uFF0C\u5F97\u5230\u5546\u94FA\u4FE1\u606F</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6A21\u62DF\u91CD\u5EFA\u65F6\u95F4</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5C01\u88C5\u8FC7\u671F\u65F6\u95F4</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.\u5C06\u70ED\u70B9\u6570\u636E\u5B58\u5165 redis \u4E2D</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-\u5C01\u88C5redis\u5DE5\u5177\u7C7B" tabindex="-1"><a class="header-anchor" href="#_3-1-\u5C01\u88C5redis\u5DE5\u5177\u7C7B" aria-hidden="true">#</a> 3.1 \u5C01\u88C5Redis\u5DE5\u5177\u7C7B</h3><p>\u57FA\u4E8EStringRedisTemplate\u5C01\u88C5\u4E00\u4E2A\u7F13\u5B58\u5DE5\u5177\u7C7B\uFF0C\u6EE1\u8DB3\u4E0B\u5217\u9700\u6C42\uFF1A</p><ul><li><p>\u65B9\u6CD51\uFF1A\u5C06\u4EFB\u610FJava\u5BF9\u8C61\u5E8F\u5217\u5316\u4E3Ajson\u5E76\u5B58\u50A8\u5728string\u7C7B\u578B\u7684key\u4E2D\uFF0C\u5E76\u4E14\u53EF\u4EE5\u8BBE\u7F6ETTL\u8FC7\u671F\u65F6\u95F4</p></li><li><p>\u65B9\u6CD52\uFF1A\u5C06\u4EFB\u610FJava\u5BF9\u8C61\u5E8F\u5217\u5316\u4E3Ajson\u5E76\u5B58\u50A8\u5728string\u7C7B\u578B\u7684key\u4E2D\uFF0C\u5E76\u4E14\u53EF\u4EE5\u8BBE\u7F6E\u903B\u8F91\u8FC7\u671F\u65F6\u95F4\uFF0C\u7528\u4E8E\u5904\u7406\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898</p></li><li><p>\u65B9\u6CD53\uFF1A\u6839\u636E\u6307\u5B9A\u7684key\u67E5\u8BE2\u7F13\u5B58\uFF0C\u5E76\u53CD\u5E8F\u5217\u5316\u4E3A\u6307\u5B9A\u7C7B\u578B\uFF0C\u5229\u7528\u7F13\u5B58\u7A7A\u503C\u7684\u65B9\u5F0F\u89E3\u51B3\u7F13\u5B58\u7A7F\u900F\u95EE\u9898</p></li><li><p>\u65B9\u6CD54\uFF1A\u6839\u636E\u6307\u5B9A\u7684key\u67E5\u8BE2\u7F13\u5B58\uFF0C\u5E76\u53CD\u5E8F\u5217\u5316\u4E3A\u6307\u5B9A\u7C7B\u578B\uFF0C\u9700\u8981\u5229\u7528\u903B\u8F91\u8FC7\u671F\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898</p></li></ul><p>\u5C06\u903B\u8F91\u8FDB\u884C\u5C01\u88C5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">BooleanUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Function</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Redis \u5DE5\u5177\u7C7B
 * <span class="token keyword">@author</span> hzz
 * <span class="token keyword">@create</span> 2022-07-27 15:25
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheClient</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token comment">// \u7EBF\u7A0B\u6C60</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> CACHE_REBUILD_EXECUTOR <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u5C06\u4EFB\u610FJava\u5BF9\u8C61\u5E8F\u5217\u5316\u4E3Ajson\u5E76\u5B58\u50A8\u5728string\u7C7B\u578B\u7684key\u4E2D\uFF0C\u5E76\u4E14\u53EF\u4EE5\u8BBE\u7F6ETTL\u8FC7\u671F\u65F6\u95F4
     * <span class="token keyword">@param</span> <span class="token parameter">key</span>
     * <span class="token keyword">@param</span> <span class="token parameter">value</span>
     * <span class="token keyword">@param</span> <span class="token parameter">time</span>
     * <span class="token keyword">@param</span> <span class="token parameter">unit</span>
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * \u5C06\u4EFB\u610FJava\u5BF9\u8C61\u5E8F\u5217\u5316\u4E3Ajson\u5E76\u5B58\u50A8\u5728string\u7C7B\u578B\u7684key\u4E2D\uFF0C\u5E76\u4E14\u53EF\u4EE5\u8BBE\u7F6E\u903B\u8F91\u8FC7\u671F\u65F6\u95F4\uFF0C\u7528\u4E8E\u5904\u7406\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898
     * <span class="token keyword">@param</span> <span class="token parameter">key</span>
     * <span class="token keyword">@param</span> <span class="token parameter">value</span>
     * <span class="token keyword">@param</span> <span class="token parameter">time</span>
     * <span class="token keyword">@param</span> <span class="token parameter">unit</span>
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u6839\u636E\u6307\u5B9A\u7684key\u67E5\u8BE2\u7F13\u5B58\uFF0C\u5E76\u53CD\u5E8F\u5217\u5316\u4E3A\u6307\u5B9A\u7C7B\u578B\uFF0C\u5229\u7528\u7F13\u5B58\u7A7A\u503C\u7684\u65B9\u5F0F\u89E3\u51B3\u7F13\u5B58\u7A7F\u900F\u95EE\u9898
     * <span class="token keyword">@param</span> <span class="token parameter">keyPrefix</span>
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@param</span> <span class="token parameter">type</span>
     * <span class="token keyword">@param</span> <span class="token parameter">dbFallback</span>
     * <span class="token keyword">@param</span> <span class="token parameter">time</span>
     * <span class="token keyword">@param</span> <span class="token parameter">unit</span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">&gt;</span></span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">queryWithPassThrough</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> dbFallback<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u5224\u65AD redis \u662F\u5426\u6709 \u5546\u6237\u7F13\u5B58</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.1 \u5B58\u5728\u5219\u76F4\u63A5\u8FD4\u56DE</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u5224\u65AD\u662F\u5426\u4E3A \u7A7A\u503C</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>json <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.\u4ECE\u6570\u636E\u5E93\u4E2D\u67E5\u51FA\u5546\u94FA\u4FE1\u606F</span>
        <span class="token class-name">R</span> r <span class="token operator">=</span> dbFallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.1 \u4E0D\u5B58\u5728\u62A5\u9519</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u7F13\u5B58 \u7A7A\u503C\uFF0C\u5E76\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\u4E3A 2\u5206\u949F</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u5C06\u5546\u94FA\u4FE1\u606F\u4FDD\u5B58\u5728 redis \u4E2D \`cache_shop: + id\`\uFF0C\u540C\u65F6\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u8FD4\u56DE\u5546\u94FA\u4FE1\u606F</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * \u6839\u636E\u6307\u5B9A\u7684key\u67E5\u8BE2\u7F13\u5B58\uFF0C\u5E76\u53CD\u5E8F\u5217\u5316\u4E3A\u6307\u5B9A\u7C7B\u578B\uFF0C\u9700\u8981\u5229\u7528\u903B\u8F91\u8FC7\u671F\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F\u95EE\u9898
     * <span class="token keyword">@param</span> <span class="token parameter">keyPrefix</span>
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@param</span> <span class="token parameter">type</span>
     * <span class="token keyword">@param</span> <span class="token parameter">dbFallback</span>
     * <span class="token keyword">@param</span> <span class="token parameter">time</span>
     * <span class="token keyword">@param</span> <span class="token parameter">unit</span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">&gt;</span></span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">queryWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> dbFallback<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u5224\u65AD\u7F13\u5B58\u662F\u5426\u5B58\u5728</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.\u4E0D\u5B58\u5728\uFF0C\u8FD4\u56DE\u7A7A</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u5B58\u5728\uFF0C\u4ECE redis \u4E2D\u53D6\u51FA\u6570\u636E</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u5224\u65AD\u662F\u5426\u8FC7\u671F</span>
        <span class="token class-name">LocalDateTime</span> expireTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">R</span> r <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expireTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 5.\u4E0D\u8FC7\u671F\uFF0C\u8FD4\u56DE\u6570\u636E</span>
            <span class="token keyword">return</span> r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 6.\u8FC7\u671F\uFF0C\u83B7\u5F97\u4E92\u65A5\u9501</span>
        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 6.2 \u83B7\u53D6\u9501\u6210\u529F</span>
            <span class="token comment">// 6.3 DoubleCheck\uFF0C\u5224\u65AD\u7F13\u5B58\u662F\u5426\u8FC7\u671F</span>
            redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            expireTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>expireTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 6.4 \u4E0D\u8FC7\u671F\uFF0C\u8FD4\u56DE\u6570\u636E</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 6.5 \u8FC7\u671F\uFF0C\u5F00\u542F\u65B0\u7EBF\u7A0B\uFF0C\u91CD\u5EFA\u7F13\u5B58</span>
            CACHE_REBUILD_EXECUTOR<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// \u91CD\u5EFA\u7F13\u5B58</span>
                    <span class="token class-name">R</span> r1 <span class="token operator">=</span> dbFallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setWithLogicalExpire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> r1<span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 6.6 \u91CA\u653E\u9501</span>
                    <span class="token function">unlock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 6.1 \u83B7\u53D6\u9501\u5931\u8D25\uFF0C\u8FD4\u56DE\u8FC7\u671F\u7684\u6570\u636E</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u83B7\u53D6\u4E92\u65A5\u9501
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Boolean</span> isLock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> LOCK_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u91CA\u653E\u9501
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728ShopServiceImpl \u4E2D</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>	
 	<span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CacheClient</span> cacheClient<span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
     * \u6839\u636Eid\u67E5\u8BE2\u5546\u94FA\u4FE1\u606F
     *
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> \u5546\u94FAid
     * <span class="token keyword">@return</span> \u5546\u94FA\u8BE6\u60C5\u6570\u636E
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u7F13\u5B58\u7A7F\u900F</span>
        <span class="token comment">// Shop shop = queryWithPassThrough(id);</span>

        <span class="token comment">// \u4E92\u65A5\u9501\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F</span>
        <span class="token comment">// Shop shop = queryWithMutex(id);</span>

        <span class="token comment">// \u903B\u8F91\u8FC7\u671F\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F</span>
        <span class="token comment">// Shop shop = queryWithLogicalExpire(id);</span>

        <span class="token comment">// \u7F13\u5B58\u7A7F\u900F</span>
        <span class="token comment">// Shop shop = cacheClient.queryWithPassThrough(CACHE_SHOP_KEY, id, Shop.class, this::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span>

        <span class="token comment">// \u903B\u8F91\u8FC7\u671F\u89E3\u51B3\u7F13\u5B58\u51FB\u7A7F</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> cacheClient<span class="token punctuation">.</span><span class="token function">queryWithLogicalExpire</span><span class="token punctuation">(</span>CACHE_SHOP_KEY<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getById</span><span class="token punctuation">,</span> <span class="token number">20L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5546\u94FA\u4E0D\u5B58\u5728&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3\u3001\u4F18\u60E0\u5377\u79D2\u6740" tabindex="-1"><a class="header-anchor" href="#_3\u3001\u4F18\u60E0\u5377\u79D2\u6740" aria-hidden="true">#</a> 3\u3001\u4F18\u60E0\u5377\u79D2\u6740</h2><h3 id="_3-1-\u5168\u5C40\u552F\u4E00id" tabindex="-1"><a class="header-anchor" href="#_3-1-\u5168\u5C40\u552F\u4E00id" aria-hidden="true">#</a> 3.1 -\u5168\u5C40\u552F\u4E00ID</h3><p>\u6BCF\u4E2A\u5E97\u94FA\u90FD\u53EF\u4EE5\u53D1\u5E03\u4F18\u60E0\u5238\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653362612286.png" alt="1653362612286"></p><p>\u5F53\u7528\u6237\u62A2\u8D2D\u65F6\uFF0C\u5C31\u4F1A\u751F\u6210\u8BA2\u5355\u5E76\u4FDD\u5B58\u5230tb_voucher_order\u8FD9\u5F20\u8868\u4E2D\uFF0C\u800C\u8BA2\u5355\u8868\u5982\u679C\u4F7F\u7528\u6570\u636E\u5E93\u81EA\u589EID\u5C31\u5B58\u5728\u4E00\u4E9B\u95EE\u9898\uFF1A</p><ul><li>id\u7684\u89C4\u5F8B\u6027\u592A\u660E\u663E</li><li>\u53D7\u5355\u8868\u6570\u636E\u91CF\u7684\u9650\u5236</li></ul><p>\u573A\u666F\u5206\u6790\uFF1A\u5982\u679C\u6211\u4EEC\u7684<code>id\u5177\u6709\u592A\u660E\u663E</code>\u7684\u89C4\u5219\uFF0C\u7528\u6237\u6216\u8005\u8BF4\u5546\u4E1A\u5BF9\u624B\u5F88\u5BB9\u6613\u731C\u6D4B\u51FA\u6765\u6211\u4EEC\u7684\u4E00\u4E9B\u654F\u611F\u4FE1\u606F\uFF0C\u6BD4\u5982\u5546\u57CE\u5728\u4E00\u5929\u65F6\u95F4\u5185\uFF0C\u5356\u51FA\u4E86\u591A\u5C11\u5355\uFF0C\u8FD9\u660E\u663E\u4E0D\u5408\u9002\u3002</p><p>\u573A\u666F\u5206\u6790\u4E8C\uFF1A\u968F\u7740\u6211\u4EEC\u5546\u57CE\u89C4\u6A21\u8D8A\u6765\u8D8A\u5927\uFF0Cmysql\u7684\u5355\u8868\u7684\u5BB9\u91CF\u4E0D\u5B9C\u8D85\u8FC7500W\uFF0C\u6570\u636E\u91CF\u8FC7\u5927\u4E4B\u540E\uFF0C\u6211\u4EEC\u8981\u8FDB\u884C\u62C6\u5E93\u62C6\u8868\uFF0C\u4F46\u62C6\u5206\u8868\u4E86\u4E4B\u540E\uFF0C\u4ED6\u4EEC\u4ECE\u903B\u8F91\u4E0A\u8BB2\u4ED6\u4EEC\u662F\u540C\u4E00\u5F20\u8868\uFF0C\u6240\u4EE5\u4ED6\u4EEC\u7684id\u662F\u4E0D\u80FD\u4E00\u6837\u7684\uFF0C \u4E8E\u662F\u4E4E\u6211\u4EEC\u9700\u8981\u4FDD\u8BC1id\u7684\u552F\u4E00\u6027\u3002</p><p><strong>\u5168\u5C40ID\u751F\u6210\u5668</strong>\uFF0C\u662F\u4E00\u79CD\u5728\u5206\u5E03\u5F0F\u7CFB\u7EDF\u4E0B\u7528\u6765\u751F\u6210\u5168\u5C40\u552F\u4E00ID\u7684\u5DE5\u5177\uFF0C\u4E00\u822C\u8981\u6EE1\u8DB3\u4E0B\u5217\u7279\u6027\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653363100502.png" alt="1653363100502"></p><p>\u4E3A\u4E86<code>\u589E\u52A0ID\u7684\u5B89\u5168\u6027</code>\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4E0D\u76F4\u63A5\u4F7F\u7528Redis\u81EA\u589E\u7684\u6570\u503C\uFF0C\u800C\u662F\u62FC\u63A5\u4E00\u4E9B\u5176\u5B83\u4FE1\u606F\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653363172079.png" alt="1653363172079"></p><p>ID\u7684\u7EC4\u6210\u90E8\u5206\uFF1A\u7B26\u53F7\u4F4D\uFF1A1bit\uFF0C\u6C38\u8FDC\u4E3A0</p><p>\u65F6\u95F4\u6233\uFF1A31bit\uFF0C\u4EE5\u79D2\u4E3A\u5355\u4F4D\uFF0C\u53EF\u4EE5\u4F7F\u752869\u5E74</p><p>\u5E8F\u5217\u53F7\uFF1A32bit\uFF0C\u79D2\u5185\u7684\u8BA1\u6570\u5668\uFF0C\u652F\u6301\u6BCF\u79D2\u4EA7\u751F2^32\u4E2A\u4E0D\u540CID</p><h3 id="_3-2-redis\u5B9E\u73B0\u5168\u5C40\u552F\u4E00id" tabindex="-1"><a class="header-anchor" href="#_3-2-redis\u5B9E\u73B0\u5168\u5C40\u552F\u4E00id" aria-hidden="true">#</a> 3.2 -Redis\u5B9E\u73B0\u5168\u5C40\u552F\u4E00Id</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisIdWorker</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * \u5F00\u59CB\u65F6\u95F4\u6233
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> BEGIN_TIMESTAMP <span class="token operator">=</span> <span class="token number">1640995200L</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * \u5E8F\u5217\u53F7\u7684\u4F4D\u6570
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNT_BITS <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisIdWorker</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u751F\u6210\u65F6\u95F4\u6233</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> nowSecond <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> nowSecond <span class="token operator">-</span> BEGIN_TIMESTAMP<span class="token punctuation">;</span>

        <span class="token comment">// 2.\u751F\u6210\u5E8F\u5217\u53F7</span>
        <span class="token comment">// 2.1.\u83B7\u53D6\u5F53\u524D\u65E5\u671F\uFF0C\u7CBE\u786E\u5230\u5929</span>
        <span class="token class-name">String</span> date <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy:MM:dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.2.\u81EA\u589E\u957F</span>
        <span class="token keyword">long</span> count <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">&quot;icr:&quot;</span> <span class="token operator">+</span> keyPrefix <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.\u62FC\u63A5\u5E76\u8FD4\u56DE</span>
        <span class="token keyword">return</span> timestamp <span class="token operator">&lt;&lt;</span> COUNT_BITS <span class="token operator">|</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>long count = stringRedisTemplate.opsForValue().increment(&quot;icr:&quot; + keyPrefix + &quot;:&quot; + date);</p><p>\u4F18\u70B9\uFF1A</p><p>1.\u4E00\u5929\u4E00\u4E2A key\uFF0C \u9632\u6B62 key \u8FC7\u5927\uFF0C\u8D85\u8FC7\u9650\u5236</p><p>2.\u53EF\u4EE5\u8FDB\u884C\u7EDF\u8BA1</p></blockquote><p>\u6D4B\u8BD5\u7C7B</p><p>\u77E5\u8BC6\u5C0F\u8D34\u58EB\uFF1A\u5173\u4E8E <code>countdownlatch</code></p><p>countdownlatch\u540D\u4E3A\u4FE1\u53F7\u67AA\uFF1A\u4E3B\u8981\u7684\u4F5C\u7528\u662F<code>\u540C\u6B65\u534F\u8C03\u5728\u591A\u7EBF\u7A0B\u7684\u7B49\u5F85\u4E8E\u5524\u9192\u95EE\u9898</code></p><p>\u6211\u4EEC\u5982\u679C\u6CA1\u6709CountDownLatch \uFF0C\u90A3\u4E48\u7531\u4E8E\u7A0B\u5E8F\u662F\u5F02\u6B65\u7684\uFF0C\u5F53\u5F02\u6B65\u7A0B\u5E8F\u6CA1\u6709\u6267\u884C\u5B8C\u65F6\uFF0C\u4E3B\u7EBF\u7A0B\u5C31\u5DF2\u7ECF\u6267\u884C\u5B8C\u4E86\uFF0C\u7136\u540E\u6211\u4EEC\u671F\u671B\u7684\u662F\u5206\u7EBF\u7A0B\u5168\u90E8\u8D70\u5B8C\u4E4B\u540E\uFF0C\u4E3B\u7EBF\u7A0B\u518D\u8D70\uFF0C\u6240\u4EE5\u6211\u4EEC\u6B64\u65F6\u9700\u8981\u4F7F\u7528\u5230CountDownLatch</p><p>CountDownLatch \u4E2D\u6709\u4E24\u4E2A\u6700\u91CD\u8981\u7684\u65B9\u6CD5</p><p>1\u3001<code>countDown</code></p><p>2\u3001<code>await</code></p><p>await \u65B9\u6CD5 \u662F\u963B\u585E\u65B9\u6CD5\uFF0C\u6211\u4EEC\u62C5\u5FC3\u5206\u7EBF\u7A0B\u6CA1\u6709\u6267\u884C\u5B8C\u65F6\uFF0Cmain\u7EBF\u7A0B\u5C31\u5148\u6267\u884C\uFF0C\u6240\u4EE5\u4F7F\u7528await\u53EF\u4EE5\u8BA9main\u7EBF\u7A0B\u963B\u585E\uFF0C\u90A3\u4E48\u4EC0\u4E48\u65F6\u5019main\u7EBF\u7A0B\u4E0D\u518D\u963B\u585E\u5462\uFF1F\u5F53CountDownLatch \u5185\u90E8\u7EF4\u62A4\u7684 \u53D8\u91CF\u53D8\u4E3A0\u65F6\uFF0C\u5C31\u4E0D\u518D\u963B\u585E\uFF0C\u76F4\u63A5\u653E\u884C\uFF0C\u90A3\u4E48\u4EC0\u4E48\u65F6\u5019CountDownLatch \u7EF4\u62A4\u7684\u53D8\u91CF\u53D8\u4E3A0 \u5462\uFF0C\u6211\u4EEC\u53EA\u9700\u8981\u8C03\u7528\u4E00\u6B21countDown \uFF0C\u5185\u90E8\u53D8\u91CF\u5C31\u51CF\u5C111\uFF0C\u6211\u4EEC\u8BA9\u5206\u7EBF\u7A0B\u548C\u53D8\u91CF\u7ED1\u5B9A\uFF0C \u6267\u884C\u5B8C\u4E00\u4E2A\u5206\u7EBF\u7A0B\u5C31\u51CF\u5C11\u4E00\u4E2A\u53D8\u91CF\uFF0C\u5F53\u5206\u7EBF\u7A0B\u5168\u90E8\u8D70\u5B8C\uFF0CCountDownLatch \u7EF4\u62A4\u7684\u53D8\u91CF\u5C31\u662F0\uFF0C\u6B64\u65F6await\u5C31\u4E0D\u518D\u963B\u585E\uFF0C<code>\u7EDF\u8BA1\u51FA\u6765\u7684\u65F6\u95F4\u4E5F\u5C31\u662F\u6240\u6709\u5206\u7EBF\u7A0B\u6267\u884C\u5B8C\u540E\u7684\u65F6\u95F4</code>\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> es <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testIdWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> id <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;id = &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        es<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;time = &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-\u6DFB\u52A0\u4F18\u60E0\u5377" tabindex="-1"><a class="header-anchor" href="#_3-3-\u6DFB\u52A0\u4F18\u60E0\u5377" aria-hidden="true">#</a> 3.3 \u6DFB\u52A0\u4F18\u60E0\u5377</h3><p>\u6BCF\u4E2A\u5E97\u94FA\u90FD\u53EF\u4EE5\u53D1\u5E03\u4F18\u60E0\u5238\uFF0C\u5206\u4E3A\u5E73\u4EF7\u5238\u548C\u7279\u4EF7\u5238\u3002\u5E73\u4EF7\u5238\u53EF\u4EE5\u4EFB\u610F\u8D2D\u4E70\uFF0C\u800C\u7279\u4EF7\u5238\u9700\u8981\u79D2\u6740\u62A2\u8D2D\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653365145124.png" alt="1653365145124"></p><p>tb_voucher\uFF1A\u4F18\u60E0\u5238\u7684\u57FA\u672C\u4FE1\u606F\uFF0C\u4F18\u60E0\u91D1\u989D\u3001\u4F7F\u7528\u89C4\u5219\u7B49 tb_seckill_voucher\uFF1A\u4F18\u60E0\u5238\u7684\u5E93\u5B58\u3001\u5F00\u59CB\u62A2\u8D2D\u65F6\u95F4\uFF0C\u7ED3\u675F\u62A2\u8D2D\u65F6\u95F4\u3002\u7279\u4EF7\u4F18\u60E0\u5238\u624D\u9700\u8981\u586B\u5199\u8FD9\u4E9B\u4FE1\u606F</p><p>\u5E73\u4EF7\u5377\u7531\u4E8E\u4F18\u60E0\u529B\u5EA6\u5E76\u4E0D\u662F\u5F88\u5927\uFF0C\u6240\u4EE5\u662F\u53EF\u4EE5\u4EFB\u610F\u9886\u53D6</p><p>\u800C\u4EE3\u91D1\u5238\u7531\u4E8E\u4F18\u60E0\u529B\u5EA6\u5927\uFF0C\u6240\u4EE5\u50CF\u7B2C\u4E8C\u79CD\u5377\uFF0C\u5C31\u5F97\u9650\u5236\u6570\u91CF\uFF0C\u4ECE\u8868\u7ED3\u6784\u4E0A\u4E5F\u80FD\u770B\u51FA\uFF0C\u7279\u4EF7\u5377\u9664\u4E86\u5177\u6709\u4F18\u60E0\u5377\u7684\u57FA\u672C\u4FE1\u606F\u4EE5\u5916\uFF0C\u8FD8\u5177\u6709\u5E93\u5B58\uFF0C\u62A2\u8D2D\u65F6\u95F4\uFF0C\u7ED3\u675F\u65F6\u95F4\u7B49\u7B49\u5B57\u6BB5</p><p>**\u65B0\u589E\u666E\u901A\u5377\u4EE3\u7801\uFF1A **VoucherController</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">addVoucher</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Voucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    voucherService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u65B0\u589E\u79D2\u6740\u5377\u4EE3\u7801\uFF1A</strong></p><p><strong>VoucherController</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;seckill&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">addSeckillVoucher</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Voucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    voucherService<span class="token punctuation">.</span><span class="token function">addSeckillVoucher</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>VoucherServiceImpl</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSeckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Voucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u4FDD\u5B58\u4F18\u60E0\u5238</span>
    <span class="token function">save</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u4FDD\u5B58\u79D2\u6740\u4FE1\u606F</span>
    <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillVoucher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setStock</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setBeginTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucherService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u4FDD\u5B58\u79D2\u6740\u5E93\u5B58\u5230Redis\u4E2D</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>SECKILL_STOCK_KEY <span class="token operator">+</span> voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-\u5B9E\u73B0\u79D2\u6740\u4E0B\u5355" tabindex="-1"><a class="header-anchor" href="#_3-4-\u5B9E\u73B0\u79D2\u6740\u4E0B\u5355" aria-hidden="true">#</a> 3.4 \u5B9E\u73B0\u79D2\u6740\u4E0B\u5355</h3><blockquote><p>1.\u6839\u636E id \u67E5\u8BE2\u4F18\u60E0\u5238\u4FE1\u606F</p><p>2.\u5224\u65AD\u79D2\u6740\u662F\u5426\u5F00\u59CB</p><p>3.\u5224\u65AD\u79D2\u6740\u662F\u5426\u7ED3\u675F</p><p>4.\u5224\u65AD\u5E93\u5B58\u662F\u5426\u5145\u8DB3</p><p>5.\u6263\u51CF\u5E93\u5B58</p><p>6.\u521B\u5EFA\u8BA2\u5355</p><p>\u200B 6.1 \u7528\u6237id</p><p>\u200B 6.2 \u8BA2\u5355id</p><p>\u200B 6.3 \u4F18\u60E0\u5238id</p><p>7.\u8FD4\u56DE\u8BA2\u5355\u53F7</p></blockquote><p>\u4E0B\u5355\u6838\u5FC3\u601D\u8DEF\uFF1A\u5F53\u6211\u4EEC\u70B9\u51FB\u62A2\u8D2D\u65F6\uFF0C\u4F1A\u89E6\u53D1\u53F3\u4FA7\u7684\u8BF7\u6C42\uFF0C\u6211\u4EEC\u53EA\u9700\u8981\u7F16\u5199\u5BF9\u5E94\u7684controller\u5373\u53EF</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653365839526.png" alt="1653365839526"></p><p>\u79D2\u6740\u4E0B\u5355\u5E94\u8BE5\u601D\u8003\u7684\u5185\u5BB9\uFF1A</p><p>\u4E0B\u5355\u65F6\u9700\u8981\u5224\u65AD\u4E24\u70B9\uFF1A</p><ul><li>\u79D2\u6740\u662F\u5426\u5F00\u59CB\u6216\u7ED3\u675F\uFF0C\u5982\u679C\u5C1A\u672A\u5F00\u59CB\u6216\u5DF2\u7ECF\u7ED3\u675F\u5219\u65E0\u6CD5\u4E0B\u5355</li><li>\u5E93\u5B58\u662F\u5426\u5145\u8DB3\uFF0C\u4E0D\u8DB3\u5219\u65E0\u6CD5\u4E0B\u5355</li></ul><p>\u4E0B\u5355\u6838\u5FC3\u903B\u8F91\u5206\u6790\uFF1A</p><p>\u5F53\u7528\u6237\u5F00\u59CB\u8FDB\u884C\u4E0B\u5355\uFF0C\u6211\u4EEC\u5E94\u5F53\u53BB\u67E5\u8BE2\u4F18\u60E0\u5377\u4FE1\u606F\uFF0C\u67E5\u8BE2\u5230\u4F18\u60E0\u5377\u4FE1\u606F\uFF0C\u5224\u65AD\u662F\u5426\u6EE1\u8DB3\u79D2\u6740\u6761\u4EF6</p><p>\u6BD4\u5982\u65F6\u95F4\u662F\u5426\u5145\u8DB3\uFF0C\u5982\u679C\u65F6\u95F4\u5145\u8DB3\uFF0C\u5219\u8FDB\u4E00\u6B65\u5224\u65AD\u5E93\u5B58\u662F\u5426\u8DB3\u591F\uFF0C\u5982\u679C\u4E24\u8005\u90FD\u6EE1\u8DB3\uFF0C\u5219\u6263\u51CF\u5E93\u5B58\uFF0C\u521B\u5EFA\u8BA2\u5355\uFF0C\u7136\u540E\u8FD4\u56DE\u8BA2\u5355id\uFF0C\u5982\u679C\u6709\u4E00\u4E2A\u6761\u4EF6\u4E0D\u6EE1\u8DB3\u5219\u76F4\u63A5\u7ED3\u675F\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653366238564.png" alt="1653366238564"></p><p>VoucherOrderServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token doc-comment comment">/**
     * \u79D2\u6740\u4E0B\u5355
     *
     * <span class="token keyword">@param</span> <span class="token parameter">voucherId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u6839\u636E id \u67E5\u8BE2\u4F18\u60E0\u5238\u4FE1\u606F</span>
        <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5224\u65AD\u79D2\u6740\u662F\u5426\u5F00\u59CB</span>
        <span class="token class-name">LocalDateTime</span> beginTime <span class="token operator">=</span> voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beginTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u79D2\u6740\u6D3B\u52A8\u5C1A\u672A\u5F00\u59CB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u5224\u65AD\u79D2\u6740\u662F\u5426\u7ED3\u675F</span>
        <span class="token class-name">LocalDateTime</span> endTime <span class="token operator">=</span> voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endTime<span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u79D2\u6740\u6D3B\u52A8\u5DF2\u7ECF\u7ED3\u675F&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.\u5224\u65AD\u5E93\u5B58\u662F\u5426\u5145\u8DB3</span>
        <span class="token class-name">Integer</span> stock <span class="token operator">=</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5.\u6263\u51CF\u5E93\u5B58</span>
        <span class="token comment">// \u6CE8\u610F\uFF1A\u8FD9\u6837\u5199\u662F\u9519\u8BEF\u7684\uFF0C\u56E0\u4E3A\u662F\u8986\u76D6\u7ED3\u679C</span>
        <span class="token comment">// voucher.setStock(stock - 1);</span>
        <span class="token comment">// seckillVoucherService.updateById(voucher);</span>
        <span class="token keyword">boolean</span> update <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 6.\u521B\u5EFA\u8BA2\u5355</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 	6.2 \u8BA2\u5355id</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 	6.1 \u7528\u6237id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 	6.3 \u4F18\u60E0\u5238id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7.\u8FD4\u56DE\u8BA2\u5355\u53F7</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-\u5E93\u5B58\u8D85\u5356\u95EE\u9898\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#_3-5-\u5E93\u5B58\u8D85\u5356\u95EE\u9898\u5206\u6790" aria-hidden="true">#</a> 3.5 \u5E93\u5B58\u8D85\u5356\u95EE\u9898\u5206\u6790</h3><p>\u6709\u5173\u8D85\u5356\u95EE\u9898\u5206\u6790\uFF1A\u5728\u6211\u4EEC\u539F\u6709\u4EE3\u7801\u4E2D\u662F\u8FD9\u4E48\u5199\u7684</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5E93\u5B58\u4E0D\u8DB3</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//5\uFF0C\u6263\u51CF\u5E93\u5B58</span>
    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock= stock -1&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u6263\u51CF\u5E93\u5B58</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5047\u8BBE\u7EBF\u7A0B1\u8FC7\u6765\u67E5\u8BE2\u5E93\u5B58\uFF0C\u5224\u65AD\u51FA\u6765\u5E93\u5B58\u5927\u4E8E1\uFF0C\u6B63\u51C6\u5907\u53BB\u6263\u51CF\u5E93\u5B58\uFF0C\u4F46\u662F\u8FD8\u6CA1\u6709\u6765\u5F97\u53CA\u53BB\u6263\u51CF\uFF0C\u6B64\u65F6\u7EBF\u7A0B2\u8FC7\u6765\uFF0C\u7EBF\u7A0B2\u4E5F\u53BB\u67E5\u8BE2\u5E93\u5B58\uFF0C\u53D1\u73B0\u8FD9\u4E2A\u6570\u91CF\u4E00\u5B9A\u4E5F\u5927\u4E8E1\uFF0C\u90A3\u4E48\u8FD9\u4E24\u4E2A\u7EBF\u7A0B\u90FD\u4F1A\u53BB\u6263\u51CF\u5E93\u5B58\uFF0C\u6700\u7EC8\u591A\u4E2A\u7EBF\u7A0B\u76F8\u5F53\u4E8E\u4E00\u8D77\u53BB\u6263\u51CF\u5E93\u5B58\uFF0C\u6B64\u65F6\u5C31\u4F1A\u51FA\u73B0\u5E93\u5B58\u7684\u8D85\u5356\u95EE\u9898\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653368335155.png" alt="1653368335155"></p><p>\u8D85\u5356\u95EE\u9898\u662F\u5178\u578B\u7684\u591A\u7EBF\u7A0B\u5B89\u5168\u95EE\u9898\uFF0C\u9488\u5BF9\u8FD9\u4E00\u95EE\u9898\u7684\u5E38\u89C1\u89E3\u51B3\u65B9\u6848\u5C31\u662F\u52A0\u9501\uFF1A\u800C\u5BF9\u4E8E\u52A0\u9501\uFF0C\u6211\u4EEC\u901A\u5E38\u6709\u4E24\u79CD\u89E3\u51B3\u65B9\u6848\uFF1A\u89C1\u4E0B\u56FE\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653368562591.png" alt="1653368562591"></p><p><strong>\u60B2\u89C2\u9501\uFF1A</strong></p><p>\u60B2\u89C2\u9501\u53EF\u4EE5\u5B9E\u73B0\u5BF9\u4E8E\u6570\u636E\u7684\u4E32\u884C\u5316\u6267\u884C\uFF0C\u6BD4\u5982syn\uFF0C\u548Clock\u90FD\u662F\u60B2\u89C2\u9501\u7684\u4EE3\u8868\uFF0C\u540C\u65F6\uFF0C\u60B2\u89C2\u9501\u4E2D\u53C8\u53EF\u4EE5\u518D\u7EC6\u5206\u4E3A\u516C\u5E73\u9501\uFF0C\u975E\u516C\u5E73\u9501\uFF0C\u53EF\u91CD\u5165\u9501\uFF0C\u7B49\u7B49</p><p><strong>\u4E50\u89C2\u9501\uFF1A</strong></p><p>\u4E50\u89C2\u9501\uFF1A\u4F1A\u6709\u4E00\u4E2A<code>\u7248\u672C\u53F7</code>\uFF0C\u6BCF\u6B21\u64CD\u4F5C\u6570\u636E\u4F1A\u5BF9\u7248\u672C\u53F7+1\uFF0C\u518D\u63D0\u4EA4\u56DE\u6570\u636E\u65F6\uFF0C\u4F1A\u53BB\u6821\u9A8C\u662F\u5426\u6BD4\u4E4B\u524D\u7684\u7248\u672C\u59271 \uFF0C\u5982\u679C\u59271 \uFF0C\u5219\u8FDB\u884C\u64CD\u4F5C\u6210\u529F\uFF0C\u8FD9\u5957\u673A\u5236\u7684\u6838\u5FC3\u903B\u8F91\u5728\u4E8E\uFF0C\u5982\u679C\u5728\u64CD\u4F5C\u8FC7\u7A0B\u4E2D\uFF0C\u7248\u672C\u53F7\u53EA\u6BD4\u539F\u6765\u59271 \uFF0C\u90A3\u4E48\u5C31\u610F\u5473\u7740\u64CD\u4F5C\u8FC7\u7A0B\u4E2D\u6CA1\u6709\u4EBA\u5BF9\u4ED6\u8FDB\u884C\u8FC7\u4FEE\u6539\uFF0C\u4ED6\u7684\u64CD\u4F5C\u5C31\u662F\u5B89\u5168\u7684\uFF0C\u5982\u679C\u4E0D\u59271\uFF0C\u5219\u6570\u636E\u88AB\u4FEE\u6539\u8FC7\uFF0C\u5F53\u7136\u4E50\u89C2\u9501\u8FD8\u6709\u4E00\u4E9B\u53D8\u79CD\u7684\u5904\u7406\u65B9\u5F0F\u6BD4\u5982cas</p><p>\u4E50\u89C2\u9501\u7684\u5178\u578B\u4EE3\u8868\uFF1A\u5C31\u662F<code>cas</code>\uFF0C\u5229\u7528cas\u8FDB\u884C\u65E0\u9501\u5316\u673A\u5236\u52A0\u9501\uFF0Cvar5 \u662F\u64CD\u4F5C\u524D\u8BFB\u53D6\u7684\u5185\u5B58\u503C\uFF0Cwhile\u4E2D\u7684var1+var2 \u662F\u9884\u4F30\u503C\uFF0C\u5982\u679C\u9884\u4F30\u503C == \u5185\u5B58\u503C\uFF0C\u5219\u4EE3\u8868\u4E2D\u95F4\u6CA1\u6709\u88AB\u4EBA\u4FEE\u6539\u8FC7\uFF0C\u6B64\u65F6\u5C31\u5C06\u65B0\u503C\u53BB\u66FF\u6362 \u5185\u5B58\u503C</p><p>\u5176\u4E2Ddo while \u662F\u4E3A\u4E86\u5728\u64CD\u4F5C\u5931\u8D25\u65F6\uFF0C\u518D\u6B21\u8FDB\u884C\u81EA\u65CB\u64CD\u4F5C\uFF0C\u5373\u628A\u4E4B\u524D\u7684\u903B\u8F91\u518D\u64CD\u4F5C\u4E00\u6B21\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> var5<span class="token punctuation">;</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
    var5 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getIntVolatile</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> var5<span class="token punctuation">,</span> var5 <span class="token operator">+</span> var4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> var5<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u8BFE\u7A0B\u4E2D\u7684\u4F7F\u7528\u65B9\u5F0F\uFF1A</strong></p><p>\u8BFE\u7A0B\u4E2D\u7684\u4F7F\u7528\u65B9\u5F0F\u662F\u6CA1\u6709\u50CFcas\u4E00\u6837\u5E26\u81EA\u65CB\u7684\u64CD\u4F5C\uFF0C\u4E5F\u6CA1\u6709\u5BF9version\u7684\u7248\u672C\u53F7+1 \uFF0C\u4ED6\u7684\u64CD\u4F5C\u903B\u8F91\u662F\u5728\u64CD\u4F5C\u65F6\uFF0C\u5BF9\u7248\u672C\u53F7\u8FDB\u884C+1 \u64CD\u4F5C\uFF0C\u7136\u540E\u8981\u6C42version \u5982\u679C\u662F1 \u7684\u60C5\u51B5\u4E0B\uFF0C\u624D\u80FD\u64CD\u4F5C\uFF0C\u90A3\u4E48\u7B2C\u4E00\u4E2A\u7EBF\u7A0B\u5728\u64CD\u4F5C\u540E\uFF0C\u6570\u636E\u5E93\u4E2D\u7684version\u53D8\u6210\u4E862\uFF0C\u4F46\u662F\u4ED6\u81EA\u5DF1\u6EE1\u8DB3version=1 \uFF0C\u6240\u4EE5\u6CA1\u6709\u95EE\u9898\uFF0C\u6B64\u65F6\u7EBF\u7A0B2\u6267\u884C\uFF0C\u7EBF\u7A0B2 \u6700\u540E\u4E5F\u9700\u8981\u52A0\u4E0A\u6761\u4EF6version =1 \uFF0C\u4F46\u662F\u73B0\u5728\u7531\u4E8E\u7EBF\u7A0B1\u5DF2\u7ECF\u64CD\u4F5C\u8FC7\u4E86\uFF0C\u6240\u4EE5\u7EBF\u7A0B2\uFF0C\u64CD\u4F5C\u65F6\u5C31\u4E0D\u6EE1\u8DB3version=1 \u7684\u6761\u4EF6\u4E86\uFF0C\u6240\u4EE5\u7EBF\u7A0B2\u65E0\u6CD5\u6267\u884C\u6210\u529F</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653369268550.png" alt="1653369268550"></p><h3 id="_3-6-\u4E50\u89C2\u9501\u89E3\u51B3\u8D85\u5356\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_3-6-\u4E50\u89C2\u9501\u89E3\u51B3\u8D85\u5356\u95EE\u9898" aria-hidden="true">#</a> 3.6 \u4E50\u89C2\u9501\u89E3\u51B3\u8D85\u5356\u95EE\u9898</h3><p><strong>\u4FEE\u6539\u4EE3\u7801\u65B9\u6848\u4E00\u3001</strong></p><p>VoucherOrderServiceImpl \u5728\u6263\u51CF\u5E93\u5B58\u65F6\uFF0C\u6539\u4E3A\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock= stock -1&quot;</span><span class="token punctuation">)</span> <span class="token comment">//set stock = stock -1</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//where id = \uFF1F and stock = ?</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u903B\u8F91\u7684\u6838\u5FC3\u542B\u4E49\u662F\uFF1A\u53EA\u8981\u6211\u6263\u51CF\u5E93\u5B58\u65F6\u7684\u5E93\u5B58\u548C\u4E4B\u524D\u6211\u67E5\u8BE2\u5230\u7684\u5E93\u5B58\u662F\u4E00\u6837\u7684\uFF0C\u5C31\u610F\u5473\u7740\u6CA1\u6709\u4EBA\u5728\u4E2D\u95F4\u4FEE\u6539\u8FC7\u5E93\u5B58\uFF0C\u90A3\u4E48\u6B64\u65F6\u5C31\u662F\u5B89\u5168\u7684\uFF0C\u4F46\u662F\u4EE5\u4E0A\u8FD9\u79CD\u65B9\u5F0F\u901A\u8FC7\u6D4B\u8BD5\u53D1\u73B0\u4F1A\u6709\u5F88\u591A <code>\u5931\u8D25</code> \u7684\u60C5\u51B5\uFF0C\u5931\u8D25\u7684\u539F\u56E0\u5728\u4E8E\uFF1A\u5728\u4F7F\u7528\u4E50\u89C2\u9501\u8FC7\u7A0B\u4E2D\u5047\u8BBE100\u4E2A\u7EBF\u7A0B\u540C\u65F6\u90FD\u62FF\u5230\u4E86100\u7684\u5E93\u5B58\uFF0C\u7136\u540E\u5927\u5BB6\u4E00\u8D77\u53BB\u8FDB\u884C\u6263\u51CF\uFF0C\u4F46\u662F100\u4E2A\u4EBA\u4E2D\u53EA\u67091\u4E2A\u4EBA\u80FD\u6263\u51CF\u6210\u529F\uFF0C\u5176\u4ED6\u7684\u4EBA\u5728\u5904\u7406\u65F6\uFF0C\u4ED6\u4EEC\u5728\u6263\u51CF\u65F6\uFF0C\u5E93\u5B58\u5DF2\u7ECF\u88AB\u4FEE\u6539\u8FC7\u4E86\uFF0C\u6240\u4EE5\u6B64\u65F6\u5176\u4ED6\u7EBF\u7A0B\u90FD\u4F1A\u5931\u8D25\uFF0C<code>\u6210\u529F\u7387\u4F4E</code></p><p><strong>\u4FEE\u6539\u4EE3\u7801\u65B9\u6848\u4E8C\u3001</strong></p><p>\u4E4B\u524D\u7684\u65B9\u5F0F\u8981\u4FEE\u6539\u524D\u540E\u90FD\u4FDD\u6301\u4E00\u81F4\uFF0C\u4F46\u662F\u8FD9\u6837\u6211\u4EEC\u5206\u6790\u8FC7\uFF0C\u6210\u529F\u7684\u6982\u7387\u592A\u4F4E\uFF0C\u6240\u4EE5\u6211\u4EEC\u7684\u4E50\u89C2\u9501\u9700\u8981\u53D8\u4E00\u4E0B\uFF0C\u6539\u6210stock\u5927\u4E8E0 \u5373\u53EF</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock= stock -1&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//where id = ? and stock &gt; 0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u77E5\u8BC6\u5C0F\u6269\u5C55\uFF1A</strong></p><p>\u9488\u5BF9cas\u4E2D\u7684\u81EA\u65CB\u538B\u529B\u8FC7\u5927\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528Longaddr\u8FD9\u4E2A\u7C7B\u53BB\u89E3\u51B3</p><p>Java8 \u63D0\u4F9B\u7684\u4E00\u4E2A\u5BF9AtomicLong\u6539\u8FDB\u540E\u7684\u4E00\u4E2A\u7C7B\uFF0CLongAdder</p><p>\u5927\u91CF\u7EBF\u7A0B\u5E76\u53D1\u66F4\u65B0\u4E00\u4E2A\u539F\u5B50\u6027\u7684\u65F6\u5019\uFF0C\u5929\u7136\u7684\u95EE\u9898\u5C31\u662F\u81EA\u65CB\uFF0C\u4F1A\u5BFC\u81F4\u5E76\u53D1\u6027\u95EE\u9898\uFF0C\u5F53\u7136\u8FD9\u4E5F\u6BD4\u6211\u4EEC\u76F4\u63A5\u4F7F\u7528syn\u6765\u7684\u597D</p><p>\u6240\u4EE5\u5229\u7528\u8FD9\u4E48\u4E00\u4E2A\u7C7B\uFF0CLongAdder\u6765\u8FDB\u884C\u4F18\u5316</p><p>\u5982\u679C\u83B7\u53D6\u67D0\u4E2A\u503C\uFF0C\u5219\u4F1A\u5BF9cell\u548Cbase\u7684\u503C\u8FDB\u884C\u9012\u589E\uFF0C\u6700\u540E\u8FD4\u56DE\u4E00\u4E2A\u5B8C\u6574\u7684\u503C</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653370271627.png" alt="1653370271627"></p><h3 id="_3-6-\u4F18\u60E0\u5238\u79D2\u6740-\u4E00\u4EBA\u4E00\u5355" tabindex="-1"><a class="header-anchor" href="#_3-6-\u4F18\u60E0\u5238\u79D2\u6740-\u4E00\u4EBA\u4E00\u5355" aria-hidden="true">#</a> 3.6 \u4F18\u60E0\u5238\u79D2\u6740-\u4E00\u4EBA\u4E00\u5355</h3><p>\u9700\u6C42\uFF1A\u4FEE\u6539\u79D2\u6740\u4E1A\u52A1\uFF0C\u8981\u6C42\u540C\u4E00\u4E2A\u4F18\u60E0\u5238\uFF0C\u4E00\u4E2A\u7528\u6237\u53EA\u80FD\u4E0B\u4E00\u5355</p><p><strong>\u73B0\u5728\u7684\u95EE\u9898\u5728\u4E8E\uFF1A</strong></p><p>\u4F18\u60E0\u5377\u662F\u4E3A\u4E86\u5F15\u6D41\uFF0C\u4F46\u662F\u76EE\u524D\u7684\u60C5\u51B5\u662F\uFF0C\u4E00\u4E2A\u4EBA\u53EF\u4EE5\u65E0\u9650\u5236\u7684\u62A2\u8FD9\u4E2A\u4F18\u60E0\u5377\uFF0C\u6240\u4EE5\u6211\u4EEC\u5E94\u5F53\u589E\u52A0\u4E00\u5C42\u903B\u8F91\uFF0C\u8BA9\u4E00\u4E2A\u7528\u6237\u53EA\u80FD\u4E0B\u4E00\u4E2A\u5355\uFF0C\u800C\u4E0D\u662F\u8BA9\u4E00\u4E2A\u7528\u6237\u4E0B\u591A\u4E2A\u5355</p><p>\u5177\u4F53\u64CD\u4F5C\u903B\u8F91\u5982\u4E0B\uFF1A\u6BD4\u5982\u65F6\u95F4\u662F\u5426\u5145\u8DB3\uFF0C\u5982\u679C\u65F6\u95F4\u5145\u8DB3\uFF0C\u5219\u8FDB\u4E00\u6B65\u5224\u65AD\u5E93\u5B58\u662F\u5426\u8DB3\u591F\uFF0C\u7136\u540E\u518D\u6839\u636E\u4F18\u60E0\u5377id\u548C\u7528\u6237id\u67E5\u8BE2\u662F\u5426\u5DF2\u7ECF\u4E0B\u8FC7\u8FD9\u4E2A\u8BA2\u5355\uFF0C\u5982\u679C\u4E0B\u8FC7\u8FD9\u4E2A\u8BA2\u5355\uFF0C\u5219\u4E0D\u518D\u4E0B\u5355\uFF0C\u5426\u5219\u8FDB\u884C\u4E0B\u5355</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653371854389.png" alt="1653371854389"></p><p>VoucherOrderServiceImpl</p><p><strong>\u521D\u6B65\u4EE3\u7801\uFF1A\u589E\u52A0\u4E00\u4EBA\u4E00\u5355\u903B\u8F91</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.\u67E5\u8BE2\u4F18\u60E0\u5238</span>
    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.\u5224\u65AD\u79D2\u6740\u662F\u5426\u5F00\u59CB</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5C1A\u672A\u5F00\u59CB</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u79D2\u6740\u5C1A\u672A\u5F00\u59CB\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.\u5224\u65AD\u79D2\u6740\u662F\u5426\u5DF2\u7ECF\u7ED3\u675F</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5C1A\u672A\u5F00\u59CB</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u79D2\u6740\u5DF2\u7ECF\u7ED3\u675F\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.\u5224\u65AD\u5E93\u5B58\u662F\u5426\u5145\u8DB3</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5E93\u5B58\u4E0D\u8DB3</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 5.\u4E00\u4EBA\u4E00\u5355\u903B\u8F91</span>
    <span class="token comment">// 5.1.\u7528\u6237id</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.2.\u5224\u65AD\u662F\u5426\u5B58\u5728</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u7528\u6237\u5DF2\u7ECF\u8D2D\u4E70\u8FC7\u4E86</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u7528\u6237\u5DF2\u7ECF\u8D2D\u4E70\u8FC7\u4E00\u6B21\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//6\uFF0C\u6263\u51CF\u5E93\u5B58</span>
    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock= stock -1&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u6263\u51CF\u5E93\u5B58</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//7.\u521B\u5EFA\u8BA2\u5355</span>
    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 7.1.\u8BA2\u5355id</span>
    <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 7.3.\u4EE3\u91D1\u5238id</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**\u5B58\u5728\u95EE\u9898\uFF1A**\u73B0\u5728\u7684\u95EE\u9898\u8FD8\u662F\u548C\u4E4B\u524D\u4E00\u6837\uFF0C\u5E76\u53D1\u8FC7\u6765\uFF0C\u67E5\u8BE2\u6570\u636E\u5E93\uFF0C\u90FD\u4E0D\u5B58\u5728\u8BA2\u5355\uFF0C\u6240\u4EE5\u6211\u4EEC\u8FD8\u662F\u9700\u8981\u52A0\u9501\uFF0C\u4F46\u662F\u4E50\u89C2\u9501\u6BD4\u8F83\u9002\u5408\u66F4\u65B0\u6570\u636E\uFF0C\u800C\u73B0\u5728\u662F\u63D2\u5165\u6570\u636E\uFF0C\u6240\u4EE5\u6211\u4EEC\u9700\u8981\u4F7F\u7528\u60B2\u89C2\u9501\u64CD\u4F5C</p><p>**\u6CE8\u610F\uFF1A**\u5728\u8FD9\u91CC\u63D0\u5230\u4E86\u975E\u5E38\u591A\u7684\u95EE\u9898\uFF0C\u6211\u4EEC\u9700\u8981\u6162\u6162\u7684\u6765\u601D\u8003\uFF0C\u9996\u5148\u6211\u4EEC\u7684\u521D\u59CB\u65B9\u6848\u662F\u5C01\u88C5\u4E86\u4E00\u4E2AcreateVoucherOrder\u65B9\u6CD5\uFF0C\u540C\u65F6\u4E3A\u4E86\u786E\u4FDD\u4ED6\u7EBF\u7A0B\u5B89\u5168\uFF0C\u5728\u65B9\u6CD5\u4E0A\u6DFB\u52A0\u4E86\u4E00\u628Asynchronized \u9501</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 5.1.\u67E5\u8BE2\u8BA2\u5355</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.2.\u5224\u65AD\u662F\u5426\u5B58\u5728</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u7528\u6237\u5DF2\u7ECF\u8D2D\u4E70\u8FC7\u4E86</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u7528\u6237\u5DF2\u7ECF\u8D2D\u4E70\u8FC7\u4E00\u6B21\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 6.\u6263\u51CF\u5E93\u5B58</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// set stock = stock - 1</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// where id = ? and stock &gt; 0</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u6263\u51CF\u5931\u8D25</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 7.\u521B\u5EFA\u8BA2\u5355</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7.1.\u8BA2\u5355id</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7.2.\u7528\u6237id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7.3.\u4EE3\u91D1\u5238id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 7.\u8FD4\u56DE\u8BA2\u5355id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\uFF0C\u4F46\u662F\u8FD9\u6837\u6DFB\u52A0\u9501\uFF0C<code>\u9501\u7684\u7C92\u5EA6\u592A\u7C97\u4E86</code>\uFF0C\u5728\u4F7F\u7528\u9501\u8FC7\u7A0B\u4E2D\uFF0C\u63A7\u5236 <strong>\u9501\u7C92\u5EA6</strong> \u662F\u4E00\u4E2A\u975E\u5E38\u91CD\u8981\u7684\u4E8B\u60C5\uFF0C\u56E0\u4E3A\u5982\u679C\u9501\u7684\u7C92\u5EA6\u592A\u5927\uFF0C\u4F1A\u5BFC\u81F4\u6BCF\u4E2A\u7EBF\u7A0B\u8FDB\u6765\u90FD\u4F1A\u9501\u4F4F\uFF0C\u6240\u4EE5\u6211\u4EEC\u9700\u8981\u53BB\u63A7\u5236\u9501\u7684\u7C92\u5EA6\uFF0C\u4EE5\u4E0B\u8FD9\u6BB5\u4EE3\u7801\u9700\u8981\u4FEE\u6539\u4E3A\uFF1A intern() \u8FD9\u4E2A\u65B9\u6CD5\u662F\u4ECE\u5E38\u91CF\u6C60\u4E2D\u62FF\u5230\u6570\u636E\uFF0C\u5982\u679C\u6211\u4EEC\u76F4\u63A5\u4F7F\u7528userId.toString() \u4ED6\u62FF\u5230\u7684\u5BF9\u8C61\u5B9E\u9645\u4E0A\u662F\u4E0D\u540C\u7684\u5BF9\u8C61\uFF0Cnew\u51FA\u6765\u7684\u5BF9\u8C61\uFF0C\u6211\u4EEC\u4F7F\u7528\u9501\u5FC5\u987B\u4FDD\u8BC1\u9501\u5FC5\u987B\u662F\u540C\u4E00\u628A\uFF0C\u6240\u4EE5\u6211\u4EEC\u9700\u8981\u4F7F\u7528 <code>intern()</code> \u65B9\u6CD5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span>  <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span><span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">// 5.1.\u67E5\u8BE2\u8BA2\u5355</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.2.\u5224\u65AD\u662F\u5426\u5B58\u5728</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u7528\u6237\u5DF2\u7ECF\u8D2D\u4E70\u8FC7\u4E86</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u7528\u6237\u5DF2\u7ECF\u8D2D\u4E70\u8FC7\u4E00\u6B21\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 6.\u6263\u51CF\u5E93\u5B58</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// set stock = stock - 1</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// where id = ? and stock &gt; 0</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u6263\u51CF\u5931\u8D25</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 7.\u521B\u5EFA\u8BA2\u5355</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7.1.\u8BA2\u5355id</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7.2.\u7528\u6237id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7.3.\u4EE3\u91D1\u5238id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 7.\u8FD4\u56DE\u8BA2\u5355id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F46\u662F\u4EE5\u4E0A\u4EE3\u7801\u8FD8\u662F\u5B58\u5728\u95EE\u9898\uFF0C\u95EE\u9898\u7684\u539F\u56E0\u5728\u4E8E\u5F53\u524D\u65B9\u6CD5\u88ABspring\u7684\u4E8B\u52A1\u63A7\u5236\uFF0C\u5982\u679C\u4F60\u5728\u65B9\u6CD5\u5185\u90E8\u52A0\u9501\uFF0C\u53EF\u80FD\u4F1A\u5BFC\u81F4\u5F53\u524D\u65B9\u6CD5\u4E8B\u52A1\u8FD8\u6CA1\u6709\u63D0\u4EA4\uFF0C\u4F46\u662F\u9501\u5DF2\u7ECF\u91CA\u653E\u4E5F\u4F1A\u5BFC\u81F4\u95EE\u9898\uFF0C\u6240\u4EE5\u6211\u4EEC\u9009\u62E9\u5C06\u5F53\u524D\u65B9\u6CD5\u6574\u4F53\u5305\u88F9\u8D77\u6765\uFF0C\u786E\u4FDD\u4E8B\u52A1\u4E0D\u4F1A\u51FA\u73B0\u95EE\u9898\uFF1A\u5982\u4E0B\uFF1A</p><p>\u5728seckillVoucher \u65B9\u6CD5\u4E2D\uFF0C\u6DFB\u52A0\u4EE5\u4E0B\u903B\u8F91\uFF0C\u8FD9\u6837\u5C31\u80FD\u4FDD\u8BC1\u4E8B\u52A1\u7684\u7279\u6027\uFF0C\u540C\u65F6\u4E5F\u63A7\u5236\u4E86\u9501\u7684\u7C92\u5EA6</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F46\u662F\u4EE5\u4E0A\u505A\u6CD5\u4F9D\u7136\u6709\u95EE\u9898\uFF0C\u56E0\u4E3A\u4F60\u8C03\u7528\u7684\u65B9\u6CD5\uFF0C\u5176\u5B9E\u662Fthis.\u7684\u65B9\u5F0F\u8C03\u7528\u7684\uFF0C\u4E8B\u52A1\u60F3\u8981\u751F\u6548\uFF0C\u8FD8\u5F97\u5229\u7528\u4EE3\u7406\u6765\u751F\u6548\uFF0C\u6240\u4EE5\u8FD9\u4E2A\u5730\u65B9\uFF0C\u6211\u4EEC\u9700\u8981\u83B7\u5F97\u539F\u59CB\u7684\u4E8B\u52A1\u5BF9\u8C61\uFF0C \u6765\u64CD\u4F5C\u4E8B\u52A1</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u975E\u4E8B\u52A1\u7684\u65B9\u6CD5\u8C03\u7528\u81EA\u8EAB\u7C7B\u7684\u4E8B\u52A1\u65B9\u6CD5\uFF0C\u4E8B\u52A1\u5931\u6548</span>
    <span class="token comment">// \u83B7\u5F97\u4EE3\u7406\u5BF9\u8C61</span>
    <span class="token class-name">IVoucherOrderService</span> voucherOrderService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> voucherOrderService<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,406),k=n("p",null,"\u8865\u5145\uFF1A",-1),r=s("Spring\u4E8B\u52A1\u5931\u6548\u5E38\u89C1\u573A\u666F: "),d={href:"https://blog.csdn.net/qq_16268979/article/details/123707823",target:"_blank",rel:"noopener noreferrer"},m=s("https://blog.csdn.net/qq_16268979/article/details/123707823"),v=t(`<p>\u5B8C\u6210\u4EE3\u7801</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * \u79D2\u6740\u4E0B\u5355
     *
     * <span class="token keyword">@param</span> <span class="token parameter">voucherId</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.\u6839\u636E id \u67E5\u8BE2\u4F18\u60E0\u5238\u4FE1\u606F</span>
    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.\u5224\u65AD\u79D2\u6740\u662F\u5426\u5F00\u59CB</span>
    <span class="token class-name">LocalDateTime</span> beginTime <span class="token operator">=</span> voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beginTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u79D2\u6740\u6D3B\u52A8\u5C1A\u672A\u5F00\u59CB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.\u5224\u65AD\u79D2\u6740\u662F\u5426\u7ED3\u675F</span>
    <span class="token class-name">LocalDateTime</span> endTime <span class="token operator">=</span> voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>endTime<span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u79D2\u6740\u6D3B\u52A8\u5DF2\u7ECF\u7ED3\u675F&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.\u5224\u65AD\u5E93\u5B58\u662F\u5426\u5145\u8DB3</span>
    <span class="token class-name">Integer</span> stock <span class="token operator">=</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u975E\u4E8B\u52A1\u7684\u65B9\u6CD5\u8C03\u7528\u81EA\u8EAB\u7C7B\u7684\u4E8B\u52A1\u65B9\u6CD5\uFF0C\u4E8B\u52A1\u5931\u6548</span>
        <span class="token comment">// \u83B7\u5F97\u4EE3\u7406\u5BF9\u8C61</span>
        <span class="token class-name">IVoucherOrderService</span> voucherOrderService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> voucherOrderService<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
     * \u521B\u5EFA\u4F18\u60E0\u5238\u8BA2\u5355
     *
     * <span class="token keyword">@param</span> <span class="token parameter">voucherId</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 5.\u4E00\u4EBA\u4E00\u5355</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 6.\u5224\u65AD\u8BA2\u5355\u662F\u5426\u5DF2\u7ECF\u5B58\u5728</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u60A8\u5DF2\u8D2D\u4E70\u8FC7\u6B64\u4F18\u60E0\u5238&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 5.\u6263\u51CF\u5E93\u5B58</span>
    <span class="token comment">// \u6CE8\u610F\uFF1A\u8FD9\u6837\u5199\u662F\u9519\u8BEF\u7684\uFF0C\u56E0\u4E3A\u662F\u8986\u76D6\u7ED3\u679C</span>
    <span class="token comment">// voucher.setStock(stock - 1);</span>
    <span class="token comment">// seckillVoucherService.updateById(voucher);</span>
    <span class="token comment">// \u8FD9\u6837\u7684\u6210\u529F\u7387\u592A\u4F4E</span>
    <span class="token comment">// boolean update = seckillVoucherService.update().setSql(&quot;stock = stock - 1&quot;).eq(&quot;stock&quot;, stock).update();</span>
    <span class="token comment">// \u53EA\u8981\u5E93\u5B58\u5927\u4E8E 0 \u5C31\u53EF\u4EE5\u51CF</span>
    <span class="token keyword">boolean</span> update <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 6.\u521B\u5EFA\u8BA2\u5355</span>
    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 	6.2 \u8BA2\u5355id</span>
    <span class="token keyword">long</span> orderId <span class="token operator">=</span> idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 	6.1 \u7528\u6237id</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 	6.3 \u4F18\u60E0\u5238id</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 7.\u8FD4\u56DE\u8BA2\u5355\u53F7</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-7-\u96C6\u7FA4\u73AF\u5883\u4E0B\u7684\u5E76\u53D1\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_3-7-\u96C6\u7FA4\u73AF\u5883\u4E0B\u7684\u5E76\u53D1\u95EE\u9898" aria-hidden="true">#</a> 3.7 \u96C6\u7FA4\u73AF\u5883\u4E0B\u7684\u5E76\u53D1\u95EE\u9898</h3><p>\u901A\u8FC7\u52A0\u9501\u53EF\u4EE5\u89E3\u51B3\u5728\u5355\u673A\u60C5\u51B5\u4E0B\u7684\u4E00\u4EBA\u4E00\u5355\u5B89\u5168\u95EE\u9898\uFF0C\u4F46\u662F\u5728\u96C6\u7FA4\u6A21\u5F0F\u4E0B\u5C31\u4E0D\u884C\u4E86\u3002</p><p>1\u3001\u6211\u4EEC\u5C06\u670D\u52A1\u542F\u52A8\u4E24\u4EFD\uFF0C\u7AEF\u53E3\u5206\u522B\u4E3A8081\u548C8082\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220728175935554.png" alt="image-20220728175935554"></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653373887844.png" alt="1653373887844"></p><p>2\u3001\u7136\u540E\u4FEE\u6539nginx\u7684conf\u76EE\u5F55\u4E0B\u7684nginx.conf\u6587\u4EF6\uFF0C\u914D\u7F6E\u53CD\u5411\u4EE3\u7406\u548C\u8D1F\u8F7D\u5747\u8861\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653373908620.png" alt="1653373908620"></p><p><strong>\u5177\u4F53\u64CD\u4F5C(\u7565)</strong></p><p><strong>\u6709\u5173\u9501\u5931\u6548\u539F\u56E0\u5206\u6790</strong></p><p>\u7531\u4E8E\u73B0\u5728\u6211\u4EEC\u90E8\u7F72\u4E86\u591A\u4E2Atomcat\uFF0C\u6BCF\u4E2Atomcat\u90FD\u6709\u4E00\u4E2A\u5C5E\u4E8E\u81EA\u5DF1\u7684jvm\uFF0C\u90A3\u4E48\u5047\u8BBE\u5728\u670D\u52A1\u5668A\u7684tomcat\u5185\u90E8\uFF0C\u6709\u4E24\u4E2A\u7EBF\u7A0B\uFF0C\u8FD9\u4E24\u4E2A\u7EBF\u7A0B\u7531\u4E8E\u4F7F\u7528\u7684\u662F\u540C\u4E00\u4EFD\u4EE3\u7801\uFF0C\u90A3\u4E48\u4ED6\u4EEC\u7684\u9501\u5BF9\u8C61\u662F\u540C\u4E00\u4E2A\uFF0C\u662F\u53EF\u4EE5\u5B9E\u73B0\u4E92\u65A5\u7684\uFF0C\u4F46\u662F\u5982\u679C\u73B0\u5728\u662F\u670D\u52A1\u5668B\u7684tomcat\u5185\u90E8\uFF0C\u53C8\u6709\u4E24\u4E2A\u7EBF\u7A0B\uFF0C\u4F46\u662F\u4ED6\u4EEC\u7684\u9501\u5BF9\u8C61\u5199\u7684\u867D\u7136\u548C\u670D\u52A1\u5668A\u4E00\u6837\uFF0C\u4F46\u662F\u9501\u5BF9\u8C61\u5374\u4E0D\u662F\u540C\u4E00\u4E2A\uFF0C\u6240\u4EE5\u7EBF\u7A0B3\u548C\u7EBF\u7A0B4\u53EF\u4EE5\u5B9E\u73B0\u4E92\u65A5\uFF0C\u4F46\u662F\u5374\u65E0\u6CD5\u548C\u7EBF\u7A0B1\u548C\u7EBF\u7A0B2\u5B9E\u73B0\u4E92\u65A5\uFF0C\u8FD9\u5C31\u662F \u96C6\u7FA4\u73AF\u5883\u4E0B\uFF0C<code>syn\u9501</code> \u5931\u6548\u7684\u539F\u56E0\uFF0C\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u6211\u4EEC\u5C31\u9700\u8981\u4F7F\u7528\u5206\u5E03\u5F0F\u9501\u6765\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653374044740.png" alt="1653374044740"></p><h2 id="_4\u3001\u5206\u5E03\u5F0F\u9501" tabindex="-1"><a class="header-anchor" href="#_4\u3001\u5206\u5E03\u5F0F\u9501" aria-hidden="true">#</a> 4\u3001\u5206\u5E03\u5F0F\u9501</h2><h3 id="_4-1-\u3001\u57FA\u672C\u539F\u7406\u548C\u5B9E\u73B0\u65B9\u5F0F\u5BF9\u6BD4" tabindex="-1"><a class="header-anchor" href="#_4-1-\u3001\u57FA\u672C\u539F\u7406\u548C\u5B9E\u73B0\u65B9\u5F0F\u5BF9\u6BD4" aria-hidden="true">#</a> 4.1 \u3001\u57FA\u672C\u539F\u7406\u548C\u5B9E\u73B0\u65B9\u5F0F\u5BF9\u6BD4</h3><p>\u5206\u5E03\u5F0F\u9501\uFF1A\u6EE1\u8DB3\u5206\u5E03\u5F0F\u7CFB\u7EDF\u6216\u96C6\u7FA4\u6A21\u5F0F\u4E0B <code>\u591A\u8FDB\u7A0B\u53EF\u89C1</code> \u5E76\u4E14 <code>\u4E92\u65A5</code> \u7684\u9501\u3002</p><p>\u5206\u5E03\u5F0F\u9501\u7684\u6838\u5FC3\u601D\u60F3\u5C31\u662F\u8BA9\u5927\u5BB6\u90FD<code>\u4F7F\u7528\u540C\u4E00\u628A\u9501</code>\uFF0C\u53EA\u8981\u5927\u5BB6\u4F7F\u7528\u7684\u662F\u540C\u4E00\u628A\u9501\uFF0C\u90A3\u4E48\u6211\u4EEC\u5C31\u80FD\u9501\u4F4F\u7EBF\u7A0B\uFF0C\u4E0D\u8BA9\u7EBF\u7A0B\u8FDB\u884C\uFF0C\u8BA9\u7A0B\u5E8F\u4E32\u884C\u6267\u884C\uFF0C\u8FD9\u5C31\u662F\u5206\u5E03\u5F0F\u9501\u7684\u6838\u5FC3\u601D\u8DEF</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653374296906.png" alt="1653374296906"></p><p>\u90A3\u4E48\u5206\u5E03\u5F0F\u9501\u4ED6\u5E94\u8BE5\u6EE1\u8DB3\u4E00\u4E9B\u4EC0\u4E48\u6837\u7684\u6761\u4EF6\u5462\uFF1F</p><p><code>\u53EF\u89C1\u6027</code>\uFF1A\u591A\u4E2A\u7EBF\u7A0B\u90FD\u80FD\u770B\u5230\u76F8\u540C\u7684\u7ED3\u679C\uFF0C\u6CE8\u610F\uFF1A\u8FD9\u4E2A\u5730\u65B9\u8BF4\u7684\u53EF\u89C1\u6027\u5E76\u4E0D\u662F\u5E76\u53D1\u7F16\u7A0B\u4E2D\u6307\u7684\u5185\u5B58\u53EF\u89C1\u6027\uFF0C\u53EA\u662F\u8BF4\u591A\u4E2A\u8FDB\u7A0B\u4E4B\u95F4\u90FD\u80FD\u611F\u77E5\u5230\u53D8\u5316\u7684\u610F\u601D</p><p><code>\u4E92\u65A5</code>\uFF1A\u4E92\u65A5\u662F\u5206\u5E03\u5F0F\u9501\u7684\u6700\u57FA\u672C\u7684\u6761\u4EF6\uFF0C\u4F7F\u5F97\u7A0B\u5E8F\u4E32\u884C\u6267\u884C</p><p><code>\u9AD8\u53EF\u7528</code>\uFF1A\u7A0B\u5E8F\u4E0D\u6613\u5D29\u6E83\uFF0C\u65F6\u65F6\u523B\u523B\u90FD\u4FDD\u8BC1\u8F83\u9AD8\u7684\u53EF\u7528\u6027</p><p><code>\u9AD8\u6027\u80FD</code>\uFF1A\u7531\u4E8E\u52A0\u9501\u672C\u8EAB\u5C31\u8BA9\u6027\u80FD\u964D\u4F4E\uFF0C\u6240\u6709\u5BF9\u4E8E\u5206\u5E03\u5F0F\u9501\u672C\u8EAB\u9700\u8981\u4ED6\u5C31\u8F83\u9AD8\u7684\u52A0\u9501\u6027\u80FD\u548C\u91CA\u653E\u9501\u6027\u80FD</p><p><code>\u5B89\u5168\u6027</code>\uFF1A\u5B89\u5168\u4E5F\u662F\u7A0B\u5E8F\u4E2D\u5FC5\u4E0D\u53EF\u5C11\u7684\u4E00\u73AF</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653381992018.png" alt="1653381992018"></p><p>\u5E38\u89C1\u7684\u5206\u5E03\u5F0F\u9501\u6709\u4E09\u79CD</p><p><code>Mysql</code>\uFF1Amysql\u672C\u8EAB\u5C31\u5E26\u6709\u9501\u673A\u5236\uFF0C\u4F46\u662F\u7531\u4E8Emysql\u6027\u80FD\u672C\u8EAB\u4E00\u822C\uFF0C\u6240\u4EE5\u91C7\u7528\u5206\u5E03\u5F0F\u9501\u7684\u60C5\u51B5\u4E0B\uFF0C\u5176\u5B9E\u4F7F\u7528mysql\u4F5C\u4E3A\u5206\u5E03\u5F0F\u9501\u6BD4\u8F83\u5C11\u89C1</p><p><code>Redis</code>\uFF1Aredis\u4F5C\u4E3A\u5206\u5E03\u5F0F\u9501\u662F\u975E\u5E38\u5E38\u89C1\u7684\u4E00\u79CD\u4F7F\u7528\u65B9\u5F0F\uFF0C\u73B0\u5728\u4F01\u4E1A\u7EA7\u5F00\u53D1\u4E2D\u57FA\u672C\u90FD\u4F7F\u7528redis\u6216\u8005zookeeper\u4F5C\u4E3A\u5206\u5E03\u5F0F\u9501\uFF0C\u5229\u7528setnx\u8FD9\u4E2A\u65B9\u6CD5\uFF0C\u5982\u679C\u63D2\u5165key\u6210\u529F\uFF0C\u5219\u8868\u793A\u83B7\u5F97\u5230\u4E86\u9501\uFF0C\u5982\u679C\u6709\u4EBA\u63D2\u5165\u6210\u529F\uFF0C\u5176\u4ED6\u4EBA\u63D2\u5165\u5931\u8D25\u5219\u8868\u793A\u65E0\u6CD5\u83B7\u5F97\u5230\u9501\uFF0C\u5229\u7528\u8FD9\u5957\u903B\u8F91\u6765\u5B9E\u73B0\u5206\u5E03\u5F0F\u9501</p><p><code>Zookeeper</code>\uFF1Azookeeper\u4E5F\u662F\u4F01\u4E1A\u7EA7\u5F00\u53D1\u4E2D\u8F83\u597D\u7684\u4E00\u4E2A\u5B9E\u73B0\u5206\u5E03\u5F0F\u9501\u7684\u65B9\u6848\uFF0C\u7531\u4E8E\u672C\u5957\u89C6\u9891\u5E76\u4E0D\u8BB2\u89E3zookeeper\u7684\u539F\u7406\u548C\u5206\u5E03\u5F0F\u9501\u7684\u5B9E\u73B0\uFF0C\u6240\u4EE5\u4E0D\u8FC7\u591A\u9610\u8FF0</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653382219377.png" alt="1653382219377"></p><h3 id="_4-2-\u3001redis\u5206\u5E03\u5F0F\u9501\u7684\u5B9E\u73B0\u6838\u5FC3\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#_4-2-\u3001redis\u5206\u5E03\u5F0F\u9501\u7684\u5B9E\u73B0\u6838\u5FC3\u601D\u8DEF" aria-hidden="true">#</a> 4.2 \u3001Redis\u5206\u5E03\u5F0F\u9501\u7684\u5B9E\u73B0\u6838\u5FC3\u601D\u8DEF</h3><p>\u5B9E\u73B0\u5206\u5E03\u5F0F\u9501\u65F6\u9700\u8981\u5B9E\u73B0\u7684\u4E24\u4E2A\u57FA\u672C\u65B9\u6CD5\uFF1A</p><ul><li><p>\u83B7\u53D6\u9501\uFF1A</p><ul><li>\u4E92\u65A5\uFF1A\u786E\u4FDD\u53EA\u80FD\u6709\u4E00\u4E2A\u7EBF\u7A0B\u83B7\u53D6\u9501</li><li>\u975E\u963B\u585E\uFF1A\u5C1D\u8BD5\u4E00\u6B21\uFF0C\u6210\u529F\u8FD4\u56DEtrue\uFF0C\u5931\u8D25\u8FD4\u56DEfalse</li></ul><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220729172106391.png" alt="image-20220729172106391"></p></li><li><p>\u91CA\u653E\u9501\uFF1A</p><ul><li>\u624B\u52A8\u91CA\u653E</li><li>\u8D85\u65F6\u91CA\u653E\uFF1A\u83B7\u53D6\u9501\u65F6\u6DFB\u52A0\u4E00\u4E2A\u8D85\u65F6\u65F6\u95F4</li></ul><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653382669900.png" alt="1653382669900"></p></li></ul><p>\u6838\u5FC3\u601D\u8DEF\uFF1A</p><p>\u6211\u4EEC\u5229\u7528redis \u7684setNx \u65B9\u6CD5\uFF0C\u5F53\u6709\u591A\u4E2A\u7EBF\u7A0B\u8FDB\u5165\u65F6\uFF0C\u6211\u4EEC\u5C31\u5229\u7528\u8BE5\u65B9\u6CD5\uFF0C\u7B2C\u4E00\u4E2A\u7EBF\u7A0B\u8FDB\u5165\u65F6\uFF0Credis \u4E2D\u5C31\u6709\u8FD9\u4E2Akey \u4E86\uFF0C\u8FD4\u56DE\u4E861\uFF0C\u5982\u679C\u7ED3\u679C\u662F1\uFF0C\u5219\u8868\u793A\u4ED6\u62A2\u5230\u4E86\u9501\uFF0C\u90A3\u4E48\u4ED6\u53BB\u6267\u884C\u4E1A\u52A1\uFF0C\u7136\u540E\u518D\u5220\u9664\u9501\uFF0C\u9000\u51FA\u9501\u903B\u8F91\uFF0C\u6CA1\u6709\u62A2\u5230\u9501\u7684\u54E5\u4EEC\uFF0C\u7B49\u5F85\u4E00\u5B9A\u65F6\u95F4\u540E\u91CD\u8BD5\u5373\u53EF</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653382830810.png" alt="1653382830810"></p><h3 id="_4-3-\u5B9E\u73B0\u5206\u5E03\u5F0F\u9501\u7248\u672C\u4E00" tabindex="-1"><a class="header-anchor" href="#_4-3-\u5B9E\u73B0\u5206\u5E03\u5F0F\u9501\u7248\u672C\u4E00" aria-hidden="true">#</a> 4.3 \u5B9E\u73B0\u5206\u5E03\u5F0F\u9501\u7248\u672C\u4E00</h3><blockquote><p>1.\u83B7\u53D6\u9501</p><p>2.\u5931\u8D25\uFF0C\u8FD4\u56DE\u9519\u8BEF\u4FE1\u606F</p><p>3.\u6210\u529F\uFF0C\u6267\u884C\u4E1A\u52A1\u903B\u8F91</p><p>4.\u91CA\u653E\u9501</p></blockquote><ul><li>\u52A0\u9501\u903B\u8F91</li></ul><p><strong>\u9501\u7684\u57FA\u672C\u63A5\u53E3</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ILock</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * \u5C1D\u8BD5\u83B7\u53D6\u9501
     * <span class="token keyword">@param</span> <span class="token parameter">timeoutSec</span> \u8FC7\u671F\u65F6\u95F4\uFF0C\u8D85\u65F6\u81EA\u52A8\u91CA\u653E\u9501
     * <span class="token keyword">@return</span> true\uFF1A\u83B7\u53D6\u9501\u6210\u529F false\uFF1A\u83B7\u53D6\u9501\u5931\u8D25
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutSec<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u91CA\u653E\u9501
     */</span>
    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>SimpleRedisLock</strong></p><p>\u5229\u7528setnx\u65B9\u6CD5\u8FDB\u884C\u52A0\u9501\uFF0C\u540C\u65F6\u589E\u52A0\u8FC7\u671F\u65F6\u95F4\uFF0C\u9632\u6B62\u6B7B\u9501\uFF0C\u6B64\u65B9\u6CD5\u53EF\u4EE5\u4FDD\u8BC1\u52A0\u9501\u548C\u589E\u52A0\u8FC7\u671F\u65F6\u95F4\u5177\u6709\u539F\u5B50\u6027</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> KEY_PREFIX <span class="token operator">=</span> <span class="token string">&quot;lock:&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutSec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u83B7\u53D6\u7EBF\u7A0B\u6807\u793A</span>
        <span class="token class-name">String</span> threadId <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// \u83B7\u53D6\u9501</span>
        <span class="token class-name">Boolean</span> success <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">,</span> threadId <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> timeoutSec<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u91CA\u653E\u9501\u903B\u8F91</li></ul><p>SimpleRedisLock</p><p>\u91CA\u653E\u9501\uFF0C\u9632\u6B62\u5220\u9664\u522B\u4EBA\u7684\u9501</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//\u901A\u8FC7del\u5220\u9664\u9501</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u4FEE\u6539\u4E1A\u52A1\u4EE3\u7801</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u67E5\u8BE2\u4F18\u60E0\u5238</span>
        <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5224\u65AD\u79D2\u6740\u662F\u5426\u5F00\u59CB</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5C1A\u672A\u5F00\u59CB</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u79D2\u6740\u5C1A\u672A\u5F00\u59CB\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u5224\u65AD\u79D2\u6740\u662F\u5426\u5DF2\u7ECF\u7ED3\u675F</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5C1A\u672A\u5F00\u59CB</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u79D2\u6740\u5DF2\u7ECF\u7ED3\u675F\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.\u5224\u65AD\u5E93\u5B58\u662F\u5426\u5145\u8DB3</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5E93\u5B58\u4E0D\u8DB3</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u521B\u5EFA\u9501\u5BF9\u8C61---------\u65B0\u589E\u4EE3\u7801</span>
        <span class="token class-name">SimpleRedisLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token string">&quot;order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> stringRedisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u83B7\u53D6\u9501\u5BF9\u8C61</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//\u52A0\u9501\u5931\u8D25</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u4E0D\u5141\u8BB8\u91CD\u590D\u4E0B\u5355&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u83B7\u53D6\u4EE3\u7406\u5BF9\u8C61(\u4E8B\u52A1)</span>
            <span class="token class-name">IVoucherOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u91CA\u653E\u9501</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-redis\u5206\u5E03\u5F0F\u9501\u8BEF\u5220\u60C5\u51B5\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#_4-4-redis\u5206\u5E03\u5F0F\u9501\u8BEF\u5220\u60C5\u51B5\u8BF4\u660E" aria-hidden="true">#</a> 4.4 Redis\u5206\u5E03\u5F0F\u9501\u8BEF\u5220\u60C5\u51B5\u8BF4\u660E</h3><p>\u903B\u8F91\u8BF4\u660E\uFF1A</p><p>\u6301\u6709\u9501\u7684\u7EBF\u7A0B\u5728\u9501\u7684\u5185\u90E8\u51FA\u73B0\u4E86\u963B\u585E\uFF0C\u5BFC\u81F4\u4ED6\u7684\u9501\u81EA\u52A8\u91CA\u653E\uFF0C\u8FD9\u65F6\u5176\u4ED6\u7EBF\u7A0B\uFF0C\u7EBF\u7A0B2\u6765\u5C1D\u8BD5\u83B7\u5F97\u9501\uFF0C\u5C31\u62FF\u5230\u4E86\u8FD9\u628A\u9501\uFF0C\u7136\u540E\u7EBF\u7A0B2\u5728\u6301\u6709\u9501\u6267\u884C\u8FC7\u7A0B\u4E2D\uFF0C\u7EBF\u7A0B1\u53CD\u5E94\u8FC7\u6765\uFF0C\u7EE7\u7EED\u6267\u884C\uFF0C\u800C\u7EBF\u7A0B1\u6267\u884C\u8FC7\u7A0B\u4E2D\uFF0C\u8D70\u5230\u4E86\u5220\u9664\u9501\u903B\u8F91\uFF0C\u6B64\u65F6\u5C31\u4F1A\u628A\u672C\u5E94\u8BE5\u5C5E\u4E8E\u7EBF\u7A0B2\u7684\u9501\u8FDB\u884C\u5220\u9664\uFF0C\u8FD9\u5C31\u662F\u8BEF\u5220\u522B\u4EBA\u9501\u7684\u60C5\u51B5\u8BF4\u660E</p><p>\u89E3\u51B3\u65B9\u6848\uFF1A\u89E3\u51B3\u65B9\u6848\u5C31\u662F\u5728\u6BCF\u4E2A\u7EBF\u7A0B\u91CA\u653E\u9501\u7684\u65F6\u5019\uFF0C\u53BB\u5224\u65AD\u4E00\u4E0B\u5F53\u524D\u8FD9\u628A\u9501\u662F\u5426\u5C5E\u4E8E\u81EA\u5DF1\uFF0C\u5982\u679C\u5C5E\u4E8E\u81EA\u5DF1\uFF0C\u5219\u4E0D\u8FDB\u884C\u9501\u7684\u5220\u9664\uFF0C\u5047\u8BBE\u8FD8\u662F\u4E0A\u8FB9\u7684\u60C5\u51B5\uFF0C\u7EBF\u7A0B1\u5361\u987F\uFF0C\u9501\u81EA\u52A8\u91CA\u653E\uFF0C\u7EBF\u7A0B2\u8FDB\u5165\u5230\u9501\u7684\u5185\u90E8\u6267\u884C\u903B\u8F91\uFF0C\u6B64\u65F6\u7EBF\u7A0B1\u53CD\u5E94\u8FC7\u6765\uFF0C\u7136\u540E\u5220\u9664\u9501\uFF0C\u4F46\u662F\u7EBF\u7A0B1\uFF0C\u4E00\u770B\u5F53\u524D\u8FD9\u628A\u9501\u4E0D\u662F\u5C5E\u4E8E\u81EA\u5DF1\uFF0C\u4E8E\u662F\u4E0D\u8FDB\u884C\u5220\u9664\u9501\u903B\u8F91\uFF0C\u5F53\u7EBF\u7A0B2\u8D70\u5230\u5220\u9664\u9501\u903B\u8F91\u65F6\uFF0C\u5982\u679C\u6CA1\u6709\u5361\u8FC7\u81EA\u52A8\u91CA\u653E\u9501\u7684\u65F6\u95F4\u70B9\uFF0C\u5219\u5224\u65AD\u5F53\u524D\u8FD9\u628A\u9501\u662F\u5C5E\u4E8E\u81EA\u5DF1\u7684\uFF0C\u4E8E\u662F\u5220\u9664\u8FD9\u628A\u9501\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653385920025.png" alt="1653385920025"></p><h3 id="_4-5-\u89E3\u51B3redis\u5206\u5E03\u5F0F\u9501\u8BEF\u5220\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_4-5-\u89E3\u51B3redis\u5206\u5E03\u5F0F\u9501\u8BEF\u5220\u95EE\u9898" aria-hidden="true">#</a> 4.5 \u89E3\u51B3Redis\u5206\u5E03\u5F0F\u9501\u8BEF\u5220\u95EE\u9898</h3><blockquote><p>1.\u83B7\u53D6\u9501\u540E\u5B58\u5165\u7EBF\u7A0B\u6807\u8BC6 \uFF08UUID + \u7EBF\u7A0BID\uFF09 \u7EBF\u7A0BID \u662F\u81EA\u589E\u7684\uFF0C\u591A\u4E2A jvm \u53EF\u80FD\u4F1A\u51FA\u73B0 \u7EBF\u7A0BID \u76F8\u540C\u7684\u60C5\u51B5</p><p>2.\u91CA\u653E\u9501\u524D\uFF0C\u5224\u65AD\u9501\u7684\u7EBF\u7A0B\u6807\u8BC6\u662F\u5426\u662F\u81EA\u5DF1\u7684</p></blockquote><p>\u9700\u6C42\uFF1A\u4FEE\u6539\u4E4B\u524D\u7684\u5206\u5E03\u5F0F\u9501\u5B9E\u73B0\uFF0C\u6EE1\u8DB3\uFF1A\u5728\u83B7\u53D6\u9501\u65F6\u5B58\u5165\u7EBF\u7A0B\u6807\u793A\uFF08\u53EF\u4EE5\u7528UUID\u8868\u793A\uFF09 \u5728\u91CA\u653E\u9501\u65F6\u5148\u83B7\u53D6\u9501\u4E2D\u7684\u7EBF\u7A0B\u6807\u793A\uFF0C\u5224\u65AD\u662F\u5426\u4E0E\u5F53\u524D\u7EBF\u7A0B\u6807\u793A\u4E00\u81F4</p><ul><li>\u5982\u679C\u4E00\u81F4\u5219\u91CA\u653E\u9501</li><li>\u5982\u679C\u4E0D\u4E00\u81F4\u5219\u4E0D\u91CA\u653E\u9501</li></ul><p>\u6838\u5FC3\u903B\u8F91\uFF1A\u5728\u5B58\u5165\u9501\u65F6\uFF0C\u653E\u5165\u81EA\u5DF1\u7EBF\u7A0B\u7684\u6807\u8BC6\uFF0C\u5728\u5220\u9664\u9501\u65F6\uFF0C\u5224\u65AD\u5F53\u524D\u8FD9\u628A\u9501\u7684\u6807\u8BC6\u662F\u4E0D\u662F\u81EA\u5DF1\u5B58\u5165\u7684\uFF0C\u5982\u679C\u662F\uFF0C\u5219\u8FDB\u884C\u5220\u9664\uFF0C\u5982\u679C\u4E0D\u662F\uFF0C\u5219\u4E0D\u8FDB\u884C\u5220\u9664\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653387398820.png" alt="1653387398820"></p><p>\u5177\u4F53\u4EE3\u7801\u5982\u4E0B\uFF1A\u52A0\u9501</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ID_PREFIX <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutSec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// \u83B7\u53D6\u7EBF\u7A0B\u6807\u793A</span>
   <span class="token class-name">String</span> threadId <span class="token operator">=</span> ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// \u83B7\u53D6\u9501</span>
   <span class="token class-name">Boolean</span> success <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> timeoutSec<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u91CA\u653E\u9501</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u83B7\u53D6\u7EBF\u7A0B\u6807\u793A</span>
    <span class="token class-name">String</span> threadId <span class="token operator">=</span> ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u83B7\u53D6\u9501\u4E2D\u7684\u6807\u793A</span>
    <span class="token class-name">String</span> id <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u5224\u65AD\u6807\u793A\u662F\u5426\u4E00\u81F4</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>threadId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u91CA\u653E\u9501</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u6709\u5173\u4EE3\u7801\u5B9E\u64CD\u8BF4\u660E\uFF1A</strong></p><p>\u5728\u6211\u4EEC\u4FEE\u6539\u5B8C\u6B64\u5904\u4EE3\u7801\u540E\uFF0C\u6211\u4EEC\u91CD\u542F\u5DE5\u7A0B\uFF0C\u7136\u540E\u542F\u52A8\u4E24\u4E2A\u7EBF\u7A0B\uFF0C\u7B2C\u4E00\u4E2A\u7EBF\u7A0B\u6301\u6709\u9501\u540E\uFF0C\u624B\u52A8\u91CA\u653E\u9501\uFF0C\u7B2C\u4E8C\u4E2A\u7EBF\u7A0B \u6B64\u65F6\u8FDB\u5165\u5230\u9501\u5185\u90E8\uFF0C\u518D\u653E\u884C\u7B2C\u4E00\u4E2A\u7EBF\u7A0B\uFF0C\u6B64\u65F6\u7B2C\u4E00\u4E2A\u7EBF\u7A0B\u7531\u4E8E\u9501\u7684value\u503C\u5E76\u975E\u662F\u81EA\u5DF1\uFF0C\u6240\u4EE5\u4E0D\u80FD\u91CA\u653E\u9501\uFF0C\u4E5F\u5C31\u65E0\u6CD5\u5220\u9664\u522B\u4EBA\u7684\u9501\uFF0C\u6B64\u65F6\u7B2C\u4E8C\u4E2A\u7EBF\u7A0B\u80FD\u591F\u6B63\u786E\u91CA\u653E\u9501\uFF0C\u901A\u8FC7\u8FD9\u4E2A\u6848\u4F8B\u521D\u6B65\u8BF4\u660E\u6211\u4EEC\u89E3\u51B3\u4E86\u9501\u8BEF\u5220\u7684\u95EE\u9898\u3002</p><h3 id="_4-6-\u5206\u5E03\u5F0F\u9501\u7684\u539F\u5B50\u6027\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_4-6-\u5206\u5E03\u5F0F\u9501\u7684\u539F\u5B50\u6027\u95EE\u9898" aria-hidden="true">#</a> 4.6 \u5206\u5E03\u5F0F\u9501\u7684\u539F\u5B50\u6027\u95EE\u9898</h3><p>\u66F4\u4E3A\u6781\u7AEF\u7684\u8BEF\u5220\u903B\u8F91\u8BF4\u660E\uFF1A</p><p>\u7EBF\u7A0B1\u73B0\u5728\u6301\u6709\u9501\u4E4B\u540E\uFF0C\u5728\u6267\u884C\u4E1A\u52A1\u903B\u8F91\u8FC7\u7A0B\u4E2D\uFF0C\u4ED6\u6B63\u51C6\u5907\u5220\u9664\u9501\uFF0C\u800C\u4E14\u5DF2\u7ECF\u8D70\u5230\u4E86\u6761\u4EF6\u5224\u65AD\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u6BD4\u5982\u4ED6\u5DF2\u7ECF\u62FF\u5230\u4E86\u5F53\u524D\u8FD9\u628A\u9501\u786E\u5B9E\u662F\u5C5E\u4E8E\u4ED6\u81EA\u5DF1\u7684\uFF0C\u6B63\u51C6\u5907\u5220\u9664\u9501\uFF0C\u4F46\u662F\u6B64\u65F6\u4ED6\u7684\u9501\u5230\u671F\u4E86\uFF0C\u90A3\u4E48\u6B64\u65F6\u7EBF\u7A0B2\u8FDB\u6765\uFF0C\u4F46\u662F\u7EBF\u7A0B1\u4ED6\u4F1A\u63A5\u7740\u5F80\u540E\u6267\u884C\uFF0C\u5F53\u4ED6\u5361\u987F\u7ED3\u675F\u540E\uFF0C\u4ED6\u76F4\u63A5\u5C31\u4F1A\u6267\u884C\u5220\u9664\u9501\u90A3\u884C\u4EE3\u7801\uFF0C\u76F8\u5F53\u4E8E\u6761\u4EF6\u5224\u65AD\u5E76\u6CA1\u6709\u8D77\u5230\u4F5C\u7528\uFF0C\u8FD9\u5C31\u662F\u5220\u9501\u65F6\u7684\u539F\u5B50\u6027\u95EE\u9898\uFF0C\u4E4B\u6240\u4EE5\u6709\u8FD9\u4E2A\u95EE\u9898\uFF0C\u662F\u56E0\u4E3A\u7EBF\u7A0B1\u7684\u62FF\u9501\uFF0C\u6BD4\u9501\uFF0C\u5220\u9501\uFF0C\u5B9E\u9645\u4E0A\u5E76\u4E0D\u662F\u539F\u5B50\u6027\u7684\uFF0C\u6211\u4EEC\u8981\u9632\u6B62\u521A\u624D\u7684\u60C5\u51B5\u53D1\u751F\uFF0C</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653387764938.png" alt="1653387764938"></p><h3 id="_4-7-lua\u811A\u672C\u89E3\u51B3\u591A\u6761\u547D\u4EE4\u539F\u5B50\u6027\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_4-7-lua\u811A\u672C\u89E3\u51B3\u591A\u6761\u547D\u4EE4\u539F\u5B50\u6027\u95EE\u9898" aria-hidden="true">#</a> 4.7 Lua\u811A\u672C\u89E3\u51B3\u591A\u6761\u547D\u4EE4\u539F\u5B50\u6027\u95EE\u9898</h3>`,72),b=s("Redis\u63D0\u4F9B\u4E86Lua\u811A\u672C\u529F\u80FD\uFF0C\u5728\u4E00\u4E2A\u811A\u672C\u4E2D\u7F16\u5199\u591A\u6761Redis\u547D\u4EE4\uFF0C\u786E\u4FDD\u591A\u6761\u547D\u4EE4\u6267\u884C\u65F6\u7684\u539F\u5B50\u6027\u3002Lua\u662F\u4E00\u79CD\u7F16\u7A0B\u8BED\u8A00\uFF0C\u5B83\u7684\u57FA\u672C\u8BED\u6CD5\u5927\u5BB6\u53EF\u4EE5\u53C2\u8003\u7F51\u7AD9\uFF1A"),g={href:"https://www.runoob.com/lua/lua-tutorial.html%EF%BC%8C%E8%BF%99%E9%87%8C%E9%87%8D%E7%82%B9%E4%BB%8B%E7%BB%8DRedis%E6%8F%90%E4%BE%9B%E7%9A%84%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8lua%E5%8E%BB%E6%93%8D%E4%BD%9Credis%EF%BC%8C%E5%8F%88%E8%83%BD%E4%BF%9D%E8%AF%81%E4%BB%96%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E6%8B%BF%E9%94%81%E6%AF%94%E9%94%81%E5%88%A0%E9%94%81%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8E%9F%E5%AD%90%E6%80%A7%E5%8A%A8%E4%BD%9C%E4%BA%86%EF%BC%8C%E4%BD%9C%E4%B8%BAJava%E7%A8%8B%E5%BA%8F%E5%91%98%E8%BF%99%E4%B8%80%E5%9D%97%E5%B9%B6%E4%B8%8D%E4%BD%9C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E8%A6%81%E6%B1%82%EF%BC%8C%E5%B9%B6%E4%B8%8D%E9%9C%80%E8%A6%81%E5%A4%A7%E5%AE%B6%E8%BF%87%E4%BA%8E%E7%B2%BE%E9%80%9A%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%96%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%E5%8D%B3%E5%8F%AF%E3%80%82",target:"_blank",rel:"noopener noreferrer"},h=s("https://www.runoob.com/lua/lua-tutorial.html\uFF0C\u8FD9\u91CC\u91CD\u70B9\u4ECB\u7ECDRedis\u63D0\u4F9B\u7684\u8C03\u7528\u51FD\u6570\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528lua\u53BB\u64CD\u4F5Credis\uFF0C\u53C8\u80FD\u4FDD\u8BC1\u4ED6\u7684\u539F\u5B50\u6027\uFF0C\u8FD9\u6837\u5C31\u53EF\u4EE5\u5B9E\u73B0\u62FF\u9501\u6BD4\u9501\u5220\u9501\u662F\u4E00\u4E2A\u539F\u5B50\u6027\u52A8\u4F5C\u4E86\uFF0C\u4F5C\u4E3AJava\u7A0B\u5E8F\u5458\u8FD9\u4E00\u5757\u5E76\u4E0D\u4F5C\u4E00\u4E2A\u7B80\u5355\u8981\u6C42\uFF0C\u5E76\u4E0D\u9700\u8981\u5927\u5BB6\u8FC7\u4E8E\u7CBE\u901A\uFF0C\u53EA\u9700\u8981\u77E5\u9053\u4ED6\u6709\u4EC0\u4E48\u4F5C\u7528\u5373\u53EF\u3002"),f=t(`<p>\u8FD9\u91CC\u91CD\u70B9\u4ECB\u7ECDRedis\u63D0\u4F9B\u7684\u8C03\u7528\u51FD\u6570\uFF0C\u8BED\u6CD5\u5982\u4E0B\uFF1A</p><div class="language-lua ext-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;\u547D\u4EE4\u540D\u79F0&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;key&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;\u5176\u5B83\u53C2\u6570&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4F8B\u5982\uFF0C\u6211\u4EEC\u8981\u6267\u884Cset name jack\uFF0C\u5219\u811A\u672C\u662F\u8FD9\u6837\uFF1A</p><div class="language-lua ext-lua line-numbers-mode"><pre class="language-lua"><code><span class="token operator">#</span> \u6267\u884C set name jack
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;set&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;jack&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F8B\u5982\uFF0C\u6211\u4EEC\u8981\u5148\u6267\u884Cset name Rose\uFF0C\u518D\u6267\u884Cget name\uFF0C\u5219\u811A\u672C\u5982\u4E0B\uFF1A</p><div class="language-lua ext-lua line-numbers-mode"><pre class="language-lua"><code><span class="token operator">#</span> \u5148\u6267\u884C set name jack
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;set&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Rose&#39;</span><span class="token punctuation">)</span>
<span class="token operator">#</span> \u518D\u6267\u884C get name
<span class="token keyword">local</span> name <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span>
<span class="token operator">#</span> \u8FD4\u56DE
<span class="token keyword">return</span> name
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5199\u597D\u811A\u672C\u4EE5\u540E\uFF0C\u9700\u8981\u7528Redis\u547D\u4EE4\u6765\u8C03\u7528\u811A\u672C\uFF0C\u8C03\u7528\u811A\u672C\u7684\u5E38\u89C1\u547D\u4EE4\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653392181413.png" alt="1653392181413"></p><p>\u4F8B\u5982\uFF0C\u6211\u4EEC\u8981\u6267\u884C redis.call(&#39;set&#39;, &#39;name&#39;, &#39;jack&#39;) \u8FD9\u4E2A\u811A\u672C\uFF0C\u8BED\u6CD5\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653392218531.png" alt="1653392218531"></p><p>\u5982\u679C\u811A\u672C\u4E2D\u7684key\u3001value\u4E0D\u60F3\u5199\u6B7B\uFF0C\u53EF\u4EE5\u4F5C\u4E3A\u53C2\u6570\u4F20\u9012\u3002key\u7C7B\u578B\u53C2\u6570\u4F1A\u653E\u5165KEYS\u6570\u7EC4\uFF0C\u5176\u5B83\u53C2\u6570\u4F1A\u653E\u5165ARGV\u6570\u7EC4\uFF0C\u5728\u811A\u672C\u4E2D\u53EF\u4EE5\u4ECEKEYS\u548CARGV\u6570\u7EC4\u83B7\u53D6\u8FD9\u4E9B\u53C2\u6570\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653392438917.png" alt="1653392438917"></p><p>\u63A5\u4E0B\u6765\u6211\u4EEC\u6765\u56DE\u4E00\u4E0B\u6211\u4EEC\u91CA\u653E\u9501\u7684\u903B\u8F91\uFF1A</p><p>\u91CA\u653E\u9501\u7684\u4E1A\u52A1\u6D41\u7A0B\u662F\u8FD9\u6837\u7684</p><p>\u200B 1\u3001\u83B7\u53D6\u9501\u4E2D\u7684\u7EBF\u7A0B\u6807\u793A</p><p>\u200B 2\u3001\u5224\u65AD\u662F\u5426\u4E0E\u6307\u5B9A\u7684\u6807\u793A\uFF08\u5F53\u524D\u7EBF\u7A0B\u6807\u793A\uFF09\u4E00\u81F4</p><p>\u200B 3\u3001\u5982\u679C\u4E00\u81F4\u5219\u91CA\u653E\u9501\uFF08\u5220\u9664\uFF09</p><p>\u200B 4\u3001\u5982\u679C\u4E0D\u4E00\u81F4\u5219\u4EC0\u4E48\u90FD\u4E0D\u505A</p><p>\u5982\u679C\u7528Lua\u811A\u672C\u6765\u8868\u793A\u5219\u662F\u8FD9\u6837\u7684\uFF1A</p><p>\u6700\u7EC8\u6211\u4EEC\u64CD\u4F5Credis\u7684\u62FF\u9501\u6BD4\u9501\u5220\u9501\u7684lua\u811A\u672C\u5C31\u4F1A\u53D8\u6210\u8FD9\u6837</p><div class="language-lua ext-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- \u8FD9\u91CC\u7684 KEYS[1] \u5C31\u662F\u9501\u7684key\uFF0C\u8FD9\u91CC\u7684ARGV[1] \u5C31\u662F\u5F53\u524D\u7EBF\u7A0B\u6807\u793A</span>
<span class="token comment">-- \u83B7\u53D6\u9501\u4E2D\u7684\u6807\u793A\uFF0C\u5224\u65AD\u662F\u5426\u4E0E\u5F53\u524D\u7EBF\u7A0B\u6807\u793A\u4E00\u81F4</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;GET&#39;</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
  <span class="token comment">-- \u4E00\u81F4\uFF0C\u5219\u5220\u9664\u9501</span>
  <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;DEL&#39;</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">-- \u4E0D\u4E00\u81F4\uFF0C\u5219\u76F4\u63A5\u8FD4\u56DE</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-8-\u5229\u7528java\u4EE3\u7801\u8C03\u7528lua\u811A\u672C\u6539\u9020\u5206\u5E03\u5F0F\u9501" tabindex="-1"><a class="header-anchor" href="#_4-8-\u5229\u7528java\u4EE3\u7801\u8C03\u7528lua\u811A\u672C\u6539\u9020\u5206\u5E03\u5F0F\u9501" aria-hidden="true">#</a> 4.8 \u5229\u7528Java\u4EE3\u7801\u8C03\u7528Lua\u811A\u672C\u6539\u9020\u5206\u5E03\u5F0F\u9501</h3><p>lua\u811A\u672C\u672C\u8EAB\u5E76\u4E0D\u9700\u8981\u5927\u5BB6\u82B1\u8D39\u592A\u591A\u65F6\u95F4\u53BB\u7814\u7A76\uFF0C\u53EA\u9700\u8981\u77E5\u9053\u5982\u4F55\u8C03\u7528\uFF0C\u5927\u81F4\u662F\u4EC0\u4E48\u610F\u601D\u5373\u53EF\uFF0C\u6240\u4EE5\u5728\u7B14\u8BB0\u4E2D\u5E76\u4E0D\u4F1A\u8BE6\u7EC6\u7684\u53BB\u89E3\u91CA\u8FD9\u4E9Blua\u8868\u8FBE\u5F0F\u7684\u542B\u4E49\u3002</p><p>\u6211\u4EEC\u7684RedisTemplate\u4E2D\uFF0C\u53EF\u4EE5\u5229\u7528execute\u65B9\u6CD5\u53BB\u6267\u884Clua\u811A\u672C\uFF0C\u53C2\u6570\u5BF9\u5E94\u5173\u7CFB\u5C31\u5982\u4E0B\u56FE\u80A1</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653393304844.png" alt="1653393304844"></p><p><strong>Java\u4EE3\u7801</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> UNLOCK_SCRIPT<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        UNLOCK_SCRIPT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UNLOCK_SCRIPT<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;unlock.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UNLOCK_SCRIPT<span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u8C03\u7528lua\u811A\u672C</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
            UNLOCK_SCRIPT<span class="token punctuation">,</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
            ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7ECF\u8FC7\u4EE5\u4E0A\u4EE3\u7801\u6539\u9020\u540E\uFF0C\u6211\u4EEC\u5C31\u80FD\u591F\u5B9E\u73B0 \u62FF\u9501\u6BD4\u9501\u5220\u9501\u7684\u539F\u5B50\u6027\u52A8\u4F5C\u4E86~</p><p><strong>\u5C0F\u603B\u7ED3\uFF1A</strong></p><p>\u57FA\u4E8ERedis\u7684\u5206\u5E03\u5F0F\u9501\u5B9E\u73B0\u601D\u8DEF\uFF1A</p><ul><li>\u5229\u7528set nx ex\u83B7\u53D6\u9501\uFF0C\u5E76\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\uFF0C\u4FDD\u5B58\u7EBF\u7A0B\u6807\u793A</li><li>\u91CA\u653E\u9501\u65F6\u5148\u5224\u65AD\u7EBF\u7A0B\u6807\u793A\u662F\u5426\u4E0E\u81EA\u5DF1\u4E00\u81F4\uFF0C\u4E00\u81F4\u5219\u5220\u9664\u9501 <ul><li>\u7279\u6027\uFF1A <ul><li>\u5229\u7528set nx\u6EE1\u8DB3\u4E92\u65A5\u6027</li><li>\u5229\u7528set ex\u4FDD\u8BC1\u6545\u969C\u65F6\u9501\u4F9D\u7136\u80FD\u91CA\u653E\uFF0C\u907F\u514D\u6B7B\u9501\uFF0C\u63D0\u9AD8\u5B89\u5168\u6027</li><li>\u5229\u7528Redis\u96C6\u7FA4\u4FDD\u8BC1\u9AD8\u53EF\u7528\u548C\u9AD8\u5E76\u53D1\u7279\u6027</li></ul></li></ul></li></ul><p>\u7B14\u8005\u603B\u7ED3\uFF1A\u6211\u4EEC\u4E00\u8DEF\u8D70\u6765\uFF0C\u5229\u7528\u6DFB\u52A0\u8FC7\u671F\u65F6\u95F4\uFF0C\u9632\u6B62\u6B7B\u9501\u95EE\u9898\u7684\u53D1\u751F\uFF0C\u4F46\u662F\u6709\u4E86\u8FC7\u671F\u65F6\u95F4\u4E4B\u540E\uFF0C\u53EF\u80FD\u51FA\u73B0\u8BEF\u5220\u522B\u4EBA\u9501\u7684\u95EE\u9898\uFF0C\u8FD9\u4E2A\u95EE\u9898\u6211\u4EEC\u5F00\u59CB\u662F\u5229\u7528\u5220\u4E4B\u524D \u901A\u8FC7\u62FF\u9501\uFF0C\u6BD4\u9501\uFF0C\u5220\u9501\u8FD9\u4E2A\u903B\u8F91\u6765\u89E3\u51B3\u7684\uFF0C\u4E5F\u5C31\u662F\u5220\u4E4B\u524D\u5224\u65AD\u4E00\u4E0B\u5F53\u524D\u8FD9\u628A\u9501\u662F\u5426\u662F\u5C5E\u4E8E\u81EA\u5DF1\u7684\uFF0C\u4F46\u662F\u73B0\u5728\u8FD8\u6709\u539F\u5B50\u6027\u95EE\u9898\uFF0C\u4E5F\u5C31\u662F\u6211\u4EEC\u6CA1\u6CD5\u4FDD\u8BC1\u62FF\u9501\u6BD4\u9501\u5220\u9501\u662F\u4E00\u4E2A\u539F\u5B50\u6027\u7684\u52A8\u4F5C\uFF0C\u6700\u540E\u901A\u8FC7lua\u8868\u8FBE\u5F0F\u6765\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898</p><p>\u4F46\u662F\u76EE\u524D\u8FD8\u5269\u4E0B\u4E00\u4E2A\u95EE\u9898\u9501\u4E0D\u4F4F\uFF0C\u4EC0\u4E48\u662F\u9501\u4E0D\u4F4F\u5462\uFF0C\u4F60\u60F3\u4E00\u60F3\uFF0C\u5982\u679C\u5F53\u8FC7\u671F\u65F6\u95F4\u5230\u4E86\u4E4B\u540E\uFF0C\u6211\u4EEC\u53EF\u4EE5\u7ED9\u4ED6\u7EED\u671F\u4E00\u4E0B\uFF0C\u6BD4\u5982\u7EED\u4E2A30s\uFF0C\u5C31\u597D\u50CF\u662F\u7F51\u5427\u4E0A\u7F51\uFF0C \u7F51\u8D39\u5230\u4E86\u4E4B\u540E\uFF0C\u7136\u540E\u8BF4\uFF0C\u6765\uFF0C\u7F51\u7BA1\uFF0C\u518D\u7ED9\u6211\u676510\u5757\u7684\uFF0C\u662F\u4E0D\u662F\u540E\u8FB9\u7684\u95EE\u9898\u90FD\u4E0D\u4F1A\u53D1\u751F\u4E86\uFF0C\u90A3\u4E48\u7EED\u671F\u95EE\u9898\u600E\u4E48\u89E3\u51B3\u5462\uFF0C\u53EF\u4EE5\u4F9D\u8D56\u4E8E\u6211\u4EEC\u63A5\u4E0B\u6765\u8981\u5B66\u4E60redission\u5566</p><p><strong>\u6D4B\u8BD5\u903B\u8F91\uFF1A</strong></p><p>\u7B2C\u4E00\u4E2A\u7EBF\u7A0B\u8FDB\u6765\uFF0C\u5F97\u5230\u4E86\u9501\uFF0C\u624B\u52A8\u5220\u9664\u9501\uFF0C\u6A21\u62DF\u9501\u8D85\u65F6\u4E86\uFF0C\u5176\u4ED6\u7EBF\u7A0B\u4F1A\u6267\u884Clua\u6765\u62A2\u9501\uFF0C\u5F53\u7B2C\u4E00\u4E2A\u7EBF\u7A0B\u5229\u7528lua\u5220\u9664\u9501\u65F6\uFF0Clua\u80FD\u4FDD\u8BC1\u4ED6\u4E0D\u80FD\u5220\u9664\u4ED6\u7684\u9501\uFF0C\u7B2C\u4E8C\u4E2A\u7EBF\u7A0B\u5220\u9664\u9501\u65F6\uFF0C\u5229\u7528lua\u540C\u6837\u53EF\u4EE5\u4FDD\u8BC1\u4E0D\u4F1A\u5220\u9664\u522B\u4EBA\u7684\u9501\uFF0C\u540C\u65F6\u8FD8\u80FD\u4FDD\u8BC1\u539F\u5B50\u6027\u3002</p><h2 id="_5\u3001\u5206\u5E03\u5F0F\u9501-redission" tabindex="-1"><a class="header-anchor" href="#_5\u3001\u5206\u5E03\u5F0F\u9501-redission" aria-hidden="true">#</a> 5\u3001\u5206\u5E03\u5F0F\u9501-redission</h2><h3 id="_5-1-\u5206\u5E03\u5F0F\u9501-redission\u529F\u80FD\u4ECB\u7ECD" tabindex="-1"><a class="header-anchor" href="#_5-1-\u5206\u5E03\u5F0F\u9501-redission\u529F\u80FD\u4ECB\u7ECD" aria-hidden="true">#</a> 5.1 \u5206\u5E03\u5F0F\u9501-redission\u529F\u80FD\u4ECB\u7ECD</h3><p>\u57FA\u4E8Esetnx\u5B9E\u73B0\u7684\u5206\u5E03\u5F0F\u9501\u5B58\u5728\u4E0B\u9762\u7684\u95EE\u9898\uFF1A</p><p><strong>\u91CD\u5165\u95EE\u9898</strong>\uFF1A\u91CD\u5165\u95EE\u9898\u662F\u6307 \u83B7\u5F97\u9501\u7684\u7EBF\u7A0B\u53EF\u4EE5\u518D\u6B21\u8FDB\u5165\u5230\u76F8\u540C\u7684\u9501\u7684\u4EE3\u7801\u5757\u4E2D\uFF0C\u53EF\u91CD\u5165\u9501\u7684\u610F\u4E49\u5728\u4E8E\u9632\u6B62\u6B7B\u9501\uFF0C\u6BD4\u5982HashTable\u8FD9\u6837\u7684\u4EE3\u7801\u4E2D\uFF0C\u4ED6\u7684\u65B9\u6CD5\u90FD\u662F\u4F7F\u7528synchronized\u4FEE\u9970\u7684\uFF0C\u5047\u5982\u4ED6\u5728\u4E00\u4E2A\u65B9\u6CD5\u5185\uFF0C\u8C03\u7528\u53E6\u4E00\u4E2A\u65B9\u6CD5\uFF0C\u90A3\u4E48\u6B64\u65F6\u5982\u679C\u662F\u4E0D\u53EF\u91CD\u5165\u7684\uFF0C\u4E0D\u5C31\u6B7B\u9501\u4E86\u5417\uFF1F\u6240\u4EE5\u53EF\u91CD\u5165\u9501\u4ED6\u7684\u4E3B\u8981\u610F\u4E49\u662F\u9632\u6B62\u6B7B\u9501\uFF0C\u6211\u4EEC\u7684synchronized\u548CLock\u9501\u90FD\u662F\u53EF\u91CD\u5165\u7684\u3002</p><p><strong>\u4E0D\u53EF\u91CD\u8BD5</strong>\uFF1A\u662F\u6307\u76EE\u524D\u7684\u5206\u5E03\u5F0F\u53EA\u80FD\u5C1D\u8BD5\u4E00\u6B21\uFF0C\u6211\u4EEC\u8BA4\u4E3A\u5408\u7406\u7684\u60C5\u51B5\u662F\uFF1A\u5F53\u7EBF\u7A0B\u5728\u83B7\u5F97\u9501\u5931\u8D25\u540E\uFF0C\u4ED6\u5E94\u8BE5\u80FD\u518D\u6B21\u5C1D\u8BD5\u83B7\u5F97\u9501\u3002</p><p>**\u8D85\u65F6\u91CA\u653E\uFF1A**\u6211\u4EEC\u5728\u52A0\u9501\u65F6\u589E\u52A0\u4E86\u8FC7\u671F\u65F6\u95F4\uFF0C\u8FD9\u6837\u7684\u6211\u4EEC\u53EF\u4EE5\u9632\u6B62\u6B7B\u9501\uFF0C\u4F46\u662F\u5982\u679C\u5361\u987F\u7684\u65F6\u95F4\u8D85\u957F\uFF0C\u867D\u7136\u6211\u4EEC\u91C7\u7528\u4E86lua\u8868\u8FBE\u5F0F\u9632\u6B62\u5220\u9501\u7684\u65F6\u5019\uFF0C\u8BEF\u5220\u522B\u4EBA\u7684\u9501\uFF0C\u4F46\u662F\u6BD5\u7ADF\u6CA1\u6709\u9501\u4F4F\uFF0C\u6709\u5B89\u5168\u9690\u60A3</p><p><strong>\u4E3B\u4ECE\u4E00\u81F4\u6027\uFF1A</strong> \u5982\u679CRedis\u63D0\u4F9B\u4E86\u4E3B\u4ECE\u96C6\u7FA4\uFF0C\u5F53\u6211\u4EEC\u5411\u96C6\u7FA4\u5199\u6570\u636E\u65F6\uFF0C\u4E3B\u673A\u9700\u8981\u5F02\u6B65\u7684\u5C06\u6570\u636E\u540C\u6B65\u7ED9\u4ECE\u673A\uFF0C\u800C\u4E07\u4E00\u5728\u540C\u6B65\u8FC7\u53BB\u4E4B\u524D\uFF0C\u4E3B\u673A\u5B95\u673A\u4E86\uFF0C\u5C31\u4F1A\u51FA\u73B0\u6B7B\u9501\u95EE\u9898\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653546070602.png" alt="1653546070602"></p><p>\u90A3\u4E48\u4EC0\u4E48\u662FRedission\u5462</p><p>Redisson\u662F\u4E00\u4E2A\u5728Redis\u7684\u57FA\u7840\u4E0A\u5B9E\u73B0\u7684Java\u9A7B\u5185\u5B58\u6570\u636E\u7F51\u683C\uFF08In-Memory Data Grid\uFF09\u3002\u5B83\u4E0D\u4EC5\u63D0\u4F9B\u4E86\u4E00\u7CFB\u5217\u7684\u5206\u5E03\u5F0F\u7684Java\u5E38\u7528\u5BF9\u8C61\uFF0C\u8FD8\u63D0\u4F9B\u4E86\u8BB8\u591A\u5206\u5E03\u5F0F\u670D\u52A1\uFF0C\u5176\u4E2D\u5C31\u5305\u542B\u4E86\u5404\u79CD\u5206\u5E03\u5F0F\u9501\u7684\u5B9E\u73B0\u3002</p><p>Redission\u63D0\u4F9B\u4E86\u5206\u5E03\u5F0F\u9501\u7684\u591A\u79CD\u591A\u6837\u7684\u529F\u80FD</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653546736063.png" alt="1653546736063"></p><h3 id="_5-2-\u5206\u5E03\u5F0F\u9501-redission\u5FEB\u901F\u5165\u95E8" tabindex="-1"><a class="header-anchor" href="#_5-2-\u5206\u5E03\u5F0F\u9501-redission\u5FEB\u901F\u5165\u95E8" aria-hidden="true">#</a> 5.2 \u5206\u5E03\u5F0F\u9501-Redission\u5FEB\u901F\u5165\u95E8</h3><p>\u5F15\u5165\u4F9D\u8D56\uFF1A</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.13.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u914D\u7F6ERedisson\u5BA2\u6237\u7AEF\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// \u914D\u7F6E</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.150.101:6379&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123321&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u521B\u5EFARedissonClient\u5BF9\u8C61</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5982\u4F55\u4F7F\u7528Redission\u7684\u5206\u5E03\u5F0F\u9501</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissionClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token comment">//\u83B7\u53D6\u9501(\u53EF\u91CD\u5165)\uFF0C\u6307\u5B9A\u9501\u7684\u540D\u79F0</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u5C1D\u8BD5\u83B7\u53D6\u9501\uFF0C\u53C2\u6570\u5206\u522B\u662F\uFF1A\u83B7\u53D6\u9501\u7684\u6700\u5927\u7B49\u5F85\u65F6\u95F4(\u671F\u95F4\u4F1A\u91CD\u8BD5\uFF0C\u9ED8\u8BA4\u662F-1\uFF0C\u4E0D\u91CD\u8BD5\uFF0C\u76F4\u63A5\u8FD4\u56DE)\uFF0C\u9501\u81EA\u52A8\u91CA\u653E\u65F6\u95F4\uFF08\u9ED8\u8BA430s\uFF09\uFF0C\u65F6\u95F4\u5355\u4F4D</span>
    <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u5224\u65AD\u83B7\u53D6\u9501\u6210\u529F</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\u6267\u884C\u4E1A\u52A1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          
        <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
            <span class="token comment">//\u91CA\u653E\u9501</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 VoucherOrderServiceImpl</p><p>\u6CE8\u5165RedissonClient</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u67E5\u8BE2\u4F18\u60E0\u5238</span>
        <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5224\u65AD\u79D2\u6740\u662F\u5426\u5F00\u59CB</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5C1A\u672A\u5F00\u59CB</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u79D2\u6740\u5C1A\u672A\u5F00\u59CB\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.\u5224\u65AD\u79D2\u6740\u662F\u5426\u5DF2\u7ECF\u7ED3\u675F</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5C1A\u672A\u5F00\u59CB</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u79D2\u6740\u5DF2\u7ECF\u7ED3\u675F\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.\u5224\u65AD\u5E93\u5B58\u662F\u5426\u5145\u8DB3</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5E93\u5B58\u4E0D\u8DB3</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u521B\u5EFA\u9501\u5BF9\u8C61 \u8FD9\u4E2A\u4EE3\u7801\u4E0D\u7528\u4E86\uFF0C\u56E0\u4E3A\u6211\u4EEC\u73B0\u5728\u8981\u4F7F\u7528\u5206\u5E03\u5F0F\u9501</span>
        <span class="token comment">//SimpleRedisLock lock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u83B7\u53D6\u9501\u5BF9\u8C61</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
		<span class="token comment">//\u52A0\u9501\u5931\u8D25</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u4E0D\u5141\u8BB8\u91CD\u590D\u4E0B\u5355&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u83B7\u53D6\u4EE3\u7406\u5BF9\u8C61(\u4E8B\u52A1)</span>
            <span class="token class-name">IVoucherOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u91CA\u653E\u9501</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-\u5206\u5E03\u5F0F\u9501-redission\u53EF\u91CD\u5165\u9501\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#_5-3-\u5206\u5E03\u5F0F\u9501-redission\u53EF\u91CD\u5165\u9501\u539F\u7406" aria-hidden="true">#</a> 5.3 \u5206\u5E03\u5F0F\u9501-redission\u53EF\u91CD\u5165\u9501\u539F\u7406</h3><p>\u5728Lock\u9501\u4E2D\uFF0C\u4ED6\u662F\u501F\u52A9\u4E8E\u5E95\u5C42\u7684\u4E00\u4E2Avoaltile\u7684\u4E00\u4E2Astate\u53D8\u91CF\u6765\u8BB0\u5F55\u91CD\u5165\u7684\u72B6\u6001\u7684\uFF0C\u6BD4\u5982\u5F53\u524D\u6CA1\u6709\u4EBA\u6301\u6709\u8FD9\u628A\u9501\uFF0C\u90A3\u4E48state=0\uFF0C\u5047\u5982\u6709\u4EBA\u6301\u6709\u8FD9\u628A\u9501\uFF0C\u90A3\u4E48state=1\uFF0C\u5982\u679C\u6301\u6709\u8FD9\u628A\u9501\u7684\u4EBA\u518D\u6B21\u6301\u6709\u8FD9\u628A\u9501\uFF0C\u90A3\u4E48state\u5C31\u4F1A+1 \uFF0C\u5982\u679C\u662F\u5BF9\u4E8Esynchronized\u800C\u8A00\uFF0C\u4ED6\u5728c\u8BED\u8A00\u4EE3\u7801\u4E2D\u4F1A\u6709\u4E00\u4E2Acount\uFF0C\u539F\u7406\u548Cstate\u7C7B\u4F3C\uFF0C\u4E5F\u662F\u91CD\u5165\u4E00\u6B21\u5C31\u52A0\u4E00\uFF0C\u91CA\u653E\u4E00\u6B21\u5C31-1 \uFF0C\u76F4\u5230\u51CF\u5C11\u62100 \u65F6\uFF0C\u8868\u793A\u5F53\u524D\u8FD9\u628A\u9501\u6CA1\u6709\u88AB\u4EBA\u6301\u6709\u3002</p><p>\u5728redission\u4E2D\uFF0C\u6211\u4EEC\u7684\u4E5F\u652F\u6301\u652F\u6301\u53EF\u91CD\u5165\u9501</p><p>\u5728\u5206\u5E03\u5F0F\u9501\u4E2D\uFF0C\u4ED6\u91C7\u7528hash\u7ED3\u6784\u7528\u6765\u5B58\u50A8\u9501\uFF0C\u5176\u4E2D\u5927key\u8868\u793A\u8868\u793A\u8FD9\u628A\u9501\u662F\u5426\u5B58\u5728\uFF0C\u7528\u5C0Fkey\u8868\u793A\u5F53\u524D\u8FD9\u628A\u9501\u88AB\u54EA\u4E2A\u7EBF\u7A0B\u6301\u6709\uFF0C\u6240\u4EE5\u63A5\u4E0B\u6765\u6211\u4EEC\u4E00\u8D77\u5206\u6790\u4E00\u4E0B\u5F53\u524D\u7684\u8FD9\u4E2Alua\u8868\u8FBE\u5F0F</p><p>\u8FD9\u4E2A\u5730\u65B9\u4E00\u5171\u67093\u4E2A\u53C2\u6570</p><p><strong>KEYS[1] \uFF1A \u9501\u540D\u79F0</strong></p><p><strong>ARGV[1]\uFF1A \u9501\u5931\u6548\u65F6\u95F4</strong></p><p><strong>ARGV[2]\uFF1A id + &quot;:&quot; + threadId; \u9501\u7684\u5C0Fkey</strong></p><p>exists: \u5224\u65AD\u6570\u636E\u662F\u5426\u5B58\u5728 name\uFF1A\u662Flock\u662F\u5426\u5B58\u5728,\u5982\u679C==0\uFF0C\u5C31\u8868\u793A\u5F53\u524D\u8FD9\u628A\u9501\u4E0D\u5B58\u5728</p><p>redis.call(&#39;hset&#39;, KEYS[1], ARGV[2], 1);\u6B64\u65F6\u4ED6\u5C31\u5F00\u59CB\u5F80redis\u91CC\u8FB9\u53BB\u5199\u6570\u636E \uFF0C\u5199\u6210\u4E00\u4E2Ahash\u7ED3\u6784</p><p>Lock{</p><p>\u200B id + <strong>&quot;:&quot;</strong> + threadId : 1</p><p>}</p><p>\u5982\u679C\u5F53\u524D\u8FD9\u628A\u9501\u5B58\u5728\uFF0C\u5219\u7B2C\u4E00\u4E2A\u6761\u4EF6\u4E0D\u6EE1\u8DB3\uFF0C\u518D\u5224\u65AD</p><p>redis.call(&#39;hexists&#39;, KEYS[1], ARGV[2]) == 1</p><p>\u6B64\u65F6\u9700\u8981\u901A\u8FC7\u5927key+\u5C0Fkey\u5224\u65AD\u5F53\u524D\u8FD9\u628A\u9501\u662F\u5426\u662F\u5C5E\u4E8E\u81EA\u5DF1\u7684\uFF0C\u5982\u679C\u662F\u81EA\u5DF1\u7684\uFF0C\u5219\u8FDB\u884C</p><p>redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[2], 1)</p><p>\u5C06\u5F53\u524D\u8FD9\u4E2A\u9501\u7684value\u8FDB\u884C+1 \uFF0Credis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); \u7136\u540E\u518D\u5BF9\u5176\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\uFF0C\u5982\u679C\u4EE5\u4E0A\u4E24\u4E2A\u6761\u4EF6\u90FD\u4E0D\u6EE1\u8DB3\uFF0C\u5219\u8868\u793A\u5F53\u524D\u8FD9\u628A\u9501\u62A2\u9501\u5931\u8D25\uFF0C\u6700\u540E\u8FD4\u56DEpttl\uFF0C\u5373\u4E3A\u5F53\u524D\u8FD9\u628A\u9501\u7684\u5931\u6548\u65F6\u95F4</p><p>\u5982\u679C\u5C0F\u4F19\u4F34\u4EEC\u770B\u4E86\u524D\u8FB9\u7684\u6E90\u7801\uFF0C \u4F60\u4F1A\u53D1\u73B0\u4ED6\u4F1A\u53BB\u5224\u65AD\u5F53\u524D\u8FD9\u4E2A\u65B9\u6CD5\u7684\u8FD4\u56DE\u503C\u662F\u5426\u4E3Anull\uFF0C\u5982\u679C\u662Fnull\uFF0C\u5219\u5BF9\u5E94\u5219\u524D\u4E24\u4E2Aif\u5BF9\u5E94\u7684\u6761\u4EF6\uFF0C\u9000\u51FA\u62A2\u9501\u903B\u8F91\uFF0C\u5982\u679C\u8FD4\u56DE\u7684\u4E0D\u662Fnull\uFF0C\u5373\u8D70\u4E86\u7B2C\u4E09\u4E2A\u5206\u652F\uFF0C\u5728\u6E90\u7801\u5904\u4F1A\u8FDB\u884Cwhile(true)\u7684\u81EA\u65CB\u62A2\u9501\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220729212954440.png" alt="image-20220729212954440"></p><p>\u91CA\u653E\u9501</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220729213214921.png" alt="image-20220729213214921"></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653548087334.png" alt="1653548087334"></p><h3 id="_5-4-\u5206\u5E03\u5F0F\u9501-redission\u9501\u91CD\u8BD5\u548Cwatchdog\u673A\u5236" tabindex="-1"><a class="header-anchor" href="#_5-4-\u5206\u5E03\u5F0F\u9501-redission\u9501\u91CD\u8BD5\u548Cwatchdog\u673A\u5236" aria-hidden="true">#</a> 5.4 \u5206\u5E03\u5F0F\u9501-redission\u9501\u91CD\u8BD5\u548CWatchDog\u673A\u5236</h3><p><strong>\u8BF4\u660E</strong>\uFF1A\u7531\u4E8E\u8BFE\u7A0B\u4E2D\u5DF2\u7ECF\u8BF4\u660E\u4E86\u6709\u5173tryLock\u7684\u6E90\u7801\u89E3\u6790\u4EE5\u53CA\u5176\u770B\u95E8\u72D7\u539F\u7406\uFF0C\u6240\u4EE5\u7B14\u8005\u5728\u8FD9\u91CC\u7ED9\u5927\u5BB6\u5206\u6790lock()\u65B9\u6CD5\u7684\u6E90\u7801\u89E3\u6790\uFF0C\u5E0C\u671B\u5927\u5BB6\u5728\u5B66\u4E60\u8FC7\u7A0B\u4E2D\uFF0C\u80FD\u591F\u638C\u63E1\u66F4\u591A\u7684\u77E5\u8BC6</p><p>\u62A2\u9501\u8FC7\u7A0B\u4E2D\uFF0C\u83B7\u5F97\u5F53\u524D\u7EBF\u7A0B\uFF0C\u901A\u8FC7tryAcquire\u8FDB\u884C\u62A2\u9501\uFF0C\u8BE5\u62A2\u9501\u903B\u8F91\u548C\u4E4B\u524D\u903B\u8F91\u76F8\u540C</p><p>1\u3001\u5148\u5224\u65AD\u5F53\u524D\u8FD9\u628A\u9501\u662F\u5426\u5B58\u5728\uFF0C\u5982\u679C\u4E0D\u5B58\u5728\uFF0C\u63D2\u5165\u4E00\u628A\u9501\uFF0C\u8FD4\u56DEnull</p><p>2\u3001\u5224\u65AD\u5F53\u524D\u8FD9\u628A\u9501\u662F\u5426\u662F\u5C5E\u4E8E\u5F53\u524D\u7EBF\u7A0B\uFF0C\u5982\u679C\u662F\uFF0C\u5219\u8FD4\u56DEnull</p><p>\u6240\u4EE5\u5982\u679C\u8FD4\u56DE\u662Fnull\uFF0C\u5219\u4EE3\u8868\u7740\u5F53\u524D\u8FD9\u54E5\u4EEC\u5DF2\u7ECF\u62A2\u9501\u5B8C\u6BD5\uFF0C\u6216\u8005\u53EF\u91CD\u5165\u5B8C\u6BD5\uFF0C\u4F46\u662F\u5982\u679C\u4EE5\u4E0A\u4E24\u4E2A\u6761\u4EF6\u90FD\u4E0D\u6EE1\u8DB3\uFF0C\u5219\u8FDB\u5165\u5230\u7B2C\u4E09\u4E2A\u6761\u4EF6\uFF0C\u8FD4\u56DE\u7684\u662F\u9501\u7684\u5931\u6548\u65F6\u95F4\uFF0C\u540C\u5B66\u4EEC\u53EF\u4EE5\u81EA\u884C\u5F80\u4E0B\u7FFB\u4E00\u70B9\u70B9\uFF0C\u4F60\u80FD\u53D1\u73B0\u6709\u4E2Awhile( true) \u518D\u6B21\u8FDB\u884CtryAcquire\u8FDB\u884C\u62A2\u9501</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">long</span> threadId <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Long</span> ttl <span class="token operator">=</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// lock acquired</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ttl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\u4F1A\u6709\u4E00\u4E2A\u6761\u4EF6\u5206\u652F\uFF0C\u56E0\u4E3Alock\u65B9\u6CD5\u6709\u91CD\u8F7D\u65B9\u6CD5\uFF0C\u4E00\u4E2A\u662F\u5E26\u53C2\u6570\uFF0C\u4E00\u4E2A\u662F\u4E0D\u5E26\u53C2\u6570\uFF0C\u5982\u679C\u5E26\u5E26\u53C2\u6570\u4F20\u5165\u7684\u503C\u662F-1\uFF0C\u5982\u679C\u4F20\u5165\u53C2\u6570\uFF0C\u5219leaseTime\u662F\u4ED6\u672C\u8EAB\uFF0C\u6240\u4EE5\u5982\u679C\u4F20\u5165\u4E86\u53C2\u6570\uFF0C\u6B64\u65F6leaseTime != -1 \u5219\u4F1A\u8FDB\u53BB\u62A2\u9501\uFF0C\u62A2\u9501\u7684\u903B\u8F91\u5C31\u662F\u4E4B\u524D\u8BF4\u7684\u90A3\u4E09\u4E2A\u903B\u8F91</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span>EVAL_LONG<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5982\u679C\u662F\u6CA1\u6709\u4F20\u5165\u65F6\u95F4\uFF0C\u5219\u6B64\u65F6\u4E5F\u4F1A\u8FDB\u884C\u62A2\u9501\uFF0C \u800C\u4E14\u62A2\u9501\u65F6\u95F4\u662F\u9ED8\u8BA4\u770B\u95E8\u72D7\u65F6\u95F4 commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout()</p><p>ttlRemainingFuture.onComplete((ttlRemaining, e) \u8FD9\u53E5\u8BDD\u76F8\u5F53\u4E8E\u5BF9\u4EE5\u4E0A\u62A2\u9501\u8FDB\u884C\u4E86\u76D1\u542C\uFF0C\u4E5F\u5C31\u662F\u8BF4\u5F53\u4E0A\u8FB9\u62A2\u9501\u5B8C\u6BD5\u540E\uFF0C\u6B64\u65B9\u6CD5\u4F1A\u88AB\u8C03\u7528\uFF0C\u5177\u4F53\u8C03\u7528\u7684\u903B\u8F91\u5C31\u662F\u53BB\u540E\u53F0\u5F00\u542F\u4E00\u4E2A\u7EBF\u7A0B\uFF0C\u8FDB\u884C\u7EED\u7EA6\u903B\u8F91\uFF0C\u4E5F\u5C31\u662F\u770B\u95E8\u72D7\u7EBF\u7A0B</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ttlRemainingFuture <span class="token operator">=</span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span>
                                        commandExecutor<span class="token punctuation">.</span><span class="token function">getConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCfg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLockWatchdogTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span>EVAL_LONG<span class="token punctuation">)</span><span class="token punctuation">;</span>
ttlRemainingFuture<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ttlRemaining<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// lock acquired</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ttlRemaining <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> ttlRemainingFuture<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u903B\u8F91\u5C31\u662F\u7EED\u7EA6\u903B\u8F91\uFF0C\u6CE8\u610F\u770BcommandExecutor.getConnectionManager().newTimeout\uFF08\uFF09 \u6B64\u65B9\u6CD5</p><p>Method( <strong>new</strong> TimerTask() {},\u53C2\u65702 \uFF0C\u53C2\u65703 )</p><p>\u6307\u7684\u662F\uFF1A\u901A\u8FC7\u53C2\u65702\uFF0C\u53C2\u65703 \u53BB\u63CF\u8FF0\u4EC0\u4E48\u65F6\u5019\u53BB\u505A\u53C2\u65701\u7684\u4E8B\u60C5\uFF0C\u73B0\u5728\u7684\u60C5\u51B5\u662F\uFF1A10s\u4E4B\u540E\u53BB\u505A\u53C2\u6570\u4E00\u7684\u4E8B\u60C5</p><p>\u56E0\u4E3A\u9501\u7684\u5931\u6548\u65F6\u95F4\u662F30s\uFF0C\u5F5310s\u4E4B\u540E\uFF0C\u6B64\u65F6\u8FD9\u4E2AtimeTask \u5C31\u89E6\u53D1\u4E86\uFF0C\u4ED6\u5C31\u53BB\u8FDB\u884C\u7EED\u7EA6\uFF0C\u628A\u5F53\u524D\u8FD9\u628A\u9501\u7EED\u7EA6\u621030s\uFF0C\u5982\u679C\u64CD\u4F5C\u6210\u529F\uFF0C\u90A3\u4E48\u6B64\u65F6\u5C31\u4F1A\u9012\u5F52\u8C03\u7528\u81EA\u5DF1\uFF0C\u518D\u91CD\u65B0\u8BBE\u7F6E\u4E00\u4E2AtimeTask()\uFF0C\u4E8E\u662F\u518D\u8FC710s\u540E\u53C8\u518D\u8BBE\u7F6E\u4E00\u4E2AtimerTask\uFF0C\u5B8C\u6210\u4E0D\u505C\u7684\u7EED\u7EA6</p><p>\u90A3\u4E48\u5927\u5BB6\u53EF\u4EE5\u60F3\u4E00\u60F3\uFF0C\u5047\u8BBE\u6211\u4EEC\u7684\u7EBF\u7A0B\u51FA\u73B0\u4E86\u5B95\u673A\u4ED6\u8FD8\u4F1A\u7EED\u7EA6\u5417\uFF1F\u5F53\u7136\u4E0D\u4F1A\uFF0C\u56E0\u4E3A\u6CA1\u6709\u4EBA\u518D\u53BB\u8C03\u7528renewExpiration\u8FD9\u4E2A\u65B9\u6CD5\uFF0C\u6240\u4EE5\u7B49\u5230\u65F6\u95F4\u4E4B\u540E\u81EA\u7136\u5C31\u91CA\u653E\u4E86\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExpirationEntry</span> ee <span class="token operator">=</span> EXPIRATION_RENEWAL_MAP<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ee <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token class-name">Timeout</span> task <span class="token operator">=</span> commandExecutor<span class="token punctuation">.</span><span class="token function">getConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newTimeout</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Timeout</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ExpirationEntry</span> ent <span class="token operator">=</span> EXPIRATION_RENEWAL_MAP<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Long</span> threadId <span class="token operator">=</span> ent<span class="token punctuation">.</span><span class="token function">getFirstThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token function">renewExpirationAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Can&#39;t update lock &quot;</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; expiration&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// reschedule itself</span>
                    <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> internalLockLeaseTime <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ee<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-\u5206\u5E03\u5F0F\u9501-redission\u9501\u7684mutilock\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#_5-5-\u5206\u5E03\u5F0F\u9501-redission\u9501\u7684mutilock\u539F\u7406" aria-hidden="true">#</a> 5.5 \u5206\u5E03\u5F0F\u9501-redission\u9501\u7684MutiLock\u539F\u7406</h3><p>\u4E3A\u4E86\u63D0\u9AD8redis\u7684\u53EF\u7528\u6027\uFF0C\u6211\u4EEC\u4F1A\u642D\u5EFA\u96C6\u7FA4\u6216\u8005\u4E3B\u4ECE\uFF0C\u73B0\u5728\u4EE5\u4E3B\u4ECE\u4E3A\u4F8B</p><p>\u6B64\u65F6\u6211\u4EEC\u53BB\u5199\u547D\u4EE4\uFF0C\u5199\u5728\u4E3B\u673A\u4E0A\uFF0C \u4E3B\u673A\u4F1A\u5C06\u6570\u636E\u540C\u6B65\u7ED9\u4ECE\u673A\uFF0C\u4F46\u662F\u5047\u8BBE\u5728\u4E3B\u673A\u8FD8\u6CA1\u6709\u6765\u5F97\u53CA\u628A\u6570\u636E\u5199\u5165\u5230\u4ECE\u673A\u53BB\u7684\u65F6\u5019\uFF0C\u6B64\u65F6\u4E3B\u673A\u5B95\u673A\uFF0C\u54E8\u5175\u4F1A\u53D1\u73B0\u4E3B\u673A\u5B95\u673A\uFF0C\u5E76\u4E14\u9009\u4E3E\u4E00\u4E2Aslave\u53D8\u6210master\uFF0C\u800C\u6B64\u65F6\u65B0\u7684master\u4E2D\u5B9E\u9645\u4E0A\u5E76\u6CA1\u6709\u9501\u4FE1\u606F\uFF0C\u6B64\u65F6\u9501\u4FE1\u606F\u5C31\u5DF2\u7ECF\u4E22\u6389\u4E86\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653553998403.png" alt="1653553998403"></p><p>\u4E3A\u4E86\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\uFF0Credission\u63D0\u51FA\u6765\u4E86MutiLock\u9501\uFF0C\u4F7F\u7528\u8FD9\u628A\u9501\u54B1\u4EEC\u5C31\u4E0D\u4F7F\u7528\u4E3B\u4ECE\u4E86\uFF0C\u6BCF\u4E2A\u8282\u70B9\u7684\u5730\u4F4D\u90FD\u662F\u4E00\u6837\u7684\uFF0C \u8FD9\u628A\u9501\u52A0\u9501\u7684\u903B\u8F91\u9700\u8981\u5199\u5165\u5230\u6BCF\u4E00\u4E2A\u4E3B\u4E1B\u8282\u70B9\u4E0A\uFF0C\u53EA\u6709\u6240\u6709\u7684\u670D\u52A1\u5668\u90FD\u5199\u5165\u6210\u529F\uFF0C\u6B64\u65F6\u624D\u662F\u52A0\u9501\u6210\u529F\uFF0C\u5047\u8BBE\u73B0\u5728\u67D0\u4E2A\u8282\u70B9\u6302\u4E86\uFF0C\u90A3\u4E48\u4ED6\u53BB\u83B7\u5F97\u9501\u7684\u65F6\u5019\uFF0C\u53EA\u8981\u6709\u4E00\u4E2A\u8282\u70B9\u62FF\u4E0D\u5230\uFF0C\u90FD\u4E0D\u80FD\u7B97\u662F\u52A0\u9501\u6210\u529F\uFF0C\u5C31\u4FDD\u8BC1\u4E86\u52A0\u9501\u7684\u53EF\u9760\u6027\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653554055048.png" alt="1653554055048"></p><p>\u90A3\u4E48MutiLock \u52A0\u9501\u539F\u7406\u662F\u4EC0\u4E48\u5462\uFF1F\u7B14\u8005\u753B\u4E86\u4E00\u5E45\u56FE\u6765\u8BF4\u660E</p><p>\u5F53\u6211\u4EEC\u53BB\u8BBE\u7F6E\u4E86\u591A\u4E2A\u9501\u65F6\uFF0Credission\u4F1A\u5C06\u591A\u4E2A\u9501\u6DFB\u52A0\u5230\u4E00\u4E2A\u96C6\u5408\u4E2D\uFF0C\u7136\u540E\u7528while\u5FAA\u73AF\u53BB\u4E0D\u505C\u53BB\u5C1D\u8BD5\u62FF\u9501\uFF0C\u4F46\u662F\u4F1A\u6709\u4E00\u4E2A\u603B\u5171\u7684\u52A0\u9501\u65F6\u95F4\uFF0C\u8FD9\u4E2A\u65F6\u95F4\u662F\u7528\u9700\u8981\u52A0\u9501\u7684\u4E2A\u6570 * 1500ms \uFF0C\u5047\u8BBE\u67093\u4E2A\u9501\uFF0C\u90A3\u4E48\u65F6\u95F4\u5C31\u662F4500ms\uFF0C\u5047\u8BBE\u5728\u8FD94500ms\u5185\uFF0C\u6240\u6709\u7684\u9501\u90FD\u52A0\u9501\u6210\u529F\uFF0C \u90A3\u4E48\u6B64\u65F6\u624D\u7B97\u662F\u52A0\u9501\u6210\u529F\uFF0C\u5982\u679C\u57284500ms\u6709\u7EBF\u7A0B\u52A0\u9501\u5931\u8D25\uFF0C\u5219\u4F1A\u518D\u6B21\u53BB\u8FDB\u884C\u91CD\u8BD5.</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653553093967.png" alt="1653553093967"></p><h2 id="_6\u3001\u79D2\u6740\u4F18\u5316" tabindex="-1"><a class="header-anchor" href="#_6\u3001\u79D2\u6740\u4F18\u5316" aria-hidden="true">#</a> 6\u3001\u79D2\u6740\u4F18\u5316</h2><h3 id="_6-1-\u79D2\u6740\u4F18\u5316-\u5F02\u6B65\u79D2\u6740\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#_6-1-\u79D2\u6740\u4F18\u5316-\u5F02\u6B65\u79D2\u6740\u601D\u8DEF" aria-hidden="true">#</a> 6.1 \u79D2\u6740\u4F18\u5316-\u5F02\u6B65\u79D2\u6740\u601D\u8DEF</h3><p>\u6211\u4EEC\u6765\u56DE\u987E\u4E00\u4E0B\u4E0B\u5355\u6D41\u7A0B</p><p>\u5F53\u7528\u6237\u53D1\u8D77\u8BF7\u6C42\uFF0C\u6B64\u65F6\u4F1A\u8BF7\u6C42nginx\uFF0Cnginx\u4F1A\u8BBF\u95EE\u5230tomcat\uFF0C\u800Ctomcat\u4E2D\u7684\u7A0B\u5E8F\uFF0C\u4F1A\u8FDB\u884C\u4E32\u884C\u64CD\u4F5C\uFF0C\u5206\u6210\u5982\u4E0B\u51E0\u4E2A\u6B65\u9AA4</p><p>1\u3001\u67E5\u8BE2\u4F18\u60E0\u5377</p><p>2\u3001\u5224\u65AD\u79D2\u6740\u5E93\u5B58\u662F\u5426\u8DB3\u591F</p><p>3\u3001\u67E5\u8BE2\u8BA2\u5355</p><p>4\u3001\u6821\u9A8C\u662F\u5426\u662F\u4E00\u4EBA\u4E00\u5355</p><p>5\u3001\u6263\u51CF\u5E93\u5B58</p><p>6\u3001\u521B\u5EFA\u8BA2\u5355</p><p>\u5728\u8FD9\u516D\u6B65\u64CD\u4F5C\u4E2D\uFF0C\u53C8\u6709\u5F88\u591A\u64CD\u4F5C\u662F\u8981\u53BB\u64CD\u4F5C\u6570\u636E\u5E93\u7684\uFF0C\u800C\u4E14\u8FD8\u662F\u4E00\u4E2A\u7EBF\u7A0B\u4E32\u884C\u6267\u884C\uFF0C \u8FD9\u6837\u5C31\u4F1A\u5BFC\u81F4\u6211\u4EEC\u7684\u7A0B\u5E8F\u6267\u884C\u7684\u5F88\u6162\uFF0C\u6240\u4EE5\u6211\u4EEC\u9700\u8981\u5F02\u6B65\u7A0B\u5E8F\u6267\u884C\uFF0C\u90A3\u4E48\u5982\u4F55\u52A0\u901F\u5462\uFF1F</p><p>\u5728\u8FD9\u91CC\u7B14\u8005\u60F3\u7ED9\u5927\u5BB6\u5206\u4EAB\u4E00\u4E0B\u8BFE\u7A0B\u5185\u6CA1\u6709\u7684\u601D\u8DEF\uFF0C\u770B\u770B\u6709\u6CA1\u6709\u5C0F\u4F19\u4F34\u8FD9\u4E48\u60F3\uFF0C\u6BD4\u5982\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4E0D\u53EF\u4EE5\u4F7F\u7528\u5F02\u6B65\u7F16\u6392\u6765\u505A\uFF0C\u6216\u8005\u8BF4\u6211\u5F00\u542FN\u591A\u7EBF\u7A0B\uFF0CN\u591A\u4E2A\u7EBF\u7A0B\uFF0C\u4E00\u4E2A\u7EBF\u7A0B\u6267\u884C\u67E5\u8BE2\u4F18\u60E0\u5377\uFF0C\u4E00\u4E2A\u6267\u884C\u5224\u65AD\u6263\u51CF\u5E93\u5B58\uFF0C\u4E00\u4E2A\u53BB\u521B\u5EFA\u8BA2\u5355\u7B49\u7B49\uFF0C\u7136\u540E\u518D\u7EDF\u4E00\u505A\u8FD4\u56DE\uFF0C\u8FD9\u79CD\u505A\u6CD5\u548C\u8BFE\u7A0B\u4E2D\u6709\u54EA\u79CD\u597D\u5462\uFF1F\u7B54\u6848\u662F\u8BFE\u7A0B\u4E2D\u7684\u597D\uFF0C\u56E0\u4E3A\u5982\u679C\u4F60\u91C7\u7528\u6211\u521A\u8BF4\u7684\u65B9\u5F0F\uFF0C\u5982\u679C\u8BBF\u95EE\u7684\u4EBA\u5F88\u591A\uFF0C\u90A3\u4E48\u7EBF\u7A0B\u6C60\u4E2D\u7684\u7EBF\u7A0B\u53EF\u80FD\u4E00\u4E0B\u5B50\u5C31\u88AB\u6D88\u8017\u5B8C\u4E86\uFF0C\u800C\u4E14\u4F60\u4F7F\u7528\u4E0A\u8FF0\u65B9\u6848\uFF0C\u6700\u5927\u7684\u7279\u70B9\u5728\u4E8E\uFF0C\u4F60\u89C9\u5F97\u65F6\u6548\u6027\u4F1A\u975E\u5E38\u91CD\u8981\uFF0C\u4F46\u662F\u4F60\u60F3\u60F3\u662F\u5417\uFF1F\u5E76\u4E0D\u662F\uFF0C\u6BD4\u5982\u6211\u53EA\u8981\u786E\u5B9A\u4ED6\u80FD\u505A\u8FD9\u4EF6\u4E8B\uFF0C\u7136\u540E\u6211\u540E\u8FB9\u6162\u6162\u505A\u5C31\u53EF\u4EE5\u4E86\uFF0C\u6211\u5E76\u4E0D\u9700\u8981\u4ED6\u4E00\u53E3\u6C14\u505A\u5B8C\u8FD9\u4EF6\u4E8B\uFF0C\u6240\u4EE5\u6211\u4EEC\u5E94\u5F53\u91C7\u7528\u7684\u662F\u8BFE\u7A0B\u4E2D\uFF0C\u7C7B\u4F3C\u6D88\u606F\u961F\u5217\u7684\u65B9\u5F0F\u6765\u5B8C\u6210\u6211\u4EEC\u7684\u9700\u6C42\uFF0C\u800C\u4E0D\u662F\u4F7F\u7528\u7EBF\u7A0B\u6C60\u6216\u8005\u662F\u5F02\u6B65\u7F16\u6392\u7684\u65B9\u5F0F\u6765\u5B8C\u6210\u8FD9\u4E2A\u9700\u6C42</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653560986599.png" alt="1653560986599"></p><p>\u4F18\u5316\u65B9\u6848\uFF1A\u6211\u4EEC\u5C06\u8017\u65F6\u6BD4\u8F83\u77ED\u7684\u903B\u8F91\u5224\u65AD\u653E\u5165\u5230redis\u4E2D\uFF0C\u6BD4\u5982\u662F\u5426\u5E93\u5B58\u8DB3\u591F\uFF0C\u6BD4\u5982\u662F\u5426\u4E00\u4EBA\u4E00\u5355\uFF0C\u8FD9\u6837\u7684\u64CD\u4F5C\uFF0C\u53EA\u8981\u8FD9\u79CD\u903B\u8F91\u53EF\u4EE5\u5B8C\u6210\uFF0C\u5C31\u610F\u5473\u7740\u6211\u4EEC\u662F\u4E00\u5B9A\u53EF\u4EE5\u4E0B\u5355\u5B8C\u6210\u7684\uFF0C\u6211\u4EEC\u53EA\u9700\u8981\u8FDB\u884C\u5FEB\u901F\u7684\u903B\u8F91\u5224\u65AD\uFF0C\u6839\u672C\u5C31\u4E0D\u7528\u7B49\u4E0B\u5355\u903B\u8F91\u8D70\u5B8C\uFF0C\u6211\u4EEC\u76F4\u63A5\u7ED9\u7528\u6237\u8FD4\u56DE\u6210\u529F\uFF0C \u518D\u5728\u540E\u53F0\u5F00\u4E00\u4E2A\u7EBF\u7A0B\uFF0C\u540E\u53F0\u7EBF\u7A0B\u6162\u6162\u7684\u53BB\u6267\u884Cqueue\u91CC\u8FB9\u7684\u6D88\u606F\uFF0C\u8FD9\u6837\u7A0B\u5E8F\u4E0D\u5C31\u8D85\u7EA7\u5FEB\u4E86\u5417\uFF1F\u800C\u4E14\u4E5F\u4E0D\u7528\u62C5\u5FC3\u7EBF\u7A0B\u6C60\u6D88\u8017\u6B86\u5C3D\u7684\u95EE\u9898\uFF0C\u56E0\u4E3A\u8FD9\u91CC\u6211\u4EEC\u7684\u7A0B\u5E8F\u4E2D\u5E76\u6CA1\u6709\u624B\u52A8\u4F7F\u7528\u4EFB\u4F55\u7EBF\u7A0B\u6C60\uFF0C\u5F53\u7136\u8FD9\u91CC\u8FB9\u6709\u4E24\u4E2A\u96BE\u70B9</p><p>\u7B2C\u4E00\u4E2A\u96BE\u70B9\u662F\u6211\u4EEC\u600E\u4E48\u5728redis\u4E2D\u53BB\u5FEB\u901F\u6821\u9A8C\u4E00\u4EBA\u4E00\u5355\uFF0C\u8FD8\u6709\u5E93\u5B58\u5224\u65AD</p><p>\u7B2C\u4E8C\u4E2A\u96BE\u70B9\u662F\u7531\u4E8E\u6211\u4EEC\u6821\u9A8C\u548Ctomct\u4E0B\u5355\u662F\u4E24\u4E2A\u7EBF\u7A0B\uFF0C\u90A3\u4E48\u6211\u4EEC\u5982\u4F55\u77E5\u9053\u5230\u5E95\u54EA\u4E2A\u5355\u4ED6\u6700\u540E\u662F\u5426\u6210\u529F\uFF0C\u6216\u8005\u662F\u4E0B\u5355\u5B8C\u6210\uFF0C\u4E3A\u4E86\u5B8C\u6210\u8FD9\u4EF6\u4E8B\u6211\u4EEC\u5728redis\u64CD\u4F5C\u5B8C\u4E4B\u540E\uFF0C\u6211\u4EEC\u4F1A\u5C06\u4E00\u4E9B\u4FE1\u606F\u8FD4\u56DE\u7ED9\u524D\u7AEF\uFF0C\u540C\u65F6\u4E5F\u4F1A\u628A\u8FD9\u4E9B\u4FE1\u606F\u4E22\u5230\u5F02\u6B65queue\u4E2D\u53BB\uFF0C\u540E\u7EED\u64CD\u4F5C\u4E2D\uFF0C\u53EF\u4EE5\u901A\u8FC7\u8FD9\u4E2Aid\u6765\u67E5\u8BE2\u6211\u4EECtomcat\u4E2D\u7684\u4E0B\u5355\u903B\u8F91\u662F\u5426\u5B8C\u6210\u4E86\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653561657295.png" alt="1653561657295"></p><p>\u6211\u4EEC\u73B0\u5728\u6765\u770B\u770B\u6574\u4F53\u601D\u8DEF\uFF1A\u5F53\u7528\u6237\u4E0B\u5355\u4E4B\u540E\uFF0C\u5224\u65AD\u5E93\u5B58\u662F\u5426\u5145\u8DB3\u53EA\u9700\u8981\u5BFCredis\u4E2D\u53BB\u6839\u636Ekey\u627E\u5BF9\u5E94\u7684value\u662F\u5426\u5927\u4E8E0\u5373\u53EF\uFF0C\u5982\u679C\u4E0D\u5145\u8DB3\uFF0C\u5219\u76F4\u63A5\u7ED3\u675F\uFF0C\u5982\u679C\u5145\u8DB3\uFF0C\u7EE7\u7EED\u5728redis\u4E2D\u5224\u65AD\u7528\u6237\u662F\u5426\u53EF\u4EE5\u4E0B\u5355\uFF0C\u5982\u679Cset\u96C6\u5408\u4E2D\u6CA1\u6709\u8FD9\u6761\u6570\u636E\uFF0C\u8BF4\u660E\u4ED6\u53EF\u4EE5\u4E0B\u5355\uFF0C\u5982\u679Cset\u96C6\u5408\u4E2D\u6CA1\u6709\u8FD9\u6761\u8BB0\u5F55\uFF0C\u5219\u5C06userId\u548C\u4F18\u60E0\u5377\u5B58\u5165\u5230redis\u4E2D\uFF0C\u5E76\u4E14\u8FD4\u56DE0\uFF0C\u6574\u4E2A\u8FC7\u7A0B\u9700\u8981\u4FDD\u8BC1\u662F\u539F\u5B50\u6027\u7684\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528lua\u6765\u64CD\u4F5C</p><p>\u5F53\u4EE5\u4E0A\u5224\u65AD\u903B\u8F91\u8D70\u5B8C\u4E4B\u540E\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5224\u65AD\u5F53\u524Dredis\u4E2D\u8FD4\u56DE\u7684\u7ED3\u679C\u662F\u5426\u662F0 \uFF0C\u5982\u679C\u662F0\uFF0C\u5219\u8868\u793A\u53EF\u4EE5\u4E0B\u5355\uFF0C\u5219\u5C06\u4E4B\u524D\u8BF4\u7684\u4FE1\u606F\u5B58\u5165\u5230\u5230queue\u4E2D\u53BB\uFF0C\u7136\u540E\u8FD4\u56DE\uFF0C\u7136\u540E\u518D\u6765\u4E2A\u7EBF\u7A0B\u5F02\u6B65\u7684\u4E0B\u5355\uFF0C\u524D\u7AEF\u53EF\u4EE5\u901A\u8FC7\u8FD4\u56DE\u7684\u8BA2\u5355id\u6765\u5224\u65AD\u662F\u5426\u4E0B\u5355\u6210\u529F\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653562234886.png" alt="1653562234886"></p><h3 id="_6-2-\u79D2\u6740\u4F18\u5316-redis\u5B8C\u6210\u79D2\u6740\u8D44\u683C\u5224\u65AD" tabindex="-1"><a class="header-anchor" href="#_6-2-\u79D2\u6740\u4F18\u5316-redis\u5B8C\u6210\u79D2\u6740\u8D44\u683C\u5224\u65AD" aria-hidden="true">#</a> 6.2 \u79D2\u6740\u4F18\u5316-Redis\u5B8C\u6210\u79D2\u6740\u8D44\u683C\u5224\u65AD</h3><blockquote><p>\u9700\u6C42\u4E00\uFF1A\u65B0\u589E\u79D2\u6740\u4F18\u60E0\u5238\u7684\u540C\u65F6\uFF0C\u5C06\u4F18\u60E0\u5238\u4FE1\u606F\u4FDD\u5B58\u5230Redis\u4E2D \uFF08\u952E\uFF1A seckill:stock: + voucherId\uFF09</p><p>\u9700\u6C42\u4E8C\uFF1A\u57FA\u4E8ELua\u811A\u672C\uFF0C\u5224\u65AD\u79D2\u6740\u5E93\u5B58\u3001\u4E00\u4EBA\u4E00\u5355\uFF0C\u51B3\u5B9A\u7528\u6237\u662F\u5426\u62A2\u8D2D\u6210\u529F</p><p>1.\u53C2\u6570\u503C</p><p>voucherId\uFF0CuserId</p><p>2.\u952E\u503C</p><p>stockKey,orderKey</p><p>3.\u4E1A\u52A1\u903B\u8F91</p><p>3.1 \u5224\u65AD\u5E93\u5B58 get stockKey</p><p>3.2 \u5224\u65AD\u91CD\u590D\u4E0B\u5355 sismember orderKey userId</p><p>3.3 \u6263\u51CF\u5E93\u5B58 incrby stockKey -1</p><p>3.4 \u4E0B\u5355 sadd orderKey userId</p><p>\u79D2\u6740\u4E0B\u5355\uFF1A</p><p>1.\u6267\u884C lua \u811A\u672C</p><p>2.\u5224\u65AD\u7ED3\u679C</p><p>3.\u4FDD\u5B58\u5230\u963B\u585E\u961F\u5217</p><p>4.\u8FD4\u56DE\u8BA2\u5355id</p></blockquote><p>\u9700\u6C42\uFF1A</p><ul><li><p>\u65B0\u589E\u79D2\u6740\u4F18\u60E0\u5238\u7684\u540C\u65F6\uFF0C\u5C06\u4F18\u60E0\u5238\u4FE1\u606F\u4FDD\u5B58\u5230Redis\u4E2D</p></li><li><p>\u57FA\u4E8ELua\u811A\u672C\uFF0C\u5224\u65AD\u79D2\u6740\u5E93\u5B58\u3001\u4E00\u4EBA\u4E00\u5355\uFF0C\u51B3\u5B9A\u7528\u6237\u662F\u5426\u62A2\u8D2D\u6210\u529F</p></li><li><p>\u5982\u679C\u62A2\u8D2D\u6210\u529F\uFF0C\u5C06\u4F18\u60E0\u5238id\u548C\u7528\u6237id\u5C01\u88C5\u540E\u5B58\u5165\u963B\u585E\u961F\u5217</p></li><li><p>\u5F00\u542F\u7EBF\u7A0B\u4EFB\u52A1\uFF0C\u4E0D\u65AD\u4ECE\u963B\u585E\u961F\u5217\u4E2D\u83B7\u53D6\u4FE1\u606F\uFF0C\u5B9E\u73B0\u5F02\u6B65\u4E0B\u5355\u529F\u80FD</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1656080546603.png" alt="1656080546603"></p></li></ul><p>VoucherServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSeckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Voucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u4FDD\u5B58\u4F18\u60E0\u5238</span>
    <span class="token function">save</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u4FDD\u5B58\u79D2\u6740\u4FE1\u606F</span>
    <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillVoucher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setStock</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setBeginTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucherService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// \u4FDD\u5B58\u79D2\u6740\u5E93\u5B58\u5230Redis\u4E2D</span>
    <span class="token comment">//SECKILL_STOCK_KEY \u8FD9\u4E2A\u53D8\u91CF\u5B9A\u4E49\u5728RedisConstans\u4E2D</span>
    <span class="token comment">//private static final String SECKILL_STOCK_KEY =&quot;seckill:stock:&quot;</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>SECKILL_STOCK_KEY <span class="token operator">+</span> voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5B8C\u6574lua\u8868\u8FBE\u5F0F</p><div class="language-lua ext-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- 1.\u53C2\u6570\u5217\u8868</span>
<span class="token comment">-- 1.1.\u4F18\u60E0\u5238id</span>
<span class="token keyword">local</span> voucherId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- 1.2.\u7528\u6237id</span>
<span class="token keyword">local</span> userId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment">-- 1.3.\u8BA2\u5355id</span>
<span class="token keyword">local</span> orderId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>

<span class="token comment">-- 2.\u6570\u636Ekey</span>
<span class="token comment">-- 2.1.\u5E93\u5B58key</span>
<span class="token keyword">local</span> stockKey <span class="token operator">=</span> <span class="token string">&#39;seckill:stock:&#39;</span> <span class="token operator">..</span> voucherId
<span class="token comment">-- 2.2.\u8BA2\u5355key</span>
<span class="token keyword">local</span> orderKey <span class="token operator">=</span> <span class="token string">&#39;seckill:order:&#39;</span> <span class="token operator">..</span> voucherId

<span class="token comment">-- 3.\u811A\u672C\u4E1A\u52A1</span>
<span class="token comment">-- 3.1.\u5224\u65AD\u5E93\u5B58\u662F\u5426\u5145\u8DB3 get stockKey</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- 3.2.\u5E93\u5B58\u4E0D\u8DB3\uFF0C\u8FD4\u56DE1</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token keyword">end</span>
<span class="token comment">-- 3.2.\u5224\u65AD\u7528\u6237\u662F\u5426\u4E0B\u5355 SISMEMBER orderKey userId</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;sismember&#39;</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- 3.3.\u5B58\u5728\uFF0C\u8BF4\u660E\u662F\u91CD\u590D\u4E0B\u5355\uFF0C\u8FD4\u56DE2</span>
    <span class="token keyword">return</span> <span class="token number">2</span>
<span class="token keyword">end</span>
<span class="token comment">-- 3.4.\u6263\u5E93\u5B58 incrby stockKey -1</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;incrby&#39;</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">-- 3.5.\u4E0B\u5355\uFF08\u4FDD\u5B58\u7528\u6237\uFF09sadd orderKey userId</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;sadd&#39;</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
<span class="token comment">-- 3.6.\u53D1\u9001\u6D88\u606F\u5230\u961F\u5217\u4E2D\uFF0C XADD stream.orders * k1 v1 k2 v2 ...</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;xadd&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;stream.orders&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;*&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;userId&#39;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&#39;voucherId&#39;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">,</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F53\u4EE5\u4E0Alua\u8868\u8FBE\u5F0F\u6267\u884C\u5B8C\u6BD5\u540E\uFF0C\u5269\u4E0B\u7684\u5C31\u662F\u6839\u636E\u6B65\u9AA43,4\u6765\u6267\u884C\u6211\u4EEC\u63A5\u4E0B\u6765\u7684\u4EFB\u52A1\u4E86</p><p>VoucherOrderServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//\u83B7\u53D6\u7528\u6237</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.\u6267\u884Clua\u811A\u672C</span>
    <span class="token class-name">Long</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
            SECKILL_SCRIPT<span class="token punctuation">,</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.\u5224\u65AD\u7ED3\u679C\u662F\u5426\u4E3A0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.1.\u4E0D\u4E3A0 \uFF0C\u4EE3\u8868\u6CA1\u6709\u8D2D\u4E70\u8D44\u683C</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;\u4E0D\u80FD\u91CD\u590D\u4E0B\u5355&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//TODO \u4FDD\u5B58\u963B\u585E\u961F\u5217</span>
    <span class="token comment">// 3.\u8FD4\u56DE\u8BA2\u5355id</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-\u79D2\u6740\u4F18\u5316-\u57FA\u4E8E\u963B\u585E\u961F\u5217\u5B9E\u73B0\u79D2\u6740\u4F18\u5316" tabindex="-1"><a class="header-anchor" href="#_6-3-\u79D2\u6740\u4F18\u5316-\u57FA\u4E8E\u963B\u585E\u961F\u5217\u5B9E\u73B0\u79D2\u6740\u4F18\u5316" aria-hidden="true">#</a> 6.3 \u79D2\u6740\u4F18\u5316-\u57FA\u4E8E\u963B\u585E\u961F\u5217\u5B9E\u73B0\u79D2\u6740\u4F18\u5316</h3><p>VoucherOrderServiceImpl</p><p>\u4FEE\u6539\u4E0B\u5355\u52A8\u4F5C\uFF0C\u73B0\u5728\u6211\u4EEC\u53BB\u4E0B\u5355\u65F6\uFF0C\u662F\u901A\u8FC7lua\u8868\u8FBE\u5F0F\u53BB\u539F\u5B50\u6267\u884C\u5224\u65AD\u903B\u8F91\uFF0C\u5982\u679C\u5224\u65AD\u6211\u51FA\u6765\u4E0D\u4E3A0 \uFF0C\u5219\u8981\u4E48\u662F\u5E93\u5B58\u4E0D\u8DB3\uFF0C\u8981\u4E48\u662F\u91CD\u590D\u4E0B\u5355\uFF0C\u8FD4\u56DE\u9519\u8BEF\u4FE1\u606F\uFF0C\u5982\u679C\u662F0\uFF0C\u5219\u628A\u4E0B\u5355\u7684\u903B\u8F91\u4FDD\u5B58\u5230\u961F\u5217\u4E2D\u53BB\uFF0C\u7136\u540E\u5F02\u6B65\u6267\u884C</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u5F02\u6B65\u5904\u7406\u7EBF\u7A0B\u6C60</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> SECKILL_ORDER_EXECUTOR <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// \u963B\u585E\u961F\u5217</span>
<span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> orderTasks <span class="token operator">=</span> <span class="token keyword">new</span>  <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// \u4EE3\u7406\u5BF9\u8C61</span>
<span class="token class-name">IVoucherOrderService</span> proxy<span class="token punctuation">;</span>

<span class="token comment">//\u5728\u7C7B\u521D\u59CB\u5316\u4E4B\u540E\u6267\u884C\uFF0C\u56E0\u4E3A\u5F53\u8FD9\u4E2A\u7C7B\u521D\u59CB\u5316\u597D\u4E86\u4E4B\u540E\uFF0C\u968F\u65F6\u90FD\u662F\u6709\u53EF\u80FD\u8981\u6267\u884C\u7684</span>
<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   SECKILL_ORDER_EXECUTOR<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoucherOrderHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u7528\u4E8E\u7EBF\u7A0B\u6C60\u5904\u7406\u7684\u4EFB\u52A1</span>
<span class="token comment">// \u5F53\u521D\u59CB\u5316\u5B8C\u6BD5\u540E\uFF0C\u5C31\u4F1A\u53BB\u4ECE\u961F\u5217\u4E2D\u53BB\u62FF\u4FE1\u606F</span>
 <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 1.\u83B7\u53D6\u961F\u5217\u4E2D\u7684\u8BA2\u5355\u4FE1\u606F</span>
                    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> orderTasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 2.\u521B\u5EFA\u8BA2\u5355</span>
                    <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u5904\u7406\u8BA2\u5355\u5F02\u5E38&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
          	 <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     
       <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//1.\u83B7\u53D6\u7528\u6237</span>
            <span class="token class-name">Long</span> userId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.\u521B\u5EFA\u9501\u5BF9\u8C61</span>
            <span class="token class-name">RLock</span> redisLock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3.\u5C1D\u8BD5\u83B7\u53D6\u9501</span>
            <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> redisLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4.\u5224\u65AD\u662F\u5426\u83B7\u5F97\u9501\u6210\u529F</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u83B7\u53D6\u9501\u5931\u8D25\uFF0C\u76F4\u63A5\u8FD4\u56DE\u5931\u8D25\u6216\u8005\u91CD\u8BD5</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u4E0D\u5141\u8BB8\u91CD\u590D\u4E0B\u5355\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token comment">//\u6CE8\u610F\uFF1A\u7531\u4E8E\u662Fspring\u7684\u4E8B\u52A1\u662F\u653E\u5728threadLocal\u4E2D\uFF0C\u6B64\u65F6\u7684\u662F\u591A\u7EBF\u7A0B\uFF0C\u4E8B\u52A1\u4F1A\u5931\u6548</span>
                proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u91CA\u653E\u9501</span>
                redisLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u83B7\u53D6\u4EE3\u7406\u5BF9\u8C61</span>
        proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span><span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.\u6267\u884Clua\u811A\u672C</span>
        <span class="token class-name">Long</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                SECKILL_SCRIPT<span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5224\u65AD\u7ED3\u679C\u662F\u5426\u4E3A0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.1.\u4E0D\u4E3A0 \uFF0C\u4EE3\u8868\u6CA1\u6709\u8D2D\u4E70\u8D44\u683C</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;\u4E0D\u80FD\u91CD\u590D\u4E0B\u5355&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.3.\u8BA2\u5355id</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.4.\u7528\u6237id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.5.\u4EE3\u91D1\u5238id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.6.\u653E\u5165\u963B\u585E\u961F\u5217</span>
        orderTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.\u8FD4\u56DE\u8BA2\u5355id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     
     <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.1.\u67E5\u8BE2\u8BA2\u5355</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getVoucherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.2.\u5224\u65AD\u662F\u5426\u5B58\u5728</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u7528\u6237\u5DF2\u7ECF\u8D2D\u4E70\u8FC7\u4E86</span>
           log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u7528\u6237\u5DF2\u7ECF\u8D2D\u4E70\u8FC7\u4E86&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 6.\u6263\u51CF\u5E93\u5B58</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// set stock = stock - 1</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getVoucherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// where id = ? and stock &gt; 0</span>
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u6263\u51CF\u5931\u8D25</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E93\u5B58\u4E0D\u8DB3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u5C0F\u603B\u7ED3\uFF1A</strong></p><p>\u79D2\u6740\u4E1A\u52A1\u7684\u4F18\u5316\u601D\u8DEF\u662F\u4EC0\u4E48\uFF1F</p><ul><li>\u5148\u5229\u7528Redis\u5B8C\u6210\u5E93\u5B58\u4F59\u91CF\u3001\u4E00\u4EBA\u4E00\u5355\u5224\u65AD\uFF0C\u5B8C\u6210\u62A2\u5355\u4E1A\u52A1</li><li>\u518D\u5C06\u4E0B\u5355\u4E1A\u52A1\u653E\u5165\u963B\u585E\u961F\u5217\uFF0C\u5229\u7528\u72EC\u7ACB\u7EBF\u7A0B\u5F02\u6B65\u4E0B\u5355</li><li>\u57FA\u4E8E\u963B\u585E\u961F\u5217\u7684\u5F02\u6B65\u79D2\u6740\u5B58\u5728\u54EA\u4E9B\u95EE\u9898\uFF1F <ul><li>\u5185\u5B58\u9650\u5236\u95EE\u9898</li><li>\u6570\u636E\u5B89\u5168\u95EE\u9898</li></ul></li></ul><h2 id="_7\u3001redis\u6D88\u606F\u961F\u5217" tabindex="-1"><a class="header-anchor" href="#_7\u3001redis\u6D88\u606F\u961F\u5217" aria-hidden="true">#</a> 7\u3001Redis\u6D88\u606F\u961F\u5217</h2><h3 id="_7-1-redis\u6D88\u606F\u961F\u5217-\u8BA4\u8BC6\u6D88\u606F\u961F\u5217" tabindex="-1"><a class="header-anchor" href="#_7-1-redis\u6D88\u606F\u961F\u5217-\u8BA4\u8BC6\u6D88\u606F\u961F\u5217" aria-hidden="true">#</a> 7.1 Redis\u6D88\u606F\u961F\u5217-\u8BA4\u8BC6\u6D88\u606F\u961F\u5217</h3><p>\u4EC0\u4E48\u662F\u6D88\u606F\u961F\u5217\uFF1A\u5B57\u9762\u610F\u601D\u5C31\u662F\u5B58\u653E\u6D88\u606F\u7684\u961F\u5217\u3002\u6700\u7B80\u5355\u7684\u6D88\u606F\u961F\u5217\u6A21\u578B\u5305\u62EC3\u4E2A\u89D2\u8272\uFF1A</p><ul><li>\u6D88\u606F\u961F\u5217\uFF1A\u5B58\u50A8\u548C\u7BA1\u7406\u6D88\u606F\uFF0C\u4E5F\u88AB\u79F0\u4E3A <code>\u6D88\u606F\u4EE3\u7406</code>\uFF08Message Broker\uFF09</li><li>\u751F\u4EA7\u8005\uFF1A\u53D1\u9001\u6D88\u606F\u5230\u6D88\u606F\u961F\u5217</li><li>\u6D88\u8D39\u8005\uFF1A\u4ECE\u6D88\u606F\u961F\u5217\u83B7\u53D6\u6D88\u606F\u5E76\u5904\u7406\u6D88\u606F</li></ul><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653574849336.png" alt="1653574849336"></p><p>\u4F7F\u7528\u961F\u5217\u7684\u597D\u5904\u5728\u4E8E **\u89E3\u8026\uFF1A**\u6240\u8C13\u89E3\u8026\uFF0C\u4E3E\u4E00\u4E2A\u751F\u6D3B\u4E2D\u7684\u4F8B\u5B50\u5C31\u662F\uFF1A\u5FEB\u9012\u5458(\u751F\u4EA7\u8005)\u628A\u5FEB\u9012\u653E\u5230\u5FEB\u9012\u67DC\u91CC\u8FB9(Message Queue)\u53BB\uFF0C\u6211\u4EEC(\u6D88\u8D39\u8005)\u4ECE\u5FEB\u9012\u67DC\u91CC\u8FB9\u53BB\u62FF\u4E1C\u897F\uFF0C\u8FD9\u5C31\u662F\u4E00\u4E2A\u5F02\u6B65\uFF0C\u5982\u679C\u8026\u5408\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u5FEB\u9012\u5458\u76F8\u5F53\u4E8E\u76F4\u63A5\u628A\u5FEB\u9012\u4EA4\u7ED9\u4F60\uFF0C\u8FD9\u4E8B\u56FA\u7136\u597D\uFF0C\u4F46\u662F\u4E07\u4E00\u4F60\u4E0D\u5728\u5BB6\uFF0C\u90A3\u4E48\u5FEB\u9012\u5458\u5C31\u4F1A\u4E00\u76F4\u7B49\u4F60\uFF0C\u8FD9\u5C31\u6D6A\u8D39\u4E86\u5FEB\u9012\u5458\u7684\u65F6\u95F4\uFF0C\u6240\u4EE5\u8FD9\u79CD\u601D\u60F3\u5728\u6211\u4EEC\u65E5\u5E38\u5F00\u53D1\u4E2D\uFF0C\u662F\u975E\u5E38\u6709\u5FC5\u8981\u7684\u3002</p><p>\u8FD9\u79CD\u573A\u666F\u5728\u6211\u4EEC\u79D2\u6740\u4E2D\u5C31\u53D8\u6210\u4E86\uFF1A\u6211\u4EEC\u4E0B\u5355\u4E4B\u540E\uFF0C\u5229\u7528redis\u53BB\u8FDB\u884C\u6821\u9A8C\u4E0B\u5355\u6761\u4EF6\uFF0C\u518D\u901A\u8FC7\u961F\u5217\u628A\u6D88\u606F\u53D1\u9001\u51FA\u53BB\uFF0C\u7136\u540E\u518D\u542F\u52A8\u4E00\u4E2A\u7EBF\u7A0B\u53BB\u6D88\u8D39\u8FD9\u4E2A\u6D88\u606F\uFF0C\u5B8C\u6210\u89E3\u8026\uFF0C\u540C\u65F6\u4E5F\u52A0\u5FEB\u6211\u4EEC\u7684\u54CD\u5E94\u901F\u5EA6\u3002</p><p>\u8FD9\u91CC\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528\u4E00\u4E9B\u73B0\u6210\u7684mq\uFF0C\u6BD4\u5982kafka\uFF0Crabbitmq\u7B49\u7B49\uFF0C\u4F46\u662F\u5462\uFF0C\u5982\u679C\u6CA1\u6709\u5B89\u88C5mq\uFF0C\u6211\u4EEC\u4E5F\u53EF\u4EE5\u76F4\u63A5\u4F7F\u7528redis\u63D0\u4F9B\u7684mq\u65B9\u6848\uFF0C\u964D\u4F4E\u6211\u4EEC\u7684\u90E8\u7F72\u548C\u5B66\u4E60\u6210\u672C\u3002</p><h3 id="_7-2-redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8Elist\u5B9E\u73B0\u6D88\u606F\u961F\u5217" tabindex="-1"><a class="header-anchor" href="#_7-2-redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8Elist\u5B9E\u73B0\u6D88\u606F\u961F\u5217" aria-hidden="true">#</a> 7.2 Redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8EList\u5B9E\u73B0\u6D88\u606F\u961F\u5217</h3><p><strong>\u57FA\u4E8EList\u7ED3\u6784\u6A21\u62DF\u6D88\u606F\u961F\u5217</strong></p><p>\u6D88\u606F\u961F\u5217\uFF08Message Queue\uFF09\uFF0C\u5B57\u9762\u610F\u601D\u5C31\u662F\u5B58\u653E\u6D88\u606F\u7684\u961F\u5217\u3002\u800CRedis\u7684list\u6570\u636E\u7ED3\u6784\u662F\u4E00\u4E2A\u53CC\u5411\u94FE\u8868\uFF0C\u5F88\u5BB9\u6613\u6A21\u62DF\u51FA\u961F\u5217\u6548\u679C\u3002</p><p>\u961F\u5217\u662F\u5165\u53E3\u548C\u51FA\u53E3\u4E0D\u5728\u4E00\u8FB9\uFF0C\u56E0\u6B64\u6211\u4EEC\u53EF\u4EE5\u5229\u7528\uFF1ALPUSH \u7ED3\u5408 RPOP\u3001\u6216\u8005 RPUSH \u7ED3\u5408 LPOP\u6765\u5B9E\u73B0\u3002 \u4E0D\u8FC7\u8981\u6CE8\u610F\u7684\u662F\uFF0C\u5F53\u961F\u5217\u4E2D\u6CA1\u6709\u6D88\u606F\u65F6RPOP\u6216LPOP\u64CD\u4F5C\u4F1A\u8FD4\u56DEnull\uFF0C\u5E76\u4E0D\u50CFJVM\u7684\u963B\u585E\u961F\u5217\u90A3\u6837\u4F1A\u963B\u585E\u5E76\u7B49\u5F85\u6D88\u606F\u3002\u56E0\u6B64\u8FD9\u91CC\u5E94\u8BE5\u4F7F\u7528BRPOP\u6216\u8005BLPOP\u6765\u5B9E\u73B0\u963B\u585E\u6548\u679C\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653575176451.png" alt="1653575176451"></p><p>\u57FA\u4E8EList\u7684\u6D88\u606F\u961F\u5217\u6709\u54EA\u4E9B\u4F18\u7F3A\u70B9\uFF1F \u4F18\u70B9\uFF1A</p><ul><li>\u5229\u7528Redis\u5B58\u50A8\uFF0C<code>\u4E0D\u53D7\u9650\u4E8EJVM\u5185\u5B58\u4E0A\u9650</code></li><li>\u57FA\u4E8ERedis\u7684 <code>\u6301\u4E45\u5316\u673A\u5236</code> \uFF0C<code>\u6570\u636E\u5B89\u5168\u6027</code>\u6709\u4FDD\u8BC1</li><li>\u53EF\u4EE5\u6EE1\u8DB3\u6D88\u606F\u6709\u5E8F\u6027</li></ul><p>\u7F3A\u70B9\uFF1A</p><ul><li>\u65E0\u6CD5\u907F\u514D <code>\u6D88\u606F\u4E22\u5931</code>\uFF08pop\u51FA\u6D88\u606F\uFF0C\u4F46\u662F\u56E0\u4E3A\u67D0\u4E9B\u539F\u56E0\uFF0C\u65E0\u6CD5\u6210\u529F\u6D88\u8D39\uFF0C\u5C31\u9020\u6210\u4E86\u6D88\u606F\u4E22\u5931\uFF09</li><li>\u53EA\u652F\u6301 <code>\u5355\u6D88\u8D39\u8005</code></li></ul><h3 id="_7-3-redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8Epubsub\u7684\u6D88\u606F\u961F\u5217" tabindex="-1"><a class="header-anchor" href="#_7-3-redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8Epubsub\u7684\u6D88\u606F\u961F\u5217" aria-hidden="true">#</a> 7.3 Redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8EPubSub\u7684\u6D88\u606F\u961F\u5217</h3><p>PubSub\uFF08\u53D1\u5E03\u8BA2\u9605\uFF09\u662FRedis2.0\u7248\u672C\u5F15\u5165\u7684\u6D88\u606F\u4F20\u9012\u6A21\u578B\u3002\u987E\u540D\u601D\u4E49\uFF0C\u6D88\u8D39\u8005\u53EF\u4EE5\u8BA2\u9605\u4E00\u4E2A\u6216\u591A\u4E2Achannel\uFF0C\u751F\u4EA7\u8005\u5411\u5BF9\u5E94channel\u53D1\u9001\u6D88\u606F\u540E\uFF0C\u6240\u6709\u8BA2\u9605\u8005\u90FD\u80FD\u6536\u5230\u76F8\u5173\u6D88\u606F\u3002</p><p>SUBSCRIBE channel [channel] \uFF1A\u8BA2\u9605\u4E00\u4E2A\u6216\u591A\u4E2A\u9891\u9053 PUBLISH channel msg \uFF1A\u5411\u4E00\u4E2A\u9891\u9053\u53D1\u9001\u6D88\u606F PSUBSCRIBE pattern[pattern] \uFF1A\u8BA2\u9605\u4E0Epattern\u683C\u5F0F\u5339\u914D\u7684\u6240\u6709\u9891\u9053</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653575506373.png" alt="1653575506373"></p><p>\u57FA\u4E8EPubSub\u7684\u6D88\u606F\u961F\u5217\u6709\u54EA\u4E9B\u4F18\u7F3A\u70B9\uFF1F \u4F18\u70B9\uFF1A</p><ul><li>\u91C7\u7528\u53D1\u5E03\u8BA2\u9605\u6A21\u578B\uFF0C\u652F\u6301\u591A\u751F\u4EA7\u3001\u591A\u6D88\u8D39</li></ul><p>\u7F3A\u70B9\uFF1A</p><ul><li>\u4E0D\u652F\u6301 <code>\u6570\u636E\u6301\u4E45\u5316</code>\uFF08\u53D1\u5E03\u6D88\u606F\uFF0C\u4F46\u662F\u6CA1\u4EBA\u8BA2\u9605\uFF09</li><li>\u65E0\u6CD5\u907F\u514D <code>\u6D88\u606F\u4E22\u5931</code>\uFF08\u540C\u4E0A\uFF09</li><li><code>\u6D88\u606F\u5806\u79EF\u6709\u4E0A\u9650</code>\uFF0C\u8D85\u51FA\u65F6\u6570\u636E\u4E22\u5931\uFF08\u6D88\u606F\u6CA1\u6709\u53CA\u65F6\u6D88\u8D39\uFF0C\u5806\u79EF\u5728\u5BA2\u6237\u7AEF\uFF09</li></ul><h3 id="_7-4-redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8Estream\u7684\u6D88\u606F\u961F\u5217" tabindex="-1"><a class="header-anchor" href="#_7-4-redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8Estream\u7684\u6D88\u606F\u961F\u5217" aria-hidden="true">#</a> 7.4 Redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8EStream\u7684\u6D88\u606F\u961F\u5217</h3><p>Stream \u662F Redis 5.0 \u5F15\u5165\u7684\u4E00\u79CD\u65B0\u6570\u636E\u7C7B\u578B\uFF0C\u53EF\u4EE5\u5B9E\u73B0\u4E00\u4E2A\u529F\u80FD\u975E\u5E38\u5B8C\u5584\u7684\u6D88\u606F\u961F\u5217\u3002</p><p>\u53D1\u9001\u6D88\u606F\u7684\u547D\u4EE4\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653577301737.png" alt="1653577301737"></p><p>\u4F8B\u5982\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653577349691.png" alt="1653577349691"></p><p>\u8BFB\u53D6\u6D88\u606F\u7684\u65B9\u5F0F\u4E4B\u4E00\uFF1AXREAD</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653577445413.png" alt="1653577445413"></p><p>\u4F8B\u5982\uFF0C\u4F7F\u7528XREAD\u8BFB\u53D6\u7B2C\u4E00\u4E2A\u6D88\u606F\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653577643629.png" alt="1653577643629"></p><p>XREAD\u963B\u585E\u65B9\u5F0F\uFF0C\u8BFB\u53D6\u6700\u65B0\u7684\u6D88\u606F\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653577659166.png" alt="1653577659166"></p><p>\u5728\u4E1A\u52A1\u5F00\u53D1\u4E2D\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5FAA\u73AF\u7684\u8C03\u7528XREAD\u963B\u585E\u65B9\u5F0F\u6765\u67E5\u8BE2\u6700\u65B0\u6D88\u606F\uFF0C\u4ECE\u800C\u5B9E\u73B0\u6301\u7EED\u76D1\u542C\u961F\u5217\u7684\u6548\u679C\uFF0C\u4F2A\u4EE3\u7801\u5982\u4E0B</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653577689129.png" alt="1653577689129"></p><p>\u6CE8\u610F\uFF1A\u5F53\u6211\u4EEC\u6307\u5B9A\u8D77\u59CBID\u4E3A$\u65F6\uFF0C\u4EE3\u8868\u8BFB\u53D6\u6700\u65B0\u7684\u6D88\u606F\uFF0C\u5982\u679C\u6211\u4EEC\u5904\u7406\u4E00\u6761\u6D88\u606F\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u53C8\u6709\u8D85\u8FC71\u6761\u4EE5\u4E0A\u7684\u6D88\u606F\u5230\u8FBE\u961F\u5217\uFF0C\u5219\u4E0B\u6B21\u83B7\u53D6\u65F6\u4E5F\u53EA\u80FD\u83B7\u53D6\u5230\u6700\u65B0\u7684\u4E00\u6761\uFF0C\u4F1A\u51FA\u73B0 <code>\u6F0F\u8BFB</code> \u6D88\u606F\u7684\u95EE\u9898</p><p>STREAM\u7C7B\u578B\u6D88\u606F\u961F\u5217\u7684XREAD\u547D\u4EE4\u7279\u70B9\uFF1A</p><ul><li>\u6D88\u606F\u53EF\u56DE\u6EAF\uFF08\u6570\u636E\u8BFB\u53D6\u4E86\u4F9D\u7136\u5B58\u5728\uFF09</li><li>\u4E00\u4E2A\u6D88\u606F\u53EF\u4EE5\u88AB\u591A\u4E2A\u6D88\u8D39\u8005\u8BFB\u53D6</li><li>\u53EF\u4EE5\u963B\u585E\u8BFB\u53D6</li><li>\u6709\u6D88\u606F <code>\u6F0F\u8BFB</code> \u7684\u98CE\u9669\uFF08\u5F53\u6211\u4EEC\u6307\u5B9A\u8D77\u59CBID\u4E3A$\u65F6\uFF0C\u4EE3\u8868\u8BFB\u53D6\u6700\u65B0\u7684\u6D88\u606F\uFF0C\u5982\u679C\u6211\u4EEC\u5904\u7406\u4E00\u6761\u6D88\u606F\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u53C8\u6709\u8D85\u8FC71\u6761\u4EE5\u4E0A\u7684\u6D88\u606F\u5230\u8FBE\u961F\u5217\uFF0C\u5219\u4E0B\u6B21\u83B7\u53D6\u65F6\u4E5F\u53EA\u80FD\u83B7\u53D6\u5230\u6700\u65B0\u7684\u4E00\u6761\uFF0C\u4F1A\u51FA\u73B0\u6F0F\u8BFB\u6D88\u606F\u7684\u95EE\u9898\u3002\uFF09</li></ul><h3 id="_7-5-redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8Estream\u7684\u6D88\u606F\u961F\u5217-\u6D88\u8D39\u8005\u7EC4" tabindex="-1"><a class="header-anchor" href="#_7-5-redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8Estream\u7684\u6D88\u606F\u961F\u5217-\u6D88\u8D39\u8005\u7EC4" aria-hidden="true">#</a> 7.5 Redis\u6D88\u606F\u961F\u5217-\u57FA\u4E8EStream\u7684\u6D88\u606F\u961F\u5217-\u6D88\u8D39\u8005\u7EC4</h3><p>\u6D88\u8D39\u8005\u7EC4\uFF08Consumer Group\uFF09\uFF1A\u5C06\u591A\u4E2A\u6D88\u8D39\u8005\u5212\u5206\u5230\u4E00\u4E2A\u7EC4\u4E2D\uFF0C\u76D1\u542C\u540C\u4E00\u4E2A\u961F\u5217\u3002\u5177\u5907\u4E0B\u5217\u7279\u70B9\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653577801668.png" alt="1653577801668"></p><p>\u521B\u5EFA\u6D88\u8D39\u8005\u7EC4\uFF1A <img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653577984924.png" alt="1653577984924"> key\uFF1A\u961F\u5217\u540D\u79F0 groupName\uFF1A\u6D88\u8D39\u8005\u7EC4\u540D\u79F0 ID\uFF1A\u8D77\u59CBID\u6807\u793A\uFF0C$\u4EE3\u8868\u961F\u5217\u4E2D\u6700\u540E\u4E00\u4E2A\u6D88\u606F\uFF0C0\u5219\u4EE3\u8868\u961F\u5217\u4E2D\u7B2C\u4E00\u4E2A\u6D88\u606F MKSTREAM\uFF1A\u961F\u5217\u4E0D\u5B58\u5728\u65F6\u81EA\u52A8\u521B\u5EFA\u961F\u5217 \u5176\u5B83\u5E38\u89C1\u547D\u4EE4\uFF1A</p><p><strong>\u5220\u9664\u6307\u5B9A\u7684\u6D88\u8D39\u8005\u7EC4</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>XGROUP DESTORY key groupName
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>\u7ED9\u6307\u5B9A\u7684\u6D88\u8D39\u8005\u7EC4\u6DFB\u52A0\u6D88\u8D39\u8005</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>XGROUP CREATECONSUMER key groupname consumername
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>\u5220\u9664\u6D88\u8D39\u8005\u7EC4\u4E2D\u7684\u6307\u5B9A\u6D88\u8D39\u8005</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>XGROUP DELCONSUMER key groupname consumername
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4ECE\u6D88\u8D39\u8005\u7EC4\u8BFB\u53D6\u6D88\u606F\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>XREADGROUP GROUP group consumer <span class="token punctuation">[</span>COUNT count<span class="token punctuation">]</span> <span class="token punctuation">[</span>BLOCK milliseconds<span class="token punctuation">]</span> <span class="token punctuation">[</span>NOACK<span class="token punctuation">]</span> STREAMS key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> ID <span class="token punctuation">[</span>ID <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>group\uFF1A\u6D88\u8D39\u7EC4\u540D\u79F0</li><li>consumer\uFF1A\u6D88\u8D39\u8005\u540D\u79F0\uFF0C\u5982\u679C\u6D88\u8D39\u8005\u4E0D\u5B58\u5728\uFF0C\u4F1A\u81EA\u52A8\u521B\u5EFA\u4E00\u4E2A\u6D88\u8D39\u8005</li><li>count\uFF1A\u672C\u6B21\u67E5\u8BE2\u7684\u6700\u5927\u6570\u91CF</li><li>BLOCK milliseconds\uFF1A\u5F53\u6CA1\u6709\u6D88\u606F\u65F6\u6700\u957F\u7B49\u5F85\u65F6\u95F4</li><li>NOACK\uFF1A\u65E0\u9700\u624B\u52A8ACK\uFF0C\u83B7\u53D6\u5230\u6D88\u606F\u540E\u81EA\u52A8\u786E\u8BA4</li><li>key\uFF1A\u6307\u5B9A\u961F\u5217\u540D\u79F0</li><li>ID\uFF1A\u83B7\u53D6\u6D88\u606F\u7684\u8D77\u59CBID\uFF1A</li></ul><p>&quot;&gt;&quot;\uFF1A\u4ECE\u4E0B\u4E00\u4E2A\u672A\u6D88\u8D39\u7684\u6D88\u606F\u5F00\u59CB \u5176\u5B83\uFF1A\u6839\u636E\u6307\u5B9Aid\u4ECEpending-list\u4E2D\u83B7\u53D6\u5DF2\u6D88\u8D39\u4F46\u672A\u786E\u8BA4\u7684\u6D88\u606F\uFF0C\u4F8B\u59820\uFF0C\u662F\u4ECEpending-list\u4E2D\u7684\u7B2C\u4E00\u4E2A\u6D88\u606F\u5F00\u59CB</p><p>\u6D88\u8D39\u8005\u76D1\u542C\u6D88\u606F\u7684\u57FA\u672C\u601D\u8DEF\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653578211854.png" alt="1653578211854"></p><p>STREAM\u7C7B\u578B\u6D88\u606F\u961F\u5217\u7684XREADGROUP\u547D\u4EE4\u7279\u70B9\uFF1A</p><ul><li>\u6D88\u606F\u53EF\u56DE\u6EAF</li><li>\u53EF\u4EE5\u591A\u6D88\u8D39\u8005\u4E89\u62A2\u6D88\u606F\uFF0C\u52A0\u5FEB\u6D88\u8D39\u901F\u5EA6</li><li>\u53EF\u4EE5\u963B\u585E\u8BFB\u53D6</li><li>\u6CA1\u6709\u6D88\u606F\u6F0F\u8BFB\u7684\u98CE\u9669</li><li>\u6709\u6D88\u606F\u786E\u8BA4\u673A\u5236\uFF0C\u4FDD\u8BC1\u6D88\u606F\u81F3\u5C11\u88AB\u6D88\u8D39\u4E00\u6B21</li></ul><p>\u6700\u540E\u6211\u4EEC\u6765\u4E2A\u5C0F\u5BF9\u6BD4</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653578560691.png" alt="1653578560691"></p><h3 id="_7-6-\u57FA\u4E8Eredis\u7684stream\u7ED3\u6784\u4F5C\u4E3A\u6D88\u606F\u961F\u5217-\u5B9E\u73B0\u5F02\u6B65\u79D2\u6740\u4E0B\u5355" tabindex="-1"><a class="header-anchor" href="#_7-6-\u57FA\u4E8Eredis\u7684stream\u7ED3\u6784\u4F5C\u4E3A\u6D88\u606F\u961F\u5217-\u5B9E\u73B0\u5F02\u6B65\u79D2\u6740\u4E0B\u5355" aria-hidden="true">#</a> 7.6 \u57FA\u4E8ERedis\u7684Stream\u7ED3\u6784\u4F5C\u4E3A\u6D88\u606F\u961F\u5217\uFF0C\u5B9E\u73B0\u5F02\u6B65\u79D2\u6740\u4E0B\u5355</h3><blockquote><p>\u9700\u6C42\uFF1A</p><ul><li>\u521B\u5EFA\u4E00\u4E2AStream\u7C7B\u578B\u7684\u6D88\u606F\u961F\u5217\uFF0C\u540D\u4E3Astream.orders</li></ul><p>XGROUP CREATE stream.orders g1 0 MKSTREAM</p><ul><li><p>\u4FEE\u6539\u4E4B\u524D\u7684\u79D2\u6740\u4E0B\u5355Lua\u811A\u672C\uFF0C\u5728\u8BA4\u5B9A\u6709\u62A2\u8D2D\u8D44\u683C\u540E\uFF0C\u76F4\u63A5\u5411stream.orders\u4E2D\u6DFB\u52A0\u6D88\u606F\uFF0C\u5185\u5BB9\u5305\u542BvoucherId\u3001userId\u3001orderId</p><p>1.\u53D1\u9001\u6D88\u606F\u5230\u961F\u5217\u4E2D\uFF0CXADD stream.orders * k1 v1 k2 v2</p></li><li><p>\u9879\u76EE\u542F\u52A8\u65F6\uFF0C\u5F00\u542F\u4E00\u4E2A\u7EBF\u7A0B\u4EFB\u52A1\uFF0C\u5C1D\u8BD5\u83B7\u53D6stream.orders\u4E2D\u7684\u6D88\u606F\uFF0C\u5B8C\u6210\u4E0B\u5355</p><p>1.\u4ECE\u961F\u5217\u4E2D\u8BFB\u53D6\u6D88\u606F XREADGROUP GROUP g1 c1 count 1 BLOCK 2000 STREAM S1 &gt;</p><p>2.\u82E5\u6D88\u606F\u4E3A\u7A7A\uFF0C\u8BF4\u660E\u8FD8\u6CA1\u6709\u6D88\u606F\uFF0C\u7EE7\u7EED\u4E0B\u6B21\u5FAA\u574F</p><p>3.\u521B\u5EFA\u8BA2\u5355</p><p>4.\u624B\u52A8ACK XACK</p><p>\u51FA\u73B0\u5F02\u5E38\uFF0C\u7F16\u5199\u65B9\u6CD5 handlePendingList</p><p>1.\u4ECEPendingList\u4E2D\u8BFB\u53D6\u6D88\u606F XREADGROUP GROUP g1 c1 count 1 BLOCK 2000 STREAM S1 0</p><p>2.\u82E5\u6D88\u606F\u4E3A\u7A7A\uFF0C\u8BF4\u660E\u6CA1\u6709\u5F02\u5E38\u6D88\u606F\uFF0C\u7ED3\u675F\u5FAA\u574F</p><p>3.\u521B\u5EFA\u8BA2\u5355</p><p>4.\u624B\u52A8ACK XACK</p><p>5.\u51FA\u73B0\u5F02\u5E38\uFF0C\u7761\u7720 20 ms\uFF0C\u7EE7\u7EED\u4E0B\u4E00\u6B21\u5FAA\u574F</p></li></ul></blockquote><p>\u9700\u6C42\uFF1A</p><ul><li>\u521B\u5EFA\u4E00\u4E2AStream\u7C7B\u578B\u7684\u6D88\u606F\u961F\u5217\uFF0C\u540D\u4E3Astream.orders</li><li>\u4FEE\u6539\u4E4B\u524D\u7684\u79D2\u6740\u4E0B\u5355Lua\u811A\u672C\uFF0C\u5728\u8BA4\u5B9A\u6709\u62A2\u8D2D\u8D44\u683C\u540E\uFF0C\u76F4\u63A5\u5411stream.orders\u4E2D\u6DFB\u52A0\u6D88\u606F\uFF0C\u5185\u5BB9\u5305\u542BvoucherId\u3001userId\u3001orderId</li><li>\u9879\u76EE\u542F\u52A8\u65F6\uFF0C\u5F00\u542F\u4E00\u4E2A\u7EBF\u7A0B\u4EFB\u52A1\uFF0C\u5C1D\u8BD5\u83B7\u53D6stream.orders\u4E2D\u7684\u6D88\u606F\uFF0C\u5B8C\u6210\u4E0B\u5355</li></ul><p>\u4FEE\u6539lua\u8868\u8FBE\u5F0F,\u65B0\u589E3.6</p><div class="language-lua ext-lua line-numbers-mode"><pre class="language-lua"><code><span class="token keyword">local</span> orderId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment">--3.5 \u53D1\u9001\u6D88\u606F\u5230\u961F\u5217\u4E2D\uFF0CXADD stream.orders * k1 v1 k2 v2</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;xadd&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;stream.orders&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;*&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;voucherId&#39;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">,</span> <span class="token string">&#39;userId&#39;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>VoucherOrderServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 1.\u83B7\u53D6\u6D88\u606F\u961F\u5217\u4E2D\u7684\u8BA2\u5355\u4FE1\u606F XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
                    <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 2.\u5224\u65AD\u8BA2\u5355\u4FE1\u606F\u662F\u5426\u4E3A\u7A7A</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// \u5982\u679C\u4E3Anull\uFF0C\u8BF4\u660E\u6CA1\u6709\u6D88\u606F\uFF0C\u7EE7\u7EED\u4E0B\u4E00\u6B21\u5FAA\u73AF</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// \u89E3\u6790\u6570\u636E</span>
                <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> value <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 3.\u521B\u5EFA\u8BA2\u5355</span>
                <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 4.\u786E\u8BA4\u6D88\u606F XACK</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token string">&quot;s1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u5904\u7406\u8BA2\u5355\u5F02\u5E38&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//\u5904\u7406\u5F02\u5E38\u6D88\u606F</span>
                <span class="token function">handlePendingList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handlePendingList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 1.\u83B7\u53D6pending-list\u4E2D\u7684\u8BA2\u5355\u4FE1\u606F XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
                    <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 2.\u5224\u65AD\u8BA2\u5355\u4FE1\u606F\u662F\u5426\u4E3A\u7A7A</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// \u5982\u679C\u4E3Anull\uFF0C\u8BF4\u660E\u6CA1\u6709\u5F02\u5E38\u6D88\u606F\uFF0C\u7ED3\u675F\u5FAA\u73AF</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// \u89E3\u6790\u6570\u636E</span>
                <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> value <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 3.\u521B\u5EFA\u8BA2\u5355</span>
                <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 4.\u786E\u8BA4\u6D88\u606F XACK</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token string">&quot;s1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u5904\u7406pendding\u8BA2\u5355\u5F02\u5E38&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span><span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8\u3001\u8FBE\u4EBA\u63A2\u5E97" tabindex="-1"><a class="header-anchor" href="#_8\u3001\u8FBE\u4EBA\u63A2\u5E97" aria-hidden="true">#</a> 8\u3001\u8FBE\u4EBA\u63A2\u5E97</h2><h3 id="_8-1\u3001\u8FBE\u4EBA\u63A2\u5E97-\u53D1\u5E03\u63A2\u5E97\u7B14\u8BB0" tabindex="-1"><a class="header-anchor" href="#_8-1\u3001\u8FBE\u4EBA\u63A2\u5E97-\u53D1\u5E03\u63A2\u5E97\u7B14\u8BB0" aria-hidden="true">#</a> 8.1\u3001\u8FBE\u4EBA\u63A2\u5E97-\u53D1\u5E03\u63A2\u5E97\u7B14\u8BB0</h3><p>\u53D1\u5E03\u63A2\u5E97\u7B14\u8BB0</p><p>\u63A2\u5E97\u7B14\u8BB0\u7C7B\u4F3C\u70B9\u8BC4\u7F51\u7AD9\u7684\u8BC4\u4EF7\uFF0C\u5F80\u5F80\u662F\u56FE\u6587\u7ED3\u5408\u3002\u5BF9\u5E94\u7684\u8868\u6709\u4E24\u4E2A\uFF1A tb_blog\uFF1A\u63A2\u5E97\u7B14\u8BB0\u8868\uFF0C\u5305\u542B\u7B14\u8BB0\u4E2D\u7684\u6807\u9898\u3001\u6587\u5B57\u3001\u56FE\u7247\u7B49 tb_blog_comments\uFF1A\u5176\u4ED6\u7528\u6237\u5BF9\u63A2\u5E97\u7B14\u8BB0\u7684\u8BC4\u4EF7</p><p><strong>\u5177\u4F53\u53D1\u5E03\u6D41\u7A0B</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653578992639.png" alt="1653578992639"></p><p>\u4E0A\u4F20\u63A5\u53E3</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;upload&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;blog&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">uploadImage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> image<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u83B7\u53D6\u539F\u59CB\u6587\u4EF6\u540D\u79F0</span>
            <span class="token class-name">String</span> originalFilename <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u751F\u6210\u65B0\u6587\u4EF6\u540D</span>
            <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token function">createNewFileName</span><span class="token punctuation">(</span>originalFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u4FDD\u5B58\u6587\u4EF6</span>
            image<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>IMAGE_UPLOAD_DIR<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u8FD4\u56DE\u7ED3\u679C</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;\u6587\u4EF6\u4E0A\u4F20\u6210\u529F\uFF0C{}&quot;</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6CE8\u610F\uFF1A\u540C\u5B66\u4EEC\u5728\u64CD\u4F5C\u65F6\uFF0C\u9700\u8981\u4FEE\u6539SystemConstants.IMAGE_UPLOAD_DIR \u81EA\u5DF1\u56FE\u7247\u6240\u5728\u7684\u5730\u5740\uFF0C\u5728\u5B9E\u9645\u5F00\u53D1\u4E2D\u56FE\u7247\u4E00\u822C\u4F1A\u653E\u5728nginx\u4E0A\u6216\u8005\u662F\u4E91\u5B58\u50A8\u4E0A\u3002</p><p>BlogController</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/blog&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlogController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IBlogService</span> blogService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">saveBlog</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u83B7\u53D6\u767B\u5F55\u7528\u6237</span>
        <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u4FDD\u5B58\u63A2\u5E97\u535A\u6587</span>
        blogService<span class="token punctuation">.</span><span class="token function">saveBlog</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u8FD4\u56DEid</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-\u8FBE\u4EBA\u63A2\u5E97-\u67E5\u770B\u63A2\u5E97\u7B14\u8BB0" tabindex="-1"><a class="header-anchor" href="#_8-2-\u8FBE\u4EBA\u63A2\u5E97-\u67E5\u770B\u63A2\u5E97\u7B14\u8BB0" aria-hidden="true">#</a> 8.2 \u8FBE\u4EBA\u63A2\u5E97-\u67E5\u770B\u63A2\u5E97\u7B14\u8BB0</h3><p>\u5B9E\u73B0\u67E5\u770B\u53D1\u5E03\u63A2\u5E97\u7B14\u8BB0\u7684\u63A5\u53E3</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653579931626.png" alt="1653579931626"></p><p>\u5B9E\u73B0\u4EE3\u7801\uFF1A</p><p>BlogServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.\u67E5\u8BE2blog</span>
    <span class="token class-name">Blog</span> blog <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>blog <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u7B14\u8BB0\u4E0D\u5B58\u5728\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2.\u67E5\u8BE2blog\u6709\u5173\u7684\u7528\u6237</span>
    <span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queryBlogUser</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> blog<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-\u8FBE\u4EBA\u63A2\u5E97-\u70B9\u8D5E\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_8-3-\u8FBE\u4EBA\u63A2\u5E97-\u70B9\u8D5E\u529F\u80FD" aria-hidden="true">#</a> 8.3 \u8FBE\u4EBA\u63A2\u5E97-\u70B9\u8D5E\u529F\u80FD</h3><blockquote><p>\u9700\u6C42\uFF1A</p><ul><li>\u540C\u4E00\u4E2A\u7528\u6237\u53EA\u80FD\u70B9\u8D5E\u4E00\u6B21\uFF0C\u518D\u6B21\u70B9\u51FB\u5219\u53D6\u6D88\u70B9\u8D5E</li><li>\u5982\u679C\u5F53\u524D\u7528\u6237\u5DF2\u7ECF\u70B9\u8D5E\uFF0C\u5219\u70B9\u8D5E\u6309\u94AE\u9AD8\u4EAE\u663E\u793A\uFF08\u524D\u7AEF\u5DF2\u5B9E\u73B0\uFF0C\u5224\u65AD\u5B57\u6BB5Blog\u7C7B\u7684isLike\u5C5E\u6027\uFF09</li></ul><p>\u7ED9 Blog \u7C7B\u6DFB\u52A0 isLike \u5B57\u6BB5</p><p>1.\u83B7\u53D6\u7528\u6237id</p><p>2.\u5224\u65AD\u7528\u6237\u662F\u5426\u70B9\u8D5E\u8FC7 ismember</p><p>3.\u6CA1\u70B9\u8D5E\u8FC7</p><p>\u200B 3.1 \u6570\u636E\u5E93 \u70B9\u8D5E\u6570+1</p><p>\u200B 3.2 redis \u5C06 \u7528\u6237id \u653E\u5165 set</p><p>4.\u70B9\u8D5E\u8FC7</p><p>\u200B 4.1 \u6570\u636E\u5E93 \u70B9\u8D5E\u6570\uFF0D1</p><p>\u200B 4.2 redis \u5C06 \u7528\u6237id \u79FB\u51FAset</p></blockquote><p>\u521D\u59CB\u4EE3\u7801</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/likes/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogLikes</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//\u4FEE\u6539\u70B9\u8D5E\u6570\u91CF</span>
    blogService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked +1 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u95EE\u9898\u5206\u6790\uFF1A\u8FD9\u79CD\u65B9\u5F0F\u4F1A\u5BFC\u81F4\u4E00\u4E2A\u7528\u6237\u65E0\u9650\u70B9\u8D5E\uFF0C\u660E\u663E\u662F\u4E0D\u5408\u7406\u7684</p><p>\u9020\u6210\u8FD9\u4E2A\u95EE\u9898\u7684\u539F\u56E0\u662F\uFF0C\u6211\u4EEC\u73B0\u5728\u7684\u903B\u8F91\uFF0C\u53D1\u8D77\u8BF7\u6C42\u53EA\u662F\u7ED9\u6570\u636E\u5E93+1\uFF0C\u6240\u4EE5\u624D\u4F1A\u51FA\u73B0\u8FD9\u4E2A\u95EE\u9898</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653581590453.png" alt="1653581590453"></p><p>\u5B8C\u5584\u70B9\u8D5E\u529F\u80FD</p><p>\u9700\u6C42\uFF1A</p><ul><li>\u540C\u4E00\u4E2A\u7528\u6237\u53EA\u80FD\u70B9\u8D5E\u4E00\u6B21\uFF0C\u518D\u6B21\u70B9\u51FB\u5219\u53D6\u6D88\u70B9\u8D5E</li><li>\u5982\u679C\u5F53\u524D\u7528\u6237\u5DF2\u7ECF\u70B9\u8D5E\uFF0C\u5219\u70B9\u8D5E\u6309\u94AE\u9AD8\u4EAE\u663E\u793A\uFF08\u524D\u7AEF\u5DF2\u5B9E\u73B0\uFF0C\u5224\u65AD\u5B57\u6BB5Blog\u7C7B\u7684isLike\u5C5E\u6027\uFF09</li></ul><p>\u5B9E\u73B0\u6B65\u9AA4\uFF1A</p><ul><li>\u7ED9Blog\u7C7B\u4E2D\u6DFB\u52A0\u4E00\u4E2AisLike\u5B57\u6BB5\uFF0C\u6807\u793A\u662F\u5426\u88AB\u5F53\u524D\u7528\u6237\u70B9\u8D5E</li><li>\u4FEE\u6539\u70B9\u8D5E\u529F\u80FD\uFF0C\u5229\u7528Redis\u7684set\u96C6\u5408\u5224\u65AD\u662F\u5426\u70B9\u8D5E\u8FC7\uFF0C\u672A\u70B9\u8D5E\u8FC7\u5219\u70B9\u8D5E\u6570+1\uFF0C\u5DF2\u70B9\u8D5E\u8FC7\u5219\u70B9\u8D5E\u6570-1</li><li>\u4FEE\u6539\u6839\u636Eid\u67E5\u8BE2Blog\u7684\u4E1A\u52A1\uFF0C\u5224\u65AD\u5F53\u524D\u767B\u5F55\u7528\u6237\u662F\u5426\u70B9\u8D5E\u8FC7\uFF0C\u8D4B\u503C\u7ED9isLike\u5B57\u6BB5</li><li>\u4FEE\u6539\u5206\u9875\u67E5\u8BE2Blog\u4E1A\u52A1\uFF0C\u5224\u65AD\u5F53\u524D\u767B\u5F55\u7528\u6237\u662F\u5426\u70B9\u8D5E\u8FC7\uFF0C\u8D4B\u503C\u7ED9isLike\u5B57\u6BB5</li></ul><p>\u4E3A\u4EC0\u4E48\u91C7\u7528set\u96C6\u5408\uFF1A</p><p>\u56E0\u4E3A\u6211\u4EEC\u7684\u6570\u636E\u662F\u4E0D\u80FD\u91CD\u590D\u7684\uFF0C\u5F53\u7528\u6237\u64CD\u4F5C\u8FC7\u4E4B\u540E\uFF0C\u65E0\u8BBA\u4ED6\u600E\u4E48\u64CD\u4F5C\uFF0C\u90FD\u662F</p><p>\u5177\u4F53\u6B65\u9AA4\uFF1A</p><p>1\u3001\u5728Blog \u6DFB\u52A0\u4E00\u4E2A\u5B57\u6BB5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Boolean</span> isLike<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>2\u3001\u4FEE\u6539\u4EE3\u7801</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlogServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BlogMapper</span><span class="token punctuation">,</span> <span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IBlogService</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IUserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryHot</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u6839\u636E\u7528\u6237\u67E5\u8BE2</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token string">&quot;liked&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>MAX_PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u5F53\u524D\u9875\u6570\u636E</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u67E5\u8BE2\u7528\u6237</span>
        records<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>blog <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">queryIsLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// --------- \u65B0\u589E</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u6839\u636E id \u67E5\u8BE2 blog
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Blog</span> blog <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">queryIsLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// -------- \u65B0\u589E</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u8BBE\u7F6E \u662F\u5426\u70B9\u8D5E\u8FC7 -------- \u65B0\u589E
     * <span class="token keyword">@param</span> <span class="token parameter">blog</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queryIsLiked</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u83B7\u53D6\u7528\u6237id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5224\u65AD\u7528\u6237\u662F\u5426\u70B9\u8D5E\u8FC7 ismember</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;blog:like:&quot;</span> <span class="token operator">+</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> isMember <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setIsLike</span><span class="token punctuation">(</span>isMember<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u70B9\u8D5E
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">likeBlog</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u83B7\u53D6\u7528\u6237id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5224\u65AD\u7528\u6237\u662F\u5426\u70B9\u8D5E\u8FC7 ismember</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;blog:like:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> isMember <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>isMember<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3.\u6CA1\u70B9\u8D5E\u8FC7</span>
            <span class="token comment">// 3.1 \u6570\u636E\u5E93 \u70B9\u8D5E\u6570+1</span>
            <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked + 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3.2 redis \u5C06 \u7528\u6237id \u653E\u5165 set</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.\u70B9\u8D5E\u8FC7</span>
            <span class="token comment">// 4.1 \u6570\u636E\u5E93 \u70B9\u8D5E\u6570\uFF0D1</span>
            <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked - 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4.2 redis \u5C06 \u7528\u6237id \u79FB\u51FAset</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-4-\u8FBE\u4EBA\u63A2\u5E97-\u70B9\u8D5E\u6392\u884C\u699C" tabindex="-1"><a class="header-anchor" href="#_8-4-\u8FBE\u4EBA\u63A2\u5E97-\u70B9\u8D5E\u6392\u884C\u699C" aria-hidden="true">#</a> 8.4 \u8FBE\u4EBA\u63A2\u5E97-\u70B9\u8D5E\u6392\u884C\u699C</h3><blockquote><p>set \u6539\u7528 zset</p><p>1.\u5224\u65AD\u662F\u5426\u70B9\u8D5E\u8FC7 zscore</p><p>2.\u4F7F\u7528\u65F6\u95F4\u6233\u4F5C\u4E3A score</p><p>\u7F16\u5199\u70B9\u8D5E\u6392\u884C\u699C top5 \u63A5\u53E3</p><p>1.\u4ECEredis \u4E2D\u53D6\u51FA top5 zrange</p><p>2.\u6839\u636Eid \u67E5\u8BE2\u7528\u6237</p><p>3.\u8FD4\u56DE\u8131\u654F\u7528\u6237\u5217\u8868</p></blockquote><p>\u5728\u63A2\u5E97\u7B14\u8BB0\u7684\u8BE6\u60C5\u9875\u9762\uFF0C\u5E94\u8BE5\u628A\u7ED9\u8BE5\u7B14\u8BB0\u70B9\u8D5E\u7684\u4EBA\u663E\u793A\u51FA\u6765\uFF0C\u6BD4\u5982\u6700\u65E9\u70B9\u8D5E\u7684TOP5\uFF0C\u5F62\u6210\u70B9\u8D5E\u6392\u884C\u699C\uFF1A</p><p>\u4E4B\u524D\u7684\u70B9\u8D5E\u662F\u653E\u5230set\u96C6\u5408\uFF0C\u4F46\u662Fset\u96C6\u5408\u662F\u4E0D\u80FD\u6392\u5E8F\u7684\uFF0C\u6240\u4EE5\u8FD9\u4E2A\u65F6\u5019\uFF0C\u54B1\u4EEC\u53EF\u4EE5\u91C7\u7528\u4E00\u4E2A\u53EF\u4EE5\u6392\u5E8F\u7684set\u96C6\u5408\uFF0C\u5C31\u662F\u54B1\u4EEC\u7684sortedSet</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653805077118.png" alt="1653805077118"></p><p>\u6211\u4EEC\u63A5\u4E0B\u6765\u6765\u5BF9\u6BD4\u4E00\u4E0B\u8FD9\u4E9B\u96C6\u5408\u7684\u533A\u522B\u662F\u4EC0\u4E48</p><p>\u6240\u6709\u70B9\u8D5E\u7684\u4EBA\uFF0C\u9700\u8981\u662F\u552F\u4E00\u7684\uFF0C\u6240\u4EE5\u6211\u4EEC\u5E94\u5F53\u4F7F\u7528set\u6216\u8005\u662FsortedSet</p><p>\u5176\u6B21\u6211\u4EEC\u9700\u8981\u6392\u5E8F\uFF0C\u5C31\u53EF\u4EE5\u76F4\u63A5\u9501\u5B9A\u4F7F\u7528sortedSet\u5566</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653805203758.png" alt="1653805203758"></p><p>\u4FEE\u6539\u4EE3\u7801</p><p>BlogServiceImpl</p><p>\u70B9\u8D5E\u903B\u8F91\u4EE3\u7801</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">likeBlog</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u83B7\u53D6\u767B\u5F55\u7528\u6237</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5224\u65AD\u5F53\u524D\u767B\u5F55\u7528\u6237\u662F\u5426\u5DF2\u7ECF\u70B9\u8D5E</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> BLOG_LIKED_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">Double</span> score <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ---- \u66F4\u6539</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3.\u5982\u679C\u672A\u70B9\u8D5E\uFF0C\u53EF\u4EE5\u70B9\u8D5E</span>
            <span class="token comment">// 3.1.\u6570\u636E\u5E93\u70B9\u8D5E\u6570 + 1</span>
            <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked + 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3.2.\u4FDD\u5B58\u7528\u6237\u5230Redis\u7684set\u96C6\u5408  zadd key value score</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ---- \u66F4\u6539</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.\u5982\u679C\u5DF2\u70B9\u8D5E\uFF0C\u53D6\u6D88\u70B9\u8D5E</span>
            <span class="token comment">// 4.1.\u6570\u636E\u5E93\u70B9\u8D5E\u6570 -1</span>
            <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked - 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4.2.\u628A\u7528\u6237\u4ECERedis\u7684set\u96C6\u5408\u79FB\u9664</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ---- \u66F4\u6539</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">isBlogLiked</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u83B7\u53D6\u767B\u5F55\u7528\u6237</span>
        <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u7528\u6237\u672A\u767B\u5F55\uFF0C\u65E0\u9700\u67E5\u8BE2\u662F\u5426\u70B9\u8D5E</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u5224\u65AD\u5F53\u524D\u767B\u5F55\u7528\u6237\u662F\u5426\u5DF2\u7ECF\u70B9\u8D5E</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;blog:liked:&quot;</span> <span class="token operator">+</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Double</span> score <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ---- \u66F4\u6539</span>
        blog<span class="token punctuation">.</span><span class="token function">setIsLike</span><span class="token punctuation">(</span>score <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u70B9\u8D5E\u5217\u8868\u67E5\u8BE2\u5217\u8868</p><p>BlogController</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/likes/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogLikes</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> blogService<span class="token punctuation">.</span><span class="token function">queryBlogLikes</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>BlogServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogLikes</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> BLOG_LIKED_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token comment">// 1.\u67E5\u8BE2top5\u7684\u70B9\u8D5E\u7528\u6237 zrange key 0 4</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> top5 <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>top5 <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> top5<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2.\u89E3\u6790\u51FA\u5176\u4E2D\u7684\u7528\u6237id</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> top5<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> idStr <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.\u6839\u636E\u7528\u6237id\u67E5\u8BE2\u7528\u6237 WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> userDTOS <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER BY FIELD(id,&quot;</span> <span class="token operator">+</span> idStr <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.\u8FD4\u56DE</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>userDTOS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
     * \u8BBE\u7F6E \u662F\u5426\u70B9\u8D5E\u8FC7
     *
     * <span class="token keyword">@param</span> <span class="token parameter">blog</span>
     */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queryIsLiked</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">// --------- \u65B0\u589E</span>
        <span class="token comment">// \u7528\u6237\u672A\u767B\u5F55\uFF0C\u65E0\u9700\u67E5\u8BE2\u662F\u5426\u70B9\u8D5E</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 1.\u83B7\u53D6\u7528\u6237id</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.\u5224\u65AD\u7528\u6237\u662F\u5426\u70B9\u8D5E\u8FC7 ismember</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> BLOG_LIKED_KEY <span class="token operator">+</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Double</span> score <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setIsLike</span><span class="token punctuation">(</span>score <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9\u3001\u597D\u53CB\u5173\u6CE8" tabindex="-1"><a class="header-anchor" href="#_9\u3001\u597D\u53CB\u5173\u6CE8" aria-hidden="true">#</a> 9\u3001\u597D\u53CB\u5173\u6CE8</h2><h3 id="_9-1-\u597D\u53CB\u5173\u6CE8-\u5173\u6CE8\u548C\u53D6\u6D88\u5173\u6CE8" tabindex="-1"><a class="header-anchor" href="#_9-1-\u597D\u53CB\u5173\u6CE8-\u5173\u6CE8\u548C\u53D6\u6D88\u5173\u6CE8" aria-hidden="true">#</a> 9.1 \u597D\u53CB\u5173\u6CE8-\u5173\u6CE8\u548C\u53D6\u6D88\u5173\u6CE8</h3><p>\u9488\u5BF9\u7528\u6237\u7684\u64CD\u4F5C\uFF1A\u53EF\u4EE5\u5BF9\u7528\u6237\u8FDB\u884C\u5173\u6CE8\u548C\u53D6\u6D88\u5173\u6CE8\u529F\u80FD\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653806140822.png" alt="1653806140822"></p><p>\u5B9E\u73B0\u601D\u8DEF\uFF1A</p><p>\u9700\u6C42\uFF1A\u57FA\u4E8E\u8BE5\u8868\u6570\u636E\u7ED3\u6784\uFF0C\u5B9E\u73B0\u4E24\u4E2A\u63A5\u53E3\uFF1A</p><ul><li>\u5173\u6CE8\u548C\u53D6\u5173\u63A5\u53E3</li><li>\u5224\u65AD\u662F\u5426\u5173\u6CE8\u7684\u63A5\u53E3</li></ul><p>\u5173\u6CE8\u662FUser\u4E4B\u95F4\u7684\u5173\u7CFB\uFF0C\u662F\u535A\u4E3B\u4E0E\u7C89\u4E1D\u7684\u5173\u7CFB\uFF0C\u6570\u636E\u5E93\u4E2D\u6709\u4E00\u5F20tb_follow\u8868\u6765\u6807\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653806253817.png" alt="1653806253817"></p><p>\u6CE8\u610F: \u8FD9\u91CC\u9700\u8981\u628A\u4E3B\u952E\u4FEE\u6539\u4E3A\u81EA\u589E\u957F\uFF0C\u7B80\u5316\u5F00\u53D1\u3002</p><p>FollowController</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u5173\u6CE8 \u6216 \u53D6\u6D88\u5173\u6CE8</span>
<span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}/{isFollow}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> followUserId<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;isFollow&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Boolean</span> isFollow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> followService<span class="token punctuation">.</span><span class="token function">follow</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">,</span> isFollow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u67E5\u8BE2\u662F\u5426\u5173\u6CE8</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/or/not/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">isFollow</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> followUserId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> followService<span class="token punctuation">.</span><span class="token function">isFollow</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>FollowServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">isFollow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u83B7\u53D6\u767B\u5F55\u7528\u6237</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.\u67E5\u8BE2\u662F\u5426\u5173\u6CE8 select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;follow_user_id&quot;</span><span class="token punctuation">,</span> followUserId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.\u5224\u65AD</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

 <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isFollow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u83B7\u53D6\u767B\u5F55\u7528\u6237</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;follows:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
        <span class="token comment">// 1.\u5224\u65AD\u5230\u5E95\u662F\u5173\u6CE8\u8FD8\u662F\u53D6\u5173</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isFollow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.\u5173\u6CE8\uFF0C\u65B0\u589E\u6570\u636E</span>
            <span class="token class-name">Follow</span> follow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Follow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            follow<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            follow<span class="token punctuation">.</span><span class="token function">setFollowUserId</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>follow<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3.\u53D6\u5173\uFF0C\u5220\u9664 delete from tb_follow where user_id = ? and follow_user_id = ?</span>
            <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;follow_user_id&quot;</span><span class="token punctuation">,</span> followUserId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-2-\u597D\u53CB\u5173\u6CE8-\u5171\u540C\u5173\u6CE8" tabindex="-1"><a class="header-anchor" href="#_9-2-\u597D\u53CB\u5173\u6CE8-\u5171\u540C\u5173\u6CE8" aria-hidden="true">#</a> 9.2 \u597D\u53CB\u5173\u6CE8-\u5171\u540C\u5173\u6CE8</h3><blockquote><p>1.\u6539\u9020\u5173\u6CE8\u63A5\u53E3\uFF0C\u5C06 followUserId \u653E\u5165 redis \u4E2D</p><p>2.\u6C42\u4EA4\u96C6\u5F97\u5230\u5171\u540C\u5173\u6CE8</p></blockquote><p>\u60F3\u8981\u53BB\u770B\u5171\u540C\u5173\u6CE8\u7684\u597D\u53CB\uFF0C\u9700\u8981\u9996\u5148\u8FDB\u5165\u5230\u8FD9\u4E2A\u9875\u9762\uFF0C\u8FD9\u4E2A\u9875\u9762\u4F1A\u53D1\u8D77\u4E24\u4E2A\u8BF7\u6C42</p><p>1\u3001\u53BB\u67E5\u8BE2\u7528\u6237\u7684\u8BE6\u60C5</p><p>2\u3001\u53BB\u67E5\u8BE2\u7528\u6237\u7684\u7B14\u8BB0</p><p>\u4EE5\u4E0A\u4E24\u4E2A\u529F\u80FD\u548C\u5171\u540C\u5173\u6CE8\u6CA1\u6709\u4EC0\u4E48\u5173\u7CFB\uFF0C\u5927\u5BB6\u53EF\u4EE5\u81EA\u884C\u5C06\u7B14\u8BB0\u4E2D\u7684\u4EE3\u7801\u62F7\u8D1D\u5230idea\u4E2D\u5C31\u53EF\u4EE5\u5B9E\u73B0\u8FD9\u4E24\u4E2A\u529F\u80FD\u4E86\uFF0C\u6211\u4EEC\u7684\u91CD\u70B9\u5728\u4E8E\u5171\u540C\u5173\u6CE8\u529F\u80FD\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653806706296.png" alt="1653806706296"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// UserController \u6839\u636Eid\u67E5\u8BE2\u7528\u6237</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// \u67E5\u8BE2\u8BE6\u60C5</span>
	<span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// \u8FD4\u56DE</span>
	<span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// BlogController  \u6839\u636Eid\u67E5\u8BE2\u535A\u4E3B\u7684\u63A2\u5E97\u7B14\u8BB0</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/of/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogByUserId</span><span class="token punctuation">(</span>
		<span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;current&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> current<span class="token punctuation">,</span>
		<span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// \u6839\u636E\u7528\u6237\u67E5\u8BE2</span>
	<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> blogService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>MAX_PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// \u83B7\u53D6\u5F53\u524D\u9875\u6570\u636E</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\u6211\u4EEC\u6765\u770B\u770B\u5171\u540C\u5173\u6CE8\u5982\u4F55\u5B9E\u73B0\uFF1A</p><p>\u9700\u6C42\uFF1A\u5229\u7528Redis\u4E2D\u6070\u5F53\u7684\u6570\u636E\u7ED3\u6784\uFF0C\u5B9E\u73B0\u5171\u540C\u5173\u6CE8\u529F\u80FD\u3002\u5728\u535A\u4E3B\u4E2A\u4EBA\u9875\u9762\u5C55\u793A\u51FA\u5F53\u524D\u7528\u6237\u4E0E\u535A\u4E3B\u7684\u5171\u540C\u5173\u6CE8\u5462\u3002</p><p>\u5F53\u7136\u662F\u4F7F\u7528\u6211\u4EEC\u4E4B\u524D\u5B66\u4E60\u8FC7\u7684set\u96C6\u5408\u54AF\uFF0C\u5728set\u96C6\u5408\u4E2D\uFF0C\u6709\u4EA4\u96C6\u5E76\u96C6\u8865\u96C6\u7684api\uFF0C\u6211\u4EEC\u53EF\u4EE5\u628A\u4E24\u4EBA\u7684\u5173\u6CE8\u7684\u4EBA\u5206\u522B\u653E\u5165\u5230\u4E00\u4E2Aset\u96C6\u5408\u4E2D\uFF0C\u7136\u540E\u518D\u901A\u8FC7api\u53BB\u67E5\u770B\u8FD9\u4E24\u4E2Aset\u96C6\u5408\u4E2D\u7684\u4EA4\u96C6\u6570\u636E\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653806973212.png" alt="1653806973212"></p><p>\u6211\u4EEC\u5148\u6765\u6539\u9020\u5F53\u524D\u7684\u5173\u6CE8\u5217\u8868</p><p>\u6539\u9020\u539F\u56E0\u662F\u56E0\u4E3A\u6211\u4EEC\u9700\u8981\u5728\u7528\u6237\u5173\u6CE8\u4E86\u67D0\u4F4D\u7528\u6237\u540E\uFF0C\u9700\u8981\u5C06\u6570\u636E\u653E\u5165\u5230set\u96C6\u5408\u4E2D\uFF0C\u65B9\u4FBF\u540E\u7EED\u8FDB\u884C\u5171\u540C\u5173\u6CE8\uFF0C\u540C\u65F6\u5F53\u53D6\u6D88\u5173\u6CE8\u65F6\uFF0C\u4E5F\u9700\u8981\u4ECEset\u96C6\u5408\u4E2D\u8FDB\u884C\u5220\u9664</p><p>FollowServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isFollow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.\u83B7\u53D6\u767B\u5F55\u7528\u6237</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;follows:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token comment">// 1.\u5224\u65AD\u5230\u5E95\u662F\u5173\u6CE8\u8FD8\u662F\u53D6\u5173</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isFollow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.\u5173\u6CE8\uFF0C\u65B0\u589E\u6570\u636E</span>
        <span class="token class-name">Follow</span> follow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Follow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        follow<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        follow<span class="token punctuation">.</span><span class="token function">setFollowUserId</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>follow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u628A\u5173\u6CE8\u7528\u6237\u7684id\uFF0C\u653E\u5165redis\u7684set\u96C6\u5408 sadd userId followerUserId</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> followUserId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.\u53D6\u5173\uFF0C\u5220\u9664 delete from tb_follow where user_id = ? and follow_user_id = ?</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;follow_user_id&quot;</span><span class="token punctuation">,</span> followUserId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u628A\u5173\u6CE8\u7528\u6237\u7684id\u4ECERedis\u96C6\u5408\u4E2D\u79FB\u9664</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> followUserId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u5177\u4F53\u7684\u5173\u6CE8\u4EE3\u7801\uFF1A</strong></p><p>FollowServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">followCommons</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.\u83B7\u53D6\u5F53\u524D\u7528\u6237</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;follows:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token comment">// 2.\u6C42\u4EA4\u96C6</span>
    <span class="token class-name">String</span> key2 <span class="token operator">=</span> <span class="token string">&quot;follows:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> intersect <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> key2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>intersect <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> intersect<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u65E0\u4EA4\u96C6</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.\u89E3\u6790id\u96C6\u5408</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> intersect<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.\u67E5\u8BE2\u7528\u6237</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">listByIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-3-\u597D\u53CB\u5173\u6CE8-feed\u6D41\u5B9E\u73B0\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#_9-3-\u597D\u53CB\u5173\u6CE8-feed\u6D41\u5B9E\u73B0\u65B9\u6848" aria-hidden="true">#</a> 9.3 \u597D\u53CB\u5173\u6CE8-Feed\u6D41\u5B9E\u73B0\u65B9\u6848</h3><p>\u5F53\u6211\u4EEC\u5173\u6CE8\u4E86\u7528\u6237\u540E\uFF0C\u8FD9\u4E2A\u7528\u6237\u53D1\u4E86\u52A8\u6001\uFF0C\u90A3\u4E48\u6211\u4EEC\u5E94\u8BE5\u628A\u8FD9\u4E9B\u6570\u636E\u63A8\u9001\u7ED9\u7528\u6237\uFF0C\u8FD9\u4E2A\u9700\u6C42\uFF0C\u5176\u5B9E\u6211\u4EEC\u53C8\u628A\u4ED6\u53EB\u505AFeed\u6D41\uFF0C\u5173\u6CE8\u63A8\u9001\u4E5F\u53EB\u505AFeed\u6D41\uFF0C\u76F4\u8BD1\u4E3A\u6295\u5582\u3002\u4E3A\u7528\u6237\u6301\u7EED\u7684\u63D0\u4F9B\u201C\u6C89\u6D78\u5F0F\u201D\u7684\u4F53\u9A8C\uFF0C\u901A\u8FC7\u65E0\u9650\u4E0B\u62C9\u5237\u65B0\u83B7\u53D6\u65B0\u7684\u4FE1\u606F\u3002</p><p>\u5BF9\u4E8E\u4F20\u7EDF\u7684\u6A21\u5F0F\u7684\u5185\u5BB9\u89E3\u9501\uFF1A\u6211\u4EEC\u662F\u9700\u8981\u7528\u6237\u53BB\u901A\u8FC7\u641C\u7D22\u5F15\u64CE\u6216\u8005\u662F\u5176\u4ED6\u7684\u65B9\u5F0F\u53BB\u89E3\u9501\u60F3\u8981\u770B\u7684\u5185\u5BB9</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653808641260.png" alt="1653808641260"></p><p>\u5BF9\u4E8E\u65B0\u578B\u7684Feed\u6D41\u7684\u7684\u6548\u679C\uFF1A\u4E0D\u9700\u8981\u6211\u4EEC\u7528\u6237\u518D\u53BB\u63A8\u9001\u4FE1\u606F\uFF0C\u800C\u662F\u7CFB\u7EDF\u5206\u6790\u7528\u6237\u5230\u5E95\u60F3\u8981\u4EC0\u4E48\uFF0C\u7136\u540E\u76F4\u63A5\u628A\u5185\u5BB9\u63A8\u9001\u7ED9\u7528\u6237\uFF0C\u4ECE\u800C\u4F7F\u7528\u6237\u80FD\u591F\u66F4\u52A0\u7684\u8282\u7EA6\u65F6\u95F4\uFF0C\u4E0D\u7528\u4E3B\u52A8\u53BB\u5BFB\u627E\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653808993693.png" alt="1653808993693"></p><p>Feed\u6D41\u7684\u5B9E\u73B0\u6709\u4E24\u79CD\u6A21\u5F0F\uFF1A</p><p>Feed\u6D41\u4EA7\u54C1\u6709\u4E24\u79CD\u5E38\u89C1\u6A21\u5F0F\uFF1A Timeline\uFF1A\u4E0D\u505A\u5185\u5BB9\u7B5B\u9009\uFF0C\u7B80\u5355\u7684\u6309\u7167\u5185\u5BB9\u53D1\u5E03\u65F6\u95F4\u6392\u5E8F\uFF0C\u5E38\u7528\u4E8E\u597D\u53CB\u6216\u5173\u6CE8\u3002\u4F8B\u5982\u670B\u53CB\u5708</p><ul><li>\u4F18\u70B9\uFF1A\u4FE1\u606F\u5168\u9762\uFF0C\u4E0D\u4F1A\u6709\u7F3A\u5931\u3002\u5E76\u4E14\u5B9E\u73B0\u4E5F\u76F8\u5BF9\u7B80\u5355</li><li>\u7F3A\u70B9\uFF1A\u4FE1\u606F\u566A\u97F3\u8F83\u591A\uFF0C\u7528\u6237\u4E0D\u4E00\u5B9A\u611F\u5174\u8DA3\uFF0C\u5185\u5BB9\u83B7\u53D6\u6548\u7387\u4F4E</li></ul><p>\u667A\u80FD\u6392\u5E8F\uFF1A\u5229\u7528\u667A\u80FD\u7B97\u6CD5\u5C4F\u853D\u6389\u8FDD\u89C4\u7684\u3001\u7528\u6237\u4E0D\u611F\u5174\u8DA3\u7684\u5185\u5BB9\u3002\u63A8\u9001\u7528\u6237\u611F\u5174\u8DA3\u4FE1\u606F\u6765\u5438\u5F15\u7528\u6237</p><ul><li>\u4F18\u70B9\uFF1A\u6295\u5582\u7528\u6237\u611F\u5174\u8DA3\u4FE1\u606F\uFF0C\u7528\u6237\u7C98\u5EA6\u5F88\u9AD8\uFF0C\u5BB9\u6613\u6C89\u8FF7</li><li>\u7F3A\u70B9\uFF1A\u5982\u679C\u7B97\u6CD5\u4E0D\u7CBE\u51C6\uFF0C\u53EF\u80FD\u8D77\u5230\u53CD\u4F5C\u7528 \u672C\u4F8B\u4E2D\u7684\u4E2A\u4EBA\u9875\u9762\uFF0C\u662F\u57FA\u4E8E\u5173\u6CE8\u7684\u597D\u53CB\u6765\u505AFeed\u6D41\uFF0C\u56E0\u6B64\u91C7\u7528Timeline\u7684\u6A21\u5F0F\u3002\u8BE5\u6A21\u5F0F\u7684\u5B9E\u73B0\u65B9\u6848\u6709\u4E09\u79CD\uFF1A</li></ul><p>\u6211\u4EEC\u672C\u6B21\u9488\u5BF9\u597D\u53CB\u7684\u64CD\u4F5C\uFF0C\u91C7\u7528\u7684\u5C31\u662FTimeline\u7684\u65B9\u5F0F\uFF0C\u53EA\u9700\u8981\u62FF\u5230\u6211\u4EEC\u5173\u6CE8\u7528\u6237\u7684\u4FE1\u606F\uFF0C\u7136\u540E\u6309\u7167\u65F6\u95F4\u6392\u5E8F\u5373\u53EF</p><p>\uFF0C\u56E0\u6B64\u91C7\u7528Timeline\u7684\u6A21\u5F0F\u3002\u8BE5\u6A21\u5F0F\u7684\u5B9E\u73B0\u65B9\u6848\u6709\u4E09\u79CD\uFF1A</p><ul><li>\u62C9\u6A21\u5F0F</li><li>\u63A8\u6A21\u5F0F</li><li>\u63A8\u62C9\u7ED3\u5408</li></ul><p><strong>\u62C9\u6A21\u5F0F</strong>\uFF1A\u4E5F\u53EB\u505A\u8BFB\u6269\u6563</p><p>\u8BE5\u6A21\u5F0F\u7684\u6838\u5FC3\u542B\u4E49\u5C31\u662F\uFF1A\u5F53\u5F20\u4E09\u548C\u674E\u56DB\u548C\u738B\u4E94\u53D1\u4E86\u6D88\u606F\u540E\uFF0C\u90FD\u4F1A\u4FDD\u5B58\u5728\u81EA\u5DF1\u7684\u90AE\u7BB1\u4E2D\uFF0C\u5047\u8BBE\u8D75\u516D\u8981\u8BFB\u53D6\u4FE1\u606F\uFF0C\u90A3\u4E48\u4ED6\u4F1A\u4ECE\u8BFB\u53D6\u4ED6\u81EA\u5DF1\u7684\u6536\u4EF6\u7BB1\uFF0C\u6B64\u65F6\u7CFB\u7EDF\u4F1A\u4ECE\u4ED6\u5173\u6CE8\u7684\u4EBA\u7FA4\u4E2D\uFF0C\u628A\u4ED6\u5173\u6CE8\u4EBA\u7684\u4FE1\u606F\u5168\u90E8\u90FD\u8FDB\u884C\u62C9\u53D6\uFF0C\u7136\u540E\u5728\u8FDB\u884C\u6392\u5E8F</p><p>\u4F18\u70B9\uFF1A\u6BD4\u8F83\u8282\u7EA6\u7A7A\u95F4\uFF0C\u56E0\u4E3A\u8D75\u516D\u5728\u8BFB\u4FE1\u606F\u65F6\uFF0C\u5E76\u6CA1\u6709\u91CD\u590D\u8BFB\u53D6\uFF0C\u800C\u4E14\u8BFB\u53D6\u5B8C\u4E4B\u540E\u53EF\u4EE5\u628A\u4ED6\u7684\u6536\u4EF6\u7BB1\u8FDB\u884C\u6E05\u695A\u3002</p><p>\u7F3A\u70B9\uFF1A\u6BD4\u8F83\u5EF6\u8FDF\uFF0C\u5F53\u7528\u6237\u8BFB\u53D6\u6570\u636E\u65F6\u624D\u53BB\u5173\u6CE8\u7684\u4EBA\u91CC\u8FB9\u53BB\u8BFB\u53D6\u6570\u636E\uFF0C\u5047\u8BBE\u7528\u6237\u5173\u6CE8\u4E86\u5927\u91CF\u7684\u7528\u6237\uFF0C\u90A3\u4E48\u6B64\u65F6\u5C31\u4F1A\u62C9\u53D6\u6D77\u91CF\u7684\u5185\u5BB9\uFF0C\u5BF9\u670D\u52A1\u5668\u538B\u529B\u5DE8\u5927\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653809450816.png" alt="1653809450816"></p><p><strong>\u63A8\u6A21\u5F0F</strong>\uFF1A\u4E5F\u53EB\u505A\u5199\u6269\u6563\u3002</p><p>\u63A8\u6A21\u5F0F\u662F\u6CA1\u6709\u5199\u90AE\u7BB1\u7684\uFF0C\u5F53\u5F20\u4E09\u5199\u4E86\u4E00\u4E2A\u5185\u5BB9\uFF0C\u6B64\u65F6\u4F1A\u4E3B\u52A8\u7684\u628A\u5F20\u4E09\u5199\u7684\u5185\u5BB9\u53D1\u9001\u5230\u4ED6\u7684\u7C89\u4E1D\u6536\u4EF6\u7BB1\u4E2D\u53BB\uFF0C\u5047\u8BBE\u6B64\u65F6\u674E\u56DB\u518D\u6765\u8BFB\u53D6\uFF0C\u5C31\u4E0D\u7528\u518D\u53BB\u4E34\u65F6\u62C9\u53D6\u4E86</p><p>\u4F18\u70B9\uFF1A\u65F6\u6548\u5FEB\uFF0C\u4E0D\u7528\u4E34\u65F6\u62C9\u53D6</p><p>\u7F3A\u70B9\uFF1A\u5185\u5B58\u538B\u529B\u5927\uFF0C\u5047\u8BBE\u4E00\u4E2A\u5927V\u5199\u4FE1\u606F\uFF0C\u5F88\u591A\u4EBA\u5173\u6CE8\u4ED6\uFF0C \u5C31\u4F1A\u5199\u5F88\u591A\u5206\u6570\u636E\u5230\u7C89\u4E1D\u90A3\u8FB9\u53BB</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653809875208.png" alt="1653809875208"></p><p><strong>\u63A8\u62C9\u7ED3\u5408\u6A21\u5F0F</strong>\uFF1A\u4E5F\u53EB\u505A\u8BFB\u5199\u6DF7\u5408\uFF0C\u517C\u5177\u63A8\u548C\u62C9\u4E24\u79CD\u6A21\u5F0F\u7684\u4F18\u70B9\u3002</p><p>\u63A8\u62C9\u6A21\u5F0F\u662F\u4E00\u4E2A\u6298\u4E2D\u7684\u65B9\u6848\uFF0C\u7AD9\u5728\u53D1\u4EF6\u4EBA\u8FD9\u4E00\u6BB5\uFF0C\u5982\u679C\u662F\u4E2A\u666E\u901A\u7684\u4EBA\uFF0C\u90A3\u4E48\u6211\u4EEC\u91C7\u7528\u5199\u6269\u6563\u7684\u65B9\u5F0F\uFF0C\u76F4\u63A5\u628A\u6570\u636E\u5199\u5165\u5230\u4ED6\u7684\u7C89\u4E1D\u4E2D\u53BB\uFF0C\u56E0\u4E3A\u666E\u901A\u7684\u4EBA\u4ED6\u7684\u7C89\u4E1D\u5173\u6CE8\u91CF\u6BD4\u8F83\u5C0F\uFF0C\u6240\u4EE5\u8FD9\u6837\u505A\u6CA1\u6709\u538B\u529B\uFF0C\u5982\u679C\u662F\u5927V\uFF0C\u90A3\u4E48\u4ED6\u662F\u76F4\u63A5\u5C06\u6570\u636E\u5148\u5199\u5165\u5230\u4E00\u4EFD\u5230\u53D1\u4EF6\u7BB1\u91CC\u8FB9\u53BB\uFF0C\u7136\u540E\u518D\u76F4\u63A5\u5199\u4E00\u4EFD\u5230\u6D3B\u8DC3\u7C89\u4E1D\u6536\u4EF6\u7BB1\u91CC\u8FB9\u53BB\uFF0C\u73B0\u5728\u7AD9\u5728\u6536\u4EF6\u4EBA\u8FD9\u7AEF\u6765\u770B\uFF0C\u5982\u679C\u662F\u6D3B\u8DC3\u7C89\u4E1D\uFF0C\u90A3\u4E48\u5927V\u548C\u666E\u901A\u7684\u4EBA\u53D1\u7684\u90FD\u4F1A\u76F4\u63A5\u5199\u5165\u5230\u81EA\u5DF1\u6536\u4EF6\u7BB1\u91CC\u8FB9\u6765\uFF0C\u800C\u5982\u679C\u662F\u666E\u901A\u7684\u7C89\u4E1D\uFF0C\u7531\u4E8E\u4ED6\u4EEC\u4E0A\u7EBF\u4E0D\u662F\u5F88\u9891\u7E41\uFF0C\u6240\u4EE5\u7B49\u4ED6\u4EEC\u4E0A\u7EBF\u65F6\uFF0C\u518D\u4ECE\u53D1\u4EF6\u7BB1\u91CC\u8FB9\u53BB\u62C9\u4FE1\u606F\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653812346852.png" alt="1653812346852"></p><h3 id="_9-4-\u597D\u53CB\u5173\u6CE8-\u63A8\u9001\u5230\u7C89\u4E1D\u6536\u4EF6\u7BB1" tabindex="-1"><a class="header-anchor" href="#_9-4-\u597D\u53CB\u5173\u6CE8-\u63A8\u9001\u5230\u7C89\u4E1D\u6536\u4EF6\u7BB1" aria-hidden="true">#</a> 9.4 \u597D\u53CB\u5173\u6CE8-\u63A8\u9001\u5230\u7C89\u4E1D\u6536\u4EF6\u7BB1</h3><blockquote><p>1.\u83B7\u53D6\u7B14\u8BB0\u4F5C\u8005\u7684\u6240\u6709\u7C89\u4E1D where follow_user_id = ?</p><p>2.\u5C06\u7B14\u8BB0id\u63A8\u9001\u7ED9\u7C89\u4E1D key feed: + \u7C89\u4E1Did field blogId value \u65F6\u95F4\u6233</p></blockquote><p>\u9700\u6C42\uFF1A</p><ul><li>\u4FEE\u6539\u65B0\u589E\u63A2\u5E97\u7B14\u8BB0\u7684\u4E1A\u52A1\uFF0C\u5728\u4FDD\u5B58blog\u5230\u6570\u636E\u5E93\u7684\u540C\u65F6\uFF0C\u63A8\u9001\u5230\u7C89\u4E1D\u7684\u6536\u4EF6\u7BB1</li><li>\u6536\u4EF6\u7BB1\u6EE1\u8DB3\u53EF\u4EE5\u6839\u636E\u65F6\u95F4\u6233\u6392\u5E8F\uFF0C\u5FC5\u987B\u7528Redis\u7684\u6570\u636E\u7ED3\u6784\u5B9E\u73B0</li><li>\u67E5\u8BE2\u6536\u4EF6\u7BB1\u6570\u636E\u65F6\uFF0C\u53EF\u4EE5\u5B9E\u73B0\u5206\u9875\u67E5\u8BE2</li></ul><p>Feed\u6D41\u4E2D\u7684\u6570\u636E\u4F1A\u4E0D\u65AD\u66F4\u65B0\uFF0C\u6240\u4EE5\u6570\u636E\u7684\u89D2\u6807\u4E5F\u5728\u53D8\u5316\uFF0C\u56E0\u6B64\u4E0D\u80FD\u91C7\u7528\u4F20\u7EDF\u7684\u5206\u9875\u6A21\u5F0F\u3002</p><p>\u4F20\u7EDF\u4E86\u5206\u9875\u5728feed\u6D41\u662F\u4E0D\u9002\u7528\u7684\uFF0C\u56E0\u4E3A\u6211\u4EEC\u7684\u6570\u636E\u4F1A\u968F\u65F6\u53D1\u751F\u53D8\u5316</p><p>\u5047\u8BBE\u5728t1 \u65F6\u523B\uFF0C\u6211\u4EEC\u53BB\u8BFB\u53D6\u7B2C\u4E00\u9875\uFF0C\u6B64\u65F6page = 1 \uFF0Csize = 5 \uFF0C\u90A3\u4E48\u6211\u4EEC\u62FF\u5230\u7684\u5C31\u662F10~6 \u8FD9\u51E0\u6761\u8BB0\u5F55\uFF0C\u5047\u8BBE\u73B0\u5728t2\u65F6\u5019\u53C8\u53D1\u5E03\u4E86\u4E00\u6761\u8BB0\u5F55\uFF0C\u6B64\u65F6t3 \u65F6\u523B\uFF0C\u6211\u4EEC\u6765\u8BFB\u53D6\u7B2C\u4E8C\u9875\uFF0C\u8BFB\u53D6\u7B2C\u4E8C\u9875\u4F20\u5165\u7684\u53C2\u6570\u662Fpage=2 \uFF0Csize=5 \uFF0C\u90A3\u4E48\u6B64\u65F6\u8BFB\u53D6\u5230\u7684\u7B2C\u4E8C\u9875\u5B9E\u9645\u4E0A\u662F\u4ECE6 \u5F00\u59CB\uFF0C\u7136\u540E\u662F6~2 \uFF0C\u90A3\u4E48\u6211\u4EEC\u5C31\u8BFB\u53D6\u5230\u4E86\u91CD\u590D\u7684\u6570\u636E\uFF0C\u6240\u4EE5feed\u6D41\u7684\u5206\u9875\uFF0C\u4E0D\u80FD\u91C7\u7528\u539F\u59CB\u65B9\u6848\u6765\u505A\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653813047671.png" alt="1653813047671"></p><p>Feed\u6D41\u7684\u6EDA\u52A8\u5206\u9875</p><p>\u6211\u4EEC\u9700\u8981\u8BB0\u5F55\u6BCF\u6B21\u64CD\u4F5C\u7684\u6700\u540E\u4E00\u6761\uFF0C\u7136\u540E\u4ECE\u8FD9\u4E2A\u4F4D\u7F6E\u5F00\u59CB\u53BB\u8BFB\u53D6\u6570\u636E</p><p>\u4E3E\u4E2A\u4F8B\u5B50\uFF1A\u6211\u4EEC\u4ECEt1\u65F6\u523B\u5F00\u59CB\uFF0C\u62FF\u7B2C\u4E00\u9875\u6570\u636E\uFF0C\u62FF\u5230\u4E8610~6\uFF0C\u7136\u540E\u8BB0\u5F55\u4E0B\u5F53\u524D\u6700\u540E\u4E00\u6B21\u62FF\u53D6\u7684\u8BB0\u5F55\uFF0C\u5C31\u662F6\uFF0Ct2\u65F6\u523B\u53D1\u5E03\u4E86\u65B0\u7684\u8BB0\u5F55\uFF0C\u6B64\u65F6\u8FD9\u4E2A11\u653E\u5230\u6700\u9876\u4E0A\uFF0C\u4F46\u662F\u4E0D\u4F1A\u5F71\u54CD\u6211\u4EEC\u4E4B\u524D\u8BB0\u5F55\u76846\uFF0C\u6B64\u65F6t3\u65F6\u523B\u6765\u62FF\u7B2C\u4E8C\u9875\uFF0C\u7B2C\u4E8C\u9875\u8FD9\u4E2A\u65F6\u5019\u62FF\u6570\u636E\uFF0C\u8FD8\u662F\u4ECE6\u540E\u4E00\u70B9\u76845\u53BB\u62FF\uFF0C\u5C31\u62FF\u5230\u4E865-1\u7684\u8BB0\u5F55\u3002\u6211\u4EEC\u8FD9\u4E2A\u5730\u65B9\u53EF\u4EE5\u91C7\u7528sortedSet\u6765\u505A\uFF0C\u53EF\u4EE5\u8FDB\u884C\u8303\u56F4\u67E5\u8BE2\uFF0C\u5E76\u4E14\u8FD8\u53EF\u4EE5\u8BB0\u5F55\u5F53\u524D\u83B7\u53D6\u6570\u636E\u65F6\u95F4\u6233\u6700\u5C0F\u503C\uFF0C\u5C31\u53EF\u4EE5\u5B9E\u73B0\u6EDA\u52A8\u5206\u9875\u4E86</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653813462834.png" alt="1653813462834"></p><p>\u6838\u5FC3\u7684\u610F\u601D\uFF1A\u5C31\u662F\u6211\u4EEC\u5728\u4FDD\u5B58\u5B8C\u63A2\u5E97\u7B14\u8BB0\u540E\uFF0C\u83B7\u5F97\u5230\u5F53\u524D\u7B14\u8BB0\u7684\u7C89\u4E1D\uFF0C\u7136\u540E\u628A\u6570\u636E\u63A8\u9001\u5230\u7C89\u4E1D\u7684redis\u4E2D\u53BB\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">saveBlog</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.\u83B7\u53D6\u767B\u5F55\u7528\u6237</span>
    <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.\u4FDD\u5B58\u63A2\u5E97\u7B14\u8BB0</span>
    <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isSuccess<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;\u65B0\u589E\u7B14\u8BB0\u5931\u8D25!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.\u67E5\u8BE2\u7B14\u8BB0\u4F5C\u8005\u7684\u6240\u6709\u7C89\u4E1D select * from tb_follow where follow_user_id = ?</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">&gt;</span></span> follows <span class="token operator">=</span> followService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;follow_user_id&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.\u63A8\u9001\u7B14\u8BB0id\u7ED9\u6240\u6709\u7C89\u4E1D</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Follow</span> follow <span class="token operator">:</span> follows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 4.1.\u83B7\u53D6\u7C89\u4E1Did</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> follow<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2.\u63A8\u9001</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> FEED_KEY <span class="token operator">+</span> userId<span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 5.\u8FD4\u56DEid</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-5-\u597D\u53CB\u5173\u6CE8-\u5B9E\u73B0\u5206\u9875\u67E5\u8BE2\u6536\u90AE\u7BB1" tabindex="-1"><a class="header-anchor" href="#_9-5-\u597D\u53CB\u5173\u6CE8-\u5B9E\u73B0\u5206\u9875\u67E5\u8BE2\u6536\u90AE\u7BB1" aria-hidden="true">#</a> 9.5 \u597D\u53CB\u5173\u6CE8-\u5B9E\u73B0\u5206\u9875\u67E5\u8BE2\u6536\u90AE\u7BB1</h3><blockquote><p>\u5B9A\u4E49\u8FD4\u56DE\u7C7B ScrollResult</p><p>List&lt;?&gt; list;</p><p>Long max;</p><p>Integer offset;</p><p>\u7F16\u5199 queryBlogOfFollow(Long max, Integer offset) \u63A5\u53E3</p><p>1.\u67E5\u8BE2\u7528\u6237id</p><p>2.\u67E5\u8BE2\u90AE\u7BB1</p><p>3.\u89E3\u6790\u6570\u636E blogId,minTime,offset</p><p>4.\u6839\u636E ids \u67E5\u8BE2\u7B14\u8BB0\uFF0C\u4F7F\u7528 order by field \u4FDD\u8BC1\u987A\u5E8F</p><p>5.\u5C01\u88C5\u5E76\u8FD4\u56DE\u6570\u636E</p></blockquote><p>\u9700\u6C42\uFF1A\u5728\u4E2A\u4EBA\u4E3B\u9875\u7684\u201C\u5173\u6CE8\u201D\u5361\u7247\u4E2D\uFF0C\u67E5\u8BE2\u5E76\u5C55\u793A\u63A8\u9001\u7684Blog\u4FE1\u606F\uFF1A</p><p>\u5177\u4F53\u64CD\u4F5C\u5982\u4E0B\uFF1A</p><p>1\u3001\u6BCF\u6B21\u67E5\u8BE2\u5B8C\u6210\u540E\uFF0C\u6211\u4EEC\u8981\u5206\u6790\u51FA\u67E5\u8BE2\u51FA\u6570\u636E\u7684\u6700\u5C0F\u65F6\u95F4\u6233\uFF0C\u8FD9\u4E2A\u503C\u4F1A\u4F5C\u4E3A\u4E0B\u4E00\u6B21\u67E5\u8BE2\u7684\u6761\u4EF6</p><p>2\u3001\u6211\u4EEC\u9700\u8981\u627E\u5230\u4E0E\u4E0A\u4E00\u6B21\u67E5\u8BE2\u76F8\u540C\u7684\u67E5\u8BE2\u4E2A\u6570\u4F5C\u4E3A\u504F\u79FB\u91CF\uFF0C\u4E0B\u6B21\u67E5\u8BE2\u65F6\uFF0C\u8DF3\u8FC7\u8FD9\u4E9B\u67E5\u8BE2\u8FC7\u7684\u6570\u636E\uFF0C\u62FF\u5230\u6211\u4EEC\u9700\u8981\u7684\u6570\u636E</p><p>\u7EFC\u4E0A\uFF1A\u6211\u4EEC\u7684\u8BF7\u6C42\u53C2\u6570\u4E2D\u5C31\u9700\u8981\u643A\u5E26 lastId\uFF1A\u4E0A\u4E00\u6B21\u67E5\u8BE2\u7684\u6700\u5C0F\u65F6\u95F4\u6233 \u548C\u504F\u79FB\u91CF\u8FD9\u4E24\u4E2A\u53C2\u6570\u3002</p><p>\u8FD9\u4E24\u4E2A\u53C2\u6570\u7B2C\u4E00\u6B21\u4F1A\u7531\u524D\u7AEF\u6765\u6307\u5B9A\uFF0C\u4EE5\u540E\u7684\u67E5\u8BE2\u5C31\u6839\u636E\u540E\u53F0\u7ED3\u679C\u4F5C\u4E3A\u6761\u4EF6\uFF0C\u518D\u6B21\u4F20\u9012\u5230\u540E\u53F0\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220802170249895.png" alt="image-20220802170249895"></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653819821591.png" alt="1653819821591"></p><p>\u4E00\u3001\u5B9A\u4E49\u51FA\u6765\u5177\u4F53\u7684\u8FD4\u56DE\u503C\u5B9E\u4F53\u7C7B</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScrollResult</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> minTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>BlogController</p><p>\u6CE8\u610F\uFF1ARequestParam \u8868\u793A\u63A5\u53D7url\u5730\u5740\u680F\u4F20\u53C2\u7684\u6CE8\u89E3\uFF0C\u5F53\u65B9\u6CD5\u4E0A\u53C2\u6570\u7684\u540D\u79F0\u548Curl\u5730\u5740\u680F\u4E0D\u76F8\u540C\u65F6\uFF0C\u53EF\u4EE5\u901A\u8FC7RequestParam \u6765\u8FDB\u884C\u6307\u5B9A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/of/follow&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogOfFollow</span><span class="token punctuation">(</span>
    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;lastId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> max<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;offset&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> offset<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> blogService<span class="token punctuation">.</span><span class="token function">queryBlogOfFollow</span><span class="token punctuation">(</span>max<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>BlogServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogOfFollow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> max<span class="token punctuation">,</span> <span class="token class-name">Integer</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.\u83B7\u53D6\u5F53\u524D\u7528\u6237</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.\u67E5\u8BE2\u6536\u4EF6\u7BB1 ZREVRANGEBYSCORE key Max Min LIMIT offset count</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> FEED_KEY <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typedTuples <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">reverseRangeByScoreWithScores</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.\u975E\u7A7A\u5224\u65AD</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>typedTuples <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> typedTuples<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.\u89E3\u6790\u6570\u636E\uFF1AblogId\u3001minTime\uFF08\u65F6\u95F4\u6233\uFF09\u3001offset</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>typedTuples<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> minTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    <span class="token keyword">int</span> os <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tuple <span class="token operator">:</span> typedTuples<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 5 4 4 2 2</span>
        <span class="token comment">// 4.1.\u83B7\u53D6id</span>
        ids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2.\u83B7\u53D6\u5206\u6570(\u65F6\u95F4\u6233\uFF09</span>
        <span class="token keyword">long</span> time <span class="token operator">=</span> tuple<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>time <span class="token operator">==</span> minTime<span class="token punctuation">)</span><span class="token punctuation">{</span>
            os<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            minTime <span class="token operator">=</span> time<span class="token punctuation">;</span>
            os <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">;</span>
    <span class="token comment">// 5.\u6839\u636Eid\u67E5\u8BE2blog</span>
    <span class="token class-name">String</span> idStr <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> blogs <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER BY FIELD(id,&quot;</span> <span class="token operator">+</span> idStr <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Blog</span> blog <span class="token operator">:</span> blogs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 5.1.\u67E5\u8BE2blog\u6709\u5173\u7684\u7528\u6237</span>
        <span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.2.\u67E5\u8BE2blog\u662F\u5426\u88AB\u70B9\u8D5E</span>
        <span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 6.\u5C01\u88C5\u5E76\u8FD4\u56DE</span>
    <span class="token class-name">ScrollResult</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScrollResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span><span class="token function">setList</span><span class="token punctuation">(</span>blogs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span><span class="token function">setOffset</span><span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span><span class="token function">setMinTime</span><span class="token punctuation">(</span>minTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10\u3001\u9644\u8FD1\u5546\u6237" tabindex="-1"><a class="header-anchor" href="#_10\u3001\u9644\u8FD1\u5546\u6237" aria-hidden="true">#</a> 10\u3001\u9644\u8FD1\u5546\u6237</h2><h3 id="_10-1\u3001\u9644\u8FD1\u5546\u6237-geo\u6570\u636E\u7ED3\u6784\u7684\u57FA\u672C\u7528\u6CD5" tabindex="-1"><a class="header-anchor" href="#_10-1\u3001\u9644\u8FD1\u5546\u6237-geo\u6570\u636E\u7ED3\u6784\u7684\u57FA\u672C\u7528\u6CD5" aria-hidden="true">#</a> 10.1\u3001\u9644\u8FD1\u5546\u6237-GEO\u6570\u636E\u7ED3\u6784\u7684\u57FA\u672C\u7528\u6CD5</h3><p>GEO\u5C31\u662FGeolocation\u7684\u7B80\u5199\u5F62\u5F0F\uFF0C\u4EE3\u8868\u5730\u7406\u5750\u6807\u3002Redis\u57283.2\u7248\u672C\u4E2D\u52A0\u5165\u4E86\u5BF9GEO\u7684\u652F\u6301\uFF0C\u5141\u8BB8\u5B58\u50A8\u5730\u7406\u5750\u6807\u4FE1\u606F\uFF0C\u5E2E\u52A9\u6211\u4EEC\u6839\u636E\u7ECF\u7EAC\u5EA6\u6765\u68C0\u7D22\u6570\u636E\u3002\u5E38\u89C1\u7684\u547D\u4EE4\u6709\uFF1A</p><ul><li>GEOADD\uFF1A\u6DFB\u52A0\u4E00\u4E2A\u5730\u7406\u7A7A\u95F4\u4FE1\u606F\uFF0C\u5305\u542B\uFF1A\u7ECF\u5EA6\uFF08longitude\uFF09\u3001\u7EAC\u5EA6\uFF08latitude\uFF09\u3001\u503C\uFF08member\uFF09</li><li>GEODIST\uFF1A\u8BA1\u7B97\u6307\u5B9A\u7684\u4E24\u4E2A\u70B9\u4E4B\u95F4\u7684\u8DDD\u79BB\u5E76\u8FD4\u56DE</li><li>GEOHASH\uFF1A\u5C06\u6307\u5B9Amember\u7684\u5750\u6807\u8F6C\u4E3Ahash\u5B57\u7B26\u4E32\u5F62\u5F0F\u5E76\u8FD4\u56DE</li><li>GEOPOS\uFF1A\u8FD4\u56DE\u6307\u5B9Amember\u7684\u5750\u6807</li><li>GEORADIUS\uFF1A\u6307\u5B9A\u5706\u5FC3\u3001\u534A\u5F84\uFF0C\u627E\u5230\u8BE5\u5706\u5185\u5305\u542B\u7684\u6240\u6709member\uFF0C\u5E76\u6309\u7167\u4E0E\u5706\u5FC3\u4E4B\u95F4\u7684\u8DDD\u79BB\u6392\u5E8F\u540E\u8FD4\u56DE\u30026.\u4EE5\u540E\u5DF2\u5E9F\u5F03</li><li>GEOSEARCH\uFF1A\u5728\u6307\u5B9A\u8303\u56F4\u5185\u641C\u7D22member\uFF0C\u5E76\u6309\u7167\u4E0E\u6307\u5B9A\u70B9\u4E4B\u95F4\u7684\u8DDD\u79BB\u6392\u5E8F\u540E\u8FD4\u56DE\u3002\u8303\u56F4\u53EF\u4EE5\u662F\u5706\u5F62\u6216\u77E9\u5F62\u30026.2.\u65B0\u529F\u80FD</li><li>GEOSEARCHSTORE\uFF1A\u4E0EGEOSEARCH\u529F\u80FD\u4E00\u81F4\uFF0C\u4E0D\u8FC7\u53EF\u4EE5\u628A\u7ED3\u679C\u5B58\u50A8\u5230\u4E00\u4E2A\u6307\u5B9A\u7684key\u3002 6.2.\u65B0\u529F\u80FD</li></ul><h3 id="_10-2\u3001-\u9644\u8FD1\u5546\u6237-\u5BFC\u5165\u5E97\u94FA\u6570\u636E\u5230geo" tabindex="-1"><a class="header-anchor" href="#_10-2\u3001-\u9644\u8FD1\u5546\u6237-\u5BFC\u5165\u5E97\u94FA\u6570\u636E\u5230geo" aria-hidden="true">#</a> 10.2\u3001 \u9644\u8FD1\u5546\u6237-\u5BFC\u5165\u5E97\u94FA\u6570\u636E\u5230GEO</h3><blockquote><p>redis zset \u4E2D key\u4E3A shop:gep: + shopType\uFF0Cvalue\u4E3A \u5546\u6237id\uFF0Cscore\u4E3A \u7ECF\u7EAC\u5EA6</p><p>1.\u67E5\u8BE2\u6240\u4EE5\u7684\u5E97\u94FA\u4FE1\u606F</p><p>2.\u6309\u7167 shopType \u8FDB\u884C\u5206\u7EC4</p><p>3.\u5B58\u5165 redis zset \u4E2D</p></blockquote><p>\u5177\u4F53\u573A\u666F\u8BF4\u660E\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653822036941.png" alt="1653822036941"></p><p>\u5F53\u6211\u4EEC\u70B9\u51FB\u7F8E\u98DF\u4E4B\u540E\uFF0C\u4F1A\u51FA\u73B0\u4E00\u7CFB\u5217\u7684\u5546\u5BB6\uFF0C\u5546\u5BB6\u4E2D\u53EF\u4EE5\u6309\u7167\u591A\u79CD\u6392\u5E8F\u65B9\u5F0F\uFF0C\u6211\u4EEC\u6B64\u65F6\u5173\u6CE8\u7684\u662F\u8DDD\u79BB\uFF0C\u8FD9\u4E2A\u5730\u65B9\u5C31\u9700\u8981\u4F7F\u7528\u5230\u6211\u4EEC\u7684GEO\uFF0C\u5411\u540E\u53F0\u4F20\u5165\u5F53\u524Dapp\u6536\u96C6\u7684\u5730\u5740(\u6211\u4EEC\u6B64\u5904\u662F\u5199\u6B7B\u7684) \uFF0C\u4EE5\u5F53\u524D\u5750\u6807\u4F5C\u4E3A\u5706\u5FC3\uFF0C\u540C\u65F6\u7ED1\u5B9A\u76F8\u540C\u7684\u5E97\u5BB6\u7C7B\u578Btype\uFF0C\u4EE5\u53CA\u5206\u9875\u4FE1\u606F\uFF0C\u628A\u8FD9\u51E0\u4E2A\u6761\u4EF6\u4F20\u5165\u540E\u53F0\uFF0C\u540E\u53F0\u67E5\u8BE2\u51FA\u5BF9\u5E94\u7684\u6570\u636E\u518D\u8FD4\u56DE\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653822021827.png" alt="1653822021827"></p><p>\u6211\u4EEC\u8981\u505A\u7684\u4E8B\u60C5\u662F\uFF1A\u5C06\u6570\u636E\u5E93\u8868\u4E2D\u7684\u6570\u636E\u5BFC\u5165\u5230redis\u4E2D\u53BB\uFF0Credis\u4E2D\u7684GEO\uFF0CGEO\u5728redis\u4E2D\u5C31\u4E00\u4E2Amenber\u548C\u4E00\u4E2A\u7ECF\u7EAC\u5EA6\uFF0C\u6211\u4EEC\u628Ax\u548Cy\u8F74\u4F20\u5165\u5230redis\u505A\u7684\u7ECF\u7EAC\u5EA6\u4F4D\u7F6E\u53BB\uFF0C\u4F46\u6211\u4EEC\u4E0D\u80FD\u628A\u6240\u6709\u7684\u6570\u636E\u90FD\u653E\u5165\u5230member\u4E2D\u53BB\uFF0C\u6BD5\u7ADF\u4F5C\u4E3Aredis\u662F\u4E00\u4E2A\u5185\u5B58\u7EA7\u6570\u636E\u5E93\uFF0C\u5982\u679C\u5B58\u6D77\u91CF\u6570\u636E\uFF0Credis\u8FD8\u662F\u529B\u4E0D\u4ECE\u5FC3\uFF0C\u6240\u4EE5\u6211\u4EEC\u5728\u8FD9\u4E2A\u5730\u65B9\u5B58\u50A8\u4ED6\u7684id\u5373\u53EF\u3002</p><p>\u4F46\u662F\u8FD9\u4E2A\u65F6\u5019\u8FD8\u6709\u4E00\u4E2A\u95EE\u9898\uFF0C\u5C31\u662F\u5728redis\u4E2D\u5E76\u6CA1\u6709\u5B58\u50A8type\uFF0C\u6240\u4EE5\u6211\u4EEC\u65E0\u6CD5\u6839\u636Etype\u6765\u5BF9\u6570\u636E\u8FDB\u884C\u7B5B\u9009\uFF0C\u6240\u4EE5\u6211\u4EEC\u53EF\u4EE5\u6309\u7167\u5546\u6237\u7C7B\u578B\u505A\u5206\u7EC4\uFF0C\u7C7B\u578B\u76F8\u540C\u7684\u5546\u6237\u4F5C\u4E3A\u540C\u4E00\u7EC4\uFF0C\u4EE5typeId\u4E3Akey\u5B58\u5165\u540C\u4E00\u4E2AGEO\u96C6\u5408\u4E2D\u5373\u53EF</p><p>\u4EE3\u7801</p><p>HmDianPingApplicationTests</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">loadShopData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.\u67E5\u8BE2\u5E97\u94FA\u4FE1\u606F</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> shopService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.\u628A\u5E97\u94FA\u5206\u7EC4\uFF0C\u6309\u7167typeId\u5206\u7EC4\uFF0CtypeId\u4E00\u81F4\u7684\u653E\u5230\u4E00\u4E2A\u96C6\u5408</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span><span class="token class-name">Shop</span><span class="token operator">::</span><span class="token function">getTypeId</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.\u5206\u6279\u5B8C\u6210\u5199\u5165Redis</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.1.\u83B7\u53D6\u7C7B\u578Bid</span>
        <span class="token class-name">Long</span> typeId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> SHOP_GEO_KEY <span class="token operator">+</span> typeId<span class="token punctuation">;</span>
        <span class="token comment">// 3.2.\u83B7\u53D6\u540C\u7C7B\u578B\u7684\u5E97\u94FA\u7684\u96C6\u5408</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> value <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> locations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.3.\u5199\u5165redis GEOADD key \u7ECF\u5EA6 \u7EAC\u5EA6 member</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span> shop <span class="token operator">:</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span>
            locations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                    shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>shop<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> locations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-3-\u9644\u8FD1\u5546\u6237-\u5B9E\u73B0\u9644\u8FD1\u5546\u6237\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_10-3-\u9644\u8FD1\u5546\u6237-\u5B9E\u73B0\u9644\u8FD1\u5546\u6237\u529F\u80FD" aria-hidden="true">#</a> 10.3 \u9644\u8FD1\u5546\u6237-\u5B9E\u73B0\u9644\u8FD1\u5546\u6237\u529F\u80FD</h3><blockquote><p>1.\u5224\u65AD\u662F\u5426\u8981\u6839\u636E\u5750\u6807\u6765\u67E5\u8BE2</p><p>2.\u8BA1\u7B97\u5206\u9875\u53C2\u6570 from end</p><p>3.\u4ECE redis \u4E2D\u67E5\u6570\u636E\uFF0C\u5206\u9875 GEOSEARCH key FROMLONLAT x y BYRADIUS 5000 WITHDIST</p><p>4.\u89E3\u6790\u51FA shopId,distance</p><p>5.\u6839\u636E shopId \u67E5 shop \u4FE1\u606F</p><p>6.\u5C01\u88C5 distance</p><p>7.\u8FD4\u56DE\u6570\u636E</p></blockquote><p>SpringDataRedis\u76842.3.9\u7248\u672C\u5E76\u4E0D\u652F\u6301Redis 6.2\u63D0\u4F9B\u7684GEOSEARCH\u547D\u4EE4\uFF0C\u56E0\u6B64\u6211\u4EEC\u9700\u8981\u63D0\u793A\u5176\u7248\u672C\uFF0C\u4FEE\u6539\u81EA\u5DF1\u7684POM</p><p>\u7B2C\u4E00\u6B65\uFF1A\u5BFC\u5165pom</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.data<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.data<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>6.1.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7B2C\u4E8C\u6B65\uFF1A</p><p>ShopController</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/of/type&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryShopByType</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;typeId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> typeId<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;current&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> current<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> x<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> y
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> shopService<span class="token punctuation">.</span><span class="token function">queryShopByType</span><span class="token punctuation">(</span>typeId<span class="token punctuation">,</span> current<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ShopServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryShopByType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> typeId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> current<span class="token punctuation">,</span> <span class="token class-name">Double</span> x<span class="token punctuation">,</span> <span class="token class-name">Double</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.\u5224\u65AD\u662F\u5426\u9700\u8981\u6839\u636E\u5750\u6807\u67E5\u8BE2</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> y <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u4E0D\u9700\u8981\u5750\u6807\u67E5\u8BE2\uFF0C\u6309\u6570\u636E\u5E93\u67E5\u8BE2</span>
            <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;type_id&quot;</span><span class="token punctuation">,</span> typeId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>DEFAULT_PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u8FD4\u56DE\u6570\u636E</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2.\u8BA1\u7B97\u5206\u9875\u53C2\u6570</span>
        <span class="token keyword">int</span> from <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>DEFAULT_PAGE_SIZE<span class="token punctuation">;</span>
        <span class="token keyword">int</span> end <span class="token operator">=</span> current <span class="token operator">*</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>DEFAULT_PAGE_SIZE<span class="token punctuation">;</span>

        <span class="token comment">// 3.\u67E5\u8BE2redis\u3001\u6309\u7167\u8DDD\u79BB\u6392\u5E8F\u3001\u5206\u9875\u3002\u7ED3\u679C\uFF1AshopId\u3001distance</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> SHOP_GEO_KEY <span class="token operator">+</span> typeId<span class="token punctuation">;</span>
        <span class="token class-name">GeoResults</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE</span>
                <span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>
                        key<span class="token punctuation">,</span>
                        <span class="token class-name">GeoReference</span><span class="token punctuation">.</span><span class="token function">fromCoordinate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Distance</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoSearchCommandArgs</span><span class="token punctuation">.</span><span class="token function">newGeoSearchArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includeDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.\u89E3\u6790\u51FAid</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>results <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GeoResult</span><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u6CA1\u6709\u4E0B\u4E00\u9875\u4E86\uFF0C\u7ED3\u675F</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.1.\u622A\u53D6 from ~ end\u7684\u90E8\u5206</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Distance</span><span class="token punctuation">&gt;</span></span> distanceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.2.\u83B7\u53D6\u5E97\u94FAid</span>
            <span class="token class-name">String</span> shopIdStr <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>shopIdStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4.3.\u83B7\u53D6\u8DDD\u79BB</span>
            <span class="token class-name">Distance</span> distance <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            distanceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>shopIdStr<span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.\u6839\u636Eid\u67E5\u8BE2Shop</span>
        <span class="token class-name">String</span> idStr <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> shops <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER BY FIELD(id,&quot;</span> <span class="token operator">+</span> idStr <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span> shop <span class="token operator">:</span> shops<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            shop<span class="token punctuation">.</span><span class="token function">setDistance</span><span class="token punctuation">(</span>distanceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 6.\u8FD4\u56DE</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11\u3001\u7528\u6237\u7B7E\u5230" tabindex="-1"><a class="header-anchor" href="#_11\u3001\u7528\u6237\u7B7E\u5230" aria-hidden="true">#</a> 11\u3001\u7528\u6237\u7B7E\u5230</h2><h4 id="_11-1\u3001\u7528\u6237\u7B7E\u5230-bitmap\u529F\u80FD\u6F14\u793A" tabindex="-1"><a class="header-anchor" href="#_11-1\u3001\u7528\u6237\u7B7E\u5230-bitmap\u529F\u80FD\u6F14\u793A" aria-hidden="true">#</a> 11.1\u3001\u7528\u6237\u7B7E\u5230-BitMap\u529F\u80FD\u6F14\u793A</h4><p>\u6211\u4EEC\u9488\u5BF9\u7B7E\u5230\u529F\u80FD\u5B8C\u5168\u53EF\u4EE5\u901A\u8FC7mysql\u6765\u5B8C\u6210\uFF0C\u6BD4\u5982\u8BF4\u4EE5\u4E0B\u8FD9\u5F20\u8868</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653823145495.png" alt="1653823145495"></p><p>\u7528\u6237\u4E00\u6B21\u7B7E\u5230\uFF0C\u5C31\u662F\u4E00\u6761\u8BB0\u5F55\uFF0C\u5047\u5982\u67091000\u4E07\u7528\u6237\uFF0C\u5E73\u5747\u6BCF\u4EBA\u6BCF\u5E74\u7B7E\u5230\u6B21\u6570\u4E3A10\u6B21\uFF0C\u5219\u8FD9\u5F20\u8868\u4E00\u5E74\u7684\u6570\u636E\u91CF\u4E3A 1\u4EBF\u6761</p><p>\u6BCF\u7B7E\u5230\u4E00\u6B21\u9700\u8981\u4F7F\u7528\uFF088 + 8 + 1 + 1 + 3 + 1\uFF09\u517122 \u5B57\u8282\u7684\u5185\u5B58\uFF0C\u4E00\u4E2A\u6708\u5219\u6700\u591A\u9700\u8981600\u591A\u5B57\u8282</p><p>\u6211\u4EEC\u5982\u4F55\u80FD\u591F\u7B80\u5316\u4E00\u70B9\u5462\uFF1F\u5176\u5B9E\u53EF\u4EE5\u8003\u8651\u5C0F\u65F6\u5019\u4E00\u4E2A\u633A\u5E38\u89C1\u7684\u65B9\u6848\uFF0C\u5C31\u662F\u5C0F\u65F6\u5019\uFF0C\u54B1\u4EEC\u51C6\u5907\u4E00\u5F20\u5C0F\u5C0F\u7684\u5361\u7247\uFF0C\u4F60\u53EA\u8981\u7B7E\u5230\u5C31\u6253\u4E0A\u4E00\u4E2A\u52FE\uFF0C\u6211\u6700\u540E\u5224\u65AD\u4F60\u662F\u5426\u7B7E\u5230\uFF0C\u5176\u5B9E\u53EA\u9700\u8981\u5230\u5C0F\u5361\u7247\u4E0A\u770B\u4E00\u770B\u5C31\u77E5\u9053\u4E86</p><p>\u6211\u4EEC\u53EF\u4EE5\u91C7\u7528\u7C7B\u4F3C\u8FD9\u6837\u7684\u65B9\u6848\u6765\u5B9E\u73B0\u6211\u4EEC\u7684\u7B7E\u5230\u9700\u6C42\u3002</p><p>\u6211\u4EEC\u6309\u6708\u6765\u7EDF\u8BA1\u7528\u6237\u7B7E\u5230\u4FE1\u606F\uFF0C\u7B7E\u5230\u8BB0\u5F55\u4E3A1\uFF0C\u672A\u7B7E\u5230\u5219\u8BB0\u5F55\u4E3A0.</p><p>\u628A\u6BCF\u4E00\u4E2Abit\u4F4D\u5BF9\u5E94\u5F53\u6708\u7684\u6BCF\u4E00\u5929\uFF0C\u5F62\u6210\u4E86\u6620\u5C04\u5173\u7CFB\u3002\u75280\u548C1\u6807\u793A\u4E1A\u52A1\u72B6\u6001\uFF0C\u8FD9\u79CD\u601D\u8DEF\u5C31\u79F0\u4E3A\u4F4D\u56FE\uFF08BitMap\uFF09\u3002\u8FD9\u6837\u6211\u4EEC\u5C31\u7528\u6781\u5C0F\u7684\u7A7A\u95F4\uFF0C\u6765\u5B9E\u73B0\u4E86\u5927\u91CF\u6570\u636E\u7684\u8868\u793A</p><p>Redis\u4E2D\u662F\u5229\u7528string\u7C7B\u578B\u6570\u636E\u7ED3\u6784\u5B9E\u73B0BitMap\uFF0C\u56E0\u6B64\u6700\u5927\u4E0A\u9650\u662F512M\uFF0C\u8F6C\u6362\u4E3Abit\u5219\u662F 2^32\u4E2Abit\u4F4D\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653824498278.png" alt="1653824498278"></p><p>BitMap\u7684\u64CD\u4F5C\u547D\u4EE4\u6709\uFF1A</p><ul><li>SETBIT\uFF1A\u5411\u6307\u5B9A\u4F4D\u7F6E\uFF08offset\uFF09\u5B58\u5165\u4E00\u4E2A0\u62161</li><li>GETBIT \uFF1A\u83B7\u53D6\u6307\u5B9A\u4F4D\u7F6E\uFF08offset\uFF09\u7684bit\u503C</li><li>BITCOUNT \uFF1A\u7EDF\u8BA1BitMap\u4E2D\u503C\u4E3A1\u7684bit\u4F4D\u7684\u6570\u91CF</li><li>BITFIELD \uFF1A\u64CD\u4F5C\uFF08\u67E5\u8BE2\u3001\u4FEE\u6539\u3001\u81EA\u589E\uFF09BitMap\u4E2Dbit\u6570\u7EC4\u4E2D\u7684\u6307\u5B9A\u4F4D\u7F6E\uFF08offset\uFF09\u7684\u503C</li><li>BITFIELD_RO \uFF1A\u83B7\u53D6BitMap\u4E2Dbit\u6570\u7EC4\uFF0C\u5E76\u4EE5\u5341\u8FDB\u5236\u5F62\u5F0F\u8FD4\u56DE</li><li>BITOP \uFF1A\u5C06\u591A\u4E2ABitMap\u7684\u7ED3\u679C\u505A\u4F4D\u8FD0\u7B97\uFF08\u4E0E \u3001\u6216\u3001\u5F02\u6216\uFF09</li><li>BITPOS \uFF1A\u67E5\u627Ebit\u6570\u7EC4\u4E2D\u6307\u5B9A\u8303\u56F4\u5185\u7B2C\u4E00\u4E2A0\u62161\u51FA\u73B0\u7684\u4F4D\u7F6E</li></ul><h4 id="_11-2-\u3001\u7528\u6237\u7B7E\u5230-\u5B9E\u73B0\u7B7E\u5230\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_11-2-\u3001\u7528\u6237\u7B7E\u5230-\u5B9E\u73B0\u7B7E\u5230\u529F\u80FD" aria-hidden="true">#</a> 11.2 \u3001\u7528\u6237\u7B7E\u5230-\u5B9E\u73B0\u7B7E\u5230\u529F\u80FD</h4><blockquote><p>1.\u83B7\u53D6\u5F53\u524D\u7528\u6237</p><p>2.\u83B7\u53D6\u5F53\u524D\u65E5\u671F</p><p>3.\u62FC\u63A5 key sign:userId:date</p><p>4.\u83B7\u53D6\u4ECA\u5929\u662F\u8FD9\u4E2A\u6708\u7684\u7B2C\u51E0\u5929 offset</p><p>5.\u5199\u5165 redis SETBIT key offset 1/0</p></blockquote><p>\u9700\u6C42\uFF1A\u5B9E\u73B0\u7B7E\u5230\u63A5\u53E3\uFF0C\u5C06\u5F53\u524D\u7528\u6237\u5F53\u5929\u7B7E\u5230\u4FE1\u606F\u4FDD\u5B58\u5230Redis\u4E2D</p><p>\u601D\u8DEF\uFF1A\u6211\u4EEC\u53EF\u4EE5\u628A\u5E74\u548C\u6708\u4F5C\u4E3AbitMap\u7684key\uFF0C\u7136\u540E\u4FDD\u5B58\u5230\u4E00\u4E2AbitMap\u4E2D\uFF0C\u6BCF\u6B21\u7B7E\u5230\u5C31\u5230\u5BF9\u5E94\u7684\u4F4D\u4E0A\u628A\u6570\u5B57\u4ECE0\u53D8\u62101\uFF0C\u53EA\u8981\u5BF9\u5E94\u662F1\uFF0C\u5C31\u8868\u660E\u8BF4\u660E\u8FD9\u4E00\u5929\u5DF2\u7ECF\u7B7E\u5230\u4E86\uFF0C\u53CD\u4E4B\u5219\u6CA1\u6709\u7B7E\u5230\u3002</p><p>\u6211\u4EEC\u901A\u8FC7\u63A5\u53E3\u6587\u6863\u53D1\u73B0\uFF0C\u6B64\u63A5\u53E3\u5E76\u6CA1\u6709\u4F20\u9012\u4EFB\u4F55\u7684\u53C2\u6570\uFF0C\u6CA1\u6709\u53C2\u6570\u600E\u4E48\u786E\u5B9E\u662F\u54EA\u4E00\u5929\u7B7E\u5230\u5462\uFF1F\u8FD9\u4E2A\u5F88\u5BB9\u6613\uFF0C\u53EF\u4EE5\u901A\u8FC7\u540E\u53F0\u4EE3\u7801\u76F4\u63A5\u83B7\u53D6\u5373\u53EF\uFF0C\u7136\u540E\u5230\u5BF9\u5E94\u7684\u5730\u5740\u4E0A\u53BB\u4FEE\u6539bitMap\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653833970361.png" alt="1653833970361"></p><p><strong>\u4EE3\u7801</strong></p><p>UserController</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sign&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>UserServiceImpl</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.\u83B7\u53D6\u5F53\u524D\u767B\u5F55\u7528\u6237</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.\u83B7\u53D6\u65E5\u671F</span>
    <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.\u62FC\u63A5key</span>
    <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;:yyyyMM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> USER_SIGN_KEY <span class="token operator">+</span> userId <span class="token operator">+</span> keySuffix<span class="token punctuation">;</span>
    <span class="token comment">// 4.\u83B7\u53D6\u4ECA\u5929\u662F\u672C\u6708\u7684\u7B2C\u51E0\u5929</span>
    <span class="token keyword">int</span> dayOfMonth <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getDayOfMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.\u5199\u5165Redis SETBIT key offset 1</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dayOfMonth <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_11-3-\u7528\u6237\u7B7E\u5230-\u7B7E\u5230\u7EDF\u8BA1" tabindex="-1"><a class="header-anchor" href="#_11-3-\u7528\u6237\u7B7E\u5230-\u7B7E\u5230\u7EDF\u8BA1" aria-hidden="true">#</a> 11.3 \u7528\u6237\u7B7E\u5230-\u7B7E\u5230\u7EDF\u8BA1</h4><blockquote><p>1.\u5F97\u5230\u5230\u4ECA\u5929\u4E3A\u6B62\u7684\u6240\u6709\u7B7E\u5230\u8BB0\u5F55 BITFIELD sign:10122208 GET u3 0\uFF0C\u8FD4\u56DE\u7684\u662F\u4E00\u4E2A\u5341\u8FDB\u5236\u6570\u5B57</p><p>2.\u904D\u5386\u8FD9\u4E2A\u6570\u5B57</p><p>2.1 \u6700\u540E\u4E00\u4F4D \u8DDF 1 \u8FDB\u884C\u4E0E\u8FD0\u7B97</p><p>2.2 \u82E5\u4E3A0\uFF0C\u7ED3\u675F\u5FAA\u574F</p><p>2.3 \u82E5\u4E3A1\uFF0C\u8BA1\u6570\u5668\u52A01</p><p>2.4 num \u65E0\u7B26\u53F7\u53F3\u79FB\u4EE5\u4E00\u4F4D</p><p>3.\u8FD4\u56DE\u7ED3\u679C</p></blockquote><p>**\u95EE\u98981\uFF1A**\u4EC0\u4E48\u53EB\u505A\u8FDE\u7EED\u7B7E\u5230\u5929\u6570\uFF1F \u4ECE\u6700\u540E\u4E00\u6B21\u7B7E\u5230\u5F00\u59CB\u5411\u524D\u7EDF\u8BA1\uFF0C\u76F4\u5230\u9047\u5230\u7B2C\u4E00\u6B21\u672A\u7B7E\u5230\u4E3A\u6B62\uFF0C\u8BA1\u7B97\u603B\u7684\u7B7E\u5230\u6B21\u6570\uFF0C\u5C31\u662F\u8FDE\u7EED\u7B7E\u5230\u5929\u6570\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653834455899.png" alt="1653834455899"></p><p>Java\u903B\u8F91\u4EE3\u7801\uFF1A\u83B7\u5F97\u5F53\u524D\u8FD9\u4E2A\u6708\u7684\u6700\u540E\u4E00\u6B21\u7B7E\u5230\u6570\u636E\uFF0C\u5B9A\u4E49\u4E00\u4E2A\u8BA1\u6570\u5668\uFF0C\u7136\u540E\u4E0D\u505C\u7684\u5411\u524D\u7EDF\u8BA1\uFF0C\u76F4\u5230\u83B7\u5F97\u7B2C\u4E00\u4E2A\u975E0\u7684\u6570\u5B57\u5373\u53EF\uFF0C\u6BCF\u5F97\u5230\u4E00\u4E2A\u975E0\u7684\u6570\u5B57\u8BA1\u6570\u5668+1\uFF0C\u76F4\u5230\u904D\u5386\u5B8C\u6240\u6709\u7684\u6570\u636E\uFF0C\u5C31\u53EF\u4EE5\u83B7\u5F97\u5F53\u524D\u6708\u7684\u7B7E\u5230\u603B\u5929\u6570\u4E86</p><p>**\u95EE\u98982\uFF1A**\u5982\u4F55\u5F97\u5230\u672C\u6708\u5230\u4ECA\u5929\u4E3A\u6B62\u7684\u6240\u6709\u7B7E\u5230\u6570\u636E\uFF1F</p><p>BITFIELD key GET u[dayOfMonth] 0</p><p>\u5047\u8BBE\u4ECA\u5929\u662F10\u53F7\uFF0C\u90A3\u4E48\u6211\u4EEC\u5C31\u53EF\u4EE5\u4ECE\u5F53\u524D\u6708\u7684\u7B2C\u4E00\u5929\u5F00\u59CB\uFF0C\u83B7\u5F97\u5230\u5F53\u524D\u8FD9\u4E00\u5929\u7684\u4F4D\u6570\uFF0C\u662F10\u53F7\uFF0C\u90A3\u4E48\u5C31\u662F10\u4F4D\uFF0C\u53BB\u62FF\u8FD9\u6BB5\u65F6\u95F4\u7684\u6570\u636E\uFF0C\u5C31\u80FD\u62FF\u5230\u6240\u6709\u7684\u6570\u636E\u4E86\uFF0C\u90A3\u4E48\u8FD910\u5929\u91CC\u8FB9\u7B7E\u5230\u4E86\u591A\u5C11\u6B21\u5462\uFF1F\u7EDF\u8BA1\u6709\u591A\u5C11\u4E2A1\u5373\u53EF\u3002</p><p><strong>\u95EE\u98983\uFF1A\u5982\u4F55\u4ECE\u540E\u5411\u524D\u904D\u5386\u6BCF\u4E2Abit\u4F4D\uFF1F</strong></p><p>\u6CE8\u610F\uFF1AbitMap\u8FD4\u56DE\u7684\u6570\u636E\u662F10\u8FDB\u5236\uFF0C\u54EA\u5047\u5982\u8BF4\u8FD4\u56DE\u4E00\u4E2A\u6570\u5B578\uFF0C\u90A3\u4E48\u6211\u54EA\u513F\u77E5\u9053\u5230\u5E95\u54EA\u4E9B\u662F0\uFF0C\u54EA\u4E9B\u662F1\u5462\uFF1F\u6211\u4EEC\u53EA\u9700\u8981\u8BA9\u5F97\u5230\u768410\u8FDB\u5236\u6570\u5B57\u548C1\u505A\u4E0E\u8FD0\u7B97\u5C31\u53EF\u4EE5\u4E86\uFF0C\u56E0\u4E3A1\u53EA\u6709\u9047\u89C11 \u624D\u662F1\uFF0C\u5176\u4ED6\u6570\u5B57\u90FD\u662F0 \uFF0C\u6211\u4EEC\u628A\u7B7E\u5230\u7ED3\u679C\u548C1\u8FDB\u884C\u4E0E\u64CD\u4F5C\uFF0C\u6BCF\u4E0E\u4E00\u6B21\uFF0C\u5C31\u628A\u7B7E\u5230\u7ED3\u679C\u5411\u53F3\u79FB\u52A8\u4E00\u4F4D\uFF0C\u4F9D\u6B21\u5185\u63A8\uFF0C\u6211\u4EEC\u5C31\u80FD\u5B8C\u6210\u9010\u4E2A\u904D\u5386\u7684\u6548\u679C\u4E86\u3002</p><p>\u9700\u6C42\uFF1A\u5B9E\u73B0\u4E0B\u9762\u63A5\u53E3\uFF0C\u7EDF\u8BA1\u5F53\u524D\u7528\u6237\u622A\u6B62\u5F53\u524D\u65F6\u95F4\u5728\u672C\u6708\u7684\u8FDE\u7EED\u7B7E\u5230\u5929\u6570</p><p>\u6709\u7528\u6237\u6709\u65F6\u95F4\u6211\u4EEC\u5C31\u53EF\u4EE5\u7EC4\u7EC7\u51FA\u5BF9\u5E94\u7684key\uFF0C\u6B64\u65F6\u5C31\u80FD\u627E\u5230\u8FD9\u4E2A\u7528\u6237\u622A\u6B62\u8FD9\u5929\u7684\u6240\u6709\u7B7E\u5230\u8BB0\u5F55\uFF0C\u518D\u6839\u636E\u8FD9\u5957\u7B97\u6CD5\uFF0C\u5C31\u80FD\u7EDF\u8BA1\u51FA\u6765\u4ED6\u8FDE\u7EED\u7B7E\u5230\u7684\u6B21\u6570\u4E86</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653835784444.png" alt="1653835784444"></p><p>\u4EE3\u7801</p><p><strong>UserController</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sign/count&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">signCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">signCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>UserServiceImpl</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">signCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.\u83B7\u53D6\u5F53\u524D\u767B\u5F55\u7528\u6237</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.\u83B7\u53D6\u65E5\u671F</span>
    <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.\u62FC\u63A5key</span>
    <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;:yyyyMM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> USER_SIGN_KEY <span class="token operator">+</span> userId <span class="token operator">+</span> keySuffix<span class="token punctuation">;</span>
    <span class="token comment">// 4.\u83B7\u53D6\u4ECA\u5929\u662F\u672C\u6708\u7684\u7B2C\u51E0\u5929</span>
    <span class="token keyword">int</span> dayOfMonth <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getDayOfMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.\u83B7\u53D6\u672C\u6708\u622A\u6B62\u4ECA\u5929\u4E3A\u6B62\u7684\u6240\u6709\u7684\u7B7E\u5230\u8BB0\u5F55\uFF0C\u8FD4\u56DE\u7684\u662F\u4E00\u4E2A\u5341\u8FDB\u5236\u7684\u6570\u5B57 BITFIELD sign:5:202203 GET u14 0</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bitField</span><span class="token punctuation">(</span>
            key<span class="token punctuation">,</span>
            <span class="token class-name">BitFieldSubCommands</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">BitFieldSubCommands<span class="token punctuation">.</span>BitFieldType</span><span class="token punctuation">.</span><span class="token function">unsigned</span><span class="token punctuation">(</span>dayOfMonth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> result<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u6CA1\u6709\u4EFB\u4F55\u7B7E\u5230\u7ED3\u679C</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Long</span> num <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 6.\u5FAA\u73AF\u904D\u5386</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 6.1.\u8BA9\u8FD9\u4E2A\u6570\u5B57\u4E0E1\u505A\u4E0E\u8FD0\u7B97\uFF0C\u5F97\u5230\u6570\u5B57\u7684\u6700\u540E\u4E00\u4E2Abit\u4F4D  // \u5224\u65AD\u8FD9\u4E2Abit\u4F4D\u662F\u5426\u4E3A0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5982\u679C\u4E3A0\uFF0C\u8BF4\u660E\u672A\u7B7E\u5230\uFF0C\u7ED3\u675F</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5982\u679C\u4E0D\u4E3A0\uFF0C\u8BF4\u660E\u5DF2\u7B7E\u5230\uFF0C\u8BA1\u6570\u5668+1</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u628A\u6570\u5B57\u53F3\u79FB\u4E00\u4F4D\uFF0C\u629B\u5F03\u6700\u540E\u4E00\u4E2Abit\u4F4D\uFF0C\u7EE7\u7EED\u4E0B\u4E00\u4E2Abit\u4F4D</span>
        num <span class="token operator">&gt;&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_11-4-\u989D\u5916\u52A0\u9910-\u5173\u4E8E\u4F7F\u7528bitmap\u6765\u89E3\u51B3\u7F13\u5B58\u7A7F\u900F\u7684\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#_11-4-\u989D\u5916\u52A0\u9910-\u5173\u4E8E\u4F7F\u7528bitmap\u6765\u89E3\u51B3\u7F13\u5B58\u7A7F\u900F\u7684\u65B9\u6848" aria-hidden="true">#</a> 11.4 \u989D\u5916\u52A0\u9910-\u5173\u4E8E\u4F7F\u7528bitmap\u6765\u89E3\u51B3\u7F13\u5B58\u7A7F\u900F\u7684\u65B9\u6848</h4><p>\u56DE\u987E<strong>\u7F13\u5B58\u7A7F\u900F</strong>\uFF1A</p><p>\u53D1\u8D77\u4E86\u4E00\u4E2A\u6570\u636E\u5E93\u4E0D\u5B58\u5728\u7684\uFF0Credis\u91CC\u8FB9\u4E5F\u4E0D\u5B58\u5728\u7684\u6570\u636E\uFF0C\u901A\u5E38\u4F60\u53EF\u4EE5\u628A\u4ED6\u770B\u6210\u4E00\u4E2A\u653B\u51FB</p><p>\u89E3\u51B3\u65B9\u6848\uFF1A</p><ul><li><p>\u5224\u65ADid&lt;0</p></li><li><p>\u5982\u679C\u6570\u636E\u5E93\u662F\u7A7A\uFF0C\u90A3\u4E48\u5C31\u53EF\u4EE5\u76F4\u63A5\u5F80redis\u91CC\u8FB9\u628A\u8FD9\u4E2A\u7A7A\u6570\u636E\u7F13\u5B58\u8D77\u6765</p></li></ul><p>\u7B2C\u4E00\u79CD\u89E3\u51B3\u65B9\u6848\uFF1A\u9047\u5230\u7684\u95EE\u9898\u662F\u5982\u679C\u7528\u6237\u8BBF\u95EE\u7684\u662Fid\u4E0D\u5B58\u5728\u7684\u6570\u636E\uFF0C\u5219\u6B64\u65F6\u5C31\u65E0\u6CD5\u751F\u6548</p><p>\u7B2C\u4E8C\u79CD\u89E3\u51B3\u65B9\u6848\uFF1A\u9047\u5230\u7684\u95EE\u9898\u662F\uFF1A\u5982\u679C\u662F\u4E0D\u540C\u7684id\u90A3\u5C31\u53EF\u4EE5\u9632\u6B62\u4E0B\u6B21\u8FC7\u6765\u76F4\u51FB\u6570\u636E</p><p>\u6240\u4EE5\u6211\u4EEC\u5982\u4F55\u89E3\u51B3\u5462\uFF1F</p><p>\u6211\u4EEC\u53EF\u4EE5\u5C06\u6570\u636E\u5E93\u7684\u6570\u636E\uFF0C\u6240\u5BF9\u5E94\u7684id\u5199\u5165\u5230\u4E00\u4E2Alist\u96C6\u5408\u4E2D\uFF0C\u5F53\u7528\u6237\u8FC7\u6765\u8BBF\u95EE\u7684\u65F6\u5019\uFF0C\u6211\u4EEC\u76F4\u63A5\u53BB\u5224\u65ADlist\u4E2D\u662F\u5426\u5305\u542B\u5F53\u524D\u7684\u8981\u67E5\u8BE2\u7684\u6570\u636E\uFF0C\u5982\u679C\u8BF4\u7528\u6237\u8981\u67E5\u8BE2\u7684id\u6570\u636E\u5E76\u4E0D\u5728list\u96C6\u5408\u4E2D\uFF0C\u5219\u76F4\u63A5\u8FD4\u56DE\uFF0C\u5982\u679Clist\u4E2D\u5305\u542B\u5BF9\u5E94\u67E5\u8BE2\u7684id\u6570\u636E\uFF0C\u5219\u8BF4\u660E\u4E0D\u662F\u4E00\u6B21\u7F13\u5B58\u7A7F\u900F\u6570\u636E\uFF0C\u5219\u76F4\u63A5\u653E\u884C\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653836416586.png" alt="1653836416586"></p><p>\u73B0\u5728\u7684\u95EE\u9898\u662F\u8FD9\u4E2A\u4E3B\u952E\u5176\u5B9E\u5E76\u6CA1\u6709\u90A3\u4E48\u77ED\uFF0C\u800C\u662F\u5F88\u957F\u7684\u4E00\u4E2A \u4E3B\u952E</p><p>\u54EA\u6015\u4F60\u5355\u72EC\u53BB\u63D0\u53D6\u8FD9\u4E2A\u4E3B\u952E\uFF0C\u4F46\u662F\u572811\u5E74\u5DE6\u53F3\uFF0C\u6DD8\u5B9D\u7684\u5546\u54C1\u603B\u91CF\u5C31\u5DF2\u7ECF\u8D85\u8FC710\u4EBF\u4E2A</p><p>\u6240\u4EE5\u5982\u679C\u91C7\u7528\u4EE5\u4E0A\u65B9\u6848\uFF0C\u8FD9\u4E2Alist\u4E5F\u4F1A\u5F88\u5927\uFF0C\u6240\u4EE5\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528bitmap\u6765\u51CF\u5C11list\u7684\u5B58\u50A8\u7A7A\u95F4</p><p>\u6211\u4EEC\u53EF\u4EE5\u628Alist\u6570\u636E\u62BD\u8C61\u6210\u4E00\u4E2A\u975E\u5E38\u5927\u7684bitmap\uFF0C\u6211\u4EEC\u4E0D\u518D\u4F7F\u7528list\uFF0C\u800C\u662F\u5C06db\u4E2D\u7684id\u6570\u636E\u5229\u7528\u54C8\u5E0C\u601D\u60F3\uFF0C\u6BD4\u5982\uFF1A</p><p>id % bitmap.size = \u7B97\u51FA\u5F53\u524D\u8FD9\u4E2Aid\u5BF9\u5E94\u5E94\u8BE5\u843D\u5728bitmap\u7684\u54EA\u4E2A\u7D22\u5F15\u4E0A\uFF0C\u7136\u540E\u5C06\u8FD9\u4E2A\u503C\u4ECE0\u53D8\u62101\uFF0C\u7136\u540E\u5F53\u7528\u6237\u6765\u67E5\u8BE2\u6570\u636E\u65F6\uFF0C\u6B64\u65F6\u5DF2\u7ECF\u6CA1\u6709\u4E86list\uFF0C\u8BA9\u7528\u6237\u7528\u4ED6\u67E5\u8BE2\u7684id\u53BB\u7528\u76F8\u540C\u7684\u54C8\u5E0C\u7B97\u6CD5\uFF0C \u7B97\u51FA\u6765\u5F53\u524D\u8FD9\u4E2Aid\u5E94\u5F53\u843D\u5728bitmap\u7684\u54EA\u4E00\u4F4D\uFF0C\u7136\u540E\u5224\u65AD\u8FD9\u4E00\u4F4D\u662F0\uFF0C\u8FD8\u662F1\uFF0C\u5982\u679C\u662F0\u5219\u8868\u660E\u8FD9\u4E00\u4F4D\u4E0A\u7684\u6570\u636E\u4E00\u5B9A\u4E0D\u5B58\u5728\uFF0C \u91C7\u7528\u8FD9\u79CD\u65B9\u5F0F\u6765\u5904\u7406\uFF0C\u9700\u8981\u91CD\u70B9\u8003\u8651\u4E00\u4E2A\u4E8B\u60C5\uFF0C\u5C31\u662F\u8BEF\u5DEE\u7387\uFF0C\u6240\u8C13\u7684\u8BEF\u5DEE\u7387\u5C31\u662F\u6307\u5F53\u53D1\u751F\u54C8\u5E0C\u51B2\u7A81\u7684\u65F6\u5019\uFF0C\u4EA7\u751F\u7684\u8BEF\u5DEE\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653836578970.png" alt="1653836578970"></p><h2 id="_12\u3001uv\u7EDF\u8BA1" tabindex="-1"><a class="header-anchor" href="#_12\u3001uv\u7EDF\u8BA1" aria-hidden="true">#</a> 12\u3001UV\u7EDF\u8BA1</h2><h3 id="_12-1-\u3001uv\u7EDF\u8BA1-hyperloglog" tabindex="-1"><a class="header-anchor" href="#_12-1-\u3001uv\u7EDF\u8BA1-hyperloglog" aria-hidden="true">#</a> 12.1 \u3001UV\u7EDF\u8BA1-HyperLogLog</h3><p>\u9996\u5148\u6211\u4EEC\u641E\u61C2\u4E24\u4E2A\u6982\u5FF5\uFF1A</p><ul><li>UV\uFF1A\u5168\u79F0Unique Visitor\uFF0C\u4E5F\u53EB\u72EC\u7ACB\u8BBF\u5BA2\u91CF\uFF0C\u662F\u6307\u901A\u8FC7\u4E92\u8054\u7F51\u8BBF\u95EE\u3001\u6D4F\u89C8\u8FD9\u4E2A\u7F51\u9875\u7684\u81EA\u7136\u4EBA\u30021\u5929\u5185\u540C\u4E00\u4E2A\u7528\u6237\u591A\u6B21\u8BBF\u95EE\u8BE5\u7F51\u7AD9\uFF0C\u53EA\u8BB0\u5F551\u6B21\u3002</li><li>PV\uFF1A\u5168\u79F0Page View\uFF0C\u4E5F\u53EB\u9875\u9762\u8BBF\u95EE\u91CF\u6216\u70B9\u51FB\u91CF\uFF0C\u7528\u6237\u6BCF\u8BBF\u95EE\u7F51\u7AD9\u7684\u4E00\u4E2A\u9875\u9762\uFF0C\u8BB0\u5F551\u6B21PV\uFF0C\u7528\u6237\u591A\u6B21\u6253\u5F00\u9875\u9762\uFF0C\u5219\u8BB0\u5F55\u591A\u6B21PV\u3002\u5F80\u5F80\u7528\u6765\u8861\u91CF\u7F51\u7AD9\u7684\u6D41\u91CF\u3002</li></ul><p>\u901A\u5E38\u6765\u8BF4UV\u4F1A\u6BD4PV\u5927\u5F88\u591A\uFF0C\u6240\u4EE5\u8861\u91CF\u540C\u4E00\u4E2A\u7F51\u7AD9\u7684\u8BBF\u95EE\u91CF\uFF0C\u6211\u4EEC\u9700\u8981\u7EFC\u5408\u8003\u8651\u5F88\u591A\u56E0\u7D20\uFF0C\u6240\u4EE5\u6211\u4EEC\u53EA\u662F\u5355\u7EAF\u7684\u628A\u8FD9\u4E24\u4E2A\u503C\u4F5C\u4E3A\u4E00\u4E2A\u53C2\u8003\u503C</p><p>UV\u7EDF\u8BA1\u5728\u670D\u52A1\u7AEF\u505A\u4F1A\u6BD4\u8F83\u9EBB\u70E6\uFF0C\u56E0\u4E3A\u8981\u5224\u65AD\u8BE5\u7528\u6237\u662F\u5426\u5DF2\u7ECF\u7EDF\u8BA1\u8FC7\u4E86\uFF0C\u9700\u8981\u5C06\u7EDF\u8BA1\u8FC7\u7684\u7528\u6237\u4FE1\u606F\u4FDD\u5B58\u3002\u4F46\u662F\u5982\u679C\u6BCF\u4E2A\u8BBF\u95EE\u7684\u7528\u6237\u90FD\u4FDD\u5B58\u5230Redis\u4E2D\uFF0C\u6570\u636E\u91CF\u4F1A\u975E\u5E38\u6050\u6016\uFF0C\u90A3\u600E\u4E48\u5904\u7406\u5462\uFF1F</p>`,450),y=s("Hyperloglog(HLL)\u662F\u4ECELoglog\u7B97\u6CD5\u6D3E\u751F\u7684\u6982\u7387\u7B97\u6CD5\uFF0C\u7528\u4E8E\u786E\u5B9A\u975E\u5E38\u5927\u7684\u96C6\u5408\u7684\u57FA\u6570\uFF0C\u800C\u4E0D\u9700\u8981\u5B58\u50A8\u5176\u6240\u6709\u503C\u3002\u76F8\u5173\u7B97\u6CD5\u539F\u7406\u5927\u5BB6\u53EF\u4EE5\u53C2\u8003\uFF1A"),w={href:"https://juejin.cn/post/6844903785744056333#heading-0",target:"_blank",rel:"noopener noreferrer"},q=s("https://juejin.cn/post/6844903785744056333#heading-0"),S=s(" Redis\u4E2D\u7684HLL\u662F\u57FA\u4E8Estring\u7ED3\u6784\u5B9E\u73B0\u7684\uFF0C\u5355\u4E2AHLL\u7684\u5185\u5B58"),I=n("strong",null,"\u6C38\u8FDC\u5C0F\u4E8E16kb",-1),R=s("\uFF0C"),x=n("strong",null,"\u5185\u5B58\u5360\u7528\u4F4E",-1),T=s("\u7684\u4EE4\u4EBA\u53D1\u6307\uFF01\u4F5C\u4E3A\u4EE3\u4EF7\uFF0C\u5176\u6D4B\u91CF\u7ED3\u679C\u662F\u6982\u7387\u6027\u7684\uFF0C"),E=n("strong",null,"\u6709\u5C0F\u4E8E0.81\uFF05\u7684\u8BEF\u5DEE",-1),_=s("\u3002\u4E0D\u8FC7\u5BF9\u4E8EUV\u7EDF\u8BA1\u6765\u8BF4\uFF0C\u8FD9\u5B8C\u5168\u53EF\u4EE5\u5FFD\u7565\u3002"),L=n("p",null,[n("img",{src:"https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653837988985.png",alt:"1653837988985"})],-1),O=n("h3",{id:"_12-2-uv\u7EDF\u8BA1-\u6D4B\u8BD5\u767E\u4E07\u6570\u636E\u7684\u7EDF\u8BA1",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_12-2-uv\u7EDF\u8BA1-\u6D4B\u8BD5\u767E\u4E07\u6570\u636E\u7684\u7EDF\u8BA1","aria-hidden":"true"},"#"),s(" 12.2 UV\u7EDF\u8BA1-\u6D4B\u8BD5\u767E\u4E07\u6570\u636E\u7684\u7EDF\u8BA1")],-1),j=n("p",null,"\u6D4B\u8BD5\u601D\u8DEF\uFF1A\u6211\u4EEC\u76F4\u63A5\u5229\u7528\u5355\u5143\u6D4B\u8BD5\uFF0C\u5411HyperLogLog\u4E2D\u6DFB\u52A0100\u4E07\u6761\u6570\u636E\uFF0C\u770B\u770B\u5185\u5B58\u5360\u7528\u548C\u7EDF\u8BA1\u6548\u679C\u5982\u4F55",-1),U=n("p",null,[n("img",{src:"https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/1653838053608.png",alt:"1653838053608"})],-1),C=n("p",null,"\u7ECF\u8FC7\u6D4B\u8BD5\uFF1A\u6211\u4EEC\u4F1A\u53D1\u751F\u4ED6\u7684\u8BEF\u5DEE\u662F\u5728\u5141\u8BB8\u8303\u56F4\u5185\uFF0C\u5E76\u4E14\u5185\u5B58\u5360\u7528\u6781\u5C0F",-1);function B(D,V){const a=l("ExternalLinkIcon");return o(),c("div",null,[u,n("blockquote",null,[k,n("p",null,[r,n("a",d,[m,p(a)])])]),v,n("p",null,[b,n("a",g,[h,p(a)])]),f,n("p",null,[y,n("a",w,[q,p(a)]),S,I,R,x,T,E,_]),L,O,j,U,C])}var P=e(i,[["render",B],["__file","Redis02.html.vue"]]);export{P as default};
