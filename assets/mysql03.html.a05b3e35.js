import{_ as e}from"./plugin-vue_export-helper.21dcd24c.js";import{o as i,c as d,d as n}from"./app.6a2d513d.js";const a={},s=n(`<h1 id="\u4E09\u3001mysql\u4E8B\u52A1\u7BC7" tabindex="-1"><a class="header-anchor" href="#\u4E09\u3001mysql\u4E8B\u52A1\u7BC7" aria-hidden="true">#</a> \u4E09\u3001MySQL\u4E8B\u52A1\u7BC7</h1><h2 id="\u7B2C13\u7AE0-\u4E8B\u52A1\u57FA\u7840\u77E5\u8BC6" tabindex="-1"><a class="header-anchor" href="#\u7B2C13\u7AE0-\u4E8B\u52A1\u57FA\u7840\u77E5\u8BC6" aria-hidden="true">#</a> \u7B2C13\u7AE0_\u4E8B\u52A1\u57FA\u7840\u77E5\u8BC6</h2><h3 id="_1-\u6570\u636E\u5E93\u4E8B\u52A1\u6982\u8FF0" tabindex="-1"><a class="header-anchor" href="#_1-\u6570\u636E\u5E93\u4E8B\u52A1\u6982\u8FF0" aria-hidden="true">#</a> 1. \u6570\u636E\u5E93\u4E8B\u52A1\u6982\u8FF0</h3><h5 id="_1-1-\u5B58\u50A8\u5F15\u64CE\u652F\u6301\u60C5\u51B5" tabindex="-1"><a class="header-anchor" href="#_1-1-\u5B58\u50A8\u5F15\u64CE\u652F\u6301\u60C5\u51B5" aria-hidden="true">#</a> 1.1 \u5B58\u50A8\u5F15\u64CE\u652F\u6301\u60C5\u51B5</h5><p><code>SHOW ENGINES</code> \u547D\u4EE4\u6765\u67E5\u770B\u5F53\u524D MySQL \u652F\u6301\u7684\u5B58\u50A8\u5F15\u64CE\u90FD\u6709\u54EA\u4E9B\uFF0C\u4EE5\u53CA\u8FD9\u4E9B\u5B58\u50A8\u5F15\u64CE\u662F\u5426\u652F\u6301\u4E8B\u52A1\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708124306444.png" alt="image-20220708124306444"></p><p>\u80FD\u770B\u51FA\u5728 MySQL \u4E2D\uFF0C\u53EA\u6709InnoDB \u662F\u652F\u6301\u4E8B\u52A1\u7684\u3002</p><h5 id="_1-2-\u57FA\u672C\u6982\u5FF5" tabindex="-1"><a class="header-anchor" href="#_1-2-\u57FA\u672C\u6982\u5FF5" aria-hidden="true">#</a> 1.2 \u57FA\u672C\u6982\u5FF5</h5><p>**\u4E8B\u52A1\uFF1A**\u4E00\u7EC4\u903B\u8F91\u64CD\u4F5C\u5355\u5143\uFF0C\u4F7F\u6570\u636E\u4ECE\u4E00\u79CD\u72B6\u6001\u53D8\u6362\u5230\u53E6\u4E00\u79CD\u72B6\u6001\u3002</p><p>**\u4E8B\u52A1\u5904\u7406\u7684\u539F\u5219\uFF1A**\u4FDD\u8BC1\u6240\u6709\u4E8B\u52A1\u90FD\u4F5C\u4E3A <code>\u4E00\u4E2A\u5DE5\u4F5C\u5355\u5143</code> \u6765\u6267\u884C\uFF0C\u5373\u4F7F\u51FA\u73B0\u4E86\u6545\u969C\uFF0C\u90FD\u4E0D\u80FD\u6539\u53D8\u8FD9\u79CD\u6267\u884C\u65B9 \u5F0F\u3002\u5F53\u5728\u4E00\u4E2A\u4E8B\u52A1\u4E2D\u6267\u884C\u591A\u4E2A\u64CD\u4F5C\u65F6\uFF0C\u8981\u4E48\u6240\u6709\u7684\u4E8B\u52A1\u90FD\u88AB\u63D0\u4EA4( <code>commit</code> )\uFF0C\u90A3\u4E48\u8FD9\u4E9B\u4FEE\u6539\u5C31 <code>\u6C38\u4E45</code> \u5730\u4FDD <code>\u5B58\u4E0B\u6765</code>\uFF1B\u8981\u4E48\u6570\u636E\u5E93\u7BA1\u7406\u7CFB\u7EDF\u5C06 <code>\u653E\u5F03</code> \u6240\u4F5C\u7684\u6240\u6709 <code>\u4FEE\u6539</code> \uFF0C\u6574\u4E2A\u4E8B\u52A1\u56DE\u6EDA( rollback )\u5230\u6700\u521D\u72B6\u6001\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u6848\u4F8B\uFF1AAA\u7528\u6237\u7ED9BB\u7528\u6237\u8F6C\u8D26100
update account set money = money - 100 where name = &#39;AA&#39;;
# \u670D\u52A1\u5668\u5B95\u673A
update account set money = money + 100 where name = &#39;BB&#39;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-3-\u4E8B\u7269\u7684acid\u7279\u6027" tabindex="-1"><a class="header-anchor" href="#_1-3-\u4E8B\u7269\u7684acid\u7279\u6027" aria-hidden="true">#</a> 1.3 \u4E8B\u7269\u7684ACID\u7279\u6027</h5><ul><li><strong>\u539F\u5B50\u6027\uFF08atomicity\uFF09\uFF1A</strong></li></ul><p>\u539F\u5B50\u6027\u662F\u6307\u4E8B\u52A1\u662F\u4E00\u4E2A\u4E0D\u53EF\u5206\u5272\u7684\u5DE5\u4F5C\u5355\u4F4D\uFF0C\u8981\u4E48\u5168\u90E8\u63D0\u4EA4\uFF0C\u8981\u4E48\u5168\u90E8\u5931\u8D25\u56DE\u6EDA\u3002\u5373\u8981\u4E48\u8F6C\u8D26\u6210\u529F\uFF0C\u8981\u4E48\u8F6C\u8D26\u5931\u8D25\uFF0C\u662F\u4E0D\u5B58\u5728\u4E2D\u95F4\u7684\u72B6\u6001\u3002\u5982\u679C\u65E0\u6CD5\u4FDD\u8BC1\u539F\u5B50\u6027\u4F1A\u600E\u4E48\u6837\uFF1F\u5C31\u4F1A\u51FA\u73B0\u6570\u636E\u4E0D\u4E00\u81F4\u7684\u60C5\u5F62\uFF0CA\u8D26\u6237\u51CF\u53BB100\u5143\uFF0C\u800CB\u8D26\u6237\u589E\u52A0100\u5143\u64CD\u4F5C\u5931\u8D25\uFF0C\u7CFB\u7EDF\u5C06\u65E0\u6545\u4E22\u5931100\u5143\u3002</p><ul><li><strong>\u4E00\u81F4\u6027\uFF08consistency\uFF09\uFF1A</strong></li></ul><p>\uFF08\u56FD\u5185\u5F88\u591A\u7F51\u7AD9\u4E0A\u5BF9\u4E00\u81F4\u6027\u7684\u9610\u8FF0\u6709\u8BEF\uFF0C\u5177\u4F53\u4F60\u53EF\u4EE5\u53C2\u8003 Wikipedia \u5BF9Consistency\u7684\u9610\u8FF0\uFF09</p><p>\u6839\u636E\u5B9A\u4E49\uFF0C\u4E00\u81F4\u6027\u662F\u6307\u4E8B\u52A1\u6267\u884C\u524D\u540E\uFF0C\u6570\u636E\u4ECE\u4E00\u4E2A <code>\u5408\u6CD5\u6027\u72B6\u6001</code> \u53D8\u6362\u5230\u53E6\u5916\u4E00\u4E2A <code>\u5408\u6CD5\u6027\u72B6\u6001</code> \u3002\u8FD9\u79CD\u72B6\u6001\u662F <code>\u8BED\u4E49\u4E0A</code> \u7684\u800C\u4E0D\u662F\u8BED\u6CD5\u4E0A\u7684\uFF0C\u8DDF\u5177\u4F53\u7684\u4E1A\u52A1\u6709\u5173\u3002</p><p>\u90A3\u4EC0\u4E48\u662F\u5408\u6CD5\u7684\u6570\u636E\u72B6\u6001\u5462\uFF1F\u6EE1\u8DB3 <code>\u9884\u5B9A\u7684\u7EA6\u675F</code> \u7684\u72B6\u6001\u5C31\u53EB\u505A\u5408\u6CD5\u7684\u72B6\u6001\u3002\u901A\u4FD7\u4E00\u70B9\uFF0C\u8FD9\u72B6\u6001\u662F\u7531\u4F60\u81EA\u5DF1\u6765\u5B9A\u4E49\u7684\uFF08\u6BD4\u5982\u6EE1\u8DB3\u73B0\u5B9E\u4E16\u754C\u4E2D\u7684\u7EA6\u675F\uFF09\u3002\u6EE1\u8DB3\u8FD9\u4E2A\u72B6\u6001\uFF0C\u6570\u636E\u5C31\u662F\u4E00\u81F4\u7684\uFF0C\u4E0D\u6EE1\u8DB3\u8FD9\u4E2A\u72B6\u6001\uFF0C\u6570\u636E\u5C31 \u662F\u4E0D\u4E00\u81F4\u7684\uFF01\u5982\u679C\u4E8B\u52A1\u4E2D\u7684\u67D0\u4E2A\u64CD\u4F5C\u5931\u8D25\u4E86\uFF0C\u7CFB\u7EDF\u5C31\u4F1A\u81EA\u52A8\u64A4\u9500\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684\u4E8B\u52A1\uFF0C\u8FD4\u56DE\u5230\u4E8B\u52A1\u64CD\u4F5C \u4E4B\u524D\u7684\u72B6\u6001\u3002</p><p>**\u4E3E\u4F8B1\uFF1A**A\u8D26\u6237\u6709200\u5143\uFF0C\u8F6C\u8D26300\u5143\u51FA\u53BB\uFF0C\u6B64\u65F6A\u8D26\u6237\u4F59\u989D\u4E3A-100\u5143\u3002\u4F60\u81EA\u7136\u5C31\u53D1\u73B0\u6B64\u65F6\u6570\u636E\u662F\u4E0D\u4E00\u81F4\u7684\uFF0C\u4E3A\u4EC0\u4E48\u5462\uFF1F\u56E0\u4E3A\u4F60\u5B9A\u4E49\u4E86\u4E00\u4E2A\u72B6\u6001\uFF0C\u4F59\u989D\u8FD9\u5217\u5FC5\u987B&gt;=0\u3002</p><p>**\u4E3E\u4F8B2\uFF1A**A\u8D26\u6237\u6709200\u5143\uFF0C\u8F6C\u8D2650\u5143\u7ED9B\u8D26\u6237\uFF0CA\u8D26\u6237\u7684\u94B1\u6263\u4E86\uFF0C\u4F46\u662FB\u8D26\u6237\u56E0\u4E3A\u5404\u79CD\u610F\u5916\uFF0C\u4F59\u989D\u5E76\u6CA1\u6709\u589E\u52A0\u3002\u4F60\u4E5F\u77E5\u9053\u6B64\u65F6\u7684\u6570\u636E\u662F\u4E0D\u4E00\u81F4\u7684\uFF0C\u4E3A\u4EC0\u4E48\u5462\uFF1F\u56E0\u4E3A\u4F60\u5B9A\u4E49\u4E86\u4E00\u4E2A\u72B6\u6001\uFF0C\u8981\u6C42A+B\u7684\u603B\u4F59\u989D\u5FC5\u987B\u4E0D\u53D8\u3002</p><p>**\u4E3E\u4F8B3\uFF1A**\u5728\u6570\u636E\u8868\u4E2D\u6211\u4EEC\u5C06<code>\u59D3\u540D</code>\u5B57\u6BB5\u8BBE\u7F6E\u4E3A<code>\u552F\u4E00\u6027\u7EA6\u675F</code>\uFF0C\u8FD9\u65F6\u5F53\u4E8B\u52A1\u8FDB\u884C\u63D0\u4EA4\u6216\u8005\u4E8B\u52A1\u53D1\u751F\u56DE\u6EDA\u7684\u65F6\u5019\uFF0C\u5982\u679C\u6570\u636E\u8868\u7684\u59D3\u540D\u4E0D\u552F\u4E00\uFF0C\u5C31\u7834\u574F\u4E86\u4E8B\u7269\u7684\u4E00\u81F4\u6027\u8981\u6C42\u3002</p><ul><li><strong>\u9694\u79BB\u578B\uFF08isolation\uFF09\uFF1A</strong></li></ul><p>\u4E8B\u52A1\u7684\u9694\u79BB\u6027\u662F\u6307\u4E00\u4E2A\u4E8B\u52A1\u7684\u6267\u884C<code>\u4E0D\u80FD\u88AB\u5176\u4ED6\u4E8B\u52A1\u5E72\u6270</code>\uFF0C\u5373\u4E00\u4E2A\u4E8B\u52A1\u5185\u90E8\u7684\u64CD\u4F5C\u53CA\u4F7F\u7528\u7684\u6570\u636E\u5BF9<code>\u5E76\u53D1</code>\u7684\u5176\u4ED6\u4E8B\u52A1\u662F\u9694\u79BB\u7684\uFF0C\u5E76\u53D1\u6267\u884C\u7684\u5404\u4E2A\u4E8B\u52A1\u4E4B\u95F4\u4E0D\u80FD\u76F8\u4E92\u5E72\u6270\u3002</p><p>\u5982\u679C\u65E0\u6CD5\u4FDD\u8BC1\u9694\u79BB\u6027\u4F1A\u600E\u4E48\u6837\uFF1F\u5047\u8BBEA\u8D26\u6237\u6709200\u5143\uFF0CB\u8D26\u62370\u5143\u3002A\u8D26\u6237\u5F80B\u8D26\u6237\u8F6C\u8D26\u4E24\u6B21\uFF0C\u6BCF\u6B21\u91D1\u989D\u4E3A50 \u5143\uFF0C\u5206\u522B\u5728\u4E24\u4E2A\u4E8B\u52A1\u4E2D\u6267\u884C\u3002\u5982\u679C\u65E0\u6CD5\u4FDD\u8BC1\u9694\u79BB\u6027\uFF0C\u4F1A\u51FA\u73B0\u4E0B\u9762\u7684\u60C5\u5F62\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>UPDATE accounts SET money = money - 50 WHERE NAME = &#39;AA&#39;;
UPDATE accounts SET money = money + 50 WHERE NAME = &#39;BB&#39;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708164610193.png" alt="image-20220708164610193"></p><p><strong>\u6301\u4E45\u6027\uFF08durability\uFF09\uFF1A</strong></p><p>\u6301\u4E45\u6027\u662F\u6307\u4E00\u4E2A\u4E8B\u52A1\u4E00\u65E6\u88AB\u63D0\u4EA4\uFF0C\u5B83\u5BF9\u6570\u636E\u5E93\u4E2D\u6570\u636E\u7684\u6539\u53D8\u5C31\u662F \u6C38\u4E45\u6027\u7684 \uFF0C\u63A5\u4E0B\u6765\u7684\u5176\u4ED6\u64CD\u4F5C\u548C\u6570\u636E\u5E93 \u6545\u969C\u4E0D\u5E94\u8BE5\u5BF9\u5176\u6709\u4EFB\u4F55\u5F71\u54CD\u3002</p><p>\u6301\u4E45\u6027\u662F\u901A\u8FC7 <code>\u4E8B\u52A1\u65E5\u5FD7</code> \u6765\u4FDD\u8BC1\u7684\u3002\u65E5\u5FD7\u5305\u62EC\u4E86 <code>\u91CD\u505A\u65E5\u5FD7</code> \u548C <code>\u56DE\u6EDA\u65E5\u5FD7</code> \u3002\u5F53\u6211\u4EEC\u901A\u8FC7\u4E8B\u52A1\u5BF9\u6570\u636E\u8FDB\u884C\u4FEE\u6539 \u7684\u65F6\u5019\uFF0C\u9996\u5148\u4F1A\u5C06\u6570\u636E\u5E93\u7684\u53D8\u5316\u4FE1\u606F\u8BB0\u5F55\u5230\u91CD\u505A\u65E5\u5FD7\u4E2D\uFF0C\u7136\u540E\u518D\u5BF9\u6570\u636E\u5E93\u4E2D\u5BF9\u5E94\u7684\u884C\u8FDB\u884C\u4FEE\u6539\u3002\u8FD9\u6837\u505A \u7684\u597D\u5904\u662F\uFF0C\u5373\u4F7F\u6570\u636E\u5E93\u7CFB\u7EDF\u5D29\u6E83\uFF0C\u6570\u636E\u5E93\u91CD\u542F\u540E\u4E5F\u80FD\u627E\u5230\u6CA1\u6709\u66F4\u65B0\u5230\u6570\u636E\u5E93\u7CFB\u7EDF\u4E2D\u7684\u91CD\u505A\u65E5\u5FD7\uFF0C\u91CD\u65B0\u6267 \u884C\uFF0C\u4ECE\u800C\u4F7F\u4E8B\u52A1\u5177\u6709\u6301\u4E45\u6027\u3002</p><blockquote><p>\u603B\u7ED3</p><p>ACID\u662F\u4E8B\u52A1\u7684\u56DB\u5927\u7279\u5F81\uFF0C\u5728\u8FD9\u56DB\u4E2A\u7279\u6027\u4E2D\uFF0C\u539F\u5B50\u6027\u662F\u57FA\u7840\uFF0C\u9694\u79BB\u6027\u662F\u624B\u6BB5\uFF0C\u4E00\u81F4\u6027\u662F\u7EA6\u675F\u6761\u4EF6\uFF0C \u800C\u6301\u4E45\u6027\u662F\u6211\u4EEC\u7684\u76EE\u7684\u3002</p><p>\u6570\u636E\u5E93\u4E8B\u52A1\uFF0C\u5176\u5B9E\u5C31\u662F\u6570\u636E\u5E93\u8BBE\u8BA1\u8005\u4E3A\u4E86\u65B9\u4FBF\u8D77\u89C1\uFF0C\u628A\u9700\u8981\u4FDD\u8BC1<code>\u539F\u5B50\u6027</code>\u3001<code>\u9694\u79BB\u6027</code>\u3001<code>\u4E00\u81F4\u6027</code>\u548C<code>\u6301\u4E45\u6027</code>\u7684\u4E00\u4E2A\u6216\u591A\u4E2A\u6570\u636E\u5E93\u64CD\u4F5C\u79F0\u4E3A\u4E00\u4E2A\u4E8B\u52A1\u3002</p></blockquote><h5 id="_1-4-\u4E8B\u52A1\u7684\u72B6\u6001" tabindex="-1"><a class="header-anchor" href="#_1-4-\u4E8B\u52A1\u7684\u72B6\u6001" aria-hidden="true">#</a> 1.4 \u4E8B\u52A1\u7684\u72B6\u6001</h5><p>\u6211\u4EEC\u73B0\u5728\u77E5\u9053 <code>\u4E8B\u52A1</code> \u662F\u4E00\u4E2A\u62BD\u8C61\u7684\u6982\u5FF5\uFF0C\u5B83\u5176\u5B9E\u5BF9\u5E94\u7740\u4E00\u4E2A\u6216\u591A\u4E2A\u6570\u636E\u5E93\u64CD\u4F5C\uFF0CMySQL\u6839\u636E\u8FD9\u4E9B\u64CD\u4F5C\u6240\u6267 \u884C\u7684\u4E0D\u540C\u9636\u6BB5\u628A <code>\u4E8B\u52A1</code> \u5927\u81F4\u5212\u5206\u6210\u51E0\u4E2A\u72B6\u6001\uFF1A</p><ul><li><p><strong>\u6D3B\u52A8\u7684\uFF08active\uFF09</strong></p><p>\u4E8B\u52A1\u5BF9\u5E94\u7684\u6570\u636E\u5E93\u64CD\u4F5C\u6B63\u5728\u6267\u884C\u8FC7\u7A0B\u4E2D\u65F6\uFF0C\u6211\u4EEC\u5C31\u8BF4\u8BE5\u4E8B\u52A1\u5904\u5728 <code>\u6D3B\u52A8\u7684</code> \u72B6\u6001\u3002</p></li><li><p><strong>\u90E8\u5206\u63D0\u4EA4\u7684\uFF08partially committed\uFF09</strong></p><p>\u5F53\u4E8B\u52A1\u4E2D\u7684\u6700\u540E\u4E00\u4E2A\u64CD\u4F5C\u6267\u884C\u5B8C\u6210\uFF0C\u4F46\u7531\u4E8E\u64CD\u4F5C\u90FD\u5728\u5185\u5B58\u4E2D\u6267\u884C\uFF0C\u6240\u9020\u6210\u7684\u5F71\u54CD\u5E76 <code>\u6CA1\u6709\u5237\u65B0\u5230\u78C1\u76D8</code> \u65F6\uFF0C\u6211\u4EEC\u5C31\u8BF4\u8BE5\u4E8B\u52A1\u5904\u5728 <code>\u90E8\u5206\u63D0\u4EA4\u7684</code> \u72B6\u6001\u3002</p></li><li><p><strong>\u5931\u8D25\u7684\uFF08failed\uFF09</strong></p><p>\u5F53\u4E8B\u52A1\u5904\u5728 <code>\u6D3B\u52A8\u7684</code> \u6216\u8005 \u90E8\u5206\u63D0\u4EA4\u7684 \u72B6\u6001\u65F6\uFF0C\u53EF\u80FD\u9047\u5230\u4E86\u67D0\u4E9B\u9519\u8BEF\uFF08\u6570\u636E\u5E93\u81EA\u8EAB\u7684\u9519\u8BEF\u3001\u64CD\u4F5C\u7CFB\u7EDF \u9519\u8BEF\u6216\u8005\u76F4\u63A5\u65AD\u7535\u7B49\uFF09\u800C\u65E0\u6CD5\u7EE7\u7EED\u6267\u884C\uFF0C\u6216\u8005\u4EBA\u4E3A\u7684\u505C\u6B62\u5F53\u524D\u4E8B\u52A1\u7684\u6267\u884C\uFF0C\u6211\u4EEC\u5C31\u8BF4\u8BE5\u4E8B\u52A1\u5904\u5728 \u5931 \u8D25\u7684 \u72B6\u6001\u3002</p></li><li><p><strong>\u4E2D\u6B62\u7684\uFF08aborted\uFF09</strong></p><p>\u5982\u679C\u4E8B\u52A1\u6267\u884C\u4E86\u4E00\u90E8\u5206\u800C\u53D8\u4E3A <code>\u5931\u8D25\u7684</code> \u72B6\u6001\uFF0C\u90A3\u4E48\u5C31\u9700\u8981\u628A\u5DF2\u7ECF\u4FEE\u6539\u7684\u4E8B\u52A1\u4E2D\u7684\u64CD\u4F5C\u8FD8\u539F\u5230\u4E8B\u52A1\u6267 \u884C\u524D\u7684\u72B6\u6001\u3002\u6362\u53E5\u8BDD\u8BF4\uFF0C\u5C31\u662F\u8981\u64A4\u9500\u5931\u8D25\u4E8B\u52A1\u5BF9\u5F53\u524D\u6570\u636E\u5E93\u9020\u6210\u7684\u5F71\u54CD\u3002\u6211\u4EEC\u628A\u8FD9\u4E2A\u64A4\u9500\u7684\u8FC7\u7A0B\u79F0\u4E4B\u4E3A <code>\u56DE\u6EDA</code> \u3002\u5F53 <code>\u56DE\u6EDA</code> \u64CD\u4F5C\u6267\u884C\u5B8C\u6BD5\u65F6\uFF0C\u4E5F\u5C31\u662F\u6570\u636E\u5E93\u6062\u590D\u5230\u4E86\u6267\u884C\u4E8B\u52A1\u4E4B\u524D\u7684\u72B6\u6001\uFF0C\u6211\u4EEC\u5C31\u8BF4\u8BE5\u4E8B \u52A1\u5904\u5728\u4E86 <code>\u4E2D\u6B62\u7684</code> \u72B6\u6001\u3002</p></li><li><p><strong>\u63D0\u4EA4\u7684\uFF08committed\uFF09</strong></p><p>\u5F53\u4E00\u4E2A\u5904\u5728 <code>\u90E8\u5206\u63D0\u4EA4\u7684</code> \u72B6\u6001\u7684\u4E8B\u52A1\u5C06\u4FEE\u6539\u8FC7\u7684\u6570\u636E\u90FD <code>\u540C\u6B65\u5230\u78C1\u76D8</code> \u4E0A\u4E4B\u540E\uFF0C\u6211\u4EEC\u5C31\u53EF\u4EE5\u8BF4\u8BE5\u4E8B\u52A1\u5904\u5728\u4E86 <code>\u63D0\u4EA4\u7684</code> \u72B6\u6001\u3002</p><p>\u4E00\u4E2A\u57FA\u672C\u7684\u72B6\u6001\u8F6C\u6362\u56FE\u5982\u4E0B\u6240\u793A\uFF1A</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708171859055.png" alt="image-20220708171859055" style="zoom:80%;"><p>\u56FE\u4E2D\u53EF\u89C1\uFF0C\u53EA\u6709\u5F53\u4E8B\u7269\u5904\u4E8E<code>\u63D0\u4EA4\u7684</code>\u6216\u8005<code>\u4E2D\u6B62\u7684</code>\u72B6\u6001\u65F6\uFF0C\u4E00\u4E2A\u4E8B\u52A1\u7684\u751F\u547D\u5468\u671F\u624D\u7B97\u662F\u7ED3\u675F\u4E86\u3002\u5BF9\u4E8E\u5DF2\u7ECF\u63D0\u4EA4\u7684\u4E8B\u52A1\u6765\u8BF4\uFF0C\u8BE5\u4E8B\u52A1\u5BF9\u6570\u636E\u5E93\u6240\u505A\u7684\u4FEE\u6539\u5C06\u6C38\u4E45\u751F\u6548\uFF0C\u5BF9\u4E8E\u5904\u4E8E\u4E2D\u6B62\u72B6\u6001\u7684\u4E8B\u7269\uFF0C\u8BE5\u4E8B\u52A1\u5BF9\u6570\u636E\u5E93\u6240\u505A\u7684\u6240\u6709\u4FEE\u6539\u90FD\u4F1A\u88AB\u56DE\u6EDA\u5230\u6CA1\u6267\u884C\u8BE5\u4E8B\u7269\u4E4B\u524D\u7684\u72B6\u6001\u3002</p></li></ul><h3 id="_2-\u5982\u4F55\u4F7F\u7528\u4E8B\u52A1" tabindex="-1"><a class="header-anchor" href="#_2-\u5982\u4F55\u4F7F\u7528\u4E8B\u52A1" aria-hidden="true">#</a> 2. \u5982\u4F55\u4F7F\u7528\u4E8B\u52A1</h3><p>\u4F7F\u7528\u4E8B\u52A1\u6709\u4E24\u79CD\u65B9\u5F0F\uFF0C\u5206\u522B\u4E3A <code>\u663E\u5F0F\u4E8B\u52A1</code> \u548C <code>\u9690\u5F0F\u4E8B\u52A1</code> \u3002</p><h5 id="_2-1-\u663E\u5F0F\u4E8B\u52A1" tabindex="-1"><a class="header-anchor" href="#_2-1-\u663E\u5F0F\u4E8B\u52A1" aria-hidden="true">#</a> 2.1 \u663E\u5F0F\u4E8B\u52A1</h5><p><strong>\u6B65\u9AA41\uFF1A</strong> START TRANSACTION \u6216\u8005 BEGIN \uFF0C\u4F5C\u7528\u662F\u663E\u5F0F\u5F00\u542F\u4E00\u4E2A\u4E8B\u52A1\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; BEGIN;
#\u6216\u8005
mysql&gt; START TRANSACTION;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>START TRANSACTION</code> \u8BED\u53E5\u76F8\u8F83\u4E8E <code>BEGIN</code> \u7279\u522B\u4E4B\u5904\u5728\u4E8E\uFF0C\u540E\u8FB9\u80FD\u8DDF\u968F\u51E0\u4E2A <code>\u4FEE\u9970\u7B26</code> \uFF1A</p><p>\u2460 <code>READ ONLY</code> \uFF1A\u6807\u8BC6\u5F53\u524D\u4E8B\u52A1\u662F\u4E00\u4E2A <code>\u53EA\u8BFB\u4E8B\u52A1</code> \uFF0C\u4E5F\u5C31\u662F\u5C5E\u4E8E\u8BE5\u4E8B\u52A1\u7684\u6570\u636E\u5E93\u64CD\u4F5C\u53EA\u80FD\u8BFB\u53D6\u6570\u636E\uFF0C\u800C\u4E0D\u80FD\u4FEE\u6539\u6570\u636E\u3002</p><blockquote><p>\u8865\u5145\uFF1A\u53EA\u8BFB\u4E8B\u52A1\u4E2D\u53EA\u662F\u4E0D\u5141\u8BB8\u4FEE\u6539\u90A3\u4E9B\u5176\u4ED6\u4E8B\u52A1\u4E5F\u80FD\u8BBF\u95EE\u5230\u7684\u8868\u4E2D\u7684\u6570\u636E\uFF0C\u5BF9\u4E8E\u4E34\u65F6\u8868\u6765\u8BF4\uFF08\u6211\u4EEC\u4F7F\u7528 CREATE TMEPORARY TABLE \u521B\u5EFA\u7684\u8868\uFF09\uFF0C\u7531\u4E8E\u5B83\u4EEC\u53EA\u80FD\u518D\u5F53\u524D\u4F1A\u8BDD\u4E2D\u53EF\u89C1\uFF0C\u6240\u6709\u53EA\u8BFB\u4E8B\u52A1\u5176\u5B9E\u4E5F\u662F\u53EF\u4EE5\u5BF9\u4E34\u65F6\u8868\u8FDB\u884C\u589E\u3001\u5220\u3001\u6539\u64CD\u4F5C\u7684\u3002</p></blockquote><p>\u2461 <code>READ WRITE</code> \uFF1A\u6807\u8BC6\u5F53\u524D\u4E8B\u52A1\u662F\u4E00\u4E2A <code>\u8BFB\u5199\u4E8B\u52A1</code> \uFF0C\u4E5F\u5C31\u662F\u5C5E\u4E8E\u8BE5\u4E8B\u52A1\u7684\u6570\u636E\u5E93\u64CD\u4F5C\u65E2\u53EF\u4EE5\u8BFB\u53D6\u6570\u636E\uFF0C \u4E5F\u53EF\u4EE5\u4FEE\u6539\u6570\u636E\u3002</p><p>\u2462 <code>WITH CONSISTENT SNAPSHOT</code> \uFF1A\u542F\u52A8\u4E00\u81F4\u6027\u8BFB\u3002</p><p>\u6BD4\u5982\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>START TRANSACTION READ ONLY; # \u5F00\u542F\u4E00\u4E2A\u53EA\u8BFB\u4E8B\u52A1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>START TRANSACTION READ ONLY, WITH CONSISTENT SNAPSHOT # \u5F00\u542F\u53EA\u8BFB\u4E8B\u52A1\u548C\u4E00\u81F4\u6027\u8BFB
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>START TRANSACTION READ WRITE, WITH CONSISTENT SNAPSHOT # \u5F00\u542F\u8BFB\u5199\u4E8B\u52A1\u548C\u4E00\u81F4\u6027\u8BFB
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u6CE8\u610F\uFF1A</p><ul><li><code>READ ONLY</code>\u548C<code>READ WRITE</code>\u662F\u7528\u6765\u8BBE\u7F6E\u6240\u8C13\u7684\u4E8B\u7269<code>\u8BBF\u95EE\u6A21\u5F0F</code>\u7684\uFF0C\u5C31\u662F\u4EE5\u53EA\u8BFB\u8FD8\u662F\u8BFB\u5199\u7684\u65B9\u5F0F\u6765\u8BBF\u95EE\u6570\u636E\u5E93\u4E2D\u7684\u6570\u636E\uFF0C\u4E00\u4E2A\u4E8B\u52A1\u7684\u8BBF\u95EE\u6A21\u5F0F\u4E0D\u80FD\u540C\u65F6\u5373\u8BBE\u7F6E\u4E3A<code>\u53EA\u8BFB</code>\u7684\u4E5F\u8BBE\u7F6E\u4E3A<code>\u8BFB\u5199</code>\u7684\uFF0C\u6240\u4EE5\u4E0D\u80FD\u540C\u65F6\u628A<code>READ ONLY</code>\u548C<code>READ WRITE</code>\u653E\u5230<code>START TRANSACTION</code>\u8BED\u53E5\u540E\u8FB9\u3002</li><li>\u5982\u679C\u6211\u4EEC\u4E0D\u663E\u5F0F\u6307\u5B9A\u4E8B\u52A1\u7684\u8BBF\u95EE\u6A21\u5F0F\uFF0C\u90A3\u4E48\u8BE5\u4E8B\u52A1\u7684\u8BBF\u95EE\u6A21\u5F0F\u5C31\u662F<code>\u8BFB\u5199</code>\u6A21\u5F0F</li></ul><p>**\u6B65\u9AA42\uFF1A**\u4E00\u7CFB\u5217\u4E8B\u52A1\u4E2D\u7684\u64CD\u4F5C\uFF08\u4E3B\u8981\u662FDML\uFF0C\u4E0D\u542BDDL\uFF09</p><p>**\u6B65\u9AA43\uFF1A**\u63D0\u4EA4\u4E8B\u52A1 \u6216 \u4E2D\u6B62\u4E8B\u52A1\uFF08\u5373\u56DE\u6EDA\u4E8B\u52A1\uFF09</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u63D0\u4EA4\u4E8B\u52A1\u3002\u5F53\u63D0\u4EA4\u4E8B\u52A1\u540E\uFF0C\u5BF9\u6570\u636E\u5E93\u7684\u4FEE\u6539\u662F\u6C38\u4E45\u6027\u7684\u3002
mysql&gt; COMMIT;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u56DE\u6EDA\u4E8B\u52A1\u3002\u5373\u64A4\u9500\u6B63\u5728\u8FDB\u884C\u7684\u6240\u6709\u6CA1\u6709\u63D0\u4EA4\u7684\u4FEE\u6539
mysql&gt; ROLLBACK;

# \u5C06\u4E8B\u52A1\u56DE\u6EDA\u5230\u67D0\u4E2A\u4FDD\u5B58\u70B9\u3002
mysql&gt; ROLLBACK TO [SAVEPOINT]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D\u5173\u4E8ESAVEPOINT\u76F8\u5173\u64CD\u4F5C\u6709\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u5728\u4E8B\u52A1\u4E2D\u521B\u5EFA\u4FDD\u5B58\u70B9\uFF0C\u65B9\u4FBF\u540E\u7EED\u9488\u5BF9\u4FDD\u5B58\u70B9\u8FDB\u884C\u56DE\u6EDA\u3002\u4E00\u4E2A\u4E8B\u52A1\u4E2D\u53EF\u4EE5\u5B58\u5728\u591A\u4E2A\u4FDD\u5B58\u70B9\u3002
SAVEPOINT \u4FDD\u5B58\u70B9\u540D\u79F0;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u5220\u9664\u67D0\u4E2A\u4FDD\u5B58\u70B9
RELEASE SAVEPOINT \u4FDD\u5B58\u70B9\u540D\u79F0;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-2-\u9690\u5F0F\u4E8B\u52A1" tabindex="-1"><a class="header-anchor" href="#_2-2-\u9690\u5F0F\u4E8B\u52A1" aria-hidden="true">#</a> 2.2 \u9690\u5F0F\u4E8B\u52A1</h5><p>MySQL\u4E2D\u6709\u4E00\u4E2A\u7CFB\u7EDF\u53D8\u91CF <code>autocommit</code> \uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; SHOW VARIABLES LIKE &#39;autocommit&#39;;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    |  ON   |
+---------------+-------+
1 row in set (0.01 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F53\u7136\uFF0C\u5982\u679C\u6211\u4EEC\u60F3\u5173\u95ED\u8FD9\u79CD <code>\u81EA\u52A8\u63D0\u4EA4</code> \u7684\u529F\u80FD\uFF0C\u53EF\u4EE5\u4F7F\u7528\u4E0B\u8FB9\u4E24\u79CD\u65B9\u6CD5\u4E4B\u4E00\uFF1A</p><ul><li><p>\u663E\u5F0F\u7684\u7684\u4F7F\u7528 <code>START TRANSACTION</code> \u6216\u8005 <code>BEGIN</code> \u8BED\u53E5\u5F00\u542F\u4E00\u4E2A\u4E8B\u52A1\u3002\u8FD9\u6837\u5728\u672C\u6B21\u4E8B\u52A1\u63D0\u4EA4\u6216\u8005\u56DE\u6EDA\u524D\u4F1A\u6682\u65F6\u5173\u95ED\u6389\u81EA\u52A8\u63D0\u4EA4\u7684\u529F\u80FD\u3002</p></li><li><p>\u628A\u7CFB\u7EDF\u53D8\u91CF <code>autocommit</code> \u7684\u503C\u8BBE\u7F6E\u4E3A <code>OFF</code> \uFF0C\u5C31\u50CF\u8FD9\u6837\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>SET autocommit = OFF;
#\u6216
SET autocommit = 0;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h5 id="_2-3-\u9690\u5F0F\u63D0\u4EA4\u6570\u636E\u7684\u60C5\u51B5" tabindex="-1"><a class="header-anchor" href="#_2-3-\u9690\u5F0F\u63D0\u4EA4\u6570\u636E\u7684\u60C5\u51B5" aria-hidden="true">#</a> 2.3 \u9690\u5F0F\u63D0\u4EA4\u6570\u636E\u7684\u60C5\u51B5</h5><ul><li><p>\u6570\u636E\u5B9A\u4E49\u8BED\u8A00\uFF08Data definition language\uFF0C\u7F29\u5199\u4E3A\uFF1ADDL\uFF09</p><p>\u6570\u636E\u5E93\u5BF9\u8C61\uFF0C\u6307\u7684\u5C31\u662F<code>\u6570\u636E\u5E93\u3001\u8868\u3001\u89C6\u56FE\u3001\u5B58\u50A8\u8FC7\u7A0B</code>\u7B49\u7ED3\u6784\u3002\u5F53\u6211\u4EEC<code>CREATE\u3001ALTER\u3001DROP</code>\u7B49\u8BED\u53E5\u53BB\u4FEE\u6539\u6570\u636E\u5E93\u5BF9\u8C61\u65F6\uFF0C\u5C31\u4F1A\u9690\u5F0F\u7684\u63D0\u4EA4\u524D\u8FB9\u8BED\u53E5\u6240\u5C5E\u4E8E\u7684\u4E8B\u7269\u3002\u5373\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;

SELECT ... # \u4E8B\u52A1\u4E2D\u7684\u4E00\u6761\u8BED\u53E5
UPDATE ... # \u4E8B\u52A1\u4E2D\u7684\u4E00\u6761\u8BED\u53E5
... # \u4E8B\u52A1\u4E2D\u7684\u5176\u4ED6\u8BED\u53E5

CREATE TABLE ... # \u6B64\u8BED\u53E5\u4F1A\u9690\u5F0F\u7684\u63D0\u4EA4\u524D\u8FB9\u8BED\u53E5\u6240\u5C5E\u4E8E\u7684\u4E8B\u52A1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>\u9690\u5F0F\u4F7F\u7528\u6216\u4FEE\u6539mysql\u6570\u636E\u5E93\u4E2D\u7684\u8868</p><p>\u5F53\u6211\u4EEC\u4F7F\u7528<code>ALTER USER</code>\u3001<code>CREATE USER</code>\u3001<code>DROP USER</code>\u3001<code>GRANT</code>\u3001<code>RENAME USER</code>\u3001<code>REVOKE</code>\u3001<code>SET PASSWORD</code>\u7B49\u8BED\u53E5\u65F6\u4E5F\u4F1A\u9690\u5F0F\u7684\u63D0\u4EA4\u524D\u8FB9\u8BED\u53E5\u6240\u5C5E\u4E8E\u7684\u4E8B\u52A1\u3002</p></li><li><p>\u4E8B\u52A1\u63A7\u5236\u6216\u5173\u4E8E\u9501\u5B9A\u7684\u8BED\u53E5</p><p>\u2460 \u5F53\u6211\u4EEC\u5728\u4E00\u4E2A\u4E8B\u52A1\u8FD8\u6CA1\u63D0\u4EA4\u6216\u8005\u56DE\u6EDA\u65F6\u5C31\u53C8\u4F7F\u7528 START TRANSACTION \u6216\u8005 BEGIN \u8BED\u53E5\u5F00\u542F\u4E86\u53E6\u4E00\u4E2A\u4E8B\u52A1\u65F6\uFF0C\u4F1A\u9690\u5F0F\u7684\u63D0\u4EA4\u4E0A\u4E00\u4E2A\u4E8B\u52A1\u3002\u5373\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;

SELECT ... # \u4E8B\u52A1\u4E2D\u7684\u4E00\u6761\u8BED\u53E5
UPDATE ... # \u4E8B\u52A1\u4E2D\u7684\u4E00\u6761\u8BED\u53E5
... # \u4E8B\u52A1\u4E2D\u7684\u5176\u4ED6\u8BED\u53E5

BEGIN; # \u6B64\u8BED\u53E5\u4F1A\u9690\u5F0F\u7684\u63D0\u4EA4\u524D\u8FB9\u8BED\u53E5\u6240\u5C5E\u4E8E\u7684\u4E8B\u52A1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u2461 \u5F53\u524D\u7684 autocommit \u7CFB\u7EDF\u53D8\u91CF\u7684\u503C\u4E3A OFF \uFF0C\u6211\u4EEC\u624B\u52A8\u628A\u5B83\u8C03\u4E3A ON \u65F6\uFF0C\u4E5F\u4F1A \u9690\u5F0F\u7684\u63D0\u4EA4\u524D\u8FB9\u8BED\u53E5\u6240\u5C5E\u7684\u4E8B\u52A1\u3002</p><p>\u2462 \u4F7F\u7528 LOCK TABLES \u3001 UNLOCK TABLES \u7B49\u5173\u4E8E\u9501\u5B9A\u7684\u8BED\u53E5\u4E5F\u4F1A \u9690\u5F0F\u7684\u63D0\u4EA4 \u524D\u8FB9\u8BED\u53E5\u6240\u5C5E\u7684\u4E8B\u52A1\u3002</p></li><li><p>\u52A0\u8F7D\u6570\u636E\u7684\u8BED\u53E5</p><p>\u4F7F\u7528<code>LOAD DATA</code>\u8BED\u53E5\u6765\u6279\u91CF\u5F80\u6570\u636E\u5E93\u4E2D\u5BFC\u5165\u6570\u636E\u65F6\uFF0C\u4E5F\u4F1A<code>\u9690\u5F0F\u7684\u63D0\u4EA4</code>\u524D\u8FB9\u8BED\u53E5\u6240\u5C5E\u7684\u4E8B\u52A1\u3002</p></li><li><p>\u5173\u4E8EMySQL\u590D\u5236\u7684\u4E00\u4E9B\u8BED\u53E5</p><p>\u4F7F\u7528<code>START SLAVE\u3001STOP SLAVE\u3001RESET SLAVE\u3001CHANGE MASTER TO</code>\u7B49\u8BED\u53E5\u4F1A\u9690\u5F0F\u7684\u63D0\u4EA4\u524D\u8FB9\u8BED\u53E5\u6240\u5C5E\u7684\u4E8B\u52A1</p></li><li><p>\u5176\u4ED6\u7684\u4E00\u4E9B\u8BED\u53E5</p><p>\u4F7F\u7528<code>ANALYZE TABLE\u3001CACHE INDEX\u3001CAECK TABLE\u3001FLUSH\u3001LOAD INDEX INTO CACHE\u3001OPTIMIZE TABLE\u3001REPAIR TABLE\u3001RESET</code>\u7B49\u8BED\u53E5\u4E5F\u4F1A\u9690\u5F0F\u7684\u63D0\u4EA4\u524D\u8FB9\u8BED\u53E5\u6240\u5C5E\u7684\u4E8B\u52A1\u3002</p></li></ul><h5 id="_2-4-\u4F7F\u7528\u4E3E\u4F8B1-\u63D0\u4EA4\u4E0E\u56DE\u6EDA" tabindex="-1"><a class="header-anchor" href="#_2-4-\u4F7F\u7528\u4E3E\u4F8B1-\u63D0\u4EA4\u4E0E\u56DE\u6EDA" aria-hidden="true">#</a> 2.4 \u4F7F\u7528\u4E3E\u4F8B1\uFF1A\u63D0\u4EA4\u4E0E\u56DE\u6EDA</h5><p>\u6211\u4EEC\u770B\u4E0B\u5728 MySQL \u7684\u9ED8\u8BA4\u72B6\u6001\u4E0B\uFF0C\u4E0B\u9762\u8FD9\u4E2A\u4E8B\u52A1\u6700\u540E\u7684\u5904\u7406\u7ED3\u679C\u662F\u4EC0\u4E48\u3002</p><p><strong>\u60C5\u51B51\uFF1A</strong></p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE user(name varchar(20), PRIMARY KEY (name)) ENGINE=InnoDB;

BEGIN;
INSERT INTO user SELECT &#39;\u5F20\u4E09&#39;;
COMMIT;

BEGIN;
INSERT INTO user SELECT &#39;\u674E\u56DB&#39;;
INSERT INTO user SELECT &#39;\u674E\u56DB&#39;;
ROLLBACK;

SELECT * FROM user;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD0\u884C\u7ED3\u679C\uFF081 \u884C\u6570\u636E\uFF09\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; commit;
Query OK, 0 rows affected (0.00 \u79D2)

mysql&gt; BEGIN;
Query OK, 0 rows affected (0.00 \u79D2)

mysql&gt; INSERT INTO user SELECT &#39;\u674E\u56DB&#39;;
Query OK, 1 rows affected (0.00 \u79D2)

mysql&gt; INSERT INTO user SELECT &#39;\u674E\u56DB&#39;;
Duplicate entry &#39;\u674E\u56DB&#39; for key &#39;user.PRIMARY&#39;
mysql&gt; ROLLBACK;
Query OK, 0 rows affected (0.01 \u79D2)

mysql&gt; select * from user;
+--------+
| name   |
+--------+
| \u5F20\u4E09    |
+--------+
1 \u884C\u4E8E\u6570\u636E\u96C6 (0.01 \u79D2)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u60C5\u51B52\uFF1A</strong></p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE user (name varchar(20), PRIMARY KEY (name)) ENGINE=InnoDB;

BEGIN;
INSERT INTO user SELECT &#39;\u5F20\u4E09&#39;;
COMMIT;

INSERT INTO user SELECT &#39;\u674E\u56DB&#39;;
INSERT INTO user SELECT &#39;\u674E\u56DB&#39;;
ROLLBACK;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD0\u884C\u7ED3\u679C\uFF082 \u884C\u6570\u636E\uFF09\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; SELECT * FROM user;
+--------+
| name   |
+--------+
| \u5F20\u4E09    |
| \u674E\u56DB    |
+--------+
2 \u884C\u4E8E\u6570\u636E\u96C6 (0.01 \u79D2)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u60C5\u51B53\uFF1A</strong></p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE user(name varchar(255), PRIMARY KEY (name)) ENGINE=InnoDB;

SET @@completion_type = 1;
BEGIN;
INSERT INTO user SELECT &#39;\u5F20\u4E09&#39;;
COMMIT;

INSERT INTO user SELECT &#39;\u674E\u56DB&#39;;
INSERT INTO user SELECT &#39;\u674E\u56DB&#39;;
ROLLBACK;

SELECT * FROM user;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD0\u884C\u7ED3\u679C\uFF081 \u884C\u6570\u636E\uFF09\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; SELECT * FROM user;
+--------+
| name   |
+--------+
| \u5F20\u4E09    |
+--------+
1 \u884C\u4E8E\u6570\u636E\u96C6 (0.01 \u79D2)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708201221316.png" alt="image-20220708201221316" style="float:left;"><blockquote><p>\u5F53\u6211\u4EEC\u8BBE\u7F6E autocommit=0 \u65F6\uFF0C\u4E0D\u8BBA\u662F\u5426\u91C7\u7528 START TRANSACTION \u6216\u8005 BEGIN \u7684\u65B9\u5F0F\u6765\u5F00\u542F\u4E8B \u52A1\uFF0C\u90FD\u9700\u8981\u7528 COMMIT \u8FDB\u884C\u63D0\u4EA4\uFF0C\u8BA9\u4E8B\u52A1\u751F\u6548\uFF0C\u4F7F\u7528 ROLLBACK \u5BF9\u4E8B\u52A1\u8FDB\u884C\u56DE\u6EDA\u3002</p><p>\u5F53\u6211\u4EEC\u8BBE\u7F6E autocommit=1 \u65F6\uFF0C\u6BCF\u6761 SQL \u8BED\u53E5\u90FD\u4F1A\u81EA\u52A8\u8FDB\u884C\u63D0\u4EA4\u3002 \u4E0D\u8FC7\u8FD9\u65F6\uFF0C\u5982\u679C\u4F60\u91C7\u7528 START TRANSACTION \u6216\u8005 BEGIN \u7684\u65B9\u5F0F\u6765\u663E\u5F0F\u5730\u5F00\u542F\u4E8B\u52A1\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u4E8B\u52A1\u53EA\u6709\u5728 COMMIT \u65F6\u624D\u4F1A\u751F\u6548\uFF0C \u5728 ROLLBACK \u65F6\u624D\u4F1A\u56DE\u6EDA\u3002</p></blockquote><h5 id="_2-5-\u4F7F\u7528\u4E3E\u4F8B2-\u6D4B\u8BD5\u4E0D\u652F\u6301\u4E8B\u52A1\u7684engine" tabindex="-1"><a class="header-anchor" href="#_2-5-\u4F7F\u7528\u4E3E\u4F8B2-\u6D4B\u8BD5\u4E0D\u652F\u6301\u4E8B\u52A1\u7684engine" aria-hidden="true">#</a> 2.5 \u4F7F\u7528\u4E3E\u4F8B2\uFF1A\u6D4B\u8BD5\u4E0D\u652F\u6301\u4E8B\u52A1\u7684engine</h5><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE test1(i INT) ENGINE=InnoDB;

CREATE TABLE test2(i INT) ENGINE=MYISAM;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u9488\u5BF9\u4E8EInnoDB\u8868</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;
INSERT INTO test1 VALUES(1);
ROLLBACK;

SELECT * FROM test1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7ED3\u679C\uFF1A\u6CA1\u6709\u6570\u636E</p><p>\u9488\u5BF9\u4E8EMYISAM\u8868\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;
INSERT INTO test1 VALUES(1);
ROLLBACK;

SELECT * FROM test2;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7ED3\u679C\uFF1A\u6709\u4E00\u6761\u6570\u636E</p><h5 id="_2-6-\u4F7F\u7528\u4E3E\u4F8B3-savepoint" tabindex="-1"><a class="header-anchor" href="#_2-6-\u4F7F\u7528\u4E3E\u4F8B3-savepoint" aria-hidden="true">#</a> 2.6 \u4F7F\u7528\u4E3E\u4F8B3\uFF1ASAVEPOINT</h5><p>\u521B\u5EFA\u8868\u5E76\u6DFB\u52A0\u6570\u636E\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE account(
id INT PRIMARY KEY AUTO_INCREMENT,
NAME VARCHAR(15),
balance DECIMAL(10,2)
);

INSERT INTO account(NAME,balance)
VALUES
(&#39;\u5F20\u4E09&#39;,1000),
(&#39;\u674E\u56DB&#39;,1000);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;
UPDATE account SET balance = balance - 100 WHERE NAME = &#39;\u5F20\u4E09&#39;;
UPDATE account SET balance = balance - 100 WHERE NAME = &#39;\u5F20\u4E09&#39;;
SAVEPOINT s1; # \u8BBE\u7F6E\u4FDD\u5B58\u70B9
UPDATE account SET balance = balance + 1 WHERE NAME = &#39;\u5F20\u4E09&#39;;
ROLLBACK TO s1; # \u56DE\u6EDA\u5230\u4FDD\u5B58\u70B9
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7ED3\u679C\uFF1A\u5F20\u4E09\uFF1A800.00</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>ROLLBACK;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u7ED3\u679C\uFF1A\u5F20\u4E09\uFF1A1000.00</p><h3 id="_3-\u4E8B\u52A1\u9694\u79BB\u7EA7\u522B" tabindex="-1"><a class="header-anchor" href="#_3-\u4E8B\u52A1\u9694\u79BB\u7EA7\u522B" aria-hidden="true">#</a> 3. \u4E8B\u52A1\u9694\u79BB\u7EA7\u522B</h3><p>MySQL\u662F\u4E00\u4E2A <code>\u5BA2\u6237\u7AEF\uFF0F\u670D\u52A1\u5668</code> \u67B6\u6784\u7684\u8F6F\u4EF6\uFF0C\u5BF9\u4E8E\u540C\u4E00\u4E2A\u670D\u52A1\u5668\u6765\u8BF4\uFF0C\u53EF\u4EE5\u6709\u82E5\u5E72\u4E2A\u5BA2\u6237\u7AEF\u4E0E\u4E4B\u8FDE\u63A5\uFF0C\u6BCF \u4E2A\u5BA2\u6237\u7AEF\u4E0E\u670D\u52A1\u5668\u8FDE\u63A5\u4E0A\u4E4B\u540E\uFF0C\u5C31\u53EF\u4EE5\u79F0\u4E3A\u4E00\u4E2A\u4F1A\u8BDD\uFF08 <code>Session</code> \uFF09\u3002\u6BCF\u4E2A\u5BA2\u6237\u7AEF\u90FD\u53EF\u4EE5\u5728\u81EA\u5DF1\u7684\u4F1A\u8BDD\u4E2D \u5411\u670D\u52A1\u5668\u53D1\u51FA\u8BF7\u6C42\u8BED\u53E5\uFF0C\u4E00\u4E2A\u8BF7\u6C42\u8BED\u53E5\u53EF\u80FD\u662F\u67D0\u4E2A\u4E8B\u52A1\u7684\u4E00\u90E8\u5206\uFF0C\u4E5F\u5C31\u662F\u5BF9\u4E8E\u670D\u52A1\u5668\u6765\u8BF4\u53EF\u80FD\u540C\u65F6\u5904\u7406\u591A\u4E2A\u4E8B\u52A1\u3002\u4E8B\u52A1\u6709 <code>\u9694\u79BB\u6027</code> \u7684\u7279\u6027\uFF0C\u7406\u8BBA\u4E0A\u5728\u67D0\u4E2A\u4E8B\u52A1 <code>\u5BF9\u67D0\u4E2A\u6570\u636E\u8FDB\u884C\u8BBF\u95EE</code> \u65F6\uFF0C\u5176\u4ED6\u4E8B\u52A1\u5E94\u8BE5\u8FDB\u884C<code>\u6392\u961F</code> \uFF0C\u5F53\u8BE5\u4E8B\u52A1\u63D0\u4EA4\u4E4B\u540E\uFF0C\u5176\u4ED6\u4E8B\u52A1\u624D\u53EF\u4EE5\u7EE7\u7EED\u8BBF\u95EE\u8FD9\u4E2A\u6570\u636E\u3002\u4F46\u662F\u8FD9\u6837\u5BF9 <code>\u6027\u80FD\u5F71\u54CD\u592A\u5927</code> \uFF0C\u6211\u4EEC\u65E2\u60F3\u4FDD\u6301\u4E8B\u52A1\u7684\u9694\u79BB\u6027\uFF0C\u53C8\u60F3\u8BA9\u670D\u52A1\u5668\u5728\u5904\u7406\u8BBF\u95EE\u540C\u4E00\u6570\u636E\u7684\u591A\u4E2A\u4E8B\u52A1\u65F6 <code>\u6027\u80FD\u5C3D\u91CF\u9AD8\u4E9B</code> \uFF0C\u90A3\u5C31\u770B\u4E8C\u8005\u5982\u4F55\u6743\u8861\u53D6 \u820D\u4E86\u3002</p><h5 id="_3-1-\u6570\u636E\u51C6\u5907" tabindex="-1"><a class="header-anchor" href="#_3-1-\u6570\u636E\u51C6\u5907" aria-hidden="true">#</a> 3.1 \u6570\u636E\u51C6\u5907</h5><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE student (
    studentno INT,
    name VARCHAR(20),
    class varchar(20),
    PRIMARY KEY (studentno)
) Engine=InnoDB CHARSET=utf8;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u5411\u8FD9\u4E2A\u8868\u91CC\u63D2\u5165\u4E00\u6761\u6570\u636E\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>INSERT INTO student VALUES(1, &#39;\u5C0F\u8C37&#39;, &#39;1\u73ED&#39;);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u73B0\u5728\u8868\u91CC\u7684\u6570\u636E\u5C31\u662F\u8FD9\u6837\u7684\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; select * from student;
+-----------+--------+-------+
| studentno | name   | class |
+-----------+--------+-------+
|      1    |   \u5C0F\u8C37  | 1\u73ED   |
+-----------+--------+-------+
1 row in set (0.00 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-2-\u6570\u636E\u5E76\u53D1\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#_3-2-\u6570\u636E\u5E76\u53D1\u95EE\u9898" aria-hidden="true">#</a> 3.2 \u6570\u636E\u5E76\u53D1\u95EE\u9898</h5><p>\u9488\u5BF9\u4E8B\u52A1\u7684\u9694\u79BB\u6027\u548C\u5E76\u53D1\u6027\uFF0C\u6211\u4EEC\u600E\u4E48\u505A\u53D6\u820D\u5462\uFF1F\u5148\u770B\u4E00\u4E0B\u8BBF\u95EE\u76F8\u540C\u6570\u636E\u7684\u4E8B\u52A1\u5728 \u4E0D\u4FDD\u8BC1\u4E32\u884C\u6267\u884C \uFF08\u4E5F \u5C31\u662F\u6267\u884C\u5B8C\u4E00\u4E2A\u518D\u6267\u884C\u53E6\u4E00\u4E2A\uFF09\u7684\u60C5\u51B5\u4E0B\u53EF\u80FD\u4F1A\u51FA\u73B0\u54EA\u4E9B\u95EE\u9898\uFF1A</p><p><strong>1. \u810F\u5199\uFF08 Dirty Write \uFF09</strong></p><p>\u5BF9\u4E8E\u4E24\u4E2A\u4E8B\u52A1 Session A\u3001Session B\uFF0C\u5982\u679C\u4E8B\u52A1Session A <code>\u4FEE\u6539\u4E86</code> \u53E6\u4E00\u4E2A <code>\u672A\u63D0\u4EA4</code> \u4E8B\u52A1Session B <code>\u4FEE\u6539\u8FC7</code> \u7684\u6570\u636E\uFF0C\u90A3\u5C31\u610F\u5473\u7740\u53D1\u751F\u4E86 <code>\u810F\u5199</code>\uFF0C\u793A\u610F\u56FE\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708214453902.png" alt="image-20220708214453902"></p><p>Session A \u548C Session B \u5404\u5F00\u542F\u4E86\u4E00\u4E2A\u4E8B\u52A1\uFF0CSesssion B \u4E2D\u7684\u4E8B\u52A1\u5148\u5C06studentno\u5217\u4E3A1\u7684\u8BB0\u5F55\u7684name\u5217\u66F4\u65B0\u4E3A&#39;\u674E\u56DB&#39;\uFF0C\u7136\u540ESession A\u4E2D\u7684\u4E8B\u52A1\u63A5\u7740\u53C8\u628A\u8FD9\u6761studentno\u5217\u4E3A1\u7684\u8BB0\u5F55\u7684name\u5217\u66F4\u65B0\u4E3A&#39;\u5F20\u4E09&#39;\u3002\u5982\u679C\u4E4B\u540ESession B\u4E2D\u7684\u4E8B\u52A1\u8FDB\u884C\u4E86\u56DE\u6EDA\uFF0C\u90A3\u4E48Session A\u4E2D\u7684\u66F4\u65B0\u4E5F\u5C06\u4E0D\u590D\u5B58\u5728\uFF0C\u8FD9\u79CD\u73B0\u8C61\u79F0\u4E4B\u4E3A\u810F\u5199\u3002\u8FD9\u65F6Session A\u4E2D\u7684\u4E8B\u52A1\u5C31\u6CA1\u6709\u6548\u679C\u4E86\uFF0C\u660E\u660E\u628A\u6570\u636E\u66F4\u65B0\u4E86\uFF0C\u6700\u540E\u4E5F\u63D0\u4EA4\u4E8B\u52A1\u4E86\uFF0C\u6700\u540E\u770B\u5230\u7684\u6570\u636E\u4EC0\u4E48\u53D8\u5316\u4E5F\u6CA1\u6709\u3002\u8FD9\u91CC\u5927\u5BB6\u5BF9\u4E8B\u52A1\u7684\u9694\u79BB\u6027\u6BD4\u8F83\u4E86\u89E3\u7684\u8BDD\uFF0C\u4F1A\u53D1\u73B0\u9ED8\u8BA4\u9694\u79BB\u7EA7\u522B\u4E0B\uFF0C\u4E0A\u9762Session A\u4E2D\u7684\u66F4\u65B0\u8BED\u53E5\u4F1A\u5904\u4E8E\u7B49\u5F85\u72B6\u6001\uFF0C\u8FD9\u91CC\u53EA\u662F\u8DDF\u5927\u5BB6\u8BF4\u660E\u4E00\u4E0B\u4F1A\u51FA\u73B0\u8FD9\u6837\u7684\u73B0\u8C61\u3002</p><p><strong>2. \u810F\u8BFB\uFF08 Dirty Read \uFF09</strong></p><p>\u5BF9\u4E8E\u4E24\u4E2A\u4E8B\u52A1 Session A\u3001Session B\uFF0CSession A <code>\u8BFB\u53D6</code> \u4E86\u5DF2\u7ECF\u88AB Session B <code>\u66F4\u65B0</code> \u4F46\u8FD8 <code>\u6CA1\u6709\u88AB\u63D0\u4EA4</code> \u7684\u5B57\u6BB5\u3002 \u4E4B\u540E\u82E5 Session B <code>\u56DE\u6EDA</code> \uFF0CSession A <code>\u8BFB\u53D6 </code>\u7684\u5185\u5BB9\u5C31\u662F <code>\u4E34\u65F6\u4E14\u65E0\u6548</code> \u7684\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708215109480.png" alt="image-20220708215109480"></p><p>Session A\u548CSession B\u5404\u5F00\u542F\u4E86\u4E00\u4E2A\u4E8B\u52A1\uFF0CSession B\u4E2D\u7684\u4E8B\u52A1\u5148\u5C06studentno\u5217\u4E3A1\u7684\u8BB0\u5F55\u7684name\u5217\u66F4\u65B0 \u4E3A&#39;\u5F20\u4E09&#39;\uFF0C\u7136\u540ESession A\u4E2D\u7684\u4E8B\u52A1\u518D\u53BB\u67E5\u8BE2\u8FD9\u6761studentno\u4E3A1\u7684\u8BB0\u5F55\uFF0C\u5982\u679C\u8BFB\u5230\u5217name\u7684\u503C\u4E3A&#39;\u5F20\u4E09&#39;\uFF0C\u800C Session B\u4E2D\u7684\u4E8B\u52A1\u7A0D\u540E\u8FDB\u884C\u4E86\u56DE\u6EDA\uFF0C\u90A3\u4E48Session A\u4E2D\u7684\u4E8B\u52A1\u76F8\u5F53\u4E8E\u8BFB\u5230\u4E86\u4E00\u4E2A\u4E0D\u5B58\u5728\u7684\u6570\u636E\uFF0C\u8FD9\u79CD\u73B0\u8C61\u5C31\u79F0\u4E4B\u4E3A <code>\u810F\u8BFB</code> \u3002</p><p><strong>3. \u4E0D\u53EF\u91CD\u590D\u8BFB\uFF08 Non-Repeatable Read \uFF09</strong></p><p>\u5BF9\u4E8E\u4E24\u4E2A\u4E8B\u52A1Session A\u3001Session B\uFF0CSession A <code>\u8BFB\u53D6</code>\u4E86\u4E00\u4E2A\u5B57\u6BB5\uFF0C\u7136\u540E Session B <code>\u66F4\u65B0</code>\u4E86\u8BE5\u5B57\u6BB5\u3002 \u4E4B\u540E Session A <code>\u518D\u6B21\u8BFB\u53D6</code> \u540C\u4E00\u4E2A\u5B57\u6BB5\uFF0C <code>\u503C\u5C31\u4E0D\u540C</code> \u4E86\u3002\u90A3\u5C31\u610F\u5473\u7740\u53D1\u751F\u4E86\u4E0D\u53EF\u91CD\u590D\u8BFB\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708215626435.png" alt="image-20220708215626435"></p><p>\u6211\u4EEC\u5728Session B\u4E2D\u63D0\u4EA4\u4E86\u51E0\u4E2A <code>\u9690\u5F0F\u4E8B\u52A1</code> \uFF08\u6CE8\u610F\u662F\u9690\u5F0F\u4E8B\u52A1\uFF0C\u610F\u5473\u7740\u8BED\u53E5\u7ED3\u675F\u4E8B\u52A1\u5C31\u63D0\u4EA4\u4E86\uFF09\uFF0C\u8FD9\u4E9B\u4E8B\u52A1 \u90FD\u4FEE\u6539\u4E86studentno\u5217\u4E3A1\u7684\u8BB0\u5F55\u7684\u5217name\u7684\u503C\uFF0C\u6BCF\u6B21\u4E8B\u52A1\u63D0\u4EA4\u4E4B\u540E\uFF0C\u5982\u679CSession A\u4E2D\u7684\u4E8B\u52A1\u90FD\u53EF\u4EE5\u67E5\u770B\u5230\u6700\u65B0\u7684\u503C\uFF0C\u8FD9\u79CD\u73B0\u8C61\u4E5F\u88AB\u79F0\u4E4B\u4E3A <code>\u4E0D\u53EF\u91CD\u590D\u8BFB </code>\u3002</p><p><strong>4. \u5E7B\u8BFB\uFF08 Phantom \uFF09</strong></p><p>\u5BF9\u4E8E\u4E24\u4E2A\u4E8B\u52A1Session A\u3001Session B, Session A \u4ECE\u4E00\u4E2A\u8868\u4E2D <code>\u8BFB\u53D6</code> \u4E86\u4E00\u4E2A\u5B57\u6BB5, \u7136\u540E Session B \u5728\u8BE5\u8868\u4E2D \u63D2 \u5165 \u4E86\u4E00\u4E9B\u65B0\u7684\u884C\u3002 \u4E4B\u540E, \u5982\u679C Session A <code>\u518D\u6B21\u8BFB\u53D6</code> \u540C\u4E00\u4E2A\u8868, \u5C31\u4F1A\u591A\u51FA\u51E0\u884C\u3002\u90A3\u5C31\u610F\u5473\u7740\u53D1\u751F\u4E86<code>\u5E7B\u8BFB</code>\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708220102342.png" alt="image-20220708220102342"></p><p>Session A\u4E2D\u7684\u4E8B\u52A1\u5148\u6839\u636E\u6761\u4EF6 studentno &gt; 0\u8FD9\u4E2A\u6761\u4EF6\u67E5\u8BE2\u8868student\uFF0C\u5F97\u5230\u4E86name\u5217\u503C\u4E3A&#39;\u5F20\u4E09&#39;\u7684\u8BB0\u5F55\uFF1B \u4E4B\u540ESession B\u4E2D\u63D0\u4EA4\u4E86\u4E00\u4E2A <code>\u9690\u5F0F\u4E8B\u52A1</code> \uFF0C\u8BE5\u4E8B\u52A1\u5411\u8868student\u4E2D\u63D2\u5165\u4E86\u4E00\u6761\u65B0\u8BB0\u5F55\uFF1B\u4E4B\u540ESession A\u4E2D\u7684\u4E8B\u52A1 \u518D\u6839\u636E\u76F8\u540C\u7684\u6761\u4EF6 studentno &gt; 0\u67E5\u8BE2\u8868student\uFF0C\u5F97\u5230\u7684\u7ED3\u679C\u96C6\u4E2D\u5305\u542BSession B\u4E2D\u7684\u4E8B\u52A1\u65B0\u63D2\u5165\u7684\u90A3\u6761\u8BB0 \u5F55\uFF0C\u8FD9\u79CD\u73B0\u8C61\u4E5F\u88AB\u79F0\u4E4B\u4E3A \u5E7B\u8BFB \u3002\u6211\u4EEC\u628A\u65B0\u63D2\u5165\u7684\u90A3\u4E9B\u8BB0\u5F55\u79F0\u4E4B\u4E3A <code>\u5E7B\u5F71\u8BB0\u5F55</code> \u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708220228436.png" alt="image-20220708220228436" style="float:left;"><h5 id="_3-3-sql\u4E2D\u7684\u56DB\u79CD\u9694\u79BB\u7EA7\u522B" tabindex="-1"><a class="header-anchor" href="#_3-3-sql\u4E2D\u7684\u56DB\u79CD\u9694\u79BB\u7EA7\u522B" aria-hidden="true">#</a> 3.3 SQL\u4E2D\u7684\u56DB\u79CD\u9694\u79BB\u7EA7\u522B</h5><p>\u4E0A\u9762\u4ECB\u7ECD\u4E86\u51E0\u79CD\u5E76\u53D1\u4E8B\u52A1\u6267\u884C\u8FC7\u7A0B\u4E2D\u53EF\u80FD\u9047\u5230\u7684\u4E00\u4E9B\u95EE\u9898\uFF0C\u8FD9\u4E9B\u95EE\u9898\u6709\u8F7B\u91CD\u7F13\u6025\u4E4B\u5206\uFF0C\u6211\u4EEC\u7ED9\u8FD9\u4E9B\u95EE\u9898 \u6309\u7167\u4E25\u91CD\u6027\u6765\u6392\u4E00\u4E0B\u5E8F\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>\u810F\u5199 &gt; \u810F\u8BFB &gt; \u4E0D\u53EF\u91CD\u590D\u8BFB &gt; \u5E7B\u8BFB
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u6211\u4EEC\u613F\u610F\u820D\u5F03\u4E00\u90E8\u5206\u9694\u79BB\u6027\u6765\u6362\u53D6\u4E00\u90E8\u5206\u6027\u80FD\u5728\u8FD9\u91CC\u5C31\u4F53\u73B0\u5728\uFF1A\u8BBE\u7ACB\u4E00\u4E9B\u9694\u79BB\u7EA7\u522B\uFF0C\u9694\u79BB\u7EA7\u522B\u8D8A\u4F4E\uFF0C\u5E76\u53D1\u95EE\u9898\u53D1\u751F\u7684\u5C31\u8D8A\u591A\u3002 <code>SQL\u6807\u51C6</code> \u4E2D\u8BBE\u7ACB\u4E864\u4E2A <code>\u9694\u79BB\u7EA7\u522B</code> \uFF1A</p><ul><li><code>READ UNCOMMITTED</code> \uFF1A\u8BFB\u672A\u63D0\u4EA4\uFF0C\u5728\u8BE5\u9694\u79BB\u7EA7\u522B\uFF0C\u6240\u6709\u4E8B\u52A1\u90FD\u53EF\u4EE5\u770B\u5230\u5176\u4ED6\u672A\u63D0\u4EA4\u4E8B\u52A1\u7684\u6267\u884C\u7ED3 \u679C\u3002\u4E0D\u80FD\u907F\u514D\u810F\u8BFB\u3001\u4E0D\u53EF\u91CD\u590D\u8BFB\u3001\u5E7B\u8BFB\u3002</li><li><code>READ COMMITTED</code> \uFF1A\u8BFB\u5DF2\u63D0\u4EA4\uFF0C\u5B83\u6EE1\u8DB3\u4E86\u9694\u79BB\u7684\u7B80\u5355\u5B9A\u4E49\uFF1A\u4E00\u4E2A\u4E8B\u52A1\u53EA\u80FD\u770B\u89C1\u5DF2\u7ECF\u63D0\u4EA4\u4E8B\u52A1\u6240\u505A \u7684\u6539\u53D8\u3002\u8FD9\u662F\u5927\u591A\u6570\u6570\u636E\u5E93\u7CFB\u7EDF\u7684\u9ED8\u8BA4\u9694\u79BB\u7EA7\u522B\uFF08\u4F46\u4E0D\u662FMySQL\u9ED8\u8BA4\u7684\uFF09\u3002\u53EF\u4EE5\u907F\u514D\u810F\u8BFB\uFF0C\u4F46\u4E0D\u53EF \u91CD\u590D\u8BFB\u3001\u5E7B\u8BFB\u95EE\u9898\u4ECD\u7136\u5B58\u5728\u3002</li><li><code>REPEATABLE READ</code> \uFF1A\u53EF\u91CD\u590D\u8BFB\uFF0C\u4E8B\u52A1A\u5728\u8BFB\u5230\u4E00\u6761\u6570\u636E\u4E4B\u540E\uFF0C\u6B64\u65F6\u4E8B\u52A1B\u5BF9\u8BE5\u6570\u636E\u8FDB\u884C\u4E86\u4FEE\u6539\u5E76\u63D0 \u4EA4\uFF0C\u90A3\u4E48\u4E8B\u52A1A\u518D\u8BFB\u8BE5\u6570\u636E\uFF0C\u8BFB\u5230\u7684\u8FD8\u662F\u539F\u6765\u7684\u5185\u5BB9\u3002\u53EF\u4EE5\u907F\u514D\u810F\u8BFB\u3001\u4E0D\u53EF\u91CD\u590D\u8BFB\uFF0C\u4F46\u5E7B\u8BFB\u95EE\u9898\u4ECD \u7136\u5B58\u5728\u3002\u8FD9\u662FMySQL\u7684\u9ED8\u8BA4\u9694\u79BB\u7EA7\u522B\u3002</li><li><code>SERIALIZABLE</code> \uFF1A\u53EF\u4E32\u884C\u5316\uFF0C\u786E\u4FDD\u4E8B\u52A1\u53EF\u4EE5\u4ECE\u4E00\u4E2A\u8868\u4E2D\u8BFB\u53D6\u76F8\u540C\u7684\u884C\u3002\u5728\u8FD9\u4E2A\u4E8B\u52A1\u6301\u7EED\u671F\u95F4\uFF0C\u7981\u6B62 \u5176\u4ED6\u4E8B\u52A1\u5BF9\u8BE5\u8868\u6267\u884C\u63D2\u5165\u3001\u66F4\u65B0\u548C\u5220\u9664\u64CD\u4F5C\u3002\u6240\u6709\u7684\u5E76\u53D1\u95EE\u9898\u90FD\u53EF\u4EE5\u907F\u514D\uFF0C\u4F46\u6027\u80FD\u5341\u5206\u4F4E\u4E0B\u3002\u80FD\u907F \u514D\u810F\u8BFB\u3001\u4E0D\u53EF\u91CD\u590D\u8BFB\u548C\u5E7B\u8BFB\u3002</li></ul><p><code>SQL\u6807\u51C6</code> \u4E2D\u89C4\u5B9A\uFF0C\u9488\u5BF9\u4E0D\u540C\u7684\u9694\u79BB\u7EA7\u522B\uFF0C\u5E76\u53D1\u4E8B\u52A1\u53EF\u4EE5\u53D1\u751F\u4E0D\u540C\u4E25\u91CD\u7A0B\u5EA6\u7684\u95EE\u9898\uFF0C\u5177\u4F53\u60C5\u51B5\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708220917267.png" alt="image-20220708220917267"></p><p><code>\u810F\u5199 </code>\u600E\u4E48\u6CA1\u6D89\u53CA\u5230\uFF1F\u56E0\u4E3A\u810F\u5199\u8FD9\u4E2A\u95EE\u9898\u592A\u4E25\u91CD\u4E86\uFF0C\u4E0D\u8BBA\u662F\u54EA\u79CD\u9694\u79BB\u7EA7\u522B\uFF0C\u90FD\u4E0D\u5141\u8BB8\u810F\u5199\u7684\u60C5\u51B5\u53D1\u751F\u3002</p><p>\u4E0D\u540C\u7684\u9694\u79BB\u7EA7\u522B\u6709\u4E0D\u540C\u7684\u73B0\u8C61\uFF0C\u5E76\u6709\u4E0D\u540C\u7684\u9501\u548C\u5E76\u53D1\u673A\u5236\uFF0C\u9694\u79BB\u7EA7\u522B\u8D8A\u9AD8\uFF0C\u6570\u636E\u5E93\u7684\u5E76\u53D1\u6027\u80FD\u5C31\u8D8A\u5DEE\uFF0C4 \u79CD\u4E8B\u52A1\u9694\u79BB\u7EA7\u522B\u4E0E\u5E76\u53D1\u6027\u80FD\u7684\u5173\u7CFB\u5982\u4E0B\uFF1A</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708220957108.png" alt="image-20220708220957108" style="zoom:80%;"><h5 id="_3-4-mysql\u652F\u6301\u7684\u56DB\u79CD\u9694\u79BB\u7EA7\u522B" tabindex="-1"><a class="header-anchor" href="#_3-4-mysql\u652F\u6301\u7684\u56DB\u79CD\u9694\u79BB\u7EA7\u522B" aria-hidden="true">#</a> 3.4 MySQL\u652F\u6301\u7684\u56DB\u79CD\u9694\u79BB\u7EA7\u522B</h5><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708221639979.png" alt="image-20220708221639979" style="float:left;"><p>MySQL\u7684\u9ED8\u8BA4\u9694\u79BB\u7EA7\u522B\u4E3AREPEATABLE READ\uFF0C\u6211\u4EEC\u53EF\u4EE5\u624B\u52A8\u4FEE\u6539\u4E00\u4E0B\u4E8B\u52A1\u7684\u9694\u79BB\u7EA7\u522B\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u67E5\u770B\u9694\u79BB\u7EA7\u522B\uFF0CMySQL 5.7.20\u7684\u7248\u672C\u4E4B\u524D\uFF1A
mysql&gt; SHOW VARIABLES LIKE &#39;tx_isolation&#39;;
+---------------+-----------------+
| Variable_name | Value           |
+---------------+-----------------+
| tx_isolation  | REPEATABLE-READ |
+---------------+-----------------+
1 row in set (0.00 sec)
# MySQL 5.7.20\u7248\u672C\u4E4B\u540E\uFF0C\u5F15\u5165transaction_isolation\u6765\u66FF\u6362tx_isolation

# \u67E5\u770B\u9694\u79BB\u7EA7\u522B\uFF0CMySQL 5.7.20\u7684\u7248\u672C\u53CA\u4E4B\u540E\uFF1A
mysql&gt; SHOW VARIABLES LIKE &#39;transaction_isolation&#39;;
+-----------------------+-----------------+
| Variable_name         | Value           |
+-----------------------+-----------------+
| transaction_isolation | REPEATABLE-READ |
+-----------------------+-----------------+
1 row in set (0.02 sec)

#\u6216\u8005\u4E0D\u540CMySQL\u7248\u672C\u4E2D\u90FD\u53EF\u4EE5\u4F7F\u7528\u7684\uFF1A
SELECT @@transaction_isolation;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-5-\u5982\u4F55\u8BBE\u7F6E\u4E8B\u52A1\u7684\u9694\u79BB\u7EA7\u522B" tabindex="-1"><a class="header-anchor" href="#_3-5-\u5982\u4F55\u8BBE\u7F6E\u4E8B\u52A1\u7684\u9694\u79BB\u7EA7\u522B" aria-hidden="true">#</a> 3.5 \u5982\u4F55\u8BBE\u7F6E\u4E8B\u52A1\u7684\u9694\u79BB\u7EA7\u522B</h5><p><strong>\u901A\u8FC7\u4E0B\u9762\u7684\u8BED\u53E5\u4FEE\u6539\u4E8B\u52A1\u7684\u9694\u79BB\u7EA7\u522B\uFF1A</strong></p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>SET [GLOBAL|SESSION] TRANSACTION ISOLATION LEVEL \u9694\u79BB\u7EA7\u522B;
#\u5176\u4E2D\uFF0C\u9694\u79BB\u7EA7\u522B\u683C\u5F0F\uFF1A
&gt; READ UNCOMMITTED
&gt; READ COMMITTED
&gt; REPEATABLE READ
&gt; SERIALIZABLE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6216\u8005\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>SET [GLOBAL|SESSION] TRANSACTION_ISOLATION = &#39;\u9694\u79BB\u7EA7\u522B&#39;
#\u5176\u4E2D\uFF0C\u9694\u79BB\u7EA7\u522B\u683C\u5F0F\uFF1A
&gt; READ-UNCOMMITTED
&gt; READ-COMMITTED
&gt; REPEATABLE-READ
&gt; SERIALIZABLE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u5173\u4E8E\u8BBE\u7F6E\u65F6\u4F7F\u7528GLOBAL\u6216SESSION\u7684\u5F71\u54CD\uFF1A</strong></p><ul><li><p>\u4F7F\u7528 GLOBAL \u5173\u952E\u5B57\uFF08\u5728\u5168\u5C40\u8303\u56F4\u5F71\u54CD\uFF09\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>SET GLOBAL TRANSACTION ISOLATION LEVEL SERIALIZABLE;
#\u6216
SET GLOBAL TRANSACTION_ISOLATION = &#39;SERIALIZABLE&#39;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5219\uFF1A</p><ul><li>\u5F53\u524D\u5DF2\u7ECF\u5B58\u5728\u7684\u4F1A\u8BDD\u65E0\u6548</li><li>\u53EA\u5BF9\u6267\u884C\u5B8C\u8BE5\u8BED\u53E5\u4E4B\u540E\u4EA7\u751F\u7684\u4F1A\u8BDD\u8D77\u4F5C\u7528</li></ul></li><li><p>\u4F7F\u7528 <code>SESSION</code> \u5173\u952E\u5B57\uFF08\u5728\u4F1A\u8BDD\u8303\u56F4\u5F71\u54CD\uFF09\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;
#\u6216
SET SESSION TRANSACTION_ISOLATION = &#39;SERIALIZABLE&#39;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5219\uFF1A</p><ul><li>\u5BF9\u5F53\u524D\u4F1A\u8BDD\u7684\u6240\u6709\u540E\u7EED\u7684\u4E8B\u52A1\u6709\u6548</li><li>\u5982\u679C\u5728\u4E8B\u52A1\u4E4B\u95F4\u6267\u884C\uFF0C\u5219\u5BF9\u540E\u7EED\u7684\u4E8B\u52A1\u6709\u6548</li><li>\u8BE5\u8BED\u53E5\u53EF\u4EE5\u5728\u5DF2\u7ECF\u5F00\u542F\u7684\u4E8B\u52A1\u4E2D\u95F4\u6267\u884C\uFF0C\u4F46\u4E0D\u4F1A\u5F71\u54CD\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684\u4E8B\u52A1</li></ul></li></ul><p>\u5982\u679C\u5728\u670D\u52A1\u5668\u542F\u52A8\u65F6\u60F3\u6539\u53D8\u4E8B\u52A1\u7684\u9ED8\u8BA4\u9694\u79BB\u7EA7\u522B\uFF0C\u53EF\u4EE5\u4FEE\u6539\u542F\u52A8\u53C2\u6570<code>transaction_isolation</code>\u7684\u503C\u3002\u6BD4\u5982\uFF0C\u5728\u542F\u52A8\u670D\u52A1\u5668\u65F6\u6307\u5B9A\u4E86<code>transaction_isolation=SERIALIZABLE</code>\uFF0C\u90A3\u4E48\u4E8B\u52A1\u7684\u9ED8\u8BA4\u9694\u79BB\u754C\u522B\u5C31\u4ECE\u539F\u6765\u7684<code>REPEATABLE-READ</code>\u53D8\u6210\u4E86<code>SERIALIZABLE</code>\u3002</p><blockquote><p>\u5C0F\u7ED3\uFF1A</p><p>\u6570\u636E\u5E93\u89C4\u5B9A\u4E86\u591A\u79CD\u4E8B\u52A1\u9694\u79BB\u7EA7\u522B\uFF0C\u4E0D\u540C\u9694\u79BB\u7EA7\u522B\u5BF9\u5E94\u4E0D\u540C\u7684\u5E72\u6270\u7A0B\u5EA6\uFF0C\u9694\u79BB\u7EA7\u522B\u8D8A\u9AD8\uFF0C\u6570\u636E\u4E00\u81F4\u6027\u5C31\u8D8A\u597D\uFF0C\u4F46\u5E76\u53D1\u6027\u8D8A\u5F31\u3002</p></blockquote><h5 id="_3-6-\u4E0D\u540C\u9694\u79BB\u7EA7\u522B\u4E3E\u4F8B" tabindex="-1"><a class="header-anchor" href="#_3-6-\u4E0D\u540C\u9694\u79BB\u7EA7\u522B\u4E3E\u4F8B" aria-hidden="true">#</a> 3.6 \u4E0D\u540C\u9694\u79BB\u7EA7\u522B\u4E3E\u4F8B</h5><p>\u521D\u59CB\u5316\u6570\u636E\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>TRUNCATE TABLE account;
INSERT INTO account VALUES (1,&#39;\u5F20\u4E09&#39;,&#39;100&#39;), (2,&#39;\u674E\u56DB&#39;,&#39;0&#39;);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220708223250773.png" alt="image-20220708223250773" style="float:left;"><p><strong>\u6F14\u793A1. \u8BFB\u672A\u63D0\u4EA4\u4E4B\u810F\u8BFB</strong></p><p>\u8BBE\u7F6E\u9694\u79BB\u7EA7\u522B\u4E3A\u672A\u63D0\u4EA4\u8BFB\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710193920008.png" alt="image-20220710193920008"></p><p>\u810F\u8BFB\u5C31\u662F\u6307\u5F53\u524D\u4E8B\u52A1\u5C31\u5728\u8BBF\u95EE\u6570\u636E\uFF0C\u5E76\u4E14\u5BF9\u6570\u636E\u8FDB\u884C\u4E86\u4FEE\u6539\uFF0C\u800C\u8FD9\u79CD\u4FEE\u6539\u8FD8\u6CA1\u6709\u63D0\u4EA4\u5230\u6570\u636E\u5E93\u4E2D\uFF0C\u8FD9\u65F6\uFF0C\u53E6\u5916\u4E00\u4E2A\u4E8B\u52A1\u4E5F\u8BBF\u95EE\u4E86\u8FD9\u4E2A\u6570\u636E\uFF0C\u7136\u540E\u4F7F\u7528\u4E86\u8FD9\u4E2A\u6570\u636E\u3002</p><p><strong>\u6F14\u793A2\uFF1A\u8BFB\u5DF2\u63D0\u4EA4</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710194440101.png" alt="image-20220710194440101"></p><p><strong>\u6F14\u793A3. \u4E0D\u53EF\u91CD\u590D\u8BFB</strong></p><p>\u8BBE\u7F6E\u9694\u79BB\u7EA7\u522B\u4E3A\u53EF\u91CD\u590D\u8BFB\uFF0C\u4E8B\u52A1\u7684\u6267\u884C\u6D41\u7A0B\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710194144826.png" alt="image-20220710194144826"></p><p>\u5F53\u6211\u4EEC\u5C06\u5F53\u524D\u4F1A\u8BDD\u7684\u9694\u79BB\u7EA7\u522B\u8BBE\u7F6E\u4E3A\u53EF\u91CD\u590D\u8BFB\u7684\u65F6\u5019\uFF0C\u5F53\u524D\u4F1A\u8BDD\u53EF\u4EE5\u91CD\u590D\u8BFB\uFF0C\u5C31\u662F\u6BCF\u6B21\u8BFB\u53D6\u7684\u7ED3\u679C\u96C6\u90FD\u76F8\u540C\uFF0C\u800C\u4E0D\u7BA1\u5176\u4ED6\u4E8B\u52A1\u6709\u6CA1\u6709\u63D0\u4EA4\u3002\u4F46\u662F\u5728\u53EF\u91CD\u590D\u8BFB\u7684\u9694\u79BB\u7EA7\u522B\u4E0A\u4F1A\u51FA\u73B0\u5E7B\u8BFB\u7684\u95EE\u9898\u3002</p><p><strong>\u6F14\u793A4\uFF1A\u5E7B\u8BFB</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710194042096.png" alt="image-20220710194042096"></p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710194612317.png" alt="image-20220710194612317" style="float:left;"><h3 id="_4-\u4E8B\u52A1\u7684\u5E38\u89C1\u5206\u7C7B" tabindex="-1"><a class="header-anchor" href="#_4-\u4E8B\u52A1\u7684\u5E38\u89C1\u5206\u7C7B" aria-hidden="true">#</a> 4. \u4E8B\u52A1\u7684\u5E38\u89C1\u5206\u7C7B</h3><p>\u4ECE\u4E8B\u52A1\u7406\u8BBA\u7684\u89D2\u5EA6\u6765\u770B\uFF0C\u53EF\u4EE5\u628A\u4E8B\u52A1\u5206\u4E3A\u4EE5\u4E0B\u51E0\u79CD\u7C7B\u578B\uFF1A</p><ul><li>\u6241\u5E73\u4E8B\u52A1\uFF08Flat Transactions\uFF09</li><li>\u5E26\u6709\u4FDD\u5B58\u70B9\u7684\u6241\u5E73\u4E8B\u52A1\uFF08Flat Transactions with Savepoints\uFF09</li><li>\u94FE\u4E8B\u52A1\uFF08Chained Transactions\uFF09</li><li>\u5D4C\u5957\u4E8B\u52A1\uFF08Nested Transactions\uFF09</li><li>\u5206\u5E03\u5F0F\u4E8B\u52A1\uFF08Distributed Transactions\uFF09</li></ul><h2 id="\u7B2C14\u7AE0-mysql\u4E8B\u52A1\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#\u7B2C14\u7AE0-mysql\u4E8B\u52A1\u65E5\u5FD7" aria-hidden="true">#</a> \u7B2C14\u7AE0_MySQL\u4E8B\u52A1\u65E5\u5FD7</h2><p>\u4E8B\u52A1\u67094\u79CD\u7279\u6027\uFF1A\u539F\u5B50\u6027\u3001\u4E00\u81F4\u6027\u3001\u9694\u79BB\u6027\u548C\u6301\u4E45\u6027\u3002\u90A3\u4E48\u4E8B\u52A1\u7684\u56DB\u79CD\u7279\u6027\u5230\u5E95\u662F\u57FA\u4E8E\u4EC0\u4E48\u673A\u5236\u5B9E\u73B0\u5462\uFF1F</p><ul><li>\u4E8B\u52A1\u7684\u9694\u79BB\u6027\u7531 <code>\u9501\u673A\u5236</code> \u5B9E\u73B0\u3002</li><li>\u800C\u4E8B\u52A1\u7684\u539F\u5B50\u6027\u3001\u4E00\u81F4\u6027\u548C\u6301\u4E45\u6027\u7531\u4E8B\u52A1\u7684 redo \u65E5\u5FD7\u548Cundo \u65E5\u5FD7\u6765\u4FDD\u8BC1\u3002 <ul><li>REDO LOG \u79F0\u4E3A <code>\u91CD\u505A\u65E5\u5FD7 </code>\uFF0C\u63D0\u4F9B\u518D\u5199\u5165\u64CD\u4F5C\uFF0C\u6062\u590D\u63D0\u4EA4\u4E8B\u52A1\u4FEE\u6539\u7684\u9875\u64CD\u4F5C\uFF0C\u7528\u6765\u4FDD\u8BC1\u4E8B\u52A1\u7684\u6301\u4E45\u6027\u3002</li><li>UNDO LOG \u79F0\u4E3A <code>\u56DE\u6EDA\u65E5\u5FD7</code> \uFF0C\u56DE\u6EDA\u884C\u8BB0\u5F55\u5230\u67D0\u4E2A\u7279\u5B9A\u7248\u672C\uFF0C\u7528\u6765\u4FDD\u8BC1\u4E8B\u52A1\u7684\u539F\u5B50\u6027\u3001\u4E00\u81F4\u6027\u3002</li></ul></li></ul><p>\u6709\u7684DBA\u6216\u8BB8\u4F1A\u8BA4\u4E3A UNDO \u662F REDO \u7684\u9006\u8FC7\u7A0B\uFF0C\u5176\u5B9E\u4E0D\u7136\u3002REDO \u548C UNDO\u90FD\u53EF\u4EE5\u89C6\u4E3A\u662F\u4E00\u79CD <code>\u6062\u590D\u64CD\u4F5C</code>\uFF0C\u4F46\u662F\uFF1A</p><ul><li>redo log: \u662F\u5B58\u50A8\u5F15\u64CE\u5C42 (innodb) \u751F\u6210\u7684\u65E5\u5FD7\uFF0C\u8BB0\u5F55\u7684\u662F<code>&quot;\u7269\u7406\u7EA7\u522B&quot;</code>\u4E0A\u7684\u9875\u4FEE\u6539\u64CD\u4F5C\uFF0C\u6BD4\u5982\u9875\u53F7xxx\uFF0C\u504F\u79FB\u91CFyyy\u5199\u5165\u4E86&#39;zzz&#39;\u6570\u636E\u3002\u4E3B\u8981\u4E3A\u4E86\u4FDD\u8BC1\u6570\u636E\u7684\u53EF\u9760\u6027\u3002</li><li>undo log: \u662F\u5B58\u50A8\u5F15\u64CE\u5C42 (innodb) \u751F\u6210\u7684\u65E5\u5FD7\uFF0C\u8BB0\u5F55\u7684\u662F <code>\u903B\u8F91\u64CD\u4F5C</code> \u65E5\u5FD7\uFF0C\u6BD4\u5982\u5BF9\u67D0\u4E00\u884C\u6570\u636E\u8FDB\u884C\u4E86INSERT\u8BED\u53E5\u64CD\u4F5C\uFF0C\u90A3\u4E48undo log\u5C31\u8BB0\u5F55\u4E00\u6761\u4E0E\u4E4B\u76F8\u53CD\u7684DELETE\u64CD\u4F5C\u3002\u4E3B\u8981\u7528\u4E8E <code>\u4E8B\u52A1\u7684\u56DE\u6EDA</code> (undo log \u8BB0\u5F55\u7684\u662F\u6BCF\u4E2A\u4FEE\u6539\u64CD\u4F5C\u7684 <code>\u9006\u64CD\u4F5C</code>) \u548C <code>\u4E00\u81F4\u6027\u975E\u9501\u5B9A\u8BFB</code> (undo log \u56DE\u6EDA\u884C\u8BB0\u5F55\u5230\u67D0\u79CD\u7279\u5B9A\u7684\u7248\u672C\u2014\u2014MVCC\uFF0C\u5373\u591A\u7248\u672C\u5E76\u53D1\u63A7\u5236)\u3002</li></ul><h3 id="_1-redo\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#_1-redo\u65E5\u5FD7" aria-hidden="true">#</a> 1. redo\u65E5\u5FD7</h3><p>InnoDB\u5B58\u50A8\u5F15\u64CE\u662F\u4EE5<code>\u9875\u4E3A\u5355\u4F4D</code>\u6765\u7BA1\u7406\u5B58\u50A8\u7A7A\u95F4\u7684\u3002\u5728\u771F\u6B63\u8BBF\u95EE\u9875\u9762\u4E4B\u524D\uFF0C\u9700\u8981\u628A\u5728<code>\u78C1\u76D8\u4E0A</code>\u7684\u9875\u7F13\u5B58\u5230\u5185\u5B58\u4E2D\u7684<code>Buffer Pool</code>\u4E4B\u540E\u624D\u53EF\u4EE5\u8BBF\u95EE\u3002\u6240\u6709\u7684\u53D8\u66F4\u90FD\u5FC5\u987B<code>\u5148\u66F4\u65B0\u7F13\u51B2\u6C60</code>\u4E2D\u7684\u6570\u636E\uFF0C\u7136\u540E\u7F13\u51B2\u6C60\u4E2D\u7684<code>\u810F\u9875</code>\u4F1A\u4EE5\u4E00\u5B9A\u7684\u9891\u7387\u88AB\u5237\u5165\u78C1\u76D8 (<code>checkPoint</code>\u673A\u5236)\uFF0C\u901A\u8FC7\u7F13\u51B2\u6C60\u6765\u4F18\u5316CPU\u548C\u78C1\u76D8\u4E4B\u95F4\u7684\u9E3F\u6C9F\uFF0C\u8FD9\u6837\u5C31\u53EF\u4EE5\u4FDD\u8BC1\u6574\u4F53\u7684\u6027\u80FD\u4E0D\u4F1A\u4E0B\u964D\u592A\u5FEB\u3002</p><h5 id="_1-1-\u4E3A\u4EC0\u4E48\u9700\u8981redo\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#_1-1-\u4E3A\u4EC0\u4E48\u9700\u8981redo\u65E5\u5FD7" aria-hidden="true">#</a> 1.1 \u4E3A\u4EC0\u4E48\u9700\u8981REDO\u65E5\u5FD7</h5><p>\u4E00\u65B9\u9762\uFF0C\u7F13\u51B2\u6C60\u53EF\u4EE5\u5E2E\u52A9\u6211\u4EEC\u6D88\u9664CPU\u548C\u78C1\u76D8\u4E4B\u95F4\u7684\u9E3F\u6C9F\uFF0Ccheckpoint\u673A\u5236\u53EF\u4EE5\u4FDD\u8BC1\u6570\u636E\u7684\u6700\u7EC8\u843D\u76D8\uFF0C\u7136 \u800C\u7531\u4E8Echeckpoint <code>\u5E76\u4E0D\u662F\u6BCF\u6B21\u53D8\u66F4\u7684\u65F6\u5019\u5C31\u89E6\u53D1</code> \u7684\uFF0C\u800C\u662Fmaster\u7EBF\u7A0B\u9694\u4E00\u6BB5\u65F6\u95F4\u53BB\u5904\u7406\u7684\u3002\u6240\u4EE5\u6700\u574F\u7684\u60C5 \u51B5\u5C31\u662F\u4E8B\u52A1\u63D0\u4EA4\u540E\uFF0C\u521A\u5199\u5B8C\u7F13\u51B2\u6C60\uFF0C\u6570\u636E\u5E93\u5B95\u673A\u4E86\uFF0C\u90A3\u4E48\u8FD9\u6BB5\u6570\u636E\u5C31\u662F\u4E22\u5931\u7684\uFF0C\u65E0\u6CD5\u6062\u590D\u3002</p><p>\u53E6\u4E00\u65B9\u9762\uFF0C\u4E8B\u52A1\u5305\u542B <code>\u6301\u4E45\u6027</code> \u7684\u7279\u6027\uFF0C\u5C31\u662F\u8BF4\u5BF9\u4E8E\u4E00\u4E2A\u5DF2\u7ECF\u63D0\u4EA4\u7684\u4E8B\u52A1\uFF0C\u5728\u4E8B\u52A1\u63D0\u4EA4\u540E\u5373\u4F7F\u7CFB\u7EDF\u53D1\u751F\u4E86\u5D29\u6E83\uFF0C\u8FD9\u4E2A\u4E8B\u52A1\u5BF9\u6570\u636E\u5E93\u4E2D\u6240\u505A\u7684\u66F4\u6539\u4E5F\u4E0D\u80FD\u4E22\u5931\u3002</p><p>\u90A3\u4E48\u5982\u4F55\u4FDD\u8BC1\u8FD9\u4E2A\u6301\u4E45\u6027\u5462\uFF1F <code>\u4E00\u4E2A\u7B80\u5355\u7684\u505A\u6CD5</code> \uFF1A\u5728\u4E8B\u52A1\u63D0\u4EA4\u5B8C\u6210\u4E4B\u524D\u628A\u8BE5\u4E8B\u52A1\u6240\u4FEE\u6539\u7684\u6240\u6709\u9875\u9762\u90FD\u5237\u65B0 \u5230\u78C1\u76D8\uFF0C\u4F46\u662F\u8FD9\u4E2A\u7B80\u5355\u7C97\u66B4\u7684\u505A\u6CD5\u6709\u4E9B\u95EE\u9898:</p><ul><li><p><strong>\u4FEE\u6539\u91CF\u4E0E\u5237\u65B0\u78C1\u76D8\u5DE5\u4F5C\u91CF\u4E25\u91CD\u4E0D\u6210\u6BD4\u4F8B</strong></p><p>\u6709\u65F6\u5019\u6211\u4EEC\u4EC5\u4EC5\u4FEE\u6539\u4E86\u67D0\u4E2A\u9875\u9762\u4E2D\u7684\u4E00\u4E2A\u5B57\u8282\uFF0C\u4F46\u662F\u6211\u4EEC\u77E5\u9053\u5728InnoDB\u4E2D\u662F\u4EE5\u9875\u4E3A\u5355\u4F4D\u6765\u8FDB\u884C\u78C1\u76D8IO\u7684\uFF0C\u4E5F\u5C31\u662F\u8BF4\u6211\u4EEC\u5728\u8BE5\u4E8B\u52A1\u63D0\u4EA4\u65F6\u4E0D\u5F97\u4E0D\u5C06\u4E00\u4E2A\u5B8C\u6574\u7684\u9875\u9762\u4ECE\u5185\u5B58\u4E2D\u5237\u65B0\u5230\u78C1\u76D8\uFF0C\u6211\u4EEC\u53C8\u77E5\u9053\u4E00\u4E2A\u9ED8\u8BA4\u9875\u9762\u65F616KB\u5927\u5C0F\uFF0C\u53EA\u4FEE\u6539\u4E00\u4E2A\u5B57\u8282\u5C31\u8981\u5237\u65B016KB\u7684\u6570\u636E\u5230\u78C1\u76D8\u4E0A\u663E\u7136\u662F\u5C0F\u9898\u5927\u505A\u4E86\u3002</p></li><li><p><strong>\u968F\u673AIO\u5237\u65B0\u8F83\u6162</strong></p><p>\u4E00\u4E2A\u4E8B\u52A1\u53EF\u80FD\u5305\u542B\u5F88\u591A\u8BED\u53E5\uFF0C\u5373\u4F7F\u662F\u4E00\u6761\u8BED\u53E5\u4E5F\u53EF\u80FD\u4FEE\u6539\u8BB8\u591A\u9875\u9762\uFF0C\u5047\u5982\u8BE5\u4E8B\u52A1\u4FEE\u6539\u7684\u8FD9\u4E9B\u9875\u9762\u53EF\u80FD\u5E76\u4E0D\u76F8\u90BB\uFF0C\u8FD9\u5C31\u610F\u5473\u7740\u5728\u5C06\u67D0\u4E2A\u4E8B\u52A1\u4FEE\u6539\u7684Buffer Pool\u4E2D\u7684\u9875\u9762<code>\u5237\u65B0\u5230\u78C1\u76D8</code>\u65F6\uFF0C\u9700\u8981\u8FDB\u884C\u5F88\u591A\u7684<code>\u968F\u673AIO</code>\uFF0C\u968F\u673AIO\u6BD4\u987A\u5E8FIO\u8981\u6162\uFF0C\u5C24\u5176\u5BF9\u4E8E\u4F20\u7EDF\u7684\u673A\u68B0\u786C\u76D8\u6765\u8BF4\u3002</p></li></ul><p><code>\u53E6\u4E00\u4E2A\u89E3\u51B3\u7684\u601D\u8DEF</code> \uFF1A\u6211\u4EEC\u53EA\u662F\u60F3\u8BA9\u5DF2\u7ECF\u63D0\u4EA4\u4E86\u7684\u4E8B\u52A1\u5BF9\u6570\u636E\u5E93\u4E2D\u6570\u636E\u6240\u505A\u7684\u4FEE\u6539\u6C38\u4E45\u751F\u6548\uFF0C\u5373\u4F7F\u540E\u6765\u7CFB \u7EDF\u5D29\u6E83\uFF0C\u5728\u91CD\u542F\u540E\u4E5F\u80FD\u628A\u8FD9\u79CD\u4FEE\u6539\u6062\u590D\u51FA\u6765\u3002\u6240\u4EE5\u6211\u4EEC\u5176\u5B9E\u6CA1\u6709\u5FC5\u8981\u5728\u6BCF\u6B21\u4E8B\u52A1\u63D0\u4EA4\u65F6\u5C31\u628A\u8BE5\u4E8B\u52A1\u5728\u5185 \u5B58\u4E2D\u4FEE\u6539\u8FC7\u7684\u5168\u90E8\u9875\u9762\u5237\u65B0\u5230\u78C1\u76D8\uFF0C\u53EA\u9700\u8981\u628A \u4FEE\u6539 \u4E86\u54EA\u4E9B\u4E1C\u897F \u8BB0\u5F55\u4E00\u4E0B \u5C31\u597D\u3002\u6BD4\u5982\uFF0C\u67D0\u4E2A\u4E8B\u52A1\u5C06\u7CFB\u7EDF \u8868\u7A7A\u95F4\u4E2D \u7B2C10\u53F7 \u9875\u9762\u4E2D\u504F\u79FB\u91CF\u4E3A 100 \u5904\u7684\u90A3\u4E2A\u5B57\u8282\u7684\u503C 1 \u6539\u6210 2 \u3002\u6211\u4EEC\u53EA\u9700\u8981\u8BB0\u5F55\u4E00\u4E0B\uFF1A\u5C06\u7B2C0\u53F7\u8868 \u7A7A\u95F4\u768410\u53F7\u9875\u9762\u7684\u504F\u79FB\u91CF\u4E3A100\u5904\u7684\u503C\u66F4\u65B0\u4E3A 2</p><p>InnoDB\u5F15\u64CE\u7684\u4E8B\u52A1\u91C7\u7528\u4E86WAL\u6280\u672F (<code>Write-Ahead Logging</code>)\uFF0C\u8FD9\u79CD\u6280\u672F\u7684\u601D\u60F3\u5C31\u662F <code>\u5148\u5199\u65E5\u5FD7\uFF0C\u518D\u5199\u78C1\u76D8</code> \uFF0C\u53EA\u6709\u65E5\u5FD7\u5199\u5165\u6210\u529F\uFF0C\u624D\u7B97\u4E8B\u52A1\u63D0\u4EA4\u6210\u529F\uFF0C\u8FD9\u91CC\u7684\u65E5\u5FD7\u5C31\u662Fredo log\u3002\u5F53\u53D1\u751F\u5B95\u673A\u4E14\u6570\u636E\u672A\u5237\u5230\u78C1\u76D8\u7684\u65F6\u5019\uFF0C\u53EF\u4EE5\u901A\u8FC7redo log\u6765\u6062\u590D\uFF0C\u4FDD\u8BC1ACID\u4E2D\u7684D\uFF0C\u8FD9\u5C31\u662Fredo log\u7684\u4F5C\u7528\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710202517977.png" alt="image-20220710202517977"></p><h5 id="_1-2-redo\u65E5\u5FD7\u7684\u597D\u5904\u3001\u7279\u70B9" tabindex="-1"><a class="header-anchor" href="#_1-2-redo\u65E5\u5FD7\u7684\u597D\u5904\u3001\u7279\u70B9" aria-hidden="true">#</a> 1.2 REDO\u65E5\u5FD7\u7684\u597D\u5904\u3001\u7279\u70B9</h5><h6 id="_1-\u597D\u5904" tabindex="-1"><a class="header-anchor" href="#_1-\u597D\u5904" aria-hidden="true">#</a> 1. \u597D\u5904</h6><ul><li>redo\u65E5\u5FD7 <code>\u964D\u4F4E\u4E86\u5237\u76D8\u9891\u7387 </code></li><li>redo\u65E5\u5FD7 <code>\u5360\u7528\u7684\u7A7A\u95F4\u975E\u5E38\u5C0F</code></li></ul><p>\u5B58\u50A8\u8868\u7A7A\u95F4ID\u3001\u9875\u53F7\u3001\u504F\u79FB\u91CF\u4EE5\u53CA\u9700\u8981\u66F4\u65B0\u7684\u503C\uFF0C\u6240\u9700\u7684\u5B58\u50A8\u7A7A\u95F4\u662F\u5F88\u5C0F\u7684\uFF0C\u5237\u76D8\u5FEB\u3002</p><h6 id="_2-\u7279\u70B9" tabindex="-1"><a class="header-anchor" href="#_2-\u7279\u70B9" aria-hidden="true">#</a> 2. \u7279\u70B9</h6><ul><li><p><strong>redo\u65E5\u5FD7\u662F\u987A\u5E8F\u5199\u5165\u78C1\u76D8\u7684</strong></p><p>\u5728\u6267\u884C\u4E8B\u52A1\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u6BCF\u6267\u884C\u4E00\u6761\u8BED\u53E5\uFF0C\u5C31\u53EF\u80FD\u4EA7\u751F\u82E5\u5E72\u6761redo\u65E5\u5FD7\uFF0C\u8FD9\u4E9B\u65E5\u5FD7\u662F\u6309\u7167<code>\u4EA7\u751F\u7684\u987A\u5E8F\u5199\u5165\u78C1\u76D8\u7684</code>\uFF0C\u4E5F\u5C31\u662F\u4F7F\u7528\u987A\u5E8FIO\uFF0C\u6548\u7387\u6BD4\u968F\u673AIO\u5FEB\u3002</p></li><li><p><strong>\u4E8B\u52A1\u6267\u884C\u8FC7\u7A0B\u4E2D\uFF0Credo log\u4E0D\u65AD\u8BB0\u5F55</strong></p><p>redo log\u8DDFbin log\u7684\u533A\u522B\uFF0Credo log\u662F<code>\u5B58\u50A8\u5F15\u64CE\u5C42</code>\u4EA7\u751F\u7684\uFF0C\u800Cbin log\u662F<code>\u6570\u636E\u5E93\u5C42</code>\u4EA7\u751F\u7684\u3002\u5047\u8BBE\u4E00\u4E2A\u4E8B\u52A1\uFF0C\u5BF9\u8868\u505A10\u4E07\u884C\u7684\u8BB0\u5F55\u63D2\u5165\uFF0C\u5728\u8FD9\u4E2A\u8FC7\u7A0B\u4E2D\uFF0C\u4E00\u76F4\u4E0D\u65AD\u7684\u5F80redo log\u987A\u5E8F\u8BB0\u5F55\uFF0C\u800Cbin log\u4E0D\u4F1A\u8BB0\u5F55\uFF0C\u76F4\u5230\u8FD9\u4E2A\u4E8B\u52A1\u63D0\u4EA4\uFF0C\u624D\u4F1A\u4E00\u6B21\u5199\u5165\u5230bin log\u6587\u4EF6\u4E2D\u3002</p></li></ul><h5 id="_1-3-redo\u7684\u7EC4\u6210" tabindex="-1"><a class="header-anchor" href="#_1-3-redo\u7684\u7EC4\u6210" aria-hidden="true">#</a> 1.3 redo\u7684\u7EC4\u6210</h5><p>Redo log\u53EF\u4EE5\u7B80\u5355\u5206\u4E3A\u4EE5\u4E0B\u4E24\u4E2A\u90E8\u5206\uFF1A</p><ul><li><code>\u91CD\u505A\u65E5\u5FD7\u7684\u7F13\u51B2 (redo log buffer)</code> \uFF0C\u4FDD\u5B58\u5728\u5185\u5B58\u4E2D\uFF0C\u662F\u6613\u5931\u7684\u3002</li></ul><p>\u5728\u670D\u52A1\u5668\u542F\u52A8\u65F6\u5C31\u4F1A\u5411\u64CD\u4F5C\u7CFB\u7EDF\u7533\u8BF7\u4E86\u4E00\u5927\u7247\u79F0\u4E4B\u4E3A redo log buffer \u7684 <code>\u8FDE\u7EED\u5185\u5B58</code> \u7A7A\u95F4\uFF0C\u7FFB\u8BD1\u6210\u4E2D\u6587\u5C31\u662Fredo\u65E5\u5FD7\u7F13\u51B2\u533A\u3002\u8FD9\u7247\u5185\u5B58\u7A7A\u95F4\u88AB\u5212\u5206\u4E3A\u82E5\u5E72\u4E2A\u8FDE\u7EED\u7684<code>redo log block</code>\u3002\u4E00\u4E2Aredo log block\u5360\u7528<code>512\u5B57\u8282</code>\u5927\u5C0F\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710204114543.png" alt="image-20220710204114543"></p><p><strong>\u53C2\u6570\u8BBE\u7F6E\uFF1Ainnodb_log_buffer_size\uFF1A</strong></p><p>redo log buffer \u5927\u5C0F\uFF0C\u9ED8\u8BA4 <code>16M</code> \uFF0C\u6700\u5927\u503C\u662F4096M\uFF0C\u6700\u5C0F\u503C\u4E3A1M\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; show variables like &#39;%innodb_log_buffer_size%&#39;;
+------------------------+----------+
| Variable_name          | Value    |
+------------------------+----------+
| innodb_log_buffer_size | 16777216 |
+------------------------+----------+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>\u91CD\u505A\u65E5\u5FD7\u6587\u4EF6 (redo log file) </code>\uFF0C\u4FDD\u5B58\u5728\u786C\u76D8\u4E2D\uFF0C\u662F\u6301\u4E45\u7684\u3002</li></ul><p>REDO\u65E5\u5FD7\u6587\u4EF6\u5982\u56FE\u6240\u793A\uFF0C\u5176\u4E2D<code>ib_logfile0</code>\u548C<code>ib_logfile1</code>\u5373\u4E3AREDO\u65E5\u5FD7\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710204427616.png" alt="image-20220710204427616"></p><h5 id="_1-4-redo\u7684\u6574\u4F53\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_1-4-redo\u7684\u6574\u4F53\u6D41\u7A0B" aria-hidden="true">#</a> 1.4 redo\u7684\u6574\u4F53\u6D41\u7A0B</h5><p>\u4EE5\u4E00\u4E2A\u66F4\u65B0\u4E8B\u52A1\u4E3A\u4F8B\uFF0Credo log \u6D41\u8F6C\u8FC7\u7A0B\uFF0C\u5982\u4E0B\u56FE\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710204810264-16574572910841.png" alt="image-20220710204810264"></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u7B2C1\u6B65\uFF1A\u5148\u5C06\u539F\u59CB\u6570\u636E\u4ECE\u78C1\u76D8\u4E2D\u8BFB\u5165\u5185\u5B58\u4E2D\u6765\uFF0C\u4FEE\u6539\u6570\u636E\u7684\u5185\u5B58\u62F7\u8D1D
\u7B2C2\u6B65\uFF1A\u751F\u6210\u4E00\u6761\u91CD\u505A\u65E5\u5FD7\u5E76\u5199\u5165redo log buffer\uFF0C\u8BB0\u5F55\u7684\u662F\u6570\u636E\u88AB\u4FEE\u6539\u540E\u7684\u503C
\u7B2C3\u6B65\uFF1A\u5F53\u4E8B\u52A1commit\u65F6\uFF0C\u5C06redo log buffer\u4E2D\u7684\u5185\u5BB9\u5237\u65B0\u5230 redo log file\uFF0C\u5BF9 redo log file\u91C7\u7528\u8FFD\u52A0\u5199\u7684\u65B9\u5F0F
\u7B2C4\u6B65\uFF1A\u5B9A\u671F\u5C06\u5185\u5B58\u4E2D\u4FEE\u6539\u7684\u6570\u636E\u5237\u65B0\u5230\u78C1\u76D8\u4E2D
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u4F53\u4F1A\uFF1A Write-Ahead Log(\u9884\u5148\u65E5\u5FD7\u6301\u4E45\u5316)\uFF1A\u5728\u6301\u4E45\u5316\u4E00\u4E2A\u6570\u636E\u9875\u4E4B\u524D\uFF0C\u5148\u5C06\u5185\u5B58\u4E2D\u76F8\u5E94\u7684\u65E5\u5FD7\u9875\u6301\u4E45\u5316\u3002</p></blockquote><h5 id="_1-5-redo-log\u7684\u5237\u76D8\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_1-5-redo-log\u7684\u5237\u76D8\u7B56\u7565" aria-hidden="true">#</a> 1.5 redo log\u7684\u5237\u76D8\u7B56\u7565</h5><p>redo log\u7684\u5199\u5165\u5E76\u4E0D\u662F\u76F4\u63A5\u5199\u5165\u78C1\u76D8\u7684\uFF0CInnoDB\u5F15\u64CE\u4F1A\u5728\u5199redo log\u7684\u65F6\u5019\u5148\u5199redo log buffer\uFF0C\u4E4B\u540E\u4EE5<code>\u4E00 \u5B9A\u7684\u9891\u7387</code>\u5237\u5165\u5230\u771F\u6B63\u7684redo log file \u4E2D\u3002\u8FD9\u91CC\u7684\u4E00\u5B9A\u9891\u7387\u600E\u4E48\u770B\u5F85\u5462\uFF1F\u8FD9\u5C31\u662F\u6211\u4EEC\u8981\u8BF4\u7684\u5237\u76D8\u7B56\u7565\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710205015302.png" alt="image-20220710205015302"></p><p>\u6CE8\u610F\uFF0Credo log buffer\u5237\u76D8\u5230redo log file\u7684\u8FC7\u7A0B\u5E76\u4E0D\u662F\u771F\u6B63\u7684\u5237\u5230\u78C1\u76D8\u4E2D\u53BB\uFF0C\u53EA\u662F\u5237\u5165\u5230 <code>\u6587\u4EF6\u7CFB\u7EDF\u7F13\u5B58 \uFF08page cache\uFF09</code>\u4E2D\u53BB\uFF08\u8FD9\u662F\u73B0\u4EE3\u64CD\u4F5C\u7CFB\u7EDF\u4E3A\u4E86\u63D0\u9AD8\u6587\u4EF6\u5199\u5165\u6548\u7387\u505A\u7684\u4E00\u4E2A\u4F18\u5316\uFF09\uFF0C\u771F\u6B63\u7684\u5199\u5165\u4F1A\u4EA4\u7ED9\u7CFB\u7EDF\u81EA\u5DF1\u6765\u51B3\u5B9A\uFF08\u6BD4\u5982page cache\u8DB3\u591F\u5927\u4E86\uFF09\u3002\u90A3\u4E48\u5BF9\u4E8EInnoDB\u6765\u8BF4\u5C31\u5B58\u5728\u4E00\u4E2A\u95EE\u9898\uFF0C\u5982\u679C\u4EA4\u7ED9\u7CFB\u7EDF\u6765\u540C \u6B65\uFF0C\u540C\u6837\u5982\u679C\u7CFB\u7EDF\u5B95\u673A\uFF0C\u90A3\u4E48\u6570\u636E\u4E5F\u4E22\u5931\u4E86\uFF08\u867D\u7136\u6574\u4E2A\u7CFB\u7EDF\u5B95\u673A\u7684\u6982\u7387\u8FD8\u662F\u6BD4\u8F83\u5C0F\u7684\uFF09\u3002</p><p>\u9488\u5BF9\u8FD9\u79CD\u60C5\u51B5\uFF0CInnoDB\u7ED9\u51FA <code>innodb_flush_log_at_trx_commit</code> \u53C2\u6570\uFF0C\u8BE5\u53C2\u6570\u63A7\u5236 commit\u63D0\u4EA4\u4E8B\u52A1 \u65F6\uFF0C\u5982\u4F55\u5C06 redo log buffer \u4E2D\u7684\u65E5\u5FD7\u5237\u65B0\u5230 redo log file \u4E2D\u3002\u5B83\u652F\u6301\u4E09\u79CD\u7B56\u7565\uFF1A</p><ul><li><p><code>\u8BBE\u7F6E\u4E3A0</code> \uFF1A\u8868\u793A\u6BCF\u6B21\u4E8B\u52A1\u63D0\u4EA4\u65F6\u4E0D\u8FDB\u884C\u5237\u76D8\u64CD\u4F5C\u3002\uFF08\u7CFB\u7EDF\u9ED8\u8BA4master thread\u6BCF\u96941s\u8FDB\u884C\u4E00\u6B21\u91CD\u505A\u65E5\u5FD7\u7684\u540C\u6B65\uFF09</p><p>\u7B2C1\u6B65\uFF1A\u5148\u5C06\u539F\u59CB\u6570\u636E\u4ECE\u78C1\u76D8\u4E2D\u8BFB\u5165\u5185\u5B58\u4E2D\u6765\uFF0C\u4FEE\u6539\u6570\u636E\u7684\u5185\u5B58\u62F7\u8D1D</p><p>\u7B2C2\u6B65\uFF1A\u751F\u6210\u4E00\u6761\u91CD\u505A\u65E5\u5FD7\u5E76\u5199\u5165redo log buffer\uFF0C\u8BB0\u5F55\u7684\u662F\u6570\u636E\u88AB\u4FEE\u6539\u540E\u7684\u503C</p><p>\u7B2C3\u6B65\uFF1A\u5F53\u4E8B\u52A1commit\u65F6\uFF0C\u5C06redo log buffer\u4E2D\u7684\u5185\u5BB9\u5237\u65B0\u5230 redo log file\uFF0C\u5BF9 redo log file\u91C7\u7528\u8FFD\u52A0 \u5199\u7684\u65B9\u5F0F</p><p>\u7B2C4\u6B65\uFF1A\u5B9A\u671F\u5C06\u5185\u5B58\u4E2D\u4FEE\u6539\u7684\u6570\u636E\u5237\u65B0\u5230\u78C1\u76D8\u4E2D</p></li><li><p><code>\u8BBE\u7F6E\u4E3A1</code> \uFF1A\u8868\u793A\u6BCF\u6B21\u4E8B\u52A1\u63D0\u4EA4\u65F6\u90FD\u5C06\u8FDB\u884C\u540C\u6B65\uFF0C\u5237\u76D8\u64CD\u4F5C\uFF08 \u9ED8\u8BA4\u503C \uFF09</p></li><li><p><code>\u8BBE\u7F6E\u4E3A2</code> \uFF1A\u8868\u793A\u6BCF\u6B21\u4E8B\u52A1\u63D0\u4EA4\u65F6\u90FD\u53EA\u628A redo log buffer \u5185\u5BB9\u5199\u5165 page cache\uFF0C\u4E0D\u8FDB\u884C\u540C\u6B65\u3002\u7531os\u81EA \u5DF1\u51B3\u5B9A\u4EC0\u4E48\u65F6\u5019\u540C\u6B65\u5230\u78C1\u76D8\u6587\u4EF6\u3002</p></li></ul><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710205948156.png" alt="image-20220710205948156" style="float:left;"><p>\u53E6\u5916\uFF0CInnoDB\u5B58\u50A8\u5F15\u64CE\u6709\u4E00\u4E2A\u540E\u53F0\u7EBF\u7A0B\uFF0C\u6BCF\u9694<code>1\u79D2</code>\uFF0C\u5C31\u4F1A\u628A<code>redo log buffer</code>\u4E2D\u7684\u5185\u5BB9\u5199\u5230\u6587\u4EF6\u7CFB\u7EDF\u7F13\u5B58(<code>page cache</code>)\uFF0C\u7136\u540E\u8C03\u7528\u5237\u76D8\u64CD\u4F5C\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710210339724.png" alt="image-20220710210339724"></p><p>\u4E5F\u5C31\u662F\u8BF4\uFF0C\u4E00\u4E2A\u6CA1\u6709\u63D0\u4EA4\u4E8B\u52A1\u7684<code>redo log</code>\u8BB0\u5F55\uFF0C\u4E5F\u53EF\u80FD\u4F1A\u5237\u76D8\u3002\u56E0\u4E3A\u5728\u4E8B\u52A1\u6267\u884C\u8FC7\u7A0B redo log \u8BB0\u5F55\u662F\u4F1A\u5199\u5165 <code>redo log buffer</code>\u4E2D\uFF0C\u8FD9\u4E9Bredo log \u8BB0\u5F55\u4F1A\u88AB<code>\u540E\u53F0\u7EBF\u7A0B</code>\u5237\u76D8\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710210532805.png" alt="image-20220710210532805"></p><p>\u9664\u4E86\u540E\u53F0\u7EBF\u7A0B\u6BCF\u79D2<code>1\u6B21</code>\u7684\u8F6E\u8BE2\u64CD\u4F5C\uFF0C\u8FD8\u6709\u4E00\u79CD\u60C5\u51B5\uFF0C\u5F53<code>redo log buffer</code>\u5360\u7528\u7684\u7A7A\u95F4\u5373\u5C06\u8FBE\u5230<code>innodb_log_buffer_size</code>\uFF08\u8FD9\u4E2A\u53C2\u6570\u9ED8\u8BA4\u662F16M\uFF09\u7684\u4E00\u534A\u7684\u65F6\u5019\uFF0C\u540E\u53F0\u7EBF\u7A0B\u4F1A\u4E3B\u52A8\u5237\u76D8\u3002</p><h5 id="_1-6-\u4E0D\u540C\u5237\u76D8\u7B56\u7565\u6F14\u793A" tabindex="-1"><a class="header-anchor" href="#_1-6-\u4E0D\u540C\u5237\u76D8\u7B56\u7565\u6F14\u793A" aria-hidden="true">#</a> 1.6 \u4E0D\u540C\u5237\u76D8\u7B56\u7565\u6F14\u793A</h5><h6 id="_1-\u6D41\u7A0B\u56FE" tabindex="-1"><a class="header-anchor" href="#_1-\u6D41\u7A0B\u56FE" aria-hidden="true">#</a> 1. \u6D41\u7A0B\u56FE</h6><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710210751414.png" alt="image-20220710210751414" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710211318120.png" alt="image-20220710211318120" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710211335379.png" alt="image-20220710211335379" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710211618789.png" alt="image-20220710211618789" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710211831675.png" alt="image-20220710211831675" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710212041563.png" alt="image-20220710212041563" style="float:left;"><h6 id="_2-\u4E3E\u4F8B" tabindex="-1"><a class="header-anchor" href="#_2-\u4E3E\u4F8B" aria-hidden="true">#</a> 2. \u4E3E\u4F8B</h6><p>\u6BD4\u8F83innodb_flush_log_at_trx_commit\u5BF9\u4E8B\u52A1\u7684\u5F71\u54CD\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE test_load(
    a INT,
    b CHAR(80)
)ENGINE=INNODB;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>DELIMITER//
CREATE PROCEDURE p_load(COUNT INT UNSIGNED)
BEGIN
DECLARE s INT UNSIGNED DEFAULT 1;
DECLARE c CHAR(80) DEFAULT REPEAT(&#39;a&#39;,80);
WHILE s&lt;=COUNT DO
INSERT INTO test_load SELECT NULL, c;
COMMIT;
SET s=s+1;
END WHILE;
END //
DELIMITER;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710215001482.png" alt="image-20220710215001482" style="float:left;"><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; CALL p_load(30000);
Query OK, 0 rows affected(1 min 23 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>1 min 23 sec</code>\u7684\u65F6\u95F4\u663E\u7136\u662F\u4E0D\u80FD\u63A5\u53D7\u7684\u3002\u800C\u9020\u6210\u65F6\u95F4\u6BD4\u8F83\u957F\u7684\u539F\u56E0\u5C31\u5728\u4E8Efsync\u64CD\u4F5C\u6240\u9700\u8981\u7684\u65F6\u95F4\u3002</p><p>\u4FEE\u6539\u53C2\u6570innodb_flush_log_at_trx_commit\uFF0C\u8BBE\u7F6E\u4E3A0\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; set global innodb_flush_log_at_trx_commit = 0;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; CALL p_load(30000);
Query OK, 0 rows affected(38 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4FEE\u6539\u53C2\u6570innodb_flush_log_at_trx_commit\uFF0C\u8BBE\u7F6E\u4E3A2\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; set global innodb_flush_log_at_trx_commit = 2;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; CALL p_load(30000);
Query OK, 0 rows affected(46 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710215353893.png" alt="image-20220710215353893" style="float:left;"><h5 id="_1-7-\u5199\u5165redo-log-buffer-\u8FC7\u7A0B" tabindex="-1"><a class="header-anchor" href="#_1-7-\u5199\u5165redo-log-buffer-\u8FC7\u7A0B" aria-hidden="true">#</a> 1.7 \u5199\u5165redo log buffer \u8FC7\u7A0B</h5><h6 id="_1-\u8865\u5145\u6982\u5FF5-mini-transaction" tabindex="-1"><a class="header-anchor" href="#_1-\u8865\u5145\u6982\u5FF5-mini-transaction" aria-hidden="true">#</a> 1. \u8865\u5145\u6982\u5FF5\uFF1AMini-Transaction</h6><p>MySQL\u628A\u5BF9\u5E95\u5C42\u9875\u9762\u4E2D\u7684\u4E00\u6B21\u539F\u5B50\u8BBF\u95EE\u8FC7\u7A0B\u79F0\u4E4B\u4E3A\u4E00\u4E2A<code>Mini-Transaction</code>\uFF0C\u7B80\u79F0<code>mtr</code>\uFF0C\u6BD4\u5982\uFF0C\u5411\u67D0\u4E2A\u7D22\u5F15\u5BF9\u5E94\u7684B+\u6811\u4E2D\u63D2\u5165\u4E00\u6761\u8BB0\u5F55\u7684\u8FC7\u7A0B\u5C31\u662F\u4E00\u4E2A<code>Mini-Transaction</code>\u3002\u4E00\u4E2A\u6240\u8C13\u7684<code>mtr</code>\u53EF\u4EE5\u5305\u542B\u4E00\u7EC4redo\u65E5\u5FD7\uFF0C\u5728\u8FDB\u884C\u5D29\u6E83\u6062\u590D\u65F6\u8FD9\u4E00\u7EC4<code>redo</code>\u65E5\u5FD7\u53EF\u4EE5\u4F5C\u4E3A\u4E00\u4E2A\u4E0D\u53EF\u5206\u5272\u7684\u6574\u4F53\u3002</p><p>\u4E00\u4E2A\u4E8B\u52A1\u53EF\u4EE5\u5305\u542B\u82E5\u5E72\u6761\u8BED\u53E5\uFF0C\u6BCF\u4E00\u6761\u8BED\u53E5\u5176\u5B9E\u662F\u7531\u82E5\u5E72\u4E2A <code>mtr</code> \u7EC4\u6210\uFF0C\u6BCF\u4E00\u4E2A <code>mtr</code> \u53C8\u53EF\u4EE5\u5305\u542B\u82E5\u5E72\u6761 redo\u65E5\u5FD7\uFF0C\u753B\u4E2A\u56FE\u8868\u793A\u5B83\u4EEC\u7684\u5173\u7CFB\u5C31\u662F\u8FD9\u6837\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710220653131.png" alt="image-20220710220653131"></p><h6 id="_2-redo-\u65E5\u5FD7\u5199\u5165log-buffer" tabindex="-1"><a class="header-anchor" href="#_2-redo-\u65E5\u5FD7\u5199\u5165log-buffer" aria-hidden="true">#</a> 2. redo \u65E5\u5FD7\u5199\u5165log buffer</h6><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710220838744.png" alt="image-20220710220838744" style="float:left;"><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710220919271.png" alt="image-20220710220919271"></p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710221221981.png" alt="image-20220710221221981" style="float:left;"><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710221318271.png" alt="image-20220710221318271"></p><p>\u4E0D\u540C\u7684\u4E8B\u52A1\u53EF\u80FD\u662F <code>\u5E76\u53D1</code> \u6267\u884C\u7684\uFF0C\u6240\u4EE5 T1 \u3001 T2 \u4E4B\u95F4\u7684 mtr \u53EF\u80FD\u662F <code>\u4EA4\u66FF\u6267\u884C</code> \u7684\u3002\u6CA1\u5F53\u4E00\u4E2Amtr\u6267\u884C\u5B8C\u6210\u65F6\uFF0C\u4F34\u968F\u8BE5mtr\u751F\u6210\u7684\u4E00\u7EC4redo\u65E5\u5FD7\u5C31\u9700\u8981\u88AB\u590D\u5236\u5230log buffer\u4E2D\uFF0C\u4E5F\u5C31\u662F\u8BF4\u4E0D\u540C\u4E8B\u52A1\u7684mtr\u53EF\u80FD\u662F\u4EA4\u66FF\u5199\u5165log buffer\u7684\uFF0C\u6211\u4EEC\u753B\u4E2A\u793A\u610F\u56FE\uFF08\u4E3A\u4E86\u7F8E\u89C2\uFF0C\u6211\u4EEC\u628A\u4E00\u4E2Amtr\u4E2D\u4EA7\u751F\u7684\u6240\u6709redo\u65E5\u5FD7\u5F53\u505A\u4E00\u4E2A\u6574\u4F53\u6765\u753B\uFF09\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710221620291.png" alt="image-20220710221620291"></p><p>\u6709\u7684mtr\u4EA7\u751F\u7684redo\u65E5\u5FD7\u91CF\u975E\u5E38\u5927\uFF0C\u6BD4\u5982<code>mtr_t1_2</code>\u4EA7\u751F\u7684redo\u65E5\u5FD7\u5360\u7528\u7A7A\u95F4\u6BD4\u8F83\u5927\uFF0C\u5360\u7528\u4E863\u4E2Ablock\u6765\u5B58\u50A8\u3002</p><h6 id="_3-redo-log-block\u7684\u7ED3\u6784\u56FE" tabindex="-1"><a class="header-anchor" href="#_3-redo-log-block\u7684\u7ED3\u6784\u56FE" aria-hidden="true">#</a> 3. redo log block\u7684\u7ED3\u6784\u56FE</h6><p>\u4E00\u4E2Aredo log block\u662F\u7531<code>\u65E5\u5FD7\u5934\u3001\u65E5\u5FD7\u4F53\u3001\u65E5\u5FD7\u5C3E</code>\u7EC4\u6210\u3002\u65E5\u5FD7\u5934\u5360\u752812\u5B57\u8282\uFF0C\u65E5\u5FD7\u5C3E\u5360\u75288\u5B57\u8282\uFF0C\u6240\u4EE5\u4E00\u4E2Ablock\u771F\u6B63\u80FD\u5B58\u50A8\u7684\u6570\u636E\u662F512-12-8=492\u5B57\u8282\u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710223117420.png" alt="image-20220710223117420" style="float:left;"><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220710223135374.png" alt="image-20220710223135374"></p><p>\u771F\u6B63\u7684redo\u65E5\u5FD7\u90FD\u662F\u5B58\u50A8\u5230\u5360\u7528<code>496</code>\u5B57\u8282\u5927\u5C0F\u7684<code>log block body</code>\u4E2D\uFF0C\u56FE\u4E2D\u7684<code>log block header</code>\u548C<code>log block trailer</code>\u5B58\u50A8\u7684\u662F\u4E00\u4E9B\u7BA1\u7406\u4FE1\u606F\u3002\u6211\u4EEC\u6765\u770B\u770B\u8FD9\u4E9B\u6240\u8C13<code>\u7BA1\u7406\u4FE1\u606F</code>\u90FD\u6709\u4EC0\u4E48\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711144546439.png" alt="image-20220711144546439"></p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711144608223.png" alt="image-20220711144608223" style="float:left;"><h5 id="_1-8-redo-log-file" tabindex="-1"><a class="header-anchor" href="#_1-8-redo-log-file" aria-hidden="true">#</a> 1.8 redo log file</h5><h6 id="_1-\u76F8\u5173\u53C2\u6570\u8BBE\u7F6E" tabindex="-1"><a class="header-anchor" href="#_1-\u76F8\u5173\u53C2\u6570\u8BBE\u7F6E" aria-hidden="true">#</a> 1. \u76F8\u5173\u53C2\u6570\u8BBE\u7F6E</h6><ul><li><p><code>innodb_log_group_home_dir</code> \uFF1A\u6307\u5B9A redo log \u6587\u4EF6\u7EC4\u6240\u5728\u7684\u8DEF\u5F84\uFF0C\u9ED8\u8BA4\u503C\u4E3A <code>./</code> \uFF0C\u8868\u793A\u5728\u6570\u636E\u5E93 \u7684\u6570\u636E\u76EE\u5F55\u4E0B\u3002MySQL\u7684\u9ED8\u8BA4\u6570\u636E\u76EE\u5F55\uFF08 <code>var/lib/mysql</code>\uFF09\u4E0B\u9ED8\u8BA4\u6709\u4E24\u4E2A\u540D\u4E3A <code>ib_logfile0</code> \u548C <code>ib_logfile1</code> \u7684\u6587\u4EF6\uFF0Clog buffer\u4E2D\u7684\u65E5\u5FD7\u9ED8\u8BA4\u60C5\u51B5\u4E0B\u5C31\u662F\u5237\u65B0\u5230\u8FD9\u4E24\u4E2A\u78C1\u76D8\u6587\u4EF6\u4E2D\u3002\u6B64redo\u65E5\u5FD7 \u6587\u4EF6\u4F4D\u7F6E\u8FD8\u53EF\u4EE5\u4FEE\u6539\u3002</p></li><li><p><code>innodb_log_files_in_group</code>\uFF1A\u6307\u660Eredo log file\u7684\u4E2A\u6570\uFF0C\u547D\u540D\u65B9\u5F0F\u5982\uFF1Aib_logfile0\uFF0Ciblogfile1... iblogfilen\u3002\u9ED8\u8BA42\u4E2A\uFF0C\u6700\u5927100\u4E2A\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; show variables like &#39;innodb_log_files_in_group&#39;;
+---------------------------+-------+
| Variable_name             | Value |
+---------------------------+-------+
| innodb_log_files_in_group | 2     |
+---------------------------+-------+
#ib_logfile0
#ib_logfile1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>innodb_flush_log_at_trx_commit</code>\uFF1A\u63A7\u5236 redo log \u5237\u65B0\u5230\u78C1\u76D8\u7684\u7B56\u7565\uFF0C\u9ED8\u8BA4\u4E3A1\u3002</p></li><li><p><code>innodb_log_file_size</code>\uFF1A\u5355\u4E2A redo log \u6587\u4EF6\u8BBE\u7F6E\u5927\u5C0F\uFF0C\u9ED8\u8BA4\u503C\u4E3A <code>48M</code> \u3002\u6700\u5927\u503C\u4E3A512G\uFF0C\u6CE8\u610F\u6700\u5927\u503C \u6307\u7684\u662F\u6574\u4E2A redo log \u7CFB\u5217\u6587\u4EF6\u4E4B\u548C\uFF0C\u5373\uFF08innodb_log_files_in_group * innodb_log_file_size \uFF09\u4E0D\u80FD\u5927 \u4E8E\u6700\u5927\u503C512G\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; show variables like &#39;innodb_log_file_size&#39;;
+----------------------+----------+
| Variable_name        | Value    |
+----------------------+----------+
| innodb_log_file_size | 50331648 |
+----------------------+----------+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>\u6839\u636E\u4E1A\u52A1\u4FEE\u6539\u5176\u5927\u5C0F\uFF0C\u4EE5\u4FBF\u5BB9\u7EB3\u8F83\u5927\u7684\u4E8B\u52A1\u3002\u7F16\u8F91my.cnf\u6587\u4EF6\u5E76\u91CD\u542F\u6570\u636E\u5E93\u751F\u6548\uFF0C\u5982\u4E0B\u6240\u793A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>[root@localhost ~]# vim /etc/my.cnf
innodb_log_file_size=200M
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u5728\u6570\u636E\u5E93\u5B9E\u4F8B\u66F4\u65B0\u6BD4\u8F83\u9891\u7E41\u7684\u60C5\u51B5\u4E0B\uFF0C\u53EF\u4EE5\u9002\u5F53\u52A0\u5927 redo log \u6570\u7EC4\u548C\u5927\u5C0F\u3002\u4F46\u4E5F\u4E0D\u63A8\u8350 redo log \u8BBE\u7F6E\u8FC7\u5927\uFF0C\u5728MySQL\u5D29\u6E83\u65F6\u4F1A\u91CD\u65B0\u6267\u884CREDO\u65E5\u5FD7\u4E2D\u7684\u8BB0\u5F55\u3002</p></blockquote><h6 id="_2-\u65E5\u5FD7\u6587\u4EF6\u7EC4" tabindex="-1"><a class="header-anchor" href="#_2-\u65E5\u5FD7\u6587\u4EF6\u7EC4" aria-hidden="true">#</a> 2. \u65E5\u5FD7\u6587\u4EF6\u7EC4</h6><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711152137012.png" alt="image-20220711152137012" style="float:left;"><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711152242300.png" alt="image-20220711152242300"></p><p>\u603B\u5171\u7684redo\u65E5\u5FD7\u6587\u4EF6\u5927\u5C0F\u5176\u5B9E\u5C31\u662F\uFF1A <code>innodb_log_file_size \xD7 innodb_log_files_in_group</code> \u3002</p><p>\u91C7\u7528\u5FAA\u73AF\u4F7F\u7528\u7684\u65B9\u5F0F\u5411redo\u65E5\u5FD7\u6587\u4EF6\u7EC4\u91CC\u5199\u6570\u636E\u7684\u8BDD\uFF0C\u4F1A\u5BFC\u81F4\u540E\u5199\u5165\u7684redo\u65E5\u5FD7\u8986\u76D6\u6389\u524D\u8FB9\u5199\u7684redo\u65E5\u5FD7\uFF1F\u5F53\u7136\uFF01\u6240\u4EE5InnoDB\u7684\u8BBE\u8BA1\u8005\u63D0\u51FA\u4E86checkpoint\u7684\u6982\u5FF5\u3002</p><h6 id="_3-checkpoint" tabindex="-1"><a class="header-anchor" href="#_3-checkpoint" aria-hidden="true">#</a> 3. checkpoint</h6><p>\u5728\u6574\u4E2A\u65E5\u5FD7\u6587\u4EF6\u7EC4\u4E2D\u8FD8\u6709\u4E24\u4E2A\u91CD\u8981\u7684\u5C5E\u6027\uFF0C\u5206\u522B\u662F write pos\u3001checkpoint</p><ul><li><code>write pos</code>\u662F\u5F53\u524D\u8BB0\u5F55\u7684\u4F4D\u7F6E\uFF0C\u4E00\u8FB9\u5199\u4E00\u8FB9\u540E\u79FB</li><li><code>checkpoint</code>\u662F\u5F53\u524D\u8981\u64E6\u9664\u7684\u4F4D\u7F6E\uFF0C\u4E5F\u662F\u5F80\u540E\u63A8\u79FB</li></ul><p>\u6BCF\u6B21\u5237\u76D8 redo log \u8BB0\u5F55\u5230\u65E5\u5FD7\u6587\u4EF6\u7EC4\u4E2D\uFF0Cwrite pos \u4F4D\u7F6E\u5C31\u4F1A\u540E\u79FB\u66F4\u65B0\u3002\u6BCF\u6B21MySQL\u52A0\u8F7D\u65E5\u5FD7\u6587\u4EF6\u7EC4\u6062\u590D\u6570\u636E\u65F6\uFF0C\u4F1A\u6E05\u7A7A\u52A0\u8F7D\u8FC7\u7684 redo log \u8BB0\u5F55\uFF0C\u5E76\u628Acheck point\u540E\u79FB\u66F4\u65B0\u3002write pos \u548C checkpoint \u4E4B\u95F4\u7684\u8FD8\u7A7A\u7740\u7684\u90E8\u5206\u53EF\u4EE5\u7528\u6765\u5199\u5165\u65B0\u7684 redo log \u8BB0\u5F55\u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711152631108.png" alt="image-20220711152631108" style="zoom:80%;"><p>\u5982\u679C write pos \u8FFD\u4E0A checkpoint \uFF0C\u8868\u793A<code>\u65E5\u5FD7\u6587\u4EF6\u7EC4</code>\u6EE1\u4E86\uFF0C\u8FD9\u65F6\u5019\u4E0D\u80FD\u518D\u5199\u5165\u65B0\u7684 redo log\u8BB0\u5F55\uFF0CMySQL \u5F97 \u505C\u4E0B\u6765\uFF0C\u6E05\u7A7A\u4E00\u4E9B\u8BB0\u5F55\uFF0C\u628A checkpoint \u63A8\u8FDB\u4E00\u4E0B\u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711152802294.png" alt="image-20220711152802294" style="zoom:80%;"><h5 id="_1-9-redo-log-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_1-9-redo-log-\u5C0F\u7ED3" aria-hidden="true">#</a> 1.9 redo log \u5C0F\u7ED3</h5><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711152930911.png" alt="image-20220711152930911" style="float:left;"><h3 id="_2-undo\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#_2-undo\u65E5\u5FD7" aria-hidden="true">#</a> 2. Undo\u65E5\u5FD7</h3><p>redo log\u662F\u4E8B\u52A1\u6301\u4E45\u6027\u7684\u4FDD\u8BC1\uFF0Cundo log\u662F\u4E8B\u52A1\u539F\u5B50\u6027\u7684\u4FDD\u8BC1\u3002\u5728\u4E8B\u52A1\u4E2D <code>\u66F4\u65B0\u6570\u636E</code> \u7684 <code>\u524D\u7F6E\u64CD\u4F5C</code> \u5176\u5B9E\u662F\u8981\u5148\u5199\u5165\u4E00\u4E2A <code>undo log</code> \u3002</p><h5 id="_2-1-\u5982\u4F55\u7406\u89E3undo\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#_2-1-\u5982\u4F55\u7406\u89E3undo\u65E5\u5FD7" aria-hidden="true">#</a> 2.1 \u5982\u4F55\u7406\u89E3Undo\u65E5\u5FD7</h5><p>\u4E8B\u52A1\u9700\u8981\u4FDD\u8BC1 <code>\u539F\u5B50\u6027 </code>\uFF0C\u4E5F\u5C31\u662F\u4E8B\u52A1\u4E2D\u7684\u64CD\u4F5C\u8981\u4E48\u5168\u90E8\u5B8C\u6210\uFF0C\u8981\u4E48\u4EC0\u4E48\u4E5F\u4E0D\u505A\u3002\u4F46\u6709\u65F6\u5019\u4E8B\u52A1\u6267\u884C\u5230\u4E00\u534A\u4F1A\u51FA\u73B0\u4E00\u4E9B\u60C5\u51B5\uFF0C\u6BD4\u5982\uFF1A</p><ul><li>\u60C5\u51B5\u4E00\uFF1A\u4E8B\u52A1\u6267\u884C\u8FC7\u7A0B\u4E2D\u53EF\u80FD\u9047\u5230\u5404\u79CD\u9519\u8BEF\uFF0C\u6BD4\u5982<code> \u670D\u52A1\u5668\u672C\u8EAB\u7684\u9519\u8BEF</code> \uFF0C <code>\u64CD\u4F5C\u7CFB\u7EDF\u9519\u8BEF</code> \uFF0C\u751A\u81F3\u662F\u7A81\u7136 <code>\u65AD\u7535</code> \u5BFC\u81F4\u7684\u9519\u8BEF\u3002</li><li>\u60C5\u51B5\u4E8C\uFF1A\u7A0B\u5E8F\u5458\u53EF\u4EE5\u5728\u4E8B\u52A1\u6267\u884C\u8FC7\u7A0B\u4E2D\u624B\u52A8\u8F93\u5165 <code>ROLLBACK</code> \u8BED\u53E5\u7ED3\u675F\u5F53\u524D\u4E8B\u52A1\u7684\u6267\u884C\u3002</li></ul><p>\u4EE5\u4E0A\u60C5\u51B5\u51FA\u73B0\uFF0C\u6211\u4EEC\u9700\u8981\u628A\u6570\u636E\u6539\u56DE\u539F\u5148\u7684\u6837\u5B50\uFF0C\u8FD9\u4E2A\u8FC7\u7A0B\u79F0\u4E4B\u4E3A <code>\u56DE\u6EDA</code> \uFF0C\u8FD9\u6837\u5C31\u53EF\u4EE5\u9020\u6210\u4E00\u4E2A\u5047\u8C61\uFF1A\u8FD9 \u4E2A\u4E8B\u52A1\u770B\u8D77\u6765\u4EC0\u4E48\u90FD\u6CA1\u505A\uFF0C\u6240\u4EE5\u7B26\u5408 <code>\u539F\u5B50\u6027</code> \u8981\u6C42\u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711153523704.png" alt="image-20220711153523704" style="float:left;"><h5 id="_2-2-undo\u65E5\u5FD7\u7684\u4F5C\u7528" tabindex="-1"><a class="header-anchor" href="#_2-2-undo\u65E5\u5FD7\u7684\u4F5C\u7528" aria-hidden="true">#</a> 2.2 Undo\u65E5\u5FD7\u7684\u4F5C\u7528</h5><ul><li><strong>\u4F5C\u75281\uFF1A\u56DE\u6EDA\u6570\u636E</strong></li></ul><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711153645204.png" alt="image-20220711153645204" style="float:left;"><ul><li><strong>\u4F5C\u75282\uFF1AMVCC</strong></li></ul><p>undo\u7684\u53E6\u4E00\u4E2A\u4F5C\u7528\u662FMVCC\uFF0C\u5373 <code>\u5728InnoDB\u5B58\u50A8\u5F15\u64CE\u4E2DMVCC\u7684\u5B9E\u73B0\u662F\u901A\u8FC7undo\u6765\u5B8C\u6210</code> \u3002\u5F53\u7528\u6237\u8BFB\u53D6\u4E00\u884C\u8BB0\u5F55\u65F6\uFF0C\u82E5\u8BE5\u8BB0\u5F55\u4EE5\u53CA\u88AB\u5176\u4ED6\u4E8B\u52A1\u5360\u7528\uFF0C\u5F53\u524D\u4E8B\u52A1\u53EF\u4EE5\u901A\u8FC7undo\u8BFB\u53D6\u4E4B\u524D\u7684\u884C\u7248\u672C\u4FE1\u606F\uFF0C\u4EE5\u6B64\u5B9E\u73B0\u975E\u9501\u5B9A\u8BFB\u53D6\u3002</p><h5 id="_2-3-undo\u7684\u5B58\u50A8\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#_2-3-undo\u7684\u5B58\u50A8\u7ED3\u6784" aria-hidden="true">#</a> 2.3 undo\u7684\u5B58\u50A8\u7ED3\u6784</h5><h6 id="_1-\u56DE\u6EDA\u6BB5\u4E0Eundo\u9875" tabindex="-1"><a class="header-anchor" href="#_1-\u56DE\u6EDA\u6BB5\u4E0Eundo\u9875" aria-hidden="true">#</a> 1. \u56DE\u6EDA\u6BB5\u4E0Eundo\u9875</h6><p>InnoDB\u5BF9undo log\u7684\u7BA1\u7406\u91C7\u7528\u6BB5\u7684\u65B9\u5F0F\uFF0C\u4E5F\u5C31\u662F <code>\u56DE\u6EDA\u6BB5\uFF08rollback segment\uFF09</code> \u3002\u6BCF\u4E2A\u56DE\u6EDA\u6BB5\u8BB0\u5F55\u4E86 <code>1024</code> \u4E2A <code>undo log segment</code> \uFF0C\u800C\u5728\u6BCF\u4E2Aundo log segment\u6BB5\u4E2D\u8FDB\u884C <code>undo\u9875</code> \u7684\u7533\u8BF7\u3002</p><ul><li>\u5728<code> InnoDB1.1\u7248\u672C\u4E4B\u524D</code> \uFF08\u4E0D\u5305\u62EC1.1\u7248\u672C\uFF09\uFF0C\u53EA\u6709\u4E00\u4E2Arollback segment\uFF0C\u56E0\u6B64\u652F\u6301\u540C\u65F6\u5728\u7EBF\u7684\u4E8B\u52A1\u9650\u5236\u4E3A <code>1024</code> \u3002\u867D\u7136\u5BF9\u7EDD\u5927\u591A\u6570\u7684\u5E94\u7528\u6765\u8BF4\u90FD\u5DF2\u7ECF\u591F\u7528\u3002</li><li>\u4ECE1.1\u7248\u672C\u5F00\u59CBInnoDB\u652F\u6301\u6700\u5927 <code>128\u4E2Arollback segment</code> \uFF0C\u6545\u5176\u652F\u6301\u540C\u65F6\u5728\u7EBF\u7684\u4E8B\u52A1\u9650\u5236\u63D0\u9AD8\u5230 \u4E86 <code>128*1024</code> \u3002</li></ul><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; show variables like &#39;innodb_undo_logs&#39;;
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| innodb_undo_logs | 128   |
+------------------+-------+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711154936382.png" alt="image-20220711154936382" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711155044078.png" alt="image-20220711155044078" style="float:left;"><h6 id="_2-\u56DE\u6EDA\u6BB5\u4E0E\u4E8B\u52A1" tabindex="-1"><a class="header-anchor" href="#_2-\u56DE\u6EDA\u6BB5\u4E0E\u4E8B\u52A1" aria-hidden="true">#</a> 2. \u56DE\u6EDA\u6BB5\u4E0E\u4E8B\u52A1</h6><ol><li><p>\u6BCF\u4E2A\u4E8B\u52A1\u53EA\u4F1A\u4F7F\u7528\u4E00\u4E2A\u56DE\u6EDA\u6BB5\uFF0C\u4E00\u4E2A\u56DE\u6EDA\u6BB5\u5728\u540C\u4E00\u65F6\u523B\u53EF\u80FD\u4F1A\u670D\u52A1\u4E8E\u591A\u4E2A\u4E8B\u52A1\u3002</p></li><li><p>\u5F53\u4E00\u4E2A\u4E8B\u52A1\u5F00\u59CB\u7684\u65F6\u5019\uFF0C\u4F1A\u5236\u5B9A\u4E00\u4E2A\u56DE\u6EDA\u6BB5\uFF0C\u5728\u4E8B\u52A1\u8FDB\u884C\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u5F53\u6570\u636E\u88AB\u4FEE\u6539\u65F6\uFF0C\u539F\u59CB\u7684\u6570 \u636E\u4F1A\u88AB\u590D\u5236\u5230\u56DE\u6EDA\u6BB5\u3002</p></li><li><p>\u5728\u56DE\u6EDA\u6BB5\u4E2D\uFF0C\u4E8B\u52A1\u4F1A\u4E0D\u65AD\u586B\u5145\u76D8\u533A\uFF0C\u76F4\u5230\u4E8B\u52A1\u7ED3\u675F\u6216\u6240\u6709\u7684\u7A7A\u95F4\u88AB\u7528\u5B8C\u3002\u5982\u679C\u5F53\u524D\u7684\u76D8\u533A\u4E0D\u591F \u7528\uFF0C\u4E8B\u52A1\u4F1A\u5728\u6BB5\u4E2D\u8BF7\u6C42\u6269\u5C55\u4E0B\u4E00\u4E2A\u76D8\u533A\uFF0C\u5982\u679C\u6240\u6709\u5DF2\u5206\u914D\u7684\u76D8\u533A\u90FD\u88AB\u7528\u5B8C\uFF0C\u4E8B\u52A1\u4F1A\u8986\u76D6\u6700\u521D\u7684\u76D8 \u533A\u6216\u8005\u5728\u56DE\u6EDA\u6BB5\u5141\u8BB8\u7684\u60C5\u51B5\u4E0B\u6269\u5C55\u65B0\u7684\u76D8\u533A\u6765\u4F7F\u7528\u3002</p></li><li><p>\u56DE\u6EDA\u6BB5\u5B58\u5728\u4E8Eundo\u8868\u7A7A\u95F4\u4E2D\uFF0C\u5728\u6570\u636E\u5E93\u4E2D\u53EF\u4EE5\u5B58\u5728\u591A\u4E2Aundo\u8868\u7A7A\u95F4\uFF0C\u4F46\u540C\u4E00\u65F6\u523B\u53EA\u80FD\u4F7F\u7528\u4E00\u4E2A undo\u8868\u7A7A\u95F4\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; show variables like &#39;innodb_undo_tablespaces&#39;;
+-------------------------+-------+
| Variable_name           | Value |
+-------------------------+-------+
| innodb_undo_tablespaces | 2     |
+-------------------------+-------+
# undo log\u7684\u6570\u91CF\uFF0C\u6700\u5C11\u4E3A2. undo log\u7684truncate\u64CD\u4F5C\u6709purge\u534F\u8C03\u7EBF\u7A0B\u53D1\u8D77\u3002\u5728truncate\u67D0\u4E2Aundo log\u8868\u7A7A\u95F4\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u4FDD\u8BC1\u6709\u4E00\u4E2A\u53EF\u7528\u7684undo log\u53EF\u7528\u3002
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>\u5F53\u4E8B\u52A1\u63D0\u4EA4\u65F6\uFF0CInnoDB\u5B58\u50A8\u5F15\u64CE\u4F1A\u505A\u4EE5\u4E0B\u4E24\u4EF6\u4E8B\u60C5\uFF1A</p></li></ol><ul><li>\u5C06undo log\u653E\u5165\u5217\u8868\u4E2D\uFF0C\u4EE5\u4F9B\u4E4B\u540E\u7684purge\u64CD\u4F5C</li><li>\u5224\u65ADundo log\u6240\u5728\u7684\u9875\u662F\u5426\u53EF\u4EE5\u91CD\u7528\uFF0C\u82E5\u53EF\u4EE5\u5206\u914D\u7ED9\u4E0B\u4E2A\u4E8B\u52A1\u4F7F\u7528</li></ul><h6 id="_3-\u56DE\u6EDA\u6BB5\u4E2D\u7684\u6570\u636E\u5206\u7C7B" tabindex="-1"><a class="header-anchor" href="#_3-\u56DE\u6EDA\u6BB5\u4E2D\u7684\u6570\u636E\u5206\u7C7B" aria-hidden="true">#</a> 3. \u56DE\u6EDA\u6BB5\u4E2D\u7684\u6570\u636E\u5206\u7C7B</h6><ol><li><code>\u672A\u63D0\u4EA4\u7684\u56DE\u6EDA\u6570\u636E(uncommitted undo information)</code>\uFF1A\u8BE5\u6570\u636E\u6240\u5173\u8054\u7684\u4E8B\u52A1\u5E76\u672A\u63D0\u4EA4\uFF0C\u7528\u4E8E\u5B9E\u73B0\u8BFB\u4E00\u81F4\u6027\uFF0C\u6240\u4EE5\u8BE5\u6570\u636E\u4E0D\u80FD\u88AB\u5176\u4ED6\u4E8B\u52A1\u7684\u6570\u636E\u8986\u76D6\u3002</li><li><code>\u5DF2\u7ECF\u63D0\u4EA4\u4F46\u672A\u8FC7\u671F\u7684\u56DE\u6EDA\u6570\u636E(committed undo information)</code>\uFF1A\u8BE5\u6570\u636E\u5173\u8054\u7684\u4E8B\u52A1\u5DF2\u7ECF\u63D0\u4EA4\uFF0C\u4F46\u662F\u4ECD\u53D7\u5230undo retention\u53C2\u6570\u7684\u4FDD\u6301\u65F6\u95F4\u7684\u5F71\u54CD\u3002</li><li><code>\u4E8B\u52A1\u5DF2\u7ECF\u63D0\u4EA4\u5E76\u8FC7\u671F\u7684\u6570\u636E(expired undo information)</code>\uFF1A\u4E8B\u52A1\u5DF2\u7ECF\u63D0\u4EA4\uFF0C\u800C\u4E14\u6570\u636E\u4FDD\u5B58\u65F6\u95F4\u5DF2\u7ECF\u8D85\u8FC7 undo retention\u53C2\u6570\u6307\u5B9A\u7684\u65F6\u95F4\uFF0C\u5C5E\u4E8E\u5DF2\u7ECF\u8FC7\u671F\u7684\u6570\u636E\u3002\u5F53\u56DE\u6EDA\u6BB5\u6EE1\u4E86\u4E4B\u540E\uFF0C\u5C31\u4F18\u5148\u8986\u76D6\u201C\u4E8B\u52A1\u5DF2\u7ECF\u63D0\u4EA4\u5E76\u8FC7\u671F\u7684\u6570\u636E&quot;\u3002</li></ol><p>\u4E8B\u52A1\u63D0\u4EA4\u540E\u4E0D\u80FD\u9A6C\u4E0A\u5220\u9664undo log\u53CAundo log\u6240\u5728\u7684\u9875\u3002\u8FD9\u662F\u56E0\u4E3A\u53EF\u80FD\u8FD8\u6709\u5176\u4ED6\u4E8B\u52A1\u9700\u8981\u901A\u8FC7undo log\u6765\u5F97\u5230\u884C\u8BB0\u5F55\u4E4B\u524D\u7684\u7248\u672C\u3002\u6545\u4E8B\u52A1\u63D0\u4EA4\u65F6\u5C06undo log\u653E\u5165\u4E00\u4E2A\u94FE\u8868\u4E2D\uFF0C\u662F\u5426\u53EF\u4EE5\u6700\u7EC8\u5220\u9664undo log\u4EE5undo log\u6240\u5728\u9875\u7531 purge\u7EBF\u7A0B \u6765\u5224\u65AD\u3002</p><h5 id="_2-4-undo\u7684\u7C7B\u578B" tabindex="-1"><a class="header-anchor" href="#_2-4-undo\u7684\u7C7B\u578B" aria-hidden="true">#</a> 2.4 undo\u7684\u7C7B\u578B</h5><p>\u5728InnoDB\u5B58\u50A8\u5F15\u64CE\u4E2D\uFF0Cundo log\u5206\u4E3A\uFF1A</p><ul><li><p>insert undo log</p><p>insert undo log\u662F\u6307insert\u64CD\u4F5C\u4E2D\u4EA7\u751F\u7684undo log\u3002\u56E0\u4E3Ainsert\u64CD\u4F5C\u7684\u8BB0\u5F55\uFF0C\u53EA\u5BF9\u4E8B\u52A1\u672C\u8EAB\u53EF\u89C1\uFF0C\u5BF9\u5176\u4ED6\u4E8B\u52A1\u4E0D\u53EF\u89C1\uFF08\u8FD9\u662F\u4E8B\u52A1\u9694\u79BB\u6027\u7684\u8981\u6C42\uFF09\uFF0C\u6545\u8BE5undo log\u53EF\u4EE5\u5728\u4E8B\u52A1\u63D0\u4EA4\u540E\u76F4\u63A5\u5220\u9664\u3002\u4E0D\u9700\u8981\u8FDB\u884Cpurge\u64CD\u4F5C\u3002</p></li><li><p>update undo log</p><p>update undo log\u8BB0\u5F55\u7684\u662F\u5BF9delete\u548Cupdate\u64CD\u4F5C\u4EA7\u751F\u7684undo log\u3002\u8BE5undo log\u53EF\u80FD\u9700\u8981\u63D0\u4F9BMVCC\u673A\u5236\uFF0C\u56E0\u6B64\u4E0D\u80FD\u5728\u4E8B\u52A1\u63D0\u4EA4\u65F6\u5C31\u8FDB\u884C\u5220\u9664\u3002\u63D0\u4EA4\u65F6\u653E\u5165undo log\u94FE\u8868\uFF0C\u7B49\u5F85purge\u7EBF\u7A0B\u8FDB\u884C\u6700\u540E\u7684\u5220\u9664\u3002</p></li></ul><h5 id="_2-5-undo-log\u7684\u751F\u547D\u5468\u671F" tabindex="-1"><a class="header-anchor" href="#_2-5-undo-log\u7684\u751F\u547D\u5468\u671F" aria-hidden="true">#</a> 2.5 undo log\u7684\u751F\u547D\u5468\u671F</h5><h6 id="_1-\u7B80\u8981\u751F\u6210\u8FC7\u7A0B" tabindex="-1"><a class="header-anchor" href="#_1-\u7B80\u8981\u751F\u6210\u8FC7\u7A0B" aria-hidden="true">#</a> 1. \u7B80\u8981\u751F\u6210\u8FC7\u7A0B</h6><p>\u4EE5\u4E0B\u662Fundo+redo\u4E8B\u52A1\u7684\u7B80\u5316\u8FC7\u7A0B</p><p>\u5047\u8BBE\u6709\u4E24\u4E2A\u6570\u503C\uFF0C\u5206\u522B\u4E3AA=1\u548CB=2\uFF0C\u7136\u540E\u5C06A\u4FEE\u6539\u4E3A3\uFF0CB\u4FEE\u6539\u4E3A4</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711162414928.png" alt="image-20220711162414928" style="float:left;"><p><strong>\u53EA\u6709Buffer Pool\u7684\u6D41\u7A0B\uFF1A</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711162505008.png" alt="image-20220711162505008"></p><p><strong>\u6709\u4E86Redo Log\u548CUndo Log\u4E4B\u540E\uFF1A</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711162642305.png" alt="image-20220711162642305"></p><p>\u5728\u66F4\u65B0Buffer Pool\u4E2D\u7684\u6570\u636E\u4E4B\u524D\uFF0C\u6211\u4EEC\u9700\u8981\u5148\u5C06\u8BE5\u6570\u636E\u4E8B\u52A1\u5F00\u59CB\u4E4B\u524D\u7684\u72B6\u6001\u5199\u5165Undo Log\u4E2D\u3002\u5047\u8BBE\u66F4\u65B0\u5230\u4E00\u534A\u51FA\u9519\u4E86\uFF0C\u6211\u4EEC\u5C31\u53EF\u4EE5\u901A\u8FC7Undo Log\u6765\u56DE\u6EDA\u5230\u4E8B\u52A1\u5F00\u59CB\u524D\u3002</p><h6 id="_2-\u8BE6\u7EC6\u751F\u6210\u8FC7\u7A0B" tabindex="-1"><a class="header-anchor" href="#_2-\u8BE6\u7EC6\u751F\u6210\u8FC7\u7A0B" aria-hidden="true">#</a> 2. \u8BE6\u7EC6\u751F\u6210\u8FC7\u7A0B</h6><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711162919157.png" alt="image-20220711162919157" style="float:left;"><p><strong>\u5F53\u6211\u4EEC\u6267\u884CINSERT\u65F6\uFF1A</strong></p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>begin;
INSERT INTO user (name) VALUES (&quot;tom&quot;);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63D2\u5165\u7684\u6570\u636E\u90FD\u4F1A\u751F\u6210\u4E00\u6761insert undo log\uFF0C\u5E76\u4E14\u6570\u636E\u7684\u56DE\u6EDA\u6307\u9488\u4F1A\u6307\u5411\u5B83\u3002undo log\u4F1A\u8BB0\u5F55undo log\u7684\u5E8F\u53F7\u3001\u63D2\u5165\u4E3B\u952E\u7684\u5217\u548C\u503C...\uFF0C\u90A3\u4E48\u5728\u8FDB\u884Crollback\u7684\u65F6\u5019\uFF0C\u901A\u8FC7\u4E3B\u952E\u76F4\u63A5\u628A\u5BF9\u5E94\u7684\u6570\u636E\u5220\u9664\u5373\u53EF\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711163725129.png" alt="image-20220711163725129"></p><p><strong>\u5F53\u6211\u4EEC\u6267\u884CUPDATE\u65F6\uFF1A</strong></p><p>\u5BF9\u5E94\u66F4\u65B0\u7684\u64CD\u4F5C\u4F1A\u4EA7\u751Fupdate undo log\uFF0C\u5E76\u4E14\u4F1A\u5206\u66F4\u65B0\u4E3B\u952E\u548C\u4E0D\u66F4\u65B0\u4E3B\u952E\u7684\uFF0C\u5047\u8BBE\u73B0\u5728\u6267\u884C\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>UPDATE user SET name=&quot;Sun&quot; WHERE id=1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711164138414.png" alt="image-20220711164138414"></p><p>\u8FD9\u65F6\u4F1A\u628A\u8001\u7684\u8BB0\u5F55\u5199\u5165\u65B0\u7684undo log\uFF0C\u8BA9\u56DE\u6EDA\u6307\u9488\u6307\u5411\u65B0\u7684undo log\uFF0C\u5B83\u7684undo no\u662F1\uFF0C\u5E76\u4E14\u65B0\u7684undo log\u4F1A\u6307\u5411\u8001\u7684undo log\uFF08undo no=0\uFF09\u3002</p><p>\u5047\u8BBE\u73B0\u5728\u6267\u884C\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>UPDATE user SET id=2 WHERE id=1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711164421494.png" alt="image-20220711164421494"></p><p>\u5BF9\u4E8E\u66F4\u65B0\u4E3B\u952E\u7684\u64CD\u4F5C\uFF0C\u4F1A\u5148\u628A\u539F\u6765\u7684\u6570\u636Edeletemark\u6807\u8BC6\u6253\u5F00\uFF0C\u8FD9\u65F6\u5E76\u6CA1\u6709\u771F\u6B63\u7684\u5220\u9664\u6570\u636E\uFF0C\u771F\u6B63\u7684\u5220\u9664\u4F1A\u4EA4\u7ED9\u6E05\u7406\u7EBF\u7A0B\u53BB\u5224\u65AD\uFF0C\u7136\u540E\u5728\u540E\u9762\u63D2\u5165\u4E00\u6761\u65B0\u7684\u6570\u636E\uFF0C\u65B0\u7684\u6570\u636E\u4E5F\u4F1A\u4EA7\u751Fundo log\uFF0C\u5E76\u4E14undo log\u7684\u5E8F\u53F7\u4F1A\u9012\u589E\u3002</p><p>\u53EF\u4EE5\u53D1\u73B0\u6BCF\u6B21\u5BF9\u6570\u636E\u7684\u53D8\u66F4\u90FD\u4F1A\u4EA7\u751F\u4E00\u4E2Aundo log\uFF0C\u5F53\u4E00\u6761\u8BB0\u5F55\u88AB\u53D8\u66F4\u591A\u6B21\u65F6\uFF0C\u90A3\u4E48\u5C31\u4F1A\u4EA7\u751F\u591A\u6761undo log\uFF0Cundo log\u8BB0\u5F55\u7684\u662F\u53D8\u66F4\u524D\u7684\u65E5\u5FD7\uFF0C\u5E76\u4E14\u6BCF\u4E2Aundo log\u7684\u5E8F\u53F7\u662F\u9012\u589E\u7684\uFF0C\u90A3\u4E48\u5F53\u8981\u56DE\u6EDA\u7684\u65F6\u5019\uFF0C\u6309\u7167\u5E8F\u53F7<code>\u4F9D\u6B21\u5411\u524D\u63A8</code>\uFF0C\u5C31\u53EF\u4EE5\u627E\u5230\u6211\u4EEC\u7684\u539F\u59CB\u6570\u636E\u4E86\u3002</p><h6 id="_3-undo-log\u662F\u5982\u4F55\u56DE\u6EDA\u7684" tabindex="-1"><a class="header-anchor" href="#_3-undo-log\u662F\u5982\u4F55\u56DE\u6EDA\u7684" aria-hidden="true">#</a> 3. undo log\u662F\u5982\u4F55\u56DE\u6EDA\u7684</h6><p>\u4EE5\u4E0A\u9762\u7684\u4F8B\u5B50\u6765\u8BF4\uFF0C\u5047\u8BBE\u6267\u884Crollback\uFF0C\u90A3\u4E48\u5BF9\u5E94\u7684\u6D41\u7A0B\u5E94\u8BE5\u662F\u8FD9\u6837\uFF1A</p><ol><li>\u901A\u8FC7undo no=3\u7684\u65E5\u5FD7\u628Aid=2\u7684\u6570\u636E\u5220\u9664</li><li>\u901A\u8FC7undo no=2\u7684\u65E5\u5FD7\u628Aid=1\u7684\u6570\u636E\u7684deletemark\u8FD8\u539F\u62100</li><li>\u901A\u8FC7undo no=1\u7684\u65E5\u5FD7\u628Aid=1\u7684\u6570\u636E\u7684name\u8FD8\u539F\u6210Tom</li><li>\u901A\u8FC7undo no=0\u7684\u65E5\u5FD7\u628Aid=1\u7684\u6570\u636E\u5220\u9664</li></ol><h6 id="_4-undo-log\u7684\u5220\u9664" tabindex="-1"><a class="header-anchor" href="#_4-undo-log\u7684\u5220\u9664" aria-hidden="true">#</a> 4. undo log\u7684\u5220\u9664</h6><ul><li><p>\u9488\u5BF9\u4E8Einsert undo log</p><p>\u56E0\u4E3Ainsert\u64CD\u4F5C\u7684\u8BB0\u5F55\uFF0C\u53EA\u5BF9\u4E8B\u52A1\u672C\u8EAB\u53EF\u89C1\uFF0C\u5BF9\u5176\u4ED6\u4E8B\u52A1\u4E0D\u53EF\u89C1\u3002\u6545\u8BE5undo log\u53EF\u4EE5\u5728\u4E8B\u52A1\u63D0\u4EA4\u540E\u76F4\u63A5\u5220\u9664\uFF0C\u4E0D\u9700\u8981\u8FDB\u884Cpurge\u64CD\u4F5C\u3002</p></li><li><p>\u9488\u5BF9\u4E8Eupdate undo log</p><p>\u8BE5undo log\u53EF\u80FD\u9700\u8981\u63D0\u4F9BMVCC\u673A\u5236\uFF0C\u56E0\u6B64\u4E0D\u80FD\u5728\u4E8B\u52A1\u63D0\u4EA4\u65F6\u5C31\u8FDB\u884C\u5220\u9664\u3002\u63D0\u4EA4\u65F6\u653E\u5165undo log\u94FE\u8868\uFF0C\u7B49\u5F85purge\u7EBF\u7A0B\u8FDB\u884C\u6700\u540E\u7684\u5220\u9664\u3002</p></li></ul><blockquote><p>\u8865\u5145\uFF1A</p><p>purge\u7EBF\u7A0B\u4E24\u4E2A\u4E3B\u8981\u4F5C\u7528\u662F\uFF1A<code>\u6E05\u7406undo\u9875</code>\u548C<code>\u6E05\u7406page\u91CC\u9762\u5E26\u6709Delete_Bit\u6807\u8BC6\u7684\u6570\u636E\u884C</code>\u3002\u5728InnoDB\u4E2D\uFF0C\u4E8B\u52A1\u4E2D\u7684Delete\u64CD\u4F5C\u5B9E\u9645\u4E0A\u5E76\u4E0D\u662F\u771F\u6B63\u7684\u5220\u9664\u6389\u6570\u636E\u884C\uFF0C\u800C\u662F\u4E00\u79CDDelete Mark\u64CD\u4F5C\uFF0C\u5728\u8BB0\u5F55\u4E0A\u6807\u8BC6Delete_Bit\uFF0C\u800C\u4E0D\u5220\u9664\u8BB0\u5F55\u3002\u662F\u4E00\u79CD\u201C\u5047\u5220\u9664\u201D\uFF0C\u53EA\u662F\u505A\u4E86\u4E2A\u6807\u8BB0\uFF0C\u771F\u6B63\u7684\u5220\u9664\u5DE5\u4F5C\u9700\u8981\u540E\u53F0purge\u7EBF\u7A0B\u53BB\u5B8C\u6210\u3002</p></blockquote><h5 id="_2-6-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_2-6-\u5C0F\u7ED3" aria-hidden="true">#</a> 2.6 \u5C0F\u7ED3</h5><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711165612956.png" alt="image-20220711165612956"></p><p>undo log\u662F\u903B\u8F91\u65E5\u5FD7\uFF0C\u5BF9\u4E8B\u52A1\u56DE\u6EDA\u65F6\uFF0C\u53EA\u662F\u5C06\u6570\u636E\u5E93\u903B\u8F91\u5730\u6062\u590D\u5230\u539F\u6765\u7684\u6837\u5B50\u3002</p><p>redo log\u662F\u7269\u7406\u65E5\u5FD7\uFF0C\u8BB0\u5F55\u7684\u662F\u6570\u636E\u9875\u7684\u7269\u7406\u53D8\u5316\uFF0Cundo log\u4E0D\u662Fredo log\u7684\u9006\u8FC7\u7A0B\u3002</p><h2 id="\u7B2C15\u7AE0-\u9501" tabindex="-1"><a class="header-anchor" href="#\u7B2C15\u7AE0-\u9501" aria-hidden="true">#</a> \u7B2C15\u7AE0_\u9501</h2><h3 id="_1-\u6982\u8FF0" tabindex="-1"><a class="header-anchor" href="#_1-\u6982\u8FF0" aria-hidden="true">#</a> 1. \u6982\u8FF0</h3><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711165954976.png" alt="image-20220711165954976" style="float:left;"><p>\u5728\u6570\u636E\u5E93\u4E2D\uFF0C\u9664\u4F20\u7EDF\u7684\u8BA1\u7B97\u8D44\u6E90\uFF08\u5982CPU\u3001RAM\u3001I/O\u7B49\uFF09\u7684\u4E89\u7528\u4EE5\u5916\uFF0C\u6570\u636E\u4E5F\u662F\u4E00\u79CD\u4F9B\u8BB8\u591A\u7528\u6237\u5171\u4EAB\u7684 \u8D44\u6E90\u3002\u4E3A\u4FDD\u8BC1\u6570\u636E\u7684\u4E00\u81F4\u6027\uFF0C\u9700\u8981\u5BF9 <code>\u5E76\u53D1\u64CD\u4F5C\u8FDB\u884C\u63A7\u5236</code> \uFF0C\u56E0\u6B64\u4EA7\u751F\u4E86 <code>\u9501</code> \u3002\u540C\u65F6 <code>\u9501\u673A\u5236</code> \u4E5F\u4E3A\u5B9E\u73B0MySQL \u7684\u5404\u4E2A\u9694\u79BB\u7EA7\u522B\u63D0\u4F9B\u4E86\u4FDD\u8BC1\u3002 <code>\u9501\u51B2\u7A81</code> \u4E5F\u662F\u5F71\u54CD\u6570\u636E\u5E93 <code>\u5E76\u53D1\u8BBF\u95EE\u6027\u80FD</code> \u7684\u4E00\u4E2A\u91CD\u8981\u56E0\u7D20\u3002\u6240\u4EE5\u9501\u5BF9\u6570\u636E\u5E93\u800C\u8A00\u663E\u5F97\u5C24\u5176\u91CD\u8981\uFF0C\u4E5F\u66F4\u52A0\u590D\u6742\u3002</p><h3 id="_2-mysql\u5E76\u53D1\u4E8B\u52A1\u8BBF\u95EE\u76F8\u540C\u8BB0\u5F55" tabindex="-1"><a class="header-anchor" href="#_2-mysql\u5E76\u53D1\u4E8B\u52A1\u8BBF\u95EE\u76F8\u540C\u8BB0\u5F55" aria-hidden="true">#</a> 2. MySQL\u5E76\u53D1\u4E8B\u52A1\u8BBF\u95EE\u76F8\u540C\u8BB0\u5F55</h3><p>\u5E76\u53D1\u4E8B\u52A1\u8BBF\u95EE\u76F8\u540C\u8BB0\u5F55\u7684\u60C5\u51B5\u5927\u81F4\u53EF\u4EE5\u5212\u5206\u4E3A3\u79CD\uFF1A</p><h5 id="_2-1-\u8BFB-\u8BFB\u60C5\u51B5" tabindex="-1"><a class="header-anchor" href="#_2-1-\u8BFB-\u8BFB\u60C5\u51B5" aria-hidden="true">#</a> 2.1 \u8BFB-\u8BFB\u60C5\u51B5</h5><p><code>\u8BFB-\u8BFB</code>\u60C5\u51B5\uFF0C\u5373\u5E76\u53D1\u4E8B\u52A1\u76F8\u7EE7<code>\u8BFB\u53D6\u76F8\u540C\u7684\u8BB0\u5F55</code>\u3002\u8BFB\u53D6\u64CD\u4F5C\u672C\u8EAB\u4E0D\u4F1A\u5BF9\u8BB0\u5F55\u6709\u4EFB\u4F55\u5F71\u54CD\uFF0C\u5E76\u4E0D\u4F1A\u5F15\u8D77\u4EC0\u4E48\u95EE\u9898\uFF0C\u6240\u4EE5\u5141\u8BB8\u8FD9\u79CD\u60C5\u51B5\u7684\u53D1\u751F\u3002</p><h5 id="_2-2-\u5199-\u5199\u60C5\u51B5" tabindex="-1"><a class="header-anchor" href="#_2-2-\u5199-\u5199\u60C5\u51B5" aria-hidden="true">#</a> 2.2 \u5199-\u5199\u60C5\u51B5</h5><p><code>\u5199-\u5199</code> \u60C5\u51B5\uFF0C\u5373\u5E76\u53D1\u4E8B\u52A1\u76F8\u7EE7\u5BF9\u76F8\u540C\u7684\u8BB0\u5F55\u505A\u51FA\u6539\u52A8\u3002</p><p>\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\u4F1A\u53D1\u751F <code>\u810F\u5199</code> \u7684\u95EE\u9898\uFF0C\u4EFB\u4F55\u4E00\u79CD\u9694\u79BB\u7EA7\u522B\u90FD\u4E0D\u5141\u8BB8\u8FD9\u79CD\u95EE\u9898\u7684\u53D1\u751F\u3002\u6240\u4EE5\u5728\u591A\u4E2A\u672A\u63D0\u4EA4\u4E8B\u52A1\u76F8\u7EE7\u5BF9\u4E00\u6761\u8BB0\u5F55\u505A\u6539\u52A8\u65F6\uFF0C\u9700\u8981\u8BA9\u5B83\u4EEC <code>\u6392\u961F\u6267\u884C</code> \uFF0C\u8FD9\u4E2A\u6392\u961F\u7684\u8FC7\u7A0B\u5176\u5B9E\u662F\u901A\u8FC7 <code>\u9501</code> \u6765\u5B9E\u73B0\u7684\u3002\u8FD9\u4E2A\u6240\u8C13\u7684\u9501\u5176\u5B9E\u662F\u4E00\u4E2A\u5185\u5B58\u4E2D\u7684\u7ED3\u6784 \uFF0C\u5728\u4E8B\u52A1\u6267\u884C\u524D\u672C\u6765\u662F\u6CA1\u6709\u9501\u7684\uFF0C\u4E5F\u5C31\u662F\u8BF4\u4E00\u5F00\u59CB\u662F\u6CA1\u6709 \u9501\u7ED3\u6784 \u548C\u8BB0\u5F55\u8FDB \u884C\u5173\u8054\u7684\uFF0C\u5982\u56FE\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711181120639.png" alt="image-20220711181120639"></p><p>\u5F53\u4E00\u4E2A\u4E8B\u52A1\u60F3\u5BF9\u8FD9\u6761\u8BB0\u5F55\u505A\u6539\u52A8\u65F6\uFF0C\u9996\u5148\u4F1A\u770B\u770B\u5185\u5B58\u4E2D\u6709\u6CA1\u6709\u4E0E\u8FD9\u6761\u8BB0\u5F55\u5173\u8054\u7684 <code>\u9501\u7ED3\u6784</code> \uFF0C\u5F53\u6CA1\u6709\u7684\u65F6\u5019 \u5C31\u4F1A\u5728\u5185\u5B58\u4E2D\u751F\u6210\u4E00\u4E2A <code>\u9501\u7ED3\u6784</code> \u4E0E\u4E4B\u5173\u8054\u3002\u6BD4\u5982\uFF0C\u4E8B\u52A1<code> T1</code> \u8981\u5BF9\u8FD9\u6761\u8BB0\u5F55\u505A\u6539\u52A8\uFF0C\u5C31\u9700\u8981\u751F\u6210\u4E00\u4E2A <code>\u9501\u7ED3\u6784</code> \u4E0E\u4E4B\u5173\u8054\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711192633239.png" alt="image-20220711192633239"></p><p>\u5728<code>\u9501\u7ED3\u6784</code>\u91CC\u6709\u5F88\u591A\u4FE1\u606F\uFF0C\u4E3A\u4E86\u7B80\u5316\u7406\u89E3\uFF0C\u53EA\u628A\u4E24\u4E2A\u6BD4\u8F83\u91CD\u8981\u7684\u5C5E\u6027\u62FF\u4E86\u51FA\u6765\uFF1A</p><ul><li><code>trx\u4FE1\u606F</code>\uFF1A\u4EE3\u8868\u8FD9\u4E2A\u9501\u7ED3\u6784\u662F\u54EA\u4E2A\u4E8B\u52A1\u751F\u6210\u7684\u3002</li><li><code>is_waiting</code>\uFF1A\u4EE3\u8868\u5F53\u524D\u4E8B\u52A1\u662F\u5426\u5728\u7B49\u5F85\u3002</li></ul><p>\u5728\u4E8B\u52A1<code>T1</code>\u6539\u52A8\u4E86\u8FD9\u6761\u8BB0\u5F55\u540E\uFF0C\u5C31\u751F\u6210\u4E86\u4E00\u4E2A<code>\u9501\u7ED3\u6784</code>\u4E0E\u8BE5\u8BB0\u5F55\u5173\u8054\uFF0C\u56E0\u4E3A\u4E4B\u524D\u6CA1\u6709\u522B\u7684\u4E8B\u52A1\u4E3A\u8FD9\u6761\u8BB0\u5F55\u52A0\u9501\uFF0C\u6240\u4EE5<code>is_waiting</code>\u5C5E\u6027\u5C31\u662F<code>false</code>\uFF0C\u6211\u4EEC\u628A\u8FD9\u4E2A\u573A\u666F\u5C31\u79F0\u503C\u4E3A<code>\u83B7\u53D6\u9501\u6210\u529F</code>\uFF0C\u6216\u8005<code>\u52A0\u9501\u6210\u529F</code>\uFF0C\u7136\u540E\u5C31\u53EF\u4EE5\u7EE7\u7EED\u6267\u884C\u64CD\u4F5C\u4E86\u3002</p><p>\u5728\u4E8B\u52A1<code>T1</code>\u63D0\u4EA4\u4E4B\u524D\uFF0C\u53E6\u4E00\u4E2A\u4E8B\u52A1<code>T2</code>\u4E5F\u60F3\u5BF9\u8BE5\u8BB0\u5F55\u505A\u6539\u52A8\uFF0C\u90A3\u4E48\u5148\u770B\u770B\u6709\u6CA1\u6709<code>\u9501\u7ED3\u6784</code>\u4E0E\u8FD9\u6761\u8BB0\u5F55\u5173\u8054\uFF0C\u53D1\u73B0\u6709\u4E00\u4E2A<code>\u9501\u7ED3\u6784</code>\u4E0E\u4E4B\u5173\u8054\u540E\uFF0C\u7136\u540E\u4E5F\u751F\u6210\u4E86\u4E00\u4E2A\u9501\u7ED3\u6784\u4E0E\u8FD9\u6761\u8BB0\u5F55\u5173\u8054\uFF0C\u4E0D\u8FC7\u9501\u7ED3\u6784\u7684<code>is_waiting</code>\u5C5E\u6027\u503C\u4E3A<code>true</code>\uFF0C\u8868\u793A\u5F53\u524D\u4E8B\u52A1\u9700\u8981\u7B49\u5F85\uFF0C\u6211\u4EEC\u628A\u8FD9\u4E2A\u573A\u666F\u5C31\u79F0\u4E4B\u4E3A<code>\u83B7\u53D6\u9501\u5931\u8D25</code>\uFF0C\u6216\u8005<code>\u52A0\u9501\u5931\u8D25</code>\uFF0C\u56FE\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711193732567.png" alt="image-20220711193732567"></p><p>\u5728\u4E8B\u52A1T1\u63D0\u4EA4\u4E4B\u540E\uFF0C\u5C31\u4F1A\u628A\u8BE5\u4E8B\u52A1\u751F\u6210\u7684<code>\u9501\u7ED3\u6784\u91CA\u653E</code>\u6389\uFF0C\u7136\u540E\u770B\u770B\u8FD8\u6709\u6CA1\u6709\u522B\u7684\u4E8B\u52A1\u5728\u7B49\u5F85\u83B7\u53D6\u9501\uFF0C\u53D1\u73B0\u4E86\u4E8B\u52A1T2\u8FD8\u5728\u7B49\u5F85\u83B7\u53D6\u9501\uFF0C\u6240\u4EE5\u628A\u4E8B\u52A1T2\u5BF9\u5E94\u7684\u9501\u7ED3\u6784\u7684<code>is_waiting</code>\u5C5E\u6027\u8BBE\u7F6E\u4E3A<code>false</code>\uFF0C\u7136\u540E\u628A\u8BE5\u4E8B\u52A1\u5BF9\u5E94\u7684\u7EBF\u7A0B\u5524\u9192\uFF0C\u8BA9\u5B83\u7EE7\u7EED\u6267\u884C\uFF0C\u6B64\u65F6\u4E8B\u52A1T2\u5C31\u7B97\u83B7\u53D6\u5230\u9501\u4E86\u3002\u6548\u679C\u5C31\u662F\u8FD9\u6837\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711194904328.png" alt="image-20220711194904328"></p><p>\u5C0F\u7ED3\u51E0\u79CD\u8BF4\u6CD5\uFF1A</p><ul><li><p>\u4E0D\u52A0\u9501</p><p>\u610F\u601D\u5C31\u662F\u4E0D\u9700\u8981\u5728\u5185\u5B58\u4E2D\u751F\u6210\u5BF9\u5E94\u7684 <code>\u9501\u7ED3\u6784</code> \uFF0C\u53EF\u4EE5\u76F4\u63A5\u6267\u884C\u64CD\u4F5C\u3002</p></li><li><p>\u83B7\u53D6\u9501\u6210\u529F\uFF0C\u6216\u8005\u52A0\u9501\u6210\u529F</p><p>\u610F\u601D\u5C31\u662F\u5728\u5185\u5B58\u4E2D\u751F\u6210\u4E86\u5BF9\u5E94\u7684 <code>\u9501\u7ED3\u6784</code> \uFF0C\u800C\u4E14\u9501\u7ED3\u6784\u7684 <code>is_waiting</code> \u5C5E\u6027\u4E3A <code>false</code> \uFF0C\u4E5F\u5C31\u662F\u4E8B\u52A1 \u53EF\u4EE5\u7EE7\u7EED\u6267\u884C\u64CD\u4F5C\u3002</p></li><li><p>\u83B7\u53D6\u9501\u5931\u8D25\uFF0C\u6216\u8005\u52A0\u9501\u5931\u8D25\uFF0C\u6216\u8005\u6CA1\u6709\u83B7\u53D6\u5230\u9501</p><p>\u610F\u601D\u5C31\u662F\u5728\u5185\u5B58\u4E2D\u751F\u6210\u4E86\u5BF9\u5E94\u7684 <code>\u9501\u7ED3\u6784</code> \uFF0C\u4E0D\u8FC7\u9501\u7ED3\u6784\u7684 <code>is_waiting</code> \u5C5E\u6027\u4E3A <code>true</code> \uFF0C\u4E5F\u5C31\u662F\u4E8B\u52A1 \u9700\u8981\u7B49\u5F85\uFF0C\u4E0D\u53EF\u4EE5\u7EE7\u7EED\u6267\u884C\u64CD\u4F5C\u3002</p></li></ul><h5 id="_2-3-\u8BFB-\u5199\u6216\u5199-\u8BFB\u60C5\u51B5" tabindex="-1"><a class="header-anchor" href="#_2-3-\u8BFB-\u5199\u6216\u5199-\u8BFB\u60C5\u51B5" aria-hidden="true">#</a> 2.3 \u8BFB-\u5199\u6216\u5199-\u8BFB\u60C5\u51B5</h5><p><code>\u8BFB-\u5199</code> \u6216 <code>\u5199-\u8BFB </code>\uFF0C\u5373\u4E00\u4E2A\u4E8B\u52A1\u8FDB\u884C\u8BFB\u53D6\u64CD\u4F5C\uFF0C\u53E6\u4E00\u4E2A\u8FDB\u884C\u6539\u52A8\u64CD\u4F5C\u3002\u8FD9\u79CD\u60C5\u51B5\u4E0B\u53EF\u80FD\u53D1\u751F <code>\u810F\u8BFB \u3001 \u4E0D\u53EF\u91CD \u590D\u8BFB \u3001 \u5E7B\u8BFB</code> \u7684\u95EE\u9898\u3002</p><p>\u5404\u4E2A\u6570\u636E\u5E93\u5382\u5546\u5BF9 <code>SQL\u6807\u51C6</code> \u7684\u652F\u6301\u90FD\u53EF\u80FD\u4E0D\u4E00\u6837\u3002\u6BD4\u5982MySQL\u5728 <code>REPEATABLE READ</code> \u9694\u79BB\u7EA7\u522B\u4E0A\u5C31\u5DF2\u7ECF\u89E3\u51B3\u4E86 <code>\u5E7B\u8BFB</code> \u95EE\u9898\u3002</p><h5 id="_2-4-\u5E76\u53D1\u95EE\u9898\u7684\u89E3\u51B3\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#_2-4-\u5E76\u53D1\u95EE\u9898\u7684\u89E3\u51B3\u65B9\u6848" aria-hidden="true">#</a> 2.4 \u5E76\u53D1\u95EE\u9898\u7684\u89E3\u51B3\u65B9\u6848</h5><p>\u600E\u4E48\u89E3\u51B3 <code>\u810F\u8BFB \u3001 \u4E0D\u53EF\u91CD\u590D\u8BFB \u3001 \u5E7B\u8BFB</code> \u8FD9\u4E9B\u95EE\u9898\u5462\uFF1F\u5176\u5B9E\u6709\u4E24\u79CD\u53EF\u9009\u7684\u89E3\u51B3\u65B9\u6848\uFF1A</p><ul><li>\u65B9\u6848\u4E00\uFF1A\u8BFB\u64CD\u4F5C\u5229\u7528\u591A\u7248\u672C\u5E76\u53D1\u63A7\u5236\uFF08 <code>MVCC</code> \uFF0C\u4E0B\u7AE0\u8BB2\u89E3\uFF09\uFF0C\u5199\u64CD\u4F5C\u8FDB\u884C <code>\u52A0\u9501</code> \u3002</li></ul><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711202206405.png" alt="image-20220711202206405" style="float:left;"><blockquote><p>\u666E\u901A\u7684SELECT\u8BED\u53E5\u5728READ COMMITTED\u548CREPEATABLE READ\u9694\u79BB\u7EA7\u522B\u4E0B\u4F1A\u4F7F\u7528\u5230MVCC\u8BFB\u53D6\u8BB0\u5F55\u3002</p><ul><li>\u5728 <code>READ COMMITTED</code> \u9694\u79BB\u7EA7\u522B\u4E0B\uFF0C\u4E00\u4E2A\u4E8B\u52A1\u5728\u6267\u884C\u8FC7\u7A0B\u4E2D\u6BCF\u6B21\u6267\u884CSELECT\u64CD\u4F5C\u65F6\u90FD\u4F1A\u751F\u6210\u4E00 \u4E2AReadView\uFF0CReadView\u7684\u5B58\u5728\u672C\u8EAB\u5C31\u4FDD\u8BC1\u4E86<code>\u4E8B\u52A1\u4E0D\u53EF\u4EE5\u8BFB\u53D6\u5230\u672A\u63D0\u4EA4\u7684\u4E8B\u52A1\u6240\u505A\u7684\u66F4\u6539</code> \uFF0C\u4E5F\u5C31\u662F\u907F\u514D\u4E86\u810F\u8BFB\u73B0\u8C61\uFF1B</li><li>\u5728 <code>REPEATABLE READ</code> \u9694\u79BB\u7EA7\u522B\u4E0B\uFF0C\u4E00\u4E2A\u4E8B\u52A1\u5728\u6267\u884C\u8FC7\u7A0B\u4E2D\u53EA\u6709 <code>\u7B2C\u4E00\u6B21\u6267\u884CSELECT\u64CD\u4F5C</code> \u624D\u4F1A\u751F\u6210\u4E00\u4E2AReadView\uFF0C\u4E4B\u540E\u7684SELECT\u64CD\u4F5C\u90FD <code>\u590D\u7528</code> \u8FD9\u4E2AReadView\uFF0C\u8FD9\u6837\u4E5F\u5C31\u907F\u514D\u4E86\u4E0D\u53EF\u91CD\u590D\u8BFB\u548C\u5E7B\u8BFB\u7684\u95EE\u9898\u3002</li></ul></blockquote><ul><li>\u65B9\u6848\u4E8C\uFF1A\u8BFB\u3001\u5199\u64CD\u4F5C\u90FD\u91C7\u7528 <code>\u52A0\u9501</code> \u7684\u65B9\u5F0F\u3002</li></ul><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711203250284.png" alt="image-20220711203250284" style="float:left;"><ul><li><p>\u5C0F\u7ED3\u5BF9\u6BD4\u53D1\u73B0\uFF1A</p><ul><li>\u91C7\u7528 <code>MVCC</code> \u65B9\u5F0F\u7684\u8BDD\uFF0C \u8BFB-\u5199 \u64CD\u4F5C\u5F7C\u6B64\u5E76\u4E0D\u51B2\u7A81\uFF0C \u6027\u80FD\u66F4\u9AD8 \u3002</li><li>\u91C7\u7528 <code>\u52A0\u9501</code> \u65B9\u5F0F\u7684\u8BDD\uFF0C \u8BFB-\u5199 \u64CD\u4F5C\u5F7C\u6B64\u9700\u8981 <code>\u6392\u961F\u6267\u884C</code> \uFF0C\u5F71\u54CD\u6027\u80FD\u3002</li></ul><p>\u4E00\u822C\u60C5\u51B5\u4E0B\u6211\u4EEC\u5F53\u7136\u613F\u610F\u91C7\u7528 <code>MVCC</code> \u6765\u89E3\u51B3 <code>\u8BFB-\u5199</code> \u64CD\u4F5C\u5E76\u53D1\u6267\u884C\u7684\u95EE\u9898\uFF0C\u4F46\u662F\u4E1A\u52A1\u5728\u67D0\u4E9B\u7279\u6B8A\u60C5\u51B5\u4E0B\uFF0C\u8981\u6C42\u5FC5\u987B\u91C7\u7528 <code>\u52A0\u9501 </code>\u7684\u65B9\u5F0F\u6267\u884C\u3002\u4E0B\u9762\u5C31\u8BB2\u89E3\u4E0BMySQL\u4E2D\u4E0D\u540C\u7C7B\u522B\u7684\u9501\u3002</p></li></ul><h3 id="_3-\u9501\u7684\u4E0D\u540C\u89D2\u5EA6\u5206\u7C7B" tabindex="-1"><a class="header-anchor" href="#_3-\u9501\u7684\u4E0D\u540C\u89D2\u5EA6\u5206\u7C7B" aria-hidden="true">#</a> 3. \u9501\u7684\u4E0D\u540C\u89D2\u5EA6\u5206\u7C7B</h3><p>\u9501\u7684\u5206\u7C7B\u56FE\uFF0C\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711203519162.png" alt="image-20220711203519162"></p><h5 id="_3-1-\u4ECE\u6570\u636E\u64CD\u4F5C\u7684\u7C7B\u578B\u5212\u5206-\u8BFB\u9501\u3001\u5199\u9501" tabindex="-1"><a class="header-anchor" href="#_3-1-\u4ECE\u6570\u636E\u64CD\u4F5C\u7684\u7C7B\u578B\u5212\u5206-\u8BFB\u9501\u3001\u5199\u9501" aria-hidden="true">#</a> 3.1 \u4ECE\u6570\u636E\u64CD\u4F5C\u7684\u7C7B\u578B\u5212\u5206\uFF1A\u8BFB\u9501\u3001\u5199\u9501</h5><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711203723941.png" alt="image-20220711203723941" style="float:left;"><ul><li><code>\u8BFB\u9501</code> \uFF1A\u4E5F\u79F0\u4E3A <code>\u5171\u4EAB\u9501</code> \u3001\u82F1\u6587\u7528 S \u8868\u793A\u3002\u9488\u5BF9\u540C\u4E00\u4EFD\u6570\u636E\uFF0C\u591A\u4E2A\u4E8B\u52A1\u7684\u8BFB\u64CD\u4F5C\u53EF\u4EE5\u540C\u65F6\u8FDB\u884C\u800C\u4E0D\u4F1A\u4E92\u76F8\u5F71\u54CD\uFF0C\u76F8\u4E92\u4E0D\u963B\u585E\u7684\u3002</li><li><code>\u5199\u9501</code> \uFF1A\u4E5F\u79F0\u4E3A <code>\u6392\u4ED6\u9501</code> \u3001\u82F1\u6587\u7528 X \u8868\u793A\u3002\u5F53\u524D\u5199\u64CD\u4F5C\u6CA1\u6709\u5B8C\u6210\u524D\uFF0C\u5B83\u4F1A\u963B\u65AD\u5176\u4ED6\u5199\u9501\u548C\u8BFB\u9501\u3002\u8FD9\u6837 \u5C31\u80FD\u786E\u4FDD\u5728\u7ED9\u5B9A\u7684\u65F6\u95F4\u91CC\uFF0C\u53EA\u6709\u4E00\u4E2A\u4E8B\u52A1\u80FD\u6267\u884C\u5199\u5165\uFF0C\u5E76\u9632\u6B62\u5176\u4ED6\u7528\u6237\u8BFB\u53D6\u6B63\u5728\u5199\u5165\u7684\u540C\u4E00\u8D44\u6E90\u3002</li></ul><p><strong>\u9700\u8981\u6CE8\u610F\u7684\u662F\u5BF9\u4E8E InnoDB \u5F15\u64CE\u6765\u8BF4\uFF0C\u8BFB\u9501\u548C\u5199\u9501\u53EF\u4EE5\u52A0\u5728\u8868\u4E0A\uFF0C\u4E5F\u53EF\u4EE5\u52A0\u5728\u884C\u4E0A\u3002</strong></p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711204843684.png" alt="image-20220711204843684" style="float:left;"><h6 id="_1-\u9501\u5B9A\u8BFB" tabindex="-1"><a class="header-anchor" href="#_1-\u9501\u5B9A\u8BFB" aria-hidden="true">#</a> 1. \u9501\u5B9A\u8BFB</h6><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711212931912.png" alt="image-20220711212931912" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711213741630.png" alt="image-20220711213741630" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711214013208.png" alt="image-20220711214013208" style="float:left;"><h6 id="_2-\u5199\u64CD\u4F5C" tabindex="-1"><a class="header-anchor" href="#_2-\u5199\u64CD\u4F5C" aria-hidden="true">#</a> 2. \u5199\u64CD\u4F5C</h6><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711214412163.png" alt="image-20220711214412163" style="float:left;"><h5 id="_3-2-\u4ECE\u6570\u636E\u64CD\u4F5C\u7684\u7C92\u5EA6\u5212\u5206-\u8868\u7EA7\u9501\u3001\u9875\u7EA7\u9501\u3001\u884C\u9501" tabindex="-1"><a class="header-anchor" href="#_3-2-\u4ECE\u6570\u636E\u64CD\u4F5C\u7684\u7C92\u5EA6\u5212\u5206-\u8868\u7EA7\u9501\u3001\u9875\u7EA7\u9501\u3001\u884C\u9501" aria-hidden="true">#</a> 3.2 \u4ECE\u6570\u636E\u64CD\u4F5C\u7684\u7C92\u5EA6\u5212\u5206\uFF1A\u8868\u7EA7\u9501\u3001\u9875\u7EA7\u9501\u3001\u884C\u9501</h5><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711214719510.png" alt="image-20220711214719510" style="float:left;"><h6 id="_1-\u8868\u9501-table-lock" tabindex="-1"><a class="header-anchor" href="#_1-\u8868\u9501-table-lock" aria-hidden="true">#</a> 1. \u8868\u9501\uFF08Table Lock\uFF09</h6><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711214805088.png" alt="image-20220711214805088" style="float:left;"><p>######## \u2460 \u8868\u7EA7\u522B\u7684S\u9501\u3001X\u9501</p><p>\u5728\u5BF9\u67D0\u4E2A\u8868\u6267\u884CSELECT\u3001INSERT\u3001DELETE\u3001UPDATE\u8BED\u53E5\u65F6\uFF0CInnoDB\u5B58\u50A8\u5F15\u64CE\u662F\u4E0D\u4F1A\u4E3A\u8FD9\u4E2A\u8868\u6DFB\u52A0\u8868\u7EA7\u522B\u7684 <code>S\u9501</code> \u6216\u8005 <code>X\u9501</code> \u7684\u3002\u5728\u5BF9\u67D0\u4E2A\u8868\u6267\u884C\u4E00\u4E9B\u8BF8\u5982 <code>ALTER TABLE \u3001 DROP TABLE</code> \u8FD9\u7C7B\u7684 DDL \u8BED\u53E5\u65F6\uFF0C\u5176 \u4ED6\u4E8B\u52A1\u5BF9\u8FD9\u4E2A\u8868\u5E76\u53D1\u6267\u884C\u8BF8\u5982SELECT\u3001INSERT\u3001DELETE\u3001UPDATE\u7684\u8BED\u53E5\u4F1A\u53D1\u751F\u963B\u585E\u3002\u540C\u7406\uFF0C\u67D0\u4E2A\u4E8B\u52A1\u4E2D\u5BF9\u67D0\u4E2A\u8868\u6267\u884CSELECT\u3001INSERT\u3001DELETE\u3001UPDATE\u8BED\u53E5\u65F6\uFF0C\u5728\u5176\u4ED6\u4F1A\u8BDD\u4E2D\u5BF9\u8FD9\u4E2A\u8868\u6267\u884C <code>DDL</code> \u8BED\u53E5\u4E5F\u4F1A \u53D1\u751F\u963B\u585E\u3002\u8FD9\u4E2A\u8FC7\u7A0B\u5176\u5B9E\u662F\u901A\u8FC7\u5728 server\u5C42\u4F7F\u7528\u4E00\u79CD\u79F0\u4E4B\u4E3A <code>\u5143\u6570\u636E\u9501</code> \uFF08\u82F1\u6587\u540D\uFF1A Metadata Locks \uFF0C \u7B80\u79F0 MDL \uFF09\u7ED3\u6784\u6765\u5B9E\u73B0\u7684\u3002</p><p>\u4E00\u822C\u60C5\u51B5\u4E0B\uFF0C\u4E0D\u4F1A\u4F7F\u7528InnoDB\u5B58\u50A8\u5F15\u64CE\u63D0\u4F9B\u7684\u8868\u7EA7\u522B\u7684 <code>S\u9501</code> \u548C <code>X\u9501</code> \u3002\u53EA\u4F1A\u5728\u4E00\u4E9B\u7279\u6B8A\u60C5\u51B5\u4E0B\uFF0C\u6BD4\u65B9\u8BF4 <code>\u5D29\u6E83\u6062\u590D</code> \u8FC7\u7A0B\u4E2D\u7528\u5230\u3002\u6BD4\u5982\uFF0C\u5728\u7CFB\u7EDF\u53D8\u91CF <code>autocommit=0\uFF0Cinnodb_table_locks = 1</code> \u65F6\uFF0C \u624B\u52A8 \u83B7\u53D6 InnoDB\u5B58\u50A8\u5F15\u64CE\u63D0\u4F9B\u7684\u8868t \u7684 <code>S\u9501</code> \u6216\u8005 <code>X\u9501</code> \u53EF\u4EE5\u8FD9\u4E48\u5199\uFF1A</p><ul><li><p><code>LOCK TABLES t READ</code> \uFF1AInnoDB\u5B58\u50A8\u5F15\u64CE\u4F1A\u5BF9\u8868 t \u52A0\u8868\u7EA7\u522B\u7684 <code>S\u9501 </code>\u3002</p></li><li><p><code>LOCK TABLES t WRITE</code> \uFF1AInnoDB\u5B58\u50A8\u5F15\u64CE\u4F1A\u5BF9\u8868 t \u52A0\u8868\u7EA7\u522B\u7684 <code>X\u9501</code> \u3002</p></li></ul><p>\u4E0D\u8FC7\u5C3D\u91CF\u907F\u514D\u5728\u4F7F\u7528InnoDB\u5B58\u50A8\u5F15\u64CE\u7684\u8868\u4E0A\u4F7F\u7528 <code>LOCK TABLES</code> \u8FD9\u6837\u7684\u624B\u52A8\u9501\u8868\u8BED\u53E5\uFF0C\u5B83\u4EEC\u5E76\u4E0D\u4F1A\u63D0\u4F9B \u4EC0\u4E48\u989D\u5916\u7684\u4FDD\u62A4\uFF0C\u53EA\u662F\u4F1A\u964D\u4F4E\u5E76\u53D1\u80FD\u529B\u800C\u5DF2\u3002InnoDB\u7684\u5389\u5BB3\u4E4B\u5904\u8FD8\u662F\u5B9E\u73B0\u4E86\u66F4\u7EC6\u7C92\u5EA6\u7684 <code>\u884C\u9501</code> \uFF0C\u5173\u4E8E InnoDB\u8868\u7EA7\u522B\u7684 <code>S\u9501</code> \u548C<code> X\u9501</code> \u5927\u5BB6\u4E86\u89E3\u4E00\u4E0B\u5C31\u53EF\u4EE5\u4E86\u3002</p><p>**\u4E3E\u4F8B\uFF1A**\u4E0B\u9762\u6211\u4EEC\u8BB2\u89E3MyISAM\u5F15\u64CE\u4E0B\u7684\u8868\u9501\u3002</p><p>\u6B65\u9AA41\uFF1A\u521B\u5EFA\u8868\u5E76\u6DFB\u52A0\u6570\u636E</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE mylock(
id INT NOT NULL PRIMARY KEY auto_increment,
NAME VARCHAR(20)
)ENGINE myisam;

# \u63D2\u5165\u4E00\u6761\u6570\u636E
INSERT INTO mylock(NAME) VALUES(&#39;a&#39;);

# \u67E5\u8BE2\u8868\u4E2D\u6240\u6709\u6570\u636E
SELECT * FROM mylock;
+----+------+
| id | Name |
+----+------+
| 1  | a    |
+----+------+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B65\u9AA4\u4E8C\uFF1A\u67E5\u770B\u8868\u4E0A\u52A0\u8FC7\u7684\u9501</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>SHOW OPEN TABLES; # \u4E3B\u8981\u5173\u6CE8In_use\u5B57\u6BB5\u7684\u503C
\u6216\u8005
SHOW OPEN TABLES where In_use &gt; 0;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711220342251.png" alt="image-20220711220342251" style="float:left;"><p>\u6216\u8005</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711220418859.png" alt="image-20220711220418859" style="float:left;"><p>\u4E0A\u9762\u7684\u7ED3\u679C\u8868\u660E\uFF0C\u5F53\u524D\u6570\u636E\u5E93\u4E2D\u6CA1\u6709\u88AB\u9501\u5B9A\u7684\u8868</p><p>\u6B65\u9AA43\uFF1A\u624B\u52A8\u589E\u52A0\u8868\u9501\u547D\u4EE4</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>LOCK TABLES t READ; # \u5B58\u50A8\u5F15\u64CE\u4F1A\u5BF9\u8868t\u52A0\u8868\u7EA7\u522B\u7684\u5171\u4EAB\u9501\u3002\u5171\u4EAB\u9501\u4E5F\u53EB\u8BFB\u9501\u6216S\u9501\uFF08Share\u7684\u7F29\u5199\uFF09
LOCK TABLES t WRITE; # \u5B58\u50A8\u5F15\u64CE\u4F1A\u5BF9\u8868t\u52A0\u8868\u7EA7\u522B\u7684\u6392\u4ED6\u9501\u3002\u6392\u4ED6\u9501\u4E5F\u53EB\u72EC\u5360\u9501\u3001\u5199\u9501\u6216X\u9501\uFF08exclusive\u7684\u7F29\u5199\uFF09
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6BD4\u5982\uFF1A</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711220442269.png" alt="image-20220711220442269" style="float:left;"><p>\u6B65\u9AA44\uFF1A\u91CA\u653E\u8868\u9501</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>UNLOCK TABLES; # \u4F7F\u7528\u6B64\u547D\u4EE4\u89E3\u9501\u5F53\u524D\u52A0\u9501\u7684\u8868
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u6BD4\u5982\uFF1A</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711220502141.png" alt="image-20220711220502141" style="float:left;"><p>\u6B65\u9AA45\uFF1A\u52A0\u8BFB\u9501</p><p>\u6211\u4EEC\u4E3Amylock\u8868\u52A0read\u9501\uFF08\u8BFB\u963B\u585E\u5199\uFF09\uFF0C\u89C2\u5BDF\u963B\u585E\u7684\u60C5\u51B5\uFF0C\u6D41\u7A0B\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711220553225.png" alt="image-20220711220553225"></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711220616537.png" alt="image-20220711220616537"></p><p>\u6B65\u9AA46\uFF1A\u52A0\u5199\u9501</p><p>\u4E3Amylock\u8868\u52A0write\u9501\uFF0C\u89C2\u5BDF\u963B\u585E\u7684\u60C5\u51B5\uFF0C\u6D41\u7A0B\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711220711630.png" alt="image-20220711220711630"></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711220730112.png" alt="image-20220711220730112"></p><p>\u603B\u7ED3\uFF1A</p><p>MyISAM\u5728\u6267\u884C\u67E5\u8BE2\u8BED\u53E5\uFF08SELECT\uFF09\u524D\uFF0C\u4F1A\u7ED9\u6D89\u53CA\u7684\u6240\u6709\u8868\u52A0\u8BFB\u9501\uFF0C\u5728\u6267\u884C\u589E\u5220\u6539\u64CD\u4F5C\u524D\uFF0C\u4F1A\u7ED9\u6D89\u53CA\u7684\u8868\u52A0\u5199\u9501\u3002InnoDB\u5B58\u50A8\u5F15\u64CE\u662F\u4E0D\u4F1A\u4E3A\u8FD9\u4E2A\u8868\u6DFB\u52A0\u8868\u7EA7\u522B\u7684\u8BFB\u9501\u548C\u5199\u9501\u7684\u3002</p><p>MySQL\u7684\u8868\u7EA7\u9501\u6709\u4E24\u79CD\u6A21\u5F0F\uFF1A\uFF08\u4EE5MyISAM\u8868\u8FDB\u884C\u64CD\u4F5C\u7684\u6F14\u793A\uFF09</p><ul><li><p>\u8868\u5171\u4EAB\u8BFB\u9501\uFF08Table Read Lock\uFF09</p></li><li><p>\u8868\u72EC\u5360\u5199\u9501\uFF08Table Write Lock\uFF09</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711220929248.png" alt="image-20220711220929248"></p></li></ul><p>######## \u2461 \u610F\u5411\u9501 \uFF08intention lock\uFF09</p><p>InnoDB \u652F\u6301 <code>\u591A\u7C92\u5EA6\u9501\uFF08multiple granularity locking\uFF09</code> \uFF0C\u5B83\u5141\u8BB8 <code>\u884C\u7EA7\u9501</code> \u4E0E <code>\u8868\u7EA7\u9501</code> \u5171\u5B58\uFF0C\u800C<code>\u610F\u5411\u9501</code>\u5C31\u662F\u5176\u4E2D\u7684\u4E00\u79CD <code>\u8868\u9501</code> \u3002</p><ol><li>\u610F\u5411\u9501\u7684\u5B58\u5728\u662F\u4E3A\u4E86\u534F\u8C03\u884C\u9501\u548C\u8868\u9501\u7684\u5173\u7CFB\uFF0C\u652F\u6301\u591A\u7C92\u5EA6\uFF08\u8868\u9501\u548C\u884C\u9501\uFF09\u7684\u9501\u5E76\u5B58\u3002</li><li>\u610F\u5411\u9501\u662F\u4E00\u79CD<code>\u4E0D\u4E0E\u884C\u7EA7\u9501\u51B2\u7A81\u8868\u7EA7\u9501</code>\uFF0C\u8FD9\u4E00\u70B9\u975E\u5E38\u91CD\u8981\u3002</li><li>\u8868\u660E\u201C\u67D0\u4E2A\u4E8B\u52A1\u6B63\u5728\u67D0\u4E9B\u884C\u6301\u6709\u4E86\u9501\u6216\u8BE5\u4E8B\u52A1\u51C6\u5907\u53BB\u6301\u6709\u9501\u201D</li></ol><p>\u610F\u5411\u9501\u5206\u4E3A\u4E24\u79CD\uFF1A</p><ul><li><p><strong>\u610F\u5411\u5171\u4EAB\u9501</strong>\uFF08intention shared lock, IS\uFF09\uFF1A\u4E8B\u52A1\u6709\u610F\u5411\u5BF9\u8868\u4E2D\u7684\u67D0\u4E9B\u884C\u52A0<strong>\u5171\u4EAB\u9501</strong>\uFF08S\u9501\uFF09</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>-- \u4E8B\u52A1\u8981\u83B7\u53D6\u67D0\u4E9B\u884C\u7684 S \u9501\uFF0C\u5FC5\u987B\u5148\u83B7\u5F97\u8868\u7684 IS \u9501\u3002
SELECT column FROM table ... LOCK IN SHARE MODE;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>\u610F\u5411\u6392\u4ED6\u9501</strong>\uFF08intention exclusive lock, IX\uFF09\uFF1A\u4E8B\u52A1\u6709\u610F\u5411\u5BF9\u8868\u4E2D\u7684\u67D0\u4E9B\u884C\u52A0<strong>\u6392\u4ED6\u9501</strong>\uFF08X\u9501\uFF09</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>-- \u4E8B\u52A1\u8981\u83B7\u53D6\u67D0\u4E9B\u884C\u7684 X \u9501\uFF0C\u5FC5\u987B\u5148\u83B7\u5F97\u8868\u7684 IX \u9501\u3002
SELECT column FROM table ... FOR UPDATE;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>\u5373\uFF1A\u610F\u5411\u9501\u662F\u7531\u5B58\u50A8\u5F15\u64CE <code>\u81EA\u5DF1\u7EF4\u62A4\u7684</code> \uFF0C\u7528\u6237\u65E0\u6CD5\u624B\u52A8\u64CD\u4F5C\u610F\u5411\u9501\uFF0C\u5728\u4E3A\u6570\u636E\u884C\u52A0\u5171\u4EAB / \u6392\u4ED6\u9501\u4E4B\u524D\uFF0C InooDB \u4F1A\u5148\u83B7\u53D6\u8BE5\u6570\u636E\u884C <code>\u6240\u5728\u6570\u636E\u8868\u7684\u5BF9\u5E94\u610F\u5411\u9501</code> \u3002</p><p><strong>1. \u610F\u5411\u9501\u8981\u89E3\u51B3\u7684\u95EE\u9898</strong></p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220711222132300.png" alt="image-20220711222132300" style="float:left;"><p>**\u4E3E\u4F8B\uFF1A**\u521B\u5EFA\u8868teacher,\u63D2\u51656\u6761\u6570\u636E\uFF0C\u4E8B\u52A1\u7684\u9694\u79BB\u7EA7\u522B\u9ED8\u8BA4\u4E3A<code>Repeatable-Read</code>\uFF0C\u5982\u4E0B\u6240\u793A\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE \`teacher\` (
	\`id\` int NOT NULL,
    \`name\` varchar(255) NOT NULL,
    PRIMARY KEY (\`id\`)
)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

INSERT INTO \`teacher\` VALUES
(&#39;1&#39;, &#39;zhangsan&#39;),
(&#39;2&#39;, &#39;lisi&#39;),
(&#39;3&#39;, &#39;wangwu&#39;),
(&#39;4&#39;, &#39;zhaoliu&#39;),
(&#39;5&#39;, &#39;songhongkang&#39;),
(&#39;6&#39;, &#39;leifengyang&#39;);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; SELECT @@transaction_isolation;
+-------------------------+
| @@transaction_isolation |
+-------------------------+
| REPEATABLE-READ         |
+-------------------------+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5047\u8BBE\u4E8B\u52A1A\u83B7\u53D6\u4E86\u67D0\u4E00\u884C\u7684\u6392\u4ED6\u9501\uFF0C\u5E76\u672A\u63D0\u4EA4\uFF0C\u8BED\u53E5\u5982\u4E0B\u6240\u793A:</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;

SELECT * FROM teacher WHERE id = 6 FOR UPDATE;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E8B\u52A1B\u60F3\u8981\u83B7\u53D6teacher\u8868\u7684\u8868\u8BFB\u9501\uFF0C\u8BED\u53E5\u5982\u4E0B\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;

LOCK TABLES teacher READ;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220712124209006.png" alt="image-20220712124209006" style="float:left;"><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;

SELECT * FROM teacher WHERE id = 6 FOR UPDATE;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u65F6teacher\u8868\u5B58\u5728\u4E24\u628A\u9501\uFF1Ateacher\u8868\u4E0A\u7684\u610F\u5411\u6392\u4ED6\u9501\u4E0Eid\u672A6\u7684\u6570\u636E\u884C\u4E0A\u7684\u6392\u4ED6\u9501\u3002\u4E8B\u52A1B\u60F3\u8981\u83B7\u53D6teacher\u8868\u7684\u5171\u4EAB\u9501\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;

LOCK TABLES teacher READ;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u65F6\u4E8B\u52A1B\u68C0\u6D4B\u4E8B\u52A1A\u6301\u6709teacher\u8868\u7684\u610F\u5411\u6392\u4ED6\u9501\uFF0C\u5C31\u53EF\u4EE5\u5F97\u77E5\u4E8B\u52A1A\u5FC5\u987B\u6301\u6709\u8BE5\u8868\u4E2D\u67D0\u4E9B\u6570\u636E\u884C\u7684\u6392\u4ED6\u9501\uFF0C\u90A3\u4E48\u4E8B\u52A1B\u5BF9teacher\u8868\u7684\u52A0\u9501\u8BF7\u6C42\u5C31\u4F1A\u88AB\u6392\u65A5\uFF08\u963B\u585E\uFF09\uFF0C\u800C\u65E0\u9700\u53BB\u68C0\u6D4B\u8868\u4E2D\u7684\u6BCF\u4E00\u884C\u6570\u636E\u662F\u5426\u5B58\u5728\u6392\u4ED6\u9501\u3002</p><p><strong>\u610F\u5411\u9501\u7684\u5E76\u53D1\u6027</strong></p><p>\u610F\u5411\u9501\u4E0D\u4F1A\u4E0E\u884C\u7EA7\u7684\u5171\u4EAB / \u6392\u4ED6\u9501\u4E92\u65A5\uFF01\u6B63\u56E0\u4E3A\u5982\u6B64\uFF0C\u610F\u5411\u9501\u5E76\u4E0D\u4F1A\u5F71\u54CD\u5230\u591A\u4E2A\u4E8B\u52A1\u5BF9\u4E0D\u540C\u6570\u636E\u884C\u52A0\u6392\u4ED6\u9501\u65F6\u7684\u5E76\u53D1\u6027\u3002\uFF08\u4E0D\u7136\u6211\u4EEC\u76F4\u63A5\u7528\u666E\u901A\u7684\u8868\u9501\u5C31\u884C\u4E86\uFF09</p><p>\u6211\u4EEC\u6269\u5C55\u4E00\u4E0B\u4E0A\u9762 teacher\u8868\u7684\u4F8B\u5B50\u6765\u6982\u62EC\u4E00\u4E0B\u610F\u5411\u9501\u7684\u4F5C\u7528\uFF08\u4E00\u6761\u6570\u636E\u4ECE\u88AB\u9501\u5B9A\u5230\u88AB\u91CA\u653E\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u53EF \u80FD\u5B58\u5728\u591A\u79CD\u4E0D\u540C\u9501\uFF0C\u4F46\u662F\u8FD9\u91CC\u6211\u4EEC\u53EA\u7740\u91CD\u8868\u73B0\u610F\u5411\u9501\uFF09\u3002</p><p>\u4E8B\u52A1A\u5148\u83B7\u5F97\u4E86\u67D0\u4E00\u884C\u7684\u6392\u4ED6\u9501\uFF0C\u5E76\u672A\u63D0\u4EA4\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;

SELECT * FROM teacher WHERE id = 6 FOR UPDATE;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E8B\u52A1A\u83B7\u53D6\u4E86teacher\u8868\u4E0A\u7684\u610F\u5411\u6392\u4ED6\u9501\u3002\u4E8B\u52A1A\u83B7\u53D6\u4E86id\u4E3A6\u7684\u6570\u636E\u884C\u4E0A\u7684\u6392\u4ED6\u9501\u3002\u4E4B\u540E\u4E8B\u52A1B\u60F3\u8981\u83B7\u53D6teacher\u8868\u4E0A\u7684\u5171\u4EAB\u9501\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;

LOCK TABLES teacher READ;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E8B\u52A1B\u68C0\u6D4B\u5230\u4E8B\u52A1A\u6301\u6709teacher\u8868\u7684\u610F\u5411\u6392\u4ED6\u9501\u3002\u4E8B\u52A1B\u5BF9teacher\u8868\u7684\u52A0\u9501\u8BF7\u6C42\u88AB\u963B\u585E\uFF08\u6392\u65A5\uFF09\u3002\u6700\u540E\u4E8B\u52A1C\u4E5F\u60F3\u83B7\u53D6teacher\u8868\u4E2D\u67D0\u4E00\u884C\u7684\u6392\u4ED6\u9501\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>BEGIN;

SELECT * FROM teacher WHERE id = 5 FOR UPDATE;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E8B\u52A1C\u7533\u8BF7teacher\u8868\u7684\u610F\u5411\u6392\u4ED6\u9501\u3002\u4E8B\u52A1C\u68C0\u6D4B\u5230\u4E8B\u52A1A\u6301\u6709teacher\u8868\u7684\u610F\u5411\u6392\u4ED6\u9501\u3002\u56E0\u4E3A\u610F\u5411\u9501\u4E4B\u95F4\u5E76\u4E0D\u4E92\u65A5\uFF0C\u6240\u4EE5\u4E8B\u52A1C\u83B7\u53D6\u5230\u4E86teacher\u8868\u7684\u610F\u5411\u6392\u4ED6\u9501\u3002\u56E0\u4E3Aid\u4E3A5\u7684\u6570\u636E\u884C\u4E0A\u4E0D\u5B58\u5728\u4EFB\u4F55\u6392\u4ED6\u9501\uFF0C\u6700\u7EC8\u4E8B\u52A1C\u6210\u529F\u83B7\u53D6\u5230\u4E86\u8BE5\u6570\u636E\u884C\u4E0A\u7684\u6392\u4ED6\u9501\u3002</p><p><strong>\u4ECE\u4E0A\u9762\u7684\u6848\u4F8B\u53EF\u4EE5\u5F97\u5230\u5982\u4E0B\u7ED3\u8BBA\uFF1A</strong></p><ol><li>InnoDB \u652F\u6301 <code>\u591A\u7C92\u5EA6\u9501</code> \uFF0C\u7279\u5B9A\u573A\u666F\u4E0B\uFF0C\u884C\u7EA7\u9501\u53EF\u4EE5\u4E0E\u8868\u7EA7\u9501\u5171\u5B58\u3002</li><li>\u610F\u5411\u9501\u4E4B\u95F4\u4E92\u4E0D\u6392\u65A5\uFF0C\u4F46\u9664\u4E86 IS \u4E0E S \u517C\u5BB9\u5916\uFF0C <code>\u610F\u5411\u9501\u4F1A\u4E0E \u5171\u4EAB\u9501 / \u6392\u4ED6\u9501 \u4E92\u65A5</code> \u3002</li><li>IX\uFF0CIS\u662F\u8868\u7EA7\u9501\uFF0C\u4E0D\u4F1A\u548C\u884C\u7EA7\u7684X\uFF0CS\u9501\u53D1\u751F\u51B2\u7A81\u3002\u53EA\u4F1A\u548C\u8868\u7EA7\u7684X\uFF0CS\u53D1\u751F\u51B2\u7A81\u3002</li><li>\u610F\u5411\u9501\u5728\u4FDD\u8BC1\u5E76\u53D1\u6027\u7684\u524D\u63D0\u4E0B\uFF0C\u5B9E\u73B0\u4E86 <code>\u884C\u9501\u548C\u8868\u9501\u5171\u5B58</code> \u4E14 <code>\u6EE1\u8DB3\u4E8B\u52A1\u9694\u79BB\u6027</code> \u7684\u8981\u6C42\u3002</li></ol><p>######## \u2462 \u81EA\u589E\u9501\uFF08AUTO-INC\u9501\uFF09</p><p>\u5728\u4F7F\u7528MySQL\u8FC7\u7A0B\u4E2D\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4E3A\u8868\u7684\u67D0\u4E2A\u5217\u6DFB\u52A0 <code>AUTO_INCREMENT</code> \u5C5E\u6027\u3002\u4E3E\u4F8B\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE \`teacher\` (
\`id\` int NOT NULL AUTO_INCREMENT,
\`name\` varchar(255) NOT NULL,
PRIMARY KEY (\`id\`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7531\u4E8E\u8FD9\u4E2A\u8868\u7684id\u5B57\u6BB5\u58F0\u660E\u4E86AUTO_INCREMENT\uFF0C\u610F\u5473\u7740\u5728\u4E66\u5199\u63D2\u5165\u8BED\u53E5\u65F6\u4E0D\u9700\u8981\u4E3A\u5176\u8D4B\u503C\uFF0CSQL\u8BED\u53E5\u4FEE\u6539 \u5982\u4E0B\u6240\u793A\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>INSERT INTO \`teacher\` (name) VALUES (&#39;zhangsan&#39;), (&#39;lisi&#39;);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4E0A\u8FB9\u7684\u63D2\u5165\u8BED\u53E5\u5E76\u6CA1\u6709\u4E3Aid\u5217\u663E\u5F0F\u8D4B\u503C\uFF0C\u6240\u4EE5\u7CFB\u7EDF\u4F1A\u81EA\u52A8\u4E3A\u5B83\u8D4B\u4E0A\u9012\u589E\u7684\u503C\uFF0C\u7ED3\u679C\u5982\u4E0B\u6240\u793A\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; select * from teacher;
+----+----------+
| id | name     |
+----+----------+
| 1  | zhangsan |
| 2  | lisi     |
+----+----------+
2 rows in set (0.00 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u73B0\u5728\u6211\u4EEC\u770B\u5230\u7684\u4E0A\u9762\u63D2\u5165\u6570\u636E\u53EA\u662F\u4E00\u79CD\u7B80\u5355\u7684\u63D2\u5165\u6A21\u5F0F\uFF0C\u6240\u6709\u63D2\u5165\u6570\u636E\u7684\u65B9\u5F0F\u603B\u5171\u5206\u4E3A\u4E09\u7C7B\uFF0C\u5206\u522B\u662F \u201C <code>Simple inserts</code> \u201D\uFF0C\u201C <code>Bulk inserts</code> \u201D\u548C\u201C <code>Mixed-mode inserts </code>\u201D\u3002</p><p><strong>1. \u201CSimple inserts\u201D \uFF08\u7B80\u5355\u63D2\u5165\uFF09</strong></p><p>\u53EF\u4EE5 <code>\u9884\u5148\u786E\u5B9A\u8981\u63D2\u5165\u7684\u884C\u6570</code> \uFF08\u5F53\u8BED\u53E5\u88AB\u521D\u59CB\u5904\u7406\u65F6\uFF09\u7684\u8BED\u53E5\u3002\u5305\u62EC\u6CA1\u6709\u5D4C\u5957\u5B50\u67E5\u8BE2\u7684\u5355\u884C\u548C\u591A\u884C<code>INSERT...VALUES()</code>\u548C <code>REPLACE</code> \u8BED\u53E5\u3002\u6BD4\u5982\u6211\u4EEC\u4E0A\u9762\u4E3E\u7684\u4F8B\u5B50\u5C31\u5C5E\u4E8E\u8BE5\u7C7B\u63D2\u5165\uFF0C\u5DF2\u7ECF\u786E\u5B9A\u8981\u63D2\u5165\u7684\u884C \u6570\u3002</p><p><strong>2. \u201CBulk inserts\u201D \uFF08\u6279\u91CF\u63D2\u5165\uFF09</strong></p><p><code>\u4E8B\u5148\u4E0D\u77E5\u9053\u8981\u63D2\u5165\u7684\u884C\u6570</code> \uFF08\u548C\u6240\u9700\u81EA\u52A8\u9012\u589E\u503C\u7684\u6570\u91CF\uFF09\u7684\u8BED\u53E5\u3002\u6BD4\u5982 <code>INSERT ... SELECT</code> \uFF0C <code>REPLACE ... SELECT</code> \u548C <code>LOAD DATA</code> \u8BED\u53E5\uFF0C\u4F46\u4E0D\u5305\u62EC\u7EAFINSERT\u3002 InnoDB\u5728\u6BCF\u5904\u7406\u4E00\u884C\uFF0C\u4E3AAUTO_INCREMENT\u5217</p><p><strong>3. \u201CMixed-mode inserts\u201D \uFF08\u6DF7\u5408\u6A21\u5F0F\u63D2\u5165\uFF09</strong></p><p>\u8FD9\u4E9B\u662F\u201CSimple inserts\u201D\u8BED\u53E5\u4F46\u662F\u6307\u5B9A\u90E8\u5206\u65B0\u884C\u7684\u81EA\u52A8\u9012\u589E\u503C\u3002\u4F8B\u5982 <code>INSERT INTO teacher (id,name) VALUES (1,&#39;a&#39;), (NULL,&#39;b&#39;), (5,&#39;c&#39;), (NULL,&#39;d&#39;);</code> \u53EA\u662F\u6307\u5B9A\u4E86\u90E8\u5206id\u7684\u503C\u3002\u53E6\u4E00\u79CD\u7C7B\u578B\u7684\u201C\u6DF7\u5408\u6A21\u5F0F\u63D2\u5165\u201D\u662F <code>INSERT ... ON DUPLICATE KEY UPDATE</code> \u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220712175552985.png" alt="image-20220712175552985" style="float:left;"><p>innodb_autoinc_lock_mode\u6709\u4E09\u79CD\u53D6\u503C\uFF0C\u5206\u522B\u5BF9\u5E94\u4E0E\u4E0D\u540C\u9501\u5B9A\u6A21\u5F0F\uFF1A</p><p><code>\uFF081\uFF09innodb_autoinc_lock_mode = 0(\u201C\u4F20\u7EDF\u201D\u9501\u5B9A\u6A21\u5F0F)</code></p><p>\u5728\u6B64\u9501\u5B9A\u6A21\u5F0F\u4E0B\uFF0C\u6240\u6709\u7C7B\u578B\u7684insert\u8BED\u53E5\u90FD\u4F1A\u83B7\u5F97\u4E00\u4E2A\u7279\u6B8A\u7684\u8868\u7EA7AUTO-INC\u9501\uFF0C\u7528\u4E8E\u63D2\u5165\u5177\u6709 AUTO_INCREMENT\u5217\u7684\u8868\u3002\u8FD9\u79CD\u6A21\u5F0F\u5176\u5B9E\u5C31\u5982\u6211\u4EEC\u4E0A\u9762\u7684\u4F8B\u5B50\uFF0C\u5373\u6BCF\u5F53\u6267\u884Cinsert\u7684\u65F6\u5019\uFF0C\u90FD\u4F1A\u5F97\u5230\u4E00\u4E2A \u8868\u7EA7\u9501(AUTO-INC\u9501)\uFF0C\u4F7F\u5F97\u8BED\u53E5\u4E2D\u751F\u6210\u7684auto_increment\u4E3A\u987A\u5E8F\uFF0C\u4E14\u5728binlog\u4E2D\u91CD\u653E\u7684\u65F6\u5019\uFF0C\u53EF\u4EE5\u4FDD\u8BC1 master\u4E0Eslave\u4E2D\u6570\u636E\u7684auto_increment\u662F\u76F8\u540C\u7684\u3002\u56E0\u4E3A\u662F\u8868\u7EA7\u9501\uFF0C\u5F53\u5728\u540C\u4E00\u65F6\u95F4\u591A\u4E2A\u4E8B\u52A1\u4E2D\u6267\u884Cinsert\u7684 \u65F6\u5019\uFF0C\u5BF9\u4E8EAUTO-INC\u9501\u7684\u4E89\u593A\u4F1A <code>\u9650\u5236\u5E76\u53D1</code> \u80FD\u529B\u3002</p><p><code>\uFF082\uFF09innodb_autoinc_lock_mode = 1(\u201C\u8FDE\u7EED\u201D\u9501\u5B9A\u6A21\u5F0F)</code></p><p>\u5728 MySQL 8.0 \u4E4B\u524D\uFF0C\u8FDE\u7EED\u9501\u5B9A\u6A21\u5F0F\u662F <code>\u9ED8\u8BA4</code> \u7684\u3002</p><p>\u5728\u8FD9\u4E2A\u6A21\u5F0F\u4E0B\uFF0C\u201Cbulk inserts\u201D\u4ECD\u7136\u4F7F\u7528AUTO-INC\u8868\u7EA7\u9501\uFF0C\u5E76\u4FDD\u6301\u5230\u8BED\u53E5\u7ED3\u675F\u3002\u8FD9\u9002\u7528\u4E8E\u6240\u6709INSERT ... SELECT\uFF0CREPLACE ... SELECT\u548CLOAD DATA\u8BED\u53E5\u3002\u540C\u4E00\u65F6\u523B\u53EA\u6709\u4E00\u4E2A\u8BED\u53E5\u53EF\u4EE5\u6301\u6709AUTO-INC\u9501\u3002</p><p>\u5BF9\u4E8E\u201CSimple inserts\u201D\uFF08\u8981\u63D2\u5165\u7684\u884C\u6570\u4E8B\u5148\u5DF2\u77E5\uFF09\uFF0C\u5219\u901A\u8FC7\u5728 <code>mutex\uFF08\u8F7B\u91CF\u9501\uFF09</code> \u7684\u63A7\u5236\u4E0B\u83B7\u5F97\u6240\u9700\u6570\u91CF\u7684\u81EA\u52A8\u9012\u589E\u503C\u6765\u907F\u514D\u8868\u7EA7AUTO-INC\u9501\uFF0C \u5B83\u53EA\u5728\u5206\u914D\u8FC7\u7A0B\u7684\u6301\u7EED\u65F6\u95F4\u5185\u4FDD\u6301\uFF0C\u800C\u4E0D\u662F\u76F4\u5230\u8BED\u53E5\u5B8C\u6210\u3002\u4E0D\u4F7F\u7528\u8868\u7EA7AUTO-INC\u9501\uFF0C\u9664\u975EAUTO-INC\u9501\u7531\u53E6\u4E00\u4E2A\u4E8B\u52A1\u4FDD\u6301\u3002\u5982\u679C\u53E6\u4E00\u4E2A\u4E8B\u52A1\u4FDD\u6301AUTO-INC\u9501\uFF0C\u5219\u201CSimple inserts\u201D\u7B49\u5F85AUTO-INC\u9501\uFF0C\u5982\u540C\u5B83\u662F\u4E00\u4E2A\u201Cbulk inserts\u201D\u3002</p><p><code>\uFF083\uFF09innodb_autoinc_lock_mode = 2(\u201C\u4EA4\u9519\u201D\u9501\u5B9A\u6A21\u5F0F)</code></p><p>\u4ECE MySQL 8.0 \u5F00\u59CB\uFF0C\u4EA4\u9519\u9501\u6A21\u5F0F\u662F <code>\u9ED8\u8BA4</code> \u8BBE\u7F6E\u3002</p><p>\u5728\u6B64\u9501\u5B9A\u6A21\u5F0F\u4E0B\uFF0C\u81EA\u52A8\u9012\u589E\u503C <code>\u4FDD\u8BC1</code> \u5728\u6240\u6709\u5E76\u53D1\u6267\u884C\u7684\u6240\u6709\u7C7B\u578B\u7684insert\u8BED\u53E5\u4E2D\u662F <code>\u552F\u4E00</code> \u4E14 <code>\u5355\u8C03\u9012\u589E</code> \u7684\u3002\u4F46\u662F\uFF0C\u7531\u4E8E\u591A\u4E2A\u8BED\u53E5\u53EF\u4EE5\u540C\u65F6\u751F\u6210\u6570\u5B57\uFF08\u5373\uFF0C\u8DE8\u8BED\u53E5\u4EA4\u53C9\u7F16\u53F7\uFF09\uFF0C<strong>\u4E3A\u4EFB\u4F55\u7ED9\u5B9A\u8BED\u53E5\u63D2\u5165\u7684\u884C\u751F\u6210\u7684\u503C\u53EF\u80FD\u4E0D\u662F\u8FDE\u7EED\u7684\u3002</strong></p><p>\u5982\u679C\u6267\u884C\u7684\u8BED\u53E5\u662F\u201Csimple inserts&quot;\uFF0C\u5176\u4E2D\u8981\u63D2\u5165\u7684\u884C\u6570\u5DF2\u63D0\u524D\u77E5\u9053\uFF0C\u9664\u4E86&quot;Mixed-mode inserts&quot;\u4E4B\u5916\uFF0C\u4E3A\u5355\u4E2A\u8BED\u53E5\u751F\u6210\u7684\u6570\u5B57\u4E0D\u4F1A\u6709\u95F4\u9699\u3002\u7136\u540E\uFF0C\u5F53\u6267\u884C&quot;bulk inserts&quot;\u65F6\uFF0C\u5728\u7531\u4EFB\u4F55\u7ED9\u5B9A\u8BED\u53E5\u5206\u914D\u7684\u81EA\u52A8\u9012\u589E\u503C\u4E2D\u53EF\u80FD\u5B58\u5728\u95F4\u9699\u3002</p><p>######## \u2463 \u5143\u6570\u636E\u9501\uFF08MDL\u9501\uFF09</p><p>MySQL5.5\u5F15\u5165\u4E86meta data lock\uFF0C\u7B80\u79F0MDL\u9501\uFF0C\u5C5E\u4E8E\u8868\u9501\u8303\u7574\u3002MDL \u7684\u4F5C\u7528\u662F\uFF0C\u4FDD\u8BC1\u8BFB\u5199\u7684\u6B63\u786E\u6027\u3002\u6BD4 \u5982\uFF0C\u5982\u679C\u4E00\u4E2A\u67E5\u8BE2\u6B63\u5728\u904D\u5386\u4E00\u4E2A\u8868\u4E2D\u7684\u6570\u636E\uFF0C\u800C\u6267\u884C\u671F\u95F4\u53E6\u4E00\u4E2A\u7EBF\u7A0B\u5BF9\u8FD9\u4E2A <code>\u8868\u7ED3\u6784\u505A\u53D8\u66F4</code> \uFF0C\u589E\u52A0\u4E86\u4E00 \u5217\uFF0C\u90A3\u4E48\u67E5\u8BE2\u7EBF\u7A0B\u62FF\u5230\u7684\u7ED3\u679C\u8DDF\u8868\u7ED3\u6784\u5BF9\u4E0D\u4E0A\uFF0C\u80AF\u5B9A\u662F\u4E0D\u884C\u7684\u3002</p><p>\u56E0\u6B64\uFF0C<strong>\u5F53\u5BF9\u4E00\u4E2A\u8868\u505A\u589E\u5220\u6539\u67E5\u64CD\u4F5C\u7684\u65F6\u5019\uFF0C\u52A0 MDL\u8BFB\u9501\uFF1B\u5F53\u8981\u5BF9\u8868\u505A\u7ED3\u6784\u53D8\u66F4\u64CD\u4F5C\u7684\u65F6\u5019\uFF0C\u52A0 MDL \u5199\u9501</strong>\u3002</p><p>\u8BFB\u9501\u4E4B\u95F4\u4E0D\u4E92\u65A5\uFF0C\u56E0\u6B64\u4F60\u53EF\u4EE5\u6709\u591A\u4E2A\u7EBF\u7A0B\u540C\u65F6\u5BF9\u4E00\u5F20\u8868\u589E\u5220\u67E5\u6539\u3002\u8BFB\u5199\u9501\u4E4B\u95F4\u3001\u5199\u9501\u4E4B\u95F4\u90FD\u662F\u4E92\u65A5\u7684\uFF0C\u7528\u6765\u4FDD\u8BC1\u53D8\u66F4\u8868\u7ED3\u6784\u64CD\u4F5C\u7684\u5B89\u5168\u6027\uFF0C\u89E3\u51B3\u4E86DML\u548CDDL\u64CD\u4F5C\u4E4B\u95F4\u7684\u4E00\u81F4\u6027\u95EE\u9898\u3002<code>\u4E0D\u9700\u8981\u663E\u5F0F\u4F7F\u7528</code>\uFF0C\u5728\u8BBF\u95EE\u4E00\u4E2A\u8868\u7684\u65F6\u5019\u4F1A\u88AB\u81EA\u52A8\u52A0\u4E0A\u3002</p><p><strong>\u4E3E\u4F8B\uFF1A\u5143\u6570\u636E\u9501\u7684\u4F7F\u7528\u573A\u666F\u6A21\u62DF</strong></p><p>**\u4F1A\u8BDDA\uFF1A**\u4ECE\u8868\u4E2D\u67E5\u8BE2\u6570\u636E</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; BEGIN;
Query OK, 0 rows affected (0.00 sec)
mysql&gt; SELECT COUNT(1) FROM teacher;
+----------+
| COUNT(1) |
+----------+
| 2        |
+----------+
1 row int set (7.46 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**\u4F1A\u8BDDB\uFF1A**\u4FEE\u6539\u8868\u7ED3\u6784\uFF0C\u589E\u52A0\u65B0\u5217</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; BEGIN;
Query OK, 0 rows affected (0.00 sec)
mysql&gt; alter table teacher add age int not null;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**\u4F1A\u8BDDC\uFF1A**\u67E5\u770B\u5F53\u524DMySQL\u7684\u8FDB\u7A0B</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; show processlist;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713142808924.png" alt="image-20220713142808924"></p><p>\u901A\u8FC7\u4F1A\u8BDDC\u53EF\u4EE5\u770B\u51FA\u4F1A\u8BDDB\u88AB\u963B\u585E\uFF0C\u8FD9\u662F\u7531\u4E8E\u4F1A\u8BDDA\u62FF\u5230\u4E86teacher\u8868\u7684\u5143\u6570\u636E\u8BFB\u9501\uFF0C\u4F1A\u8BDDB\u60F3\u7533\u8BF7teacher\u8868\u7684\u5143\u6570\u636E\u5199\u9501\uFF0C\u7531\u4E8E\u8BFB\u5199\u9501\u4E92\u65A5\uFF0C\u4F1A\u8BDDB\u9700\u8981\u7B49\u5F85\u4F1A\u8BDDA\u91CA\u653E\u5143\u6570\u636E\u9501\u624D\u80FD\u6267\u884C\u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713143156759.png" alt="image-20220713143156759" style="float:left;"><h6 id="_2-innodb\u4E2D\u7684\u884C\u9501" tabindex="-1"><a class="header-anchor" href="#_2-innodb\u4E2D\u7684\u884C\u9501" aria-hidden="true">#</a> 2. InnoDB\u4E2D\u7684\u884C\u9501</h6><p>\u884C\u9501\uFF08Row Lock\uFF09\u4E5F\u79F0\u4E3A\u8BB0\u5F55\u9501\uFF0C\u987E\u540D\u601D\u4E49\uFF0C\u5C31\u662F\u9501\u4F4F\u67D0\u4E00\u884C\uFF08\u67D0\u6761\u8BB0\u5F55 row\uFF09\u3002\u9700\u8981\u6CE8\u610F\u7684\u662F\uFF0CMySQL\u670D\u52A1\u5668\u5C42\u5E76\u6CA1\u6709\u5B9E\u73B0\u884C\u9501\u673A\u5236\uFF0C<strong>\u884C\u7EA7\u9501\u53EA\u5728\u5B58\u50A8\u5F15\u64CE\u5C42\u5B9E\u73B0</strong>\u3002</p><p>**\u4F18\u70B9\uFF1A**\u9501\u5B9A\u529B\u5EA6\u5C0F\uFF0C\u53D1\u751F<code>\u9501\u51B2\u7A81\u6982\u7387\u4F4E</code>\uFF0C\u53EF\u4EE5\u5B9E\u73B0\u7684<code>\u5E76\u53D1\u5EA6\u9AD8</code>\u3002</p><p>**\u7F3A\u70B9\uFF1A**\u5BF9\u4E8E<code>\u9501\u7684\u5F00\u9500\u6BD4\u8F83\u5927</code>\uFF0C\u52A0\u9501\u4F1A\u6BD4\u8F83\u6162\uFF0C\u5BB9\u6613\u51FA\u73B0<code>\u6B7B\u9501</code>\u60C5\u51B5\u3002</p><p>InnoDB\u4E0EMyISAM\u7684\u6700\u5927\u4E0D\u540C\u6709\u4E24\u70B9\uFF1A\u4E00\u662F\u652F\u6301 <code>\u4E8B\u7269\uFF08TRANSACTION\uFF09</code>\uFF1B\u4E8C\u662F\u91C7\u7528\u4E86 <code>\u884C\u7EA7\u9501</code>\u3002</p><p>\u9996\u5148\u6211\u4EEC\u521B\u5EFA\u8868\u5982\u4E0B\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE student (
	id INT,
    name VARCHAR(20),
    class VARCHAR(10),
    PRIMARY KEY (id)
) Engine=InnoDB CHARSET=utf8;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5411\u8FD9\u4E2A\u8868\u91CC\u63D2\u5165\u51E0\u6761\u8BB0\u5F55\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>INSERT INTO student VALUES
(1, &#39;\u5F20\u4E09&#39;, &#39;\u4E00\u73ED&#39;),
(3, &#39;\u674E\u56DB&#39;, &#39;\u4E00\u73ED&#39;),
(8, &#39;\u738B\u4E94&#39;, &#39;\u4E8C\u73ED&#39;),
(15, &#39;\u8D75\u516D&#39;, &#39;\u4E8C\u73ED&#39;),
(20, &#39;\u94B1\u4E03&#39;, &#39;\u4E09\u73ED&#39;);

mysql&gt; SELECT * FROM student;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713161549241.png" alt="image-20220713161549241" style="float:left;"><p>student\u8868\u4E2D\u7684\u805A\u7C07\u7D22\u5F15\u7684\u7B80\u56FE\u5982\u4E0B\u6240\u793A\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713163353648.png" alt="image-20220713163353648"></p><p>\u8FD9\u91CC\u628AB+\u6811\u7684\u7D22\u5F15\u7ED3\u6784\u505A\u4E86\u8D85\u7EA7\u7B80\u5316\uFF0C\u53EA\u628A\u7D22\u5F15\u4E2D\u7684\u8BB0\u5F55\u7ED9\u62FF\u4E86\u51FA\u6765\uFF0C\u4E0B\u9762\u770B\u770B\u90FD\u6709\u54EA\u4E9B\u5E38\u7528\u7684\u884C\u9501\u7C7B\u578B\u3002</p><p>######## \u2460 \u8BB0\u5F55\u9501\uFF08Record Locks\uFF09</p><p>\u8BB0\u5F55\u9501\u4E5F\u5C31\u662F\u4EC5\u4EC5\u628A\u4E00\u6761\u8BB0\u5F55\u9501\uFF0C\u5B98\u65B9\u7684\u7C7B\u578B\u540D\u79F0\u4E3A\uFF1A<code>LOCK_REC_NOT_GAP</code>\u3002\u6BD4\u5982\u6211\u4EEC\u628Aid\u503C\u4E3A8\u7684\u90A3\u6761\u8BB0\u5F55\u52A0\u4E00\u4E2A\u8BB0\u5F55\u9501\u7684\u793A\u610F\u56FE\u5982\u679C\u6240\u793A\u3002\u4EC5\u4EC5\u662F\u9501\u4F4F\u4E86id\u503C\u4E3A8\u7684\u8BB0\u5F55\uFF0C\u5BF9\u5468\u56F4\u7684\u6570\u636E\u6CA1\u6709\u5F71\u54CD\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713164811567.png" alt="image-20220713164811567"></p><p>\u4E3E\u4F8B\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713164948405.png" alt="image-20220713164948405"></p><p>\u8BB0\u5F55\u9501\u662F\u6709S\u9501\u548CX\u9501\u4E4B\u5206\u7684\uFF0C\u79F0\u4E4B\u4E3A <code>S\u578B\u8BB0\u5F55\u9501</code> \u548C <code>X\u578B\u8BB0\u5F55\u9501</code> \u3002</p><ul><li>\u5F53\u4E00\u4E2A\u4E8B\u52A1\u83B7\u53D6\u4E86\u4E00\u6761\u8BB0\u5F55\u7684S\u578B\u8BB0\u5F55\u9501\u540E\uFF0C\u5176\u4ED6\u4E8B\u52A1\u4E5F\u53EF\u4EE5\u7EE7\u7EED\u83B7\u53D6\u8BE5\u8BB0\u5F55\u7684S\u578B\u8BB0\u5F55\u9501\uFF0C\u4F46\u4E0D\u53EF\u4EE5\u7EE7\u7EED\u83B7\u53D6X\u578B\u8BB0\u5F55\u9501\uFF1B</li><li>\u5F53\u4E00\u4E2A\u4E8B\u52A1\u83B7\u53D6\u4E86\u4E00\u6761\u8BB0\u5F55\u7684X\u578B\u8BB0\u5F55\u9501\u540E\uFF0C\u5176\u4ED6\u4E8B\u52A1\u65E2\u4E0D\u53EF\u4EE5\u7EE7\u7EED\u83B7\u53D6\u8BE5\u8BB0\u5F55\u7684S\u578B\u8BB0\u5F55\u9501\uFF0C\u4E5F\u4E0D\u53EF\u4EE5\u7EE7\u7EED\u83B7\u53D6X\u578B\u8BB0\u5F55\u9501\u3002</li></ul><p>######## \u2461 \u95F4\u9699\u9501\uFF08Gap Locks\uFF09</p><p><code>MySQL</code> \u5728 <code>REPEATABLE READ</code> \u9694\u79BB\u7EA7\u522B\u4E0B\u662F\u53EF\u4EE5\u89E3\u51B3\u5E7B\u8BFB\u95EE\u9898\u7684\uFF0C\u89E3\u51B3\u65B9\u6848\u6709\u4E24\u79CD\uFF0C\u53EF\u4EE5\u4F7F\u7528 <code>MVCC</code> \u65B9 \u6848\u89E3\u51B3\uFF0C\u4E5F\u53EF\u4EE5\u91C7\u7528 <code>\u52A0\u9501 </code>\u65B9\u6848\u89E3\u51B3\u3002\u4F46\u662F\u5728\u4F7F\u7528\u52A0\u9501\u65B9\u6848\u89E3\u51B3\u65F6\u6709\u4E2A\u5927\u95EE\u9898\uFF0C\u5C31\u662F\u4E8B\u52A1\u5728\u7B2C\u4E00\u6B21\u6267\u884C\u8BFB\u53D6\u64CD\u4F5C\u65F6\uFF0C\u90A3\u4E9B\u5E7B\u5F71\u8BB0\u5F55\u5C1A\u4E0D\u5B58\u5728\uFF0C\u6211\u4EEC\u65E0\u6CD5\u7ED9\u8FD9\u4E9B <code>\u5E7B\u5F71\u8BB0\u5F55</code> \u52A0\u4E0A <code>\u8BB0\u5F55\u9501</code> \u3002InnoDB\u63D0\u51FA\u4E86\u4E00\u79CD\u79F0\u4E4B\u4E3A <code>Gap Locks</code> \u7684\u9501\uFF0C\u5B98\u65B9\u7684\u7C7B\u578B\u540D\u79F0\u4E3A\uFF1A<code> LOCK_GAP</code> \uFF0C\u6211\u4EEC\u53EF\u4EE5\u7B80\u79F0\u4E3A <code>gap\u9501</code> \u3002\u6BD4\u5982\uFF0C\u628Aid\u503C\u4E3A8\u7684\u90A3\u6761 \u8BB0\u5F55\u52A0\u4E00\u4E2Agap\u9501\u7684\u793A\u610F\u56FE\u5982\u4E0B\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713171650888.png" alt="image-20220713171650888"></p><p>\u56FE\u4E2Did\u503C\u4E3A8\u7684\u8BB0\u5F55\u52A0\u4E86gap\u9501\uFF0C\u610F\u5473\u7740 <code>\u4E0D\u5141\u8BB8\u522B\u7684\u4E8B\u52A1\u5728id\u503C\u4E3A8\u7684\u8BB0\u5F55\u524D\u8FB9\u7684\u95F4\u9699\u63D2\u5165\u65B0\u8BB0\u5F55</code> \uFF0C\u5176\u5B9E\u5C31\u662F id\u5217\u7684\u503C(3, 8)\u8FD9\u4E2A\u533A\u95F4\u7684\u65B0\u8BB0\u5F55\u662F\u4E0D\u5141\u8BB8\u7ACB\u5373\u63D2\u5165\u7684\u3002\u6BD4\u5982\uFF0C\u6709\u53E6\u5916\u4E00\u4E2A\u4E8B\u52A1\u518D\u60F3\u63D2\u5165\u4E00\u6761id\u503C\u4E3A4\u7684\u65B0 \u8BB0\u5F55\uFF0C\u5B83\u5B9A\u4F4D\u5230\u8BE5\u6761\u65B0\u8BB0\u5F55\u7684\u4E0B\u4E00\u6761\u8BB0\u5F55\u7684id\u503C\u4E3A8\uFF0C\u800C\u8FD9\u6761\u8BB0\u5F55\u4E0A\u53C8\u6709\u4E00\u4E2Agap\u9501\uFF0C\u6240\u4EE5\u5C31\u4F1A\u963B\u585E\u63D2\u5165 \u64CD\u4F5C\uFF0C\u76F4\u5230\u62E5\u6709\u8FD9\u4E2Agap\u9501\u7684\u4E8B\u52A1\u63D0\u4EA4\u4E86\u4E4B\u540E\uFF0Cid\u5217\u7684\u503C\u5728\u533A\u95F4(3, 8)\u4E2D\u7684\u65B0\u8BB0\u5F55\u624D\u53EF\u4EE5\u88AB\u63D2\u5165\u3002</p><p>**gap\u9501\u7684\u63D0\u51FA\u4EC5\u4EC5\u662F\u4E3A\u4E86\u9632\u6B62\u63D2\u5165\u5E7B\u5F71\u8BB0\u5F55\u800C\u63D0\u51FA\u7684\u3002**\u867D\u7136\u6709<code>\u5171\u4EABgap\u9501</code>\u548C<code>\u72EC\u5360gap\u9501</code>\u8FD9\u6837\u7684\u8BF4\u6CD5\uFF0C\u4F46\u662F\u5B83\u4EEC\u8D77\u5230\u7684\u4F5C\u7528\u662F\u76F8\u540C\u7684\u3002\u800C\u4E14\u5982\u679C\u5BF9\u4E00\u6761\u8BB0\u5F55\u52A0\u4E86gap\u9501\uFF08\u4E0D\u8BBA\u662F\u5171\u4EABgap\u9501\u8FD8\u662F\u72EC\u5360gap\u9501\uFF09\uFF0C\u5E76\u4E0D\u4F1A\u9650\u5236\u5176\u4ED6\u4E8B\u52A1\u5BF9\u8FD9\u6761\u8BB0\u5F55\u52A0\u8BB0\u5F55\u9501\u6216\u8005\u7EE7\u7EED\u52A0gap\u9501\u3002</p><p><strong>\u4E3E\u4F8B\uFF1A</strong></p><table><thead><tr><th>Session1</th><th>Session2</th></tr></thead><tbody><tr><td>select * from student where id=5 lock in share mode;</td><td></td></tr><tr><td></td><td>select * from student where id=5 for update;</td></tr></tbody></table><p>\u8FD9\u91CCsession2\u5E76\u4E0D\u4F1A\u88AB\u5835\u4F4F\u3002\u56E0\u4E3A\u8868\u91CC\u5E76\u6CA1\u6709id=5\u8FD9\u6761\u8BB0\u5F55\uFF0C\u56E0\u6B64session1\u5609\u7684\u662F\u95F4\u9699\u9501(3,8)\u3002\u800Csession2\u4E5F\u662F\u5728\u8FD9\u4E2A\u95F4\u9699\u52A0\u7684\u95F4\u9699\u9501\u3002\u5B83\u4EEC\u6709\u5171\u540C\u7684\u76EE\u6807\uFF0C\u5373\uFF1A\u4FDD\u62A4\u8FD9\u4E2A\u95F4\u9699\u9501\uFF0C\u4E0D\u5141\u8BB8\u63D2\u5165\u503C\u3002\u4F46\uFF0C\u5B83\u4EEC\u4E4B\u95F4\u662F\u4E0D\u51B2\u7A81\u7684\u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713174726264.png" alt="image-20220713174726264" style="float:left;"><ul><li><code>Infimum</code>\u8BB0\u5F55\uFF0C\u8868\u793A\u8BE5\u9875\u9762\u4E2D\u6700\u5C0F\u7684\u8BB0\u5F55\u3002</li><li><code>Supremun</code>\u8BB0\u5F55\uFF0C\u8868\u793A\u8BE5\u9875\u9762\u4E2D\u6700\u5927\u7684\u8BB0\u5F55\u3002</li></ul><p>\u4E3A\u4E86\u5B9E\u73B0\u963B\u6B62\u5176\u4ED6\u4E8B\u52A1\u63D2\u5165id\u503C\u518D(20,\u6B63\u65E0\u7A77)\u8FD9\u4E2A\u533A\u95F4\u7684\u65B0\u7EAA\u5F55\uFF0C\u6211\u4EEC\u53EF\u4EE5\u7ED9\u7D22\u5F15\u4E2D\u7684\u6700\u540E\u4E00\u6761\u8BB0\u5F55\uFF0C\u4E5F\u5C31\u662Fid\u503C\u4E3A20\u7684\u90A3\u6761\u8BB0\u5F55\u6240\u5728\u9875\u9762\u7684Supremun\u8BB0\u5F55\u52A0\u4E0A\u4E00\u4E2Agap\u9501\uFF0C\u5982\u56FE\u6240\u793A\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713174108634.png" alt="image-20220713174108634"></p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; select * from student where id &gt; 20 lock in share mode;
Empty set (0.01 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u68C0\u6D4B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713174551814.png" alt="image-20220713174551814"></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713174602102.png" alt="image-20220713174602102"></p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713175032619.png" alt="image-20220713175032619" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713192418730.png" alt="image-20220713192418730" style="float:left;"><p>######## \u2462 \u4E34\u952E\u9501\uFF08Next-Key Locks\uFF09</p><p>\u6709\u65F6\u5019\u6211\u4EEC\u65E2\u60F3 <code>\u9501\u4F4F\u67D0\u6761\u8BB0\u5F55</code> \uFF0C\u53C8\u60F3 \u963B\u6B62 \u5176\u4ED6\u4E8B\u52A1\u5728\u8BE5\u8BB0\u5F55\u524D\u8FB9\u7684 \u95F4\u9699\u63D2\u5165\u65B0\u8BB0\u5F55 \uFF0C\u6240\u4EE5InnoDB\u5C31\u63D0 \u51FA\u4E86\u4E00\u79CD\u79F0\u4E4B\u4E3A Next-Key Locks \u7684\u9501\uFF0C\u5B98\u65B9\u7684\u7C7B\u578B\u540D\u79F0\u4E3A\uFF1A LOCK_ORDINARY \uFF0C\u6211\u4EEC\u4E5F\u53EF\u4EE5\u7B80\u79F0\u4E3A next-key\u9501 \u3002Next-Key Locks\u662F\u5728\u5B58\u50A8\u5F15\u64CE innodb \u3001\u4E8B\u52A1\u7EA7\u522B\u5728 \u53EF\u91CD\u590D\u8BFB \u7684\u60C5\u51B5\u4E0B\u4F7F\u7528\u7684\u6570\u636E\u5E93\u9501\uFF0C innodb\u9ED8\u8BA4\u7684\u9501\u5C31\u662FNext-Key locks\u3002\u6BD4\u5982\uFF0C\u6211\u4EEC\u628Aid\u503C\u4E3A8\u7684\u90A3\u6761\u8BB0\u5F55\u52A0\u4E00\u4E2Anext-key\u9501\u7684\u793A\u610F\u56FE\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713192549340.png" alt="image-20220713192549340"></p><p><code>next-key\u9501</code>\u7684\u672C\u8D28\u5C31\u662F\u4E00\u4E2A<code>\u8BB0\u5F55\u9501</code>\u548C\u4E00\u4E2A<code>gap\u9501</code>\u7684\u5408\u4F53\uFF0C\u5B83\u65E2\u80FD\u4FDD\u62A4\u8BE5\u6761\u8BB0\u5F55\uFF0C\u53C8\u80FD\u963B\u6B62\u522B\u7684\u4E8B\u52A1\u5C06\u65B0\u8BB0\u5F55\u63D2\u5165\u88AB\u4FDD\u62A4\u8BB0\u5F55\u524D\u8FB9\u7684<code>\u95F4\u9699</code>\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>begin;
select * from student where id &lt;=8 and id &gt; 3 for update;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>######## \u2463 \u63D2\u5165\u610F\u5411\u9501</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713203124889.png" alt="image-20220713203124889" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713203532124.png" alt="image-20220713203532124" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713203619704.png" alt="image-20220713203619704" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713203714577.png" alt="image-20220713203714577" style="float:left;"><h6 id="_3-\u9875\u9501" tabindex="-1"><a class="header-anchor" href="#_3-\u9875\u9501" aria-hidden="true">#</a> 3. \u9875\u9501</h6><p>\u9875\u9501\u5C31\u662F\u5728 <code>\u9875\u7684\u7C92\u5EA6</code> \u4E0A\u8FDB\u884C\u9501\u5B9A\uFF0C\u9501\u5B9A\u7684\u6570\u636E\u8D44\u6E90\u6BD4\u884C\u9501\u8981\u591A\uFF0C\u56E0\u4E3A\u4E00\u4E2A\u9875\u4E2D\u53EF\u4EE5\u6709\u591A\u4E2A\u884C\u8BB0\u5F55\u3002\u5F53\u6211 \u4EEC\u4F7F\u7528\u9875\u9501\u7684\u65F6\u5019\uFF0C\u4F1A\u51FA\u73B0\u6570\u636E\u6D6A\u8D39\u7684\u73B0\u8C61\uFF0C\u4F46\u8FD9\u6837\u7684\u6D6A\u8D39\u6700\u591A\u4E5F\u5C31\u662F\u4E00\u4E2A\u9875\u4E0A\u7684\u6570\u636E\u884C\u3002<strong>\u9875\u9501\u7684\u5F00\u9500\u4ECB\u4E8E\u8868\u9501\u548C\u884C\u9501\u4E4B\u95F4\uFF0C\u4F1A\u51FA\u73B0\u6B7B\u9501\u3002\u9501\u5B9A\u7C92\u5EA6\u4ECB\u4E8E\u8868\u9501\u548C\u884C\u9501\u4E4B\u95F4\uFF0C\u5E76\u53D1\u5EA6\u4E00\u822C\u3002</strong></p><p>\u6BCF\u4E2A\u5C42\u7EA7\u7684\u9501\u6570\u91CF\u662F\u6709\u9650\u5236\u7684\uFF0C\u56E0\u4E3A\u9501\u4F1A\u5360\u7528\u5185\u5B58\u7A7A\u95F4\uFF0C <code>\u9501\u7A7A\u95F4\u7684\u5927\u5C0F\u662F\u6709\u9650\u7684</code> \u3002\u5F53\u67D0\u4E2A\u5C42\u7EA7\u7684\u9501\u6570\u91CF \u8D85\u8FC7\u4E86\u8FD9\u4E2A\u5C42\u7EA7\u7684\u9608\u503C\u65F6\uFF0C\u5C31\u4F1A\u8FDB\u884C <code>\u9501\u5347\u7EA7</code> \u3002\u9501\u5347\u7EA7\u5C31\u662F\u7528\u66F4\u5927\u7C92\u5EA6\u7684\u9501\u66FF\u4EE3\u591A\u4E2A\u66F4\u5C0F\u7C92\u5EA6\u7684\u9501\uFF0C\u6BD4\u5982 InnoDB \u4E2D\u884C\u9501\u5347\u7EA7\u4E3A\u8868\u9501\uFF0C\u8FD9\u6837\u505A\u7684\u597D\u5904\u662F\u5360\u7528\u7684\u9501\u7A7A\u95F4\u964D\u4F4E\u4E86\uFF0C\u4F46\u540C\u65F6\u6570\u636E\u7684\u5E76\u53D1\u5EA6\u4E5F\u4E0B\u964D\u4E86\u3002</p><h5 id="_3-3-\u4ECE\u5BF9\u5F85\u9501\u7684\u6001\u5EA6\u5212\u5206-\u4E50\u89C2\u9501\u3001\u60B2\u89C2\u9501" tabindex="-1"><a class="header-anchor" href="#_3-3-\u4ECE\u5BF9\u5F85\u9501\u7684\u6001\u5EA6\u5212\u5206-\u4E50\u89C2\u9501\u3001\u60B2\u89C2\u9501" aria-hidden="true">#</a> 3.3 \u4ECE\u5BF9\u5F85\u9501\u7684\u6001\u5EA6\u5212\u5206:\u4E50\u89C2\u9501\u3001\u60B2\u89C2\u9501</h5><p>\u4ECE\u5BF9\u5F85\u9501\u7684\u6001\u5EA6\u6765\u770B\u9501\u7684\u8BDD\uFF0C\u53EF\u4EE5\u5C06\u9501\u5206\u6210\u4E50\u89C2\u9501\u548C\u60B2\u89C2\u9501\uFF0C\u4ECE\u540D\u5B57\u4E2D\u4E5F\u53EF\u4EE5\u770B\u51FA\u8FD9\u4E24\u79CD\u9501\u662F\u4E24\u79CD\u770B\u5F85 <code>\u6570\u636E\u5E76\u53D1\u7684\u601D\u7EF4\u65B9\u5F0F</code> \u3002\u9700\u8981\u6CE8\u610F\u7684\u662F\uFF0C\u4E50\u89C2\u9501\u548C\u60B2\u89C2\u9501\u5E76\u4E0D\u662F\u9501\uFF0C\u800C\u662F\u9501\u7684 <code>\u8BBE\u8BA1\u601D\u60F3</code> \u3002</p><h6 id="_1-\u60B2\u89C2\u9501-pessimistic-locking" tabindex="-1"><a class="header-anchor" href="#_1-\u60B2\u89C2\u9501-pessimistic-locking" aria-hidden="true">#</a> 1. \u60B2\u89C2\u9501\uFF08Pessimistic Locking\uFF09</h6><p>\u60B2\u89C2\u9501\u662F\u4E00\u79CD\u601D\u60F3\uFF0C\u987E\u540D\u601D\u4E49\uFF0C\u5C31\u662F\u5F88\u60B2\u89C2\uFF0C\u5BF9\u6570\u636E\u88AB\u5176\u4ED6\u4E8B\u52A1\u7684\u4FEE\u6539\u6301\u4FDD\u5B88\u6001\u5EA6\uFF0C\u4F1A\u901A\u8FC7\u6570\u636E\u5E93\u81EA\u8EAB\u7684\u9501\u673A\u5236\u6765\u5B9E\u73B0\uFF0C\u4ECE\u800C\u4FDD\u8BC1\u6570\u636E\u64CD\u4F5C\u7684\u6392\u5B83\u6027\u3002</p><p>\u60B2\u89C2\u9501\u603B\u662F\u5047\u8BBE\u6700\u574F\u7684\u60C5\u51B5\uFF0C\u6BCF\u6B21\u53BB\u62FF\u6570\u636E\u7684\u65F6\u5019\u90FD\u8BA4\u4E3A\u522B\u4EBA\u4F1A\u4FEE\u6539\uFF0C\u6240\u4EE5\u6BCF\u6B21\u5728\u62FF\u6570\u636E\u7684\u65F6\u5019\u90FD\u4F1A\u4E0A\u9501\uFF0C\u8FD9\u6837\u522B\u4EBA\u60F3\u62FF\u8FD9\u4E2A\u6570\u636E\u5C31\u4F1A <code>\u963B\u585E</code> \u76F4\u5230\u5B83\u62FF\u5230\u9501\uFF08<strong>\u5171\u4EAB\u8D44\u6E90\u6BCF\u6B21\u53EA\u7ED9\u4E00\u4E2A\u7EBF\u7A0B\u4F7F\u7528\uFF0C\u5176\u5B83\u7EBF\u7A0B\u963B\u585E\uFF0C \u7528\u5B8C\u540E\u518D\u628A\u8D44\u6E90\u8F6C\u8BA9\u7ED9\u5176\u5B83\u7EBF\u7A0B</strong>\uFF09\u3002\u6BD4\u5982\u884C\u9501\uFF0C\u8868\u9501\u7B49\uFF0C\u8BFB\u9501\uFF0C\u5199\u9501\u7B49\uFF0C\u90FD\u662F\u5728\u505A\u64CD\u4F5C\u4E4B\u524D\u5148\u4E0A\u9501\uFF0C\u5F53\u5176\u4ED6\u7EBF\u7A0B\u60F3\u8981\u8BBF\u95EE\u6570\u636E\u65F6\uFF0C\u90FD\u9700\u8981\u963B\u585E\u6302\u8D77\u3002Java\u4E2D <code>synchronized</code> \u548C <code>ReentrantLock</code> \u7B49\u72EC\u5360\u9501\u5C31\u662F\u60B2\u89C2\u9501\u601D\u60F3\u7684\u5B9E\u73B0\u3002</p><p><strong>\u79D2\u6740\u6848\u4F8B1\uFF1A</strong></p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713204544767.png" alt="image-20220713204544767" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713205010502.png" alt="image-20220713205010502" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713205135694.png" alt="image-20220713205135694" style="float:left;"><h6 id="_2-\u4E50\u89C2\u9501-optimistic-locking" tabindex="-1"><a class="header-anchor" href="#_2-\u4E50\u89C2\u9501-optimistic-locking" aria-hidden="true">#</a> 2. \u4E50\u89C2\u9501\uFF08Optimistic Locking\uFF09</h6><p>\u4E50\u89C2\u9501\u8BA4\u4E3A\u5BF9\u540C\u4E00\u6570\u636E\u7684\u5E76\u53D1\u64CD\u4F5C\u4E0D\u4F1A\u603B\u53D1\u751F\uFF0C\u5C5E\u4E8E\u5C0F\u6982\u7387\u4E8B\u4EF6\uFF0C\u4E0D\u7528\u6BCF\u6B21\u90FD\u5BF9\u6570\u636E\u4E0A\u9501\uFF0C\u4F46\u662F\u5728\u66F4\u65B0\u7684\u65F6\u5019\u4F1A\u5224\u65AD\u4E00\u4E0B\u5728\u6B64\u671F\u95F4\u522B\u4EBA\u6709\u6CA1\u6709\u53BB\u66F4\u65B0\u8FD9\u4E2A\u6570\u636E\uFF0C\u4E5F\u5C31\u662F<strong>\u4E0D\u91C7\u7528\u6570\u636E\u5E93\u81EA\u8EAB\u7684\u9501\u673A\u5236\uFF0C\u800C\u662F\u901A\u8FC7\u7A0B\u5E8F\u6765\u5B9E\u73B0</strong>\u3002\u5728\u7A0B\u5E8F\u4E0A\uFF0C\u6211\u4EEC\u53EF\u4EE5\u91C7\u7528 <code>\u7248\u672C\u53F7\u673A\u5236</code> \u6216\u8005 <code>CAS\u673A\u5236</code> \u5B9E\u73B0\u3002<strong>\u4E50\u89C2\u9501\u9002\u7528\u4E8E\u591A\u8BFB\u7684\u5E94\u7528\u7C7B\u578B\uFF0C \u8FD9\u6837\u53EF\u4EE5\u63D0\u9AD8\u541E\u5410\u91CF</strong>\u3002\u5728Java\u4E2D<code> java.util.concurrent.atomic</code> \u5305\u4E0B\u7684\u539F\u5B50\u53D8\u91CF\u7C7B\u5C31\u662F\u4F7F\u7528\u4E86\u4E50\u89C2\u9501\u7684\u4E00\u79CD\u5B9E\u73B0\u65B9\u5F0F\uFF1ACAS\u5B9E\u73B0\u7684\u3002</p><p><strong>1. \u4E50\u89C2\u9501\u7684\u7248\u672C\u53F7\u673A\u5236</strong></p><p>\u5728\u8868\u4E2D\u8BBE\u8BA1\u4E00\u4E2A <code>\u7248\u672C\u5B57\u6BB5 version</code> \uFF0C\u7B2C\u4E00\u6B21\u8BFB\u7684\u65F6\u5019\uFF0C\u4F1A\u83B7\u53D6 version \u5B57\u6BB5\u7684\u53D6\u503C\u3002\u7136\u540E\u5BF9\u6570\u636E\u8FDB\u884C\u66F4\u65B0\u6216\u5220\u9664\u64CD\u4F5C\u65F6\uFF0C\u4F1A\u6267\u884C <code>UPDATE ... SET version=version+1 WHERE version=version</code> \u3002\u6B64\u65F6 \u5982\u679C\u5DF2\u7ECF\u6709\u4E8B\u52A1\u5BF9\u8FD9\u6761\u6570\u636E\u8FDB\u884C\u4E86\u66F4\u6539\uFF0C\u4FEE\u6539\u5C31\u4E0D\u4F1A\u6210\u529F\u3002</p><p>\u8FD9\u79CD\u65B9\u5F0F\u7C7B\u4F3C\u6211\u4EEC\u719F\u6089\u7684SVN\u3001CVS\u7248\u672C\u7BA1\u7406\u7CFB\u7EDF\uFF0C\u5F53\u6211\u4EEC\u4FEE\u6539\u4E86\u4EE3\u7801\u8FDB\u884C\u63D0\u4EA4\u65F6\uFF0C\u9996\u5148\u4F1A\u68C0\u67E5\u5F53\u524D\u7248\u672C\u53F7\u4E0E\u670D\u52A1\u5668\u4E0A\u7684\u7248\u672C\u53F7\u662F\u5426\u4E00\u81F4\uFF0C\u5982\u679C\u4E00\u81F4\u5C31\u53EF\u4EE5\u76F4\u63A5\u63D0\u4EA4\uFF0C\u5982\u679C\u4E0D\u4E00\u81F4\u5C31\u9700\u8981\u66F4\u65B0\u670D\u52A1\u5668\u4E0A\u7684\u6700\u65B0\u4EE3\u7801\uFF0C\u7136\u540E\u518D\u8FDB\u884C\u63D0\u4EA4\u3002</p><p><strong>2. \u4E50\u89C2\u9501\u7684\u65F6\u95F4\u6233\u673A\u5236</strong></p><p>\u65F6\u95F4\u6233\u548C\u7248\u672C\u53F7\u673A\u5236\u4E00\u6837\uFF0C\u4E5F\u662F\u5728\u66F4\u65B0\u63D0\u4EA4\u7684\u65F6\u5019\uFF0C\u5C06\u5F53\u524D\u6570\u636E\u7684\u65F6\u95F4\u6233\u548C\u66F4\u65B0\u4E4B\u524D\u53D6\u5F97\u7684\u65F6\u95F4\u6233\u8FDB\u884C \u6BD4\u8F83\uFF0C\u5982\u679C\u4E24\u8005\u4E00\u81F4\u5219\u66F4\u65B0\u6210\u529F\uFF0C\u5426\u5219\u5C31\u662F\u7248\u672C\u51B2\u7A81\u3002</p><p>\u4F60\u80FD\u770B\u5230\u4E50\u89C2\u9501\u5C31\u662F\u7A0B\u5E8F\u5458\u81EA\u5DF1\u63A7\u5236\u6570\u636E\u5E76\u53D1\u64CD\u4F5C\u7684\u6743\u9650\uFF0C\u57FA\u672C\u662F\u901A\u8FC7\u7ED9\u6570\u636E\u884C\u589E\u52A0\u4E00\u4E2A\u6233\uFF08\u7248\u672C\u53F7\u6216 \u8005\u65F6\u95F4\u6233\uFF09\uFF0C\u4ECE\u800C\u8BC1\u660E\u5F53\u524D\u62FF\u5230\u7684\u6570\u636E\u662F\u5426\u6700\u65B0\u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713210951100.png" alt="image-20220713210951100" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713211139670.png" alt="image-20220713211139670" style="float:left;"><h6 id="_3-\u4E24\u79CD\u9501\u7684\u9002\u7528\u573A\u666F" tabindex="-1"><a class="header-anchor" href="#_3-\u4E24\u79CD\u9501\u7684\u9002\u7528\u573A\u666F" aria-hidden="true">#</a> 3. \u4E24\u79CD\u9501\u7684\u9002\u7528\u573A\u666F</h6><p>\u4ECE\u8FD9\u4E24\u79CD\u9501\u7684\u8BBE\u8BA1\u601D\u60F3\u4E2D\uFF0C\u6211\u4EEC\u603B\u7ED3\u4E00\u4E0B\u4E50\u89C2\u9501\u548C\u60B2\u89C2\u9501\u7684\u9002\u7528\u573A\u666F\uFF1A</p><ol><li><code>\u4E50\u89C2\u9501</code> \u9002\u5408 <code>\u8BFB\u64CD\u4F5C\u591A</code> \u7684\u573A\u666F\uFF0C\u76F8\u5BF9\u6765\u8BF4\u5199\u7684\u64CD\u4F5C\u6BD4\u8F83\u5C11\u3002\u5B83\u7684\u4F18\u70B9\u5728\u4E8E <code>\u7A0B\u5E8F\u5B9E\u73B0</code> \uFF0C <code>\u4E0D\u5B58\u5728\u6B7B\u9501</code> \u95EE\u9898\uFF0C\u4E0D\u8FC7\u9002\u7528\u573A\u666F\u4E5F\u4F1A\u76F8\u5BF9\u4E50\u89C2\uFF0C\u56E0\u4E3A\u5B83\u963B\u6B62\u4E0D\u4E86\u9664\u4E86\u7A0B\u5E8F\u4EE5\u5916\u7684\u6570\u636E\u5E93\u64CD\u4F5C\u3002</li><li><code>\u60B2\u89C2\u9501</code> \u9002\u5408 <code>\u5199\u64CD\u4F5C\u591A</code> \u7684\u573A\u666F\uFF0C\u56E0\u4E3A\u5199\u7684\u64CD\u4F5C\u5177\u6709 <code>\u6392\u5B83\u6027</code> \u3002\u91C7\u7528\u60B2\u89C2\u9501\u7684\u65B9\u5F0F\uFF0C\u53EF\u4EE5\u5728\u6570\u636E\u5E93\u5C42 \u9762\u963B\u6B62\u5176\u4ED6\u4E8B\u52A1\u5BF9\u8BE5\u6570\u636E\u7684\u64CD\u4F5C\u6743\u9650\uFF0C\u9632\u6B62 <code>\u8BFB - \u5199</code> \u548C <code>\u5199 - \u5199</code> \u7684\u51B2\u7A81\u3002</li></ol><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713211417909.png" alt="image-20220713211417909" style="float:left;"><h5 id="_3-4-\u6309\u52A0\u9501\u7684\u65B9\u5F0F\u5212\u5206-\u663E\u5F0F\u9501\u3001\u9690\u5F0F\u9501" tabindex="-1"><a class="header-anchor" href="#_3-4-\u6309\u52A0\u9501\u7684\u65B9\u5F0F\u5212\u5206-\u663E\u5F0F\u9501\u3001\u9690\u5F0F\u9501" aria-hidden="true">#</a> 3.4 \u6309\u52A0\u9501\u7684\u65B9\u5F0F\u5212\u5206\uFF1A\u663E\u5F0F\u9501\u3001\u9690\u5F0F\u9501</h5><h6 id="_1-\u9690\u5F0F\u9501" tabindex="-1"><a class="header-anchor" href="#_1-\u9690\u5F0F\u9501" aria-hidden="true">#</a> 1. \u9690\u5F0F\u9501</h6><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713211525845.png" alt="image-20220713211525845" style="float:left;"><ul><li><strong>\u60C5\u666F\u4E00</strong>\uFF1A\u5BF9\u4E8E\u805A\u7C07\u7D22\u5F15\u8BB0\u5F55\u6765\u8BF4\uFF0C\u6709\u4E00\u4E2A <code>trx_id</code> \u9690\u85CF\u5217\uFF0C\u8BE5\u9690\u85CF\u5217\u8BB0\u5F55\u7740\u6700\u540E\u6539\u52A8\u8BE5\u8BB0\u5F55\u7684 <code>\u4E8B\u52A1 id</code> \u3002\u90A3\u4E48\u5982\u679C\u5728\u5F53\u524D\u4E8B\u52A1\u4E2D\u65B0\u63D2\u5165\u4E00\u6761\u805A\u7C07\u7D22\u5F15\u8BB0\u5F55\u540E\uFF0C\u8BE5\u8BB0\u5F55\u7684 trx_id \u9690\u85CF\u5217\u4EE3\u8868\u7684\u7684\u5C31\u662F \u5F53\u524D\u4E8B\u52A1\u7684 \u4E8B\u52A1id \uFF0C\u5982\u679C\u5176\u4ED6\u4E8B\u52A1\u6B64\u65F6\u60F3\u5BF9\u8BE5\u8BB0\u5F55\u6DFB\u52A0 S\u9501 \u6216\u8005 X\u9501 \u65F6\uFF0C\u9996\u5148\u4F1A\u770B\u4E00\u4E0B\u8BE5\u8BB0\u5F55\u7684 trx_id \u9690\u85CF\u5217\u4EE3\u8868\u7684\u4E8B\u52A1\u662F\u5426\u662F\u5F53\u524D\u7684\u6D3B\u8DC3\u4E8B\u52A1\uFF0C\u5982\u679C\u662F\u7684\u8BDD\uFF0C\u90A3\u4E48\u5C31\u5E2E\u52A9\u5F53\u524D\u4E8B\u52A1\u521B\u5EFA\u4E00\u4E2A X \u9501 \uFF08\u4E5F\u5C31\u662F\u4E3A\u5F53\u524D\u4E8B\u52A1\u521B\u5EFA\u4E00\u4E2A\u9501\u7ED3\u6784\uFF0C is_waiting \u5C5E\u6027\u662F false \uFF09\uFF0C\u7136\u540E\u81EA\u5DF1\u8FDB\u5165\u7B49\u5F85\u72B6\u6001 \uFF08\u4E5F\u5C31\u662F\u4E3A\u81EA\u5DF1\u4E5F\u521B\u5EFA\u4E00\u4E2A\u9501\u7ED3\u6784\uFF0C is_waiting \u5C5E\u6027\u662F true \uFF09\u3002</li><li><strong>\u60C5\u666F\u4E8C</strong>\uFF1A\u5BF9\u4E8E\u4E8C\u7EA7\u7D22\u5F15\u8BB0\u5F55\u6765\u8BF4\uFF0C\u672C\u8EAB\u5E76\u6CA1\u6709 trx_id \u9690\u85CF\u5217\uFF0C\u4F46\u662F\u5728\u4E8C\u7EA7\u7D22\u5F15\u9875\u9762\u7684 Page Header \u90E8\u5206\u6709\u4E00\u4E2A <code>PAGE_MAX_TRX_ID</code> \u5C5E\u6027\uFF0C\u8BE5\u5C5E\u6027\u4EE3\u8868\u5BF9\u8BE5\u9875\u9762\u505A\u6539\u52A8\u7684\u6700\u5927\u7684 <code>\u4E8B\u52A1id</code> \uFF0C\u5982 \u679C PAGE_MAX_TRX_ID \u5C5E\u6027\u503C\u5C0F\u4E8E\u5F53\u524D\u6700\u5C0F\u7684\u6D3B\u8DC3 \u4E8B\u52A1id \uFF0C\u90A3\u4E48\u8BF4\u660E\u5BF9\u8BE5\u9875\u9762\u505A\u4FEE\u6539\u7684\u4E8B\u52A1\u90FD\u5DF2 \u7ECF\u63D0\u4EA4\u4E86\uFF0C\u5426\u5219\u5C31\u9700\u8981\u5728\u9875\u9762\u4E2D\u5B9A\u4F4D\u5230\u5BF9\u5E94\u7684\u4E8C\u7EA7\u7D22\u5F15\u8BB0\u5F55\uFF0C\u7136\u540E\u56DE\u8868\u627E\u5230\u5B83\u5BF9\u5E94\u7684\u805A\u7C07\u7D22\u5F15\u8BB0 \u5F55\uFF0C\u7136\u540E\u518D\u91CD\u590D \u60C5\u666F\u4E00 \u7684\u505A\u6CD5\u3002</li></ul><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713214522709.png" alt="image-20220713214522709" style="float:left;"><p><strong>session 1:</strong></p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; begin;
Query OK, 0 rows affected (0.00 sec)
mysql&gt; insert INTO student VALUES(34,&quot;\u5468\u516B&quot;,&quot;\u4E8C\u73ED&quot;);
Query OK, 1 row affected (0.00 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>session 2:</strong></p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; begin;
Query OK, 0 rows affected (0.00 sec)
mysql&gt; select * from student lock in share mode; #\u6267\u884C\u5B8C\uFF0C\u5F53\u524D\u4E8B\u52A1\u88AB\u963B\u585E
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6267\u884C\u4E0B\u8FF0\u8BED\u53E5\uFF0C\u8F93\u51FA\u7ED3\u679C\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; SELECT * FROM performance_schema.data_lock_waits\\G;
*************************** 1. row ***************************
						ENGINE: INNODB
		REQUESTING_ENGINE_LOCK_ID: 140562531358232:7:4:9:140562535668584
REQUESTING_ENGINE_TRANSACTION_ID: 422037508068888
			REQUESTING_THREAD_ID: 64
			REQUESTING_EVENT_ID: 6
REQUESTING_OBJECT_INSTANCE_BEGIN: 140562535668584
		BLOCKING_ENGINE_LOCK_ID: 140562531351768:7:4:9:140562535619104
BLOCKING_ENGINE_TRANSACTION_ID: 15902
			BLOCKING_THREAD_ID: 64
			BLOCKING_EVENT_ID: 6
BLOCKING_OBJECT_INSTANCE_BEGIN: 140562535619104
1 row in set (0.00 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u9690\u5F0F\u9501\u7684\u903B\u8F91\u8FC7\u7A0B\u5982\u4E0B\uFF1A</p><p>A. InnoDB\u7684\u6BCF\u6761\u8BB0\u5F55\u4E2D\u90FD\u4E00\u4E2A\u9690\u542B\u7684trx_id\u5B57\u6BB5\uFF0C\u8FD9\u4E2A\u5B57\u6BB5\u5B58\u5728\u4E8E\u805A\u7C07\u7D22\u5F15\u7684B+Tree\u4E2D\u3002</p><p>B. \u5728\u64CD\u4F5C\u4E00\u6761\u8BB0\u5F55\u524D\uFF0C\u9996\u5148\u6839\u636E\u8BB0\u5F55\u4E2D\u7684trx_id\u68C0\u67E5\u8BE5\u4E8B\u52A1\u662F\u5426\u662F\u6D3B\u52A8\u7684\u4E8B\u52A1(\u672A\u63D0\u4EA4\u6216\u56DE\u6EDA)\u3002\u5982\u679C\u662F\u6D3B\u52A8\u7684\u4E8B\u52A1\uFF0C\u9996\u5148\u5C06 <code>\u9690\u5F0F\u9501</code> \u8F6C\u6362\u4E3A <code>\u663E\u5F0F\u9501</code> (\u5C31\u662F\u4E3A\u8BE5\u4E8B\u52A1\u6DFB\u52A0\u4E00\u4E2A\u9501)\u3002</p><p>C. \u68C0\u67E5\u662F\u5426\u6709\u9501\u51B2\u7A81\uFF0C\u5982\u679C\u6709\u51B2\u7A81\uFF0C\u521B\u5EFA\u9501\uFF0C\u5E76\u8BBE\u7F6E\u4E3Awaiting\u72B6\u6001\u3002\u5982\u679C\u6CA1\u6709\u51B2\u7A81\u4E0D\u52A0\u9501\uFF0C\u8DF3\u5230E\u3002</p><p>D. \u7B49\u5F85\u52A0\u9501\u6210\u529F\uFF0C\u88AB\u5524\u9192\uFF0C\u6216\u8005\u8D85\u65F6\u3002</p><p>E. \u5199\u6570\u636E\uFF0C\u5E76\u5C06\u81EA\u5DF1\u7684trx_id\u5199\u5165trx_id\u5B57\u6BB5\u3002</p><h6 id="_2-\u663E\u5F0F\u9501" tabindex="-1"><a class="header-anchor" href="#_2-\u663E\u5F0F\u9501" aria-hidden="true">#</a> 2. \u663E\u5F0F\u9501</h6><p>\u901A\u8FC7\u7279\u5B9A\u7684\u8BED\u53E5\u8FDB\u884C\u52A0\u9501\uFF0C\u6211\u4EEC\u4E00\u822C\u79F0\u4E4B\u4E3A\u663E\u793A\u52A0\u9501\uFF0C\u4F8B\u5982\uFF1A</p><p>\u663E\u793A\u52A0\u5171\u4EAB\u9501\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>select .... lock in share mode
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u663E\u793A\u52A0\u6392\u5B83\u9501\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>select .... for update
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_3-5-\u5176\u5B83\u9501\u4E4B-\u5168\u5C40\u9501" tabindex="-1"><a class="header-anchor" href="#_3-5-\u5176\u5B83\u9501\u4E4B-\u5168\u5C40\u9501" aria-hidden="true">#</a> 3.5 \u5176\u5B83\u9501\u4E4B\uFF1A\u5168\u5C40\u9501</h5><p>\u5168\u5C40\u9501\u5C31\u662F\u5BF9 <code>\u6574\u4E2A\u6570\u636E\u5E93\u5B9E\u4F8B</code> \u52A0\u9501\u3002\u5F53\u4F60\u9700\u8981\u8BA9\u6574\u4E2A\u5E93\u5904\u4E8E <code>\u53EA\u8BFB\u72B6\u6001</code> \u7684\u65F6\u5019\uFF0C\u53EF\u4EE5\u4F7F\u7528\u8FD9\u4E2A\u547D\u4EE4\uFF0C\u4E4B\u540E \u5176\u4ED6\u7EBF\u7A0B\u7684\u4EE5\u4E0B\u8BED\u53E5\u4F1A\u88AB\u963B\u585E\uFF1A\u6570\u636E\u66F4\u65B0\u8BED\u53E5\uFF08\u6570\u636E\u7684\u589E\u5220\u6539\uFF09\u3001\u6570\u636E\u5B9A\u4E49\u8BED\u53E5\uFF08\u5305\u62EC\u5EFA\u8868\u3001\u4FEE\u6539\u8868\u7ED3 \u6784\u7B49\uFF09\u548C\u66F4\u65B0\u7C7B\u4E8B\u52A1\u7684\u63D0\u4EA4\u8BED\u53E5\u3002\u5168\u5C40\u9501\u7684\u5178\u578B\u4F7F\u7528 <code>\u573A\u666F</code> \u662F\uFF1A\u505A <code>\u5168\u5E93\u903B\u8F91\u5907\u4EFD</code> \u3002</p><p>\u5168\u5C40\u9501\u7684\u547D\u4EE4\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>Flush tables with read lock
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_3-6-\u5176\u5B83\u9501\u4E4B-\u6B7B\u9501" tabindex="-1"><a class="header-anchor" href="#_3-6-\u5176\u5B83\u9501\u4E4B-\u6B7B\u9501" aria-hidden="true">#</a> 3.6 \u5176\u5B83\u9501\u4E4B\uFF1A\u6B7B\u9501</h5><h6 id="_1-\u6982\u5FF5" tabindex="-1"><a class="header-anchor" href="#_1-\u6982\u5FF5" aria-hidden="true">#</a> 1. \u6982\u5FF5</h6><p>\u4E24\u4E2A\u4E8B\u52A1\u90FD\u6301\u6709\u5BF9\u65B9\u9700\u8981\u7684\u9501\uFF0C\u5E76\u4E14\u5728\u7B49\u5F85\u5BF9\u65B9\u91CA\u653E\uFF0C\u5E76\u4E14\u53CC\u65B9\u90FD\u4E0D\u4F1A\u91CA\u653E\u81EA\u5DF1\u7684\u9501\u3002</p><p><strong>\u4E3E\u4F8B1\uFF1A</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713220714098.png" alt="image-20220713220714098"></p><p><strong>\u4E3E\u4F8B2\uFF1A</strong></p><p>\u7528\u6237A\u7ED9\u7528\u6237B\u8F6C\u8D26100\uFF0C\u518D\u6B21\u540C\u65F6\uFF0C\u7528\u6237B\u4E5F\u7ED9\u7528\u6237A\u8F6C\u8D26100\u3002\u8FD9\u4E2A\u8FC7\u7A0B\uFF0C\u53EF\u80FD\u5BFC\u81F4\u6B7B\u9501\u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713220936236.png" alt="image-20220713220936236" style="float:left;"><h6 id="_2-\u4EA7\u751F\u6B7B\u9501\u7684\u5FC5\u8981\u6761\u4EF6" tabindex="-1"><a class="header-anchor" href="#_2-\u4EA7\u751F\u6B7B\u9501\u7684\u5FC5\u8981\u6761\u4EF6" aria-hidden="true">#</a> 2. \u4EA7\u751F\u6B7B\u9501\u7684\u5FC5\u8981\u6761\u4EF6</h6><ol><li>\u4E24\u4E2A\u6216\u8005\u4E24\u4E2A\u4EE5\u4E0A\u4E8B\u52A1</li><li>\u6BCF\u4E2A\u4E8B\u52A1\u90FD\u5DF2\u7ECF\u6301\u6709\u9501\u5E76\u4E14\u7533\u8BF7\u65B0\u7684\u9501</li><li>\u9501\u8D44\u6E90\u540C\u65F6\u53EA\u80FD\u88AB\u540C\u4E00\u4E2A\u4E8B\u52A1\u6301\u6709\u6216\u8005\u4E0D\u517C\u5BB9</li><li>\u4E8B\u52A1\u4E4B\u95F4\u56E0\u4E3A\u6301\u6709\u9501\u548C\u7533\u8BF7\u9501\u5BFC\u81F4\u5F7C\u6B64\u5FAA\u73AF\u7B49\u5F85</li></ol><blockquote><p>\u6B7B\u9501\u7684\u5173\u952E\u5728\u4E8E\uFF1A\u4E24\u4E2A\uFF08\u6216\u4EE5\u4E0A\uFF09\u7684Session\u52A0\u9501\u7684\u987A\u5E8F\u4E0D\u4E00\u81F4\u3002</p></blockquote><h6 id="_3-\u5982\u4F55\u5904\u7406\u6B7B\u9501" tabindex="-1"><a class="header-anchor" href="#_3-\u5982\u4F55\u5904\u7406\u6B7B\u9501" aria-hidden="true">#</a> 3. \u5982\u4F55\u5904\u7406\u6B7B\u9501</h6><p>**\u65B9\u5F0F1\uFF1A**\u7B49\u5F85\uFF0C\u76F4\u5230\u8D85\u65F6\uFF08innodb_lock_wait_timeout=50s)</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713221418100.png" alt="image-20220713221418100" style="float:left;"><p>**\u65B9\u5F0F2\uFF1A**\u4F7F\u7528\u6B7B\u9501\u68C0\u6D4B\u5904\u7406\u6B7B\u9501\u7A0B\u5E8F</p><p>\u65B9\u5F0F1\u68C0\u6D4B\u6B7B\u9501\u592A\u8FC7\u88AB\u52A8\uFF0Cinnodb\u8FD8\u63D0\u4F9B\u4E86<code>wait-for graph\u7B97\u6CD5</code>\u6765\u4E3B\u52A8\u8FDB\u884C\u6B7B\u9501\u68C0\u6D4B\uFF0C\u6BCF\u5F53\u52A0\u9501\u8BF7\u6C42\u65E0\u6CD5\u7ACB\u5373\u6EE1\u8DB3\u9700\u8981\u5E76\u8FDB\u5165\u7B49\u5F85\u65F6\uFF0Cwait-for graph\u7B97\u6CD5\u90FD\u4F1A\u88AB\u89E6\u53D1\u3002</p><p>\u8FD9\u662F\u4E00\u79CD\u8F83\u4E3A<code>\u4E3B\u52A8\u7684\u6B7B\u9501\u68C0\u6D4B\u673A\u5236</code>\uFF0C\u8981\u6C42\u6570\u636E\u5E93\u4FDD\u5B58<code>\u9501\u7684\u4FE1\u606F\u94FE\u8868</code>\u548C<code>\u4E8B\u7269\u7B49\u5F85\u94FE\u8868</code>\u4E24\u90E8\u5206\u4FE1\u606F\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713221758941.png" alt="image-20220713221758941"></p><p>\u57FA\u4E8E\u8FD9\u4E24\u4E2A\u4FE1\u606F\uFF0C\u53EF\u4EE5\u7ED8\u5236wait-for graph\uFF08\u7B49\u5F85\u56FE\uFF09</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220713221830455.png" alt="image-20220713221830455"></p><blockquote><p>\u6B7B\u9501\u68C0\u6D4B\u7684\u539F\u7406\u662F\u6784\u5EFA\u4E00\u4E2A\u4EE5\u4E8B\u52A1\u4E3A\u9876\u70B9\uFF0C\u9501\u4E3A\u8FB9\u7684\u6709\u5411\u56FE\uFF0C\u5224\u65AD\u6709\u5411\u56FE\u662F\u5426\u5B58\u5728\u73AF\uFF0C\u5B58\u5728\u65E2\u6709\u6B7B\u9501\u3002</p></blockquote><p>\u4E00\u65E6\u68C0\u6D4B\u5230\u56DE\u8DEF\u3001\u6709\u6B7B\u9501\uFF0C\u8FD9\u65F6\u5019InnoDB\u5B58\u50A8\u5F15\u64CE\u4F1A\u9009\u62E9<code>\u56DE\u6EDAundo\u91CF\u6700\u5C0F\u7684\u4E8B\u52A1</code>\uFF0C\u8BA9\u5176\u4ED6\u4E8B\u52A1\u7EE7\u7EED\u6267\u884C\uFF08<code>innodb_deadlock_detect=on</code>\u8868\u793A\u5F00\u542F\u8FD9\u4E2A\u903B\u8F91\uFF09\u3002</p><p>\u7F3A\u70B9\uFF1A\u6BCF\u4E2A\u65B0\u7684\u88AB\u963B\u585E\u7684\u7EBF\u7A0B\uFF0C\u90FD\u8981\u5224\u65AD\u662F\u4E0D\u662F\u7531\u4E8E\u81EA\u5DF1\u7684\u52A0\u5165\u5BFC\u81F4\u4E86\u6B7B\u9501\uFF0C\u8FD9\u4E2A\u64CD\u4F5C\u65F6\u95F4\u590D\u6742\u5EA6\u662FO(n)\u3002\u5982\u679C100\u4E2A\u5E76\u53D1\u7EBF\u7A0B\u540C\u65F6\u66F4\u65B0\u540C\u4E00\u884C\uFF0C\u610F\u5473\u7740\u8981\u68C0\u6D4B100*100=1\u4E07\u6B21\uFF0C1\u4E07\u4E2A\u7EBF\u7A0B\u5C31\u4F1A\u67091\u5343\u4E07\u6B21\u68C0\u6D4B\u3002</p><p><strong>\u5982\u4F55\u89E3\u51B3\uFF1F</strong></p><ul><li>\u65B9\u5F0F1\uFF1A\u5173\u95ED\u6B7B\u9501\u68C0\u6D4B\uFF0C\u4F46\u610F\u5473\u7740\u53EF\u80FD\u4F1A\u51FA\u73B0\u5927\u91CF\u7684\u8D85\u65F6\uFF0C\u4F1A\u5BFC\u81F4\u4E1A\u52A1\u6709\u635F\u3002</li><li>\u65B9\u5F0F2\uFF1A\u63A7\u5236\u5E76\u53D1\u8BBF\u95EE\u7684\u6570\u91CF\u3002\u6BD4\u5982\u5728\u4E2D\u95F4\u4EF6\u4E2D\u5B9E\u73B0\u5BF9\u4E8E\u76F8\u540C\u884C\u7684\u66F4\u65B0\uFF0C\u5728\u8FDB\u5165\u5F15\u64CE\u4E4B\u524D\u6392\u961F\uFF0C\u8FD9\u6837\u5728InnoDB\u5185\u90E8\u5C31\u4E0D\u4F1A\u6709\u5927\u91CF\u7684\u6B7B\u9501\u68C0\u6D4B\u5DE5\u4F5C\u3002</li></ul><p><strong>\u8FDB\u4E00\u6B65\u7684\u601D\u8DEF\uFF1A</strong></p><p>\u53EF\u4EE5\u8003\u8651\u901A\u8FC7\u5C06\u4E00\u884C\u6539\u6210\u903B\u8F91\u4E0A\u7684\u591A\u884C\u6765\u51CF\u5C11<code>\u9501\u51B2\u7A81</code>\u3002\u6BD4\u5982\uFF0C\u8FDE\u9501\u8D85\u5E02\u8D26\u6237\u603B\u989D\u7684\u8BB0\u5F55\uFF0C\u53EF\u4EE5\u8003\u8651\u653E\u5230\u591A\u6761\u8BB0\u5F55\u4E0A\u3002\u8D26\u6237\u603B\u989D\u7B49\u4E8E\u8FD9\u591A\u4E2A\u8BB0\u5F55\u7684\u503C\u7684\u603B\u548C\u3002</p><h6 id="_4-\u5982\u4F55\u907F\u514D\u6B7B\u9501" tabindex="-1"><a class="header-anchor" href="#_4-\u5982\u4F55\u907F\u514D\u6B7B\u9501" aria-hidden="true">#</a> 4. \u5982\u4F55\u907F\u514D\u6B7B\u9501</h6><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714131008260.png" alt="image-20220714131008260" style="float:left;"><h3 id="_4-\u9501\u7684\u5185\u90E8\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#_4-\u9501\u7684\u5185\u90E8\u7ED3\u6784" aria-hidden="true">#</a> 4. \u9501\u7684\u5185\u90E8\u7ED3\u6784</h3><p>\u6211\u4EEC\u524D\u8FB9\u8BF4\u5BF9\u4E00\u6761\u8BB0\u5F55\u52A0\u9501\u7684\u672C\u8D28\u5C31\u662F\u5728\u5185\u5B58\u4E2D\u521B\u5EFA\u4E00\u4E2A<code>\u9501\u7ED3\u6784</code>\u4E0E\u4E4B\u5173\u8054\uFF0C\u90A3\u4E48\u662F\u4E0D\u662F\u4E00\u4E2A\u4E8B\u52A1\u5BF9\u591A\u6761\u8BB0\u5F55\u52A0\u9501\uFF0C\u5C31\u8981\u521B\u5EFA\u591A\u4E2A<code>\u9501\u7ED3\u6784</code>\u5462\uFF1F\u6BD4\u5982\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u4E8B\u52A1T1
SELECT * FROM user LOCK IN SHARE MODE;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7406\u8BBA\u4E0A\u521B\u5EFA\u591A\u4E2A<code>\u9501\u7ED3\u6784</code>\u6CA1\u95EE\u9898\uFF0C\u4F46\u662F\u5982\u679C\u4E00\u4E2A\u4E8B\u52A1\u8981\u83B7\u53D610000\u6761\u8BB0\u5F55\u7684\u9501\uFF0C\u751F\u621010000\u4E2A\u9501\u7ED3\u6784\u4E5F\u592A\u5D29\u6E83\u4E86\uFF01\u6240\u4EE5\u51B3\u5B9A\u5728\u5BF9\u4E0D\u540C\u8BB0\u5F55\u52A0\u9501\u65F6\uFF0C\u5982\u679C\u7B26\u5408\u4E0B\u8FB9\u8FD9\u4E9B\u6761\u4EF6\u7684\u8BB0\u5F55\u4F1A\u653E\u5728\u4E00\u4E2A<code>\u9501\u7ED3\u6784</code>\u4E2D\u3002</p><ul><li>\u5728\u540C\u4E00\u4E2A\u4E8B\u52A1\u4E2D\u8FDB\u884C\u52A0\u9501\u64CD\u4F5C</li><li>\u88AB\u52A0\u9501\u7684\u8BB0\u5F55\u5728\u540C\u4E00\u4E2A\u9875\u9762\u4E2D</li><li>\u52A0\u9501\u7684\u7C7B\u578B\u662F\u4E00\u6837\u7684</li><li>\u7B49\u5F85\u72B6\u6001\u662F\u4E00\u6837\u7684</li></ul><p><code>InnoDB</code> \u5B58\u50A8\u5F15\u64CE\u4E2D\u7684 <code>\u9501\u7ED3\u6784</code> \u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714132306208.png" alt="image-20220714132306208"></p><p>\u7ED3\u6784\u89E3\u6790\uFF1A</p><p><code>1. \u9501\u6240\u5728\u7684\u4E8B\u52A1\u4FE1\u606F </code>\uFF1A</p><p>\u4E0D\u8BBA\u662F <code>\u8868\u9501</code> \u8FD8\u662F <code>\u884C\u9501</code> \uFF0C\u90FD\u662F\u5728\u4E8B\u52A1\u6267\u884C\u8FC7\u7A0B\u4E2D\u751F\u6210\u7684\uFF0C\u54EA\u4E2A\u4E8B\u52A1\u751F\u6210\u4E86\u8FD9\u4E2A\u9501\u7ED3\u6784 \uFF0C\u8FD9\u91CC\u5C31\u8BB0\u5F55\u8FD9\u4E2A \u4E8B\u52A1\u7684\u4FE1\u606F\u3002</p><p>\u6B64 <code>\u9501\u6240\u5728\u7684\u4E8B\u52A1\u4FE1\u606F</code> \u5728\u5185\u5B58\u7ED3\u6784\u4E2D\u53EA\u662F\u4E00\u4E2A\u6307\u9488\uFF0C\u901A\u8FC7\u6307\u9488\u53EF\u4EE5\u627E\u5230\u5185\u5B58\u4E2D\u5173\u4E8E\u8BE5\u4E8B\u52A1\u7684\u66F4\u591A\u4FE1\u606F\uFF0C\u6BD4\u65B9\u8BF4\u4E8B\u52A1id\u7B49\u3002</p><p><code>2. \u7D22\u5F15\u4FE1\u606F</code> \uFF1A</p><p>\u5BF9\u4E8E <code>\u884C\u9501</code> \u6765\u8BF4\uFF0C\u9700\u8981\u8BB0\u5F55\u4E00\u4E0B\u52A0\u9501\u7684\u8BB0\u5F55\u662F\u5C5E\u4E8E\u54EA\u4E2A\u7D22\u5F15\u7684\u3002\u8FD9\u91CC\u4E5F\u662F\u4E00\u4E2A\u6307\u9488\u3002</p><p><code>3. \u8868\u9501\uFF0F\u884C\u9501\u4FE1\u606F</code> \uFF1A</p><p><code>\u8868\u9501\u7ED3\u6784</code> \u548C <code>\u884C\u9501\u7ED3\u6784</code> \u5728\u8FD9\u4E2A\u4F4D\u7F6E\u7684\u5185\u5BB9\u662F\u4E0D\u540C\u7684\uFF1A</p><ul><li><p>\u8868\u9501\uFF1A</p><p>\u8BB0\u8F7D\u7740\u662F\u5BF9\u54EA\u4E2A\u8868\u52A0\u7684\u9501\uFF0C\u8FD8\u6709\u5176\u4ED6\u7684\u4E00\u4E9B\u4FE1\u606F\u3002</p></li><li><p>\u884C\u9501\uFF1A</p><p>\u8BB0\u8F7D\u4E86\u4E09\u4E2A\u91CD\u8981\u7684\u4FE1\u606F\uFF1A</p><ul><li><code>Space ID</code> \uFF1A\u8BB0\u5F55\u6240\u5728\u8868\u7A7A\u95F4\u3002</li><li><code>Page Number</code> \uFF1A\u8BB0\u5F55\u6240\u5728\u9875\u53F7\u3002</li><li><code>n_bits </code>\uFF1A\u5BF9\u4E8E\u884C\u9501\u6765\u8BF4\uFF0C\u4E00\u6761\u8BB0\u5F55\u5C31\u5BF9\u5E94\u7740\u4E00\u4E2A\u6BD4\u7279\u4F4D\uFF0C\u4E00\u4E2A\u9875\u9762\u4E2D\u5305\u542B\u5F88\u591A\u8BB0\u5F55\uFF0C\u7528\u4E0D\u540C \u7684\u6BD4\u7279\u4F4D\u6765\u533A\u5206\u5230\u5E95\u662F\u54EA\u4E00\u6761\u8BB0\u5F55\u52A0\u4E86\u9501\u3002\u4E3A\u6B64\u5728\u884C\u9501\u7ED3\u6784\u7684\u672B\u5C3E\u653E\u7F6E\u4E86\u4E00\u5806\u6BD4\u7279\u4F4D\uFF0C\u8FD9\u4E2A<code>n_bis</code>\u5C5E\u6027\u4EE3\u8868\u4F7F\u7528\u4E86\u591A\u5C11\u6BD4\u7279\u4F4D\u3002</li></ul><blockquote><p>n_bits\u7684\u503C\u4E00\u822C\u90FD\u6BD4\u9875\u9762\u4E2D\u8BB0\u5F55\u6761\u6570\u591A\u4E00\u4E9B\u3002\u4E3B\u8981\u662F\u4E3A\u4E86\u4E4B\u540E\u5728\u9875\u9762\u4E2D\u63D2\u5165\u4E86\u65B0\u8BB0\u5F55\u540E \u4E5F\u4E0D\u81F3\u4E8E\u91CD\u65B0\u5206\u914D\u9501\u7ED3\u6784</p></blockquote></li></ul><p><code>4. type_mode</code> \uFF1A</p><p>\u8FD9\u662F\u4E00\u4E2A32\u4F4D\u7684\u6570\uFF0C\u88AB\u5206\u6210\u4E86 <code>lock_mode</code> \u3001 <code>lock_type</code> \u548C <code>rec_lock_type</code> \u4E09\u4E2A\u90E8\u5206\uFF0C\u5982\u56FE\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714133319666.png" alt="image-20220714133319666"></p><ul><li>\u9501\u7684\u6A21\u5F0F\uFF08 <code>lock_mode</code> \uFF09\uFF0C\u5360\u7528\u4F4E4\u4F4D\uFF0C\u53EF\u9009\u7684\u503C\u5982\u4E0B\uFF1A <ul><li><code>LOCK_IS</code> \uFF08\u5341\u8FDB\u5236\u7684 0 \uFF09\uFF1A\u8868\u793A\u5171\u4EAB\u610F\u5411\u9501\uFF0C\u4E5F\u5C31\u662F <code>IS\u9501</code> \u3002</li><li><code>LOCK_IX</code> \uFF08\u5341\u8FDB\u5236\u7684 1 \uFF09\uFF1A\u8868\u793A\u72EC\u5360\u610F\u5411\u9501\uFF0C\u4E5F\u5C31\u662F <code>IX\u9501</code> \u3002</li><li><code>LOCK_S</code> \uFF08\u5341\u8FDB\u5236\u7684 2 \uFF09\uFF1A\u8868\u793A\u5171\u4EAB\u9501\uFF0C\u4E5F\u5C31\u662F <code>S\u9501</code> \u3002</li><li><code>LOCK_X</code> \uFF08\u5341\u8FDB\u5236\u7684 3 \uFF09\uFF1A\u8868\u793A\u72EC\u5360\u9501\uFF0C\u4E5F\u5C31\u662F <code>X\u9501</code> \u3002</li><li><code>LOCK_AUTO_INC</code> \uFF08\u5341\u8FDB\u5236\u7684 4 \uFF09\uFF1A\u8868\u793A <code>AUTO-INC\u9501</code> \u3002</li></ul></li></ul><p>\u5728InnoDB\u5B58\u50A8\u5F15\u64CE\u4E2D\uFF0CLOCK_IS\uFF0CLOCK_IX\uFF0CLOCK_AUTO_INC\u90FD\u7B97\u662F\u8868\u7EA7\u9501\u7684\u6A21\u5F0F\uFF0CLOCK_S\u548C LOCK_X\u65E2\u53EF\u4EE5\u7B97\u662F\u8868\u7EA7\u9501\u7684\u6A21\u5F0F\uFF0C\u4E5F\u53EF\u4EE5\u662F\u884C\u7EA7\u9501\u7684\u6A21\u5F0F\u3002</p><ul><li>\u9501\u7684\u7C7B\u578B\uFF08 <code>lock_type</code> \uFF09\uFF0C\u5360\u7528\u7B2C5\uFF5E8\u4F4D\uFF0C\u4E0D\u8FC7\u73B0\u9636\u6BB5\u53EA\u6709\u7B2C5\u4F4D\u548C\u7B2C6\u4F4D\u88AB\u4F7F\u7528\uFF1A <ul><li><code>LOCK_TABLE</code> \uFF08\u5341\u8FDB\u5236\u7684 16 \uFF09\uFF0C\u4E5F\u5C31\u662F\u5F53\u7B2C5\u4E2A\u6BD4\u7279\u4F4D\u7F6E\u4E3A1\u65F6\uFF0C\u8868\u793A\u8868\u7EA7\u9501\u3002</li><li><code>LOCK_REC </code>\uFF08\u5341\u8FDB\u5236\u7684 32 \uFF09\uFF0C\u4E5F\u5C31\u662F\u5F53\u7B2C6\u4E2A\u6BD4\u7279\u4F4D\u7F6E\u4E3A1\u65F6\uFF0C\u8868\u793A\u884C\u7EA7\u9501\u3002</li></ul></li><li>\u884C\u9501\u7684\u5177\u4F53\u7C7B\u578B\uFF08 <code>rec_lock_type</code> \uFF09\uFF0C\u4F7F\u7528\u5176\u4F59\u7684\u4F4D\u6765\u8868\u793A\u3002\u53EA\u6709\u5728 <code>lock_type</code> \u7684\u503C\u4E3A <code>LOCK_REC</code> \u65F6\uFF0C\u4E5F\u5C31\u662F\u53EA\u6709\u5728\u8BE5\u9501\u4E3A\u884C\u7EA7\u9501\u65F6\uFF0C\u624D\u4F1A\u88AB\u7EC6\u5206\u4E3A\u66F4\u591A\u7684\u7C7B\u578B\uFF1A <ul><li><code>LOCK_ORDINARY</code> \uFF08\u5341\u8FDB\u5236\u7684 0 \uFF09\uFF1A\u8868\u793A <code>next-key\u9501</code> \u3002</li><li><code>LOCK_GAP</code> \uFF08\u5341\u8FDB\u5236\u7684 512 \uFF09\uFF1A\u4E5F\u5C31\u662F\u5F53\u7B2C10\u4E2A\u6BD4\u7279\u4F4D\u7F6E\u4E3A1\u65F6\uFF0C\u8868\u793A <code>gap\u9501</code> \u3002</li><li><code>LOCK_REC_NOT_GAP</code> \uFF08\u5341\u8FDB\u5236\u7684 1024 \uFF09\uFF1A\u4E5F\u5C31\u662F\u5F53\u7B2C11\u4E2A\u6BD4\u7279\u4F4D\u7F6E\u4E3A1\u65F6\uFF0C\u8868\u793A\u6B63\u7ECF <code>\u8BB0\u5F55\u9501</code> \u3002</li><li><code>LOCK_INSERT_INTENTION</code> \uFF08\u5341\u8FDB\u5236\u7684 2048 \uFF09\uFF1A\u4E5F\u5C31\u662F\u5F53\u7B2C12\u4E2A\u6BD4\u7279\u4F4D\u7F6E\u4E3A1\u65F6\uFF0C\u8868\u793A\u63D2\u5165\u610F\u5411\u9501\u3002\u5176\u4ED6\u7684\u7C7B\u578B\uFF1A\u8FD8\u6709\u4E00\u4E9B\u4E0D\u5E38\u7528\u7684\u7C7B\u578B\u6211\u4EEC\u5C31\u4E0D\u591A\u8BF4\u4E86\u3002</li></ul></li><li><code>is_waiting</code> \u5C5E\u6027\u5462\uFF1F\u57FA\u4E8E\u5185\u5B58\u7A7A\u95F4\u7684\u8282\u7701\uFF0C\u6240\u4EE5\u628A <code>is_waiting</code> \u5C5E\u6027\u653E\u5230\u4E86 <code>type_mode</code> \u8FD9\u4E2A32 \u4F4D\u7684\u6570\u5B57\u4E2D\uFF1A <ul><li><code>LOCK_WAIT</code> \uFF08\u5341\u8FDB\u5236\u7684 256 \uFF09 \uFF1A\u5F53\u7B2C9\u4E2A\u6BD4\u7279\u4F4D\u7F6E\u4E3A 1 \u65F6\uFF0C\u8868\u793A <code>is_waiting</code> \u4E3A <code>true</code> \uFF0C\u4E5F \u5C31\u662F\u5F53\u524D\u4E8B\u52A1\u5C1A\u672A\u83B7\u53D6\u5230\u9501\uFF0C\u5904\u5728\u7B49\u5F85\u72B6\u6001\uFF1B\u5F53\u8FD9\u4E2A\u6BD4\u7279\u4F4D\u4E3A 0 \u65F6\uFF0C\u8868\u793A <code>is_waiting</code> \u4E3A <code>false</code> \uFF0C\u4E5F\u5C31\u662F\u5F53\u524D\u4E8B\u52A1\u83B7\u53D6\u9501\u6210\u529F\u3002</li></ul></li></ul><p><code>5. \u5176\u4ED6\u4FE1\u606F</code> \uFF1A</p><p>\u4E3A\u4E86\u66F4\u597D\u7684\u7BA1\u7406\u7CFB\u7EDF\u8FD0\u884C\u8FC7\u7A0B\u4E2D\u751F\u6210\u7684\u5404\u79CD\u9501\u7ED3\u6784\u800C\u8BBE\u8BA1\u4E86\u5404\u79CD\u54C8\u5E0C\u8868\u548C\u94FE\u8868\u3002</p><p><code>6. \u4E00\u5806\u6BD4\u7279\u4F4D</code> \uFF1A</p><p>\u5982\u679C\u662F <code>\u884C\u9501\u7ED3\u6784</code> \u7684\u8BDD\uFF0C\u5728\u8BE5\u7ED3\u6784\u672B\u5C3E\u8FD8\u653E\u7F6E\u4E86\u4E00\u5806\u6BD4\u7279\u4F4D\uFF0C\u6BD4\u7279\u4F4D\u7684\u6570\u91CF\u662F\u7531\u4E0A\u8FB9\u63D0\u5230\u7684 <code>n_bits</code> \u5C5E\u6027 \u8868\u793A\u7684\u3002InnoDB\u6570\u636E\u9875\u4E2D\u7684\u6BCF\u6761\u8BB0\u5F55\u5728 <code>\u8BB0\u5F55\u5934\u4FE1\u606F</code> \u4E2D\u90FD\u5305\u542B\u4E00\u4E2A <code>heap_no</code> \u5C5E\u6027\uFF0C\u4F2A\u8BB0\u5F55 <code>Infimum</code> \u7684 <code>heap_no</code> \u503C\u4E3A 0 \uFF0C <code>Supremum</code> \u7684 <code>heap_no</code> \u503C\u4E3A 1 \uFF0C\u4E4B\u540E\u6BCF\u63D2\u5165\u4E00\u6761\u8BB0\u5F55\uFF0C <code>heap_no</code> \u503C\u5C31\u589E1\u3002 \u9501\u7ED3 \u6784 \u6700\u540E\u7684\u4E00\u5806\u6BD4\u7279\u4F4D\u5C31\u5BF9\u5E94\u7740\u4E00\u4E2A\u9875\u9762\u4E2D\u7684\u8BB0\u5F55\uFF0C\u4E00\u4E2A\u6BD4\u7279\u4F4D\u6620\u5C04\u4E00\u4E2A <code>heap_no</code> \uFF0C\u5373\u4E00\u4E2A\u6BD4\u7279\u4F4D\u6620\u5C04 \u5230\u9875\u5185\u7684\u4E00\u6761\u8BB0\u5F55\u3002</p><h3 id="_5-\u9501\u76D1\u63A7" tabindex="-1"><a class="header-anchor" href="#_5-\u9501\u76D1\u63A7" aria-hidden="true">#</a> 5. \u9501\u76D1\u63A7</h3><p>\u5173\u4E8EMySQL\u9501\u7684\u76D1\u63A7\uFF0C\u6211\u4EEC\u4E00\u822C\u53EF\u4EE5\u901A\u8FC7\u68C0\u67E5 InnoDB_row_lock \u7B49\u72B6\u6001\u53D8\u91CF\u6765\u5206\u6790\u7CFB\u7EDF\u4E0A\u7684\u884C\u9501\u7684\u4E89\u593A\u60C5\u51B5</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql&gt; show status like &#39;innodb_row_lock%&#39;;
+-------------------------------+-------+
| Variable_name                 | Value |
+-------------------------------+-------+
| Innodb_row_lock_current_waits | 0     |
| Innodb_row_lock_time          | 0     |
| Innodb_row_lock_time_avg      | 0     |
| Innodb_row_lock_time_max      | 0     |
| Innodb_row_lock_waits         | 0     |
+-------------------------------+-------+
5 rows in set (0.01 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5BF9\u5404\u4E2A\u72B6\u6001\u91CF\u7684\u8BF4\u660E\u5982\u4E0B\uFF1A</p><ul><li>Innodb_row_lock_current_waits\uFF1A\u5F53\u524D\u6B63\u5728\u7B49\u5F85\u9501\u5B9A\u7684\u6570\u91CF\uFF1B</li><li><code>Innodb_row_lock_time</code> \uFF1A\u4ECE\u7CFB\u7EDF\u542F\u52A8\u5230\u73B0\u5728\u9501\u5B9A\u603B\u65F6\u95F4\u957F\u5EA6\uFF1B\uFF08\u7B49\u5F85\u603B\u65F6\u957F\uFF09</li><li><code>Innodb_row_lock_time_avg</code> \uFF1A\u6BCF\u6B21\u7B49\u5F85\u6240\u82B1\u5E73\u5747\u65F6\u95F4\uFF1B\uFF08\u7B49\u5F85\u5E73\u5747\u65F6\u957F\uFF09</li><li>Innodb_row_lock_time_max\uFF1A\u4ECE\u7CFB\u7EDF\u542F\u52A8\u5230\u73B0\u5728\u7B49\u5F85\u6700\u5E38\u7684\u4E00\u6B21\u6240\u82B1\u7684\u65F6\u95F4\uFF1B</li><li><code>Innodb_row_lock_waits</code> \uFF1A\u7CFB\u7EDF\u542F\u52A8\u540E\u5230\u73B0\u5728\u603B\u5171\u7B49\u5F85\u7684\u6B21\u6570\uFF1B\uFF08\u7B49\u5F85\u603B\u6B21\u6570\uFF09</li></ul><p>\u5BF9\u4E8E\u8FD95\u4E2A\u72B6\u6001\u53D8\u91CF\uFF0C\u6BD4\u8F83\u91CD\u8981\u76843\u4E2A\u89C1\u4E0A\u9762\uFF08\u7070\u8272\uFF09\u3002</p><p>\u5C24\u5176\u662F\u5F53\u7B49\u5F85\u6B21\u6570\u5F88\u9AD8\uFF0C\u800C\u4E14\u6BCF\u6B21\u7B49\u5F85\u65F6\u957F\u4E5F\u4E0D\u5C0F\u7684\u65F6\u5019\uFF0C\u6211\u4EEC\u5C31\u9700\u8981\u5206\u6790\u7CFB\u7EDF\u4E2D\u4E3A\u4EC0\u4E48\u4F1A\u6709\u5982\u6B64\u591A\u7684\u7B49\u5F85\uFF0C\u7136\u540E\u6839\u636E\u5206\u6790\u7ED3\u679C\u7740\u624B\u6307\u5B9A\u4F18\u5316\u8BA1\u5212\u3002</p><p><strong>\u5176\u4ED6\u76D1\u63A7\u65B9\u6CD5\uFF1A</strong></p><p>MySQL\u628A\u4E8B\u52A1\u548C\u9501\u7684\u4FE1\u606F\u8BB0\u5F55\u5728\u4E86 <code>information_schema</code> \u5E93\u4E2D\uFF0C\u6D89\u53CA\u5230\u7684\u4E09\u5F20\u8868\u5206\u522B\u662F <code>INNODB_TRX</code> \u3001 <code>INNODB_LOCKS</code> \u548C <code>INNODB_LOCK_WAITS</code> \u3002</p><p><code>MySQL5.7\u53CA\u4E4B\u524D</code> \uFF0C\u53EF\u4EE5\u901A\u8FC7information_schema.INNODB_LOCKS\u67E5\u770B\u4E8B\u52A1\u7684\u9501\u60C5\u51B5\uFF0C\u4F46\u53EA\u80FD\u770B\u5230\u963B\u585E\u4E8B \u52A1\u7684\u9501\uFF1B\u5982\u679C\u4E8B\u52A1\u5E76\u672A\u88AB\u963B\u585E\uFF0C\u5219\u5728\u8BE5\u8868\u4E2D\u770B\u4E0D\u5230\u8BE5\u4E8B\u52A1\u7684\u9501\u60C5\u51B5\u3002</p><p>MySQL8.0\u5220\u9664\u4E86information_schema.INNODB_LOCKS\uFF0C\u6DFB\u52A0\u4E86 <code>performance_schema.data_locks</code> \uFF0C\u53EF\u4EE5\u901A\u8FC7performance_schema.data_locks\u67E5\u770B\u4E8B\u52A1\u7684\u9501\u60C5\u51B5\uFF0C\u548CMySQL5.7\u53CA\u4E4B\u524D\u4E0D\u540C\uFF0C performance_schema.data_locks\u4E0D\u4F46\u53EF\u4EE5\u770B\u5230\u963B\u585E\u8BE5\u4E8B\u52A1\u7684\u9501\uFF0C\u8FD8\u53EF\u4EE5\u770B\u5230\u8BE5\u4E8B\u52A1\u6240\u6301\u6709\u7684\u9501\u3002</p><p>\u540C\u65F6\uFF0Cinformation_schema.INNODB_LOCK_WAITS\u4E5F\u88AB <code>performance_schema.data_lock_waits</code> \u6240\u4EE3 \u66FF\u3002</p><p>\u6211\u4EEC\u6A21\u62DF\u4E00\u4E2A\u9501\u7B49\u5F85\u7684\u573A\u666F\uFF0C\u4EE5\u4E0B\u662F\u4ECE\u8FD9\u4E09\u5F20\u8868\u6536\u96C6\u7684\u4FE1\u606F</p><p>\u9501\u7B49\u5F85\u573A\u666F\uFF0C\u6211\u4EEC\u4F9D\u7136\u4F7F\u7528\u8BB0\u5F55\u9501\u4E2D\u7684\u6848\u4F8B\uFF0C\u5F53\u4E8B\u52A12\u8FDB\u884C\u7B49\u5F85\u65F6\uFF0C\u67E5\u8BE2\u60C5\u51B5\u5982\u4E0B\uFF1A</p><p>\uFF081\uFF09\u67E5\u8BE2\u6B63\u5728\u88AB\u9501\u963B\u585E\u7684sql\u8BED\u53E5\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>SELECT * FROM information_schema.INNODB_TRX\\G;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u91CD\u8981\u5C5E\u6027\u4EE3\u8868\u542B\u4E49\u5DF2\u5728\u4E0A\u8FF0\u4E2D\u6807\u6CE8\u3002</p><p>\uFF082\uFF09\u67E5\u8BE2\u9501\u7B49\u5F85\u60C5\u51B5</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>SELECT * FROM data_lock_waits\\G;
*************************** 1. row ***************************
							ENGINE: INNODB
		REQUESTING_ENGINE_LOCK_ID: 139750145405624:7:4:7:139747028690608
REQUESTING_ENGINE_TRANSACTION_ID: 13845 #\u88AB\u963B\u585E\u7684\u4E8B\u52A1ID
			REQUESTING_THREAD_ID: 72
			REQUESTING_EVENT_ID: 26
REQUESTING_OBJECT_INSTANCE_BEGIN: 139747028690608
		BLOCKING_ENGINE_LOCK_ID: 139750145406432:7:4:7:139747028813248
BLOCKING_ENGINE_TRANSACTION_ID: 13844 #\u6B63\u5728\u6267\u884C\u7684\u4E8B\u52A1ID\uFF0C\u963B\u585E\u4E8613845
			BLOCKING_THREAD_ID: 71
			BLOCKING_EVENT_ID: 24
BLOCKING_OBJECT_INSTANCE_BEGIN: 139747028813248
1 row in set (0.00 sec)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\uFF083\uFF09\u67E5\u8BE2\u9501\u7684\u60C5\u51B5</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>mysql &gt; SELECT * from performance_schema.data_locks\\G;
*************************** 1. row ***************************
ENGINE: INNODB
ENGINE_LOCK_ID: 139750145405624:1068:139747028693520
ENGINE_TRANSACTION_ID: 13847
THREAD_ID: 72
EVENT_ID: 31
OBJECT_SCHEMA: atguigu
OBJECT_NAME: user
PARTITION_NAME: NULL
SUBPARTITION_NAME: NULL
INDEX_NAME: NULL
OBJECT_INSTANCE_BEGIN: 139747028693520
LOCK_TYPE: TABLE
LOCK_MODE: IX
LOCK_STATUS: GRANTED
LOCK_DATA: NULL
*************************** 2. row ***************************
ENGINE: INNODB
ENGINE_LOCK_ID: 139750145405624:7:4:7:139747028690608
ENGINE_TRANSACTION_ID: 13847
THREAD_ID: 72
EVENT_ID: 31
OBJECT_SCHEMA: atguigu
OBJECT_NAME: user
PARTITION_NAME: NULL
SUBPARTITION_NAME: NULL
INDEX_NAME: PRIMARY
OBJECT_INSTANCE_BEGIN: 139747028690608
LOCK_TYPE: RECORD
LOCK_MODE: X,REC_NOT_GAP
LOCK_STATUS: WAITING
LOCK_DATA: 1
*************************** 3. row ***************************
ENGINE: INNODB
ENGINE_LOCK_ID: 139750145406432:1068:139747028816304
ENGINE_TRANSACTION_ID: 13846
THREAD_ID: 71
EVENT_ID: 28
OBJECT_SCHEMA: atguigu
OBJECT_NAME: user
PARTITION_NAME: NULL
SUBPARTITION_NAME: NULL
INDEX_NAME: NULL
OBJECT_INSTANCE_BEGIN: 139747028816304
LOCK_TYPE: TABLE
LOCK_MODE: IX
LOCK_STATUS: GRANTED
LOCK_DATA: NULL
*************************** 4. row ***************************
ENGINE: INNODB
ENGINE_LOCK_ID: 139750145406432:7:4:7:139747028813248
ENGINE_TRANSACTION_ID: 13846
THREAD_ID: 71
EVENT_ID: 28
OBJECT_SCHEMA: atguigu
OBJECT_NAME: user
PARTITION_NAME: NULL
SUBPARTITION_NAME: NULL
INDEX_NAME: PRIMARY
OBJECT_INSTANCE_BEGIN: 139747028813248
LOCK_TYPE: RECORD
LOCK_MODE: X,REC_NOT_GAP
LOCK_STATUS: GRANTED
LOCK_DATA: 1
4 rows in set (0.00 sec)

ERROR:
No query specified
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4ECE\u9501\u7684\u60C5\u51B5\u53EF\u4EE5\u770B\u51FA\u6765\uFF0C\u4E24\u4E2A\u4E8B\u52A1\u5206\u522B\u83B7\u53D6\u4E86IX\u9501\uFF0C\u6211\u4EEC\u4ECE\u610F\u5411\u9501\u7AE0\u8282\u53EF\u4EE5\u77E5\u9053\uFF0CIX\u9501\u4E92\u76F8\u65F6\u517C\u5BB9\u7684\u3002\u6240 \u4EE5\u8FD9\u91CC\u4E0D\u4F1A\u7B49\u5F85\uFF0C\u4F46\u662F\u4E8B\u52A11\u540C\u6837\u6301\u6709X\u9501\uFF0C\u6B64\u65F6\u4E8B\u52A12\u4E5F\u8981\u53BB\u540C\u4E00\u884C\u8BB0\u5F55\u83B7\u53D6X\u9501\uFF0C\u4ED6\u4EEC\u4E4B\u95F4\u4E0D\u517C\u5BB9\uFF0C\u5BFC \u81F4\u7B49\u5F85\u7684\u60C5\u51B5\u53D1\u751F\u3002</p><h3 id="_6-\u9644\u5F55" tabindex="-1"><a class="header-anchor" href="#_6-\u9644\u5F55" aria-hidden="true">#</a> 6. \u9644\u5F55</h3><p><strong>\u95F4\u9699\u9501\u52A0\u9501\u89C4\u5219\uFF08\u517111\u4E2A\u6848\u4F8B\uFF09</strong></p><p>\u95F4\u9699\u9501\u662F\u5728\u53EF\u91CD\u590D\u8BFB\u9694\u79BB\u7EA7\u522B\u4E0B\u624D\u4F1A\u751F\u6548\u7684\uFF1A next-key lock \u5B9E\u9645\u4E0A\u662F\u7531\u95F4\u9699\u9501\u52A0\u884C\u9501\u5B9E\u73B0\u7684\uFF0C\u5982\u679C\u5207\u6362 \u5230\u8BFB\u63D0\u4EA4\u9694\u79BB\u7EA7\u522B (read-committed) \u7684\u8BDD\uFF0C\u5C31\u597D\u7406\u89E3\u4E86\uFF0C\u8FC7\u7A0B\u4E2D\u53BB\u6389\u95F4\u9699\u9501\u7684\u90E8\u5206\uFF0C\u4E5F\u5C31\u662F\u53EA\u5269\u4E0B\u884C\u9501 \u7684\u90E8\u5206\u3002\u800C\u5728\u8BFB\u63D0\u4EA4\u9694\u79BB\u7EA7\u522B\u4E0B\u95F4\u9699\u9501\u5C31\u6CA1\u6709\u4E86\uFF0C\u4E3A\u4E86\u89E3\u51B3\u53EF\u80FD\u51FA\u73B0\u7684\u6570\u636E\u548C\u65E5\u5FD7\u4E0D\u4E00\u81F4\u95EE\u9898\uFF0C\u9700\u8981\u628A binlog \u683C\u5F0F\u8BBE\u7F6E\u4E3A row \u3002\u4E5F\u5C31\u662F\u8BF4\uFF0C\u8BB8\u591A\u516C\u53F8\u7684\u914D\u7F6E\u4E3A\uFF1A\u8BFB\u63D0\u4EA4\u9694\u79BB\u7EA7\u522B\u52A0 binlog_format=row\u3002\u4E1A\u52A1\u4E0D \u9700\u8981\u53EF\u91CD\u590D\u8BFB\u7684\u4FDD\u8BC1\uFF0C\u8FD9\u6837\u8003\u8651\u5230\u8BFB\u63D0\u4EA4\u4E0B\u64CD\u4F5C\u6570\u636E\u7684\u9501\u8303\u56F4\u66F4\u5C0F\uFF08\u6CA1\u6709\u95F4\u9699\u9501\uFF09\uFF0C\u8FD9\u4E2A\u9009\u62E9\u662F\u5408\u7406\u7684\u3002</p><p>next-key lock\u7684\u52A0\u9501\u89C4\u5219</p><p>\u603B\u7ED3\u7684\u52A0\u9501\u89C4\u5219\u91CC\u9762\uFF0C\u5305\u542B\u4E86\u4E24\u4E2A \u201C \u201C \u539F\u5219 \u201D \u201D \u3001\u4E24\u4E2A \u201C \u201C \u4F18\u5316 \u201D \u201D \u548C\u4E00\u4E2A \u201Cbug\u201D \u3002</p><ol><li>\u539F\u5219 1 \uFF1A\u52A0\u9501\u7684\u57FA\u672C\u5355\u4F4D\u662F next-key lock \u3002 next-key lock \u662F\u524D\u5F00\u540E\u95ED\u533A\u95F4\u3002</li><li>\u539F\u5219 2 \uFF1A\u67E5\u627E\u8FC7\u7A0B\u4E2D\u8BBF\u95EE\u5230\u7684\u5BF9\u8C61\u624D\u4F1A\u52A0\u9501\u3002\u4EFB\u4F55\u8F85\u52A9\u7D22\u5F15\u4E0A\u7684\u9501\uFF0C\u6216\u8005\u975E\u7D22\u5F15\u5217\u4E0A\u7684\u9501\uFF0C\u6700\u7EC8 \u90FD\u8981\u56DE\u6EAF\u5230\u4E3B\u952E\u4E0A\uFF0C\u5728\u4E3B\u952E\u4E0A\u4E5F\u8981\u52A0\u4E00\u628A\u9501\u3002</li><li>\u4F18\u5316 1 \uFF1A\u7D22\u5F15\u4E0A\u7684\u7B49\u503C\u67E5\u8BE2\uFF0C\u7ED9\u552F\u4E00\u7D22\u5F15\u52A0\u9501\u7684\u65F6\u5019\uFF0C next-key lock \u9000\u5316\u4E3A\u884C\u9501\u3002\u4E5F\u5C31\u662F\u8BF4\u5982\u679C InnoDB\u626B\u63CF\u7684\u662F\u4E00\u4E2A\u4E3B\u952E\u3001\u6216\u662F\u4E00\u4E2A\u552F\u4E00\u7D22\u5F15\u7684\u8BDD\uFF0C\u90A3InnoDB\u53EA\u4F1A\u91C7\u7528\u884C\u9501\u65B9\u5F0F\u6765\u52A0\u9501</li><li>\u4F18\u5316 2 \uFF1A\u7D22\u5F15\u4E0A\uFF08\u4E0D\u4E00\u5B9A\u662F\u552F\u4E00\u7D22\u5F15\uFF09\u7684\u7B49\u503C\u67E5\u8BE2\uFF0C\u5411\u53F3\u904D\u5386\u65F6\u4E14\u6700\u540E\u4E00\u4E2A\u503C\u4E0D\u6EE1\u8DB3\u7B49\u503C\u6761\u4EF6\u7684 \u65F6\u5019\uFF0C next-keylock \u9000\u5316\u4E3A\u95F4\u9699\u9501\u3002</li><li>\u4E00\u4E2A bug \uFF1A\u552F\u4E00\u7D22\u5F15\u4E0A\u7684\u8303\u56F4\u67E5\u8BE2\u4F1A\u8BBF\u95EE\u5230\u4E0D\u6EE1\u8DB3\u6761\u4EF6\u7684\u7B2C\u4E00\u4E2A\u503C\u4E3A\u6B62\u3002</li></ol><p>\u6211\u4EEC\u4EE5\u8868test\u4F5C\u4E3A\u4F8B\u5B50\uFF0C\u5EFA\u8868\u8BED\u53E5\u548C\u521D\u59CB\u5316\u8BED\u53E5\u5982\u4E0B\uFF1A\u5176\u4E2Did\u4E3A\u4E3B\u952E\u7D22\u5F15</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>CREATE TABLE \`test\` (
\`id\` int(11) NOT NULL,
\`col1\` int(11) DEFAULT NULL,
\`col2\` int(11) DEFAULT NULL,
PRIMARY KEY (\`id\`),
KEY \`c\` (\`c\`)
) ENGINE=InnoDB;
insert into test values(0,0,0),(5,5,5),
(10,10,10),(15,15,15),(20,20,20),(25,25,25);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u6848\u4F8B\u4E00\uFF1A\u552F\u4E00\u7D22\u5F15\u7B49\u503C\u67E5\u8BE2\u95F4\u9699\u9501</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714134603698.png" alt="image-20220714134603698"></p><p>\u7531\u4E8E\u8868 test \u4E2D\u6CA1\u6709 id=7 \u7684\u8BB0\u5F55</p><p>\u6839\u636E\u539F\u5219 1 \uFF0C\u52A0\u9501\u5355\u4F4D\u662F next-key lock \uFF0C session A \u52A0\u9501\u8303\u56F4\u5C31\u662F (5,10] \uFF1B \u540C\u65F6\u6839\u636E\u4F18\u5316 2 \uFF0C\u8FD9\u662F\u4E00\u4E2A\u7B49 \u503C\u67E5\u8BE2 (id=7) \uFF0C\u800C id=10 \u4E0D\u6EE1\u8DB3\u67E5\u8BE2\u6761\u4EF6\uFF0C next-key lock \u9000\u5316\u6210\u95F4\u9699\u9501\uFF0C\u56E0\u6B64\u6700\u7EC8\u52A0\u9501\u7684\u8303\u56F4\u662F (5,10)</p><p><strong>\u6848\u4F8B\u4E8C\uFF1A\u975E\u552F\u4E00\u7D22\u5F15\u7B49\u503C\u67E5\u8BE2\u9501</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714134623052-16577775838551.png" alt="image-20220714134623052"></p><p>\u8FD9\u91CC session A \u8981\u7ED9\u7D22\u5F15 col1 \u4E0A col1=5 \u7684\u8FD9\u4E00\u884C\u52A0\u4E0A\u8BFB\u9501\u3002</p><ol><li>\u6839\u636E\u539F\u5219 1 \uFF0C\u52A0\u9501\u5355\u4F4D\u662F next-key lock \uFF0C\u5DE6\u5F00\u53F3\u95ED\uFF0C5\u662F\u95ED\u4E0A\u7684\uFF0C\u56E0\u6B64\u4F1A\u7ED9 (0,5] \u52A0\u4E0A next-key lock \u3002</li><li>\u8981\u6CE8\u610F c \u662F\u666E\u901A\u7D22\u5F15\uFF0C\u56E0\u6B64\u4EC5\u8BBF\u95EE c=5 \u8FD9\u4E00\u6761\u8BB0\u5F55\u662F\u4E0D\u80FD\u9A6C\u4E0A\u505C\u4E0B\u6765\u7684\uFF08\u53EF\u80FD\u6709col1=5\u7684\u5176\u4ED6\u8BB0 \u5F55\uFF09\uFF0C\u9700\u8981\u5411\u53F3\u904D\u5386\uFF0C\u67E5\u5230c=10 \u624D\u653E\u5F03\u3002\u6839\u636E\u539F\u5219 2 \uFF0C\u8BBF\u95EE\u5230\u7684\u90FD\u8981\u52A0\u9501\uFF0C\u56E0\u6B64\u8981\u7ED9 (5,10] \u52A0 next-key lock \u3002</li><li>\u4F46\u662F\u540C\u65F6\u8FD9\u4E2A\u7B26\u5408\u4F18\u5316 2 \uFF1A\u7B49\u503C\u5224\u65AD\uFF0C\u5411\u53F3\u904D\u5386\uFF0C\u6700\u540E\u4E00\u4E2A\u503C\u4E0D\u6EE1\u8DB3 col1=5 \u8FD9\u4E2A\u7B49\u503C\u6761\u4EF6\uFF0C\u56E0\u6B64\u9000\u5316\u6210\u95F4\u9699\u9501 (5,10) \u3002</li><li>\u6839\u636E\u539F\u5219 2 \uFF0C \u53EA\u6709\u8BBF\u95EE\u5230\u7684\u5BF9\u8C61\u624D\u4F1A\u52A0\u9501\uFF0C\u8FD9\u4E2A\u67E5\u8BE2\u4F7F\u7528\u8986\u76D6\u7D22\u5F15\uFF0C\u5E76\u4E0D\u9700\u8981\u8BBF\u95EE\u4E3B\u952E\u7D22\u5F15\uFF0C\u6240\u4EE5\u4E3B\u952E\u7D22\u5F15\u4E0A\u6CA1\u6709\u52A0\u4EFB\u4F55\u9501\uFF0C\u8FD9\u5C31\u662F\u4E3A\u4EC0\u4E48 session B \u7684 update \u8BED\u53E5\u53EF\u4EE5\u6267\u884C\u5B8C\u6210\u3002</li></ol><p>\u4F46 session C \u8981\u63D2\u5165\u4E00\u4E2A (7,7,7) \u7684\u8BB0\u5F55\uFF0C\u5C31\u4F1A\u88AB session A \u7684\u95F4\u9699\u9501 (5,10) \u9501\u4F4F \u8FD9\u4E2A\u4F8B\u5B50\u8BF4\u660E\uFF0C\u9501\u662F\u52A0\u5728\u7D22\u5F15\u4E0A\u7684\u3002</p><p>\u6267\u884C for update \u65F6\uFF0C\u7CFB\u7EDF\u4F1A\u8BA4\u4E3A\u4F60\u63A5\u4E0B\u6765\u8981\u66F4\u65B0\u6570\u636E\uFF0C\u56E0\u6B64\u4F1A\u987A\u4FBF\u7ED9\u4E3B\u952E\u7D22\u5F15\u4E0A\u6EE1\u8DB3\u6761\u4EF6\u7684\u884C\u52A0\u4E0A\u884C\u9501\u3002</p><p>\u5982\u679C\u4F60\u8981\u7528 lock in share mode\u6765\u7ED9\u884C\u52A0\u8BFB\u9501\u907F\u514D\u6570\u636E\u88AB\u66F4\u65B0\u7684\u8BDD\uFF0C\u5C31\u5FC5\u987B\u5F97\u7ED5\u8FC7\u8986\u76D6\u7D22\u5F15\u7684\u4F18\u5316\uFF0C\u56E0\u4E3A\u8986\u76D6\u7D22\u5F15\u4E0D\u4F1A\u8BBF\u95EE\u4E3B\u952E\u7D22\u5F15\uFF0C\u4E0D\u4F1A\u7ED9\u4E3B\u952E\u7D22\u5F15\u4E0A\u52A0\u9501</p><p><strong>\u6848\u4F8B\u4E09\uFF1A\u4E3B\u952E\u7D22\u5F15\u8303\u56F4\u67E5\u8BE2\u9501</strong></p><p>\u4E0A\u9762\u4E24\u4E2A\u4F8B\u5B50\u662F\u7B49\u503C\u67E5\u8BE2\u7684\uFF0C\u8FD9\u4E2A\u4F8B\u5B50\u662F\u5173\u4E8E\u8303\u56F4\u67E5\u8BE2\u7684\uFF0C\u4E5F\u5C31\u662F\u8BF4\u4E0B\u9762\u7684\u8BED\u53E5</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>select * from test where id=10 for update
select * from tets where id&gt;=10 and id&lt;11 for update;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u4E24\u6761\u67E5\u8BED\u53E5\u80AF\u5B9A\u662F\u7B49\u4EF7\u7684\uFF0C\u4F46\u662F\u5B83\u4EEC\u7684\u52A0\u9501\u89C4\u5219\u4E0D\u592A\u4E00\u6837</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714134742049.png" alt="image-20220714134742049"></p><ol><li>\u5F00\u59CB\u6267\u884C\u7684\u65F6\u5019\uFF0C\u8981\u627E\u5230\u7B2C\u4E00\u4E2A id=10 \u7684\u884C\uFF0C\u56E0\u6B64\u672C\u8BE5\u662F next-key lock(5,10] \u3002 \u6839\u636E\u4F18\u5316 1 \uFF0C\u4E3B\u952E id \u4E0A\u7684\u7B49\u503C\u6761\u4EF6\uFF0C\u9000\u5316\u6210\u884C\u9501\uFF0C\u53EA\u52A0\u4E86 id=10 \u8FD9\u4E00\u884C\u7684\u884C\u9501\u3002</li><li>\u5B83\u662F\u8303\u56F4\u67E5\u8BE2\uFF0C \u8303\u56F4\u67E5\u627E\u5C31\u5F80\u540E\u7EE7\u7EED\u627E\uFF0C\u627E\u5230 id=15 \u8FD9\u4E00\u884C\u505C\u4E0B\u6765\uFF0C\u4E0D\u6EE1\u8DB3\u6761\u4EF6\uFF0C\u56E0\u6B64\u9700\u8981\u52A0 next-key lock(10,15] \u3002</li></ol><p>session A \u8FD9\u65F6\u5019\u9501\u7684\u8303\u56F4\u5C31\u662F\u4E3B\u952E\u7D22\u5F15\u4E0A\uFF0C\u884C\u9501 id=10 \u548C next-key lock(10,15] \u3002<strong>\u9996\u6B21 session A \u5B9A\u4F4D\u67E5\u627E id=10 \u7684\u884C\u7684\u65F6\u5019\uFF0C\u662F\u5F53\u505A\u7B49\u503C\u67E5\u8BE2\u6765\u5224\u65AD\u7684\uFF0C\u800C\u5411\u53F3\u626B\u63CF\u5230 id=15 \u7684\u65F6\u5019\uFF0C\u7528\u7684\u662F\u8303\u56F4\u67E5\u8BE2\u5224\u65AD\u3002</strong></p><p><strong>\u6848\u4F8B\u56DB\uFF1A\u975E\u552F\u4E00\u7D22\u5F15\u8303\u56F4\u67E5\u8BE2\u9501</strong></p><p>\u4E0E\u6848\u4F8B\u4E09\u4E0D\u540C\u7684\u662F\uFF0C\u6848\u4F8B\u56DB\u4E2D\u67E5\u8BE2\u8BED\u53E5\u7684 where \u90E8\u5206\u7528\u7684\u662F\u5B57\u6BB5 c \uFF0C\u5B83\u662F\u666E\u901A\u7D22\u5F15</p><p>\u8FD9\u4E24\u6761\u67E5\u8BED\u53E5\u80AF\u5B9A\u662F\u7B49\u4EF7\u7684\uFF0C\u4F46\u662F\u5B83\u4EEC\u7684\u52A0\u9501\u89C4\u5219\u4E0D\u592A\u4E00\u6837</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714134822160.png" alt="image-20220714134822160"></p><p>\u5728\u7B2C\u4E00\u6B21\u7528 col1=10 \u5B9A\u4F4D\u8BB0\u5F55\u7684\u65F6\u5019\uFF0C\u7D22\u5F15 c \u4E0A\u52A0\u4E86 (5,10] \u8FD9\u4E2A next-key lock \u540E\uFF0C\u7531\u4E8E\u7D22\u5F15 col1 \u662F\u975E\u552F \u4E00\u7D22\u5F15\uFF0C\u6CA1\u6709\u4F18\u5316\u89C4\u5219\uFF0C\u4E5F\u5C31\u662F\u8BF4\u4E0D\u4F1A\u8715\u53D8\u4E3A\u884C\u9501\uFF0C\u56E0\u6B64\u6700\u7EC8 sesion A \u52A0\u7684\u9501\u662F\uFF0C\u7D22\u5F15 c \u4E0A\u7684 (5,10] \u548C (10,15] \u8FD9\u4E24\u4E2A next-keylock \u3002</p><p>\u8FD9\u91CC\u9700\u8981\u626B\u63CF\u5230 col1=15 \u624D\u505C\u6B62\u626B\u63CF\uFF0C\u662F\u5408\u7406\u7684\uFF0C\u56E0\u4E3A InnoDB \u8981\u626B\u5230 col1=15 \uFF0C\u624D\u77E5\u9053\u4E0D\u9700\u8981\u7EE7\u7EED\u5F80\u540E\u627E\u4E86\u3002</p><p><strong>\u6848\u4F8B\u4E94\uFF1A\u552F\u4E00\u7D22\u5F15\u8303\u56F4\u67E5\u8BE2\u9501 bug</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714134846740.png" alt="image-20220714134846740"></p><p>session A \u662F\u4E00\u4E2A\u8303\u56F4\u67E5\u8BE2\uFF0C\u6309\u7167\u539F\u5219 1 \u7684\u8BDD\uFF0C\u5E94\u8BE5\u662F\u7D22\u5F15 id \u4E0A\u53EA\u52A0 (10,15] \u8FD9\u4E2A next-key lock \uFF0C\u5E76\u4E14\u56E0 \u4E3A id \u662F\u552F\u4E00\u952E\uFF0C\u6240\u4EE5\u5FAA\u73AF\u5224\u65AD\u5230 id=15 \u8FD9\u4E00\u884C\u5C31\u5E94\u8BE5\u505C\u6B62\u4E86\u3002</p><p>\u4F46\u662F\u5B9E\u73B0\u4E0A\uFF0C InnoDB \u4F1A\u5F80\u524D\u626B\u63CF\u5230\u7B2C\u4E00\u4E2A\u4E0D\u6EE1\u8DB3\u6761\u4EF6\u7684\u884C\u4E3A\u6B62\uFF0C\u4E5F\u5C31\u662F id=20 \u3002\u800C\u4E14\u7531\u4E8E\u8FD9\u662F\u4E2A\u8303\u56F4\u626B\u63CF\uFF0C\u56E0\u6B64\u7D22\u5F15 id \u4E0A\u7684 (15,20] \u8FD9\u4E2A next-key lock \u4E5F\u4F1A\u88AB\u9501\u4E0A\u3002\u7167\u7406\u8BF4\uFF0C\u8FD9\u91CC\u9501\u4F4F id=20 \u8FD9\u4E00\u884C\u7684\u884C\u4E3A\uFF0C\u5176\u5B9E\u662F\u6CA1\u6709\u5FC5\u8981\u7684\u3002\u56E0\u4E3A\u626B\u63CF\u5230 id=15 \uFF0C\u5C31\u53EF\u4EE5\u786E\u5B9A\u4E0D\u7528\u5F80\u540E\u518D\u627E\u4E86\u3002</p><p><strong>\u6848\u4F8B\u516D\uFF1A\u975E\u552F\u4E00\u7D22\u5F15\u4E0A\u5B58\u5728 &quot; &quot; \u7B49\u503C &quot; &quot; \u7684\u4F8B\u5B50</strong></p><p>\u8FD9\u91CC\uFF0C\u6211\u7ED9\u8868 t \u63D2\u5165\u4E00\u6761\u65B0\u8BB0\u5F55\uFF1Ainsert into t values(30,10,30);\u4E5F\u5C31\u662F\u8BF4\uFF0C\u73B0\u5728\u8868\u91CC\u9762\u6709\u4E24\u4E2Ac=10\u7684\u884C</p><p><strong>\u4F46\u662F\u5B83\u4EEC\u7684\u4E3B\u952E\u503C id \u662F\u4E0D\u540C\u7684\uFF08\u5206\u522B\u662F 10 \u548C 30 \uFF09\uFF0C\u56E0\u6B64\u8FD9\u4E24\u4E2Ac=10 \u7684\u8BB0\u5F55\u4E4B\u95F4\uFF0C\u4E5F\u662F\u6709\u95F4\u9699\u7684\u3002</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714134923414.png" alt="image-20220714134923414"></p><p>\u8FD9\u6B21\u6211\u4EEC\u7528 delete \u8BED\u53E5\u6765\u9A8C\u8BC1\u3002\u6CE8\u610F\uFF0C delete \u8BED\u53E5\u52A0\u9501\u7684\u903B\u8F91\uFF0C\u5176\u5B9E\u8DDF select ... for update \u662F\u7C7B\u4F3C\u7684\uFF0C \u4E5F\u5C31\u662F\u6211\u5728\u6587\u7AE0\u5F00\u59CB\u603B\u7ED3\u7684\u4E24\u4E2A \u201C \u539F\u5219 \u201D \u3001\u4E24\u4E2A \u201C \u4F18\u5316 \u201D \u548C\u4E00\u4E2A \u201Cbug\u201D \u3002</p><p>\u8FD9\u65F6\uFF0C session A \u5728\u904D\u5386\u7684\u65F6\u5019\uFF0C\u5148\u8BBF\u95EE\u7B2C\u4E00\u4E2A col1=10 \u7684\u8BB0\u5F55\u3002\u540C\u6837\u5730\uFF0C\u6839\u636E\u539F\u5219 1 \uFF0C\u8FD9\u91CC\u52A0\u7684\u662F (col1=5,id=5) \u5230 (col1=10,id=10) \u8FD9\u4E2A next-key lock \u3002</p><p>\u7531\u4E8Ec\u662F\u666E\u901A\u7D22\u5F15\uFF0C\u6240\u4EE5\u7EE7\u7EED\u5411\u53F3\u67E5\u627E\uFF0C\u76F4\u5230\u78B0\u5230 (col1=15,id=15) \u8FD9\u4E00\u884C\u5FAA\u73AF\u624D\u7ED3\u675F\u3002\u6839\u636E\u4F18\u5316 2 \uFF0C\u8FD9\u662F \u4E00\u4E2A\u7B49\u503C\u67E5\u8BE2\uFF0C\u5411\u53F3\u67E5\u627E\u5230\u4E86\u4E0D\u6EE1\u8DB3\u6761\u4EF6\u7684\u884C\uFF0C\u6240\u4EE5\u4F1A\u9000\u5316\u6210 (col1=10,id=10) \u5230 (col1=15,id=15) \u7684\u95F4\u9699\u9501\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714134945012.png" alt="image-20220714134945012"></p><p>\u8FD9\u4E2A delete \u8BED\u53E5\u5728\u7D22\u5F15 c \u4E0A\u7684\u52A0\u9501\u8303\u56F4\uFF0C\u5C31\u662F\u4E0A\u9762\u56FE\u4E2D\u84DD\u8272\u533A\u57DF\u8986\u76D6\u7684\u90E8\u5206\u3002\u8FD9\u4E2A\u84DD\u8272\u533A\u57DF\u5DE6\u53F3\u4E24\u8FB9\u90FD \u662F\u865A\u7EBF\uFF0C\u8868\u793A\u5F00\u533A\u95F4\uFF0C\u5373 (col1=5,id=5) \u548C (col1=15,id=15) \u8FD9\u4E24\u884C\u4E0A\u90FD\u6CA1\u6709\u9501</p><p><strong>\u6848\u4F8B\u4E03\uFF1A limit \u8BED\u53E5\u52A0\u9501</strong></p><p>\u4F8B\u5B50 6 \u4E5F\u6709\u4E00\u4E2A\u5BF9\u7167\u6848\u4F8B\uFF0C\u573A\u666F\u5982\u4E0B\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714135007118.png" alt="image-20220714135007118"></p><p>session A \u7684 delete \u8BED\u53E5\u52A0\u4E86 limit 2 \u3002\u4F60\u77E5\u9053\u8868 t \u91CC c=10 \u7684\u8BB0\u5F55\u5176\u5B9E\u53EA\u6709\u4E24\u6761\uFF0C\u56E0\u6B64\u52A0\u4E0D\u52A0 limit 2 \uFF0C\u5220\u9664\u7684\u6548\u679C\u90FD\u662F\u4E00\u6837\u7684\u3002\u4F46\u662F\u52A0\u9501\u6548\u679C\u5374\u4E0D\u4E00\u6837</p><p>\u8FD9\u662F\u56E0\u4E3A\uFF0C\u6848\u4F8B\u4E03\u91CC\u7684 delete \u8BED\u53E5\u660E\u786E\u52A0\u4E86 limit 2 \u7684\u9650\u5236\uFF0C\u56E0\u6B64\u5728\u904D\u5386\u5230 (col1=10, id=30) \u8FD9\u4E00\u884C\u4E4B\u540E\uFF0C \u6EE1\u8DB3\u6761\u4EF6\u7684\u8BED\u53E5\u5DF2\u7ECF\u6709\u4E24\u6761\uFF0C\u5FAA\u73AF\u5C31\u7ED3\u675F\u4E86\u3002\u56E0\u6B64\uFF0C\u7D22\u5F15 col1 \u4E0A\u7684\u52A0\u9501\u8303\u56F4\u5C31\u53D8\u6210\u4E86\u4ECE\uFF08 col1=5,id=5) \u5230\uFF08 col1=10,id=30) \u8FD9\u4E2A\u524D\u5F00\u540E\u95ED\u533A\u95F4\uFF0C\u5982\u4E0B\u56FE\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714135025045-16577778257713.png" alt="image-20220714135025045"></p><p>\u8FD9\u4E2A\u4F8B\u5B50\u5BF9\u6211\u4EEC\u5B9E\u8DF5\u7684\u6307\u5BFC\u610F\u4E49\u5C31\u662F\uFF0C \u5728\u5220\u9664\u6570\u636E\u7684\u65F6\u5019\u5C3D\u91CF\u52A0 limit \u3002</p><p>\u8FD9\u6837\u4E0D\u4EC5\u53EF\u4EE5\u63A7\u5236\u5220\u9664\u6570\u636E\u7684\u6761\u6570\uFF0C\u8BA9\u64CD\u4F5C\u66F4\u5B89\u5168\uFF0C\u8FD8\u53EF\u4EE5\u51CF\u5C0F\u52A0\u9501\u7684\u8303\u56F4\u3002</p><p><strong>\u6848\u4F8B\u516B\uFF1A\u4E00\u4E2A\u6B7B\u9501\u7684\u4F8B\u5B50</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714135047760.png" alt="image-20220714135047760"></p><ol><li>session A \u542F\u52A8\u4E8B\u52A1\u540E\u6267\u884C\u67E5\u8BE2\u8BED\u53E5\u52A0 lock in share mode \uFF0C\u5728\u7D22\u5F15 col1 \u4E0A\u52A0\u4E86 next-keylock(5,10] \u548C \u95F4\u9699\u9501 (10,15) \uFF08\u7D22\u5F15\u5411\u53F3\u904D\u5386\u9000\u5316\u4E3A\u95F4\u9699\u9501\uFF09\uFF1B</li><li>session B \u7684 update \u8BED\u53E5\u4E5F\u8981\u5728\u7D22\u5F15 c \u4E0A\u52A0 next-key lock(5,10] \uFF0C\u8FDB\u5165\u9501\u7B49\u5F85\uFF1B \u5B9E\u9645\u4E0A\u5206\u6210\u4E86\u4E24\u6B65\uFF0C \u5148\u662F\u52A0 (5,10) \u7684\u95F4\u9699\u9501\uFF0C\u52A0\u9501\u6210\u529F\uFF1B\u7136\u540E\u52A0 col1=10 \u7684\u884C\u9501\uFF0C\u56E0\u4E3AsessionA\u4E0A\u5DF2\u7ECF\u7ED9\u8FD9\u884C\u52A0\u4E0A\u4E86\u8BFB \u9501\uFF0C\u6B64\u65F6\u7533\u8BF7\u6B7B\u9501\u65F6\u4F1A\u88AB\u963B\u585E</li><li>\u7136\u540E session A \u8981\u518D\u63D2\u5165 (8,8,8) \u8FD9\u4E00\u884C\uFF0C\u88AB session B \u7684\u95F4\u9699\u9501\u9501\u4F4F\u3002\u7531\u4E8E\u51FA\u73B0\u4E86\u6B7B\u9501\uFF0C InnoDB \u8BA9 session B \u56DE\u6EDA</li></ol><p><strong>\u6848\u4F8B\u4E5D\uFF1Aorder by\u7D22\u5F15\u6392\u5E8F\u7684\u95F4\u9699\u95011</strong></p><p>\u5982\u4E0B\u9762\u4E00\u6761\u8BED\u53E5</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>begin;
select * from test where id&gt;9 and id&lt;12 order by id desc for update;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0B\u56FE\u4E3A\u8FD9\u4E2A\u8868\u7684\u7D22\u5F15id\u7684\u793A\u610F\u56FE\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714135130668.png" alt="image-20220714135130668"></p><ol><li>\u9996\u5148\u8FD9\u4E2A\u67E5\u8BE2\u8BED\u53E5\u7684\u8BED\u4E49\u662F order by id desc \uFF0C\u8981\u62FF\u5230\u6EE1\u8DB3\u6761\u4EF6\u7684\u6240\u6709\u884C\uFF0C\u4F18\u5316\u5668\u5FC5\u987B\u5148\u627E\u5230 \u201C \u7B2C \u4E00\u4E2A id&lt;12 \u7684\u503C \u201D \u3002</li><li>\u8FD9\u4E2A\u8FC7\u7A0B\u662F\u901A\u8FC7\u7D22\u5F15\u6811\u7684\u641C\u7D22\u8FC7\u7A0B\u5F97\u5230\u7684\uFF0C\u5728\u5F15\u64CE\u5185\u90E8\uFF0C\u5176\u5B9E\u662F\u8981\u627E\u5230 id=12 \u7684\u8FD9\u4E2A\u503C\uFF0C\u53EA\u662F\u6700\u7EC8 \u6CA1\u627E\u5230\uFF0C\u4F46\u627E\u5230\u4E86 (10,15) \u8FD9\u4E2A\u95F4\u9699\u3002\uFF08 id=15 \u4E0D\u6EE1\u8DB3\u6761\u4EF6\uFF0C\u6240\u4EE5 next-key lock \u9000\u5316\u4E3A\u4E86\u95F4\u9699\u9501 (10, 15) \u3002\uFF09</li><li>\u7136\u540E\u5411\u5DE6\u904D\u5386\uFF0C\u5728\u904D\u5386\u8FC7\u7A0B\u4E2D\uFF0C\u5C31\u4E0D\u662F\u7B49\u503C\u67E5\u8BE2\u4E86\uFF0C\u4F1A\u626B\u63CF\u5230 id=5 \u8FD9\u4E00\u884C\uFF0C\u53C8\u56E0\u4E3A\u533A\u95F4\u662F\u5DE6\u5F00\u53F3 \u95ED\u7684\uFF0C\u6240\u4EE5\u4F1A\u52A0\u4E00\u4E2Anext-key lock (0,5] \u3002 \u4E5F\u5C31\u662F\u8BF4\uFF0C\u5728\u6267\u884C\u8FC7\u7A0B\u4E2D\uFF0C\u901A\u8FC7\u6811\u641C\u7D22\u7684\u65B9\u5F0F\u5B9A\u4F4D\u8BB0\u5F55 \u7684\u65F6\u5019\uFF0C\u7528\u7684\u662F \u201C \u7B49\u503C\u67E5\u8BE2 \u201D \u7684\u65B9\u6CD5\u3002</li></ol><p><strong>\u6848\u4F8B\u5341\uFF1Aorder by\u7D22\u5F15\u6392\u5E8F\u7684\u95F4\u9699\u95012</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714135206504.png" alt="image-20220714135206504"></p><ol><li><p>\u7531\u4E8E\u662F order by col1 desc \uFF0C\u7B2C\u4E00\u4E2A\u8981\u5B9A\u4F4D\u7684\u662F\u7D22\u5F15 col1 \u4E0A \u201C \u6700\u53F3\u8FB9\u7684 \u201Dcol1=20 \u7684\u884C\u3002\u8FD9\u662F\u4E00\u4E2A\u975E\u552F\u4E00\u7D22\u5F15\u7684\u7B49\u503C\u67E5\u8BE2\uFF1A</p><p>\u5DE6\u5F00\u53F3\u95ED\u533A\u95F4\uFF0C\u9996\u5148\u52A0\u4E0A next-key lock (15,20] \u3002 \u5411\u53F3\u904D\u5386\uFF0Ccol1=25\u4E0D\u6EE1\u8DB3\u6761\u4EF6\uFF0C\u9000\u5316\u4E3A\u95F4\u9699\u9501 \u6240\u4EE5\u4F1A \u52A0\u4E0A\u95F4\u9699\u9501(20,25) \u548C next-key lock (15,20] \u3002</p></li><li><p>\u5728\u7D22\u5F15 col1 \u4E0A\u5411\u5DE6\u904D\u5386\uFF0C\u8981\u626B\u63CF\u5230 col1=10 \u624D\u505C\u4E0B\u6765\u3002\u540C\u65F6\u53C8\u56E0\u4E3A\u5DE6\u5F00\u53F3\u95ED\u533A\u95F4\uFF0C\u6240\u4EE5 next-key lock \u4F1A\u52A0\u5230 (5,10] \uFF0C\u8FD9\u6B63\u662F\u963B\u585Esession B \u7684 insert \u8BED\u53E5\u7684\u539F\u56E0\u3002</p></li><li><p>\u5728\u626B\u63CF\u8FC7\u7A0B\u4E2D\uFF0C col1=20 \u3001 col1=15 \u3001 col1=10 \u8FD9\u4E09\u884C\u90FD\u5B58\u5728\u503C\uFF0C\u7531\u4E8E\u662F select * \uFF0C\u6240\u4EE5\u4F1A\u5728\u4E3B\u952E id \u4E0A\u52A0\u4E09\u4E2A\u884C\u9501\u3002 \u56E0\u6B64\uFF0C session A \u7684 select \u8BED\u53E5\u9501\u7684\u8303\u56F4\u5C31\u662F\uFF1A</p></li><li><p>\u7D22\u5F15 col1 \u4E0A (5, 25) \uFF1B</p></li><li><p>\u4E3B\u952E\u7D22\u5F15\u4E0A id=15 \u3001 20 \u4E24\u4E2A\u884C\u9501\u3002</p></li></ol><p><strong>\u6848\u4F8B\u5341\u4E00\uFF1Aupdate\u4FEE\u6539\u6570\u636E\u7684\u4F8B\u5B50-\u5148\u63D2\u5165\u540E\u5220\u9664</strong></p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714135300189.png" alt="image-20220714135300189"></p><p>\u6CE8\u610F\uFF1A\u6839\u636E col1&gt;5 \u67E5\u5230\u7684\u7B2C\u4E00\u4E2A\u8BB0\u5F55\u662F col1=10 \uFF0C\u56E0\u6B64\u4E0D\u4F1A\u52A0 (0,5] \u8FD9\u4E2A next-key lock \u3002</p><p>session A \u7684\u52A0\u9501\u8303\u56F4\u662F\u7D22\u5F15 col1 \u4E0A\u7684 (5,10] \u3001 (10,15] \u3001 (15,20] \u3001 (20,25] \u548C(25,supremum] \u3002</p><p>\u4E4B\u540E session B \u7684\u7B2C\u4E00\u4E2A update \u8BED\u53E5\uFF0C\u8981\u628A col1=5 \u6539\u6210 col1=1 \uFF0C\u4F60\u53EF\u4EE5\u7406\u89E3\u4E3A\u4E24\u6B65\uFF1A</p><ol><li>\u63D2\u5165 (col1=1, id=5) \u8FD9\u4E2A\u8BB0\u5F55\uFF1B</li><li>\u5220\u9664 (col1=5, id=5) \u8FD9\u4E2A\u8BB0\u5F55\u3002</li></ol><p>\u901A\u8FC7\u8FD9\u4E2A\u64CD\u4F5C\uFF0C session A \u7684\u52A0\u9501\u8303\u56F4\u53D8\u6210\u4E86\u56FE 7 \u6240\u793A\u7684\u6837\u5B50:</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714135333089.png" alt="image-20220714135333089"></p><p>\u597D\uFF0C\u63A5\u4E0B\u6765 session B \u8981\u6267\u884C update t set col1 = 5 where col1 = 1 \u8FD9\u4E2A\u8BED\u53E5\u4E86\uFF0C\u4E00\u6837\u5730\u53EF\u4EE5\u62C6\u6210\u4E24\u6B65\uFF1A</p><ol><li>\u63D2\u5165 (col1=5, id=5) \u8FD9\u4E2A\u8BB0\u5F55\uFF1B</li><li>\u5220\u9664 (col1=1, id=5) \u8FD9\u4E2A\u8BB0\u5F55\u3002 \u7B2C\u4E00\u6B65\u8BD5\u56FE\u5728\u5DF2\u7ECF\u52A0\u4E86\u95F4\u9699\u9501\u7684 (1,10) \u4E2D\u63D2\u5165\u6570\u636E\uFF0C\u6240\u4EE5\u5C31\u88AB\u5835\u4F4F\u4E86\u3002</li></ol><h2 id="\u7B2C16\u7AE0-\u591A\u7248\u672C\u5E76\u53D1\u63A7\u5236" tabindex="-1"><a class="header-anchor" href="#\u7B2C16\u7AE0-\u591A\u7248\u672C\u5E76\u53D1\u63A7\u5236" aria-hidden="true">#</a> \u7B2C16\u7AE0_\u591A\u7248\u672C\u5E76\u53D1\u63A7\u5236</h2><h3 id="_1-\u4EC0\u4E48\u662Fmvcc" tabindex="-1"><a class="header-anchor" href="#_1-\u4EC0\u4E48\u662Fmvcc" aria-hidden="true">#</a> 1. \u4EC0\u4E48\u662FMVCC</h3><p>MVCC \uFF08Multiversion Concurrency Control\uFF09\uFF0C\u591A\u7248\u672C\u5E76\u53D1\u63A7\u5236\u3002\u987E\u540D\u601D\u4E49\uFF0CMVCC \u662F\u901A\u8FC7\u6570\u636E\u884C\u7684\u591A\u4E2A\u7248\u672C\u7BA1\u7406\u6765\u5B9E\u73B0\u6570\u636E\u5E93\u7684 <code>\u5E76\u53D1\u63A7\u5236 </code>\u3002\u8FD9\u9879\u6280\u672F\u4F7F\u5F97\u5728InnoDB\u7684\u4E8B\u52A1\u9694\u79BB\u7EA7\u522B\u4E0B\u6267\u884C <code>\u4E00\u81F4\u6027\u8BFB</code> \u64CD\u4F5C\u6709\u4E86\u4FDD\u8BC1\u3002\u6362\u8A00\u4E4B\uFF0C\u5C31\u662F\u4E3A\u4E86\u67E5\u8BE2\u4E00\u4E9B\u6B63\u5728\u88AB\u53E6\u4E00\u4E2A\u4E8B\u52A1\u66F4\u65B0\u7684\u884C\uFF0C\u5E76\u4E14\u53EF\u4EE5\u770B\u5230\u5B83\u4EEC\u88AB\u66F4\u65B0\u4E4B\u524D\u7684\u503C\uFF0C\u8FD9\u6837 \u5728\u505A\u67E5\u8BE2\u7684\u65F6\u5019\u5C31\u4E0D\u7528\u7B49\u5F85\u53E6\u4E00\u4E2A\u4E8B\u52A1\u91CA\u653E\u9501\u3002</p><p>MVCC\u6CA1\u6709\u6B63\u5F0F\u7684\u6807\u51C6\uFF0C\u5728\u4E0D\u540C\u7684DBMS\u4E2DMVCC\u7684\u5B9E\u73B0\u65B9\u5F0F\u53EF\u80FD\u662F\u4E0D\u540C\u7684\uFF0C\u4E5F\u4E0D\u662F\u666E\u904D\u4F7F\u7528\u7684\uFF08\u5927\u5BB6\u53EF\u4EE5\u53C2\u8003\u76F8\u5173\u7684DBMS\u6587\u6863\uFF09\u3002\u8FD9\u91CC\u8BB2\u89E3InnoDB\u4E2DMVCC\u7684\u5B9E\u73B0\u673A\u5236\uFF08MySQL\u5176\u4ED6\u7684\u5B58\u50A8\u5F15\u64CE\u5E76\u4E0D\u652F\u6301\u5B83\uFF09\u3002</p><h3 id="_2-\u5FEB\u7167\u8BFB\u4E0E\u5F53\u524D\u8BFB" tabindex="-1"><a class="header-anchor" href="#_2-\u5FEB\u7167\u8BFB\u4E0E\u5F53\u524D\u8BFB" aria-hidden="true">#</a> 2. \u5FEB\u7167\u8BFB\u4E0E\u5F53\u524D\u8BFB</h3><p>MVCC\u5728MySQL InnoDB\u4E2D\u7684\u5B9E\u73B0\u4E3B\u8981\u662F\u4E3A\u4E86\u63D0\u9AD8\u6570\u636E\u5E93\u5E76\u53D1\u6027\u80FD\uFF0C\u7528\u66F4\u597D\u7684\u65B9\u5F0F\u53BB\u5904\u7406 <code>\u8BFB-\u5199\u51B2\u7A81</code> \uFF0C\u505A\u5230 \u5373\u4F7F\u6709\u8BFB\u5199\u51B2\u7A81\u65F6\uFF0C\u4E5F\u80FD\u505A\u5230 <code>\u4E0D\u52A0\u9501</code> \uFF0C <code>\u975E\u963B\u585E\u5E76\u53D1\u8BFB</code> \uFF0C\u800C\u8FD9\u4E2A\u8BFB\u6307\u7684\u5C31\u662F <code>\u5FEB\u7167\u8BFB</code> , \u800C\u975E <code>\u5F53\u524D\u8BFB</code> \u3002\u5F53\u524D \u8BFB\u5B9E\u9645\u4E0A\u662F\u4E00\u79CD\u52A0\u9501\u7684\u64CD\u4F5C\uFF0C\u662F\u60B2\u89C2\u9501\u7684\u5B9E\u73B0\u3002\u800C <code>MVCC\u672C\u8D28\u662F\u91C7\u7528\u4E50\u89C2\u9501\u601D\u60F3</code> \u7684\u4E00\u79CD\u65B9\u5F0F\u3002</p><h5 id="_2-1-\u5FEB\u7167\u8BFB" tabindex="-1"><a class="header-anchor" href="#_2-1-\u5FEB\u7167\u8BFB" aria-hidden="true">#</a> 2.1 \u5FEB\u7167\u8BFB</h5><p>\u5FEB\u7167\u8BFB\u53C8\u53EB\u4E00\u81F4\u6027\u8BFB\uFF0C\u8BFB\u53D6\u7684\u662F\u5FEB\u7167\u6570\u636E\u3002<strong>\u4E0D\u52A0\u9501\u7684\u7B80\u5355\u7684 SELECT \u90FD\u5C5E\u4E8E\u5FEB\u7167\u8BFB</strong>\uFF0C\u5373\u4E0D\u52A0\u9501\u7684\u975E\u963B\u585E \u8BFB\uFF1B\u6BD4\u5982\u8FD9\u6837\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>SELECT * FROM player WHERE ...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4E4B\u6240\u4EE5\u51FA\u73B0\u5FEB\u7167\u8BFB\u7684\u60C5\u51B5\uFF0C\u662F\u57FA\u4E8E\u63D0\u9AD8\u5E76\u53D1\u6027\u80FD\u7684\u8003\u8651\uFF0C\u5FEB\u7167\u8BFB\u7684\u5B9E\u73B0\u662F\u57FA\u4E8EMVCC\uFF0C\u5B83\u5728\u5F88\u591A\u60C5\u51B5\u4E0B\uFF0C <code>\u907F\u514D\u4E86\u52A0\u9501\u64CD\u4F5C\uFF0C\u964D\u4F4E\u4E86\u5F00\u9500</code> \u3002</p><p>\u65E2\u7136\u662F\u57FA\u4E8E\u591A\u7248\u672C\uFF0C\u90A3\u4E48\u5FEB\u7167\u8BFB\u53EF\u80FD\u8BFB\u5230\u7684\u5E76\u4E0D\u4E00\u5B9A\u662F\u6570\u636E\u7684\u6700\u65B0\u7248\u672C\uFF0C\u800C\u6709\u53EF\u80FD\u662F\u4E4B\u524D\u7684\u5386\u53F2\u7248\u672C\u3002</p><p>\u5FEB\u7167\u8BFB\u7684\u524D\u63D0\u662F\u9694\u79BB\u7EA7\u522B\u4E0D\u662F\u4E32\u884C\u7EA7\u522B\uFF0C\u4E32\u884C\u7EA7\u522B\u4E0B\u7684\u5FEB\u7167\u8BFB\u4F1A\u9000\u5316\u6210\u5F53\u524D\u8BFB\u3002</p><h5 id="_2-2-\u5F53\u524D\u8BFB" tabindex="-1"><a class="header-anchor" href="#_2-2-\u5F53\u524D\u8BFB" aria-hidden="true">#</a> 2.2 \u5F53\u524D\u8BFB</h5><p>\u5F53\u524D\u8BFB\u8BFB\u53D6\u7684\u662F\u8BB0\u5F55\u7684\u6700\u65B0\u7248\u672C\uFF08\u6700\u65B0\u6570\u636E\uFF0C\u800C\u4E0D\u662F\u5386\u53F2\u7248\u672C\u7684\u6570\u636E\uFF09\uFF0C\u8BFB\u53D6\u65F6\u8FD8\u8981\u4FDD\u8BC1\u5176\u4ED6\u5E76\u53D1\u4E8B\u52A1 \u4E0D\u80FD\u4FEE\u6539\u5F53\u524D\u8BB0\u5F55\uFF0C\u4F1A\u5BF9\u8BFB\u53D6\u7684\u8BB0\u5F55\u8FDB\u884C\u52A0\u9501\u3002\u52A0\u9501\u7684 SELECT\uFF0C\u6216\u8005\u5BF9\u6570\u636E\u8FDB\u884C\u589E\u5220\u6539\u90FD\u4F1A\u8FDB\u884C\u5F53\u524D \u8BFB\u3002\u6BD4\u5982\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>SELECT * FROM student LOCK IN SHARE MODE; # \u5171\u4EAB\u9501
SELECT * FROM student FOR UPDATE; # \u6392\u4ED6\u9501
INSERT INTO student values ... # \u6392\u4ED6\u9501
DELETE FROM student WHERE ... # \u6392\u4ED6\u9501
UPDATE student SET ... # \u6392\u4ED6\u9501
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u590D\u4E60" tabindex="-1"><a class="header-anchor" href="#_3-\u590D\u4E60" aria-hidden="true">#</a> 3. \u590D\u4E60</h3><h5 id="_3-1-\u518D\u8C08\u9694\u79BB\u7EA7\u522B" tabindex="-1"><a class="header-anchor" href="#_3-1-\u518D\u8C08\u9694\u79BB\u7EA7\u522B" aria-hidden="true">#</a> 3.1 \u518D\u8C08\u9694\u79BB\u7EA7\u522B</h5><p>\u6211\u4EEC\u77E5\u9053\u4E8B\u52A1\u6709 4 \u4E2A\u9694\u79BB\u7EA7\u522B\uFF0C\u53EF\u80FD\u5B58\u5728\u4E09\u79CD\u5E76\u53D1\u95EE\u9898\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714140441064.png" alt="image-20220714140441064"></p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714140510426.png" alt="image-20220714140510426" style="float:left;"><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714140541555.png" alt="image-20220714140541555"></p><h5 id="_3-2-\u9690\u85CF\u5B57\u6BB5\u3001undo-log\u7248\u672C\u94FE" tabindex="-1"><a class="header-anchor" href="#_3-2-\u9690\u85CF\u5B57\u6BB5\u3001undo-log\u7248\u672C\u94FE" aria-hidden="true">#</a> 3.2 \u9690\u85CF\u5B57\u6BB5\u3001Undo Log\u7248\u672C\u94FE</h5><p>\u56DE\u987E\u4E00\u4E0Bundo\u65E5\u5FD7\u7684\u7248\u672C\u94FE\uFF0C\u5BF9\u4E8E\u4F7F\u7528 InnoDB \u5B58\u50A8\u5F15\u64CE\u7684\u8868\u6765\u8BF4\uFF0C\u5B83\u7684\u805A\u7C07\u7D22\u5F15\u8BB0\u5F55\u4E2D\u90FD\u5305\u542B\u4E24\u4E2A\u5FC5\u8981\u7684\u9690\u85CF\u5217\u3002</p><ul><li><code>trx_id</code> \uFF1A\u6BCF\u6B21\u4E00\u4E2A\u4E8B\u52A1\u5BF9\u67D0\u6761\u805A\u7C07\u7D22\u5F15\u8BB0\u5F55\u8FDB\u884C\u6539\u52A8\u65F6\uFF0C\u90FD\u4F1A\u628A\u8BE5\u4E8B\u52A1\u7684 <code>\u4E8B\u52A1id</code> \u8D4B\u503C\u7ED9 <code>trx_id</code> \u9690\u85CF\u5217\u3002</li><li><code>roll_pointer</code> \uFF1A\u6BCF\u6B21\u5BF9\u67D0\u6761\u805A\u7C07\u7D22\u5F15\u8BB0\u5F55\u8FDB\u884C\u6539\u52A8\u65F6\uFF0C\u90FD\u4F1A\u628A\u65E7\u7684\u7248\u672C\u5199\u5165\u5230 <code>undo\u65E5\u5FD7</code> \u4E2D\uFF0C\u7136 \u540E\u8FD9\u4E2A\u9690\u85CF\u5217\u5C31\u76F8\u5F53\u4E8E\u4E00\u4E2A\u6307\u9488\uFF0C\u53EF\u4EE5\u901A\u8FC7\u5B83\u6765\u627E\u5230\u8BE5\u8BB0\u5F55\u4FEE\u6539\u524D\u7684\u4FE1\u606F\u3002</li></ul><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714140716427.png" alt="image-20220714140716427" style="float:left;"><p>\u5047\u8BBE\u63D2\u5165\u8BE5\u8BB0\u5F55\u7684<code>\u4E8B\u52A1id</code>\u4E3A<code>8</code>\uFF0C\u90A3\u4E48\u6B64\u523B\u8BE5\u6761\u8BB0\u5F55\u7684\u793A\u610F\u56FE\u5982\u4E0B\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714140801595.png" alt="image-20220714140801595"></p><blockquote><p>insert undo\u53EA\u5728\u4E8B\u52A1\u56DE\u6EDA\u65F6\u8D77\u4F5C\u7528\uFF0C\u5F53\u4E8B\u52A1\u63D0\u4EA4\u540E\uFF0C\u8BE5\u7C7B\u578B\u7684undo\u65E5\u5FD7\u5C31\u6CA1\u7528\u4E86\uFF0C\u5B83\u5360\u7528\u7684Undo Log Segment\u4E5F\u4F1A\u88AB\u7CFB\u7EDF\u56DE\u6536\uFF08\u4E5F\u5C31\u662F\u8BE5undo\u65E5\u5FD7\u5360\u7528\u7684Undo\u9875\u9762\u94FE\u8868\u8981\u4E48\u88AB\u91CD\u7528\uFF0C\u8981\u4E48\u88AB\u91CA\u653E\uFF09\u3002</p></blockquote><p>\u5047\u8BBE\u4E4B\u540E\u4E24\u4E2A\u4E8B\u52A1id\u5206\u522B\u4E3A <code>10</code> \u3001 <code>20</code> \u7684\u4E8B\u52A1\u5BF9\u8FD9\u6761\u8BB0\u5F55\u8FDB\u884C<code> UPDATE</code> \u64CD\u4F5C\uFF0C\u64CD\u4F5C\u6D41\u7A0B\u5982\u4E0B\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714140846658.png" alt="image-20220714140846658"></p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714140908661.png" alt="image-20220714140908661" style="float:left;"><p>\u6BCF\u6B21\u5BF9\u8BB0\u5F55\u8FDB\u884C\u6539\u52A8\uFF0C\u90FD\u4F1A\u8BB0\u5F55\u4E00\u6761undo\u65E5\u5FD7\uFF0C\u6BCF\u6761undo\u65E5\u5FD7\u4E5F\u90FD\u6709\u4E00\u4E2A <code>roll_pointer</code> \u5C5E\u6027 \uFF08 <code>INSERT</code> \u64CD\u4F5C\u5BF9\u5E94\u7684undo\u65E5\u5FD7\u6CA1\u6709\u8BE5\u5C5E\u6027\uFF0C\u56E0\u4E3A\u8BE5\u8BB0\u5F55\u5E76\u6CA1\u6709\u66F4\u65E9\u7684\u7248\u672C\uFF09\uFF0C\u53EF\u4EE5\u5C06\u8FD9\u4E9B <code>undo\u65E5\u5FD7</code> \u90FD\u8FDE\u8D77\u6765\uFF0C\u4E32\u6210\u4E00\u4E2A\u94FE\u8868\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714141012874.png" alt="image-20220714141012874"></p><p>\u5BF9\u8BE5\u8BB0\u5F55\u6BCF\u6B21\u66F4\u65B0\u540E\uFF0C\u90FD\u4F1A\u5C06\u65E7\u503C\u653E\u5230\u4E00\u6761 <code>undo\u65E5\u5FD7</code> \u4E2D\uFF0C\u5C31\u7B97\u662F\u8BE5\u8BB0\u5F55\u7684\u4E00\u4E2A\u65E7\u7248\u672C\uFF0C\u968F\u7740\u66F4\u65B0\u6B21\u6570 \u7684\u589E\u591A\uFF0C\u6240\u6709\u7684\u7248\u672C\u90FD\u4F1A\u88AB <code>roll_pointer</code> \u5C5E\u6027\u8FDE\u63A5\u6210\u4E00\u4E2A\u94FE\u8868\uFF0C\u6211\u4EEC\u628A\u8FD9\u4E2A\u94FE\u8868\u79F0\u4E4B\u4E3A <code>\u7248\u672C\u94FE</code> \uFF0C\u7248 \u672C\u94FE\u7684\u5934\u8282\u70B9\u5C31\u662F\u5F53\u524D\u8BB0\u5F55\u6700\u65B0\u7684\u503C\u3002</p><p>\u6BCF\u4E2A\u7248\u672C\u4E2D\u8FD8\u5305\u542B\u751F\u6210\u8BE5\u7248\u672C\u65F6\u5BF9\u5E94\u7684<code>\u4E8B\u52A1id</code>\u3002</p><h3 id="_4-mvcc\u5B9E\u73B0\u539F\u7406\u4E4Breadview" tabindex="-1"><a class="header-anchor" href="#_4-mvcc\u5B9E\u73B0\u539F\u7406\u4E4Breadview" aria-hidden="true">#</a> 4. MVCC\u5B9E\u73B0\u539F\u7406\u4E4BReadView</h3><p>MVCC \u7684\u5B9E\u73B0\u4F9D\u8D56\u4E8E\uFF1A<code>\u9690\u85CF\u5B57\u6BB5</code>\u3001<code>Undo Log</code>\u3001<code>Read View</code>\u3002</p><h5 id="_4-1-\u4EC0\u4E48\u662Freadview" tabindex="-1"><a class="header-anchor" href="#_4-1-\u4EC0\u4E48\u662Freadview" aria-hidden="true">#</a> 4.1 \u4EC0\u4E48\u662FReadView</h5><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714141154235.png" alt="image-20220714141154235" style="float:left;"><h5 id="_4-2-\u8BBE\u8BA1\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#_4-2-\u8BBE\u8BA1\u601D\u8DEF" aria-hidden="true">#</a> 4.2 \u8BBE\u8BA1\u601D\u8DEF</h5><p>\u4F7F\u7528 <code>READ UNCOMMITTED</code> \u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1\uFF0C\u7531\u4E8E\u53EF\u4EE5\u8BFB\u5230\u672A\u63D0\u4EA4\u4E8B\u52A1\u4FEE\u6539\u8FC7\u7684\u8BB0\u5F55\uFF0C\u6240\u4EE5\u76F4\u63A5\u8BFB\u53D6\u8BB0\u5F55\u7684\u6700\u65B0\u7248\u672C\u5C31\u597D\u4E86\u3002</p><p>\u4F7F\u7528 <code>SERIALIZABLE</code> \u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1\uFF0CInnoDB\u89C4\u5B9A\u4F7F\u7528\u52A0\u9501\u7684\u65B9\u5F0F\u6765\u8BBF\u95EE\u8BB0\u5F55\u3002</p><p>\u4F7F\u7528 <code>READ COMMITTED</code> \u548C <code>REPEATABLE READ</code> \u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1\uFF0C\u90FD\u5FC5\u987B\u4FDD\u8BC1\u8BFB\u5230 <code>\u5DF2\u7ECF\u63D0\u4EA4\u4E86\u7684</code> \u4E8B\u52A1\u4FEE\u6539\u8FC7\u7684\u8BB0\u5F55\u3002\u5047\u5982\u53E6\u4E00\u4E2A\u4E8B\u52A1\u5DF2\u7ECF\u4FEE\u6539\u4E86\u8BB0\u5F55\u4F46\u662F\u5C1A\u672A\u63D0\u4EA4\uFF0C\u662F\u4E0D\u80FD\u76F4\u63A5\u8BFB\u53D6\u6700\u65B0\u7248\u672C\u7684\u8BB0\u5F55\u7684\uFF0C\u6838\u5FC3\u95EE\u9898\u5C31\u662F\u9700\u8981 <code>\u5224\u65AD\u4E00\u4E0B\u7248\u672C\u94FE\u4E2D\u7684\u54EA\u4E2A\u7248\u672C\u662F\u5F53\u524D\u4E8B\u52A1\u53EF\u89C1\u7684</code> \uFF0C\u8FD9\u662F ReadView\u8981\u89E3\u51B3\u7684\u4E3B\u8981\u95EE\u9898\u3002</p><p>\u8FD9\u4E2AReadView\u4E2D\u4E3B\u8981\u5305\u542B4\u4E2A\u6BD4\u8F83\u91CD\u8981\u7684\u5185\u5BB9\uFF0C\u5206\u522B\u5982\u4E0B\uFF1A</p><ol><li><p><code>creator_trx_id</code> \uFF0C\u521B\u5EFA\u8FD9\u4E2A Read View \u7684\u4E8B\u52A1 ID\u3002</p><blockquote><p>\u8BF4\u660E\uFF1A\u53EA\u6709\u5728\u5BF9\u8868\u4E2D\u7684\u8BB0\u5F55\u505A\u6539\u52A8\u65F6\uFF08\u6267\u884CINSERT\u3001DELETE\u3001UPDATE\u8FD9\u4E9B\u8BED\u53E5\u65F6\uFF09\u624D\u4F1A\u4E3A \u4E8B\u52A1\u5206\u914D\u4E8B\u52A1id\uFF0C\u5426\u5219\u5728\u4E00\u4E2A\u53EA\u8BFB\u4E8B\u52A1\u4E2D\u7684\u4E8B\u52A1id\u503C\u90FD\u9ED8\u8BA4\u4E3A0\u3002</p></blockquote></li><li><p><code>trx_ids</code> \uFF0C\u8868\u793A\u5728\u751F\u6210ReadView\u65F6\u5F53\u524D\u7CFB\u7EDF\u4E2D\u6D3B\u8DC3\u7684\u8BFB\u5199\u4E8B\u52A1\u7684 <code>\u4E8B\u52A1id\u5217\u8868</code> \u3002</p></li><li><p><code>up_limit_id</code> \uFF0C\u6D3B\u8DC3\u7684\u4E8B\u52A1\u4E2D\u6700\u5C0F\u7684\u4E8B\u52A1 ID\u3002</p></li><li><p><code>low_limit_id</code> \uFF0C\u8868\u793A\u751F\u6210ReadView\u65F6\u7CFB\u7EDF\u4E2D\u5E94\u8BE5\u5206\u914D\u7ED9\u4E0B\u4E00\u4E2A\u4E8B\u52A1\u7684 id \u503C\u3002low_limit_id \u662F\u7CFB \u7EDF\u6700\u5927\u7684\u4E8B\u52A1id\u503C\uFF0C\u8FD9\u91CC\u8981\u6CE8\u610F\u662F\u7CFB\u7EDF\u4E2D\u7684\u4E8B\u52A1id\uFF0C\u9700\u8981\u533A\u522B\u4E8E\u6B63\u5728\u6D3B\u8DC3\u7684\u4E8B\u52A1ID\u3002</p></li></ol><blockquote><p>\u6CE8\u610F\uFF1Alow_limit_id\u5E76\u4E0D\u662Ftrx_ids\u4E2D\u7684\u6700\u5927\u503C\uFF0C\u4E8B\u52A1id\u662F\u9012\u589E\u5206\u914D\u7684\u3002\u6BD4\u5982\uFF0C\u73B0\u5728\u6709id\u4E3A1\uFF0C 2\uFF0C3\u8FD9\u4E09\u4E2A\u4E8B\u52A1\uFF0C\u4E4B\u540Eid\u4E3A3\u7684\u4E8B\u52A1\u63D0\u4EA4\u4E86\u3002\u90A3\u4E48\u4E00\u4E2A\u65B0\u7684\u8BFB\u4E8B\u52A1\u5728\u751F\u6210ReadView\u65F6\uFF0C trx_ids\u5C31\u5305\u62EC1\u548C2\uFF0Cup_limit_id\u7684\u503C\u5C31\u662F1\uFF0Clow_limit_id\u7684\u503C\u5C31\u662F4\u3002</p></blockquote><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220714142254768.png" alt="image-20220714142254768" style="float:left;"><h5 id="_4-3-readview\u7684\u89C4\u5219" tabindex="-1"><a class="header-anchor" href="#_4-3-readview\u7684\u89C4\u5219" aria-hidden="true">#</a> 4.3 ReadView\u7684\u89C4\u5219</h5><p>\u6709\u4E86\u8FD9\u4E2AReadView\uFF0C\u8FD9\u6837\u5728\u8BBF\u95EE\u67D0\u6761\u8BB0\u5F55\u65F6\uFF0C\u53EA\u9700\u8981\u6309\u7167\u4E0B\u8FB9\u7684\u6B65\u9AA4\u5224\u65AD\u8BB0\u5F55\u7684\u67D0\u4E2A\u7248\u672C\u662F\u5426\u53EF\u89C1\u3002</p><ul><li>\u5982\u679C\u88AB\u8BBF\u95EE\u7248\u672C\u7684trx_id\u5C5E\u6027\u503C\u4E0EReadView\u4E2D\u7684 creator_trx_id \u503C\u76F8\u540C\uFF0C\u610F\u5473\u7740\u5F53\u524D\u4E8B\u52A1\u5728\u8BBF\u95EE\u5B83\u81EA\u5DF1\u4FEE\u6539\u8FC7\u7684\u8BB0\u5F55\uFF0C\u6240\u4EE5\u8BE5\u7248\u672C\u53EF\u4EE5\u88AB\u5F53\u524D\u4E8B\u52A1\u8BBF\u95EE\u3002</li><li>\u5982\u679C\u88AB\u8BBF\u95EE\u7248\u672C\u7684trx_id\u5C5E\u6027\u503C\u5C0F\u4E8EReadView\u4E2D\u7684 up_limit_id \u503C\uFF0C\u8868\u660E\u751F\u6210\u8BE5\u7248\u672C\u7684\u4E8B\u52A1\u5728\u5F53\u524D\u4E8B\u52A1\u751F\u6210ReadView\u524D\u5DF2\u7ECF\u63D0\u4EA4\uFF0C\u6240\u4EE5\u8BE5\u7248\u672C\u53EF\u4EE5\u88AB\u5F53\u524D\u4E8B\u52A1\u8BBF\u95EE\u3002</li><li>\u5982\u679C\u88AB\u8BBF\u95EE\u7248\u672C\u7684trx_id\u5C5E\u6027\u503C\u5927\u4E8E\u6216\u7B49\u4E8EReadView\u4E2D\u7684 low_limit_id \u503C\uFF0C\u8868\u660E\u751F\u6210\u8BE5\u7248\u672C\u7684\u4E8B\u52A1\u5728\u5F53\u524D\u4E8B\u52A1\u751F\u6210ReadView\u540E\u624D\u5F00\u542F\uFF0C\u6240\u4EE5\u8BE5\u7248\u672C\u4E0D\u53EF\u4EE5\u88AB\u5F53\u524D\u4E8B\u52A1\u8BBF\u95EE\u3002</li><li>\u5982\u679C\u88AB\u8BBF\u95EE\u7248\u672C\u7684trx_id\u5C5E\u6027\u503C\u5728ReadView\u7684 up_limit_id \u548C low_limit_id \u4E4B\u95F4\uFF0C\u90A3\u5C31\u9700\u8981\u5224\u65AD\u4E00\u4E0Btrx_id\u5C5E\u6027\u503C\u662F\u4E0D\u662F\u5728 trx_ids \u5217\u8868\u4E2D\u3002 <ul><li>\u5982\u679C\u5728\uFF0C\u8BF4\u660E\u521B\u5EFAReadView\u65F6\u751F\u6210\u8BE5\u7248\u672C\u7684\u4E8B\u52A1\u8FD8\u662F\u6D3B\u8DC3\u7684\uFF0C\u8BE5\u7248\u672C\u4E0D\u53EF\u4EE5\u88AB\u8BBF\u95EE\u3002</li><li>\u5982\u679C\u4E0D\u5728\uFF0C\u8BF4\u660E\u521B\u5EFAReadView\u65F6\u751F\u6210\u8BE5\u7248\u672C\u7684\u4E8B\u52A1\u5DF2\u7ECF\u88AB\u63D0\u4EA4\uFF0C\u8BE5\u7248\u672C\u53EF\u4EE5\u88AB\u8BBF\u95EE\u3002</li></ul></li></ul><h5 id="_4-4-mvcc\u6574\u4F53\u64CD\u4F5C\u6D41\u7A0B" tabindex="-1"><a class="header-anchor" href="#_4-4-mvcc\u6574\u4F53\u64CD\u4F5C\u6D41\u7A0B" aria-hidden="true">#</a> 4.4 MVCC\u6574\u4F53\u64CD\u4F5C\u6D41\u7A0B</h5><p>\u4E86\u89E3\u4E86\u8FD9\u4E9B\u6982\u5FF5\u4E4B\u540E\uFF0C\u6211\u4EEC\u6765\u770B\u4E0B\u5F53\u67E5\u8BE2\u4E00\u6761\u8BB0\u5F55\u7684\u65F6\u5019\uFF0C\u7CFB\u7EDF\u5982\u4F55\u901A\u8FC7MVCC\u627E\u5230\u5B83\uFF1A</p><ol><li>\u9996\u5148\u83B7\u53D6\u4E8B\u52A1\u81EA\u5DF1\u7684\u7248\u672C\u53F7\uFF0C\u4E5F\u5C31\u662F\u4E8B\u52A1 ID\uFF1B</li><li>\u83B7\u53D6 ReadView\uFF1B</li><li>\u67E5\u8BE2\u5F97\u5230\u7684\u6570\u636E\uFF0C\u7136\u540E\u4E0E ReadView \u4E2D\u7684\u4E8B\u52A1\u7248\u672C\u53F7\u8FDB\u884C\u6BD4\u8F83\uFF1B</li><li>\u5982\u679C\u4E0D\u7B26\u5408 ReadView \u89C4\u5219\uFF0C\u5C31\u9700\u8981\u4ECE Undo Log \u4E2D\u83B7\u53D6\u5386\u53F2\u5FEB\u7167\uFF1B</li><li>\u6700\u540E\u8FD4\u56DE\u7B26\u5408\u89C4\u5219\u7684\u6570\u636E\u3002</li></ol><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715130639408.png" alt="image-20220715130639408" style="float:left;"><p>\u5728\u9694\u79BB\u7EA7\u522B\u4E3A\u8BFB\u5DF2\u63D0\u4EA4\uFF08Read Committed\uFF09\u65F6\uFF0C\u4E00\u4E2A\u4E8B\u52A1\u4E2D\u7684\u6BCF\u4E00\u6B21 SELECT \u67E5\u8BE2\u90FD\u4F1A\u91CD\u65B0\u83B7\u53D6\u4E00\u6B21 Read View\u3002</p><p>\u5982\u8868\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715130843147.png" alt="image-20220715130843147"></p><blockquote><p>\u6CE8\u610F\uFF0C\u6B64\u65F6\u540C\u6837\u7684\u67E5\u8BE2\u8BED\u53E5\u90FD\u4F1A\u91CD\u65B0\u83B7\u53D6\u4E00\u6B21 Read View\uFF0C\u8FD9\u65F6\u5982\u679C Read View \u4E0D\u540C\uFF0C\u5C31\u53EF\u80FD\u4EA7\u751F\u4E0D\u53EF\u91CD\u590D\u8BFB\u6216\u8005\u5E7B\u8BFB\u7684\u60C5\u51B5\u3002</p></blockquote><p>\u5F53\u9694\u79BB\u7EA7\u522B\u4E3A\u53EF\u91CD\u590D\u8BFB\u7684\u65F6\u5019\uFF0C\u5C31\u907F\u514D\u4E86\u4E0D\u53EF\u91CD\u590D\u8BFB\uFF0C\u8FD9\u662F\u56E0\u4E3A\u4E00\u4E2A\u4E8B\u52A1\u53EA\u5728\u7B2C\u4E00\u6B21 SELECT \u7684\u65F6\u5019\u4F1A\u83B7\u53D6\u4E00\u6B21 Read View\uFF0C\u800C\u540E\u9762\u6240\u6709\u7684 SELECT \u90FD\u4F1A\u590D\u7528\u8FD9\u4E2A Read View\uFF0C\u5982\u4E0B\u8868\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715130916437.png" alt="image-20220715130916437"></p><h3 id="_5-\u4E3E\u4F8B\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#_5-\u4E3E\u4F8B\u8BF4\u660E" aria-hidden="true">#</a> 5. \u4E3E\u4F8B\u8BF4\u660E</h3><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715131200077.png" alt="image-20220715131200077" style="float:left;"><h5 id="_5-1-read-committed\u9694\u79BB\u7EA7\u522B\u4E0B" tabindex="-1"><a class="header-anchor" href="#_5-1-read-committed\u9694\u79BB\u7EA7\u522B\u4E0B" aria-hidden="true">#</a> 5.1 READ COMMITTED\u9694\u79BB\u7EA7\u522B\u4E0B</h5><p><strong>READ COMMITTED \uFF1A\u6BCF\u6B21\u8BFB\u53D6\u6570\u636E\u524D\u90FD\u751F\u6210\u4E00\u4E2AReadView\u3002</strong></p><p>\u73B0\u5728\u6709\u4E24\u4E2A <code>\u4E8B\u52A1id</code> \u5206\u522B\u4E3A <code>10</code> \u3001 <code>20</code> \u7684\u4E8B\u52A1\u5728\u6267\u884C:</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># Transaction 10
BEGIN;
UPDATE student SET name=&quot;\u674E\u56DB&quot; WHERE id=1;
UPDATE student SET name=&quot;\u738B\u4E94&quot; WHERE id=1;
# Transaction 20
BEGIN;
# \u66F4\u65B0\u4E86\u4E00\u4E9B\u522B\u7684\u8868\u7684\u8BB0\u5F55
...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u8BF4\u660E\uFF1A\u4E8B\u52A1\u6267\u884C\u8FC7\u7A0B\u4E2D\uFF0C\u53EA\u6709\u5728\u7B2C\u4E00\u6B21\u771F\u6B63\u4FEE\u6539\u8BB0\u5F55\u65F6\uFF08\u6BD4\u5982\u4F7F\u7528INSERT\u3001DELETE\u3001UPDATE\u8BED\u53E5\uFF09\uFF0C\u624D\u4F1A\u88AB\u5206\u914D\u4E00\u4E2A\u5355\u72EC\u7684\u4E8B\u52A1id\uFF0C\u8FD9\u4E2A\u4E8B\u52A1id\u662F\u9012\u589E\u7684\u3002\u6240\u4EE5\u6211\u4EEC\u624D\u5728\u4E8B\u52A12\u4E2D\u66F4\u65B0\u4E00\u4E9B\u522B\u7684\u8868\u7684\u8BB0\u5F55\uFF0C\u76EE\u7684\u662F\u8BA9\u5B83\u5206\u914D\u4E8B\u52A1id\u3002</p></blockquote><p>\u6B64\u523B\uFF0C\u8868student \u4E2D id \u4E3A 1 \u7684\u8BB0\u5F55\u5F97\u5230\u7684\u7248\u672C\u94FE\u8868\u5982\u4E0B\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715133640655.png" alt="image-20220715133640655"></p><p>\u5047\u8BBE\u73B0\u5728\u6709\u4E00\u4E2A\u4F7F\u7528 <code>READ COMMITTED</code> \u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1\u5F00\u59CB\u6267\u884C\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u4F7F\u7528READ COMMITTED\u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1
BEGIN;

# SELECT1\uFF1ATransaction 10\u300120\u672A\u63D0\u4EA4
SELECT * FROM student WHERE id = 1; # \u5F97\u5230\u7684\u5217name\u7684\u503C\u4E3A&#39;\u5F20\u4E09&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715134540737.png" alt="image-20220715134540737" style="float:left;"><p>\u4E4B\u540E\uFF0C\u6211\u4EEC\u628A <code>\u4E8B\u52A1id</code> \u4E3A <code>10</code> \u7684\u4E8B\u52A1\u63D0\u4EA4\u4E00\u4E0B\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># Transaction 10
BEGIN;
UPDATE student SET name=&quot;\u674E\u56DB&quot; WHERE id=1;
UPDATE student SET name=&quot;\u738B\u4E94&quot; WHERE id=1;
COMMIT;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u518D\u5230 <code>\u4E8B\u52A1id</code> \u4E3A <code>20</code> \u7684\u4E8B\u52A1\u4E2D\u66F4\u65B0\u4E00\u4E0B\u8868 <code>student</code> \u4E2D <code>id</code> \u4E3A <code>1</code> \u7684\u8BB0\u5F55\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># Transaction 20
BEGIN;
# \u66F4\u65B0\u4E86\u4E00\u4E9B\u522B\u7684\u8868\u7684\u8BB0\u5F55
...
UPDATE student SET name=&quot;\u94B1\u4E03&quot; WHERE id=1;
UPDATE student SET name=&quot;\u5B8B\u516B&quot; WHERE id=1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u523B\uFF0C\u8868student\u4E2D <code>id</code> \u4E3A <code>1</code> \u7684\u8BB0\u5F55\u7684\u7248\u672C\u94FE\u5C31\u957F\u8FD9\u6837\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715134839081.png" alt="image-20220715134839081"></p><p>\u7136\u540E\u518D\u5230\u521A\u624D\u4F7F\u7528 <code>READ COMMITTED</code> \u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1\u4E2D\u7EE7\u7EED\u67E5\u627E\u8FD9\u4E2A id \u4E3A 1 \u7684\u8BB0\u5F55\uFF0C\u5982\u4E0B\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u4F7F\u7528READ COMMITTED\u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1
BEGIN;

# SELECT1\uFF1ATransaction 10\u300120\u5747\u672A\u63D0\u4EA4
SELECT * FROM student WHERE id = 1; # \u5F97\u5230\u7684\u5217name\u7684\u503C\u4E3A&#39;\u5F20\u4E09&#39;

# SELECT2\uFF1ATransaction 10\u63D0\u4EA4\uFF0CTransaction 20\u672A\u63D0\u4EA4
SELECT * FROM student WHERE id = 1; # \u5F97\u5230\u7684\u5217name\u7684\u503C\u4E3A&#39;\u738B\u4E94&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715135017000.png" alt="image-20220715135017000" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715135143939.png" alt="image-20220715135143939" style="float:left;"><h5 id="_5-2-repeatable-read\u9694\u79BB\u7EA7\u522B\u4E0B" tabindex="-1"><a class="header-anchor" href="#_5-2-repeatable-read\u9694\u79BB\u7EA7\u522B\u4E0B" aria-hidden="true">#</a> 5.2 REPEATABLE READ\u9694\u79BB\u7EA7\u522B\u4E0B</h5><p>\u4F7F\u7528 <code>REPEATABLE READ</code> \u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1\u6765\u8BF4\uFF0C\u53EA\u4F1A\u5728\u7B2C\u4E00\u6B21\u6267\u884C\u67E5\u8BE2\u8BED\u53E5\u65F6\u751F\u6210\u4E00\u4E2A <code>ReadView</code> \uFF0C\u4E4B\u540E\u7684\u67E5\u8BE2\u5C31\u4E0D\u4F1A\u91CD\u590D\u751F\u6210\u4E86\u3002</p><p>\u6BD4\u5982\uFF0C\u7CFB\u7EDF\u91CC\u6709\u4E24\u4E2A <code>\u4E8B\u52A1id</code> \u5206\u522B\u4E3A <code>10</code> \u3001 <code>20</code> \u7684\u4E8B\u52A1\u5728\u6267\u884C\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># Transaction 10
BEGIN;
UPDATE student SET name=&quot;\u674E\u56DB&quot; WHERE id=1;
UPDATE student SET name=&quot;\u738B\u4E94&quot; WHERE id=1;
# Transaction 20
BEGIN;
# \u66F4\u65B0\u4E86\u4E00\u4E9B\u522B\u7684\u8868\u7684\u8BB0\u5F55
...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u523B\uFF0C\u8868student \u4E2D id \u4E3A 1 \u7684\u8BB0\u5F55\u5F97\u5230\u7684\u7248\u672C\u94FE\u8868\u5982\u4E0B\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715140006061.png" alt="image-20220715140006061"></p><p>\u5047\u8BBE\u73B0\u5728\u6709\u4E00\u4E2A\u4F7F\u7528 <code>REPEATABLE READ</code> \u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1\u5F00\u59CB\u6267\u884C\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u4F7F\u7528REPEATABLE READ\u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1
BEGIN;

# SELECT1\uFF1ATransaction 10\u300120\u672A\u63D0\u4EA4
SELECT * FROM student WHERE id = 1; # \u5F97\u5230\u7684\u5217name\u7684\u503C\u4E3A&#39;\u5F20\u4E09&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715140155744.png" alt="image-20220715140155744" style="float:left;"><p>\u4E4B\u540E\uFF0C\u6211\u4EEC\u628A <code>\u4E8B\u52A1id</code> \u4E3A <code>10</code> \u7684\u4E8B\u52A1\u63D0\u4EA4\u4E00\u4E0B\uFF0C\u5C31\u50CF\u8FD9\u6837\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># Transaction 10
BEGIN;

UPDATE student SET name=&quot;\u674E\u56DB&quot; WHERE id=1;
UPDATE student SET name=&quot;\u738B\u4E94&quot; WHERE id=1;

COMMIT;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u518D\u5230 <code>\u4E8B\u52A1id</code> \u4E3A <code>20</code> \u7684\u4E8B\u52A1\u4E2D\u66F4\u65B0\u4E00\u4E0B\u8868 <code>student</code> \u4E2D <code>id</code> \u4E3A <code>1</code> \u7684\u8BB0\u5F55\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># Transaction 20
BEGIN;
# \u66F4\u65B0\u4E86\u4E00\u4E9B\u522B\u7684\u8868\u7684\u8BB0\u5F55
...
UPDATE student SET name=&quot;\u94B1\u4E03&quot; WHERE id=1;
UPDATE student SET name=&quot;\u5B8B\u516B&quot; WHERE id=1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u523B\uFF0C\u8868student \u4E2D <code>id</code> \u4E3A <code>1</code> \u7684\u8BB0\u5F55\u7684\u7248\u672C\u94FE\u957F\u8FD9\u6837\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715140354217.png" alt="image-20220715140354217"></p><p>\u7136\u540E\u518D\u5230\u521A\u624D\u4F7F\u7528 <code>REPEATABLE READ</code> \u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1\u4E2D\u7EE7\u7EED\u67E5\u627E\u8FD9\u4E2A <code>id</code> \u4E3A <code>1</code> \u7684\u8BB0\u5F55\uFF0C\u5982\u4E0B\uFF1A</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code># \u4F7F\u7528REPEATABLE READ\u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1
BEGIN;
# SELECT1\uFF1ATransaction 10\u300120\u5747\u672A\u63D0\u4EA4
SELECT * FROM student WHERE id = 1; # \u5F97\u5230\u7684\u5217name\u7684\u503C\u4E3A&#39;\u5F20\u4E09&#39;
# SELECT2\uFF1ATransaction 10\u63D0\u4EA4\uFF0CTransaction 20\u672A\u63D0\u4EA4
SELECT * FROM student WHERE id = 1; # \u5F97\u5230\u7684\u5217name\u7684\u503C\u4ECD\u4E3A&#39;\u5F20\u4E09&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715140555172.png" alt="image-20220715140555172" style="float:left;"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715140620328.png" alt="image-20220715140620328" style="float:left;"><p>\u8FD9\u6B21<code>SELECT</code>\u67E5\u8BE2\u5F97\u5230\u7684\u7ED3\u679C\u662F\u91CD\u590D\u7684\uFF0C\u8BB0\u5F55\u7684\u5217<code>c</code>\u503C\u90FD\u662F<code>\u5F20\u4E09</code>\uFF0C\u8FD9\u5C31\u662F<code>\u53EF\u91CD\u590D\u8BFB</code>\u7684\u542B\u4E49\u3002\u5982\u679C\u6211\u4EEC\u4E4B\u540E\u518D\u628A<code>\u4E8B\u52A1id</code>\u4E3A<code>20</code>\u7684\u8BB0\u5F55\u63D0\u4EA4\u4E86\uFF0C\u7136\u540E\u518D\u5230\u521A\u624D\u4F7F\u7528<code>REPEATABLE READ</code>\u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1\u4E2D\u7EE7\u7EED\u67E5\u627E\u8FD9\u4E2A<code>id</code>\u4E3A<code>1</code>\u7684\u8BB0\u5F55\uFF0C\u5F97\u5230\u7684\u7ED3\u679C\u8FD8\u662F<code>\u5F20\u4E09</code>\uFF0C\u5177\u4F53\u6267\u884C\u8FC7\u7A0B\u5927\u5BB6\u53EF\u4EE5\u81EA\u5DF1\u5206\u6790\u4E00\u4E0B\u3002</p><h5 id="_5-3-\u5982\u4F55\u89E3\u51B3\u5E7B\u8BFB" tabindex="-1"><a class="header-anchor" href="#_5-3-\u5982\u4F55\u89E3\u51B3\u5E7B\u8BFB" aria-hidden="true">#</a> 5.3 \u5982\u4F55\u89E3\u51B3\u5E7B\u8BFB</h5><p>\u63A5\u4E0B\u6765\u8BF4\u660EInnoDB \u662F\u5982\u4F55\u89E3\u51B3\u5E7B\u8BFB\u7684\u3002</p><p>\u5047\u8BBE\u73B0\u5728\u8868 student \u4E2D\u53EA\u6709\u4E00\u6761\u6570\u636E\uFF0C\u6570\u636E\u5185\u5BB9\u4E2D\uFF0C\u4E3B\u952E id=1\uFF0C\u9690\u85CF\u7684 trx_id=10\uFF0C\u5B83\u7684 undo log \u5982\u4E0B\u56FE\u6240\u793A\u3002</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715141002035.png" alt="image-20220715141002035" style="zoom:80%;"><p>\u5047\u8BBE\u73B0\u5728\u6709\u4E8B\u52A1 A \u548C\u4E8B\u52A1 B \u5E76\u53D1\u6267\u884C\uFF0C<code>\u4E8B\u52A1 A</code> \u7684\u4E8B\u52A1 id \u4E3A <code>20</code> \uFF0C <code>\u4E8B\u52A1 B</code> \u7684\u4E8B\u52A1 id \u4E3A <code>30</code> \u3002</p><p>\u6B65\u9AA41\uFF1A\u4E8B\u52A1 A \u5F00\u59CB\u7B2C\u4E00\u6B21\u67E5\u8BE2\u6570\u636E\uFF0C\u67E5\u8BE2\u7684 SQL \u8BED\u53E5\u5982\u4E0B\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>select * from student where id &gt;= 1;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5728\u5F00\u59CB\u67E5\u8BE2\u4E4B\u524D\uFF0CMySQL \u4F1A\u4E3A\u4E8B\u52A1 A \u4EA7\u751F\u4E00\u4E2A ReadView\uFF0C\u6B64\u65F6 ReadView \u7684\u5185\u5BB9\u5982\u4E0B\uFF1A <code>trx_ids= [20,30] \uFF0C up_limit_id=20 \uFF0C low_limit_id=31 \uFF0C creator_trx_id=20</code> \u3002</p><p>\u7531\u4E8E\u6B64\u65F6\u8868 student \u4E2D\u53EA\u6709\u4E00\u6761\u6570\u636E\uFF0C\u4E14\u7B26\u5408 where id&gt;=1 \u6761\u4EF6\uFF0C\u56E0\u6B64\u4F1A\u67E5\u8BE2\u51FA\u6765\u3002\u7136\u540E\u6839\u636E ReadView \u673A\u5236\uFF0C\u53D1\u73B0\u8BE5\u884C\u6570\u636E\u7684trx_id=10\uFF0C\u5C0F\u4E8E\u4E8B\u52A1 A \u7684 ReadView \u91CC up_limit_id\uFF0C\u8FD9\u8868\u793A\u8FD9\u6761\u6570\u636E\u662F\u4E8B\u52A1 A \u5F00\u542F\u4E4B\u524D\uFF0C\u5176\u4ED6\u4E8B\u52A1\u5C31\u5DF2\u7ECF\u63D0\u4EA4\u4E86\u7684\u6570\u636E\uFF0C\u56E0\u6B64\u4E8B\u52A1 A \u53EF\u4EE5\u8BFB\u53D6\u5230\u3002</p><p>\u7ED3\u8BBA\uFF1A\u4E8B\u52A1 A \u7684\u7B2C\u4E00\u6B21\u67E5\u8BE2\uFF0C\u80FD\u8BFB\u53D6\u5230\u4E00\u6761\u6570\u636E\uFF0Cid=1\u3002</p><p>\u6B65\u9AA42\uFF1A\u63A5\u7740\u4E8B\u52A1 B(trx_id=30)\uFF0C\u5F80\u8868 student \u4E2D\u65B0\u63D2\u5165\u4E24\u6761\u6570\u636E\uFF0C\u5E76\u63D0\u4EA4\u4E8B\u52A1\u3002</p><div class="language-mysql ext-mysql line-numbers-mode"><pre class="language-mysql"><code>insert into student(id,name) values(2,&#39;\u674E\u56DB&#39;);
insert into student(id,name) values(3,&#39;\u738B\u4E94&#39;);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u65F6\u8868student \u4E2D\u5C31\u6709\u4E09\u6761\u6570\u636E\u4E86\uFF0C\u5BF9\u5E94\u7684 undo \u5982\u4E0B\u56FE\u6240\u793A\uFF1A</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715141208667.png" alt="image-20220715141208667"></p><p>\u6B65\u9AA43\uFF1A\u63A5\u7740\u4E8B\u52A1 A \u5F00\u542F\u7B2C\u4E8C\u6B21\u67E5\u8BE2\uFF0C\u6839\u636E\u53EF\u91CD\u590D\u8BFB\u9694\u79BB\u7EA7\u522B\u7684\u89C4\u5219\uFF0C\u6B64\u65F6\u4E8B\u52A1 A \u5E76\u4E0D\u4F1A\u518D\u91CD\u65B0\u751F\u6210 ReadView\u3002\u6B64\u65F6\u8868 student \u4E2D\u7684 3 \u6761\u6570\u636E\u90FD\u6EE1\u8DB3 where id&gt;=1 \u7684\u6761\u4EF6\uFF0C\u56E0\u6B64\u4F1A\u5148\u67E5\u51FA\u6765\u3002\u7136\u540E\u6839\u636E ReadView \u673A\u5236\uFF0C\u5224\u65AD\u6BCF\u6761\u6570\u636E\u662F\u4E0D\u662F\u90FD\u53EF\u4EE5\u88AB\u4E8B\u52A1 A \u770B\u5230\u3002</p><p>1\uFF09\u9996\u5148 id=1 \u7684\u8FD9\u6761\u6570\u636E\uFF0C\u524D\u9762\u5DF2\u7ECF\u8BF4\u8FC7\u4E86\uFF0C\u53EF\u4EE5\u88AB\u4E8B\u52A1 A \u770B\u5230\u3002</p><p>2\uFF09\u7136\u540E\u662F id=2 \u7684\u6570\u636E\uFF0C\u5B83\u7684 trx_id=30\uFF0C\u6B64\u65F6\u4E8B\u52A1 A \u53D1\u73B0\uFF0C\u8FD9\u4E2A\u503C\u5904\u4E8E up_limit_id \u548C low_limit_id \u4E4B \u95F4\uFF0C\u56E0\u6B64\u8FD8\u9700\u8981\u518D\u5224\u65AD 30 \u662F\u5426\u5904\u4E8E trx_ids \u6570\u7EC4\u5185\u3002\u7531\u4E8E\u4E8B\u52A1 A \u7684 trx_ids=[20,30]\uFF0C\u56E0\u6B64\u5728\u6570\u7EC4\u5185\uFF0C\u8FD9\u8868 \u793A id=2 \u7684\u8FD9\u6761\u6570\u636E\u662F\u4E0E\u4E8B\u52A1 A \u5728\u540C\u4E00\u65F6\u523B\u542F\u52A8\u7684\u5176\u4ED6\u4E8B\u52A1\u63D0\u4EA4\u7684\uFF0C\u6240\u4EE5\u8FD9\u6761\u6570\u636E\u4E0D\u80FD\u8BA9\u4E8B\u52A1 A \u770B\u5230\u3002</p><p>3\uFF09\u540C\u7406\uFF0Cid=3 \u7684\u8FD9\u6761\u6570\u636E\uFF0Ctrx_id \u4E5F\u4E3A 30\uFF0C\u56E0\u6B64\u4E5F\u4E0D\u80FD\u88AB\u4E8B\u52A1 A \u770B\u89C1\u3002</p><p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715141243993.png" alt="image-20220715141243993"></p><p>\u7ED3\u8BBA\uFF1A\u6700\u7EC8\u4E8B\u52A1 A \u7684\u7B2C\u4E8C\u6B21\u67E5\u8BE2\uFF0C\u53EA\u80FD\u67E5\u8BE2\u51FA id=1 \u7684\u8FD9\u6761\u6570\u636E\u3002\u8FD9\u548C\u4E8B\u52A1 A \u7684\u7B2C\u4E00\u6B21\u67E5\u8BE2\u7684\u7ED3\u679C\u662F\u4E00\u6837 \u7684\uFF0C\u56E0\u6B64\u6CA1\u6709\u51FA\u73B0\u5E7B\u8BFB\u73B0\u8C61\uFF0C\u6240\u4EE5\u8BF4\u5728 MySQL \u7684\u53EF\u91CD\u590D\u8BFB\u9694\u79BB\u7EA7\u522B\u4E0B\uFF0C\u4E0D\u5B58\u5728\u5E7B\u8BFB\u95EE\u9898\u3002</p><h3 id="_6-\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#_6-\u603B\u7ED3" aria-hidden="true">#</a> 6. \u603B\u7ED3</h3><p>\u8FD9\u91CC\u4ECB\u7ECD\u4E86 MVCC \u5728 <code>READ COMMITTD</code> \u3001 <code>REPEATABLE READ</code> \u8FD9\u4E24\u79CD\u9694\u79BB\u7EA7\u522B\u7684\u4E8B\u52A1\u5728\u6267\u884C\u5FEB\u7167\u8BFB\u64CD\u4F5C\u65F6 \u8BBF\u95EE\u8BB0\u5F55\u7684\u7248\u672C\u94FE\u7684\u8FC7\u7A0B\u3002\u8FD9\u6837\u4F7F\u4E0D\u540C\u4E8B\u52A1\u7684 <code>\u8BFB-\u5199</code> \u3001 <code>\u5199-\u8BFB</code> \u64CD\u4F5C\u5E76\u53D1\u6267\u884C\uFF0C\u4ECE\u800C\u63D0\u5347\u7CFB\u7EDF\u6027\u80FD\u3002</p><p>\u6838\u5FC3\u70B9\u5728\u4E8E ReadView \u7684\u539F\u7406\uFF0C <code>READ COMMITTD</code> \u3001 <code>REPEATABLE READ</code> \u8FD9\u4E24\u4E2A\u9694\u79BB\u7EA7\u522B\u7684\u4E00\u4E2A\u5F88\u5927\u4E0D\u540C \u5C31\u662F\u751F\u6210ReadView\u7684\u65F6\u673A\u4E0D\u540C\uFF1A</p><ul><li><code>READ COMMITTD</code> \u5728\u6BCF\u4E00\u6B21\u8FDB\u884C\u666E\u901ASELECT\u64CD\u4F5C\u524D\u90FD\u4F1A\u751F\u6210\u4E00\u4E2AReadView</li><li><code>REPEATABLE READ</code> \u53EA\u5728\u7B2C\u4E00\u6B21\u8FDB\u884C\u666E\u901ASELECT\u64CD\u4F5C\u524D\u751F\u6210\u4E00\u4E2AReadView\uFF0C\u4E4B\u540E\u7684\u67E5\u8BE2\u64CD\u4F5C\u90FD\u91CD\u590D \u4F7F\u7528\u8FD9\u4E2AReadView\u5C31\u597D\u4E86\u3002</li></ul><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715141413135.png" alt="image-20220715141413135" style="float:left;"><p>\u901A\u8FC7MVCC\u6211\u4EEC\u53EF\u4EE5\u89E3\u51B3\uFF1A</p><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2541/image-20220715141515370.png" alt="image-20220715141515370" style="float:left;">`,879),l=[s];function c(o,r){return i(),d("div",null,l)}var m=e(a,[["render",c],["__file","mysql03.html.vue"]]);export{m as default};
